<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>




<span class="w">#include</span> <span class="w">"tasks.h"</span>

<span class="w">#include</span> <span class="w">"runtime_impl.h"</span>

<span class="w">namespace</span> <span class="w">Realm</span> <span class="w">{</span>

  <span class="w">Logger</span> <span class="w">log_task("task");</span>
  <span class="w">Logger</span> <span class="w">log_util("util");</span>

  
  
  
  

  <span class="w">Task::Task(Processor</span> <span class="w">_proc,</span> <span class="w">Processor::TaskFuncID</span> <span class="w">_func_id,</span>
	     <span class="w">const</span> <span class="c">void</span> <span class="c">*</span><span class="w">_args</span><span class="c">,</span> <span class="c">size_t</span> <span class="w">_arglen</span><span class="c">,</span>
	     <span class="c">const</span> <span class="pc">P</span><span class="c">rofilingRequestSet</span> <span class="c">&amp;</span><span class="pc">reqs</span><span class="c">,</span>
	     <span class="pc">E</span><span class="c">vent</span> <span class="w">_finish_event</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">_priority</span><span class="pc">)</span>
    <span class="pc">:</span> <span class="w">O</span><span class="c">peration(</span><span class="w">_</span><span class="pc">fi</span><span class="c">nish_event,</span> <span class="w">r</span><span class="pc">e</span><span class="c">qs</span><span class="w">)</span><span class="pc">,</span> <span class="w">pr</span><span class="pc">o</span><span class="c">c</span><span class="pc">(</span><span class="w">_</span><span class="pc">p</span><span class="c">roc</span><span class="pc">)</span><span class="c">,</span> <span class="w">func_id</span><span class="c">(</span><span class="w">_</span><span class="pc">fu</span><span class="c">nc_id),</span>
      <span class="w">a</span><span class="c">rgs</span><span class="pc">(</span><span class="w">_</span><span class="pc">args</span><span class="c">,</span> <span class="pc">_a</span><span class="c">rglen</span><span class="pc">),</span> <span class="w">priority</span><span class="c">(</span><span class="pc">_</span><span class="c">priority</span><span class="pc">)</span>
  <span class="c">{</span>
  <span class="c">}</span>

  <span class="w">T</span><span class="pc">ask</span><span class="w">:</span><span class="pc">:~</span><span class="w">Ta</span><span class="pc">sk</span><span class="c">(void)</span>
  <span class="c">{</span>
  <span class="pc">}</span>

  <span class="w">v</span><span class="pc">o</span><span class="c">id</span> <span class="w">T</span><span class="pc">ask</span><span class="c">::</span><span class="w">execute_on_processor</span><span class="c">(</span><span class="w">P</span><span class="c">rocessor</span> <span class="pc">p)</span>
  <span class="c">{</span>
    
    <span class="pc">i</span><span class="c">f</span><span class="pc">(!p</span><span class="w">.</span><span class="c">exists())</span>
      <span class="w">p</span> <span class="pc">=</span> <span class="w">t</span><span class="pc">h</span><span class="c">is</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pr</span><span class="pc">o</span><span class="c">c;</span>

    <span class="w">P</span><span class="pc">roc</span><span class="c">essor::</span><span class="w">TaskFuncPtr</span> <span class="w">fptr</span> <span class="w">=</span> <span class="w">g</span><span class="c">et_runtime</span><span class="pc">()</span><span class="c">-&gt;</span><span class="w">task_table[func_id</span><span class="c">];</span>
<span class="w">#</span><span class="pc">if</span> <span class="pc">0</span>
    <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">argstr[100</span><span class="pc">];</span>
    <span class="w">a</span><span class="pc">r</span><span class="c">gstr</span><span class="pc">[0</span><span class="c">] =</span> <span class="w">0</span><span class="c">;</span>
    <span class="pc">f</span><span class="c">or(</span><span class="pc">si</span><span class="c">ze_t</span> <span class="c">i</span> <span class="c">=</span> <span class="c">0</span><span class="w">; (</span><span class="c">i</span> <span class="pc">&lt;</span> <span class="w">a</span><span class="pc">rgl</span><span class="c">en</span><span class="w">) &amp;&amp; (</span><span class="c">i</span> <span class="w">&lt;</span> <span class="w">40)</span><span class="pc">;</span> <span class="c">i++)</span>
      <span class="w">sprintf</span><span class="c">(</span><span class="pc">a</span><span class="c">rgstr</span><span class="w">+2*</span><span class="c">i</span><span class="w">, "%02x", ((u</span><span class="c">nsigned</span> <span class="pc">ch</span><span class="c">ar</span> <span class="w">*)(</span><span class="pc">args</span><span class="w">))[i</span><span class="pc">]</span><span class="c">);</span>
    <span class="w">i</span><span class="pc">f</span><span class="c">(</span><span class="w">a</span><span class="pc">rgl</span><span class="c">en</span> <span class="w">&gt;</span> <span class="w">4</span><span class="c">0)</span> <span class="w">strcpy(a</span><span class="c">rgstr</span><span class="w">+80, "...");</span>
    <span class="w">log_util(((func_id</span> <span class="w">=</span><span class="pc">=</span> <span class="w">3) ?</span> <span class="w">LEVEL_SPEW</span> <span class="w">:</span> <span class="w">LEVEL_INFO),</span> 
	     <span class="w">"ta</span><span class="pc">sk</span> <span class="w">s</span><span class="pc">ta</span><span class="c">rt</span><span class="w">: %</span><span class="c">d</span> <span class="w">(</span><span class="pc">%p</span><span class="w">) (%</span><span class="pc">s</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span> <span class="pc">f</span><span class="c">unc_id</span><span class="pc">,</span> <span class="w">fptr</span><span class="pc">,</span> <span class="w">a</span><span class="pc">rgst</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>
<span class="pc">#</span><span class="c">ifdef</span> <span class="w">EVENT_GRAPH_TRACE</span>
    <span class="w">start_enclosing</span><span class="c">(</span><span class="w">finish_event</span><span class="c">);</span>
    <span class="w">u</span><span class="pc">ns</span><span class="c">igned</span> <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">s</span><span class="pc">tart</span> <span class="pc">=</span> <span class="w">TimeStamp:</span><span class="c">:</span><span class="w">get_current_time_in_micros</span><span class="c">();</span>
<span class="pc">#e</span><span class="c">ndif</span>
    <span class="w">log_task.</span><span class="c">info("</span><span class="w">thread</span> <span class="w">running</span> <span class="w">ready</span> <span class="w">t</span><span class="pc">a</span><span class="c">sk</span> <span class="pc">%</span><span class="w">p</span> <span class="w">f</span><span class="c">or</span> <span class="w">pr</span><span class="pc">o</span><span class="c">c</span> <span class="c">"</span> <span class="pc">I</span><span class="c">DFMT</span> <span class="w">"",</span>
		  <span class="w">t</span><span class="pc">h</span><span class="c">is</span><span class="w">,</span> <span class="w">p</span><span class="pc">.</span><span class="c">id</span><span class="pc">)</span><span class="c">;</span>

    
    <span class="w">i</span><span class="c">f(</span><span class="w">measurements</span><span class="c">.</span><span class="w">wants_measurement&lt;ProfilingMeasurements:</span><span class="c">:</span><span class="w">OperationProcessorUsage&gt;()) {</span>
      <span class="w">P</span><span class="c">rofilingMeasurements</span><span class="pc">:</span><span class="c">:</span><span class="w">O</span><span class="c">perationProcessorUsage</span> <span class="w">opu;</span>
      <span class="pc">o</span><span class="c">pu.</span><span class="w">pr</span><span class="pc">o</span><span class="c">c</span> <span class="c">=</span> <span class="w">p</span><span class="c">;</span>
      <span class="w">m</span><span class="c">easurements.</span><span class="w">add_measurement</span><span class="pc">(</span><span class="w">o</span><span class="c">pu);</span>
    <span class="pc">}</span>

    <span class="w">mark_started(</span><span class="pc">)</span><span class="c">;</span>

    
    <span class="w">ThreadLocal</span><span class="pc">:</span><span class="c">:</span><span class="w">current_processor</span> <span class="w">=</span> <span class="w">p</span><span class="pc">;</span>

    <span class="w">(</span><span class="c">*</span><span class="w">fptr)</span><span class="pc">(</span><span class="w">a</span><span class="c">rgs.</span><span class="w">b</span><span class="pc">a</span><span class="c">se</span><span class="w">(</span><span class="pc">),</span> <span class="pc">a</span><span class="c">rgs.</span><span class="pc">s</span><span class="c">ize</span><span class="pc">(),</span> <span class="w">p</span><span class="pc">)</span><span class="c">;</span>

    
    
    

    <span class="w">mark_finished(</span><span class="pc">)</span><span class="c">;</span>

    <span class="w">log_task</span><span class="c">.</span><span class="w">i</span><span class="pc">nf</span><span class="c">o("</span><span class="w">thread</span> <span class="w">finished</span> <span class="w">running</span> <span class="w">t</span><span class="pc">a</span><span class="c">sk</span> <span class="w">%</span><span class="pc">p</span> <span class="w">f</span><span class="c">or</span> <span class="w">pr</span><span class="pc">o</span><span class="c">c</span> <span class="pc">"</span> <span class="c">IDFMT</span> <span class="w">"",</span>
		  <span class="w">t</span><span class="pc">h</span><span class="c">is</span><span class="w">,</span> <span class="pc">p</span><span class="c">.id</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">EVENT_GRAPH_TRACE</span>
    <span class="pc">u</span><span class="c">nsigned</span> <span class="w">l</span><span class="c">ong</span> <span class="pc">lon</span><span class="c">g</span> <span class="w">stop</span> <span class="pc">=</span> <span class="w">TimeStamp</span><span class="pc">:</span><span class="c">:</span><span class="w">get_current_time_in_micros</span><span class="pc">()</span><span class="c">;</span>
    <span class="w">finish_enclosing</span><span class="pc">(</span><span class="c">);</span>
    <span class="w">log_event_graph</span><span class="c">.</span><span class="w">d</span><span class="c">ebug("</span><span class="w">T</span><span class="pc">a</span><span class="c">sk</span> <span class="w">Time: ("</span> <span class="pc">I</span><span class="c">DFMT</span> <span class="w">",%</span><span class="c">d</span><span class="w">) %l</span><span class="pc">l</span><span class="c">d</span><span class="pc">",</span>
			  <span class="w">finish_event</span><span class="pc">.</span><span class="c">id,</span> <span class="pc">f</span><span class="c">inish_event</span><span class="pc">.g</span><span class="c">en,</span>
			  <span class="w">(</span><span class="pc">s</span><span class="c">top</span> <span class="w">-</span> <span class="w">s</span><span class="pc">tar</span><span class="c">t</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>
<span class="w">#</span><span class="pc">if</span> <span class="w">0</span>
    <span class="w">log_util(((func_id</span> <span class="w">=</span><span class="c">=</span> <span class="w">3) ?</span> <span class="w">LEVEL_SPEW</span> <span class="w">:</span> <span class="w">LEVEL_INFO),</span> 
	     <span class="w">"ta</span><span class="pc">sk</span> <span class="w">en</span><span class="c">d</span><span class="w">: %</span><span class="pc">d</span> <span class="w">(</span><span class="pc">%p</span><span class="w">) (%</span><span class="pc">s</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span> <span class="w">f</span><span class="pc">u</span><span class="c">nc_id</span><span class="w">,</span> <span class="w">fptr</span><span class="pc">,</span> <span class="w">argstr</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span>
  <span class="pc">}</span>


  
  
  
  

  <span class="w">ThreadedTaskScheduler</span><span class="c">::</span><span class="w">WorkCounter</span><span class="pc">:</span><span class="c">:</span><span class="pc">W</span><span class="c">orkCounter(void)</span>
    <span class="pc">:</span> <span class="w">counter</span><span class="c">(</span><span class="w">0</span><span class="pc">),</span> <span class="w">wait_value(-</span><span class="pc">1),</span> <span class="w">condvar</span><span class="c">(</span><span class="w">m</span><span class="pc">u</span><span class="c">tex</span><span class="pc">)</span>
  <span class="w">{}</span>

  <span class="w">T</span><span class="c">hreadedTaskScheduler</span><span class="w">:</span><span class="pc">:W</span><span class="c">orkCounter</span><span class="w">:</span><span class="pc">:~W</span><span class="c">orkCounter(</span><span class="pc">v</span><span class="c">oid)</span>
  <span class="w">{</span><span class="pc">}</span>

  <span class="w">inl</span><span class="c">ine</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">T</span><span class="c">hreadedTaskScheduler::</span><span class="pc">W</span><span class="c">orkCounter</span><span class="w">:</span><span class="c">:</span><span class="w">increment_counter</span><span class="c">(void)</span>
  <span class="c">{</span>
    
    
    <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">old_value</span> <span class="w">=</span> <span class="w">__sync_fetch_and_add(</span><span class="pc">&amp;c</span><span class="c">ounter</span><span class="pc">,</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>
    <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">wv_snapshot</span> <span class="pc">=</span> <span class="w">_</span><span class="c">_sync_fetch_and_add</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">wait_value</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>


<span class="w">#</span><span class="c">ifdef</span> <span class="w">DEBUG_WORK_COUNTER</span>
    <span class="w">p</span><span class="pc">rin</span><span class="c">tf("</span><span class="w">WC(%p)</span> <span class="w">increment</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">d</span> <span class="w">(</span><span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">d</span><span class="w">)\n</span><span class="c">",</span> <span class="w">t</span><span class="pc">h</span><span class="c">is,</span> <span class="pc">o</span><span class="c">ld_value,</span> <span class="c">wv_snapshot</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#e</span><span class="c">ndif</span>

    
    
    
    
    <span class="w">i</span><span class="c">f(</span><span class="pc">o</span><span class="c">ld_value</span> <span class="w">!</span><span class="c">=</span> <span class="w">w</span><span class="pc">v</span><span class="c">_snapshot)</span> <span class="c">return;</span>

    
    
    
    
    
    <span class="w">{</span>
      <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="pc">(</span><span class="w">m</span><span class="pc">u</span><span class="c">tex);</span>
      <span class="w">lo</span><span class="pc">n</span><span class="c">g</span> <span class="w">l</span><span class="c">ong</span> <span class="w">wv_reread</span> <span class="pc">=</span> <span class="w">__sync_fetch_and_add(</span><span class="pc">&amp;</span><span class="w">wait_value</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
      <span class="pc">i</span><span class="c">f(</span><span class="w">o</span><span class="c">ld_value</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">w</span><span class="c">v_reread</span><span class="pc">) </span><span class="c">{</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">DEBUG_WORK_COUNTER</span>
	<span class="w">p</span><span class="pc">ri</span><span class="c">ntf("</span><span class="w">WC(%</span><span class="pc">p</span><span class="w">)</span> <span class="w">broadcast</span><span class="pc">(</span><span class="w">1) %l</span><span class="pc">l</span><span class="c">d</span><span class="w">\</span><span class="pc">n</span><span class="c">",</span> <span class="w">t</span><span class="pc">h</span><span class="c">is</span><span class="pc">,</span> <span class="w">o</span><span class="c">ld_value);</span>
<span class="pc">#</span><span class="c">endif</span>
	<span class="w">condvar</span><span class="pc">.</span><span class="w">b</span><span class="pc">r</span><span class="c">oadcast</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">__sync_bool_compare_and_swap(</span><span class="pc">&amp;w</span><span class="c">ait_value</span><span class="pc">,</span> <span class="w">w</span><span class="pc">v</span><span class="c">_reread</span><span class="w">, -</span><span class="pc">1</span><span class="c">);</span>
      <span class="pc">}</span>
    <span class="pc">}</span>

    
    
    <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">wv_check</span> <span class="w">=</span> <span class="w">__sync_fetch_and_add(</span><span class="pc">&amp;</span><span class="w">w</span><span class="pc">a</span><span class="c">it_value</span><span class="w">,</span> <span class="pc">0</span><span class="c">);</span>
    <span class="w">a</span><span class="c">ssert</span><span class="pc">((w</span><span class="c">v_check</span> <span class="w">== -</span><span class="pc">1</span><span class="w">) || (</span><span class="pc">wv</span><span class="c">_check</span> <span class="w">&gt;</span> <span class="pc">o</span><span class="c">ld_value</span><span class="w">))</span><span class="c">;</span>
  <span class="c">}</span>

  <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="w">l</span><span class="c">ong</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">ThreadedTaskScheduler:</span><span class="c">:</span><span class="w">WorkCounter:</span><span class="c">:</span><span class="w">read_counter</span><span class="pc">(</span><span class="w">v</span><span class="c">oid)</span> <span class="pc">c</span><span class="c">onst</span>
  <span class="c">{</span>
    
    <span class="c">return</span> <span class="w">counter</span><span class="pc">;</span>
  <span class="c">}</span>

  
  
  <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">T</span><span class="c">hreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="pc">W</span><span class="c">orkCounter</span><span class="w">:</span><span class="pc">:</span><span class="w">check_for_work(l</span><span class="c">ong</span> <span class="w">l</span><span class="c">ong</span> <span class="w">old_counter</span><span class="pc">)</span>
  <span class="c">{</span>
    
    <span class="c">return</span> <span class="c">(</span><span class="w">c</span><span class="pc">o</span><span class="c">unter</span> <span class="w">&gt;</span> <span class="pc">o</span><span class="c">ld_counter</span><span class="w">)</span><span class="pc">;</span>
  <span class="c">}</span>

  
  
  <span class="pc">v</span><span class="c">oid</span> <span class="c">ThreadedTaskScheduler::</span><span class="pc">W</span><span class="c">orkCounter</span><span class="pc">:</span><span class="c">:</span><span class="w">wait_for_work</span><span class="c">(</span><span class="w">l</span><span class="c">ong</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">o</span><span class="pc">l</span><span class="c">d_counter</span><span class="pc">)</span>
  <span class="c">{</span>
    
    
    <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="c">(</span><span class="w">m</span><span class="pc">u</span><span class="c">tex);</span>

    
    
    <span class="pc">i</span><span class="c">f(</span><span class="w">c</span><span class="pc">o</span><span class="c">unter</span> <span class="w">!</span><span class="c">=</span> <span class="pc">o</span><span class="c">ld_counter)</span>
      <span class="c">return</span><span class="pc">;</span>

    
    
    <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">wv_read</span> <span class="pc">=</span> <span class="w">wait_value</span><span class="c">;</span>
    <span class="w">i</span><span class="pc">f((w</span><span class="c">v_read</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="pc">0</span><span class="w">) &amp;&amp; (w</span><span class="pc">v</span><span class="c">_read</span> <span class="pc">&lt;</span> <span class="w">o</span><span class="c">ld_counter</span><span class="w">)) {</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">DEBUG_WORK_COUNTER</span>
      <span class="w">p</span><span class="pc">r</span><span class="c">intf("</span><span class="w">WC(</span><span class="pc">%</span><span class="w">p</span><span class="pc">)</span> <span class="w">broadcast</span><span class="pc">(</span><span class="w">2) %l</span><span class="c">ld</span><span class="w">\</span><span class="c">n",</span> <span class="w">t</span><span class="pc">h</span><span class="c">is,</span> <span class="pc">wv</span><span class="c">_read</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span>
      <span class="w">condvar.b</span><span class="pc">r</span><span class="c">oadcast</span><span class="pc">()</span><span class="c">;</span>
    <span class="c">}</span>
    <span class="w">a</span><span class="c">ssert(wv_read</span> <span class="w">&lt;</span><span class="c">=</span> <span class="c">old_counter</span><span class="pc">)</span><span class="c">;</span>
    <span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="w">ok</span> <span class="pc">=</span> <span class="w">__sync_bool_compare_and_swap(</span><span class="pc">&amp;</span><span class="w">wait_value</span><span class="c">,</span> <span class="w">w</span><span class="pc">v</span><span class="c">_read</span><span class="pc">,</span> <span class="w">o</span><span class="pc">l</span><span class="c">d_counter</span><span class="pc">)</span><span class="c">;</span>
    <span class="pc">a</span><span class="c">ssert(ok);</span> 

    
    
    <span class="w">w</span><span class="pc">h</span><span class="c">ile(</span><span class="w">__sync_fetch_and_add(</span><span class="pc">&amp;</span><span class="w">counter</span><span class="c">,</span> <span class="pc">0) =</span><span class="c">=</span> <span class="w">o</span><span class="pc">l</span><span class="c">d_counter</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
      
      <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">lo</span><span class="pc">n</span><span class="c">g</span> <span class="w">wv_check</span> <span class="pc">=</span> <span class="w">_</span><span class="pc">_sync_f</span><span class="c">etch_and_add</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">w</span><span class="pc">a</span><span class="c">it_value</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
<span class="pc">#</span><span class="c">ifdef</span> <span class="w">DEBUG_WORK_COUNTER</span>
      <span class="w">p</span><span class="pc">ri</span><span class="c">ntf("</span><span class="w">WC(</span><span class="pc">%</span><span class="w">p)</span> <span class="w">wa</span><span class="pc">it</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">d</span> <span class="w">(</span><span class="pc">%</span><span class="w">l</span><span class="c">ld</span><span class="w">)\n</span><span class="c">",</span> <span class="w">t</span><span class="pc">h</span><span class="c">is,</span> <span class="c">old_counter,</span> <span class="c">wv_check</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>
      <span class="w">a</span><span class="c">ssert(</span><span class="pc">w</span><span class="c">v_check</span> <span class="w">=</span><span class="c">=</span> <span class="pc">o</span><span class="c">ld_counter);</span>
      <span class="w">condvar</span><span class="c">.</span><span class="pc">wa</span><span class="c">it();</span>
      
<span class="c">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">D</span><span class="pc">EBUG_W</span><span class="c">ORK_COUNTER</span>
      <span class="pc">p</span><span class="c">rintf("</span><span class="w">W</span><span class="c">C</span><span class="w">(</span><span class="pc">%p</span><span class="w">)</span> <span class="w">ready</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">d</span><span class="w">\</span><span class="c">n",</span> <span class="w">t</span><span class="pc">h</span><span class="c">is,</span> <span class="c">old_counter</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span>
    <span class="pc">}</span>

    
    <span class="w">__sync_bool_compare_and_swap(&amp;wait_value,</span> <span class="w">o</span><span class="pc">l</span><span class="c">d_counter</span><span class="w">, -</span><span class="pc">1</span><span class="c">);</span>
  <span class="pc">}</span>


  
  
  
  

  <span class="w">ThreadedTaskScheduler:</span><span class="pc">:</span><span class="c">ThreadedTaskScheduler(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
    <span class="pc">:</span> <span class="w">shutdown_flag</span><span class="c">(false</span><span class="pc">)</span>
    <span class="pc">,</span> <span class="w">active_worker_count</span><span class="c">(</span><span class="w">0</span><span class="pc">)</span>
    <span class="pc">,</span> <span class="w">unassigned_worker_count</span><span class="c">(</span><span class="pc">0</span><span class="c">)</span>
    <span class="w">,</span> <span class="w">wcu_task_queues</span><span class="c">(</span><span class="w">t</span><span class="pc">h</span><span class="c">is</span><span class="pc">)</span>
    <span class="pc">,</span> <span class="w">wcu_resume_queue</span><span class="c">(</span><span class="w">t</span><span class="pc">h</span><span class="c">is)</span>
    <span class="c">,</span> <span class="w">cfg_reuse_workers</span><span class="c">(</span><span class="w">t</span><span class="pc">r</span><span class="c">ue</span><span class="pc">)</span>
    <span class="pc">,</span> <span class="w">cfg_max_idle_workers</span><span class="c">(</span><span class="w">1</span><span class="c">)</span>
    <span class="pc">,</span> <span class="w">cfg_min_active_workers</span><span class="c">(</span><span class="w">1</span><span class="c">)</span>
    <span class="c">,</span> <span class="w">cfg_max_active_workers</span><span class="c">(</span><span class="w">1</span><span class="c">)</span>
  <span class="c">{</span>
    
    <span class="w">resumable_workers.add_subscription(</span><span class="pc">&amp;</span><span class="w">w</span><span class="c">cu_resume_queue</span><span class="pc">);</span>
  <span class="pc">}</span>

  <span class="w">ThreadedTaskScheduler:</span><span class="pc">:~</span><span class="c">ThreadedTaskScheduler(</span><span class="pc">v</span><span class="c">oid)</span>
  <span class="c">{</span>
    
    <span class="w">a</span><span class="c">ssert(</span><span class="w">active_worker_count</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">);</span>
    <span class="w">a</span><span class="c">ssert(</span><span class="w">unassigned_worker_count</span> <span class="w">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">);</span>
    <span class="pc">a</span><span class="c">ssert(</span><span class="w">idle_workers</span><span class="c">.</span><span class="pc">e</span><span class="c">mpty</span><span class="pc">());</span>
  <span class="w">}</span>

  <span class="c">void</span> <span class="pc">T</span><span class="c">hreadedTaskScheduler::</span><span class="w">add_task_queue</span><span class="c">(</span><span class="w">TaskQueue</span> <span class="w">*queue</span><span class="pc">)</span>
  <span class="c">{</span>
    <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="pc">(</span><span class="w">l</span><span class="c">ock);</span>

    <span class="w">task_queues</span><span class="pc">.</span><span class="c">push_back(</span><span class="w">q</span><span class="c">ueue);</span>

    
    <span class="pc">q</span><span class="c">ueue</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">add_subscription(</span><span class="pc">&amp;</span><span class="w">wcu_task_queues</span><span class="c">);</span>
  <span class="pc">}</span>

  
  <span class="w">i</span><span class="pc">n</span><span class="c">line</span> <span class="c">void</span> <span class="w">T</span><span class="c">hreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">update_worker_count</span><span class="c">(</span><span class="w">i</span><span class="pc">nt</span> <span class="w">active_delta</span><span class="c">,</span>
							 <span class="pc">i</span><span class="c">nt</span> <span class="w">unassigned_delta</span><span class="c">,</span>
							 <span class="pc">b</span><span class="c">ool</span> <span class="w">check</span> <span class="c">)</span>
  <span class="c">{</span>
    
<span class="w">#</span><span class="c">ifdef</span> <span class="w">DEBUG_THREAD_SCHEDULER</span>
    <span class="w">p</span><span class="c">rintf("</span><span class="w">UWC: %p</span> <span class="w">a=</span><span class="c">%d</span><span class="w">%+</span><span class="pc">d</span> <span class="w">u</span><span class="pc">=</span><span class="c">%d</span><span class="w">%</span><span class="pc">+d\</span><span class="c">n",</span> <span class="w">Th</span><span class="pc">read</span><span class="c">::</span><span class="w">self(</span><span class="pc">),</span>
	   <span class="w">active_worker_count</span><span class="pc">,</span> <span class="w">a</span><span class="pc">ctive_d</span><span class="c">elta,</span>
	   <span class="w">unassigned_worker_count</span><span class="c">,</span> <span class="w">u</span><span class="c">nassigned_delta</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#e</span><span class="c">ndif</span>

    <span class="w">a</span><span class="pc">ctive_w</span><span class="c">orker_count</span> <span class="w">+</span><span class="c">=</span> <span class="pc">active_d</span><span class="c">elta;</span>
    <span class="w">u</span><span class="c">nassigned_worker_count</span> <span class="w">+</span><span class="pc">=</span> <span class="w">u</span><span class="pc">nassigned_d</span><span class="c">elta;</span>

    <span class="pc">i</span><span class="c">f(</span><span class="w">check</span><span class="pc">) </span><span class="c">{</span>
      
      <span class="pc">as</span><span class="c">sert</span><span class="pc">((</span><span class="w">a</span><span class="pc">ctive_w</span><span class="c">orker_count</span> <span class="w">&gt;</span><span class="c">=</span> <span class="w">cfg_min_active_workers) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
	     <span class="c">(</span><span class="w">a</span><span class="c">ctive_worker_count</span> <span class="w">&lt;</span><span class="c">=</span> <span class="w">cfg_max_active_workers)</span><span class="pc">)</span><span class="c">;</span>

      
      <span class="w">a</span><span class="pc">s</span><span class="c">sert</span><span class="pc">((</span><span class="w">u</span><span class="c">nassigned_worker_count</span> <span class="w">&gt;</span> <span class="pc">0</span><span class="w">) |</span><span class="c">|</span>
	     <span class="c">(active_worker_count</span> <span class="pc">=</span><span class="c">=</span> <span class="w">c</span><span class="pc">fg_ma</span><span class="c">x_active_workers</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
    <span class="c">}</span>
  <span class="pc">}</span>

  <span class="pc">v</span><span class="c">oid</span> <span class="w">ThreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">thread_blocking</span><span class="c">(</span><span class="w">T</span><span class="pc">hread</span> <span class="c">*</span><span class="w">thread</span><span class="pc">)</span>
  <span class="c">{</span>
    
    
    <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="c">(</span><span class="w">l</span><span class="c">ock);</span>

    <span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="w">really_blocked</span> <span class="pc">=</span> <span class="w">try_update_thread_state</span><span class="c">(</span><span class="w">t</span><span class="c">hread,</span>
						  <span class="w">T</span><span class="pc">hread</span><span class="c">::</span><span class="w">STATE_BLOCKING,</span>
						  <span class="w">T</span><span class="pc">hread:</span><span class="c">:</span><span class="w">STATE_BLOCKED</span><span class="pc">)</span><span class="c">;</span>

    
    
    <span class="w">i</span><span class="pc">f(!</span><span class="c">really_blocked)</span>
      <span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>

    <span class="w">w</span><span class="pc">h</span><span class="c">ile(</span><span class="w">t</span><span class="pc">ru</span><span class="c">e</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
      

      
      
      <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">old_work_counter</span> <span class="w">=</span> <span class="w">work_counter</span><span class="c">.</span><span class="w">read_counter</span><span class="c">();</span>

      
      <span class="w">i</span><span class="c">f</span><span class="pc">(!</span><span class="w">resumable_workers</span><span class="c">.</span><span class="pc">em</span><span class="c">pty</span><span class="pc">()) </span><span class="c">{</span>
	<span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="w">yield_to</span> <span class="c">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">umable_workers</span><span class="pc">.</span><span class="w">get(0</span><span class="c">);</span> 
	
	<span class="pc">i</span><span class="c">f(</span><span class="w">y</span><span class="c">ield_to</span> <span class="c">==</span> <span class="w">thread</span><span class="pc">) </span><span class="c">{</span>
	  <span class="w">p</span><span class="pc">r</span><span class="c">intf("</span><span class="w">resuming</span> <span class="w">ourselves!\</span><span class="pc">n</span><span class="c">");</span>
	  <span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>
	
	<span class="w">update_worker_count</span><span class="c">(</span><span class="w">0</span><span class="pc">,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">worker_sleep</span><span class="pc">(</span><span class="w">y</span><span class="c">ield_to</span><span class="pc">)</span><span class="c">;</span>  
	<span class="w">b</span><span class="c">reak;</span>
      <span class="c">}</span>

      
      
      <span class="w">i</span><span class="c">f</span><span class="pc">((</span><span class="w">active_worker_count</span> <span class="pc">&gt;</span> <span class="w">cfg_min_active_workers)</span><span class="pc"> &amp;</span><span class="c">&amp;</span>
	 <span class="c">(</span><span class="w">unassigned_worker_count</span> <span class="w">&gt;</span> <span class="c">0</span><span class="w">)) {</span>
	
	<span class="w">u</span><span class="pc">p</span><span class="c">date_worker_count</span><span class="w">(-</span><span class="pc">1</span><span class="w">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">w</span><span class="c">orker_sleep</span><span class="pc">(</span><span class="c">0);</span>  
	<span class="w">b</span><span class="c">reak;</span>
      <span class="c">}</span>

      
      <span class="w">i</span><span class="c">f</span><span class="pc">(!</span><span class="w">idle_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty</span><span class="pc">()) </span><span class="c">{</span>
	<span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="c">yield_to</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">dle_workers.</span><span class="w">back</span><span class="c">();</span>
	<span class="c">idle_workers.</span><span class="w">pop_back</span><span class="pc">()</span><span class="c">;</span>
	
	<span class="w">u</span><span class="pc">p</span><span class="c">date_worker_count</span><span class="pc">(</span><span class="w">0, +1</span><span class="c">);</span>
	<span class="w">w</span><span class="c">orker_sleep(</span><span class="pc">y</span><span class="c">ield_to);</span>  
	<span class="w">b</span><span class="c">reak;</span>
      <span class="c">}</span>
	
      
      
      <span class="w">i</span><span class="pc">f</span><span class="c">(</span><span class="w">tr</span><span class="c">ue</span><span class="pc">) </span><span class="c">{</span>
	<span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="c">yield_to</span> <span class="pc">=</span> <span class="w">worker_create</span><span class="pc">(</span><span class="w">f</span><span class="pc">a</span><span class="c">lse);</span>
	
	<span class="w">u</span><span class="pc">p</span><span class="c">date_worker_count(</span><span class="w">0, </span><span class="pc">+</span><span class="w">1</span><span class="c">);</span>
	<span class="w">w</span><span class="pc">orker_s</span><span class="c">leep</span><span class="pc">(</span><span class="w">y</span><span class="c">ield_to);</span>  
	<span class="w">b</span><span class="c">reak;</span>
      <span class="c">}</span>

      
      
      <span class="w">wait_for_work</span><span class="c">(</span><span class="w">old_work_counter</span><span class="pc">)</span><span class="c">;</span>
    <span class="c">}</span>
  <span class="w">}</span>

  <span class="c">void</span> <span class="w">ThreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">thread_ready</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="c">*</span><span class="w">thread</span><span class="pc">)</span>
  <span class="c">{</span>
    
    
    <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="c">(</span><span class="w">l</span><span class="pc">ock</span><span class="c">);</span>

    
    <span class="w">s</span><span class="c">td::</span><span class="pc">m</span><span class="c">ap&lt;</span><span class="w">Th</span><span class="pc">read</span> <span class="c">*,</span> <span class="pc">i</span><span class="c">nt</span><span class="pc">&gt;:</span><span class="c">:const_iterator</span> <span class="pc">i</span><span class="c">t</span> <span class="c">=</span> <span class="w">worker_priorities</span><span class="c">.find(thread);</span>
    <span class="pc">a</span><span class="c">ssert(it</span> <span class="pc">!</span><span class="c">=</span> <span class="c">worker_priorities.end</span><span class="pc">());</span>
    <span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">priority</span> <span class="c">=</span> <span class="pc">i</span><span class="c">t-&gt;second</span><span class="pc">;</span>

    
    
    <span class="c">if</span><span class="pc">((</span><span class="w">active_worker_count</span> <span class="pc">&lt;</span> <span class="w">cfg_max_active_workers) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
       <span class="w">resumable_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty</span><span class="w">(</span><span class="pc">p</span><span class="c">riority</span><span class="w">-</span><span class="c">1</span><span class="w">)) {</span>
      <span class="w">update_worker_count(+1</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
      <span class="w">worker_wake</span><span class="c">(</span><span class="w">t</span><span class="c">hread</span><span class="pc">)</span><span class="c">;</span>
    <span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
      <span class="w">r</span><span class="pc">es</span><span class="c">umable_workers.</span><span class="w">put</span><span class="c">(</span><span class="w">t</span><span class="pc">hr</span><span class="c">ead</span><span class="pc">,</span> <span class="c">priority);</span>  
    <span class="c">}</span>
  <span class="pc">}</span>

  
  <span class="c">void</span> <span class="w">ThreadedTaskScheduler</span><span class="c">::</span><span class="w">scheduler_loop</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
  <span class="c">{</span>
    
    
    <span class="pc">{</span>
      

      

      <span class="w">w</span><span class="pc">h</span><span class="c">ile(</span><span class="w">tr</span><span class="c">ue</span><span class="pc">) </span><span class="c">{</span>
	
	
	<span class="w">lon</span><span class="c">g</span> <span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">old_work_counter</span> <span class="w">=</span> <span class="w">work_counter</span><span class="c">.</span><span class="w">read_counter</span><span class="c">();</span>

	
	<span class="w">w</span><span class="c">hile</span><span class="pc">(!re</span><span class="c">sumable_workers</span><span class="pc">.em</span><span class="c">pty</span><span class="w">(</span><span class="pc">)) </span><span class="c">{</span>
	  <span class="w">Th</span><span class="pc">read</span> <span class="pc">*</span><span class="w">yield_to</span> <span class="c">=</span> <span class="pc">r</span><span class="c">esumable_workers.</span><span class="w">get</span><span class="pc">(</span><span class="w">0</span><span class="c">);</span> 

	  
	  
	  
	  <span class="w">update_worker_count</span><span class="pc">(</span><span class="c">0</span><span class="w">, -</span><span class="pc">1</span><span class="c">);</span>

	  <span class="w">idle_workers</span><span class="c">.push_back(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span><span class="pc">:</span><span class="c">:</span><span class="w">self(</span><span class="pc">))</span><span class="c">;</span>
	  <span class="w">worker_sleep</span><span class="pc">(y</span><span class="c">ield_to</span><span class="pc">)</span><span class="c">;</span>

	  
	  <span class="w">o</span><span class="c">ld_work_counter</span> <span class="pc">=</span> <span class="w">w</span><span class="c">ork_counter.</span><span class="w">r</span><span class="pc">ead_</span><span class="c">counter</span><span class="w">(</span><span class="pc">);</span>  
	<span class="w">}</span>

	
	
	<span class="w">T</span><span class="pc">a</span><span class="c">sk</span> <span class="pc">*</span><span class="c">task</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">TaskQueue</span> <span class="pc">*</span><span class="w">task_source</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">in</span><span class="pc">t</span> <span class="w">task_priority</span> <span class="c">=</span> <span class="w">T</span><span class="c">askQueue</span><span class="pc">:</span><span class="c">:</span><span class="w">PRI_NEG_INF;</span>
	<span class="c">for(</span><span class="pc">s</span><span class="c">td::vector&lt;</span><span class="w">T</span><span class="pc">askQ</span><span class="c">ueue</span> <span class="pc">*</span><span class="c">&gt;::</span><span class="pc">c</span><span class="c">onst_iterator</span> <span class="c">it</span> <span class="c">=</span> <span class="w">task_queues</span><span class="c">.begin();</span>
	    <span class="c">it</span> <span class="c">!=</span> <span class="c">task_queues.end();</span>
	    <span class="c">it</span><span class="pc">++) </span><span class="c">{</span>
	  <span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">new_priority;</span>
	  <span class="w">T</span><span class="pc">ask</span> <span class="c">*</span><span class="w">new_task</span> <span class="w">= (*i</span><span class="pc">t</span><span class="w">)</span><span class="c">-&gt;</span><span class="w">get(&amp;</span><span class="pc">new_p</span><span class="c">riority</span><span class="pc">,</span> <span class="w">task_priority</span><span class="c">);</span>
	  <span class="c">if(new_task</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
	    
	    <span class="pc">i</span><span class="c">f(</span><span class="w">tas</span><span class="pc">k</span><span class="c">)</span>
	      <span class="w">task_source-</span><span class="c">&gt;</span><span class="w">put</span><span class="c">(</span><span class="w">t</span><span class="pc">ask,</span> <span class="w">ta</span><span class="pc">sk_p</span><span class="c">riority</span><span class="pc">,</span> <span class="c">false);</span> 
	  
	    <span class="w">t</span><span class="pc">ask</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">ew_t</span><span class="c">ask;</span>
	    <span class="w">t</span><span class="pc">ask_s</span><span class="c">ource</span> <span class="w">= *it</span><span class="c">;</span>
	    <span class="w">t</span><span class="pc">ask_</span><span class="c">priority</span> <span class="c">=</span> <span class="w">n</span><span class="pc">ew_p</span><span class="c">riority</span><span class="w">;</span>
	  <span class="c">}</span>
	<span class="w">}</span>

	
	<span class="pc">i</span><span class="c">f(</span><span class="w">t</span><span class="pc">ask</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
	  
	  
	  <span class="pc">i</span><span class="c">f</span><span class="pc">((</span><span class="w">unassigned_worker_count</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">1</span><span class="w">) &amp;&amp; (active_worker_count</span> <span class="w">&lt;</span> <span class="w">cfg_max_active_workers)) {</span>
	    
	    <span class="w">update_worker_count(+1</span><span class="pc">,</span> <span class="c">0);</span>
	    <span class="w">worker_create</span><span class="pc">(</span><span class="w">t</span><span class="pc">r</span><span class="c">ue);</span> 
	  <span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
	    
	    <span class="w">u</span><span class="pc">p</span><span class="c">date_worker_count</span><span class="pc">(</span><span class="w">0, -</span><span class="pc">1</span><span class="c">);</span>
	  <span class="pc">}</span>

	  
	  
	  <span class="w">worker_priorities</span><span class="pc">[</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span><span class="pc">:</span><span class="c">:</span><span class="w">self()] =</span> <span class="w">task_priority;</span>

	  
	  <span class="w">l</span><span class="pc">ock</span><span class="c">.</span><span class="w">unlock</span><span class="pc">()</span><span class="c">;</span>

	  <span class="w">b</span><span class="c">ool</span> <span class="w">ok</span> <span class="pc">=</span> <span class="w">execute_task</span><span class="pc">(</span><span class="w">t</span><span class="pc">ask)</span><span class="c">;</span>
	  <span class="pc">a</span><span class="c">ssert(</span><span class="pc">o</span><span class="c">k</span><span class="pc">)</span><span class="c">;</span>  

	  <span class="w">l</span><span class="pc">ock</span><span class="c">.</span><span class="pc">l</span><span class="c">ock</span><span class="w">(</span><span class="pc">)</span><span class="c">;</span>

	  <span class="w">w</span><span class="c">orker_priorities.</span><span class="w">er</span><span class="pc">a</span><span class="c">se(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span><span class="pc">:</span><span class="c">:</span><span class="w">s</span><span class="c">elf</span><span class="w">(</span><span class="pc">))</span><span class="c">;</span>

	  
	  <span class="w">update_worker_count</span><span class="c">(</span><span class="w">0, +1</span><span class="pc">)</span><span class="c">;</span>

	  
	  <span class="w">i</span><span class="c">f</span><span class="pc">(!</span><span class="w">cfg_reuse_workers</span><span class="pc">)</span> <span class="w">b</span><span class="c">reak;</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
	  

	  
	  <span class="c">if(</span><span class="w">shutdown_flag)</span><span class="pc"> </span><span class="c">{</span>
	    
	    <span class="pc">i</span><span class="c">f(!</span><span class="w">idle_workers</span><span class="pc">.em</span><span class="c">pty</span><span class="pc">()) </span><span class="c">{</span>
	      <span class="w">Th</span><span class="c">read</span> <span class="w">*to_wake</span> <span class="c">=</span> <span class="pc">i</span><span class="c">dle_workers.</span><span class="w">back</span><span class="pc">()</span><span class="c">;</span>
	      <span class="w">i</span><span class="pc">d</span><span class="c">le_workers.</span><span class="w">pop_back</span><span class="pc">()</span><span class="c">;</span>
	      
	      <span class="w">worker_terminate</span><span class="pc">(</span><span class="c">to_wake</span><span class="pc">)</span><span class="c">;</span>
	      <span class="w">b</span><span class="c">reak;</span>
	    <span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
	      
	      <span class="w">update_worker_count(-1, -1,</span> <span class="w">f</span><span class="c">alse);</span> 
	      <span class="w">w</span><span class="pc">o</span><span class="c">rker_terminate</span><span class="w">(</span><span class="pc">0</span><span class="c">);</span>
	      <span class="pc">b</span><span class="c">reak;</span>
	    <span class="c">}</span>
	  <span class="pc">}</span>

	  
	  <span class="w">i</span><span class="pc">nt</span> <span class="w">total_idle_count</span> <span class="pc">=</span><span class="c"> (</span><span class="w">unassigned_worker_count</span> <span class="pc">+</span>
				  <span class="pc">(i</span><span class="c">nt</span><span class="w">)</span><span class="pc">(</span><span class="w">i</span><span class="c">dle_workers</span><span class="pc">.s</span><span class="c">ize</span><span class="w">()));</span>
	  <span class="w">if</span><span class="c">(</span><span class="w">t</span><span class="pc">ot</span><span class="c">al_idle_count</span> <span class="w">&gt;</span> <span class="w">cfg_max_idle_workers</span><span class="c">) {</span>
	    
	    
	    <span class="w">i</span><span class="pc">f(!i</span><span class="c">dle_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty</span><span class="pc">()) </span><span class="c">{</span>
	      <span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="w">to_wake</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">dle_workers.</span><span class="w">back</span><span class="pc">(</span><span class="c">);</span>
	      <span class="pc">id</span><span class="c">le_workers</span><span class="pc">.</span><span class="w">pop_back(</span><span class="pc">)</span><span class="c">;</span>
	      
	      <span class="w">worker_terminate</span><span class="pc">(</span><span class="c">to_wake</span><span class="pc">)</span><span class="c">;</span>
	      <span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	    <span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
	      
	      
	      <span class="pc">i</span><span class="c">f</span><span class="pc">((</span><span class="w">unassigned_worker_count</span> <span class="pc">&gt;</span> <span class="w">1)</span><span class="pc"> &amp;</span><span class="c">&amp;</span>
		 <span class="c">(</span><span class="w">active_worker_count</span> <span class="pc">&gt;</span> <span class="w">cfg_min_active_workers)) {</span>
		<span class="w">update_worker_count(-1, -</span><span class="pc">1</span><span class="w">,</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse);</span>
		<span class="w">w</span><span class="pc">o</span><span class="c">rker_terminate</span><span class="w">(0</span><span class="c">);</span>
		<span class="w">b</span><span class="c">reak;</span>
	      <span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
		
		
		<span class="w">wait_for_work</span><span class="pc">(</span><span class="w">old_work_counter</span><span class="pc">)</span><span class="c">;</span>
	      <span class="c">}</span>
	    <span class="pc">}</span>
	  <span class="w">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
	    
	    <span class="w">i</span><span class="pc">f((u</span><span class="c">nassigned_worker_count</span> <span class="w">&gt;</span> <span class="w">1) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
	       <span class="c">(</span><span class="w">a</span><span class="c">ctive_worker_count</span> <span class="w">&gt;</span> <span class="w">c</span><span class="c">fg_min_active_workers</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
	      <span class="w">u</span><span class="c">pdate_worker_count</span><span class="w">(</span><span class="c">-</span><span class="w">1,</span><span class="c"> -</span><span class="w">1,</span> <span class="w">f</span><span class="c">alse</span><span class="pc">)</span><span class="c">;</span>
	      <span class="w">idle_workers</span><span class="c">.push_back(</span><span class="w">Th</span><span class="c">read</span><span class="pc">:</span><span class="c">:</span><span class="w">self(</span><span class="pc">))</span><span class="c">;</span>
	      <span class="w">worker_sleep(0</span><span class="pc">)</span><span class="c">;</span>
	    <span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
	      
	      
	      <span class="w">wait_for_work</span><span class="pc">(</span><span class="w">old_work_counter</span><span class="pc">)</span><span class="c">;</span>
	    <span class="c">}</span>
	  <span class="pc">}</span>
	<span class="pc">}</span>
      <span class="pc">}</span>
    <span class="pc">}</span>
  <span class="w">}</span>

  
  <span class="c">void</span> <span class="w">ThreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">scheduler_loop_wlock</span><span class="c">(void)</span>
  <span class="c">{</span>
    <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="pc">(</span><span class="w">l</span><span class="c">ock</span><span class="pc">)</span><span class="c">;</span>
    <span class="w">scheduler_loop(</span><span class="pc">)</span><span class="c">;</span>
  <span class="c">}</span>

  <span class="c">void</span> <span class="w">T</span><span class="c">hreadedTaskScheduler::</span><span class="w">w</span><span class="pc">ait_</span><span class="c">for_work(</span><span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">l</span><span class="c">ong</span> <span class="w">o</span><span class="pc">l</span><span class="c">d_work_counter)</span>
  <span class="c">{</span>
    
    <span class="pc">i</span><span class="c">f(</span><span class="w">work_counter.check_for_work</span><span class="pc">(</span><span class="w">o</span><span class="pc">l</span><span class="c">d_work_counter</span><span class="w">)</span><span class="pc">)</span>
      <span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>

    
    <span class="w">l</span><span class="pc">ock</span><span class="c">.</span><span class="w">unlock</span><span class="pc">()</span><span class="c">;</span>

    <span class="pc">w</span><span class="c">ork_counter</span><span class="w">.w</span><span class="pc">ait_f</span><span class="c">or_work(</span><span class="w">o</span><span class="c">ld_work_counter);</span>

    <span class="w">l</span><span class="pc">oc</span><span class="c">k.</span><span class="w">l</span><span class="c">ock</span><span class="w">(</span><span class="pc">)</span><span class="c">;</span>
  <span class="pc">}</span>


  
  
  
  

  <span class="w">KernelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:KernelThreadTaskScheduler</span><span class="pc">(</span><span class="w">P</span><span class="c">rocessor</span> <span class="w">_proc</span><span class="c">,</span>
						       <span class="w">CoreReservation</span><span class="pc">&amp;</span> <span class="w">_core_rsrv</span><span class="c">)</span>
    <span class="c">:</span> <span class="w">pr</span><span class="pc">o</span><span class="c">c(</span><span class="w">_</span><span class="pc">p</span><span class="c">roc</span><span class="pc">)</span>
    <span class="w">,</span> <span class="w">core_rsrv</span><span class="pc">(</span><span class="w">_</span><span class="pc">c</span><span class="c">ore_rsrv)</span>
    <span class="w">,</span> <span class="w">shutdown_condvar</span><span class="c">(</span><span class="w">l</span><span class="pc">ock)</span>
  <span class="c">{</span>
  <span class="pc">}</span>

  <span class="w">K</span><span class="c">ernelThreadTaskScheduler</span><span class="w">:</span><span class="pc">:~</span><span class="w">K</span><span class="c">ernelThreadTaskScheduler(</span><span class="w">v</span><span class="c">oid)</span>
  <span class="c">{</span>
    
    <span class="pc">a</span><span class="c">ssert(</span><span class="w">all_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty</span><span class="pc">());</span>
  <span class="pc">}</span>

  <span class="w">v</span><span class="pc">o</span><span class="c">id</span>  <span class="w">K</span><span class="pc">e</span><span class="c">rnelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">add_task_queue</span><span class="c">(</span><span class="w">TaskQueue</span> <span class="w">*queue</span><span class="c">)</span>
  <span class="c">{</span>
    
    <span class="w">ThreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">a</span><span class="c">dd_task_queue(</span><span class="w">q</span><span class="c">ueue);</span>
  <span class="c">}</span>

  <span class="c">void</span> <span class="pc">K</span><span class="c">ernelThreadTaskScheduler::</span><span class="w">s</span><span class="pc">t</span><span class="c">art(void)</span>
  <span class="c">{</span>
    
    <span class="w">{</span>
      <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="pc">(</span><span class="w">l</span><span class="pc">oc</span><span class="c">k</span><span class="pc">)</span><span class="c">;</span>

      <span class="w">update_worker_count</span><span class="pc">(</span><span class="w">cfg_min_active_workers</span><span class="pc">,</span> <span class="w">c</span><span class="pc">f</span><span class="c">g_min_active_workers</span><span class="pc">)</span><span class="c">;</span>

      <span class="w">f</span><span class="c">or(</span><span class="pc">i</span><span class="c">nt</span> <span class="c">i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">c</span><span class="pc">f</span><span class="c">g_min_active_workers</span><span class="pc">;</span> <span class="c">i++)</span>
	<span class="w">worker_create</span><span class="c">(</span><span class="w">t</span><span class="pc">r</span><span class="c">ue</span><span class="pc">)</span><span class="c">;</span>
    <span class="c">}</span>
  <span class="w">}</span>

  <span class="c">void</span> <span class="w">K</span><span class="c">ernelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">shutdown</span><span class="c">(void)</span>
  <span class="c">{</span>
    <span class="w">shutdown_flag</span> <span class="pc">=</span> <span class="pc">t</span><span class="c">rue;</span>
    
    <span class="w">work_counter</span><span class="pc">.</span><span class="w">increment_counter</span><span class="pc">()</span><span class="c">;</span>

    
    <span class="w">{</span>
      <span class="w">AutoHSLLock</span> <span class="w">al(l</span><span class="pc">ock</span><span class="c">);</span>

      <span class="w">w</span><span class="pc">h</span><span class="c">ile</span><span class="pc">(!</span><span class="w">all_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty</span><span class="pc">())</span>
	<span class="w">shutdown_condvar</span><span class="pc">.</span><span class="w">w</span><span class="c">ait();</span>
    <span class="pc">}</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">DEBUG_THREAD_SCHEDULER</span>
    <span class="w">p</span><span class="pc">ri</span><span class="c">ntf("</span><span class="w">sched</span> <span class="w">s</span><span class="pc">hutdown</span> <span class="w">complete</span><span class="pc">\</span><span class="c">n");</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>
  <span class="w">}</span>

  <span class="pc">v</span><span class="c">oid</span> <span class="w">KernelThreadTaskScheduler</span><span class="c">::</span><span class="w">thread_starting</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="c">*</span><span class="w">thread</span><span class="pc">)</span>
  <span class="c">{</span>
<span class="pc">#</span><span class="c">ifdef</span> <span class="w">D</span><span class="pc">EBUG_T</span><span class="c">HREAD_SCHEDULER</span>
    <span class="pc">p</span><span class="c">rintf("</span><span class="w">worker</span> <span class="w">starting: %p</span><span class="pc">\</span><span class="c">n",</span> <span class="pc">t</span><span class="c">hread</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span>

    
    <span class="w">{</span>
      <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="pc">(</span><span class="w">l</span><span class="pc">ock)</span><span class="c">;</span>

      <span class="pc">i</span><span class="c">f(</span><span class="w">active_workers</span><span class="pc">.</span><span class="w">c</span><span class="c">ount</span><span class="pc">(</span><span class="c">thread</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
	
	<span class="w">GASNetCondVar</span> <span class="w">my_cv</span><span class="pc">(</span><span class="w">l</span><span class="pc">ock)</span><span class="c">;</span>
	<span class="w">sleeping_threads[t</span><span class="c">hread</span><span class="w">] = &amp;m</span><span class="c">y_cv</span><span class="w">;</span>

	<span class="w">w</span><span class="pc">h</span><span class="c">ile(</span><span class="pc">a</span><span class="c">ctive_workers</span><span class="pc">.</span><span class="w">c</span><span class="c">ount(</span><span class="pc">t</span><span class="c">hread</span><span class="w">)</span><span class="pc"> =</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
	  <span class="w">m</span><span class="c">y_cv</span><span class="w">.w</span><span class="c">ait</span><span class="pc">()</span><span class="c">;</span>
    
	<span class="w">s</span><span class="pc">l</span><span class="c">eeping_threads</span><span class="pc">.</span><span class="w">er</span><span class="pc">a</span><span class="c">se(thread);</span>
      <span class="c">}</span>
    <span class="c">}</span>
  <span class="pc">}</span>

  <span class="pc">v</span><span class="c">oid</span> <span class="w">KernelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">thread_terminating</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="c">*</span><span class="pc">t</span><span class="c">hread)</span>
  <span class="c">{</span>
    <span class="w">AutoHSLLock</span> <span class="w">al(l</span><span class="pc">ock</span><span class="c">);</span>

    
    <span class="w">i</span><span class="pc">f</span><span class="c">(</span><span class="w">all_workers.c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">(t</span><span class="c">hread</span><span class="w">) &gt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
      <span class="w">p</span><span class="pc">r</span><span class="c">intf("</span><span class="w">unexpected</span> <span class="w">worker</span> <span class="w">termination: %p</span><span class="pc">\</span><span class="c">n",</span> <span class="w">t</span><span class="pc">hread)</span><span class="c">;</span>

      
      
      
      <span class="pc">i</span><span class="c">f</span><span class="pc">((</span><span class="c">all_workers</span><span class="pc">.s</span><span class="c">ize</span><span class="pc">() </span><span class="c">==</span> <span class="pc">1</span><span class="w">) &amp;&amp; !shutdown_flag) </span><span class="pc">{</span>
	<span class="w">p</span><span class="pc">r</span><span class="c">intf("</span><span class="w">HELP!</span>  <span class="w">Lost</span> <span class="w">last</span> <span class="w">w</span><span class="pc">o</span><span class="c">rker</span> <span class="w">f</span><span class="c">or</span> <span class="w">pr</span><span class="pc">o</span><span class="c">c</span> <span class="pc">"</span> <span class="pc">I</span><span class="c">DFMT</span> <span class="w">"!",</span> <span class="w">pr</span><span class="pc">o</span><span class="c">c</span><span class="pc">.</span><span class="c">id);</span>
	<span class="w">worker_terminate(worker_create(f</span><span class="pc">a</span><span class="c">lse</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
      <span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
	
	<span class="w">w</span><span class="pc">orker_t</span><span class="c">erminate</span><span class="w">(0</span><span class="c">);</span>
      <span class="c">}</span>
    <span class="pc">}</span>

    
    <span class="w">thread-</span><span class="c">&gt;</span><span class="w">detach</span><span class="pc">()</span><span class="c">;</span>
    <span class="w">d</span><span class="pc">el</span><span class="c">ete</span> <span class="w">t</span><span class="c">hread;</span>
  <span class="c">}</span>

  <span class="pc">b</span><span class="c">ool</span> <span class="w">KernelThreadTaskScheduler</span><span class="c">::</span><span class="w">execute_task</span><span class="c">(Task</span> <span class="c">*task)</span>
  <span class="c">{</span>
    <span class="w">t</span><span class="pc">as</span><span class="c">k-&gt;</span><span class="w">execute_on_processor</span><span class="pc">(</span><span class="w">p</span><span class="pc">r</span><span class="c">oc</span><span class="pc">)</span><span class="c">;</span>
    <span class="c">return</span> <span class="pc">t</span><span class="c">rue;</span>
  <span class="c">}</span>

  <span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="w">K</span><span class="c">ernelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">worker_create</span><span class="c">(</span><span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="w">make_active</span><span class="c">)</span>
  <span class="c">{</span>
    
    <span class="w">ThreadLaunchParameters</span> <span class="w">tlp</span><span class="c">;</span>
    <span class="w">Th</span><span class="pc">read</span> <span class="pc">*</span><span class="w">t</span> <span class="c">=</span> <span class="w">T</span><span class="pc">hread</span><span class="c">::</span><span class="w">create_kernel_thread&lt;ThreadedTaskScheduler</span><span class="pc">,</span>
					     <span class="w">&amp;T</span><span class="c">hreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">scheduler_loop_wlock&gt;</span><span class="c">(</span><span class="w">t</span><span class="pc">h</span><span class="c">is</span><span class="pc">,</span>
											 <span class="w">t</span><span class="pc">l</span><span class="c">p,</span>
											 <span class="w">core_rsrv</span><span class="c">,</span>
											 <span class="w">t</span><span class="pc">h</span><span class="c">is);</span>
    <span class="w">all_workers</span><span class="pc">.i</span><span class="c">nsert(</span><span class="w">t</span><span class="c">);</span>
    <span class="pc">i</span><span class="c">f(make_active)</span>
      <span class="w">active_workers</span><span class="pc">.i</span><span class="c">nsert(</span><span class="w">t</span><span class="c">);</span>
    <span class="c">return</span> <span class="w">t</span><span class="c">;</span>
  <span class="c">}</span>

  <span class="pc">v</span><span class="c">oid</span> <span class="w">KernelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">worker_sleep</span><span class="c">(</span><span class="w">T</span><span class="pc">hread</span> <span class="c">*</span><span class="w">switch_to</span><span class="pc">)</span>
  <span class="c">{</span>
    

<span class="w">#</span><span class="c">ifdef</span> <span class="w">DEBUG_THREAD_SCHEDULER</span>
    <span class="w">p</span><span class="c">rintf("</span><span class="w">sw</span><span class="pc">itch</span><span class="w">: %</span><span class="pc">p</span> <span class="w">-&gt; %p</span><span class="pc">\</span><span class="c">n",</span> <span class="w">T</span><span class="pc">h</span><span class="c">read::</span><span class="w">self()</span><span class="pc">,</span> <span class="pc">s</span><span class="c">witch_to</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>

    
    <span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="c">=</span> <span class="w">active_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">r</span><span class="c">ase(</span><span class="w">T</span><span class="pc">h</span><span class="c">read::</span><span class="w">s</span><span class="pc">e</span><span class="c">lf</span><span class="w">()</span><span class="pc">)</span><span class="c">;</span>
    <span class="w">a</span><span class="c">ssert(</span><span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="w">=</span><span class="c">=</span> <span class="w">1</span><span class="c">);</span>

    <span class="w">GASNetCondVar</span> <span class="w">my_cv</span><span class="c">(</span><span class="w">l</span><span class="pc">ock</span><span class="c">);</span>
    <span class="w">sleeping_threads[T</span><span class="pc">h</span><span class="c">read</span><span class="w">:</span><span class="c">:</span><span class="w">s</span><span class="pc">e</span><span class="c">lf</span><span class="w">()] = &amp;m</span><span class="c">y_cv</span><span class="w">;</span>

    
    <span class="w">i</span><span class="pc">f</span><span class="c">(</span><span class="pc">sw</span><span class="c">itch_to</span><span class="pc">)</span>
      <span class="w">worker_wake</span><span class="c">(</span><span class="pc">sw</span><span class="c">itch_to</span><span class="pc">);</span>

    
    <span class="w">w</span><span class="pc">h</span><span class="c">ile(active_workers.</span><span class="w">c</span><span class="pc">o</span><span class="c">unt(</span><span class="w">T</span><span class="pc">h</span><span class="c">read::</span><span class="pc">s</span><span class="c">elf</span><span class="w">()) ==</span> <span class="pc">0)</span>
      <span class="w">m</span><span class="pc">y</span><span class="c">_cv</span><span class="pc">.</span><span class="w">w</span><span class="pc">a</span><span class="c">it();</span>
    
    
    <span class="w">s</span><span class="pc">l</span><span class="c">eeping_threads.</span><span class="w">er</span><span class="pc">a</span><span class="c">se(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span><span class="pc">:</span><span class="c">:</span><span class="pc">se</span><span class="c">lf</span><span class="w">())</span><span class="pc">;</span>
  <span class="pc">}</span>

  <span class="w">v</span><span class="c">oid</span> <span class="w">KernelThreadTaskScheduler</span><span class="c">::</span><span class="w">w</span><span class="c">orker_wake(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="c">*</span><span class="w">to_wake</span><span class="c">)</span>
  <span class="c">{</span>
    
    <span class="pc">as</span><span class="c">sert(</span><span class="w">a</span><span class="c">ctive_workers.</span><span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">(</span><span class="w">t</span><span class="pc">o</span><span class="c">_wake</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0);</span>
    <span class="w">a</span><span class="pc">c</span><span class="c">tive_workers</span><span class="pc">.i</span><span class="c">nsert(</span><span class="pc">t</span><span class="c">o_wake);</span>

    
    <span class="w">st</span><span class="pc">d</span><span class="c">::map&lt;</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="c">,</span> <span class="w">GASNetCondVar</span> <span class="w">*</span><span class="pc">&gt;:</span><span class="c">:const_iterator</span> <span class="c">it</span> <span class="c">=</span> <span class="w">sleeping_threads</span><span class="c">.find(</span><span class="pc">t</span><span class="c">o_wake);</span>
    <span class="pc">i</span><span class="c">f(it</span> <span class="c">!=</span> <span class="c">sleeping_threads.end())</span>
      <span class="c">it</span><span class="pc">-</span><span class="c">&gt;second</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">signal</span><span class="pc">()</span><span class="c">;</span>
  <span class="pc">}</span>

  <span class="c">void</span> <span class="w">KernelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">worker_terminate</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="c">*</span><span class="w">switch_to</span><span class="c">)</span>
  <span class="pc">{</span>
    

    <span class="w">Th</span><span class="c">read</span> <span class="pc">*</span><span class="w">me</span> <span class="c">=</span> <span class="w">T</span><span class="c">hread::</span><span class="w">self</span><span class="pc">()</span><span class="c">;</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">DEBUG_THREAD_SCHEDULER</span>
    <span class="w">p</span><span class="c">rintf("</span><span class="w">terminate: %p</span> <span class="w">-&gt; %p</span><span class="c">\n",</span> <span class="w">m</span><span class="pc">e,</span> <span class="pc">s</span><span class="c">witch_to</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

    
    <span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span> <span class="w">c</span><span class="c">ount</span> <span class="c">=</span> <span class="w">active_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">ra</span><span class="c">se(</span><span class="w">me</span><span class="c">);</span>
    <span class="pc">a</span><span class="c">ssert(</span><span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="c">==</span> <span class="w">1</span><span class="c">);</span>

    
    <span class="w">all_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">ra</span><span class="c">se(</span><span class="w">m</span><span class="pc">e</span><span class="c">);</span>

    
    <span class="pc">i</span><span class="c">f(</span><span class="w">s</span><span class="pc">w</span><span class="c">itch_to</span><span class="w">)</span>
      <span class="w">worker_wake</span><span class="c">(switch_to</span><span class="pc">);</span>

    
    <span class="pc">i</span><span class="c">f(</span><span class="w">a</span><span class="pc">l</span><span class="c">l_workers</span><span class="pc">.em</span><span class="c">pty</span><span class="pc">()) </span><span class="c">{</span>
      <span class="w">a</span><span class="pc">s</span><span class="c">sert(</span><span class="w">shutdown_flag</span><span class="pc">);</span>
      <span class="w">shutdown_condvar</span><span class="pc">.</span><span class="w">signal</span><span class="pc">();</span>
    <span class="c">}</span>
  <span class="pc">}</span>
  
  <span class="c">void</span> <span class="w">KernelThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">wait_for_work</span><span class="c">(</span><span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">l</span><span class="c">ong</span> <span class="w">old_work_counter</span><span class="pc">)</span>
  <span class="c">{</span>
    
    <span class="w">b</span><span class="c">ool</span> <span class="w">spin_wait</span> <span class="pc">=</span> <span class="c">false;</span>
    <span class="w">i</span><span class="c">f(</span><span class="w">sp</span><span class="c">in_wait</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
      <span class="w">w</span><span class="pc">h</span><span class="c">ile</span><span class="pc">(!</span><span class="w">work_counter.check_for_work</span><span class="c">(</span><span class="w">o</span><span class="c">ld_work_counter</span><span class="w">)) {</span>
	
	<span class="w">l</span><span class="pc">ock</span><span class="c">.</span><span class="w">unlock(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">Th</span><span class="c">read</span><span class="pc">:</span><span class="c">:</span><span class="w">yield(</span><span class="pc">);</span>
	<span class="w">l</span><span class="pc">ock</span><span class="c">.</span><span class="w">l</span><span class="c">ock</span><span class="w">()</span><span class="pc">;</span>
      <span class="c">}</span>
      <span class="w">r</span><span class="c">eturn</span><span class="w">;</span>
    <span class="c">}</span>

    
    <span class="w">ThreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">wait_for_work</span><span class="c">(</span><span class="w">o</span><span class="c">ld_work_counter</span><span class="pc">)</span><span class="c">;</span>
  <span class="pc">}</span>


  
  
  
  

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">REALM_USE_USER_THREADS</span>
  <span class="w">UserThreadTaskScheduler</span><span class="c">::</span><span class="pc">U</span><span class="c">serThreadTaskScheduler(</span><span class="w">P</span><span class="c">rocessor</span> <span class="w">_proc</span><span class="c">,</span>
						   <span class="w">CoreReservation</span><span class="pc">&amp;</span> <span class="w">_core_rsrv</span><span class="c">)</span>
    <span class="pc">:</span> <span class="w">p</span><span class="pc">r</span><span class="c">oc(</span><span class="w">_</span><span class="pc">p</span><span class="c">roc</span><span class="pc">)</span>
    <span class="pc">,</span> <span class="w">core_rsrv</span><span class="c">(</span><span class="w">_</span><span class="pc">c</span><span class="c">ore_rsrv)</span>
    <span class="pc">,</span> <span class="w">cfg_num_host_threads</span><span class="c">(</span><span class="w">1</span><span class="pc">)</span>
  <span class="c">{</span>
  <span class="w">}</span>

  <span class="w">U</span><span class="pc">serT</span><span class="c">hreadTaskScheduler</span><span class="w">:</span><span class="pc">:~U</span><span class="c">serThreadTaskScheduler(</span><span class="w">v</span><span class="c">oid)</span>
  <span class="c">{</span>
    
    <span class="pc">a</span><span class="c">ssert(</span><span class="w">all_workers</span><span class="pc">.em</span><span class="c">pty</span><span class="pc">());</span>
    <span class="w">a</span><span class="pc">s</span><span class="c">sert(</span><span class="w">all_hosts</span><span class="pc">.e</span><span class="c">mpty</span><span class="pc">());</span>
  <span class="pc">}</span>

  <span class="pc">v</span><span class="c">oid</span>  <span class="w">U</span><span class="c">serThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">add_task_queue</span><span class="c">(</span><span class="w">TaskQueue</span> <span class="w">*queue</span><span class="c">)</span>
  <span class="c">{</span>
    
    <span class="w">ThreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">a</span><span class="c">dd_task_queue(</span><span class="pc">q</span><span class="c">ueue);</span>
  <span class="c">}</span>

  <span class="c">void</span> <span class="c">UserThreadTaskScheduler::</span><span class="w">s</span><span class="pc">t</span><span class="c">art(void)</span>
  <span class="c">{</span>
    
    <span class="w">cfg_min_active_workers</span> <span class="w">=</span> <span class="w">cfg_num_host_threads</span><span class="pc">;</span>
    <span class="w">cfg_max_active_workers</span> <span class="c">=</span> <span class="w">cf</span><span class="pc">g_n</span><span class="c">um_host_threads;</span>

    
    <span class="w">{</span>
      <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="pc">(</span><span class="w">l</span><span class="c">ock</span><span class="pc">)</span><span class="c">;</span>

      <span class="w">update_worker_count</span><span class="pc">(</span><span class="w">c</span><span class="pc">fg_n</span><span class="c">um_host_threads</span><span class="pc">,</span> <span class="w">c</span><span class="pc">fg_n</span><span class="c">um_host_threads);</span>

      <span class="w">ThreadLaunchParameters</span> <span class="w">tlp</span><span class="c">;</span>
      <span class="pc">t</span><span class="c">lp.</span><span class="w">set_stack_size</span><span class="c">(</span><span class="w">4096</span><span class="c">);</span>  

      <span class="w">f</span><span class="pc">o</span><span class="c">r(</span><span class="pc">i</span><span class="c">nt</span> <span class="c">i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">cfg_n</span><span class="c">um_host_threads;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
	<span class="w">T</span><span class="pc">hread</span> <span class="pc">*</span><span class="w">t</span> <span class="pc">=</span> <span class="w">T</span><span class="pc">hread</span><span class="c">::</span><span class="w">create_kernel_thread</span><span class="pc">&lt;</span><span class="w">UserThreadTaskScheduler</span><span class="c">,</span>
						 <span class="w">&amp;U</span><span class="c">serThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">host_thread_loop&gt;</span><span class="pc">(</span><span class="w">t</span><span class="pc">h</span><span class="c">is</span><span class="pc">,</span>
											<span class="w">tl</span><span class="c">p</span><span class="pc">,</span>
											<span class="w">core_rsrv</span><span class="pc">,</span>
											<span class="w">0</span><span class="c">);</span>
	<span class="w">all_hosts</span><span class="pc">.i</span><span class="c">nsert(</span><span class="w">t</span><span class="c">);</span>
      <span class="pc">}</span>
    <span class="pc">}</span>
  <span class="pc">}</span>

  <span class="c">void</span> <span class="w">U</span><span class="c">serThreadTaskScheduler::</span><span class="w">shutdown</span><span class="c">(void)</span>
  <span class="c">{</span>
    
    <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="c">(</span><span class="w">l</span><span class="c">ock</span><span class="pc">)</span><span class="c">;</span>

    <span class="w">shutdown_flag</span> <span class="pc">=</span> <span class="w">t</span><span class="c">rue;</span>
    
    <span class="w">work_counter</span><span class="pc">.</span><span class="w">increment_counter</span><span class="c">();</span>

    <span class="w">w</span><span class="c">hile</span><span class="pc">(!a</span><span class="c">ll_hosts.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty</span><span class="w">())</span><span class="pc"> </span><span class="c">{</span>
      
      <span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="w">t</span> <span class="w">= *</span><span class="pc">a</span><span class="c">ll_hosts.</span><span class="w">b</span><span class="c">egin</span><span class="pc">()</span><span class="c">;</span>
      <span class="w">a</span><span class="pc">l</span><span class="c">.</span><span class="w">release(</span><span class="pc">)</span><span class="c">;</span>
      <span class="w">t</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">join</span><span class="c">();</span>  
      <span class="w">a</span><span class="c">l.</span><span class="w">reacquire</span><span class="pc">()</span><span class="c">;</span>
      <span class="w">a</span><span class="c">ll_hosts.</span><span class="w">er</span><span class="c">ase(</span><span class="w">t</span><span class="c">);</span>
      <span class="w">d</span><span class="pc">el</span><span class="c">ete</span> <span class="w">t</span><span class="c">;</span>
    <span class="c">}</span>
  <span class="pc">}</span>

  <span class="w">n</span><span class="c">amespace</span> <span class="w">ThreadLocal</span> <span class="c">{</span>
    
    
    <span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="w">__thread</span> <span class="w">T</span><span class="pc">hread</span> <span class="w">*terminated_user_thread</span> <span class="pc">=</span> <span class="c">0;</span>
  <span class="w">}</span><span class="pc">;</span>

  <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="c">void</span> <span class="w">UserThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">request_user_thread_cleanup</span><span class="c">(</span><span class="w">T</span><span class="pc">hread</span> <span class="c">*</span><span class="w">thread</span><span class="pc">)</span>
  <span class="c">{</span>
    
    <span class="w">a</span><span class="c">ssert(</span><span class="w">T</span><span class="pc">h</span><span class="c">readLocal</span><span class="w">:</span><span class="c">:terminated_user_thread</span> <span class="w">=</span><span class="c">=</span> <span class="c">0);</span>
    <span class="w">T</span><span class="c">hreadLocal</span><span class="w">:</span><span class="c">:</span><span class="w">t</span><span class="pc">e</span><span class="c">rminated_user_thread</span> <span class="w">=</span> <span class="w">t</span><span class="pc">h</span><span class="c">read;</span>
  <span class="c">}</span>

  <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="c">void</span> <span class="w">U</span><span class="c">serThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">do_user_thread_cleanup</span><span class="c">(void)</span>
  <span class="c">{</span>
    <span class="pc">i</span><span class="c">f(</span><span class="pc">T</span><span class="c">hreadLocal</span><span class="w">:</span><span class="c">:</span><span class="w">t</span><span class="pc">e</span><span class="c">rminated_user_thread</span> <span class="w">!</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
      <span class="w">d</span><span class="c">elete</span> <span class="w">T</span><span class="c">hreadLocal</span><span class="pc">:</span><span class="c">:</span><span class="pc">te</span><span class="c">rminated_user_thread</span><span class="pc">;</span>
      <span class="w">T</span><span class="c">hreadLocal</span><span class="pc">:</span><span class="c">:</span><span class="w">t</span><span class="c">erminated_user_thread</span> <span class="w">=</span> <span class="pc">0</span><span class="c">;</span>
    <span class="c">}</span>
  <span class="pc">}</span>

  <span class="c">void</span> <span class="pc">U</span><span class="c">serThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">host_thread_loop</span><span class="c">(void)</span>
  <span class="c">{</span>
    <span class="w">AutoHSLLock</span> <span class="w">al</span><span class="c">(</span><span class="w">l</span><span class="c">ock);</span>

    <span class="w">w</span><span class="c">hile</span><span class="pc">(!</span><span class="w">shutdown_flag)</span><span class="pc"> </span><span class="c">{</span>
      
      <span class="w">Th</span><span class="pc">read</span> <span class="pc">*</span><span class="w">worker</span> <span class="pc">=</span> <span class="w">worker_create</span><span class="pc">(</span><span class="w">f</span><span class="pc">a</span><span class="c">lse);</span>

      
      <span class="w">T</span><span class="pc">hread:</span><span class="c">:</span><span class="w">user_switch</span><span class="c">(</span><span class="pc">w</span><span class="c">orker);</span>
      <span class="w">do_user_thread_cleanup(</span><span class="pc">)</span><span class="c">;</span>

      <span class="pc">i</span><span class="c">f</span><span class="pc">(!</span><span class="w">s</span><span class="pc">h</span><span class="c">utdown_flag) {</span>
	<span class="w">p</span><span class="pc">ri</span><span class="c">ntf("</span><span class="w">HELP!</span>  <span class="w">Lost</span> <span class="w">a</span> <span class="w">u</span><span class="c">ser</span> <span class="w">w</span><span class="c">orker</span> <span class="w">thread</span> <span class="w">-</span> <span class="w">making</span> <span class="w">a</span> <span class="w">ne</span><span class="c">w</span> <span class="w">one...\</span><span class="pc">n</span><span class="c">");</span>
	<span class="w">update_worker_count(+1, +</span><span class="pc">1</span><span class="c">);</span>
      <span class="pc">}</span>
    <span class="pc">}</span>
  <span class="pc">}</span>

  <span class="pc">v</span><span class="c">oid</span> <span class="w">UserThreadTaskScheduler</span><span class="c">::</span><span class="w">thread_starting</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="c">*</span><span class="w">th</span><span class="pc">r</span><span class="c">ead)</span>
  <span class="c">{</span>
    
  <span class="w">}</span>

  <span class="c">void</span> <span class="pc">U</span><span class="c">serThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">thread_terminating</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="c">*</span><span class="w">t</span><span class="pc">h</span><span class="c">read)</span>
  <span class="c">{</span>
    
    <span class="w">a</span><span class="c">ssert(</span><span class="pc">0</span><span class="c">);</span>
  <span class="c">}</span>

  <span class="w">b</span><span class="c">ool</span> <span class="pc">U</span><span class="c">serThreadTaskScheduler::</span><span class="w">execute_task</span><span class="c">(</span><span class="w">T</span><span class="c">ask</span> <span class="c">*task)</span>
  <span class="c">{</span>
    <span class="w">ta</span><span class="pc">sk</span><span class="c">-&gt;</span><span class="w">execute_on_processor</span><span class="c">(</span><span class="w">pr</span><span class="c">oc);</span>
    <span class="c">return</span> <span class="pc">tr</span><span class="c">ue;</span>
  <span class="c">}</span>

  <span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="w">U</span><span class="c">serThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">worker_create</span><span class="c">(</span><span class="w">b</span><span class="c">ool</span> <span class="w">make_active</span><span class="c">)</span>
  <span class="c">{</span>
    

    
    <span class="w">a</span><span class="c">ssert</span><span class="w">(</span><span class="pc">!m</span><span class="c">ake_active</span><span class="pc">)</span><span class="c">;</span>

    <span class="w">ThreadLaunchParameters</span> <span class="w">tlp</span><span class="pc">;</span>
    <span class="w">T</span><span class="pc">hread</span> <span class="pc">*</span><span class="w">t</span> <span class="c">=</span> <span class="w">T</span><span class="pc">hread</span><span class="c">::</span><span class="w">create_user_thread</span><span class="pc">&lt;</span><span class="w">ThreadedTaskScheduler</span><span class="pc">,</span>
					   <span class="w">&amp;T</span><span class="pc">hreade</span><span class="c">dTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">scheduler_loop&gt;</span><span class="c">(</span><span class="w">t</span><span class="pc">h</span><span class="c">is,</span>
										   <span class="w">tl</span><span class="c">p</span><span class="pc">,</span>
										   <span class="w">t</span><span class="pc">h</span><span class="c">is);</span>
    <span class="w">all_workers</span><span class="pc">.i</span><span class="c">nsert(</span><span class="w">t</span><span class="c">);</span>
    
    
    <span class="c">return</span> <span class="w">t</span><span class="c">;</span>
  <span class="c">}</span>
    
  <span class="c">void</span> <span class="w">UserThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">worker_sleep</span><span class="c">(</span><span class="w">T</span><span class="pc">hread</span> <span class="c">*</span><span class="w">switch_to</span><span class="c">)</span>
  <span class="c">{</span>
    

    
    <span class="w">a</span><span class="c">ssert(</span><span class="pc">sw</span><span class="c">itch_to</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">0</span><span class="c">);</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">DEBUG_THREAD_SCHEDULER</span>
    <span class="w">p</span><span class="pc">rin</span><span class="c">tf("</span><span class="w">sw</span><span class="pc">itch</span><span class="w">: %p</span> <span class="w">-&gt; %p</span><span class="c">\n",</span> <span class="w">T</span><span class="pc">h</span><span class="c">read::</span><span class="w">self(</span><span class="pc">),</span> <span class="w">s</span><span class="c">witch_to</span><span class="w">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

    
    
    

    <span class="w">T</span><span class="c">hread::</span><span class="w">user_switch</span><span class="c">(switch_to);</span>

    <span class="w">do_user_thread_cleanup(</span><span class="pc">)</span><span class="c">;</span>

    
    
  <span class="c">}</span>

  <span class="c">void</span> <span class="w">UserThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">worker_wake</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="w">to_wake</span><span class="pc">)</span>
  <span class="c">{</span>
    
    <span class="w">a</span><span class="c">ssert(</span><span class="pc">0</span><span class="c">);</span>
  <span class="c">}</span>

  <span class="c">void</span> <span class="w">U</span><span class="c">serThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">worker_terminate</span><span class="c">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span> <span class="pc">*</span><span class="w">s</span><span class="pc">w</span><span class="c">itch_to</span><span class="pc">)</span>
  <span class="c">{</span>
    

    
    
    <span class="w">a</span><span class="c">ssert</span><span class="pc">((s</span><span class="c">witch_to</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">0</span><span class="w">) |</span><span class="c">|</span> <span class="w">shutdown_flag)</span><span class="pc">;</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">DEBUG_THREAD_SCHEDULER</span>
    <span class="w">p</span><span class="c">rintf("</span><span class="w">terminate: %p</span> <span class="w">-&gt; %</span><span class="pc">p</span><span class="c">\n",</span> <span class="w">T</span><span class="pc">h</span><span class="c">read::</span><span class="w">self(</span><span class="pc">),</span> <span class="w">s</span><span class="c">witch_to</span><span class="w">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

    
    
    

    <span class="w">si</span><span class="c">ze_t</span> <span class="pc">c</span><span class="c">ount</span> <span class="c">=</span> <span class="w">all_workers</span><span class="pc">.</span><span class="w">e</span><span class="pc">r</span><span class="c">ase</span><span class="pc">(</span><span class="w">T</span><span class="pc">h</span><span class="c">read</span><span class="pc">:</span><span class="c">:</span><span class="w">s</span><span class="pc">e</span><span class="c">lf</span><span class="w">(</span><span class="pc">))</span><span class="c">;</span>
    <span class="pc">a</span><span class="c">ssert(</span><span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="w">=</span><span class="c">=</span> <span class="pc">1</span><span class="c">);</span>

    
    <span class="w">request_user_thread_cleanup(T</span><span class="c">hread::</span><span class="pc">s</span><span class="c">elf</span><span class="w">())</span><span class="pc">;</span>

    <span class="w">T</span><span class="pc">h</span><span class="c">read::</span><span class="w">user_switch</span><span class="c">(</span><span class="w">s</span><span class="pc">w</span><span class="c">itch_to</span><span class="pc">)</span><span class="c">;</span>

    
    <span class="w">a</span><span class="pc">s</span><span class="c">sert(</span><span class="pc">0</span><span class="c">);</span>
  <span class="pc">}</span>

  <span class="c">void</span> <span class="w">UserThreadTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">wait_for_work</span><span class="c">(</span><span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">l</span><span class="c">ong</span> <span class="w">old_work_counter</span><span class="pc">)</span>
  <span class="c">{</span>
    
    <span class="w">b</span><span class="c">ool</span> <span class="w">spin_wait</span> <span class="pc">=</span> <span class="c">false;</span>
    <span class="w">i</span><span class="pc">f</span><span class="c">(</span><span class="w">s</span><span class="pc">p</span><span class="c">in_wait</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
      <span class="w">w</span><span class="pc">h</span><span class="c">ile</span><span class="pc">(!</span><span class="w">work_counter</span><span class="pc">.</span><span class="w">check_for_work</span><span class="pc">(o</span><span class="c">ld_work_counter</span><span class="w">)) {</span>
	
	<span class="w">l</span><span class="pc">ock</span><span class="c">.</span><span class="w">unlock</span><span class="pc">();</span>
	<span class="w">Th</span><span class="c">read::</span><span class="w">yield(</span><span class="pc">);</span>
	<span class="w">l</span><span class="pc">ock</span><span class="c">.</span><span class="w">l</span><span class="c">ock</span><span class="w">()</span><span class="pc">;</span>
      <span class="c">}</span>
      <span class="w">r</span><span class="c">eturn</span><span class="w">;</span>
    <span class="c">}</span>

    
    <span class="w">ThreadedTaskScheduler</span><span class="pc">:</span><span class="c">:</span><span class="w">wait_for_work</span><span class="c">(</span><span class="w">o</span><span class="c">ld_work_counter</span><span class="pc">)</span><span class="c">;</span>
  <span class="pc">}</span>
<span class="w">#</span><span class="c">endif</span>


  
  
  
  

<span class="w">}</span><span class="pc">;</span> 

</pre>
</body>
</html>

