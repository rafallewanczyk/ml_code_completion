<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>



<span class="w">#include</span> <span class="w">"circuit.h"</span>
<span class="w">#include</span> <span class="w">"circuit_mapper.h"</span>

<span class="w">#include</span> <span class="w">&lt;cstdlib&gt;</span>
<span class="w">#include</span> <span class="w">&lt;cstdio&gt;</span>
<span class="w">#include</span> <span class="w">&lt;cassert&gt;</span>

<span class="w">using</span> <span class="w">namespace</span> <span class="w">LegionRuntime::HighLevel;</span>

<span class="w">LegionRuntime::Logger::Category</span> <span class="w">log_mapper(</span><span class="pc">"</span><span class="w">c</span><span class="pc">ircuit_</span><span class="c">mapper</span><span class="pc">"</span><span class="c">);</span>

<span class="w">CircuitMapper:</span><span class="c">:CircuitMapper(</span><span class="pc">Ma</span><span class="c">chine</span> <span class="pc">*</span><span class="w">m</span><span class="c">,</span> <span class="pc">H</span><span class="c">ighLevelRuntime</span> <span class="c">*</span><span class="pc">rt</span><span class="c">,</span> <span class="c">Processor</span> <span class="c">local</span><span class="pc">)</span>
  <span class="pc">:</span> <span class="w">ShimMapper</span><span class="c">(</span><span class="pc">m</span><span class="c">,</span> <span class="w">r</span><span class="c">t,</span> <span class="w">l</span><span class="c">ocal)</span>
<span class="c">{</span>
  <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">std::set&lt;</span><span class="pc">P</span><span class="c">rocessor</span><span class="pc">&gt; </span><span class="c">&amp;</span><span class="w">all_procs</span> <span class="w">=</span> <span class="w">m-</span><span class="c">&gt;</span><span class="w">get_all_processors</span><span class="pc">()</span><span class="c">;</span>
  
  <span class="w">f</span><span class="c">or</span> <span class="c">(std::set&lt;Processor&gt;::</span><span class="pc">c</span><span class="c">onst_iterator</span> <span class="c">it</span> <span class="c">=</span> <span class="pc">a</span><span class="c">ll_procs.begin();</span>
        <span class="c">it</span> <span class="c">!=</span> <span class="c">all_procs.end();</span> <span class="c">it++)</span>
  <span class="c">{</span>
    <span class="pc">P</span><span class="c">rocessor::Kind</span> <span class="c">kind</span> <span class="c">=</span> <span class="w">m</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">get_processor_kind(</span><span class="pc">*</span><span class="c">it);</span>
    <span class="w">s</span><span class="c">witch(</span><span class="w">k</span><span class="c">ind</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
    <span class="w">ca</span><span class="c">se</span> <span class="w">P</span><span class="c">rocessor::</span><span class="w">LOC_PROC</span><span class="c">:</span>
      <span class="w">cpu_procs</span><span class="pc">.</span><span class="c">push_back</span><span class="pc">(*</span><span class="c">it);</span>
      <span class="pc">b</span><span class="c">reak;</span>

    <span class="pc">c</span><span class="c">ase</span> <span class="w">P</span><span class="c">rocessor::</span><span class="w">TOC_PROC</span><span class="c">:</span>
      <span class="w">gpu_procs</span><span class="c">.push_back(*it);</span>
      <span class="c">break;</span>

    <span class="c">default:</span>
      
      <span class="c">break;</span>
    <span class="c">}</span>
  <span class="c">}</span>
  
  <span class="w">i</span><span class="pc">f</span> <span class="pc">(c</span><span class="c">pu_procs.empty())</span>
  <span class="c">{</span>
    <span class="w">log_mapper</span><span class="c">.</span><span class="pc">e</span><span class="c">rror("</span><span class="w">Circuit</span> <span class="w">M</span><span class="pc">ap</span><span class="c">per</span> <span class="w">could</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">fi</span><span class="pc">n</span><span class="c">d</span> <span class="w">any</span> <span class="w">CPUs"</span><span class="pc">)</span><span class="c">;</span>
    <span class="w">e</span><span class="c">xit(</span><span class="w">1</span><span class="c">);</span>
  <span class="c">}</span>
  <span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">g</span><span class="c">pu_procs</span><span class="pc">.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty())</span>
  <span class="c">{</span>
    <span class="w">l</span><span class="c">og_mapper</span><span class="pc">.</span><span class="w">e</span><span class="pc">r</span><span class="c">ror("</span><span class="w">C</span><span class="pc">i</span><span class="c">rcuit</span> <span class="w">M</span><span class="pc">a</span><span class="c">pper</span> <span class="w">c</span><span class="c">ould</span> <span class="w">n</span><span class="c">ot</span> <span class="w">fin</span><span class="pc">d</span> <span class="w">a</span><span class="c">ny</span> <span class="w">GPUs"</span><span class="pc">)</span><span class="c">;</span>
    <span class="w">e</span><span class="c">xit(</span><span class="w">1</span><span class="c">);</span>
  <span class="c">}</span>

  
  <span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">local_kind</span> <span class="w">=</span><span class="c">=</span> <span class="w">P</span><span class="c">rocessor::</span><span class="w">LOC_PROC</span><span class="c">)</span>
  <span class="c">{</span>
    <span class="w">s</span><span class="c">td::</span><span class="pc">v</span><span class="c">ector&lt;</span><span class="pc">M</span><span class="c">emory</span><span class="pc">&gt;</span> <span class="w">memory_stack</span><span class="c">;</span>
    <span class="w">machine_interface</span><span class="c">.</span><span class="w">find_memory_stack</span><span class="c">(</span><span class="w">l</span><span class="pc">oc</span><span class="c">al_proc,</span> <span class="c">memory_stack</span><span class="pc">,</span> <span class="w">t</span><span class="c">rue);</span>
    <span class="w">u</span><span class="c">nsigned</span> <span class="w">num_mem</span> <span class="c">=</span> <span class="w">m</span><span class="pc">e</span><span class="c">mory_stack.</span><span class="w">s</span><span class="c">ize();</span>
    <span class="w">a</span><span class="c">ssert(</span><span class="w">n</span><span class="c">um_mem</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">2</span><span class="c">);</span>
    <span class="w">gasnet_mem</span> <span class="w">=</span> <span class="pc">m</span><span class="c">emory_stack</span><span class="pc">[n</span><span class="c">um_mem</span><span class="w">-</span><span class="c">1</span><span class="pc">]</span><span class="c">;</span>
    <span class="w">{</span>
      <span class="w">s</span><span class="c">td::</span><span class="pc">v</span><span class="c">ector&lt;</span><span class="w">ProcessorMemoryAffinity</span><span class="c">&gt;</span> <span class="w">res</span><span class="c">ult;</span>
      <span class="w">m-</span><span class="c">&gt;</span><span class="w">get_proc_mem_affinity</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult,</span> <span class="w">l</span><span class="pc">o</span><span class="c">cal_proc</span><span class="w">,</span> <span class="w">g</span><span class="c">asnet_mem);</span>
      <span class="pc">a</span><span class="c">ssert(</span><span class="w">r</span><span class="c">esult.</span><span class="pc">s</span><span class="c">ize</span><span class="pc">() </span><span class="c">==</span> <span class="pc">1</span><span class="c">);</span>
      <span class="w">log_mapper</span><span class="c">.</span><span class="pc">inf</span><span class="c">o("</span><span class="w">CPU</span> <span class="pc">%</span><span class="c">x</span> <span class="w">has</span> <span class="w">gasnet</span> <span class="w">m</span><span class="pc">e</span><span class="c">mory</span> <span class="pc">%x</span> <span class="w">with</span> <span class="w">"</span>
          <span class="c">"</span><span class="w">bandwidth</span> <span class="pc">%</span><span class="w">u</span> <span class="w">and</span> <span class="w">latency</span> <span class="pc">%</span><span class="w">u</span><span class="c">",</span><span class="w">l</span><span class="pc">o</span><span class="c">cal_proc</span><span class="pc">.</span><span class="c">id,</span> <span class="c">gasnet_mem.</span><span class="pc">i</span><span class="c">d,</span>
          <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">0</span><span class="pc">].</span><span class="w">b</span><span class="c">andwidth</span><span class="pc">,</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="w">[</span><span class="c">0].</span><span class="w">l</span><span class="c">atency</span><span class="w">)</span><span class="c">;</span>
    <span class="pc">}</span>
    <span class="w">zero_copy_mem</span> <span class="pc">=</span> <span class="w">memory_stack</span><span class="pc">[</span><span class="w">num_mem-2</span><span class="pc">]</span><span class="c">;</span>
    <span class="w">{</span>
      <span class="w">s</span><span class="pc">td</span><span class="c">::</span><span class="pc">v</span><span class="c">ector&lt;</span><span class="w">ProcessorMemoryAffinity&gt;</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult;</span>
      <span class="w">m-</span><span class="pc">&gt;</span><span class="w">get_proc_mem_affinity</span><span class="pc">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult,</span> <span class="w">l</span><span class="pc">o</span><span class="c">cal_proc</span><span class="pc">,</span> <span class="w">z</span><span class="c">ero_copy_mem);</span>
      <span class="pc">a</span><span class="c">ssert(</span><span class="w">r</span><span class="c">esult.</span><span class="pc">s</span><span class="c">ize</span><span class="pc">() </span><span class="c">==</span> <span class="c">1);</span>
      <span class="w">log_mapper</span><span class="c">.</span><span class="pc">inf</span><span class="c">o("</span><span class="w">CPU</span> <span class="pc">%</span><span class="c">x</span> <span class="w">has</span> <span class="w">zero</span> <span class="w">c</span><span class="c">opy</span> <span class="w">m</span><span class="pc">e</span><span class="c">mory</span> <span class="pc">%x</span> <span class="w">with</span> <span class="pc">"</span>
          <span class="pc">"</span><span class="w">bandwidth</span> <span class="c">%</span><span class="w">u</span> <span class="w">and</span> <span class="w">latency</span> <span class="pc">%u</span><span class="c">",</span><span class="w">l</span><span class="pc">o</span><span class="c">cal_proc</span><span class="pc">.</span><span class="c">id,</span> <span class="w">z</span><span class="pc">ero_</span><span class="c">copy_mem.id</span><span class="pc">,</span>
          <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">0</span><span class="pc">].</span><span class="w">b</span><span class="c">andwidth</span><span class="pc">,</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="w">[</span><span class="c">0].</span><span class="w">l</span><span class="c">atency</span><span class="w">)</span><span class="c">;</span>
    <span class="pc">}</span>
    <span class="w">framebuffer_mem</span> <span class="pc">=</span> <span class="w">M</span><span class="c">emory::</span><span class="w">NO_MEMORY</span><span class="pc">;</span>
  <span class="c">}</span>
  <span class="w">e</span><span class="c">lse</span>
  <span class="c">{</span>
    <span class="w">s</span><span class="c">td::</span><span class="pc">v</span><span class="c">ector&lt;Memory</span><span class="pc">&gt;</span> <span class="w">memory_stack</span><span class="c">;</span> 
    <span class="w">machine_interface</span><span class="pc">.</span><span class="w">find_memory_stack</span><span class="pc">(</span><span class="w">l</span><span class="c">ocal_proc,</span> <span class="c">memory_stack</span><span class="pc">,</span> <span class="w">t</span><span class="c">rue);</span>
    <span class="w">u</span><span class="c">nsigned</span> <span class="w">num_mem</span> <span class="c">=</span> <span class="w">m</span><span class="pc">e</span><span class="c">mory_stack.</span><span class="w">s</span><span class="c">ize();</span>
    <span class="w">a</span><span class="c">ssert(</span><span class="w">n</span><span class="c">um_mem</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">2</span><span class="c">);</span>
    <span class="w">zero_copy_mem</span> <span class="w">=</span> <span class="pc">m</span><span class="c">emory_stack</span><span class="w">[</span><span class="pc">n</span><span class="c">um_mem</span><span class="w">-</span><span class="c">1</span><span class="pc">]</span><span class="c">;</span>
    <span class="w">{</span>
      <span class="w">s</span><span class="c">td::</span><span class="pc">v</span><span class="c">ector&lt;</span><span class="w">ProcessorMemoryAffinity</span><span class="c">&gt;</span> <span class="w">res</span><span class="c">ult;</span>
      <span class="w">m-</span><span class="c">&gt;</span><span class="w">get_proc_mem_affinity</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult,</span> <span class="w">l</span><span class="pc">o</span><span class="c">cal_proc</span><span class="w">,</span> <span class="w">z</span><span class="c">ero_copy_mem);</span>
      <span class="pc">a</span><span class="c">ssert(</span><span class="w">r</span><span class="c">esult.</span><span class="pc">s</span><span class="c">ize</span><span class="pc">() </span><span class="c">==</span> <span class="pc">1</span><span class="c">);</span>
      <span class="w">log_mapper</span><span class="c">.</span><span class="pc">inf</span><span class="c">o("</span><span class="w">GPU</span> <span class="pc">%</span><span class="c">x</span> <span class="w">has</span> <span class="w">zero</span> <span class="w">c</span><span class="c">opy</span> <span class="w">m</span><span class="pc">e</span><span class="c">mory</span> <span class="pc">%x</span> <span class="w">with</span> <span class="pc">"</span>
          <span class="pc">"</span><span class="w">bandwidth</span> <span class="c">%</span><span class="w">u</span> <span class="w">and</span> <span class="w">latency</span> <span class="pc">%u</span><span class="c">",</span><span class="w">l</span><span class="pc">o</span><span class="c">cal_proc</span><span class="pc">.</span><span class="c">id,</span> <span class="w">z</span><span class="pc">ero_</span><span class="c">copy_mem.id</span><span class="pc">,</span>
          <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">0</span><span class="pc">].</span><span class="w">b</span><span class="c">andwidth</span><span class="pc">,</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="w">[</span><span class="c">0].</span><span class="w">l</span><span class="c">atency</span><span class="w">)</span><span class="c">;</span>
    <span class="pc">}</span>
    <span class="w">framebuffer_mem</span> <span class="pc">=</span> <span class="w">memory_stack</span><span class="pc">[</span><span class="w">num_mem-2</span><span class="pc">]</span><span class="c">;</span>
    <span class="w">{</span>
      <span class="w">s</span><span class="pc">td</span><span class="c">::</span><span class="pc">v</span><span class="c">ector&lt;</span><span class="w">ProcessorMemoryAffinity&gt;</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult;</span>
      <span class="w">m-</span><span class="pc">&gt;</span><span class="w">get_proc_mem_affinity</span><span class="pc">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult,</span> <span class="w">l</span><span class="pc">o</span><span class="c">cal_proc</span><span class="pc">,</span> <span class="w">f</span><span class="c">ramebuffer_mem);</span>
      <span class="pc">a</span><span class="c">ssert(</span><span class="w">r</span><span class="c">esult.</span><span class="pc">s</span><span class="c">ize</span><span class="pc">() </span><span class="c">==</span> <span class="c">1);</span>
      <span class="w">log_mapper</span><span class="c">.</span><span class="pc">inf</span><span class="c">o("</span><span class="w">GPU</span> <span class="pc">%</span><span class="c">x</span> <span class="w">has</span> <span class="w">frame</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer</span> <span class="w">m</span><span class="pc">e</span><span class="c">mory</span> <span class="pc">%x</span> <span class="w">with</span> <span class="pc">"</span>
          <span class="pc">"</span><span class="w">bandwidth</span> <span class="c">%</span><span class="w">u</span> <span class="w">and</span> <span class="w">latency</span> <span class="pc">%u</span><span class="c">",</span><span class="w">l</span><span class="pc">oc</span><span class="c">al_proc</span><span class="pc">.</span><span class="c">id,</span> <span class="pc">f</span><span class="c">ramebuffer_mem.id</span><span class="pc">,</span>
          <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">0</span><span class="pc">].</span><span class="w">b</span><span class="c">andwidth</span><span class="pc">,</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">0].</span><span class="w">l</span><span class="c">atency</span><span class="pc">)</span><span class="c">;</span>
    <span class="pc">}</span>
    
    <span class="w">{</span>
      
      
      <span class="pc">a</span><span class="c">ssert</span><span class="pc">(!</span><span class="w">cpu_procs</span><span class="pc">.em</span><span class="c">pty</span><span class="pc">());</span>
      <span class="w">s</span><span class="pc">td</span><span class="c">::</span><span class="pc">v</span><span class="c">ector&lt;</span><span class="w">ProcessorMemoryAffinity</span><span class="pc">&gt;</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult;</span>
      <span class="w">m-</span><span class="c">&gt;</span><span class="w">get_proc_mem_affinity</span><span class="c">(</span><span class="w">re</span><span class="pc">s</span><span class="c">ult</span><span class="w">, (c</span><span class="pc">p</span><span class="c">u_procs.</span><span class="w">front()));</span>
      <span class="w">a</span><span class="c">ssert</span><span class="pc">(!</span><span class="w">r</span><span class="c">esult.</span><span class="w">e</span><span class="pc">m</span><span class="c">pty());</span>
      <span class="w">u</span><span class="c">nsigned</span> <span class="w">min_idx</span> <span class="c">=</span> <span class="c">0</span><span class="pc">;</span>
      <span class="w">u</span><span class="c">nsigned</span> <span class="w">min_bandwidth</span> <span class="c">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[0].</span><span class="w">bandwidth</span><span class="c">;</span>
      <span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">idx</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span> <span class="c">idx</span> <span class="c">&lt;</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult.</span><span class="pc">s</span><span class="c">ize();</span> <span class="c">idx++)</span>
      <span class="c">{</span>
        <span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">idx].</span><span class="w">b</span><span class="pc">a</span><span class="c">ndwidth</span> <span class="w">&lt;</span> <span class="pc">min_b</span><span class="c">andwidth</span><span class="w">)</span>
        <span class="pc">{</span>
          <span class="pc">m</span><span class="c">in_bandwidth</span> <span class="c">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">idx].bandwidth;</span>
          <span class="w">min_idx</span> <span class="pc">=</span> <span class="w">i</span><span class="c">dx;</span>
        <span class="c">}</span>
      <span class="pc">}</span>
      <span class="w">gasnet_mem</span> <span class="c">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult[</span><span class="w">m</span><span class="pc">i</span><span class="c">n_idx</span><span class="pc">].</span><span class="w">m</span><span class="c">;</span>
      <span class="w">log_mapper</span><span class="pc">.</span><span class="w">i</span><span class="pc">nf</span><span class="c">o("</span><span class="w">GPU</span> <span class="c">%x</span> <span class="w">has</span> <span class="w">gasnet</span> <span class="w">me</span><span class="c">mory</span> <span class="pc">%x</span> <span class="w">with</span> <span class="w">"</span>
          <span class="w">"b</span><span class="pc">a</span><span class="c">ndwidth</span> <span class="pc">%</span><span class="w">u</span> <span class="w">and</span> <span class="w">latency</span> <span class="pc">%</span><span class="w">u</span><span class="pc">"</span><span class="c">,</span><span class="w">l</span><span class="c">ocal_proc</span><span class="pc">.</span><span class="c">id,gasnet_mem</span><span class="pc">.</span><span class="c">id,</span>
          <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="w">m</span><span class="c">in_idx</span><span class="pc">].</span><span class="w">b</span><span class="c">andwidth</span><span class="pc">,</span><span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="w">[m</span><span class="c">in_idx].</span><span class="w">l</span><span class="c">atency</span><span class="w">)</span><span class="pc">;</span>
    <span class="pc">}</span>
  <span class="c">}</span>
<span class="pc">}</span>

<span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="w">CircuitMapper</span><span class="pc">:</span><span class="c">:</span><span class="w">spawn_task</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="pc">T</span><span class="c">ask</span> <span class="c">*task</span><span class="pc">)</span>
<span class="c">{</span>
  <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">ask</span><span class="c">-&gt;</span><span class="pc">t</span><span class="c">ask_id</span> <span class="pc">=</span><span class="c">=</span> <span class="w">REGION_MAIN</span><span class="pc">)</span>
    <span class="pc">r</span><span class="c">eturn</span> <span class="c">false;</span>
  <span class="pc">r</span><span class="c">eturn</span> <span class="c">true;</span>
<span class="c">}</span>

<span class="w">P</span><span class="pc">ro</span><span class="c">cessor</span> <span class="pc">C</span><span class="c">ircuitMapper</span><span class="pc">:</span><span class="c">:</span><span class="w">select_target_processor</span><span class="c">(const</span> <span class="c">Task</span> <span class="c">*task</span><span class="pc">)</span>
<span class="c">{</span>
  <span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">t</span><span class="c">ask-&gt;</span><span class="pc">t</span><span class="c">ask_id</span> <span class="c">==</span> <span class="w">R</span><span class="pc">E</span><span class="c">GION_MAIN</span><span class="pc">)</span>
    <span class="pc">r</span><span class="c">eturn</span> <span class="w">l</span><span class="c">ocal_proc;</span>
  
  <span class="w">a</span><span class="c">ssert(</span><span class="pc">t</span><span class="c">ask-&gt;</span><span class="w">is_index_space)</span><span class="pc">;</span>

  <span class="w">D</span><span class="pc">omainP</span><span class="c">oint</span> <span class="w">po</span><span class="c">int</span> <span class="c">=</span> <span class="c">task-&gt;</span><span class="w">index_point;</span>
  <span class="w">u</span><span class="c">nsigned</span> <span class="w">proc_id</span> <span class="c">=</span> <span class="w">p</span><span class="pc">o</span><span class="c">int.</span><span class="w">get_index() %</span> <span class="w">gpu_procs.s</span><span class="c">ize</span><span class="pc">();</span>
  <span class="pc">r</span><span class="c">eturn</span> <span class="w">g</span><span class="pc">p</span><span class="c">u_procs</span><span class="pc">[</span><span class="w">p</span><span class="pc">r</span><span class="c">oc_id];</span>
<span class="c">}</span>

<span class="pc">P</span><span class="c">rocessor</span> <span class="w">CircuitMapper:</span><span class="c">:</span><span class="w">target_task_steal</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="pc">s</span><span class="c">td::set&lt;</span><span class="pc">P</span><span class="c">rocessor&gt; &amp;</span><span class="w">blacklisted</span><span class="pc">)</span>
<span class="c">{</span>
  
  <span class="pc">r</span><span class="c">eturn</span> <span class="w">P</span><span class="c">rocessor::</span><span class="w">NO_PROC</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">C</span><span class="c">ircuitMapper::</span><span class="w">permit_task_steal</span><span class="c">(</span><span class="pc">P</span><span class="c">rocessor</span> <span class="w">thief</span><span class="c">,</span> <span class="w">c</span><span class="c">onst</span> <span class="c">std::vector&lt;</span><span class="w">c</span><span class="c">onst</span> <span class="w">T</span><span class="c">ask</span><span class="pc">*</span><span class="c">&gt; &amp;</span><span class="w">tasks</span><span class="pc">,</span>
                                      <span class="w">s</span><span class="pc">t</span><span class="c">d::</span><span class="pc">s</span><span class="c">et&lt;</span><span class="pc">c</span><span class="c">onst</span> <span class="c">Task*&gt; &amp;</span><span class="w">to_steal)</span>
<span class="c">{</span>
  
<span class="w">}</span>

<span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="w">C</span><span class="c">ircuitMapper</span><span class="pc">:</span><span class="c">:</span><span class="w">map_task_region</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="c">Task</span> <span class="c">*task,</span> <span class="c">Processor</span> <span class="c">target,</span> 
                                <span class="c">MappingTagID</span> <span class="c">tag,</span> <span class="c">bool</span> <span class="w">inline_mapping</span><span class="c">,</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">pre_mapping</span><span class="pc">,</span>
                                <span class="c">const</span> <span class="c">RegionRequirement</span> <span class="c">&amp;req,</span> <span class="c">unsigned</span> <span class="c">index,</span>
                                <span class="c">const</span> <span class="c">std::map&lt;Memory,bool&gt; &amp;</span><span class="w">current_instances</span><span class="c">,</span>
                                <span class="c">std::vector&lt;Memory&gt; &amp;</span><span class="w">target_ranking</span><span class="c">,</span>
                                <span class="c">std::set&lt;FieldID&gt; &amp;</span><span class="w">additional_fields</span><span class="c">,</span> 
                                <span class="c">bool</span> <span class="c">&amp;</span><span class="w">enable_WAR_optimization</span><span class="pc">)</span>
<span class="c">{</span>
  
  <span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">local_kind</span> <span class="w">=</span><span class="c">=</span> <span class="w">P</span><span class="c">rocessor::</span><span class="w">LOC_PROC</span><span class="pc">)</span>
  <span class="c">{</span>
    <span class="w">a</span><span class="pc">s</span><span class="c">sert(</span><span class="w">t</span><span class="c">ask-&gt;</span><span class="pc">t</span><span class="c">ask_id</span> <span class="w">=</span><span class="c">=</span> <span class="w">REGION_MAIN</span><span class="c">);</span>
    
    <span class="w">t</span><span class="pc">ar</span><span class="c">get_ranking.push_back(</span><span class="w">gasnet_mem</span><span class="c">);</span>
  <span class="c">}</span>
  <span class="pc">e</span><span class="c">lse</span> 
  <span class="c">{</span>
    <span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">t</span><span class="pc">as</span><span class="c">k-&gt;</span><span class="pc">t</span><span class="c">ask_id)</span>
    <span class="pc">{</span>
      <span class="pc">c</span><span class="c">ase</span> <span class="w">CALC_NEW_CURRENTS</span><span class="pc">:</span>
        <span class="pc">{</span>
          <span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="w">i</span><span class="c">ndex</span><span class="pc">)</span>
          <span class="c">{</span>
            <span class="pc">c</span><span class="c">ase</span> <span class="w">0</span><span class="pc">:</span>
              <span class="c">{</span>
                
                <span class="w">t</span><span class="c">arget_ranking</span><span class="w">.</span><span class="pc">p</span><span class="c">ush_back(</span><span class="w">framebuffer_mem</span><span class="c">);</span>
                
                <span class="w">enable_WAR_optimization</span> <span class="pc">=</span> <span class="w">f</span><span class="c">alse;</span>
                <span class="pc">b</span><span class="c">reak</span><span class="pc">;</span>
              <span class="c">}</span>
            <span class="pc">c</span><span class="c">ase</span> <span class="pc">1:</span>
              <span class="c">{</span>
                
                <span class="w">t</span><span class="c">arget_ranking</span><span class="pc">.pu</span><span class="c">sh_back(</span><span class="w">f</span><span class="pc">r</span><span class="c">amebuffer_mem);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="c">case</span> <span class="pc">2</span><span class="c">:</span>
              <span class="c">{</span>
                
                <span class="w">t</span><span class="c">arget_ranking.</span><span class="pc">p</span><span class="c">ush_back(</span><span class="w">zero_copy_mem</span><span class="pc">)</span><span class="c">;</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="c">case</span> <span class="c">3:</span>
              <span class="c">{</span>
                
                <span class="pc">t</span><span class="c">arget_ranking.</span><span class="w">p</span><span class="c">ush_back(</span><span class="w">z</span><span class="c">ero_copy_mem);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="pc">d</span><span class="c">efault:</span>
              <span class="pc">a</span><span class="c">ssert(false);</span>
          <span class="c">}</span>
          <span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
        <span class="c">}</span>
      <span class="w">c</span><span class="c">ase</span> <span class="w">DISTRIBUTE_CHARGE</span><span class="c">:</span>
        <span class="c">{</span>
          <span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="pc">i</span><span class="c">ndex)</span>
          <span class="c">{</span>
            <span class="pc">c</span><span class="c">ase</span> <span class="w">0</span><span class="pc">:</span>
              <span class="c">{</span>
                
                <span class="pc">t</span><span class="c">arget_ranking</span><span class="pc">.</span><span class="w">p</span><span class="c">ush_back(</span><span class="w">framebuffer_mem</span><span class="c">);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="c">case</span> <span class="w">1</span><span class="c">:</span>
              <span class="c">{</span>
                
                <span class="w">t</span><span class="c">arget_ranking.</span><span class="w">p</span><span class="pc">u</span><span class="c">sh_back(</span><span class="w">f</span><span class="pc">r</span><span class="c">amebuffer_mem);</span>
                
                <span class="w">enable_WAR_optimization</span> <span class="pc">=</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse;</span>
                <span class="c">break</span><span class="pc">;</span>
              <span class="c">}</span>
            <span class="pc">c</span><span class="c">ase</span> <span class="w">2</span><span class="c">:</span>
              <span class="c">{</span>
                
                <span class="w">t</span><span class="c">arget_ranking.push_back(</span><span class="w">zero_copy_mem</span><span class="c">);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="c">case</span> <span class="pc">3</span><span class="c">:</span>
              <span class="c">{</span>
                
                <span class="w">t</span><span class="pc">a</span><span class="c">rget_ranking.</span><span class="pc">p</span><span class="c">ush_back(</span><span class="w">z</span><span class="c">ero_copy_mem);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="pc">d</span><span class="c">efault:</span>
              <span class="c">assert(</span><span class="pc">f</span><span class="c">alse);</span>
          <span class="c">}</span>
          <span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
        <span class="c">}</span>
      <span class="w">c</span><span class="c">ase</span> <span class="w">UPDATE_VOLTAGES</span><span class="c">:</span>
        <span class="c">{</span>
          <span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="pc">i</span><span class="c">ndex)</span>
          <span class="c">{</span>
            <span class="pc">c</span><span class="c">ase</span> <span class="w">0</span><span class="pc">:</span>
              <span class="c">{</span>
                
                <span class="pc">t</span><span class="c">arget_ranking</span><span class="pc">.</span><span class="w">p</span><span class="c">ush_back(</span><span class="w">framebuffer_mem</span><span class="c">);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="c">case</span> <span class="w">1</span><span class="c">:</span>
              <span class="c">{</span>
                
                <span class="w">t</span><span class="c">arget_ranking.</span><span class="w">p</span><span class="pc">u</span><span class="c">sh_back(</span><span class="w">zero_copy_mem</span><span class="c">);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="pc">}</span>
            <span class="c">case</span> <span class="w">2</span><span class="c">:</span>
              <span class="c">{</span>
                
                <span class="pc">t</span><span class="c">arget_ranking.</span><span class="w">p</span><span class="c">ush_back(</span><span class="w">f</span><span class="c">ramebuffer_mem);</span>
                <span class="pc">b</span><span class="c">reak;</span>
              <span class="c">}</span>
            <span class="pc">d</span><span class="c">efault:</span>
              <span class="pc">a</span><span class="c">ssert(false);</span>
          <span class="c">}</span>
          <span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
        <span class="c">}</span>
      <span class="w">d</span><span class="c">efault:</span>
        <span class="pc">a</span><span class="c">ssert(false);</span>
    <span class="c">}</span>
  <span class="c">}</span>
  <span class="w">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">CircuitMapper</span><span class="c">::</span><span class="w">rank_copy_target</span><span class="c">(const</span> <span class="pc">T</span><span class="c">ask</span> <span class="c">*task,</span> <span class="pc">P</span><span class="c">rocessor</span> <span class="c">target,</span>
                                      <span class="pc">M</span><span class="c">appingTagID</span> <span class="c">tag</span><span class="pc">,</span> <span class="c">bool</span> <span class="w">inline_mapping</span><span class="c">,</span>
                                      <span class="pc">c</span><span class="c">onst</span> <span class="c">RegionRequirement</span> <span class="c">&amp;</span><span class="pc">req</span><span class="c">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">index,</span>
                                      <span class="c">const</span> <span class="c">std::set&lt;Memory&gt; &amp;</span><span class="w">current_instances</span><span class="c">,</span>
                                      <span class="c">std::set&lt;Memory&gt; &amp;</span><span class="w">to_reuse</span><span class="c">,</span>
                                      <span class="c">std::vector&lt;Memory&gt; &amp;</span><span class="w">to_create</span><span class="c">,</span>
                                      <span class="c">bool</span> <span class="c">&amp;</span><span class="w">create_one</span><span class="pc">)</span>
<span class="c">{</span>
  
  <span class="w">a</span><span class="c">ssert(</span><span class="w">c</span><span class="pc">u</span><span class="c">rrent_instances</span><span class="pc">.</span><span class="c">find(</span><span class="w">gasnet_mem)</span><span class="pc"> !</span><span class="c">=</span> <span class="w">c</span><span class="pc">u</span><span class="c">rrent_instances.end());</span>
  <span class="pc">t</span><span class="c">o_reuse.</span><span class="pc">i</span><span class="c">nsert(</span><span class="w">g</span><span class="c">asnet_mem);</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">CircuitMapper</span><span class="pc">:</span><span class="c">:</span><span class="w">slice_domain</span><span class="c">(const</span> <span class="w">T</span><span class="c">ask</span> <span class="c">*task,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">D</span><span class="c">omain&amp;</span> <span class="pc">d</span><span class="c">omain,</span>
                                 <span class="pc">st</span><span class="c">d::vector&lt;</span><span class="w">M</span><span class="pc">ap</span><span class="c">per::</span><span class="w">DomainSplit&gt;</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">slices)</span>
<span class="c">{</span>
  <span class="w">DefaultMapper:</span><span class="c">:</span><span class="w">decompose_index_space</span><span class="c">(</span><span class="w">d</span><span class="c">omain,</span> <span class="w">gpu_procs</span><span class="pc">,</span>
                                       <span class="pc">1</span><span class="c">,</span> <span class="pc">s</span><span class="c">lices);</span>
<span class="c">}</span>




</pre>
</body>
</html>

