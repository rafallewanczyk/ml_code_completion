<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>






<span class="w">import</span> <span class="w">types,</span> <span class="w">operator,</span> <span class="w">os</span>
<span class="w">from</span> <span class="w">random</span> <span class="w">import</span> <span class="w">randint</span>
<span class="w">from</span> <span class="w">urllib</span> <span class="w">import</span> <span class="w">quote,</span> <span class="w">unquote</span>
<span class="w">from</span> <span class="w">hashlib</span> <span class="w">import</span> <span class="w">md5</span>

<span class="w">from</span> <span class="w">twisted.python</span> <span class="w">import</span> <span class="w">failure,</span> <span class="w">log</span>
<span class="w">from</span> <span class="w">twisted.internet</span> <span class="w">import</span> <span class="w">reactor</span>
<span class="w">from</span> <span class="w">twisted.internet.defer</span> <span class="c">import</span> <span class="c">Deferred</span><span class="pc">,</span> <span class="w">execute</span>
<span class="c">from</span> <span class="c">twisted.internet</span><span class="pc">.p</span><span class="c">rotocol</span> <span class="c">import</span> <span class="w">C</span><span class="pc">li</span><span class="c">entFactory</span>
<span class="w">t</span><span class="c">ry:</span>
    <span class="c">from</span> <span class="c">twisted.internet</span><span class="pc">.</span><span class="w">s</span><span class="c">sl</span> <span class="c">import</span> <span class="w">ClientContextFactory</span>
<span class="pc">e</span><span class="c">xcept</span> <span class="c">ImportError:</span>
    <span class="w">C</span><span class="c">lientContextFactory</span> <span class="c">=</span> <span class="c">None</span>
<span class="pc">f</span><span class="c">rom</span> <span class="c">twisted.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocols.</span><span class="w">b</span><span class="c">asic</span> <span class="c">import</span> <span class="w">L</span><span class="c">ineReceiver</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="w">w</span><span class="c">eb</span><span class="pc">.</span><span class="w">h</span><span class="c">ttp</span> <span class="c">import</span> <span class="w">HTTPClient</span>


<span class="w">MSN_PROTOCOL_VERSION</span> <span class="w">=</span><span class="pc"> "</span><span class="w">MSNP8</span> <span class="w">CVR0"</span>       
<span class="w">MSN_PORT</span>             <span class="pc">=</span> <span class="w">1863</span>               
<span class="w">MSN_MAX_MESSAGE</span>      <span class="c">=</span> <span class="w">1664</span>               
<span class="w">MSN_CHALLENGE_STR</span>    <span class="w">=</span><span class="pc"> "</span><span class="w">Q1P7W2E4J9R8U3S5</span><span class="c">"</span> 
<span class="w">MSN_CVR_STR</span>          <span class="pc">= </span><span class="c">"</span><span class="w">0x0409</span> <span class="w">win</span> <span class="w">4</span><span class="pc">.</span><span class="w">10</span> <span class="w">i386</span> <span class="w">MSNMSGR</span> <span class="w">5.</span><span class="pc">0</span><span class="c">.</span><span class="w">0544</span> <span class="w">MSMSGS</span><span class="pc">"</span> 


<span class="w">LOGIN_SUCCESS</span>  <span class="w">=</span> <span class="pc">1</span>
<span class="w">LOGIN_FAILURE</span>  <span class="c">=</span> <span class="w">2</span>
<span class="w">LOGIN_REDIRECT</span> <span class="c">=</span> <span class="w">3</span>


<span class="w">FORWARD_LIST</span> <span class="c">=</span> <span class="pc">1</span>
<span class="w">ALLOW_LIST</span>   <span class="c">=</span> <span class="pc">2</span>
<span class="w">BLOCK_LIST</span>   <span class="c">=</span> <span class="w">4</span>
<span class="w">REVERSE_LIST</span> <span class="c">=</span> <span class="w">8</span>


<span class="w">HOME_PHONE</span>   <span class="w">= </span><span class="pc">"</span><span class="w">PHH</span><span class="pc">"</span>
<span class="w">WORK_PHONE</span>   <span class="pc">= </span><span class="c">"</span><span class="w">PHW</span><span class="c">"</span>
<span class="w">MOBILE_PHONE</span> <span class="pc">= </span><span class="c">"</span><span class="w">PHM</span><span class="c">"</span>
<span class="w">HAS_PAGER</span>    <span class="c">= "</span><span class="w">MOB</span><span class="c">"</span>


<span class="w">STATUS_ONLINE</span>  <span class="w">=</span><span class="pc"> '</span><span class="w">NLN</span><span class="pc">'</span>
<span class="w">STATUS_OFFLINE</span> <span class="pc">= '</span><span class="w">FLN</span><span class="pc">'</span>
<span class="w">STATUS_HIDDEN</span>  <span class="pc">= </span><span class="c">'</span><span class="w">HDN</span><span class="c">'</span>
<span class="w">STATUS_IDLE</span>    <span class="c">= '</span><span class="w">IDL</span><span class="c">'</span>
<span class="w">STATUS_AWAY</span>    <span class="pc">= </span><span class="c">'</span><span class="w">AWY</span><span class="c">'</span>
<span class="w">STATUS_BUSY</span>    <span class="c">= '</span><span class="w">BSY</span><span class="c">'</span>
<span class="w">STATUS_BRB</span>     <span class="c">= '</span><span class="w">BRB</span><span class="c">'</span>
<span class="w">STATUS_PHONE</span>   <span class="c">= '</span><span class="w">PHN</span><span class="c">'</span>
<span class="w">STATUS_LUNCH</span>   <span class="c">= '</span><span class="w">LUN</span><span class="c">'</span>

<span class="w">CR</span> <span class="w">= "\r</span><span class="pc">"</span>
<span class="w">LF</span> <span class="w">= "</span><span class="pc">\</span><span class="w">n</span><span class="pc">"</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">SSLRequired</span><span class="c">(</span><span class="w">E</span><span class="c">xception):</span>
    



<span class="c">def</span> <span class="w">checkParamLen</span><span class="c">(</span><span class="w">nu</span><span class="pc">m,</span> <span class="w">e</span><span class="c">xpected</span><span class="pc">,</span> <span class="w">cm</span><span class="c">d</span><span class="pc">,</span> <span class="w">er</span><span class="c">ror</span><span class="pc">=</span><span class="c">None):</span>
    <span class="c">if</span> <span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="pc">==</span> <span class="c">None:</span>
        <span class="w">er</span><span class="pc">ror</span> <span class="pc">= </span><span class="c">"</span><span class="w">I</span><span class="c">nvalid</span> <span class="w">Number</span> <span class="w">o</span><span class="pc">f</span> <span class="w">Parameters</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">%</span><span class="c">s</span><span class="w">"</span><span class="pc"> %</span> <span class="w">c</span><span class="pc">m</span><span class="c">d</span>
    <span class="w">i</span><span class="c">f</span> <span class="w">nu</span><span class="pc">m</span> <span class="pc">!</span><span class="c">=</span> <span class="w">e</span><span class="pc">x</span><span class="c">pected:</span>
        <span class="pc">ra</span><span class="c">ise</span> <span class="w">MSNProtocolError</span><span class="pc">,</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r</span>

<span class="w">d</span><span class="c">ef</span> <span class="w">_parseHeader</span><span class="c">(</span><span class="w">h</span><span class="pc">,</span> <span class="w">v</span><span class="c">):</span>
    

    <span class="c">if</span> <span class="w">h</span> <span class="w">i</span><span class="pc">n</span> <span class="w">(</span><span class="pc">'</span><span class="w">passporturls','authentication-in</span><span class="pc">f</span><span class="c">o</span><span class="w">'</span><span class="pc">,</span><span class="c">'</span><span class="w">ww</span><span class="c">w</span><span class="pc">-</span><span class="w">authenticate'</span><span class="pc">):</span>
        <span class="w">v</span> <span class="c">=</span> <span class="w">v</span><span class="c">.</span><span class="pc">r</span><span class="c">eplace</span><span class="pc">('</span><span class="w">Passport1.4','').lstrip()</span>
        <span class="w">fields</span> <span class="w">= {</span><span class="pc">}</span>
        <span class="c">for</span> <span class="w">fieldPair</span> <span class="c">in</span> <span class="w">v</span><span class="pc">.</span><span class="c">split</span><span class="w">(','):</span>
            <span class="w">t</span><span class="pc">r</span><span class="c">y:</span>
                <span class="w">field</span><span class="pc">,</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="w">f</span><span class="c">ieldPair.split</span><span class="w">('=',</span><span class="c">1)</span>
                <span class="w">f</span><span class="pc">ields</span><span class="w">[f</span><span class="c">ield.</span><span class="pc">l</span><span class="c">ower</span><span class="w">()] =</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue</span>
            <span class="w">exc</span><span class="pc">ept</span> <span class="w">V</span><span class="c">alueError:</span>
                <span class="w">f</span><span class="pc">ields</span><span class="w">[</span><span class="pc">f</span><span class="c">ield</span><span class="pc">.l</span><span class="c">ower</span><span class="w">()] = ''</span>
        <span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">f</span><span class="pc">ields</span>
    <span class="pc">e</span><span class="c">lse:</span>
        <span class="c">return</span> <span class="w">v</span>

<span class="c">def</span> <span class="w">_parsePrimitiveHost</span><span class="c">(</span><span class="w">h</span><span class="c">ost</span><span class="pc">)</span><span class="c">:</span>
    
    <span class="w">h</span><span class="pc">,</span><span class="w">p</span> <span class="pc">=</span> <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">.</span><span class="w">r</span><span class="pc">ep</span><span class="c">lace</span><span class="pc">('</span><span class="w">https://','').s</span><span class="pc">p</span><span class="c">lit</span><span class="w">('/',</span><span class="c">1</span><span class="pc">)</span>
    <span class="w">p</span> <span class="w">= '/' +</span> <span class="w">p</span>
    <span class="w">r</span><span class="c">eturn</span> <span class="w">h,</span><span class="pc">p</span>


<span class="w">d</span><span class="c">ef</span> <span class="w">_login</span><span class="c">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="w">passwd</span><span class="pc">,</span> <span class="w">nexusServer</span><span class="pc">,</span> <span class="w">cached</span><span class="pc">=0</span><span class="c">,</span> <span class="w">authData=''):</span>
    
    <span class="w">i</span><span class="c">f</span> <span class="w">ClientContextFactory</span> <span class="pc">i</span><span class="c">s</span> <span class="pc">N</span><span class="c">one:</span>
        <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">SSLRequired</span><span class="pc">(</span>
            <span class="pc">'</span><span class="w">Connecting</span> <span class="w">t</span><span class="c">o</span> <span class="w">t</span><span class="c">he</span> <span class="w">Passport</span> <span class="w">se</span><span class="pc">r</span><span class="c">ver</span> <span class="w">requires</span> <span class="w">S</span><span class="pc">SL,</span> <span class="w">but</span> <span class="w">S</span><span class="pc">SL</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">'</span>
            <span class="w">'unavailable.</span><span class="pc">'</span><span class="c">)</span>

    <span class="w">cb</span> <span class="c">=</span> <span class="w">D</span><span class="c">eferred()</span>
    <span class="c">def</span> <span class="w">_cb</span><span class="c">(</span><span class="w">se</span><span class="pc">rve</span><span class="c">r,</span> <span class="w">au</span><span class="pc">th</span><span class="c">):</span>
        <span class="w">loginFac</span> <span class="c">=</span> <span class="w">C</span><span class="pc">lientF</span><span class="c">actory()</span>
        <span class="w">l</span><span class="c">oginFac.protocol</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ambda</span> <span class="c">:</span> <span class="w">PassportLogin</span><span class="c">(</span><span class="w">cb</span><span class="c">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="w">passwd</span><span class="pc">,</span> <span class="w">s</span><span class="c">erver</span><span class="pc">,</span> <span class="w">au</span><span class="c">th</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">connectSSL</span><span class="c">(</span><span class="w">_parsePrimitiveHost</span><span class="pc">(</span><span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="w">)[</span><span class="c">0</span><span class="pc">],</span> <span class="w">443</span><span class="pc">,</span> <span class="c">loginFac,</span> <span class="w">ClientContextFactory</span><span class="pc">(</span><span class="c">))</span>

    <span class="pc">i</span><span class="c">f</span> <span class="w">cached</span><span class="pc">:</span>
        <span class="w">_cb(nexusServer</span><span class="c">,</span> <span class="w">authData</span><span class="pc">)</span>
    <span class="w">e</span><span class="c">lse:</span>
        <span class="w">fac</span> <span class="c">=</span> <span class="w">C</span><span class="pc">lientF</span><span class="c">actory()</span>
        <span class="w">d</span> <span class="c">=</span> <span class="w">D</span><span class="c">eferred()</span>
        <span class="w">d</span><span class="c">.</span><span class="w">a</span><span class="pc">ddCallbacks</span><span class="c">(</span><span class="pc">_</span><span class="c">cb</span><span class="pc">,</span> <span class="w">callbackArgs=(</span><span class="pc">a</span><span class="c">uthData</span><span class="w">,</span><span class="pc">)</span><span class="c">)</span>
        <span class="pc">d</span><span class="c">.</span><span class="pc">addE</span><span class="c">rrback(</span><span class="pc">l</span><span class="c">ambda</span> <span class="w">f</span><span class="c">:</span> <span class="w">cb</span><span class="pc">.</span><span class="w">e</span><span class="c">rrback(</span><span class="w">f</span><span class="pc">))</span>
        <span class="w">f</span><span class="pc">a</span><span class="c">c.</span><span class="w">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="c">lambda</span> <span class="pc">:</span> <span class="w">PassportNexus</span><span class="c">(</span><span class="w">d</span><span class="c">,</span> <span class="w">nexusServer</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">connectSSL</span><span class="c">(</span><span class="w">_parsePrimitiveHost</span><span class="pc">(n</span><span class="c">exusServer</span><span class="w">)[</span><span class="c">0</span><span class="pc">],</span> <span class="w">443</span><span class="pc">,</span> <span class="pc">f</span><span class="c">ac</span><span class="pc">,</span> <span class="w">ClientContextFactory(</span><span class="pc">)</span><span class="c">)</span>
    <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">cb</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">P</span><span class="c">assportNexus(</span><span class="w">HTTPClient</span><span class="c">):</span>

    

    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">,</span> <span class="w">h</span><span class="c">ost</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">d</span><span class="c">eferred</span> <span class="c">=</span> <span class="w">d</span><span class="pc">eferr</span><span class="c">ed</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">h</span><span class="pc">ost</span><span class="w">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">pa</span><span class="pc">t</span><span class="c">h</span> <span class="pc">=</span> <span class="w">_parsePrimitiveHost</span><span class="pc">(</span><span class="w">h</span><span class="c">ost</span><span class="pc">)</span>

    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        <span class="w">H</span><span class="c">TTPClient</span><span class="pc">.</span><span class="w">co</span><span class="pc">nnectionM</span><span class="c">ade(self</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">sendCommand(</span><span class="pc">'</span><span class="w">G</span><span class="c">ET',</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">p</span><span class="c">ath</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">sendHeader(</span><span class="pc">'</span><span class="w">Host</span><span class="pc">',</span> <span class="c">self.</span><span class="w">h</span><span class="c">ost)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">endHeaders</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders</span> <span class="w">= </span><span class="pc">{</span><span class="c">}</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handleHeader</span><span class="c">(self</span><span class="pc">,</span> <span class="w">h</span><span class="pc">ea</span><span class="c">der</span><span class="pc">,</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue):</span>
        <span class="w">h</span> <span class="c">=</span> <span class="w">h</span><span class="pc">eader</span><span class="c">.</span><span class="w">l</span><span class="c">ower()</span>
        <span class="c">self.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="w">[h</span><span class="c">] =</span> <span class="w">_parseHeader</span><span class="c">(</span><span class="w">h</span><span class="pc">,</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue)</span>

    <span class="c">def</span> <span class="w">handleEndHeaders</span><span class="c">(self):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnected:</span>
            <span class="c">self.transport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">'passporturls</span><span class="pc">'</span> <span class="c">not</span> <span class="pc">i</span><span class="c">n</span> <span class="c">self.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="w">o</span><span class="c">r</span> <span class="w">'dalogin'</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">i</span><span class="c">n</span> <span class="c">self.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="w">[</span><span class="c">'</span><span class="w">p</span><span class="pc">a</span><span class="c">ssporturls</span><span class="pc">']:</span>
            <span class="c">self.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.errback(</span><span class="w">f</span><span class="c">ailure.Failure(</span><span class="pc">f</span><span class="c">ailure.</span><span class="w">DefaultException("I</span><span class="c">nvalid</span> <span class="w">Nexus</span> <span class="w">Reply")))</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">d</span><span class="pc">ef</span><span class="c">erred.</span><span class="w">c</span><span class="c">allback</span><span class="w">('https://' +</span> <span class="w">s</span><span class="c">elf.</span><span class="w">he</span><span class="pc">a</span><span class="c">ders</span><span class="pc">[</span><span class="c">'</span><span class="pc">p</span><span class="c">assporturls</span><span class="w">']['dalogin</span><span class="pc">']</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">handleResponse</span><span class="c">(self</span><span class="pc">,</span> <span class="w">r</span><span class="c">):</span>
        <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

<span class="pc">c</span><span class="c">lass</span> <span class="w">PassportLogin</span><span class="c">(</span><span class="w">HTTPClient</span><span class="c">):</span>
    

    <span class="w">_finished</span> <span class="c">=</span> <span class="pc">0</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="c">__init__(self,</span> <span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">passwd</span><span class="pc">,</span> <span class="w">ho</span><span class="c">st</span><span class="pc">,</span> <span class="w">authData</span><span class="pc">)</span><span class="c">:</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span> <span class="c">=</span> <span class="w">de</span><span class="pc">ferr</span><span class="c">ed</span>
        <span class="c">self.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span> <span class="c">=</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span>
        <span class="c">self.passwd</span> <span class="c">=</span> <span class="pc">p</span><span class="c">asswd</span>
        <span class="c">self.</span><span class="pc">a</span><span class="c">uthData</span> <span class="c">=</span> <span class="c">authData</span>
        <span class="c">self.</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="w">,</span> <span class="c">self.</span><span class="w">p</span><span class="pc">at</span><span class="c">h</span> <span class="pc">=</span> <span class="w">_parsePrimitiveHost</span><span class="c">(</span><span class="w">h</span><span class="c">ost</span><span class="pc">)</span>

    <span class="pc">de</span><span class="c">f</span> <span class="w">c</span><span class="c">onnectionMade(self):</span>
        <span class="c">self.</span><span class="w">sendCommand(</span><span class="pc">'</span><span class="w">G</span><span class="c">ET',</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">pat</span><span class="c">h</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">sendHeader(</span><span class="pc">'</span><span class="w">Authorization</span><span class="pc">', </span><span class="c">'</span><span class="w">Passport1</span><span class="pc">.</span><span class="w">4</span> <span class="w">OrgVerb</span><span class="pc">=</span><span class="w">G</span><span class="c">ET</span><span class="w">,OrgURL</span><span class="c">=</span><span class="w">h</span><span class="c">ttp</span><span class="pc">:</span><span class="c">//</span><span class="w">messenger</span><span class="c">.</span><span class="w">msn</span><span class="c">.com</span><span class="w">,' +</span>
                                         <span class="pc">'</span><span class="w">sign-in=%</span><span class="c">s</span><span class="w">,pw</span><span class="c">d</span><span class="w">=%</span><span class="c">s</span><span class="w">,%</span><span class="c">s</span><span class="pc">' </span><span class="c">% (</span><span class="w">quote</span><span class="pc">(s</span><span class="c">elf.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span><span class="c">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">passwd</span><span class="pc">,</span><span class="c">self.</span><span class="w">authData)</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">sendHeader(</span><span class="pc">'</span><span class="w">Host</span><span class="pc">',</span> <span class="c">self.</span><span class="w">h</span><span class="pc">ost)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">endHeaders</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handleHeader</span><span class="c">(self</span><span class="pc">,</span> <span class="w">he</span><span class="pc">a</span><span class="c">der</span><span class="pc">,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e):</span>
        <span class="w">h</span> <span class="pc">=</span> <span class="w">h</span><span class="pc">eader</span><span class="c">.</span><span class="w">l</span><span class="c">ower()</span>
        <span class="c">self.</span><span class="w">h</span><span class="c">eaders</span><span class="w">[h</span><span class="c">] =</span> <span class="w">_parseHeader</span><span class="c">(</span><span class="w">h</span><span class="pc">,</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue)</span>

    <span class="c">def</span> <span class="w">handleEndHeaders</span><span class="c">(self):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">_finished</span><span class="c">:</span>
            <span class="pc">r</span><span class="c">eturn</span>
        <span class="c">self.</span><span class="pc">_</span><span class="c">finished</span> <span class="pc">=</span> <span class="w">1</span> 
        <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">con</span><span class="pc">ne</span><span class="c">cted</span><span class="pc">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
        <span class="w">authHeader</span> <span class="w">= 'authentication</span><span class="pc">-</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">'</span>
        <span class="w">_interHeader</span> <span class="w">=</span><span class="pc"> </span><span class="c">'</span><span class="w">ww</span><span class="c">w</span><span class="pc">-</span><span class="w">authenticate</span><span class="pc">'</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">_</span><span class="c">interHeader</span> <span class="w">i</span><span class="pc">n</span> <span class="c">self.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders:</span>
            <span class="w">a</span><span class="pc">uthH</span><span class="c">eader</span> <span class="c">=</span> <span class="w">_</span><span class="pc">i</span><span class="c">nterHeader</span>
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">inf</span><span class="c">o</span> <span class="c">=</span> <span class="c">self.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders</span><span class="w">[a</span><span class="pc">u</span><span class="c">thHeader]</span>
            <span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="c">=</span> <span class="w">inf</span><span class="c">o</span><span class="pc">['</span><span class="w">da</span><span class="pc">-</span><span class="w">st</span><span class="pc">atu</span><span class="c">s</span><span class="w">']</span>
            <span class="w">ha</span><span class="pc">ndler</span> <span class="c">=</span> <span class="w">g</span><span class="c">etattr(</span><span class="pc">s</span><span class="c">elf</span><span class="pc">, </span><span class="c">'</span><span class="w">login_</span><span class="pc">%</span><span class="c">s' % (</span><span class="w">st</span><span class="pc">atu</span><span class="c">s</span><span class="w">,),</span> <span class="w">N</span><span class="c">one)</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">ha</span><span class="pc">ndler</span><span class="c">:</span>
                <span class="w">ha</span><span class="pc">ndler</span><span class="w">(inf</span><span class="c">o</span><span class="pc">)</span>
            <span class="pc">e</span><span class="c">lse:</span>
                <span class="pc">r</span><span class="c">aise</span> <span class="w">E</span><span class="c">xception()</span>
        <span class="w">e</span><span class="pc">x</span><span class="c">cept</span> <span class="w">E</span><span class="c">xception</span><span class="w">,</span> <span class="w">e</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">d</span><span class="c">eferred.errback(</span><span class="pc">f</span><span class="c">ailure</span><span class="pc">.</span><span class="c">Failure(</span><span class="w">e</span><span class="c">))</span>

    <span class="c">def</span> <span class="w">handleResponse</span><span class="c">(self</span><span class="pc">,</span> <span class="w">r</span><span class="c">):</span>
        <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

    <span class="c">def</span> <span class="w">login_success</span><span class="c">(self</span><span class="pc">,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o):</span>
        <span class="w">ticket</span> <span class="c">=</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="w">[</span><span class="pc">'</span><span class="w">fr</span><span class="c">om</span><span class="w">-pp'</span><span class="pc">]</span>
        <span class="w">t</span><span class="pc">i</span><span class="c">cket</span> <span class="pc">=</span> <span class="c">ticket</span><span class="pc">[1:</span><span class="w">l</span><span class="pc">e</span><span class="c">n(ticket</span><span class="w">)-</span><span class="c">1</span><span class="pc">]</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.</span><span class="w">c</span><span class="c">allback</span><span class="pc">((</span><span class="w">LOGIN_SUCCESS</span><span class="c">,</span> <span class="c">ticket</span><span class="pc">))</span>

    <span class="c">def</span> <span class="w">login_failed</span><span class="c">(self</span><span class="pc">,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.</span><span class="pc">c</span><span class="c">allback</span><span class="pc">((</span><span class="w">LOGIN_FAILURE</span><span class="c">,</span> <span class="w">unquote(i</span><span class="pc">nf</span><span class="c">o</span><span class="w">[</span><span class="pc">'</span><span class="w">cbtxt'])))</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">login_redir</span><span class="c">(self</span><span class="pc">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">fo):</span>
        <span class="c">self.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.</span><span class="w">c</span><span class="pc">allb</span><span class="c">ack</span><span class="pc">((</span><span class="w">LOGIN_REDIRECT</span><span class="c">,</span> <span class="c">self.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders</span><span class="w">[</span><span class="pc">'</span><span class="w">location</span><span class="pc">'],</span> <span class="c">self.</span><span class="w">authData)</span><span class="pc">)</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">MSNProtocolError</span><span class="c">(</span><span class="pc">E</span><span class="c">xception):</span>
    
    <span class="pc">p</span><span class="c">ass</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">MSNCommandFailed</span><span class="c">(</span><span class="pc">E</span><span class="c">xception):</span>
    

    <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">errorCode</span><span class="c">):</span>
        <span class="c">self.errorCode</span> <span class="c">=</span> <span class="c">errorCode</span>

    <span class="c">def</span> <span class="w">_</span><span class="pc">_s</span><span class="c">tr__(self):</span>
        <span class="c">return</span> <span class="w">(</span><span class="pc">"</span><span class="w">C</span><span class="pc">om</span><span class="c">mand</span> <span class="w">f</span><span class="pc">a</span><span class="c">iled</span><span class="w">:</span><span class="pc"> </span><span class="c">%s</span> <span class="w">(e</span><span class="pc">rror</span> <span class="w">cod</span><span class="c">e</span> <span class="pc">%</span><span class="w">d)"</span>
                <span class="w">%</span><span class="pc"> </span><span class="c">(</span><span class="w">errorCodes[</span><span class="pc">s</span><span class="c">elf.</span><span class="pc">e</span><span class="c">rrorCode</span><span class="w">]</span><span class="pc">,</span> <span class="c">self.</span><span class="pc">errorCode</span><span class="w">)</span><span class="pc">)</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">MSNMessage</span><span class="pc">:</span>
    
    <span class="w">MESSAGE_ACK</span>      <span class="w">=</span><span class="pc"> </span><span class="c">'</span><span class="w">A</span><span class="c">'</span>
    <span class="w">MESSAGE_NACK</span>     <span class="pc">= </span><span class="c">'</span><span class="w">N</span><span class="c">'</span>
    <span class="w">MESSAGE_ACK_NONE</span> <span class="c">= '</span><span class="w">U</span><span class="c">'</span>

    <span class="w">ack</span> <span class="pc">=</span> <span class="w">M</span><span class="pc">ESSAGE_ACK</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="c">__init__(self,</span> <span class="w">le</span><span class="c">ngth=</span><span class="pc">0,</span> <span class="w">u</span><span class="pc">serH</span><span class="c">andle</span><span class="w">="",</span> <span class="w">screenName="</span><span class="c">",</span> <span class="w">m</span><span class="c">essage</span><span class="w">=""):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span> <span class="pc">=</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span>
        <span class="c">self.</span><span class="pc">s</span><span class="c">creenName</span> <span class="c">=</span> <span class="w">s</span><span class="pc">c</span><span class="c">reenName</span>
        <span class="c">self.</span><span class="w">m</span><span class="pc">es</span><span class="c">sage</span> <span class="c">=</span> <span class="w">m</span><span class="pc">e</span><span class="c">ssage</span>
        <span class="c">self.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders</span> <span class="w">= {'MIME-V</span><span class="c">ersion</span><span class="w">' : '</span><span class="pc">1.</span><span class="c">0</span><span class="w">',</span><span class="pc"> </span><span class="c">'</span><span class="w">C</span><span class="pc">ont</span><span class="c">ent-</span><span class="w">Type' </span><span class="pc">:</span><span class="c"> '</span><span class="pc">t</span><span class="c">ext</span><span class="pc">/</span><span class="w">plain'}</span>
        <span class="c">self.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth</span> <span class="pc">=</span> <span class="w">l</span><span class="pc">eng</span><span class="c">th</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">readPos</span> <span class="c">=</span> <span class="pc">0</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_calcMessageLen</span><span class="c">(self):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">reduce</span><span class="c">(</span><span class="w">operator.a</span><span class="pc">dd</span><span class="w">,</span><span class="pc"> [</span><span class="w">l</span><span class="c">en(</span><span class="pc">x</span><span class="w">[</span><span class="c">0</span><span class="w">]) +</span> <span class="w">l</span><span class="c">en(</span><span class="pc">x</span><span class="w">[</span><span class="pc">1</span><span class="w">])</span><span class="pc"> </span><span class="c">+</span> <span class="w">4</span>  <span class="w">f</span><span class="c">or</span> <span class="pc">x</span> <span class="c">in</span> <span class="c">self.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders.items</span><span class="w">()]) +</span> <span class="w">l</span><span class="c">en(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">me</span><span class="pc">ssage</span><span class="w">) </span><span class="c">+</span> <span class="w">2</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">setHeader</span><span class="c">(self</span><span class="pc">,</span> <span class="w">h</span><span class="pc">ea</span><span class="c">der</span><span class="pc">,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e):</span>
        
        <span class="c">self.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">[</span><span class="w">h</span><span class="pc">eader</span><span class="c">] =</span> <span class="w">v</span><span class="c">alue</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">getHeader</span><span class="c">(self,</span> <span class="w">h</span><span class="pc">eader</span><span class="c">):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">self.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">[</span><span class="w">h</span><span class="pc">eader</span><span class="c">]</span>

    <span class="c">def</span> <span class="w">hasHeader</span><span class="c">(self,</span> <span class="w">h</span><span class="pc">eader</span><span class="c">):</span>
        
        <span class="c">return</span> <span class="w">h</span><span class="pc">eader</span> <span class="w">i</span><span class="c">n</span> <span class="c">self.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">getMessage</span><span class="c">(self):</span>
        
        <span class="c">return</span> <span class="c">self.</span><span class="w">me</span><span class="pc">ssage</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">setMessage</span><span class="c">(self,</span> <span class="w">m</span><span class="c">essage):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">m</span><span class="c">essage</span> <span class="c">=</span> <span class="w">m</span><span class="c">essage</span>

<span class="w">c</span><span class="c">lass</span> <span class="w">MSNContact</span><span class="pc">:</span>

    

    <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="w">="",</span> <span class="w">screenName="</span><span class="pc">"</span><span class="c">,</span> <span class="w">lists</span><span class="c">=</span><span class="w">0</span><span class="pc">,</span> <span class="w">gr</span><span class="c">oups</span><span class="w">=[],</span> <span class="w">st</span><span class="pc">atu</span><span class="c">s=</span><span class="pc">N</span><span class="c">one):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span> <span class="c">=</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span>
        <span class="c">self.</span><span class="pc">s</span><span class="c">creenName</span> <span class="c">=</span> <span class="pc">sc</span><span class="c">reenName</span>
        <span class="c">self.lists</span> <span class="c">=</span> <span class="c">lists</span>
        <span class="c">self.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span> <span class="pc">= </span><span class="c">[]</span> 
        <span class="pc">s</span><span class="c">elf.</span><span class="w">st</span><span class="pc">atu</span><span class="c">s</span> <span class="c">=</span> <span class="w">st</span><span class="pc">atu</span><span class="c">s</span> 

        
        <span class="c">self.</span><span class="w">homePhone</span>   <span class="c">=</span> <span class="c">None</span>
        <span class="c">self.</span><span class="w">workPhone</span>   <span class="c">=</span> <span class="c">None</span>
        <span class="c">self.</span><span class="w">mobilePhone</span> <span class="c">=</span> <span class="c">None</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">hasPager</span>    <span class="c">=</span> <span class="c">None</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">setPhone</span><span class="c">(self</span><span class="pc">,</span> <span class="w">phoneType</span><span class="c">,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e):</span>
        

        <span class="w">t</span> <span class="c">=</span> <span class="pc">p</span><span class="c">honeType.</span><span class="w">u</span><span class="c">pper()</span>
        <span class="c">if</span> <span class="w">t</span> <span class="pc">=</span><span class="c">=</span> <span class="w">HOME_PHONE</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">h</span><span class="pc">o</span><span class="c">mePhone</span> <span class="c">=</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">t</span> <span class="pc">=</span><span class="c">=</span> <span class="w">WORK_PHONE</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">workPhone</span> <span class="c">=</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">t</span> <span class="pc">=</span><span class="c">=</span> <span class="w">MOBILE_PHONE</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">mobilePhone</span> <span class="c">=</span> <span class="w">v</span><span class="c">alue</span>
        <span class="pc">e</span><span class="c">lif</span> <span class="w">t</span> <span class="pc">=</span><span class="c">=</span> <span class="w">HAS_PAGER</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">hasPager</span> <span class="pc">=</span> <span class="w">v</span><span class="c">alue</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="c">ValueError</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="w">Phone</span> <span class="w">Type"</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">addToList</span><span class="c">(self,</span> <span class="w">listType</span><span class="c">):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">lists</span> <span class="w">|=</span> <span class="c">listType</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">removeFromList</span><span class="c">(self</span><span class="pc">,</span> <span class="w">l</span><span class="c">istType):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">l</span><span class="c">ists</span> <span class="w">^=</span> <span class="c">listType</span>

<span class="w">c</span><span class="c">lass</span> <span class="w">MSNContactList</span><span class="pc">:</span>
    

    <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">contacts</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span>
        <span class="c">self.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span>
        <span class="c">self.</span><span class="w">autoAdd</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">privacy</span> <span class="c">=</span> <span class="pc">0</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_getContactsFromList</span><span class="c">(self</span><span class="pc">,</span> <span class="w">l</span><span class="pc">istT</span><span class="c">ype):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">i</span><span class="c">ct</span><span class="w">([(uH,o</span><span class="pc">bj</span><span class="c">)</span> <span class="w">f</span><span class="c">or</span> <span class="w">u</span><span class="c">H</span><span class="pc">,</span><span class="w">o</span><span class="pc">b</span><span class="c">j</span> <span class="c">in</span> <span class="c">self.</span><span class="w">contacts</span><span class="pc">.</span><span class="w">i</span><span class="c">tems()</span> <span class="pc">i</span><span class="c">f</span> <span class="w">o</span><span class="c">bj.</span><span class="w">lists</span> <span class="w">&amp;</span> <span class="w">l</span><span class="c">istType</span><span class="w">]</span><span class="pc">)</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">addContact</span><span class="c">(self</span><span class="pc">,</span> <span class="w">contact</span><span class="c">):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">ontacts</span><span class="w">[</span><span class="c">contact</span><span class="pc">.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">]</span><span class="c"> =</span> <span class="c">contact</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">remContact</span><span class="c">(self,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">d</span><span class="pc">e</span><span class="c">l</span> <span class="c">self.contacts[</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle]</span>
        <span class="c">except</span> <span class="pc">K</span><span class="c">eyError:</span>
            <span class="c">pass</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">getContact</span><span class="c">(self,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">s</span><span class="c">elf.contacts</span><span class="pc">[</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle]</span>
        <span class="c">except</span> <span class="pc">K</span><span class="c">eyError:</span>
            <span class="c">return</span> <span class="pc">N</span><span class="c">one</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">getBlockedContacts</span><span class="c">(self):</span>
        
        <span class="c">return</span> <span class="c">self.</span><span class="w">_getContactsFromList</span><span class="c">(</span><span class="w">BLOCK_LIST</span><span class="pc">)</span>

    <span class="c">def</span> <span class="w">getAuthorizedContacts</span><span class="c">(self):</span>
        
        <span class="c">return</span> <span class="c">self.</span><span class="pc">_</span><span class="c">getContactsFromList</span><span class="pc">(</span><span class="w">ALLOW_LIST</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">getReverseContacts</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">return</span> <span class="c">self._getContactsFromList(</span><span class="w">REVERSE_LIST</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">getContacts</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">return</span> <span class="c">self._getContactsFromList(</span><span class="w">FORWARD_LIST</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">setGroup</span><span class="c">(self,</span> <span class="w">i</span><span class="c">d</span><span class="pc">,</span> <span class="pc">n</span><span class="c">ame):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span><span class="pc">[</span><span class="w">i</span><span class="c">d] =</span> <span class="pc">n</span><span class="c">ame</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">remGroup</span><span class="c">(self,</span> <span class="w">i</span><span class="c">d):</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">d</span><span class="pc">e</span><span class="c">l</span> <span class="c">self.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span><span class="pc">[</span><span class="w">i</span><span class="pc">d</span><span class="c">]</span>
        <span class="pc">e</span><span class="c">xcept</span> <span class="pc">K</span><span class="c">eyError:</span>
            <span class="pc">p</span><span class="c">ass</span>
        <span class="w">f</span><span class="c">or</span> <span class="w">c</span> <span class="c">in</span> <span class="c">self.</span><span class="w">contacts</span><span class="c">:</span>
            <span class="c">if</span> <span class="w">i</span><span class="pc">d</span> <span class="w">i</span><span class="pc">n</span> <span class="w">c</span><span class="pc">.</span><span class="w">g</span><span class="pc">roups</span><span class="c">:</span>
                <span class="w">c</span><span class="c">.</span><span class="w">g</span><span class="pc">roups</span><span class="w">.r</span><span class="pc">em</span><span class="c">ove(</span><span class="w">id</span><span class="c">)</span>


<span class="w">c</span><span class="pc">l</span><span class="c">ass</span> <span class="w">MSNEventBase</span><span class="c">(</span><span class="w">L</span><span class="c">ineReceiver):</span>
    

    <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">ids</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span> 
        <span class="c">self.</span><span class="w">currentID</span> <span class="pc">=</span> <span class="w">0</span>
        <span class="c">self.</span><span class="w">co</span><span class="pc">nnecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">setLineMode</span><span class="pc">(</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">currentMessage</span> <span class="c">=</span> <span class="c">None</span>

    <span class="c">def</span> <span class="w">co</span><span class="pc">nnectionL</span><span class="c">ost(self</span><span class="pc">,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">i</span><span class="c">ds</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">conn</span><span class="pc">ecte</span><span class="c">d</span> <span class="c">=</span> <span class="w">0</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="c">connectionMade(self):</span>
        <span class="c">self.</span><span class="w">co</span><span class="pc">nnecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">1</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_fireCallback</span><span class="c">(self</span><span class="pc">,</span> <span class="w">i</span><span class="pc">d, </span><span class="c">*args):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">i</span><span class="pc">d</span> <span class="w">i</span><span class="pc">n</span> <span class="c">self.ids:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">i</span><span class="c">ds</span><span class="w">[id</span><span class="pc">][0].</span><span class="w">c</span><span class="pc">allb</span><span class="c">ack(</span><span class="w">a</span><span class="c">rgs)</span>
            <span class="w">d</span><span class="pc">el</span> <span class="c">self.ids[</span><span class="w">i</span><span class="pc">d</span><span class="c">]</span>
            <span class="c">return</span> <span class="w">1</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span>

    <span class="c">def</span> <span class="w">_nextTransactionID</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">self.</span><span class="w">currentID</span> <span class="w">+</span><span class="c">=</span> <span class="c">1</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">c</span><span class="c">urrentID</span> <span class="w">&gt;</span> <span class="w">1000</span><span class="c">:</span>
            <span class="c">self.currentID</span> <span class="c">=</span> <span class="c">1</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">self.currentID</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_createIDMapping</span><span class="c">(self,</span> <span class="pc">d</span><span class="c">ata</span><span class="pc">=</span><span class="c">None):</span>
        
        <span class="w">id</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">_</span><span class="c">nextTransactionID</span><span class="pc">(</span><span class="c">)</span>
        <span class="w">d</span> <span class="pc">=</span> <span class="pc">D</span><span class="c">eferred()</span>
        <span class="c">self.</span><span class="w">ids[i</span><span class="pc">d</span><span class="w">] = (d</span><span class="pc">,</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta)</span>
        <span class="c">return</span> <span class="pc">(</span><span class="w">i</span><span class="pc">d,</span> <span class="w">d</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">checkMessage</span><span class="c">(self,</span> <span class="w">m</span><span class="c">essage):</span>
        
        <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="c">NotImplementedError</span>

    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">li</span><span class="pc">n</span><span class="c">eReceived(self,</span> <span class="pc">l</span><span class="c">ine):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">currentMessage</span><span class="c">:</span>
            <span class="c">self.</span><span class="pc">c</span><span class="c">urrentMessage.</span><span class="w">readPos</span> <span class="w">+</span><span class="pc">=</span> <span class="w">l</span><span class="c">en(</span><span class="pc">l</span><span class="c">ine</span><span class="w">+CR+LF</span><span class="c">)</span>
            <span class="c">if</span> <span class="pc">li</span><span class="c">ne</span> <span class="w">== "":</span>
                <span class="c">self.</span><span class="w">setRawMode(</span><span class="pc">)</span>
                <span class="pc">i</span><span class="c">f</span> <span class="c">self.currentMessage</span><span class="w">.r</span><span class="c">eadPos</span> <span class="w">=</span><span class="c">=</span> <span class="pc">s</span><span class="c">elf.currentMessage</span><span class="pc">.</span><span class="w">le</span><span class="pc">ng</span><span class="c">th:</span>
                    <span class="c">self.</span><span class="w">rawDataReceived("")</span> 
                <span class="pc">r</span><span class="c">eturn</span>
            <span class="w">t</span><span class="c">ry:</span>
                <span class="w">he</span><span class="pc">ader,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ine.split</span><span class="w">(':')</span>
            <span class="w">e</span><span class="c">xcept</span> <span class="pc">V</span><span class="c">alueError:</span>
                <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="w">M</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">Header</span><span class="pc">"</span>
            <span class="w">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">urrentMessage.</span><span class="w">setHeader</span><span class="pc">(</span><span class="w">h</span><span class="pc">e</span><span class="c">ader</span><span class="pc">,</span> <span class="w">unquote(v</span><span class="pc">alu</span><span class="c">e</span><span class="w">).lstrip</span><span class="pc">()</span><span class="c">)</span>
            <span class="w">r</span><span class="c">eturn</span>
        <span class="w">t</span><span class="pc">r</span><span class="c">y:</span>
            <span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="w">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span> <span class="c">=</span> <span class="w">l</span><span class="pc">i</span><span class="c">ne.split</span><span class="w">(' ',</span> <span class="c">1)</span>
        <span class="c">except</span> <span class="pc">V</span><span class="c">alueError:</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="w">M</span><span class="c">SNProtocolError</span><span class="w">,</span><span class="pc"> </span><span class="c">"Invalid</span> <span class="w">M</span><span class="pc">e</span><span class="c">ssage</span><span class="w">, %s"</span><span class="pc"> %</span> <span class="w">r</span><span class="pc">e</span><span class="c">pr(</span><span class="w">l</span><span class="pc">i</span><span class="c">ne</span><span class="pc">)</span>

        <span class="c">if</span> <span class="pc">l</span><span class="c">en(</span><span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="w">) !=</span> <span class="w">3</span><span class="c">:</span>
            <span class="c">raise</span> <span class="w">M</span><span class="c">SNProtocolError</span><span class="w">,</span><span class="pc"> </span><span class="c">"Invalid</span> <span class="w">C</span><span class="pc">om</span><span class="c">mand</span><span class="w">,</span><span class="pc"> </span><span class="c">%</span><span class="w">s</span><span class="pc">" %</span> <span class="w">r</span><span class="pc">ep</span><span class="c">r(</span><span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="pc">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">c</span><span class="c">md.</span><span class="w">isdigit</span><span class="pc">()</span><span class="c">:</span>
            <span class="w">errorCode</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="pc">)</span>
            <span class="w">id</span> <span class="c">=</span> <span class="pc">in</span><span class="c">t(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">.</span><span class="c">split</span><span class="w">()</span><span class="pc">[0])</span>
            <span class="c">if</span> <span class="w">id</span> <span class="w">i</span><span class="pc">n</span> <span class="c">self.</span><span class="w">ids</span><span class="c">:</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="pc">i</span><span class="c">ds</span><span class="pc">[</span><span class="w">i</span><span class="pc">d</span><span class="w">]</span><span class="pc">[0].</span><span class="w">e</span><span class="pc">rrb</span><span class="c">ack(</span><span class="w">MSNCommandFailed</span><span class="pc">(</span><span class="w">e</span><span class="c">rrorCode))</span>
                <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="pc">i</span><span class="c">ds</span><span class="pc">[</span><span class="w">i</span><span class="pc">d</span><span class="c">]</span>
                <span class="pc">r</span><span class="c">eturn</span>
            <span class="w">e</span><span class="pc">l</span><span class="c">se:</span>       
                <span class="c">self.</span><span class="w">gotError</span><span class="c">(</span><span class="w">e</span><span class="c">rrorCode</span><span class="pc">)</span>
                <span class="pc">r</span><span class="c">eturn</span>

        <span class="w">ha</span><span class="pc">ndler</span> <span class="w">=</span> <span class="w">g</span><span class="c">etattr(self</span><span class="pc">, </span><span class="c">"</span><span class="w">handle_</span><span class="c">%s</span><span class="pc">" %</span> <span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="pc">.</span><span class="w">u</span><span class="pc">p</span><span class="c">per</span><span class="pc">(),</span> <span class="pc">N</span><span class="c">one)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">ha</span><span class="pc">ndler</span><span class="c">:</span>
            <span class="w">t</span><span class="c">ry:</span>
                <span class="w">han</span><span class="pc">dler(</span><span class="w">p</span><span class="c">arams</span><span class="pc">.</span><span class="c">split</span><span class="pc">())</span>
            <span class="c">except</span> <span class="w">MSNProtocolError,</span> <span class="w">w</span><span class="pc">h</span><span class="c">y:</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">gotBadLine</span><span class="pc">(</span><span class="w">l</span><span class="pc">i</span><span class="c">ne</span><span class="pc">,</span> <span class="w">w</span><span class="pc">h</span><span class="c">y</span><span class="pc">)</span>
        <span class="c">else:</span>
            <span class="c">self.</span><span class="w">handle_UNKNOWN</span><span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">d,</span> <span class="w">p</span><span class="c">arams</span><span class="w">.</span><span class="c">split</span><span class="pc">()</span><span class="c">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">rawDataReceived</span><span class="c">(self,</span> <span class="pc">d</span><span class="c">ata):</span>
        <span class="w">extra</span> <span class="w">= ""</span>
        <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">currentMessage</span><span class="pc">.</span><span class="w">readPos</span> <span class="w">+</span><span class="pc">=</span> <span class="w">l</span><span class="c">en(</span><span class="pc">d</span><span class="c">ata)</span>
        <span class="w">diff</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">c</span><span class="c">urrentMessage.</span><span class="pc">r</span><span class="c">eadPos</span> <span class="w">-</span> <span class="w">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">urrentMessage.</span><span class="w">le</span><span class="pc">ng</span><span class="c">th</span>
        <span class="w">i</span><span class="c">f</span> <span class="w">d</span><span class="pc">i</span><span class="c">ff</span> <span class="w">&gt;</span> <span class="w">0</span><span class="c">:</span>
            <span class="c">self.</span><span class="pc">c</span><span class="c">urrentMessage.</span><span class="w">me</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">=</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="w">[:-d</span><span class="pc">i</span><span class="c">ff</span><span class="w">]</span>
            <span class="w">e</span><span class="pc">x</span><span class="c">tra</span> <span class="c">=</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="w">[</span><span class="pc">-</span><span class="w">d</span><span class="c">iff</span><span class="pc">:</span><span class="c">]</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">d</span><span class="pc">i</span><span class="c">ff</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0:</span>
            <span class="c">self.</span><span class="w">c</span><span class="c">urrentMessage</span><span class="pc">.</span><span class="w">me</span><span class="pc">ssage</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">da</span><span class="c">ta</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="c">self.</span><span class="pc">c</span><span class="c">urrentMessage</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">d</span><span class="c">ata</span>
            <span class="pc">r</span><span class="c">eturn</span>
        <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="w">c</span><span class="pc">u</span><span class="c">rrentMessage.</span><span class="w">readPos</span>
        <span class="w">m</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">c</span><span class="c">urrentMessage</span>
        <span class="pc">s</span><span class="c">elf.currentMessage</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">setLineMode</span><span class="pc">(</span><span class="w">extra</span><span class="c">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="w">checkMessage(m</span><span class="c">):</span>
            <span class="pc">r</span><span class="c">eturn</span>
        <span class="c">self.</span><span class="w">gotMessage</span><span class="c">(</span><span class="w">m</span><span class="pc">)</span>

    

    <span class="c">def</span> <span class="w">handle_MSG</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">checkParamLen(l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams),</span> <span class="w">3,</span><span class="pc"> '</span><span class="w">MSG</span><span class="pc">')</span>
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">messageLen</span> <span class="c">=</span> <span class="c">int(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">2])</span>
        <span class="c">except</span> <span class="c">ValueError:</span>
            <span class="c">raise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"Invalid</span> <span class="w">Parameter</span> <span class="w">f</span><span class="c">or</span> <span class="w">M</span><span class="c">SG</span> <span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="w">ar</span><span class="pc">gu</span><span class="c">ment</span><span class="w">"</span>
        <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">currentMessage</span> <span class="pc">=</span> <span class="w">MSNMessage</span><span class="c">(</span><span class="w">le</span><span class="pc">ng</span><span class="c">th</span><span class="pc">=</span><span class="w">m</span><span class="c">essageLen</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle=</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0</span><span class="w">]</span><span class="pc">,</span> <span class="w">screenName</span><span class="c">=</span><span class="w">unquote</span><span class="c">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[1</span><span class="w">]</span><span class="pc">))</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_UNKNOWN</span><span class="c">(self,</span> <span class="w">cm</span><span class="c">d,</span> <span class="pc">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">l</span><span class="pc">o</span><span class="c">g.msg</span><span class="pc">("</span><span class="w">Received</span> <span class="w">unknown</span> <span class="w">c</span><span class="c">ommand</span> <span class="w">(</span><span class="c">%s</span><span class="w">),</span> <span class="pc">p</span><span class="c">arams</span><span class="w">:</span><span class="c"> %s" % (</span><span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="pc">,</span> <span class="w">p</span><span class="c">arams))</span>

    

    <span class="pc">d</span><span class="c">ef</span> <span class="w">gotMessage</span><span class="c">(self,</span> <span class="pc">m</span><span class="c">essage</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">r</span><span class="c">aise</span> <span class="c">NotImplementedError</span>

    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">gotBadLine</span><span class="c">(self,</span> <span class="pc">l</span><span class="c">ine</span><span class="pc">,</span> <span class="w">wh</span><span class="c">y):</span>
        
        <span class="pc">l</span><span class="c">og.msg</span><span class="pc">('</span><span class="w">E</span><span class="c">rror</span> <span class="w">in</span> <span class="w">l</span><span class="c">ine</span><span class="w">:</span><span class="pc"> </span><span class="c">%s</span> <span class="w">(</span><span class="c">%s</span><span class="w">)' % (l</span><span class="c">ine</span><span class="pc">,</span> <span class="w">wh</span><span class="c">y))</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">gotError</span><span class="c">(self,</span> <span class="w">errorCode</span><span class="c">):</span>
        
        <span class="w">l</span><span class="c">og.msg('</span><span class="w">E</span><span class="c">rror</span> <span class="c">%s</span><span class="pc">'</span><span class="c"> % (</span><span class="w">errorCodes[</span><span class="pc">e</span><span class="c">rrorCode</span><span class="w">])</span><span class="pc">)</span>



<span class="w">c</span><span class="pc">l</span><span class="c">ass</span> <span class="w">DispatchClient</span><span class="c">(</span><span class="w">MSNEventBase</span><span class="c">):</span>
    

    
    
    <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span> <span class="w">= ""</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        <span class="w">M</span><span class="c">SNEventBase</span><span class="pc">.</span><span class="w">c</span><span class="c">onnectionMade</span><span class="pc">(</span><span class="c">self)</span>
        <span class="c">self.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">('</span><span class="w">VER</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s' % (self.</span><span class="w">_nextTransactionID(</span><span class="pc">),</span> <span class="w">MSN_PROTOCOL_VERSION</span><span class="pc">))</span>

    

    <span class="c">def</span> <span class="w">handle_VER</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">id</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">_</span><span class="c">nextTransactionID</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">CVR</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="c">d</span><span class="pc">,</span> <span class="w">MSN_CVR_STR</span><span class="pc">,</span> <span class="c">self.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span><span class="c">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_CVR</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="pc">s</span><span class="c">elf.sendLine</span><span class="pc">("</span><span class="w">USR</span> <span class="c">%s</span> <span class="w">TWN</span> <span class="w">I</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (self.</span><span class="w">_nextTransactionID(</span><span class="pc">)</span><span class="c">,</span> <span class="c">self.</span><span class="w">u</span><span class="pc">serH</span><span class="c">andle</span><span class="w">)</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_XFR</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">l</span><span class="c">en(</span><span class="w">p</span><span class="c">arams</span><span class="w">) &lt;</span> <span class="w">4</span><span class="c">:</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"Invalid</span> <span class="w">nu</span><span class="c">mber</span> <span class="w">o</span><span class="c">f</span> <span class="w">parameters</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">XFR"</span>
        <span class="w">i</span><span class="pc">d</span><span class="w">,</span> <span class="w">refType</span><span class="pc">,</span> <span class="w">a</span><span class="pc">d</span><span class="c">dr</span> <span class="c">=</span> <span class="w">p</span><span class="c">arams</span><span class="w">[</span><span class="pc">:</span><span class="w">3</span><span class="c">]</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="pc">po</span><span class="c">rt</span> <span class="c">=</span> <span class="w">a</span><span class="pc">d</span><span class="c">dr</span><span class="pc">.</span><span class="c">split</span><span class="w">(':')</span>
        <span class="pc">e</span><span class="c">xcept</span> <span class="pc">V</span><span class="c">alueError:</span>
            <span class="w">h</span><span class="c">ost</span> <span class="c">=</span> <span class="w">a</span><span class="pc">ddr</span>
            <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="w">MSN_PORT</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">r</span><span class="c">efType</span> <span class="w">=</span><span class="pc">= </span><span class="c">"</span><span class="w">N</span><span class="pc">S"</span><span class="c">:</span>
            <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">gotNotificationReferral</span><span class="c">(host,</span> <span class="w">i</span><span class="c">nt(port))</span>

    

    <span class="pc">d</span><span class="c">ef</span> <span class="pc">g</span><span class="c">otNotificationReferral(self,</span> <span class="pc">h</span><span class="c">ost,</span> <span class="c">port</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">pa</span><span class="pc">ss</span>


<span class="w">c</span><span class="c">lass</span> <span class="w">NotificationClient</span><span class="c">(</span><span class="w">MSNEventBase</span><span class="c">):</span>
    

    <span class="w">f</span><span class="pc">a</span><span class="c">ctory</span> <span class="c">=</span> <span class="c">None</span> 

    <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">currentID</span><span class="pc">=</span><span class="w">0</span><span class="c">):</span>
        <span class="w">M</span><span class="c">SNEventBase.__init__(self)</span>
        <span class="c">self.currentID</span> <span class="c">=</span> <span class="c">currentID</span>
        <span class="c">self.</span><span class="w">_state</span> <span class="w">= [</span><span class="pc">'</span><span class="w">DISCONNECTED', {}]</span>

    <span class="c">def</span> <span class="w">_setState</span><span class="c">(self</span><span class="pc">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ate):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">_</span><span class="pc">st</span><span class="c">ate</span><span class="w">[</span><span class="pc">0] </span><span class="c">=</span> <span class="w">s</span><span class="pc">ta</span><span class="c">te</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_getState</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">return</span> <span class="c">self._state</span><span class="pc">[0</span><span class="c">]</span>

    <span class="c">def</span> <span class="w">_getStateData</span><span class="c">(self,</span> <span class="c">key):</span>
        <span class="c">return</span> <span class="c">self._state</span><span class="pc">[1][</span><span class="w">k</span><span class="c">ey]</span>

    <span class="c">def</span> <span class="w">_setStateData</span><span class="c">(self,</span> <span class="c">key,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">_s</span><span class="c">tate</span><span class="pc">[</span><span class="c">1</span><span class="pc">][</span><span class="w">k</span><span class="c">ey</span><span class="pc">] </span><span class="c">=</span> <span class="w">v</span><span class="c">alue</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_remStateData</span><span class="c">(self</span><span class="pc">, </span><span class="c">*args</span><span class="pc">)</span><span class="c">:</span>
        <span class="pc">f</span><span class="c">or</span> <span class="pc">k</span><span class="c">ey</span> <span class="c">in</span> <span class="w">a</span><span class="c">rgs:</span>
            <span class="w">d</span><span class="c">el</span> <span class="c">self.</span><span class="w">_</span><span class="pc">st</span><span class="c">ate[</span><span class="pc">1][</span><span class="w">k</span><span class="c">ey]</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">onnectionM</span><span class="c">ade(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="w">MSNEventBase</span><span class="pc">.</span><span class="w">co</span><span class="pc">nnectionM</span><span class="c">ade</span><span class="pc">(</span><span class="c">self</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">_setState(</span><span class="pc">'</span><span class="w">CONNECTED</span><span class="pc">')</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">VER</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s" % (self.</span><span class="w">_nextTransactionID(</span><span class="pc">),</span> <span class="w">MSN_PROTOCOL_VERSION)</span><span class="pc">)</span>

    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self._setState</span><span class="pc">('</span><span class="w">DISCONNECTED</span><span class="pc">')</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">_state[</span><span class="pc">1</span><span class="w">] = {}</span>
        <span class="w">MSNEventBase.c</span><span class="c">onnectionLost(self</span><span class="pc">,</span> <span class="c">reason)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">checkMessage</span><span class="c">(self,</span> <span class="w">m</span><span class="c">essage):</span>
        
        <span class="w">cTypes</span> <span class="w">=</span><span class="pc"> [</span><span class="w">s</span><span class="c">.</span><span class="w">lstrip</span><span class="pc">()</span> <span class="pc">f</span><span class="c">or</span> <span class="pc">s</span> <span class="c">in</span> <span class="w">m</span><span class="c">essage</span><span class="pc">.</span><span class="w">getHeader('C</span><span class="pc">ont</span><span class="c">ent-</span><span class="w">Type').</span><span class="c">split</span><span class="w">(';')]</span>
        <span class="w">i</span><span class="c">f</span> <span class="w">'te</span><span class="c">xt</span><span class="w">/x-msmsgsprofile'</span> <span class="w">i</span><span class="c">n</span> <span class="w">c</span><span class="c">Types:</span>
            <span class="pc">se</span><span class="c">lf.</span><span class="w">gotProfile</span><span class="c">(</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage)</span>
            <span class="w">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="pc">1</span>

    

    <span class="c">def</span> <span class="w">handle_VER</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">id</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_nextTransactionID</span><span class="pc">()</span>
        <span class="c">self.</span><span class="pc">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">CVR</span> <span class="c">%s</span> <span class="c">%s</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="c">d</span><span class="pc">,</span> <span class="w">MSN_CVR_STR</span><span class="pc">,</span> <span class="c">self.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">handle_CVR</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="pc">s</span><span class="c">elf.sendLine</span><span class="pc">("</span><span class="w">USR</span> <span class="c">%s</span> <span class="w">TWN</span> <span class="w">I</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (self.</span><span class="w">_nextTransactionID(</span><span class="pc">),</span> <span class="c">self.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="w">)</span><span class="pc">)</span>

    <span class="c">def</span> <span class="w">handle_USR</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="c">if</span> <span class="pc">l</span><span class="c">en(</span><span class="pc">p</span><span class="c">arams</span><span class="w">) !=</span> <span class="w">4</span> <span class="pc">a</span><span class="c">nd</span> <span class="pc">l</span><span class="c">en(</span><span class="w">p</span><span class="c">arams</span><span class="w">) </span><span class="pc">!</span><span class="c">=</span> <span class="w">6</span><span class="c">:</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="w">Number</span> <span class="w">o</span><span class="c">f</span> <span class="w">Parameters</span> <span class="w">f</span><span class="c">or</span> <span class="w">USR"</span>

        <span class="w">mechanism</span> <span class="pc">=</span> <span class="w">p</span><span class="c">arams</span><span class="pc">[1</span><span class="c">]</span>
        <span class="c">if</span> <span class="w">m</span><span class="c">echanism</span> <span class="w">=</span><span class="pc">= </span><span class="c">"</span><span class="w">O</span><span class="c">K</span><span class="pc">"</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">loggedIn</span><span class="c">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[2],</span> <span class="w">unquote</span><span class="pc">(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">3</span><span class="w">])</span><span class="pc">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="pc">p</span><span class="c">arams[</span><span class="pc">4]))</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams</span><span class="pc">[2</span><span class="w">]</span><span class="pc">.</span><span class="w">u</span><span class="pc">p</span><span class="c">per</span><span class="w">() == "S"</span><span class="c">:</span>
            
            <span class="w">f</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory</span>
            <span class="w">d</span> <span class="pc">=</span> <span class="w">execute</span><span class="c">(</span>
                <span class="w">_login</span><span class="c">,</span> <span class="w">f</span><span class="pc">.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">f</span><span class="pc">.</span><span class="w">pa</span><span class="pc">s</span><span class="c">sword,</span> <span class="w">f</span><span class="c">.</span><span class="w">passportServer</span><span class="c">,</span>
                <span class="w">authData</span><span class="pc">=</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams</span><span class="pc">[</span><span class="w">3</span><span class="c">])</span>
            <span class="w">d</span><span class="pc">.</span><span class="c">addCallback(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">_passportLogin</span><span class="pc">)</span>
            <span class="pc">d</span><span class="c">.</span><span class="pc">addE</span><span class="c">rrback(self.</span><span class="w">_passportError</span><span class="pc">)</span>

    <span class="pc">de</span><span class="c">f</span> <span class="pc">_passportL</span><span class="c">ogin(self,</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">r</span><span class="c">esult</span><span class="pc">[</span><span class="c">0</span><span class="w">] ==</span> <span class="w">LOGIN_REDIRECT</span><span class="c">:</span>
            <span class="pc">d</span> <span class="c">=</span> <span class="w">_login</span><span class="pc">(</span><span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory.</span><span class="w">pa</span><span class="c">ssword,</span>
                       <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span><span class="pc">[1],</span> <span class="w">cached</span><span class="pc">=</span><span class="w">1</span><span class="c">,</span> <span class="w">authData</span><span class="c">=</span><span class="w">r</span><span class="c">esult</span><span class="pc">[2])</span>
            <span class="w">d</span><span class="pc">.</span><span class="c">addCallback(self.</span><span class="w">_passportLogin</span><span class="pc">)</span>
            <span class="pc">d</span><span class="c">.</span><span class="pc">addE</span><span class="c">rrback(self.</span><span class="w">_passportError</span><span class="pc">)</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">r</span><span class="c">esult</span><span class="pc">[</span><span class="c">0</span><span class="w">] ==</span> <span class="w">LOGIN_SUCCESS:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">USR</span> <span class="c">%s</span> <span class="w">TWN</span> <span class="w">S</span> <span class="c">%s" % (self.</span><span class="w">_nextTransactionID(</span><span class="pc">),</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[1</span><span class="w">])</span><span class="pc">)</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">r</span><span class="c">esult</span><span class="w">[</span><span class="c">0</span><span class="w">] </span><span class="pc">==</span> <span class="w">LOGIN_FAILURE:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">loginFailure</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult[</span><span class="pc">1])</span>


    <span class="c">def</span> <span class="w">_passportError</span><span class="c">(self,</span> <span class="w">f</span><span class="pc">a</span><span class="c">ilure):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">f</span><span class="c">ailure.</span><span class="w">c</span><span class="c">heck</span><span class="pc">(</span><span class="w">SSLRequired</span><span class="c">):</span>
            <span class="w">f</span><span class="pc">a</span><span class="c">ilure</span> <span class="pc">=</span> <span class="pc">f</span><span class="c">ailure.</span><span class="w">getErrorMessage</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">l</span><span class="pc">ogi</span><span class="c">nFailure</span><span class="pc">("</span><span class="w">E</span><span class="pc">x</span><span class="c">ception</span> <span class="w">wh</span><span class="pc">il</span><span class="c">e</span> <span class="w">authenticating:</span><span class="pc"> </span><span class="c">%s</span><span class="pc">"</span><span class="c"> %</span> <span class="w">f</span><span class="c">ailure</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">handle_CHG</span><span class="c">(self,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">pa</span><span class="pc">r</span><span class="c">ams</span><span class="pc">),</span> <span class="w">3,</span><span class="pc"> '</span><span class="w">CHG</span><span class="pc">')</span>
        <span class="w">id</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0])</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">not</span> <span class="c">self.</span><span class="w">_fireCallback</span><span class="pc">(</span><span class="w">id</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[1</span><span class="w">]):</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">statusChanged</span><span class="c">(</span><span class="pc">p</span><span class="c">arams[</span><span class="pc">1</span><span class="c">])</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_ILN</span><span class="c">(self,</span> <span class="pc">p</span><span class="c">arams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="c">arams</span><span class="pc">),</span> <span class="w">5,</span><span class="pc"> </span><span class="c">'</span><span class="w">ILN</span><span class="pc">')</span>
        <span class="c">self.</span><span class="w">gotContactStatus</span><span class="c">(</span><span class="pc">p</span><span class="c">arams</span><span class="pc">[1],</span> <span class="pc">p</span><span class="c">arams</span><span class="pc">[2],</span> <span class="w">unquote</span><span class="pc">(p</span><span class="c">arams[</span><span class="pc">3]))</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_CHL</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="w">c</span><span class="c">heckParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">,</span> <span class="pc">2</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">CHL</span><span class="c">')</span>
        <span class="c">self.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">QRY</span> <span class="c">%s</span> <span class="w">msmsgs@msnmsgr</span><span class="pc">.c</span><span class="c">om</span> <span class="w">32"</span><span class="pc"> %</span> <span class="c">self.</span><span class="w">_nextTransactionID(</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">t</span><span class="c">ransport.</span><span class="pc">w</span><span class="c">rite(</span><span class="w">md</span><span class="c">5(</span><span class="w">pa</span><span class="pc">r</span><span class="c">ams</span><span class="pc">[1</span><span class="w">] +</span> <span class="w">MSN_CHALLENGE_STR).hexdigest</span><span class="pc">())</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_QRY</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_NLN</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="c">arams</span><span class="pc">),</span> <span class="w">4,</span><span class="pc"> '</span><span class="w">NLN</span><span class="pc">')</span>
        <span class="c">self.</span><span class="w">contactStatusChanged</span><span class="c">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0</span><span class="pc">],</span> <span class="pc">p</span><span class="c">arams</span><span class="pc">[1],</span> <span class="w">unquote</span><span class="pc">(p</span><span class="c">arams[</span><span class="pc">2]))</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_FLN</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="w">c</span><span class="pc">h</span><span class="c">eckParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">,</span> <span class="c">1</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">FLN</span><span class="c">')</span>
        <span class="c">self.</span><span class="w">contactOffline</span><span class="c">(</span><span class="pc">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0</span><span class="pc">])</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_LST</span><span class="c">(self,</span> <span class="pc">p</span><span class="c">arams):</span>
        
        
        <span class="c">if</span> <span class="c">self.</span><span class="w">_getState() != 'SYNC</span><span class="pc">'</span><span class="c">:</span>
            <span class="w">r</span><span class="c">eturn</span>
        <span class="w">contact</span> <span class="pc">=</span> <span class="w">MSNContact</span><span class="c">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="w">=p</span><span class="c">arams</span><span class="pc">[0</span><span class="w">]</span><span class="pc">,</span> <span class="w">screenName</span><span class="c">=</span><span class="w">unquote</span><span class="c">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">1</span><span class="w">])</span><span class="pc">,</span>
                             <span class="w">lists</span><span class="c">=</span><span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">2</span><span class="w">]</span><span class="pc">))</span>
        <span class="c">if</span> <span class="pc">c</span><span class="c">ontact</span><span class="w">.</span><span class="c">lists</span> <span class="w">&amp;</span> <span class="w">FORWARD_LIST</span><span class="pc">:</span>
            <span class="pc">c</span><span class="c">ontact.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span><span class="pc">.</span><span class="w">e</span><span class="pc">x</span><span class="c">tend(</span><span class="w">m</span><span class="pc">a</span><span class="c">p(</span><span class="w">i</span><span class="c">nt,</span> <span class="w">p</span><span class="c">arams</span><span class="pc">[3].</span><span class="c">split</span><span class="w">(',')))</span>
        <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">_getStateData('li</span><span class="pc">st</span><span class="w">').addContact</span><span class="pc">(</span><span class="c">contact)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">_setStateData(</span><span class="pc">'</span><span class="w">last_contact</span><span class="pc">',</span> <span class="pc">c</span><span class="c">ontact)</span>
        <span class="w">sofar</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">_</span><span class="c">getStateData</span><span class="pc">(</span><span class="c">'</span><span class="w">lst_sofar')</span><span class="pc"> </span><span class="c">+</span> <span class="w">1</span>
        <span class="w">i</span><span class="c">f</span> <span class="pc">so</span><span class="c">far</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_</span><span class="pc">g</span><span class="c">etStateData</span><span class="w">(</span><span class="pc">'</span><span class="w">lst_reply</span><span class="pc">')</span><span class="c">:</span>
            
            
            
            
            
            
            
            
            <span class="c">self.</span><span class="w">_setState</span><span class="pc">('</span><span class="w">SESSION</span><span class="pc">')</span>
            <span class="w">contacts</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_</span><span class="pc">g</span><span class="c">etStateData</span><span class="pc">(</span><span class="c">'</span><span class="w">li</span><span class="c">st')</span>
            <span class="w">phone</span> <span class="c">=</span> <span class="c">self._getStateData</span><span class="pc">(</span><span class="c">'</span><span class="w">p</span><span class="c">hone')</span>
            <span class="w">id</span> <span class="c">=</span> <span class="c">self._getStateData</span><span class="pc">('</span><span class="w">synid</span><span class="c">')</span>
            <span class="c">self.</span><span class="w">_remStateData</span><span class="pc">('</span><span class="w">l</span><span class="c">st_reply</span><span class="pc">', </span><span class="c">'</span><span class="w">lsg_reply</span><span class="pc">',</span><span class="c"> '</span><span class="w">lst_sofar</span><span class="c">', '</span><span class="pc">p</span><span class="c">hone</span><span class="pc">',</span><span class="c"> '</span><span class="w">s</span><span class="pc">y</span><span class="c">nid', '</span><span class="w">li</span><span class="c">st')</span>
            <span class="c">self.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">i</span><span class="pc">d,</span> <span class="w">contacts</span><span class="pc">,</span> <span class="pc">p</span><span class="c">hone)</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="c">self.</span><span class="w">_setStateData</span><span class="pc">('</span><span class="w">l</span><span class="pc">st</span><span class="c">_sofar',</span><span class="w">sofar</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_BLP</span><span class="c">(self,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">_getState() == 'SYNC</span><span class="c">':</span>
            <span class="c">self.</span><span class="w">_getStateData</span><span class="pc">('</span><span class="w">l</span><span class="pc">i</span><span class="c">st</span><span class="w">')</span><span class="pc">.</span><span class="w">privacy</span> <span class="w">=</span> <span class="w">listCodeToID[pa</span><span class="pc">r</span><span class="c">ams</span><span class="pc">[</span><span class="c">0</span><span class="pc">].l</span><span class="c">ower</span><span class="w">()]</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="w">i</span><span class="pc">d</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[</span><span class="c">0])</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">i</span><span class="pc">d,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">1</span><span class="w">])</span><span class="pc">,</span> <span class="w">l</span><span class="c">istCodeToID[</span><span class="w">p</span><span class="pc">a</span><span class="c">rams[</span><span class="pc">2].l</span><span class="c">ower</span><span class="w">()])</span>

    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">handle_GTC</span><span class="c">(self,</span> <span class="pc">p</span><span class="c">arams):</span>
        
        <span class="c">if</span> <span class="c">self.</span><span class="w">_getState() == 'SYNC</span><span class="pc">'</span><span class="c">:</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="c">arams[0</span><span class="pc">].l</span><span class="c">ower</span><span class="w">() == "a"</span><span class="c">:</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">_getStateData(</span><span class="pc">'</span><span class="w">li</span><span class="pc">st</span><span class="w">')</span><span class="pc">.</span><span class="w">autoAdd</span> <span class="w">=</span> <span class="pc">0</span>
            <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">p</span><span class="c">arams[0</span><span class="pc">].l</span><span class="c">ower</span><span class="w">() </span><span class="c">== "</span><span class="w">n"</span><span class="c">:</span>
                <span class="c">self.</span><span class="pc">_getStateD</span><span class="c">ata</span><span class="w">(</span><span class="pc">'</span><span class="w">li</span><span class="pc">s</span><span class="c">t</span><span class="w">')</span><span class="pc">.a</span><span class="c">utoAdd</span> <span class="pc">=</span> <span class="pc">1</span>
            <span class="w">e</span><span class="c">lse:</span>
                <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"Invalid</span> <span class="w">Parameter</span> <span class="w">f</span><span class="c">or</span> <span class="w">GTC"</span> 
        <span class="w">e</span><span class="pc">l</span><span class="c">se:</span>
            <span class="w">i</span><span class="pc">d</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0])</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">pa</span><span class="c">rams</span><span class="pc">[1].l</span><span class="c">ower</span><span class="w">() </span><span class="c">== "</span><span class="w">a"</span><span class="c">:</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">id</span><span class="c">,</span> <span class="w">0</span><span class="pc">)</span>
            <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams</span><span class="pc">[1</span><span class="w">]</span><span class="pc">.l</span><span class="c">ower</span><span class="w">() </span><span class="c">== "</span><span class="w">n"</span><span class="pc">:</span>
                <span class="c">self.</span><span class="w">_</span><span class="pc">f</span><span class="c">ireCallback</span><span class="pc">(</span><span class="w">id</span><span class="pc">,</span> <span class="w">1</span><span class="c">)</span>
            <span class="pc">e</span><span class="c">lse:</span>
                <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"Invalid</span> <span class="w">Parameter</span> <span class="w">f</span><span class="c">or</span> <span class="w">GTC"</span> 

    <span class="w">d</span><span class="c">ef</span> <span class="w">handle_SYN</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">id</span> <span class="c">=</span> <span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[0])</span>
        <span class="c">if</span> <span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams) ==</span> <span class="c">2:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_setState(</span><span class="pc">'</span><span class="w">SESSION</span><span class="pc">')</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">id</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">,</span> <span class="pc">N</span><span class="c">one)</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="w">contacts</span> <span class="c">=</span> <span class="w">MSNContactList</span><span class="pc">()</span>
            <span class="w">c</span><span class="pc">o</span><span class="c">ntacts.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[1])</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_setStateData(</span><span class="pc">'</span><span class="w">li</span><span class="c">st</span><span class="pc">'</span><span class="c">,</span> <span class="c">contacts)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_</span><span class="pc">s</span><span class="c">etStateData</span><span class="w">(</span><span class="pc">'</span><span class="w">lst_reply</span><span class="pc">',</span> <span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams</span><span class="pc">[2]))</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">_</span><span class="c">setStateData</span><span class="pc">('</span><span class="w">lsg_reply</span><span class="c">',</span> <span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">3]))</span>
            <span class="pc">s</span><span class="c">elf._setStateData</span><span class="pc">('</span><span class="w">lst_sofar</span><span class="c">',</span> <span class="pc">0</span><span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">_</span><span class="c">setStateData</span><span class="pc">('</span><span class="w">phone', [])</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">handle_LSG</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">_getState() == 'SYNC</span><span class="pc">'</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">_getStateData</span><span class="pc">('</span><span class="w">li</span><span class="c">st</span><span class="w">')</span><span class="pc">.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[</span><span class="c">0</span><span class="w">])] =</span> <span class="w">unquote(</span><span class="pc">pa</span><span class="c">rams[</span><span class="pc">1</span><span class="c">])</span>

        
        
        
        
        
        
        
        

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_PRP</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="c">if</span> <span class="c">self.</span><span class="pc">_getState</span><span class="w">()</span><span class="pc"> </span><span class="c">== '</span><span class="pc">S</span><span class="c">YNC</span><span class="w">'</span><span class="c">:</span>
            <span class="c">self._getStateData</span><span class="pc">('</span><span class="w">phone')</span><span class="pc">.</span><span class="w">a</span><span class="c">ppend</span><span class="pc">((</span><span class="w">p</span><span class="pc">a</span><span class="c">rams[0</span><span class="pc">],</span> <span class="c">unquote</span><span class="w">(</span><span class="pc">p</span><span class="c">arams[</span><span class="pc">1</span><span class="w">])))</span>
        <span class="w">e</span><span class="pc">l</span><span class="c">se:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams[0</span><span class="w">])</span><span class="pc">,</span> <span class="w">i</span><span class="pc">nt</span><span class="c">(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">1</span><span class="w">])</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nquote</span><span class="pc">(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams[</span><span class="pc">3]))</span>

    <span class="c">def</span> <span class="w">handle_BPR</span><span class="c">(self,</span> <span class="pc">p</span><span class="c">arams):</span>
        <span class="w">numParams</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="c">arams)</span>
        <span class="c">if</span> <span class="pc">nu</span><span class="c">mParams</span> <span class="c">==</span> <span class="w">2</span><span class="c">:</span> 
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_getStateData(</span><span class="pc">'</span><span class="w">last_contact')</span><span class="pc">.</span><span class="w">setPhone</span><span class="pc">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[0],</span> <span class="w">u</span><span class="c">nquote</span><span class="pc">(p</span><span class="c">arams</span><span class="pc">[</span><span class="c">1</span><span class="pc">]))</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="c">numParams</span> <span class="pc">=</span><span class="c">=</span> <span class="w">4</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">gotPhoneNumber</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="w">p</span><span class="c">arams[0</span><span class="w">])</span><span class="pc">,</span> <span class="pc">p</span><span class="c">arams[</span><span class="pc">1</span><span class="w">]</span><span class="pc">,</span> <span class="c">params[</span><span class="pc">2],</span> <span class="w">u</span><span class="pc">n</span><span class="c">quote</span><span class="w">(</span><span class="c">params[</span><span class="pc">3]))</span>

    <span class="c">def</span> <span class="w">handle_ADG</span><span class="c">(self,</span> <span class="pc">p</span><span class="c">arams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="pc">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">,</span> <span class="w">5,</span><span class="pc"> </span><span class="c">'</span><span class="w">ADG</span><span class="pc">')</span>
        <span class="w">id</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="pc">p</span><span class="c">arams[</span><span class="pc">0</span><span class="c">])</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="w">_fireCallback</span><span class="pc">(</span><span class="w">id</span><span class="pc">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="pc">p</span><span class="c">arams</span><span class="pc">[1</span><span class="w">])</span><span class="pc">,</span> <span class="w">unquote</span><span class="c">(</span><span class="pc">p</span><span class="c">arams[</span><span class="pc">2</span><span class="w">])</span><span class="pc">,</span> <span class="w">i</span><span class="c">nt(</span><span class="pc">p</span><span class="c">arams[</span><span class="pc">3</span><span class="w">])):</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"ADG</span> <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="w">d</span><span class="pc">o</span><span class="c">es</span> <span class="c">not</span> <span class="w">ma</span><span class="pc">t</span><span class="c">ch</span> <span class="w">up</span> <span class="w">t</span><span class="c">o</span> <span class="w">a</span> <span class="w">req</span><span class="pc">ue</span><span class="c">st"</span> 

    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">handle_RMG</span><span class="c">(self,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="w">3,</span><span class="pc"> '</span><span class="w">RMG</span><span class="pc">')</span>
        <span class="w">id</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0])</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">not</span> <span class="c">self.</span><span class="w">_fireCallback</span><span class="pc">(</span><span class="w">id</span><span class="pc">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="pc">p</span><span class="c">arams</span><span class="pc">[1</span><span class="w">])</span><span class="pc">,</span> <span class="w">i</span><span class="c">nt(</span><span class="pc">p</span><span class="c">arams[</span><span class="pc">2</span><span class="w">])):</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="w">R</span><span class="c">MG</span> <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="w">d</span><span class="pc">o</span><span class="c">es</span> <span class="c">not</span> <span class="w">m</span><span class="c">atch</span> <span class="w">up</span> <span class="w">t</span><span class="c">o</span> <span class="w">a</span> <span class="w">req</span><span class="pc">ue</span><span class="c">st"</span> 

    <span class="w">d</span><span class="c">ef</span> <span class="w">handle_REG</span><span class="c">(self,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams</span><span class="pc">)</span><span class="c">,</span> <span class="w">5,</span><span class="pc"> '</span><span class="w">REG</span><span class="c">')</span>
        <span class="w">id</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[0])</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">not</span> <span class="c">self.</span><span class="w">_fireCallback</span><span class="pc">(</span><span class="w">id</span><span class="pc">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="pc">p</span><span class="c">arams</span><span class="pc">[1</span><span class="w">])</span><span class="pc">,</span> <span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">2</span><span class="w">])</span><span class="pc">,</span> <span class="w">unquote</span><span class="pc">(p</span><span class="c">arams[</span><span class="pc">3</span><span class="w">])):</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"REG</span> <span class="w">r</span><span class="c">esponse</span> <span class="w">d</span><span class="pc">o</span><span class="c">es</span> <span class="c">not</span> <span class="w">ma</span><span class="pc">t</span><span class="c">ch</span> <span class="w">up</span> <span class="w">t</span><span class="c">o</span> <span class="w">a</span> <span class="w">req</span><span class="pc">ue</span><span class="c">st</span><span class="pc">"</span> 

    <span class="w">d</span><span class="c">ef</span> <span class="w">handle_ADD</span><span class="c">(self,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        <span class="w">numParams</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span>
        <span class="c">if</span> <span class="pc">nu</span><span class="c">mParams</span> <span class="w">&lt;</span> <span class="w">5</span> <span class="w">o</span><span class="c">r</span> <span class="w">p</span><span class="c">arams</span><span class="pc">[1</span><span class="c">].</span><span class="w">u</span><span class="c">pper()</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">in</span> <span class="w">('AL','BL',</span><span class="pc">'</span><span class="w">RL</span><span class="pc">',</span><span class="c">'</span><span class="w">FL'</span><span class="pc">):</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="w">Parameters</span> <span class="w">f</span><span class="c">or</span> <span class="w">ADD"</span> 
        <span class="w">i</span><span class="pc">d</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams</span><span class="pc">[</span><span class="c">0])</span>
        <span class="w">listType</span> <span class="c">=</span> <span class="w">p</span><span class="c">arams[</span><span class="pc">1].lo</span><span class="c">wer()</span>
        <span class="w">listVer</span> <span class="c">=</span> <span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams[</span><span class="pc">2</span><span class="c">])</span>
        <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span> <span class="c">=</span> <span class="w">p</span><span class="c">arams[</span><span class="pc">3</span><span class="c">]</span>
        <span class="w">groupID</span> <span class="c">=</span> <span class="w">N</span><span class="c">one</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">numParams</span> <span class="pc">=</span><span class="c">=</span> <span class="w">6</span><span class="c">:</span> 
            <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[1].</span><span class="w">u</span><span class="c">pper</span><span class="w">() != "FL"</span><span class="c">:</span>
                <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="w">Only</span> <span class="w">forward</span> <span class="w">li</span><span class="pc">st</span> <span class="w">c</span><span class="pc">a</span><span class="c">n</span> <span class="w">contain</span> <span class="w">gr</span><span class="pc">oups</span><span class="w">"</span> 
            <span class="pc">g</span><span class="c">roupID</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="w">5</span><span class="c">])</span>
        <span class="c">if</span> <span class="c">not</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_fireCallback</span><span class="pc">(</span><span class="w">id</span><span class="pc">,</span> <span class="w">listCodeToID</span><span class="pc">[</span><span class="w">listType],</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">listVer</span><span class="c">,</span> <span class="c">groupID</span><span class="pc">)</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">userAddedMe</span><span class="pc">(</span><span class="w">use</span><span class="pc">rH</span><span class="c">andle,</span> <span class="w">unquote(p</span><span class="pc">ar</span><span class="c">ams</span><span class="w">[4])</span><span class="pc">,</span> <span class="c">listVer)</span>

    <span class="c">def</span> <span class="w">handle_REM</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="w">numParams</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span>
        <span class="c">if</span> <span class="pc">nu</span><span class="c">mParams</span> <span class="w">&lt;</span> <span class="w">4</span> <span class="w">o</span><span class="c">r</span> <span class="w">p</span><span class="c">arams</span><span class="pc">[1].</span><span class="w">u</span><span class="pc">p</span><span class="c">per()</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">i</span><span class="pc">n</span> <span class="w">(</span><span class="pc">'</span><span class="w">AL','BL',</span><span class="pc">'</span><span class="w">FL'</span><span class="pc">,'</span><span class="w">RL'</span><span class="pc">):</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="w">Parameters</span> <span class="w">f</span><span class="c">or</span> <span class="w">REM"</span> 
        <span class="w">i</span><span class="pc">d</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams</span><span class="pc">[</span><span class="c">0])</span>
        <span class="w">listType</span> <span class="c">=</span> <span class="w">p</span><span class="c">arams[</span><span class="pc">1].lo</span><span class="c">wer()</span>
        <span class="w">listVer</span> <span class="c">=</span> <span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams[</span><span class="pc">2</span><span class="c">])</span>
        <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span> <span class="c">=</span> <span class="w">p</span><span class="c">arams[</span><span class="pc">3</span><span class="c">]</span>
        <span class="w">groupID</span> <span class="c">=</span> <span class="w">N</span><span class="c">one</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">numParams</span> <span class="pc">=</span><span class="c">=</span> <span class="w">5</span><span class="c">:</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[1</span><span class="w">] != "FL"</span><span class="c">:</span>
                <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="w">Only</span> <span class="w">forward</span> <span class="w">li</span><span class="pc">st</span> <span class="w">c</span><span class="pc">a</span><span class="c">n</span> <span class="w">contain</span> <span class="w">gr</span><span class="pc">oups</span><span class="w">"</span> 
            <span class="c">groupID</span> <span class="w">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">4</span><span class="c">])</span>
        <span class="c">if</span> <span class="c">not</span> <span class="c">self.</span><span class="w">_fireCallback(id</span><span class="pc">,</span> <span class="w">listCodeToID[listType],</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">listVer</span><span class="pc">,</span> <span class="c">groupID</span><span class="pc">)</span><span class="c">:</span>
            <span class="c">if</span> <span class="pc">l</span><span class="c">istType.</span><span class="w">u</span><span class="pc">pp</span><span class="c">er</span><span class="w">() == "RL"</span><span class="pc">:</span>
                <span class="w">s</span><span class="c">elf.</span><span class="w">userRemovedMe</span><span class="c">(</span><span class="w">use</span><span class="pc">rH</span><span class="c">andle,</span> <span class="w">l</span><span class="pc">istV</span><span class="c">er</span><span class="pc">)</span>

    <span class="c">def</span> <span class="w">handle_REA</span><span class="c">(self,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="w">4,</span><span class="pc"> '</span><span class="w">REA</span><span class="c">')</span>
        <span class="w">id</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0])</span>
        <span class="c">self.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">i</span><span class="pc">d,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[1</span><span class="w">])</span><span class="pc">,</span> <span class="w">unquote</span><span class="pc">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[3]))</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_XFR</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">,</span> <span class="w">5,</span><span class="pc"> </span><span class="c">'</span><span class="w">XFR</span><span class="pc">')</span>
        <span class="w">i</span><span class="pc">d</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[</span><span class="pc">0</span><span class="c">])</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="pc">p</span><span class="c">ort</span> <span class="c">=</span> <span class="pc">p</span><span class="c">arams[</span><span class="pc">2].</span><span class="c">split</span><span class="w">(':')</span>
        <span class="pc">e</span><span class="c">xcept</span> <span class="pc">V</span><span class="c">alueError:</span>
            <span class="w">h</span><span class="pc">o</span><span class="c">st</span> <span class="c">=</span> <span class="pc">p</span><span class="c">arams[</span><span class="pc">2</span><span class="c">]</span>
            <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="w">MSN_PORT</span>

        <span class="w">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">s</span><span class="c">elf.</span><span class="w">_fireCallback</span><span class="pc">(</span><span class="w">id</span><span class="c">,</span> <span class="pc">h</span><span class="c">ost,</span> <span class="w">i</span><span class="c">nt(port</span><span class="pc">),</span> <span class="pc">pa</span><span class="c">rams</span><span class="pc">[</span><span class="w">4]):</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="w">Got</span> <span class="w">XFR</span> <span class="c">(</span><span class="w">referral)</span> <span class="w">that</span> <span class="w">I</span> <span class="w">didn'</span><span class="pc">t</span> <span class="w">ask</span> <span class="w">f</span><span class="c">or</span> <span class="w">..</span> <span class="w">s</span><span class="pc">h</span><span class="c">ould</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">happen?"</span> 

    <span class="w">d</span><span class="c">ef</span> <span class="w">handle_RNG</span><span class="c">(self,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="w">6,</span><span class="pc"> '</span><span class="w">RNG</span><span class="pc">')</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="w">p</span><span class="c">arams[</span><span class="pc">1</span><span class="w">]</span><span class="pc">.</span><span class="c">split</span><span class="w">(":")</span>
            <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="c">int(port)</span>
        <span class="pc">e</span><span class="c">xcept</span> <span class="pc">V</span><span class="c">alueError:</span>
            <span class="w">h</span><span class="pc">o</span><span class="c">st</span> <span class="c">=</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[1</span><span class="c">]</span>
            <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="w">MSN_PORT</span>
        <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">gotSwitchboardInvitation</span><span class="pc">(</span><span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="pc">ar</span><span class="c">ams[0</span><span class="w">])</span><span class="pc">,</span> <span class="w">h</span><span class="c">ost,</span> <span class="c">port,</span> <span class="pc">pa</span><span class="c">rams</span><span class="pc">[</span><span class="w">3</span><span class="pc">],</span> <span class="c">params[</span><span class="pc">4],</span>
                                      <span class="w">unquote</span><span class="pc">(</span><span class="c">params[</span><span class="w">5</span><span class="pc">]))</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_OUT</span><span class="c">(self,</span> <span class="pc">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">:</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">,</span> <span class="c">1</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">OUT</span><span class="c">')</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="c">arams[0</span><span class="w">] == "OTH"</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">multipleLogin(</span><span class="pc">)</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[</span><span class="c">0</span><span class="w">] </span><span class="pc">==</span><span class="c"> "</span><span class="w">SSD"</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">serverGoingDown</span><span class="c">()</span>
        <span class="w">e</span><span class="pc">ls</span><span class="c">e:</span>
            <span class="pc">r</span><span class="c">aise</span> <span class="w">MSNProtocolError,</span><span class="pc"> </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="w">Parameters</span> <span class="w">r</span><span class="pc">ec</span><span class="c">eived</span> <span class="w">f</span><span class="c">or</span> <span class="w">O</span><span class="pc">U</span><span class="c">T</span><span class="w">"</span> 

    

    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">loggedIn</span><span class="c">(self</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">screenName</span><span class="c">,</span> <span class="w">verified</span><span class="c">):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">fa</span><span class="pc">c</span><span class="c">tory.</span><span class="pc">s</span><span class="c">creenName</span> <span class="w">=</span> <span class="pc">sc</span><span class="c">reenName</span>
        <span class="w">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">contacts</span><span class="pc">:</span>
            <span class="w">listVersion</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="pc">l</span><span class="c">istVersion</span> <span class="c">=</span> <span class="c">self.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">c</span><span class="pc">o</span><span class="c">ntacts</span><span class="pc">.</span><span class="w">v</span><span class="pc">ers</span><span class="c">ion</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">syncList</span><span class="pc">(l</span><span class="c">istVersion</span><span class="w">)</span><span class="pc">.a</span><span class="c">ddCallback(self.</span><span class="w">listSynchronized</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">loginFailure</span><span class="c">(self</span><span class="pc">,</span> <span class="w">m</span><span class="pc">e</span><span class="c">ssage):</span>
        


    <span class="pc">d</span><span class="c">ef</span> <span class="w">gotProfile</span><span class="c">(self</span><span class="pc">,</span> <span class="w">m</span><span class="c">essage):</span>
        
        <span class="w">p</span><span class="c">ass</span>

    <span class="c">def</span> <span class="w">l</span><span class="pc">i</span><span class="c">stSynchronized(self</span><span class="pc">, </span><span class="c">*args</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

    <span class="c">def</span> <span class="w">statusChanged</span><span class="c">(self</span><span class="pc">,</span> <span class="w">statusCode</span><span class="c">):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory</span><span class="pc">.</span><span class="w">sta</span><span class="pc">tus</span> <span class="pc">=</span> <span class="c">statusCode</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">gotContactStatus</span><span class="c">(self</span><span class="pc">,</span> <span class="w">s</span><span class="c">tatusCode</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">screenName</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">contacts</span><span class="pc">.</span><span class="w">getContact</span><span class="c">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="w">)</span><span class="pc">.</span><span class="w">stat</span><span class="pc">us</span> <span class="w">=</span> <span class="pc">st</span><span class="c">atusCode</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">contactStatusChanged</span><span class="c">(self</span><span class="pc">,</span> <span class="w">s</span><span class="pc">tatu</span><span class="c">sCode</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="w">s</span><span class="pc">c</span><span class="c">reenName):</span>
        
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.contacts</span><span class="pc">.g</span><span class="c">etContact(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">).</span><span class="w">sta</span><span class="pc">tus</span> <span class="w">=</span> <span class="pc">st</span><span class="c">atusCode</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">contactOffline</span><span class="c">(self</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="pc">contacts</span><span class="w">.g</span><span class="pc">etC</span><span class="c">ontact(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="w">)</span><span class="pc">.</span><span class="w">sta</span><span class="pc">tus</span> <span class="w">=</span> <span class="w">STATUS_OFFLINE</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">gotPhoneNumber</span><span class="c">(self</span><span class="pc">,</span> <span class="w">listVersion</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="w">phoneType</span><span class="pc">,</span> <span class="w">nu</span><span class="c">mber):</span>
        
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">c</span><span class="c">ontacts</span><span class="w">.v</span><span class="pc">e</span><span class="c">rsion</span> <span class="pc">=</span> <span class="pc">l</span><span class="c">istVersion</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory.</span><span class="w">c</span><span class="pc">ont</span><span class="c">acts</span><span class="pc">.g</span><span class="c">etContact</span><span class="pc">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">).</span><span class="w">setPhone</span><span class="pc">(p</span><span class="c">honeType,</span> <span class="w">nu</span><span class="c">mber</span><span class="pc">)</span>

    <span class="c">def</span> <span class="w">userAddedMe</span><span class="c">(self</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">screenName</span><span class="pc">,</span> <span class="pc">l</span><span class="c">istVersion):</span>
        
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.contacts</span><span class="w">.v</span><span class="pc">e</span><span class="c">rsion</span> <span class="pc">=</span> <span class="w">l</span><span class="pc">i</span><span class="c">stVersion</span>
        <span class="w">c</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">c</span><span class="pc">ont</span><span class="c">acts</span><span class="pc">.g</span><span class="c">etContact</span><span class="pc">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">not</span> <span class="w">c</span><span class="pc">:</span>
            <span class="w">c</span> <span class="pc">=</span> <span class="w">MSNContact</span><span class="c">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="w">=us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="pc">s</span><span class="c">creenName=</span><span class="w">s</span><span class="pc">c</span><span class="c">reenName</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory.</span><span class="w">c</span><span class="pc">o</span><span class="c">ntacts</span><span class="pc">.</span><span class="w">addContact</span><span class="c">(</span><span class="w">c</span><span class="pc">)</span>
        <span class="w">c</span><span class="c">.</span><span class="w">addToList</span><span class="pc">(</span><span class="w">REVERSE_LIST</span><span class="c">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">userRemovedMe</span><span class="c">(self</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="w">listVersion</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">c</span><span class="pc">o</span><span class="c">ntacts</span><span class="pc">.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="pc">=</span> <span class="w">l</span><span class="pc">i</span><span class="c">stVersion</span>
        <span class="w">c</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">c</span><span class="pc">o</span><span class="c">ntacts</span><span class="w">.getContact</span><span class="c">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span>
        <span class="w">c</span><span class="c">.</span><span class="w">removeFromList</span><span class="c">(</span><span class="pc">R</span><span class="c">EVERSE_LIST)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">c</span><span class="c">.</span><span class="w">lists</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory.</span><span class="pc">c</span><span class="c">ontacts</span><span class="pc">.</span><span class="w">remContact</span><span class="c">(</span><span class="w">c</span><span class="pc">.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">gotSwitchboardInvitation</span><span class="c">(self</span><span class="pc">,</span> <span class="w">sessionID</span><span class="pc">,</span> <span class="w">h</span><span class="c">ost,</span> <span class="c">port,</span>
                                 <span class="w">k</span><span class="pc">e</span><span class="c">y,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">screenName</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">multipleLogin</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">p</span><span class="c">ass</span>

    <span class="c">def</span> <span class="w">serverGoingDown</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">p</span><span class="c">ass</span>

    

    <span class="c">def</span> <span class="w">changeStatus</span><span class="c">(self</span><span class="pc">,</span> <span class="w">s</span><span class="pc">tatu</span><span class="c">s):</span>
        

        <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">s</span><span class="pc">e</span><span class="c">ndLine</span><span class="pc">("</span><span class="w">CHG</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s" % (</span><span class="w">i</span><span class="c">d,</span> <span class="w">s</span><span class="pc">ta</span><span class="c">tus))</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">_cb</span><span class="c">(</span><span class="pc">r)</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">st</span><span class="pc">atu</span><span class="c">s</span> <span class="c">=</span> <span class="w">r[</span><span class="c">0]</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="w">_</span><span class="c">cb)</span>

    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <span class="c">def</span> <span class="w">setPrivacyMode</span><span class="c">(self,</span> <span class="w">privLevel</span><span class="c">):</span>
        

        <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">p</span><span class="c">rivLevel</span><span class="pc">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">BLP</span> <span class="c">%s</span> <span class="w">AL"</span><span class="pc"> %</span> <span class="w">id</span><span class="c">)</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">B</span><span class="c">LP</span> <span class="c">%s</span> <span class="w">BL"</span><span class="pc"> %</span> <span class="w">id</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">syncList</span><span class="c">(self,</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span><span class="pc">)</span><span class="c">:</span>
        

        <span class="c">self.</span><span class="w">_setState(</span><span class="pc">'</span><span class="w">SYNC</span><span class="pc">')</span>
        <span class="w">i</span><span class="pc">d,</span> <span class="pc">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">(</span><span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="w">=s</span><span class="pc">t</span><span class="c">r(</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span><span class="w">)</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">_setStateData(</span><span class="pc">'</span><span class="w">synid</span><span class="c">',</span><span class="w">i</span><span class="pc">d)</span>
        <span class="c">self.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">SYN</span> <span class="c">%s</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="c">d,</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span><span class="pc">)</span><span class="c">)</span>
        <span class="c">def</span> <span class="w">_cb</span><span class="c">(</span><span class="pc">r</span><span class="c">):</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">changeStatus</span><span class="pc">(</span><span class="w">STATUS_ONLINE</span><span class="pc">)</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">r[</span><span class="c">0]</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">None:</span>
                <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory</span><span class="pc">.</span><span class="w">contacts</span> <span class="pc">=</span> <span class="w">r[</span><span class="c">0]</span>
            <span class="w">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="w">_</span><span class="c">cb)</span>


    
    
    
    
    

    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    <span class="c">def</span> <span class="w">setPhoneDetails</span><span class="c">(self</span><span class="pc">,</span> <span class="w">phoneType</span><span class="pc">,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e):</span>
        
        
        
        
        <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">PRP</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s</span> <span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="c">d</span><span class="pc">,</span> <span class="w">p</span><span class="c">honeType</span><span class="pc">,</span> <span class="w">quote(v</span><span class="c">alue</span><span class="pc">)))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span>

    <span class="c">def</span> <span class="w">addListGroup</span><span class="c">(self,</span> <span class="pc">n</span><span class="c">ame</span><span class="pc">)</span><span class="c">:</span>
        

        <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">_</span><span class="c">createIDMapping</span><span class="w">(</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.sendLine("</span><span class="w">ADG</span> <span class="c">%s</span> <span class="c">%s</span> <span class="w">0</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="w">q</span><span class="c">uote</span><span class="w">(</span><span class="pc">n</span><span class="c">ame</span><span class="pc">)))</span>
        <span class="c">def</span> <span class="w">_cb</span><span class="c">(</span><span class="w">r</span><span class="pc">)</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">fa</span><span class="pc">c</span><span class="c">tory.</span><span class="w">contacts</span><span class="pc">.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="pc">=</span> <span class="w">r[</span><span class="c">0]</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.contacts</span><span class="pc">.</span><span class="w">setGroup</span><span class="c">(</span><span class="pc">r[1</span><span class="w">]</span><span class="pc">,</span> <span class="pc">r[2</span><span class="c">])</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="w">_</span><span class="c">cb)</span>

    <span class="c">def</span> <span class="w">remListGroup</span><span class="c">(self</span><span class="pc">,</span> <span class="w">groupID</span><span class="c">):</span>
        

        <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="pc">en</span><span class="c">dLine</span><span class="pc">("</span><span class="w">RMG</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s" % (</span><span class="w">i</span><span class="c">d,</span> <span class="pc">g</span><span class="c">roupID))</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="c">_cb(</span><span class="pc">r)</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">contacts.v</span><span class="pc">e</span><span class="c">rsion</span> <span class="pc">=</span> <span class="w">r[</span><span class="c">0]</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="pc">c</span><span class="c">ontacts</span><span class="pc">.</span><span class="w">remGroup</span><span class="c">(</span><span class="pc">r</span><span class="w">[</span><span class="pc">1</span><span class="c">])</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="pc">_</span><span class="c">cb)</span>

    <span class="c">def</span> <span class="w">renameListGroup</span><span class="c">(self</span><span class="pc">,</span> <span class="w">groupID</span><span class="pc">,</span> <span class="w">newName</span><span class="pc">)</span><span class="c">:</span>
        

        <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">REG</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s</span> <span class="pc">%</span><span class="c">s</span> <span class="w">0</span><span class="pc">"</span><span class="c"> % (</span><span class="w">id</span><span class="pc">,</span> <span class="pc">g</span><span class="c">roupID,</span> <span class="w">quote(</span><span class="pc">n</span><span class="c">ewName</span><span class="pc">)))</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">_cb</span><span class="c">(</span><span class="w">r</span><span class="pc">)</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">fa</span><span class="pc">c</span><span class="c">tory.</span><span class="w">contacts.v</span><span class="pc">e</span><span class="c">rsion</span> <span class="w">=</span> <span class="w">r[</span><span class="c">0]</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="pc">c</span><span class="c">ontacts</span><span class="pc">.</span><span class="w">setGroup</span><span class="c">(</span><span class="pc">r</span><span class="w">[</span><span class="pc">1],</span> <span class="pc">r[2</span><span class="c">])</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="w">_</span><span class="c">cb)</span>

    <span class="c">def</span> <span class="w">addContact</span><span class="c">(self</span><span class="pc">,</span> <span class="w">listType</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">groupID</span><span class="pc">=0</span><span class="c">):</span>
        

        <span class="w">i</span><span class="pc">d</span><span class="w">,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="w">l</span><span class="c">istType</span> <span class="pc">=</span> <span class="w">listIDToCode</span><span class="pc">[</span><span class="w">l</span><span class="c">istType</span><span class="pc">].</span><span class="w">u</span><span class="c">pper()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">l</span><span class="pc">i</span><span class="c">stType</span> <span class="w">=</span><span class="pc">= "</span><span class="w">FL</span><span class="pc">"</span><span class="c">:</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">ADD</span> <span class="pc">%</span><span class="c">s</span> <span class="w">F</span><span class="c">L</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">groupID</span><span class="pc">)</span><span class="c">)</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="pc">s</span><span class="c">elf.sendLine</span><span class="pc">("</span><span class="w">A</span><span class="c">DD</span> <span class="c">%s</span> <span class="c">%s</span> <span class="c">%s</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="c">d,</span> <span class="w">listType</span><span class="c">,</span> <span class="w">u</span><span class="pc">serH</span><span class="c">andle,</span> <span class="w">u</span><span class="pc">serH</span><span class="c">andle</span><span class="pc">)</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">_cb</span><span class="c">(</span><span class="w">r</span><span class="pc">)</span><span class="c">:</span>
            <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">contacts</span><span class="pc">.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="c">=</span> <span class="w">r[</span><span class="pc">2</span><span class="c">]</span>
            <span class="w">c</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">c</span><span class="pc">o</span><span class="c">ntacts</span><span class="pc">.</span><span class="w">getContact</span><span class="c">(</span><span class="pc">r</span><span class="w">[</span><span class="pc">1</span><span class="c">])</span>
            <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">c</span><span class="pc">:</span>
                <span class="w">c</span> <span class="pc">=</span> <span class="w">MSNContact</span><span class="c">(</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="w">=r[</span><span class="c">1</span><span class="pc">])</span>
            <span class="c">if</span> <span class="w">r[3]:</span>
                <span class="w">c</span><span class="pc">.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span><span class="pc">.</span><span class="c">append(r</span><span class="pc">[</span><span class="w">3</span><span class="c">])</span>
            <span class="w">c</span><span class="c">.</span><span class="w">addToList</span><span class="c">(r</span><span class="pc">[0</span><span class="c">])</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="pc">re</span><span class="c">turn</span> <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">_cb</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">remContact</span><span class="c">(self</span><span class="pc">,</span> <span class="w">listType</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">groupID</span><span class="pc">=</span><span class="w">0</span><span class="c">):</span>
        

        <span class="w">i</span><span class="pc">d</span><span class="w">,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="w">l</span><span class="c">istType</span> <span class="pc">=</span> <span class="w">listIDToCode[l</span><span class="c">istType</span><span class="w">]</span><span class="pc">.</span><span class="w">u</span><span class="c">pper()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">l</span><span class="pc">i</span><span class="c">stType</span> <span class="w">=</span><span class="pc">= "</span><span class="w">FL</span><span class="pc">"</span><span class="c">:</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">REM</span> <span class="pc">%</span><span class="c">s</span> <span class="w">F</span><span class="c">L</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s" % (</span><span class="w">i</span><span class="c">d,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="w">groupID</span><span class="c">))</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="c">self.</span><span class="pc">s</span><span class="c">endLine("</span><span class="w">R</span><span class="c">EM</span> <span class="c">%s</span> <span class="c">%s</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="c">d</span><span class="pc">,</span> <span class="w">l</span><span class="pc">is</span><span class="c">tType</span><span class="pc">,</span> <span class="w">u</span><span class="pc">serH</span><span class="c">andle</span><span class="pc">)</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">_cb</span><span class="c">(</span><span class="pc">r)</span><span class="c">:</span>
            <span class="w">l</span> <span class="c">=</span> <span class="c">self.</span><span class="w">fa</span><span class="pc">c</span><span class="c">tory.</span><span class="w">contacts</span>
            <span class="w">l.v</span><span class="pc">e</span><span class="c">rsion</span> <span class="pc">=</span> <span class="w">r[</span><span class="pc">2</span><span class="c">]</span>
            <span class="w">c</span> <span class="c">=</span> <span class="w">l</span><span class="c">.</span><span class="w">getContact</span><span class="c">(r</span><span class="w">[</span><span class="pc">1</span><span class="c">])</span>
            <span class="w">g</span><span class="pc">roup</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">[</span><span class="w">3</span><span class="c">]</span>
            <span class="w">shouldRemove</span> <span class="c">=</span> <span class="w">1</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">gr</span><span class="pc">oup</span><span class="c">:</span> 
                <span class="w">c</span><span class="c">.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups</span><span class="pc">.</span><span class="w">r</span><span class="pc">em</span><span class="c">ove(</span><span class="w">g</span><span class="pc">r</span><span class="c">oup)</span>
                <span class="pc">i</span><span class="c">f</span> <span class="pc">c</span><span class="c">.</span><span class="w">g</span><span class="pc">r</span><span class="c">oups:</span>
                    <span class="w">s</span><span class="pc">h</span><span class="c">ouldRemove</span> <span class="pc">=</span> <span class="w">0</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">s</span><span class="c">houldRemove:</span>
                <span class="w">c</span><span class="pc">.</span><span class="w">removeFromList</span><span class="c">(</span><span class="w">r[</span><span class="pc">0</span><span class="c">])</span>
                <span class="c">if</span> <span class="pc">c</span><span class="c">.</span><span class="w">lists</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0</span><span class="c">:</span>
                    <span class="w">l</span><span class="pc">.</span><span class="w">remContact</span><span class="c">(</span><span class="pc">c.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">_cb</span><span class="c">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">changeScreenName</span><span class="c">(self</span><span class="pc">,</span> <span class="w">newName</span><span class="c">):</span>
        

        <span class="w">id,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">REA</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s</span> <span class="c">%s" % (</span><span class="w">i</span><span class="c">d</span><span class="pc">,</span> <span class="c">self.</span><span class="w">fa</span><span class="pc">c</span><span class="c">tory.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="w">quote</span><span class="pc">(</span><span class="c">newName</span><span class="w">)</span><span class="pc">))</span>
        <span class="c">def</span> <span class="w">_cb</span><span class="c">(</span><span class="pc">r</span><span class="c">):</span>
            <span class="pc">se</span><span class="c">lf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">contacts.v</span><span class="pc">e</span><span class="c">rsion</span> <span class="w">=</span> <span class="w">r[</span><span class="c">0]</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">screenName</span> <span class="pc">=</span> <span class="w">r[</span><span class="pc">1</span><span class="c">]</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">_</span><span class="c">cb)</span>

    <span class="c">def</span> <span class="w">requestSwitchboardServer</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        

        <span class="w">i</span><span class="pc">d,</span> <span class="pc">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="pc">en</span><span class="c">dLine</span><span class="pc">("</span><span class="w">XFR</span> <span class="pc">%</span><span class="c">s</span> <span class="w">SB"</span><span class="pc"> %</span> <span class="w">id</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>

    <span class="c">def</span> <span class="w">logOut</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        

        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">OUT</span><span class="c">")</span>

<span class="w">c</span><span class="c">lass</span> <span class="w">NotificationFactory</span><span class="c">(</span><span class="w">C</span><span class="c">lientFactory):</span>
    

    <span class="w">contacts</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span>
    <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span> <span class="w">= '</span><span class="pc">'</span>
    <span class="w">screenName</span> <span class="w">= '</span><span class="pc">'</span>
    <span class="w">pa</span><span class="pc">s</span><span class="c">sword</span> <span class="w">= '</span><span class="pc">'</span>
    <span class="w">passportServer</span> <span class="pc">= '</span><span class="w">https:</span><span class="pc">/</span><span class="c">/</span><span class="w">nexus</span><span class="c">.</span><span class="w">passport</span><span class="pc">.</span><span class="c">com</span><span class="w">/rdr</span><span class="c">/</span><span class="w">pprdr</span><span class="pc">.</span><span class="w">asp'</span>
    <span class="w">st</span><span class="pc">atu</span><span class="c">s</span> <span class="pc">=</span><span class="c"> '</span><span class="w">FLN</span><span class="c">'</span>
    <span class="w">pr</span><span class="c">otocol</span> <span class="pc">=</span> <span class="w">NotificationClient</span>







<span class="w">c</span><span class="pc">l</span><span class="c">ass</span> <span class="w">SwitchboardClient</span><span class="c">(</span><span class="w">MSNEventBase</span><span class="pc">)</span><span class="c">:</span>
    

    <span class="w">k</span><span class="pc">e</span><span class="c">y</span> <span class="c">=</span> <span class="w">0</span>
    <span class="w">u</span><span class="pc">serH</span><span class="c">andle</span> <span class="w">= ""</span>
    <span class="w">sessionID</span> <span class="w">=</span><span class="pc"> "</span><span class="c">"</span>
    <span class="w">reply</span> <span class="c">=</span> <span class="w">0</span>

    <span class="w">_iCookie</span> <span class="c">=</span> <span class="w">0</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="c">__init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="w">M</span><span class="c">SNEventBase.__init__(self)</span>
        <span class="c">self.</span><span class="w">pendingUsers</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">cookies</span> <span class="w">= {'iCookies' : {}, 'external' : {}}</span> 

    <span class="w">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">on</span><span class="c">nectionMade(self):</span>
        <span class="w">M</span><span class="c">SNEventBase</span><span class="pc">.</span><span class="w">c</span><span class="pc">on</span><span class="c">nectionMade(self)</span>
        <span class="w">p</span><span class="pc">ri</span><span class="c">nt</span> <span class="pc">'</span><span class="w">sending</span> <span class="w">initial</span> <span class="w">stuff'</span>
        <span class="c">self.</span><span class="w">_sendInit</span><span class="pc">()</span>

    <span class="c">def</span> <span class="w">c</span><span class="pc">onnectionL</span><span class="c">ost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">c</span><span class="pc">o</span><span class="c">okies</span><span class="w">[</span><span class="pc">'</span><span class="w">i</span><span class="pc">C</span><span class="c">ookies</span><span class="w">'] = {}</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">ookies</span><span class="w">[</span><span class="pc">'</span><span class="w">e</span><span class="pc">x</span><span class="c">ternal</span><span class="w">'] </span><span class="pc">= </span><span class="c">{}</span>
        <span class="w">M</span><span class="c">SNEventBase.</span><span class="w">c</span><span class="pc">on</span><span class="c">nectionLost(self</span><span class="pc">,</span> <span class="c">reason)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_</span><span class="pc">s</span><span class="c">endInit(self):</span>
        
        <span class="w">id</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_nextTransactionID</span><span class="pc">(</span><span class="c">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="w">reply</span><span class="c">:</span>
            <span class="c">self.</span><span class="pc">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">USR</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="pc">d,</span> <span class="c">self.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="c">self.</span><span class="w">k</span><span class="c">ey</span><span class="pc">))</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="c">self.sendLine</span><span class="pc">("</span><span class="w">ANS</span> <span class="c">%s</span> <span class="c">%s</span> <span class="c">%s</span> <span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="c">d,</span> <span class="c">self.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle,</span> <span class="c">self.</span><span class="w">k</span><span class="c">ey,</span> <span class="c">self.</span><span class="w">sessionID)</span><span class="pc">)</span>

    <span class="c">def</span> <span class="w">_newInvitationCookie</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="pc">se</span><span class="c">lf.</span><span class="w">_iCookie</span> <span class="w">+</span><span class="c">=</span> <span class="pc">1</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">_</span><span class="c">iCookie</span> <span class="w">&gt;</span> <span class="w">1000</span><span class="c">:</span>
            <span class="c">self._iCookie</span> <span class="pc">=</span> <span class="pc">1</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">self._iCookie</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_checkTyping</span><span class="c">(self,</span> <span class="w">m</span><span class="pc">e</span><span class="c">ssage</span><span class="pc">,</span> <span class="w">cTypes</span><span class="c">):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">'t</span><span class="c">ext</span><span class="w">/x</span><span class="pc">-</span><span class="w">msmsgscontrol'</span> <span class="w">i</span><span class="pc">n</span> <span class="pc">c</span><span class="c">Types</span> <span class="w">a</span><span class="c">nd</span> <span class="w">me</span><span class="pc">s</span><span class="c">sage.</span><span class="w">hasHeader(</span><span class="pc">'</span><span class="w">TypingUser</span><span class="c">'):</span>
            <span class="c">self.</span><span class="w">userTyping</span><span class="pc">(</span><span class="w">m</span><span class="c">essage</span><span class="pc">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span>

    <span class="c">def</span> <span class="w">_checkFileInvitation</span><span class="c">(self,</span> <span class="w">m</span><span class="c">essage,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o):</span>
        
        <span class="w">guid</span> <span class="c">=</span> <span class="w">in</span><span class="pc">f</span><span class="c">o.</span><span class="w">g</span><span class="pc">e</span><span class="c">t</span><span class="pc">('</span><span class="w">Application</span><span class="pc">-</span><span class="w">GUID', '').low</span><span class="c">er</span><span class="w">(</span><span class="pc">)</span>
        <span class="w">n</span><span class="c">ame</span> <span class="c">=</span> <span class="w">inf</span><span class="c">o.</span><span class="pc">ge</span><span class="c">t('</span><span class="w">A</span><span class="c">pplication</span><span class="w">-N</span><span class="pc">a</span><span class="c">me</span><span class="w">'</span><span class="pc">, </span><span class="c">'').</span><span class="w">l</span><span class="pc">o</span><span class="c">wer</span><span class="w">(</span><span class="c">)</span>

        
        
        
        
        

        <span class="pc">i</span><span class="c">f</span> <span class="w">n</span><span class="pc">a</span><span class="c">me</span> <span class="w">!= "f</span><span class="pc">i</span><span class="c">le</span> <span class="w">transfer"</span> <span class="pc">a</span><span class="c">nd</span> <span class="w">g</span><span class="c">uid</span> <span class="w">!</span><span class="c">=</span> <span class="w">classNameToGUID[</span><span class="pc">"</span><span class="w">f</span><span class="pc">i</span><span class="c">le</span> <span class="w">t</span><span class="pc">r</span><span class="c">ansfer</span><span class="w">"]:</span>
            <span class="w">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">coo</span><span class="c">kie</span> <span class="c">=</span> <span class="c">int(</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">[</span><span class="c">'</span><span class="w">Invitation</span><span class="pc">-</span><span class="w">Cookie']</span><span class="pc">)</span>
            <span class="w">fileName</span> <span class="c">=</span> <span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">['</span><span class="w">A</span><span class="c">pplication</span><span class="pc">-</span><span class="w">F</span><span class="c">ile</span><span class="w">'</span><span class="pc">]</span>
            <span class="w">fileSize</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">[</span><span class="c">'</span><span class="pc">A</span><span class="c">pplication</span><span class="w">-FileSize']</span><span class="pc">)</span>
        <span class="w">e</span><span class="pc">x</span><span class="c">cept</span> <span class="pc">K</span><span class="c">eyError:</span>
            <span class="w">l</span><span class="c">og.msg('</span><span class="w">Received</span> <span class="w">munged</span> <span class="w">f</span><span class="pc">ile</span> <span class="w">transfer</span> <span class="w">req</span><span class="pc">ue</span><span class="c">st</span> <span class="w">...</span> <span class="w">ignoring.</span><span class="pc">'</span><span class="c">)</span>
            <span class="w">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">gotSendRequest</span><span class="pc">(</span><span class="c">fileName,</span> <span class="c">fileSize</span><span class="pc">,</span> <span class="w">coo</span><span class="c">kie</span><span class="pc">,</span> <span class="w">me</span><span class="pc">s</span><span class="c">sage)</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="w">1</span>

    <span class="c">def</span> <span class="w">_checkFileResponse</span><span class="c">(self,</span> <span class="w">m</span><span class="c">essage</span><span class="pc">,</span> <span class="w">inf</span><span class="c">o):</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">c</span><span class="c">md</span> <span class="c">=</span> <span class="w">inf</span><span class="c">o</span><span class="w">[</span><span class="pc">'</span><span class="w">Invitation-C</span><span class="pc">o</span><span class="c">mmand</span><span class="w">'].up</span><span class="c">per</span><span class="w">(</span><span class="pc">)</span>
            <span class="w">coo</span><span class="c">kie</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">inf</span><span class="c">o</span><span class="w">[</span><span class="pc">'</span><span class="w">I</span><span class="c">nvitation</span><span class="w">-Cookie']</span><span class="pc">)</span>
        <span class="w">e</span><span class="pc">x</span><span class="c">cept</span> <span class="pc">K</span><span class="c">eyError:</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">accept</span> <span class="w">=</span><span class="pc"> (</span><span class="w">cm</span><span class="c">d</span> <span class="w">==</span><span class="pc"> </span><span class="c">'</span><span class="w">ACCEPT'</span><span class="pc">)</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">1</span> <span class="w">o</span><span class="c">r</span> <span class="c">0</span>
        <span class="w">requested</span> <span class="w">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">cookies[</span><span class="pc">'</span><span class="w">iCookies'].g</span><span class="pc">e</span><span class="c">t(</span><span class="w">coo</span><span class="pc">kie)</span>
        <span class="c">if</span> <span class="pc">n</span><span class="c">ot</span> <span class="pc">r</span><span class="c">equested:</span>
            <span class="pc">ret</span><span class="c">urn</span> <span class="w">1</span>
        <span class="w">r</span><span class="pc">eq</span><span class="c">uested</span><span class="w">[</span><span class="pc">0].</span><span class="w">c</span><span class="pc">a</span><span class="c">llback</span><span class="w">((a</span><span class="c">ccept,</span> <span class="w">coo</span><span class="pc">kie,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">))</span>
        <span class="w">d</span><span class="pc">el</span> <span class="c">self.cookies</span><span class="w">[</span><span class="pc">'i</span><span class="c">Cookies</span><span class="w">'][coo</span><span class="pc">kie]</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span>

    <span class="c">def</span> <span class="w">_checkFileInfo</span><span class="c">(self,</span> <span class="w">m</span><span class="pc">es</span><span class="c">sage</span><span class="pc">,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o):</span>
        
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">ip</span> <span class="c">=</span> <span class="w">inf</span><span class="c">o</span><span class="w">[</span><span class="pc">'</span><span class="w">IP</span><span class="pc">-</span><span class="w">Address'</span><span class="pc">]</span>
            <span class="w">iCookie</span> <span class="c">=</span> <span class="pc">in</span><span class="c">t(</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="w">[</span><span class="pc">'</span><span class="w">Invitation</span><span class="c">-</span><span class="w">Cookie']</span><span class="c">)</span>
            <span class="w">aCookie</span> <span class="c">=</span> <span class="pc">in</span><span class="c">t(</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="w">[</span><span class="pc">'</span><span class="w">AuthCookie</span><span class="pc">']</span><span class="c">)</span>
            <span class="w">c</span><span class="pc">m</span><span class="c">d</span> <span class="c">=</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">[</span><span class="c">'</span><span class="w">I</span><span class="c">nvitation</span><span class="pc">-</span><span class="w">C</span><span class="pc">om</span><span class="c">mand</span><span class="w">'].up</span><span class="c">per</span><span class="w">(</span><span class="pc">)</span>
            <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="w">i</span><span class="pc">n</span><span class="c">t(</span><span class="w">inf</span><span class="c">o</span><span class="pc">[</span><span class="c">'</span><span class="w">Port</span><span class="pc">'])</span>
        <span class="w">e</span><span class="pc">x</span><span class="c">cept</span> <span class="pc">K</span><span class="c">eyError:</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">accept</span> <span class="w">=</span><span class="pc"> (</span><span class="w">cm</span><span class="c">d</span> <span class="w">==</span><span class="pc"> </span><span class="c">'</span><span class="w">ACCEPT</span><span class="pc">')</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">1</span> <span class="w">o</span><span class="c">r</span> <span class="pc">0</span>
        <span class="w">requested</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">cookies[</span><span class="pc">'</span><span class="w">external'].g</span><span class="pc">e</span><span class="c">t(</span><span class="w">iCookie</span><span class="pc">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">not</span> <span class="w">r</span><span class="c">equested:</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span> 
        <span class="w">r</span><span class="pc">eq</span><span class="c">uested</span><span class="w">[</span><span class="pc">0].</span><span class="w">c</span><span class="pc">a</span><span class="c">llback</span><span class="w">((a</span><span class="c">ccept,</span> <span class="w">ip</span><span class="c">,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt,</span> <span class="w">aCookie</span><span class="c">,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">))</span>
        <span class="w">d</span><span class="pc">el</span> <span class="pc">s</span><span class="c">elf.cookies</span><span class="w">[</span><span class="pc">'e</span><span class="c">xternal</span><span class="w">'][i</span><span class="pc">C</span><span class="c">ookie</span><span class="pc">]</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span>

    <span class="c">def</span> <span class="w">checkMessage</span><span class="c">(self,</span> <span class="w">m</span><span class="c">essage</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">cTypes</span> <span class="w">=</span><span class="pc"> [</span><span class="w">s</span><span class="pc">.</span><span class="w">lstrip</span><span class="pc">()</span> <span class="pc">f</span><span class="c">or</span> <span class="pc">s</span> <span class="c">in</span> <span class="w">m</span><span class="c">essage</span><span class="pc">.</span><span class="w">getHeader(</span><span class="pc">'</span><span class="w">C</span><span class="pc">ont</span><span class="c">ent-</span><span class="w">Type')</span><span class="pc">.</span><span class="c">split</span><span class="w">(';')]</span>
        <span class="w">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_checkTyping</span><span class="pc">(m</span><span class="c">essage</span><span class="pc">,</span> <span class="pc">cT</span><span class="c">ypes</span><span class="pc">)</span><span class="c">:</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">i</span><span class="c">f</span> <span class="w">'te</span><span class="c">xt</span><span class="w">/</span><span class="pc">x-</span><span class="w">msmsgsinvite'</span> <span class="w">i</span><span class="c">n</span> <span class="w">c</span><span class="pc">T</span><span class="c">ypes:</span>
            
            <span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="w">= {</span><span class="pc">}</span>
            <span class="c">for</span> <span class="w">l</span><span class="c">ine</span> <span class="c">in</span> <span class="w">m</span><span class="pc">e</span><span class="c">ssage</span><span class="pc">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span><span class="pc">.</span><span class="c">split</span><span class="pc">('</span><span class="c">\</span><span class="pc">r</span><span class="c">\n</span><span class="w">'</span><span class="pc">):</span>
                <span class="w">t</span><span class="c">ry:</span>
                    <span class="w">k</span><span class="pc">e</span><span class="c">y</span><span class="pc">,</span> <span class="pc">va</span><span class="c">l</span> <span class="c">=</span> <span class="w">l</span><span class="c">ine.split</span><span class="w">(':')</span>
                    <span class="w">inf</span><span class="c">o</span><span class="w">[k</span><span class="pc">e</span><span class="c">y] =</span> <span class="w">v</span><span class="pc">al</span><span class="w">.lstrip</span><span class="pc">()</span>
                <span class="pc">e</span><span class="c">xcept</span> <span class="pc">V</span><span class="c">alueError:</span>
                    <span class="w">c</span><span class="c">ontinue</span>
            <span class="c">if</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_checkFileInvitation(m</span><span class="c">essage</span><span class="pc">,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">)</span> <span class="w">o</span><span class="c">r</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_checkFileInfo(</span><span class="pc">m</span><span class="c">essage,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">)</span> <span class="w">o</span><span class="c">r</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_checkFileResponse(</span><span class="pc">m</span><span class="c">essage,</span> <span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">)</span><span class="c">:</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="w">'te</span><span class="c">xt</span><span class="w">/</span><span class="pc">x-</span><span class="w">clientcaps</span><span class="pc">'</span> <span class="w">i</span><span class="pc">n</span> <span class="w">cTypes</span><span class="c">:</span>
            
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">0</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="c">1</span>

    
    <span class="c">def</span> <span class="w">handle_USR</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="w">checkParamLen</span><span class="pc">(l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams),</span> <span class="w">4,</span><span class="pc"> '</span><span class="w">USR</span><span class="c">')</span>
        <span class="c">if</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams[</span><span class="pc">1</span><span class="w">] == "O</span><span class="c">K</span><span class="w">"</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">loggedIn</span><span class="pc">()</span>

    
    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_CAL</span><span class="c">(self,</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams):</span>
        <span class="w">c</span><span class="c">heckParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="pc">p</span><span class="c">arams),</span> <span class="w">3,</span><span class="pc"> </span><span class="c">'</span><span class="w">CAL</span><span class="pc">')</span>
        <span class="w">id</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="pc">p</span><span class="c">arams[0])</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="c">arams[</span><span class="pc">1].</span><span class="w">u</span><span class="c">pper</span><span class="w">() == "RINGING"</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="w">i</span><span class="c">nt(</span><span class="pc">p</span><span class="c">arams</span><span class="pc">[2]))</span> 

    
    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_JOI</span><span class="c">(self,</span> <span class="pc">par</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="pc">2</span><span class="w">,</span><span class="pc"> '</span><span class="w">JOI</span><span class="pc">')</span>
        <span class="c">self.</span><span class="w">userJoined</span><span class="c">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0</span><span class="pc">],</span> <span class="w">unquote</span><span class="pc">(p</span><span class="c">arams[</span><span class="pc">1]))</span>

    
    <span class="c">def</span> <span class="w">handle_IRO</span><span class="c">(self,</span> <span class="pc">p</span><span class="c">arams):</span>
        <span class="w">c</span><span class="c">heckParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="c">arams</span><span class="pc">)</span><span class="c">,</span> <span class="w">5,</span><span class="pc"> </span><span class="c">'</span><span class="w">IRO</span><span class="c">')</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">pendingUsers</span><span class="pc">[</span><span class="w">p</span><span class="c">arams[</span><span class="w">3]] =</span> <span class="w">u</span><span class="c">nquote</span><span class="w">(p</span><span class="c">arams[</span><span class="pc">4</span><span class="c">])</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[1</span><span class="w">] ==</span> <span class="w">p</span><span class="c">arams</span><span class="pc">[2</span><span class="w">]:</span>
            <span class="c">self.</span><span class="w">gotChattingUsers</span><span class="pc">(s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">endingUsers</span><span class="w">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">p</span><span class="c">endingUsers</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span>

    
    <span class="c">def</span> <span class="w">handle_ANS</span><span class="c">(self,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="pc">2</span><span class="w">,</span><span class="pc"> '</span><span class="w">ANS</span><span class="pc">')</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[1</span><span class="w">] == "O</span><span class="c">K</span><span class="w">"</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">loggedIn</span><span class="pc">()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_ACK</span><span class="c">(self,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">c</span><span class="pc">he</span><span class="c">ckParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="c">arams),</span> <span class="c">1</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">ACK</span><span class="c">')</span>
        <span class="c">self.</span><span class="w">_fireCallback</span><span class="c">(</span><span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0</span><span class="w">])</span><span class="pc">,</span> <span class="w">N</span><span class="c">one)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_NAK</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="pc">c</span><span class="c">heckParamLen</span><span class="pc">(</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="c">1</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">NAK</span><span class="pc">')</span>
        <span class="c">self.</span><span class="w">_</span><span class="c">fireCallback(</span><span class="w">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[0</span><span class="w">])</span><span class="pc">,</span> <span class="w">N</span><span class="pc">o</span><span class="c">ne)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_BYE</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        
        <span class="c">self.</span><span class="w">userLeft</span><span class="c">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0])</span>

    

    <span class="c">def</span> <span class="w">loggedIn</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">p</span><span class="c">ass</span>

    <span class="c">def</span> <span class="w">gotChattingUsers</span><span class="c">(self</span><span class="pc">,</span> <span class="w">us</span><span class="pc">ers</span><span class="c">):</span>
        
        <span class="pc">p</span><span class="c">ass</span>

    <span class="c">def</span> <span class="w">userJoined</span><span class="c">(self</span><span class="pc">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">,</span> <span class="w">screenName</span><span class="c">):</span>
        
        <span class="pc">p</span><span class="c">ass</span>

    <span class="c">def</span> <span class="w">u</span><span class="c">serLeft(self</span><span class="pc">,</span> <span class="w">userH</span><span class="c">andle):</span>
        
        <span class="c">pass</span>

    <span class="c">def</span> <span class="w">gotMessage</span><span class="c">(self</span><span class="pc">,</span> <span class="w">m</span><span class="c">essage):</span>
        
        <span class="c">pass</span>

    <span class="c">def</span> <span class="w">userTyping</span><span class="c">(self</span><span class="pc">,</span> <span class="pc">m</span><span class="c">essage):</span>
        
        <span class="c">pass</span>

    <span class="c">def</span> <span class="w">gotSendRequest</span><span class="c">(self</span><span class="pc">,</span> <span class="w">fileName</span><span class="pc">,</span> <span class="w">fileSize</span><span class="pc">,</span> <span class="w">iCookie</span><span class="pc">,</span> <span class="pc">m</span><span class="c">essage):</span>
        
        <span class="c">pass</span>

    

    <span class="c">def</span> <span class="w">inviteUser</span><span class="c">(self,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span><span class="c">:</span>
        

        <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">s</span><span class="c">endLine("</span><span class="w">CAL</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c"> % (</span><span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="w">us</span><span class="pc">erH</span><span class="c">andle))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span>

    <span class="c">def</span> <span class="w">sendMessage</span><span class="c">(self,</span> <span class="w">m</span><span class="c">essage</span><span class="pc">)</span><span class="c">:</span>
        

        <span class="c">if</span> <span class="w">m</span><span class="c">essage.</span><span class="w">ack</span> <span class="w">n</span><span class="c">ot</span> <span class="w">i</span><span class="c">n</span> <span class="w">('A','N</span><span class="c">'):</span>
            <span class="w">id,</span> <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_nextTransactionID()</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="w">i</span><span class="pc">d,</span> <span class="w">d</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_createIDMapping</span><span class="pc">()</span>
        <span class="w">i</span><span class="c">f</span> <span class="w">m</span><span class="pc">es</span><span class="c">sage.</span><span class="w">le</span><span class="c">ngth</span> <span class="c">==</span> <span class="c">0:</span>
            <span class="w">m</span><span class="c">essage</span><span class="pc">.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth</span> <span class="c">=</span> <span class="w">m</span><span class="c">essage.</span><span class="w">_calcMessageLen</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">MSG</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s" % (</span><span class="w">i</span><span class="pc">d,</span> <span class="pc">m</span><span class="c">essage</span><span class="pc">.</span><span class="w">ack</span><span class="c">,</span> <span class="c">message</span><span class="pc">.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth</span><span class="pc">))</span>
        
        <span class="pc">s</span><span class="c">elf.sendLine</span><span class="pc">('</span><span class="w">MIME</span><span class="pc">-</span><span class="w">V</span><span class="c">ersion</span><span class="w">:</span><span class="pc"> </span><span class="c">%</span><span class="pc">s' %</span> <span class="w">m</span><span class="c">essage.</span><span class="w">getHeader(</span><span class="pc">'</span><span class="w">M</span><span class="pc">I</span><span class="c">ME</span><span class="pc">-</span><span class="w">V</span><span class="c">ersion</span><span class="w">'</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">s</span><span class="c">endLine('</span><span class="w">C</span><span class="pc">o</span><span class="c">ntent-</span><span class="w">Type:</span><span class="pc"> </span><span class="c">%s</span><span class="pc">' %</span> <span class="w">m</span><span class="pc">e</span><span class="c">ssage</span><span class="pc">.getH</span><span class="c">eader</span><span class="pc">(</span><span class="c">'</span><span class="w">C</span><span class="c">ontent-</span><span class="w">T</span><span class="c">ype</span><span class="w">'</span><span class="pc">))</span>
        
        <span class="w">f</span><span class="c">or</span> <span class="w">h</span><span class="c">eader</span> <span class="pc">i</span><span class="c">n</span> <span class="w">[h</span> <span class="w">f</span><span class="c">or</span> <span class="w">h</span> <span class="pc">i</span><span class="c">n</span> <span class="w">m</span><span class="c">essage</span><span class="pc">.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders.</span><span class="pc">i</span><span class="c">tems</span><span class="w">(</span><span class="pc">)</span> <span class="w">i</span><span class="c">f</span> <span class="w">h[</span><span class="pc">0].l</span><span class="c">ower</span><span class="pc">()</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">i</span><span class="pc">n</span> <span class="w">(</span><span class="pc">'</span><span class="w">mime</span><span class="pc">-</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span><span class="w">','co</span><span class="pc">nte</span><span class="c">nt</span><span class="pc">-t</span><span class="c">ype</span><span class="w">')]:</span>
            <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">s</span><span class="c">endLine</span><span class="w">("</span><span class="pc">%</span><span class="c">s</span><span class="w">:</span><span class="pc"> </span><span class="c">%s" % (</span><span class="w">h</span><span class="c">eader</span><span class="w">[</span><span class="c">0</span><span class="pc">],</span> <span class="w">h</span><span class="pc">eader[1]))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">t</span><span class="c">ransport.write(</span><span class="w">CR+LF</span><span class="c">)</span>
        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.write(</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span><span class="pc">.</span><span class="w">m</span><span class="c">essage)</span>
        <span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="pc">d</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">sendTypingNotification</span><span class="c">(self):</span>
        
        <span class="w">m</span> <span class="c">=</span> <span class="w">MSNMessage</span><span class="c">()</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">ack</span> <span class="pc">=</span> <span class="w">m</span><span class="c">.</span><span class="w">MESSAGE_ACK_NONE</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">setHeader</span><span class="pc">('</span><span class="w">C</span><span class="pc">ont</span><span class="c">ent-</span><span class="w">Type',</span><span class="pc"> </span><span class="c">'</span><span class="w">t</span><span class="pc">e</span><span class="c">xt</span><span class="pc">/</span><span class="w">x</span><span class="pc">-</span><span class="w">msmsgscontrol</span><span class="pc">')</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">s</span><span class="pc">et</span><span class="c">Header('</span><span class="w">TypingUser',</span> <span class="w">s</span><span class="c">elf.</span><span class="w">us</span><span class="pc">erH</span><span class="c">andle</span><span class="pc">)</span>
        <span class="pc">m.</span><span class="w">me</span><span class="pc">ssage</span> <span class="w">= "\r</span><span class="pc">\n</span><span class="w">"</span>
        <span class="pc">se</span><span class="c">lf.</span><span class="w">sendMessage</span><span class="pc">(</span><span class="w">m</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">sendFileInvitation</span><span class="c">(self</span><span class="pc">,</span> <span class="w">fileName</span><span class="pc">,</span> <span class="w">fileSize</span><span class="c">):</span>
        
        <span class="w">coo</span><span class="c">kie</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_newInvitationCookie</span><span class="pc">()</span>
        <span class="pc">d</span> <span class="c">=</span> <span class="pc">D</span><span class="c">eferred</span><span class="pc">(</span><span class="c">)</span>
        <span class="w">m</span> <span class="pc">=</span> <span class="w">MSNMessage</span><span class="pc">()</span>
        <span class="pc">m</span><span class="c">.</span><span class="w">setHeader</span><span class="pc">('</span><span class="w">C</span><span class="pc">ont</span><span class="c">ent</span><span class="pc">-</span><span class="w">Type'</span><span class="pc">, </span><span class="c">'</span><span class="w">t</span><span class="pc">e</span><span class="c">xt/</span><span class="w">x</span><span class="pc">-</span><span class="w">msmsgsinvite;</span> <span class="w">charset</span><span class="c">=</span><span class="w">UTF-8</span><span class="pc">'</span><span class="c">)</span>
        <span class="w">m</span><span class="c">.</span><span class="w">me</span><span class="c">ssage</span> <span class="w">+= 'Application-N</span><span class="pc">a</span><span class="c">me</span><span class="pc">:</span> <span class="w">F</span><span class="c">ile</span> <span class="w">Transfer\</span><span class="c">r\n</span><span class="pc">'</span>
        <span class="w">m</span><span class="c">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">= </span><span class="c">'</span><span class="w">A</span><span class="pc">p</span><span class="c">plication-</span><span class="w">GUID:</span><span class="pc"> %</span><span class="c">s\</span><span class="pc">r</span><span class="c">\n</span><span class="pc">' </span><span class="c">% (</span><span class="w">classNameToGUID[</span><span class="pc">"</span><span class="w">f</span><span class="pc">i</span><span class="c">le</span> <span class="w">transfer"],)</span>
        <span class="w">m.m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="w">Invitation</span><span class="pc">-</span><span class="w">C</span><span class="pc">om</span><span class="c">mand</span><span class="pc">:</span> <span class="w">INVITE</span><span class="pc">\</span><span class="c">r\n</span><span class="pc">'</span>
        <span class="pc">m.m</span><span class="c">essage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="pc">I</span><span class="c">nvitation</span><span class="pc">-</span><span class="w">Cookie:</span><span class="pc"> </span><span class="c">%s\r\n</span><span class="w">'</span><span class="pc"> %</span> <span class="w">s</span><span class="pc">t</span><span class="c">r(</span><span class="w">coo</span><span class="c">kie</span><span class="pc">)</span>
        <span class="w">m</span><span class="c">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">= </span><span class="c">'</span><span class="w">Application-F</span><span class="c">ile</span><span class="w">:</span><span class="pc"> </span><span class="c">%</span><span class="pc">s</span><span class="c">\</span><span class="pc">r</span><span class="c">\n</span><span class="w">'</span><span class="pc"> %</span> <span class="w">fileName</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">m</span><span class="c">essage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="w">A</span><span class="pc">p</span><span class="c">plication</span><span class="w">-FileSize:</span><span class="pc"> </span><span class="c">%s\r\n\r\n</span><span class="w">' </span><span class="pc">%</span> <span class="w">s</span><span class="pc">t</span><span class="c">r(</span><span class="w">fileSize</span><span class="c">)</span>
        <span class="w">m</span><span class="c">.</span><span class="w">ack</span> <span class="pc">=</span> <span class="w">m</span><span class="c">.</span><span class="w">MESSAGE_ACK_NONE</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">sendMessage</span><span class="c">(</span><span class="w">m</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">cookies[</span><span class="pc">'</span><span class="w">iCookies'][coo</span><span class="pc">kie</span><span class="w">] = (d,</span> <span class="w">m</span><span class="pc">)</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="c">d</span>

    <span class="c">def</span> <span class="w">fileInvitationReply</span><span class="c">(self</span><span class="pc">,</span> <span class="w">iCookie</span><span class="c">,</span> <span class="w">accept</span><span class="c">=</span><span class="pc">1</span><span class="c">):</span>
        
        <span class="pc">d</span> <span class="c">=</span> <span class="w">D</span><span class="c">eferred()</span>
        <span class="w">m</span> <span class="c">=</span> <span class="w">MSNMessage</span><span class="pc">()</span>
        <span class="w">m</span><span class="c">.</span><span class="w">setHeader</span><span class="pc">('</span><span class="w">C</span><span class="pc">ont</span><span class="c">ent-</span><span class="w">Type</span><span class="pc">', </span><span class="c">'</span><span class="w">t</span><span class="pc">e</span><span class="c">xt</span><span class="pc">/</span><span class="w">x</span><span class="pc">-</span><span class="w">msmsgsinvite;</span> <span class="w">charset</span><span class="c">=</span><span class="w">UTF</span><span class="pc">-</span><span class="w">8</span><span class="pc">'</span><span class="c">)</span>
        <span class="w">m</span><span class="c">.</span><span class="w">me</span><span class="c">ssage</span> <span class="w">+= 'Invitation</span><span class="pc">-</span><span class="w">C</span><span class="pc">om</span><span class="c">mand</span><span class="w">:</span><span class="pc"> </span><span class="c">%s\</span><span class="pc">r</span><span class="c">\n</span><span class="w">'</span><span class="pc"> </span><span class="c">% (</span><span class="w">accept</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">'ACCEPT'</span> <span class="w">o</span><span class="c">r</span> <span class="pc">'</span><span class="w">CANCEL')</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">= </span><span class="c">'</span><span class="pc">I</span><span class="c">nvitation</span><span class="w">-Cookie:</span><span class="pc"> </span><span class="c">%s\r\n</span><span class="w">'</span><span class="pc"> %</span> <span class="w">s</span><span class="pc">t</span><span class="c">r(</span><span class="w">iCookie</span><span class="pc">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="pc">a</span><span class="c">ccept:</span>
            <span class="w">m</span><span class="c">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">= </span><span class="c">'</span><span class="w">Cancel-Code</span><span class="c">:</span> <span class="w">REJECT\</span><span class="c">r\n'</span>
        <span class="pc">m</span><span class="c">.</span><span class="w">m</span><span class="c">essage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="w">Launch</span><span class="pc">-</span><span class="w">Application</span><span class="c">:</span> <span class="w">FALSE</span><span class="pc">\</span><span class="c">r\n</span><span class="pc">'</span>
        <span class="pc">m</span><span class="c">.</span><span class="w">m</span><span class="c">essage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="w">R</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">-</span><span class="w">Data</span><span class="c">:</span> <span class="w">IP-Address:\</span><span class="pc">r</span><span class="c">\n</span><span class="pc">'</span>
        <span class="w">m</span><span class="c">.</span><span class="w">m</span><span class="c">essage</span> <span class="w">+= '\</span><span class="pc">r</span><span class="c">\</span><span class="pc">n</span><span class="c">'</span>
        <span class="pc">m</span><span class="c">.</span><span class="w">ack</span> <span class="w">=</span> <span class="w">m</span><span class="c">.</span><span class="w">MESSAGE_ACK_NONE</span>
        <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">sendMessage</span><span class="pc">(</span><span class="w">m</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">cookies[</span><span class="pc">'</span><span class="w">external'][iCookie] = (d</span><span class="pc">,</span> <span class="w">m</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>

    <span class="c">def</span> <span class="w">sendTransferInfo</span><span class="c">(self</span><span class="pc">,</span> <span class="w">accept</span><span class="pc">,</span> <span class="w">i</span><span class="c">Cookie</span><span class="pc">,</span> <span class="w">authCookie</span><span class="pc">,</span> <span class="w">ip</span><span class="pc">,</span> <span class="w">po</span><span class="c">rt</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">m</span> <span class="c">=</span> <span class="w">MSNMessage</span><span class="pc">()</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">setHeader</span><span class="pc">('</span><span class="w">C</span><span class="pc">ont</span><span class="c">ent-</span><span class="w">Type</span><span class="pc">', </span><span class="c">'</span><span class="w">t</span><span class="pc">e</span><span class="c">xt</span><span class="pc">/</span><span class="w">x</span><span class="pc">-</span><span class="w">msmsgsinvite;</span> <span class="w">charset</span><span class="c">=</span><span class="w">UTF</span><span class="pc">-</span><span class="w">8</span><span class="pc">'</span><span class="c">)</span>
        <span class="w">m</span><span class="c">.</span><span class="w">me</span><span class="c">ssage</span> <span class="w">+= 'Invitation</span><span class="pc">-</span><span class="w">C</span><span class="pc">om</span><span class="c">mand</span><span class="w">:</span><span class="pc"> </span><span class="c">%s\</span><span class="pc">r</span><span class="c">\n</span><span class="w">'</span><span class="pc"> </span><span class="c">% (</span><span class="w">accept</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">'ACCEPT'</span> <span class="w">o</span><span class="c">r</span> <span class="pc">'</span><span class="w">CANCEL')</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">= </span><span class="c">'</span><span class="pc">I</span><span class="c">nvitation</span><span class="w">-Cookie:</span><span class="pc"> </span><span class="c">%s\r\n</span><span class="w">'</span><span class="pc"> %</span> <span class="w">iCookie</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">m</span><span class="c">essage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="w">IP-Address:</span><span class="pc"> </span><span class="c">%s\r\n</span><span class="w">'</span><span class="pc"> %</span> <span class="w">ip</span>
        <span class="w">m</span><span class="pc">.</span><span class="w">m</span><span class="c">essage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="w">Port:</span><span class="c"> %s\r\n</span><span class="w">' </span><span class="pc">%</span> <span class="w">po</span><span class="pc">r</span><span class="c">t</span>
        <span class="w">m</span><span class="c">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+</span><span class="pc">=</span><span class="c"> '</span><span class="w">AuthCookie:</span><span class="pc"> </span><span class="c">%</span><span class="pc">s</span><span class="c">\r\n</span><span class="w">' </span><span class="pc">%</span> <span class="w">authCookie</span>
        <span class="w">m</span><span class="c">.</span><span class="w">m</span><span class="pc">e</span><span class="c">ssage</span> <span class="w">+= '\</span><span class="c">r\</span><span class="pc">n'</span>
        <span class="w">m</span><span class="c">.</span><span class="w">ack</span> <span class="pc">=</span> <span class="w">m</span><span class="c">.</span><span class="w">MESSAGE_NACK</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">sendMessage</span><span class="c">(</span><span class="w">m</span><span class="pc">)</span>

<span class="w">c</span><span class="c">lass</span> <span class="w">FileReceive</span><span class="c">(</span><span class="w">L</span><span class="c">ineReceiver</span><span class="pc">)</span><span class="c">:</span>
    

    <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">,</span> <span class="w">au</span><span class="pc">th,</span> <span class="w">myUserHandle</span><span class="pc">,</span> <span class="w">fi</span><span class="pc">le,</span> <span class="w">di</span><span class="pc">r</span><span class="c">ectory</span><span class="w">="",</span> <span class="w">overwrite</span><span class="c">=</span><span class="pc">0</span><span class="c">):</span>
        
        <span class="c">self.</span><span class="w">au</span><span class="c">th</span> <span class="c">=</span> <span class="w">au</span><span class="c">th</span>
        <span class="c">self.</span><span class="pc">m</span><span class="c">yUserHandle</span> <span class="c">=</span> <span class="c">myUserHandle</span>
        <span class="c">self.</span><span class="w">fileSize</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">conn</span><span class="pc">ecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">completed</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">di</span><span class="pc">re</span><span class="c">ctory</span> <span class="c">=</span> <span class="w">di</span><span class="c">rectory</span>
        <span class="c">self.</span><span class="w">bytesReceived</span> <span class="c">=</span> <span class="w">0</span>
        <span class="c">self.</span><span class="w">overwrite</span> <span class="c">=</span> <span class="w">o</span><span class="c">verwrite</span>

        
        <span class="c">self.</span><span class="pc">s</span><span class="c">tate</span> <span class="pc">= '</span><span class="w">CONNECTING</span><span class="c">'</span>
        <span class="c">self.</span><span class="w">segmentLength</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">b</span><span class="pc">uff</span><span class="c">er</span> <span class="w">= '</span><span class="pc">'</span>

        <span class="pc">i</span><span class="c">f</span> <span class="w">i</span><span class="c">sinstance(</span><span class="w">f</span><span class="pc">i</span><span class="c">le,</span> <span class="w">t</span><span class="c">ypes.</span><span class="w">StringType</span><span class="c">):</span>
            <span class="w">pa</span><span class="pc">t</span><span class="c">h</span> <span class="pc">=</span> <span class="pc">o</span><span class="c">s.path.join(</span><span class="w">d</span><span class="pc">i</span><span class="c">rectory</span><span class="pc">,</span> <span class="w">f</span><span class="pc">ile</span><span class="c">)</span>
            <span class="c">if</span> <span class="w">o</span><span class="pc">s</span><span class="c">.path.exists(</span><span class="pc">p</span><span class="c">ath</span><span class="pc">)</span> <span class="pc">a</span><span class="c">nd</span> <span class="c">not</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">overwrite</span><span class="pc">:</span>
                <span class="w">l</span><span class="c">og.</span><span class="pc">m</span><span class="c">sg</span><span class="pc">('</span><span class="w">F</span><span class="c">ile</span> <span class="w">already</span> <span class="w">ex</span><span class="pc">i</span><span class="c">sts</span><span class="w">...')</span>
                <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">I</span><span class="pc">O</span><span class="c">Error</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="w">F</span><span class="pc">i</span><span class="c">le</span> <span class="w">Exists"</span> 
            <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="pc">fi</span><span class="c">le</span> <span class="pc">=</span> <span class="w">o</span><span class="pc">p</span><span class="c">en(os.path.join(</span><span class="w">d</span><span class="c">irectory</span><span class="w">,</span> <span class="w">f</span><span class="pc">ile</span><span class="w">), 'wb'</span><span class="pc">)</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">i</span><span class="c">le</span> <span class="pc">=</span> <span class="w">f</span><span class="c">ile</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">o</span><span class="c">nnectionMade(self):</span>
        <span class="c">self.</span><span class="w">con</span><span class="pc">ne</span><span class="c">cted</span> <span class="c">=</span> <span class="w">1</span>
        <span class="c">self.</span><span class="w">s</span><span class="c">tate</span> <span class="w">=</span><span class="pc"> '</span><span class="w">INHEADER</span><span class="c">'</span>
        <span class="c">self.</span><span class="w">s</span><span class="c">endLine('</span><span class="w">VER</span> <span class="w">MSNFTP</span><span class="c">')</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">onnectionL</span><span class="c">ost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">co</span><span class="pc">nnecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">i</span><span class="c">le</span><span class="pc">.</span><span class="w">c</span><span class="pc">l</span><span class="c">ose()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">parseHeader</span><span class="c">(self</span><span class="pc">,</span> <span class="w">he</span><span class="pc">ader</span><span class="c">):</span>
        

        <span class="pc">i</span><span class="c">f</span> <span class="w">ord</span><span class="pc">(</span><span class="w">he</span><span class="pc">ader</span><span class="w">[</span><span class="c">0</span><span class="w">]) !=</span> <span class="c">0</span><span class="pc">:</span> 
            <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.loseConnection()</span>
            <span class="pc">r</span><span class="c">eturn</span>
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">extra,</span> <span class="w">factor</span> <span class="c">=</span> <span class="w">he</span><span class="pc">a</span><span class="c">der</span><span class="w">[</span><span class="pc">1:</span><span class="c">]</span>
        <span class="c">except</span> <span class="pc">V</span><span class="c">alueError:</span>
            
            <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span>
        <span class="w">e</span><span class="pc">x</span><span class="c">tra</span>  <span class="w">=</span> <span class="w">o</span><span class="c">rd</span><span class="pc">(</span><span class="c">extra</span><span class="pc">)</span>
        <span class="pc">f</span><span class="c">actor</span> <span class="c">=</span> <span class="w">o</span><span class="c">rd</span><span class="pc">(f</span><span class="c">actor)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">actor</span> <span class="w">*</span> <span class="w">256</span> <span class="w">+</span> <span class="pc">e</span><span class="c">xtra</span>

    <span class="w">d</span><span class="c">ef</span> <span class="w">l</span><span class="pc">i</span><span class="c">neReceived(self,</span> <span class="pc">l</span><span class="c">ine):</span>
        <span class="w">temp</span> <span class="c">=</span> <span class="w">l</span><span class="c">ine.split</span><span class="pc">()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">l</span><span class="c">en(</span><span class="pc">t</span><span class="c">emp) ==</span> <span class="c">1:</span>
            <span class="w">p</span><span class="pc">ar</span><span class="c">ams</span> <span class="pc">= </span><span class="c">[]</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="w">p</span><span class="pc">ar</span><span class="c">ams</span> <span class="c">=</span> <span class="c">temp</span><span class="pc">[1:</span><span class="c">]</span>
        <span class="w">c</span><span class="c">md</span> <span class="c">=</span> <span class="w">t</span><span class="c">emp</span><span class="pc">[0</span><span class="c">]</span>
        <span class="w">ha</span><span class="pc">ndler</span> <span class="c">=</span> <span class="w">g</span><span class="c">etattr(self</span><span class="pc">, </span><span class="c">"</span><span class="w">handle_</span><span class="c">%s</span><span class="pc">" %</span> <span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="pc">.</span><span class="w">u</span><span class="pc">p</span><span class="c">per</span><span class="pc">(),</span> <span class="pc">N</span><span class="c">one)</span>
        <span class="c">if</span> <span class="w">ha</span><span class="pc">ndler</span><span class="c">:</span>
            <span class="w">han</span><span class="pc">dler(</span><span class="w">p</span><span class="c">arams</span><span class="w">)</span> 
        <span class="c">else:</span>
            <span class="c">self.</span><span class="w">handle_UNKNOWN</span><span class="pc">(</span><span class="w">c</span><span class="pc">m</span><span class="c">d,</span> <span class="w">p</span><span class="c">arams)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">rawDataReceived</span><span class="c">(self,</span> <span class="w">d</span><span class="c">ata):</span>
        <span class="w">bufferLen</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e</span><span class="c">n(self.</span><span class="w">b</span><span class="pc">uffer</span><span class="c">)</span>
        <span class="c">if</span> <span class="c">self.</span><span class="w">s</span><span class="c">tate</span> <span class="w">=</span><span class="pc">= </span><span class="c">'</span><span class="w">INHEADER</span><span class="c">':</span>
            <span class="w">delim</span> <span class="c">=</span> <span class="w">3-b</span><span class="c">ufferLen</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">b</span><span class="pc">uffer</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">d</span><span class="c">ata</span><span class="w">[</span><span class="pc">:</span><span class="w">d</span><span class="pc">e</span><span class="c">lim]</span>
            <span class="pc">i</span><span class="c">f</span> <span class="pc">le</span><span class="c">n(self.</span><span class="w">b</span><span class="pc">uffer</span><span class="w">)</span><span class="pc"> =</span><span class="c">=</span> <span class="w">3</span><span class="c">:</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">segmentLength</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">parseHeader</span><span class="pc">(</span><span class="c">self.</span><span class="w">b</span><span class="c">uffer</span><span class="pc">)</span>
                <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="pc">s</span><span class="c">egmentLength:</span>
                    <span class="pc">r</span><span class="c">eturn</span> 
                <span class="c">self.</span><span class="w">b</span><span class="pc">uffer</span> <span class="w">= ""</span>
                <span class="c">self.</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="w">=</span><span class="pc"> '</span><span class="w">INSEGMENT</span><span class="c">'</span>
            <span class="w">extra</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="w">[delim</span><span class="pc">:</span><span class="c">]</span>
            <span class="pc">i</span><span class="c">f</span> <span class="pc">le</span><span class="c">n(</span><span class="pc">e</span><span class="c">xtra</span><span class="pc">) &gt;</span> <span class="pc">0</span><span class="c">:</span>
                <span class="c">self.</span><span class="w">rawDataReceived</span><span class="pc">(e</span><span class="c">xtra</span><span class="pc">)</span>
            <span class="pc">r</span><span class="c">eturn</span>

        <span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="c">self.</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="w">=</span><span class="pc">= </span><span class="c">'</span><span class="pc">I</span><span class="c">NSEGMENT':</span>
            <span class="w">dataSeg</span> <span class="c">=</span> <span class="w">d</span><span class="pc">ata</span><span class="w">[:(s</span><span class="c">elf.</span><span class="w">segmentLength-bufferLen)]</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">b</span><span class="pc">uffer</span> <span class="w">+</span><span class="c">=</span> <span class="w">d</span><span class="pc">ataS</span><span class="c">eg</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">bytesReceived</span> <span class="w">+</span><span class="c">=</span> <span class="w">l</span><span class="c">en(</span><span class="pc">dataS</span><span class="c">eg)</span>
            <span class="c">if</span> <span class="pc">l</span><span class="c">en(self.</span><span class="w">b</span><span class="pc">uffer</span><span class="w">)</span><span class="pc"> =</span><span class="c">=</span> <span class="c">self.</span><span class="pc">s</span><span class="c">egmentLength:</span>
                <span class="c">self.</span><span class="w">gotSegment</span><span class="pc">(</span><span class="c">self.</span><span class="w">b</span><span class="pc">uffer)</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">b</span><span class="pc">uffer</span> <span class="w">= ""</span>
                <span class="w">i</span><span class="c">f</span> <span class="c">self.bytesReceived</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">fileSize</span><span class="c">:</span>
                    <span class="c">self.</span><span class="w">completed</span> <span class="pc">=</span> <span class="pc">1</span>
                    <span class="c">self.</span><span class="w">b</span><span class="pc">uff</span><span class="c">er</span> <span class="w">= "</span><span class="pc">"</span>
                    <span class="c">self.</span><span class="w">f</span><span class="pc">ile</span><span class="c">.</span><span class="pc">cl</span><span class="c">ose()</span>
                    <span class="c">self.</span><span class="w">s</span><span class="pc">en</span><span class="c">dLine</span><span class="pc">("</span><span class="w">BYE</span> <span class="w">16777989</span><span class="pc">"</span><span class="c">)</span>
                    <span class="w">r</span><span class="c">eturn</span>
                <span class="c">self.</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="w">=</span><span class="pc"> '</span><span class="w">INHEADER</span><span class="c">'</span>
                <span class="w">extra</span> <span class="c">=</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="w">[(</span><span class="c">self.</span><span class="w">segmentLength-bufferLen):]</span>
                <span class="pc">i</span><span class="c">f</span> <span class="pc">l</span><span class="c">en(</span><span class="w">e</span><span class="c">xtra</span><span class="pc">) &gt;</span> <span class="c">0:</span>
                    <span class="c">self.</span><span class="w">rawDataReceived</span><span class="pc">(</span><span class="c">extra</span><span class="pc">)</span>
                <span class="w">r</span><span class="c">eturn</span>

    <span class="w">d</span><span class="pc">ef</span> <span class="w">handle_VER</span><span class="c">(self,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="c">1</span><span class="w">,</span><span class="pc"> '</span><span class="w">VER</span><span class="c">')</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams[0</span><span class="pc">].</span><span class="w">u</span><span class="c">pper</span><span class="w">() == "MSNFTP"</span><span class="c">:</span>
            <span class="c">self.</span><span class="pc">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">USR</span> <span class="pc">%</span><span class="c">s</span> <span class="c">%s</span><span class="pc">"</span><span class="c"> % (</span><span class="pc">s</span><span class="c">elf.</span><span class="w">myUserHandle</span><span class="c">,</span> <span class="c">self.</span><span class="w">au</span><span class="c">th</span><span class="w">)</span><span class="pc">)</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="w">l</span><span class="c">og.msg</span><span class="pc">('</span><span class="w">they</span> <span class="w">sen</span><span class="pc">t</span> <span class="w">t</span><span class="pc">he</span> <span class="w">wrong</span> <span class="w">v</span><span class="c">ersion</span><span class="pc">,</span> <span class="w">t</span><span class="pc">i</span><span class="c">me</span> <span class="w">t</span><span class="c">o</span> <span class="w">quit</span> <span class="w">th</span><span class="pc">i</span><span class="c">s</span> <span class="w">transfer')</span>
            <span class="c">self.</span><span class="w">t</span><span class="pc">ransp</span><span class="c">ort.</span><span class="pc">l</span><span class="c">oseConnection()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_FIL</span><span class="c">(self</span><span class="pc">,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="c">arams),</span> <span class="c">1</span><span class="w">,</span><span class="pc"> '</span><span class="w">FIL</span><span class="c">')</span>
        <span class="w">t</span><span class="c">ry:</span>
            <span class="c">self.</span><span class="w">fileSize</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">nt(</span><span class="w">p</span><span class="c">arams[0])</span>
        <span class="c">except</span> <span class="pc">V</span><span class="c">alueError:</span> 
            <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
            <span class="pc">r</span><span class="c">eturn</span>
        <span class="c">self.</span><span class="w">setRawMode</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">TFR</span><span class="pc">"</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">handle_UNKNOWN</span><span class="c">(self</span><span class="pc">,</span> <span class="w">cm</span><span class="c">d</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams):</span>
        <span class="w">l</span><span class="c">og.msg</span><span class="pc">('</span><span class="w">rec</span><span class="c">eived</span> <span class="w">unknown</span> <span class="w">c</span><span class="pc">o</span><span class="c">mmand</span> <span class="w">(</span><span class="pc">%</span><span class="c">s</span><span class="w">)</span><span class="pc">,</span> <span class="w">p</span><span class="c">arams</span><span class="w">:</span><span class="pc"> </span><span class="c">%s' % (</span><span class="w">c</span><span class="c">md,</span> <span class="w">p</span><span class="c">arams))</span>

    <span class="c">def</span> <span class="w">gotSegment</span><span class="c">(self,</span> <span class="w">d</span><span class="c">ata):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">i</span><span class="c">le</span><span class="pc">.w</span><span class="c">rite(data)</span>

<span class="w">c</span><span class="c">lass</span> <span class="w">FileSend</span><span class="c">(</span><span class="w">L</span><span class="c">ineReceiver</span><span class="pc">)</span><span class="c">:</span>
    

    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">fi</span><span class="pc">le</span><span class="c">):</span>
        

        <span class="pc">i</span><span class="c">f</span> <span class="w">i</span><span class="c">sinstance(</span><span class="w">f</span><span class="pc">ile</span><span class="c">,</span> <span class="w">t</span><span class="c">ypes.</span><span class="w">StringType</span><span class="c">):</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">ile</span> <span class="pc">=</span> <span class="w">o</span><span class="pc">p</span><span class="c">en(</span><span class="w">fi</span><span class="pc">le, '</span><span class="w">rb</span><span class="c">')</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="c">self.</span><span class="w">f</span><span class="pc">i</span><span class="c">le</span> <span class="c">=</span> <span class="w">f</span><span class="pc">i</span><span class="c">le</span>

        <span class="w">s</span><span class="c">elf.</span><span class="w">fileSize</span> <span class="pc">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">bytesSent</span> <span class="c">=</span> <span class="w">0</span>
        <span class="c">self.</span><span class="w">completed</span> <span class="c">=</span> <span class="w">0</span>
        <span class="c">self.</span><span class="w">conn</span><span class="pc">ecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">targetUser</span> <span class="c">=</span> <span class="c">None</span>
        <span class="c">self.</span><span class="w">segmentSize</span> <span class="c">=</span> <span class="w">2045</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">au</span><span class="pc">th</span> <span class="c">=</span> <span class="w">randint</span><span class="pc">(</span><span class="w">0</span><span class="pc">,</span> <span class="c">2</span><span class="w">*</span><span class="pc">*</span><span class="w">3</span><span class="pc">0)</span>
        <span class="c">self.</span><span class="w">_pendingSend</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span> 

    <span class="c">def</span> <span class="pc">con</span><span class="c">nectionMade(self):</span>
        <span class="c">self.</span><span class="w">conn</span><span class="pc">ecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">1</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">co</span><span class="pc">nnectionL</span><span class="c">ost(self,</span> <span class="c">reason):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self._pendingSend</span><span class="pc">.</span><span class="w">active</span><span class="pc">()</span><span class="c">:</span>
            <span class="c">self._pendingSend</span><span class="pc">.</span><span class="w">c</span><span class="c">ancel()</span>
            <span class="pc">s</span><span class="c">elf._pendingSend</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">bytesSent</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">fileSize</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">completed</span> <span class="pc">=</span> <span class="w">1</span>
        <span class="c">self.</span><span class="w">conn</span><span class="pc">ecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">0</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">ile</span><span class="pc">.</span><span class="w">c</span><span class="pc">l</span><span class="c">ose()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">l</span><span class="c">ineReceived(self,</span> <span class="pc">l</span><span class="c">ine):</span>
        <span class="w">temp</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ine.split</span><span class="pc">()</span>
        <span class="c">if</span> <span class="pc">l</span><span class="c">en(</span><span class="pc">t</span><span class="c">emp) ==</span> <span class="pc">1</span><span class="c">:</span>
            <span class="w">p</span><span class="c">arams</span> <span class="w">=</span><span class="pc"> </span><span class="c">[]</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="w">p</span><span class="pc">ar</span><span class="c">ams</span> <span class="c">=</span> <span class="pc">t</span><span class="c">emp</span><span class="pc">[1:</span><span class="c">]</span>
        <span class="w">c</span><span class="c">md</span> <span class="c">=</span> <span class="w">t</span><span class="c">emp</span><span class="pc">[0</span><span class="c">]</span>
        <span class="w">ha</span><span class="pc">ndler</span> <span class="c">=</span> <span class="w">g</span><span class="c">etattr(self</span><span class="pc">, </span><span class="c">"</span><span class="w">handle_</span><span class="c">%s</span><span class="pc">" %</span> <span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="pc">.</span><span class="w">u</span><span class="pc">p</span><span class="c">per</span><span class="pc">(),</span> <span class="pc">N</span><span class="c">one)</span>
        <span class="c">if</span> <span class="w">ha</span><span class="pc">ndler</span><span class="c">:</span>
            <span class="w">han</span><span class="pc">dler(</span><span class="w">p</span><span class="c">arams</span><span class="w">)</span>
        <span class="c">else:</span>
            <span class="c">self.</span><span class="w">handle_UNKNOWN</span><span class="pc">(</span><span class="w">c</span><span class="pc">m</span><span class="c">d,</span> <span class="w">p</span><span class="c">arams)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_VER</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="c">1</span><span class="pc">, </span><span class="c">'</span><span class="w">VER</span><span class="pc">')</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">[</span><span class="c">0</span><span class="pc">].</span><span class="w">u</span><span class="c">pper</span><span class="w">() == "MSNFTP"</span><span class="c">:</span>
            <span class="c">self.sendLine</span><span class="pc">("</span><span class="w">V</span><span class="c">ER</span> <span class="w">M</span><span class="c">SNFTP</span><span class="w">"</span><span class="c">)</span>
        <span class="w">e</span><span class="c">lse:</span> 
            <span class="c">self.</span><span class="w">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_USR</span><span class="c">(self,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="pc">2</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">USR</span><span class="c">')</span>
        <span class="c">self.</span><span class="w">targetUser</span> <span class="c">=</span> <span class="w">p</span><span class="c">arams</span><span class="pc">[</span><span class="c">0]</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">au</span><span class="pc">th</span> <span class="pc">=</span><span class="c">=</span> <span class="w">i</span><span class="c">nt</span><span class="pc">(</span><span class="w">p</span><span class="c">arams</span><span class="pc">[1</span><span class="w">]):</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">endLine</span><span class="pc">("</span><span class="w">FIL</span> <span class="pc">%</span><span class="c">s</span><span class="pc">" % </span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">fileSize)</span><span class="pc">)</span>
        <span class="pc">e</span><span class="c">lse:</span> 
            <span class="c">self.</span><span class="w">t</span><span class="pc">r</span><span class="c">ansport.loseConnection()</span>

    <span class="c">def</span> <span class="w">handle_TFR</span><span class="c">(self,</span> <span class="w">p</span><span class="c">arams):</span>
        <span class="w">checkParamLen</span><span class="pc">(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span><span class="c">,</span> <span class="w">0,</span><span class="pc"> '</span><span class="w">TFR</span><span class="pc">')</span>
        
        <span class="c">self.</span><span class="w">sendPart</span><span class="pc">()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">handle_BYE</span><span class="c">(self,</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ams):</span>
        <span class="c">self.</span><span class="w">completed</span> <span class="w">=</span><span class="pc"> (s</span><span class="c">elf.</span><span class="w">bytesSent</span> <span class="w">=</span><span class="pc">=</span> <span class="c">self.</span><span class="w">fileSize</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>

    <span class="c">def</span> <span class="w">handle_CCL</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ams):</span>
        <span class="c">self.completed</span> <span class="w">=</span><span class="pc"> (</span><span class="c">self.</span><span class="w">b</span><span class="c">ytesSent</span> <span class="w">=</span><span class="c">=</span> <span class="c">self.fileSize</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>

    <span class="c">def</span> <span class="w">handle_UNKNOWN</span><span class="c">(self</span><span class="pc">,</span> <span class="w">cm</span><span class="c">d</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">rams):</span>
        <span class="w">l</span><span class="c">og.msg('</span><span class="w">rec</span><span class="c">eived</span> <span class="w">unknown</span> <span class="w">c</span><span class="pc">omm</span><span class="c">and</span> <span class="w">(</span><span class="pc">%</span><span class="c">s</span><span class="w">)</span><span class="pc">,</span> <span class="w">p</span><span class="c">arams</span><span class="w">:</span><span class="pc"> </span><span class="c">%s' % (</span><span class="w">c</span><span class="c">md,</span> <span class="w">p</span><span class="c">arams))</span>

    <span class="c">def</span> <span class="w">makeHeader</span><span class="c">(self,</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze):</span>
        
        <span class="w">quotient</span><span class="pc">,</span> <span class="w">remainder</span> <span class="c">=</span> <span class="w">divmod</span><span class="c">(</span><span class="w">si</span><span class="pc">z</span><span class="c">e</span><span class="pc">,</span> <span class="w">256</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">h</span><span class="c">r(</span><span class="pc">0</span><span class="w">) </span><span class="pc">+</span> <span class="w">c</span><span class="c">hr(</span><span class="w">r</span><span class="c">emainder</span><span class="w">)</span><span class="pc"> </span><span class="c">+</span> <span class="w">c</span><span class="c">hr(</span><span class="pc">q</span><span class="c">uotient</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">sendPart</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">con</span><span class="pc">ne</span><span class="c">cted</span><span class="pc">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_pendingSend</span> <span class="pc">=</span> <span class="w">N</span><span class="c">one</span>
            <span class="pc">r</span><span class="c">eturn</span> 
        <span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">fi</span><span class="pc">le</span><span class="c">.</span><span class="pc">r</span><span class="c">ead(self.</span><span class="w">segmentSize</span><span class="c">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">d</span><span class="c">ata</span><span class="pc">:</span>
            <span class="w">dataSize</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="pc">d</span><span class="c">ata)</span>
            <span class="w">h</span><span class="pc">eader</span> <span class="c">=</span> <span class="c">self.</span><span class="w">makeHeader</span><span class="c">(</span><span class="pc">dataS</span><span class="c">ize)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">bytesSent</span> <span class="w">+</span><span class="c">=</span> <span class="pc">d</span><span class="c">ataSize</span>
            <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.write(</span><span class="w">h</span><span class="pc">ea</span><span class="c">der</span> <span class="w">+</span> <span class="pc">d</span><span class="c">ata)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">_pendingSend</span> <span class="pc">=</span> <span class="w">rea</span><span class="pc">c</span><span class="c">tor.</span><span class="pc">c</span><span class="c">allLater(0,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">sendPart</span><span class="c">)</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="c">self.</span><span class="pc">_</span><span class="c">pendingSend</span> <span class="pc">=</span> <span class="c">None</span>
            <span class="c">self.</span><span class="w">completed</span> <span class="pc">=</span> <span class="w">1</span>


<span class="w">errorCodes</span> <span class="w">=</span><span class="pc"> </span><span class="c">{</span>

    <span class="w">2</span><span class="pc">0</span><span class="c">0</span> <span class="w">: </span><span class="pc">"</span><span class="w">Syntax</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="pc">"</span><span class="c">,</span>
    <span class="w">201</span> <span class="w">:</span><span class="pc"> </span><span class="c">"</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">parameter</span><span class="c">",</span>
    <span class="w">205</span> <span class="w">:</span><span class="pc"> </span><span class="c">"</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">u</span><span class="pc">ser</span><span class="c">",</span>
    <span class="w">206</span> <span class="w">:</span><span class="c"> "</span><span class="w">Domain</span> <span class="w">na</span><span class="pc">me</span> <span class="w">missing</span><span class="c">",</span>
    <span class="w">207</span> <span class="w">:</span><span class="c"> "</span><span class="w">Already</span> <span class="w">logged</span> <span class="w">i</span><span class="c">n",</span>
    <span class="w">208</span> <span class="w">:</span><span class="c"> "</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">user</span><span class="pc">n</span><span class="c">ame",</span>
    <span class="w">209</span> <span class="pc">:</span><span class="c"> "</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">screen</span> <span class="w">n</span><span class="pc">a</span><span class="c">me",</span>
    <span class="w">210</span> <span class="pc">:</span><span class="c"> "</span><span class="w">User</span> <span class="w">l</span><span class="pc">i</span><span class="c">st</span> <span class="w">full</span><span class="c">",</span>
    <span class="w">215</span> <span class="c">: "</span><span class="w">U</span><span class="c">ser</span> <span class="w">already</span> <span class="w">there</span><span class="c">",</span>
    <span class="w">216</span> <span class="c">: "</span><span class="pc">U</span><span class="c">ser</span> <span class="w">a</span><span class="c">lready</span> <span class="w">on</span> <span class="w">l</span><span class="pc">i</span><span class="c">st",</span>
    <span class="w">217</span> <span class="c">: "</span><span class="w">U</span><span class="c">ser</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">online</span><span class="c">",</span>
    <span class="w">218</span> <span class="c">: "</span><span class="w">Already</span> <span class="w">i</span><span class="c">n</span> <span class="w">m</span><span class="pc">ode</span><span class="c">",</span>
    <span class="w">219</span> <span class="c">: "</span><span class="w">U</span><span class="c">ser</span> <span class="w">i</span><span class="pc">s</span> <span class="w">in</span> <span class="w">t</span><span class="c">he</span> <span class="w">opposite</span> <span class="w">l</span><span class="c">ist",</span>
    <span class="w">223</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Too</span> <span class="w">many</span> <span class="w">gr</span><span class="c">oups",</span>
    <span class="w">224</span> <span class="pc">:</span><span class="c"> "</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">gr</span><span class="pc">oup</span><span class="c">",</span>
    <span class="w">225</span> <span class="pc">:</span><span class="c"> "</span><span class="pc">U</span><span class="c">ser</span> <span class="w">n</span><span class="c">ot</span> <span class="w">in</span> <span class="w">gr</span><span class="pc">oup"</span><span class="c">,</span>
    <span class="w">229</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Group</span> <span class="w">n</span><span class="pc">a</span><span class="c">me</span> <span class="w">too</span> <span class="w">l</span><span class="pc">on</span><span class="c">g</span><span class="pc">"</span><span class="c">,</span>
    <span class="w">230</span> <span class="c">: "</span><span class="w">Cannot</span> <span class="w">rem</span><span class="pc">ov</span><span class="c">e</span> <span class="w">gr</span><span class="pc">oup</span> <span class="w">0</span><span class="c">",</span>
    <span class="w">231</span> <span class="pc">:</span><span class="c"> "</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">gr</span><span class="pc">oup</span><span class="c">",</span>
    <span class="w">280</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Switchboard</span> <span class="w">fa</span><span class="c">iled",</span>
    <span class="w">281</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Transfer</span> <span class="w">t</span><span class="pc">o</span> <span class="w">switchboard</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d",</span>

    <span class="w">300</span> <span class="c">: "</span><span class="w">Required</span> <span class="w">field</span> <span class="w">missing</span><span class="c">",</span>
    <span class="w">301</span> <span class="c">: "</span><span class="w">Too</span> <span class="w">many</span> <span class="w">FND</span> <span class="w">responses</span><span class="c">",</span>
    <span class="w">302</span> <span class="c">: "</span><span class="w">Not</span> <span class="w">logged</span> <span class="w">i</span><span class="pc">n",</span>

    <span class="w">500</span> <span class="c">: "</span><span class="w">Internal</span> <span class="w">ser</span><span class="c">ver</span> <span class="w">er</span><span class="pc">ror</span><span class="c">",</span>
    <span class="w">501</span> <span class="c">: "</span><span class="w">Database</span> <span class="w">se</span><span class="pc">r</span><span class="c">ver</span> <span class="w">er</span><span class="pc">ror</span><span class="c">",</span>
    <span class="w">502</span> <span class="c">: "</span><span class="w">C</span><span class="pc">om</span><span class="c">mand</span> <span class="w">disabled</span><span class="c">",</span>
    <span class="w">510</span> <span class="c">: "</span><span class="w">F</span><span class="pc">ile</span> <span class="w">operation</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d",</span>
    <span class="w">520</span> <span class="c">: "</span><span class="w">Memory</span> <span class="w">allocation</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d",</span>
    <span class="w">540</span> <span class="c">: "</span><span class="w">Wrong</span> <span class="w">CHL</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue</span> <span class="w">sen</span><span class="pc">t</span> <span class="w">t</span><span class="pc">o</span> <span class="w">se</span><span class="pc">r</span><span class="c">ver",</span>

    <span class="w">600</span> <span class="c">: "</span><span class="w">S</span><span class="c">erver</span> <span class="w">is</span> <span class="w">busy</span><span class="c">",</span>
    <span class="w">601</span> <span class="c">: "</span><span class="w">S</span><span class="pc">e</span><span class="c">rver</span> <span class="w">is</span> <span class="w">unavaliable</span><span class="c">",</span>
    <span class="w">602</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Peer</span> <span class="w">nameserver</span> <span class="w">i</span><span class="pc">s</span> <span class="w">down</span><span class="c">",</span>
    <span class="w">603</span> <span class="c">: "</span><span class="w">Database</span> <span class="w">con</span><span class="pc">nection</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d",</span>
    <span class="w">604</span> <span class="c">: "</span><span class="w">S</span><span class="c">erver</span> <span class="w">is</span> <span class="w">going</span> <span class="w">d</span><span class="c">own",</span>
    <span class="w">605</span> <span class="c">: "</span><span class="w">S</span><span class="pc">e</span><span class="c">rver</span> <span class="w">unavailable</span><span class="c">",</span>

    <span class="w">707</span> <span class="c">: "</span><span class="w">Could</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">create</span> <span class="w">con</span><span class="pc">n</span><span class="c">ection",</span>
    <span class="w">710</span> <span class="c">: "</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">CVR</span> <span class="w">parameters</span><span class="c">",</span>
    <span class="w">711</span> <span class="c">: "</span><span class="w">Write</span> <span class="w">i</span><span class="pc">s</span> <span class="w">blocking</span><span class="c">",</span>
    <span class="w">712</span> <span class="c">: "</span><span class="w">Session</span> <span class="w">i</span><span class="pc">s</span> <span class="w">overloaded</span><span class="c">",</span>
    <span class="w">713</span> <span class="c">: "</span><span class="w">Too</span> <span class="w">many</span> <span class="w">active</span> <span class="w">user</span><span class="pc">s</span><span class="c">",</span>
    <span class="w">714</span> <span class="c">: "</span><span class="w">T</span><span class="c">oo</span> <span class="w">m</span><span class="c">any</span> <span class="w">sessions</span><span class="c">",</span>
    <span class="w">715</span> <span class="c">: "</span><span class="w">Not</span> <span class="w">ex</span><span class="pc">p</span><span class="c">ected",</span>
    <span class="w">717</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Bad</span> <span class="w">friend</span> <span class="w">fi</span><span class="c">le",</span>
    <span class="w">731</span> <span class="c">: "</span><span class="w">N</span><span class="c">ot</span> <span class="w">ex</span><span class="pc">p</span><span class="c">ected",</span>

    <span class="w">800</span> <span class="c">: "</span><span class="w">Requests</span> <span class="w">too</span> <span class="w">rapid</span><span class="c">",</span>

    <span class="w">910</span> <span class="c">: "</span><span class="w">S</span><span class="pc">e</span><span class="c">rver</span> <span class="w">t</span><span class="c">oo</span> <span class="w">busy</span><span class="c">",</span>
    <span class="w">911</span> <span class="c">: "</span><span class="w">Authentication</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d",</span>
    <span class="w">912</span> <span class="c">: "</span><span class="w">S</span><span class="pc">e</span><span class="c">rver</span> <span class="w">t</span><span class="c">oo</span> <span class="w">b</span><span class="c">usy",</span>
    <span class="w">913</span> <span class="c">: "</span><span class="pc">N</span><span class="c">ot</span> <span class="w">allowed</span> <span class="w">wh</span><span class="pc">e</span><span class="c">n</span> <span class="w">offline</span><span class="c">",</span>
    <span class="w">914</span> <span class="c">: "</span><span class="w">S</span><span class="pc">e</span><span class="c">rver</span> <span class="w">t</span><span class="c">oo</span> <span class="w">b</span><span class="c">usy",</span>
    <span class="w">915</span> <span class="c">: "</span><span class="w">S</span><span class="c">erver</span> <span class="pc">t</span><span class="c">oo</span> <span class="w">b</span><span class="c">usy",</span>
    <span class="w">916</span> <span class="pc">:</span><span class="c"> "</span><span class="w">S</span><span class="c">erver</span> <span class="pc">t</span><span class="c">oo</span> <span class="pc">b</span><span class="c">usy",</span>
    <span class="w">917</span> <span class="c">: "</span><span class="w">S</span><span class="c">erver</span> <span class="w">t</span><span class="c">oo</span> <span class="pc">b</span><span class="c">usy</span><span class="pc">"</span><span class="c">,</span>
    <span class="w">918</span> <span class="pc">:</span><span class="c"> "</span><span class="w">S</span><span class="c">erver</span> <span class="pc">t</span><span class="c">oo</span> <span class="pc">b</span><span class="c">usy",</span>
    <span class="w">919</span> <span class="c">: "</span><span class="w">S</span><span class="c">erver</span> <span class="w">t</span><span class="c">oo</span> <span class="pc">b</span><span class="c">usy</span><span class="pc">"</span><span class="c">,</span>
    <span class="w">920</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Not</span> <span class="w">accepting</span> <span class="w">ne</span><span class="pc">w</span> <span class="w">use</span><span class="pc">rs</span><span class="c">",</span>
    <span class="w">921</span> <span class="c">: "</span><span class="w">S</span><span class="pc">e</span><span class="c">rver</span> <span class="w">t</span><span class="c">oo</span> <span class="pc">b</span><span class="c">usy",</span>
    <span class="w">922</span> <span class="c">: "</span><span class="w">S</span><span class="pc">e</span><span class="c">rver</span> <span class="w">t</span><span class="c">oo</span> <span class="pc">b</span><span class="c">usy",</span>
    <span class="w">923</span> <span class="pc">:</span><span class="c"> "</span><span class="w">N</span><span class="pc">o</span> <span class="w">pa</span><span class="pc">r</span><span class="c">ent</span> <span class="w">consent</span><span class="c">",</span>
    <span class="w">924</span> <span class="c">: "</span><span class="w">Passport</span> <span class="w">ac</span><span class="pc">co</span><span class="c">unt</span> <span class="w">no</span><span class="pc">t</span> <span class="w">yet</span> <span class="w">verified</span><span class="pc">"</span>

<span class="w">}</span>


<span class="w">statusCodes</span> <span class="w">=</span><span class="pc"> {</span>

    <span class="w">STATUS_ONLINE</span>  <span class="pc">:</span><span class="c"> "</span><span class="w">Online</span><span class="c">",</span>
    <span class="w">STATUS_OFFLINE</span> <span class="pc">:</span><span class="c"> "</span><span class="w">Offline</span><span class="c">",</span>
    <span class="w">STATUS_HIDDEN</span>  <span class="c">: "</span><span class="w">Appear</span> <span class="w">O</span><span class="pc">f</span><span class="c">fline",</span>
    <span class="w">STATUS_IDLE</span>    <span class="c">: "</span><span class="w">Idle</span><span class="c">",</span>
    <span class="w">STATUS_AWAY</span>    <span class="c">: "</span><span class="w">Away</span><span class="c">",</span>
    <span class="w">STATUS_BUSY</span>    <span class="c">: "</span><span class="w">Busy</span><span class="c">",</span>
    <span class="w">STATUS_BRB</span>     <span class="c">: "</span><span class="w">Be</span> <span class="w">Right</span> <span class="w">Back</span><span class="c">",</span>
    <span class="w">STATUS_PHONE</span>   <span class="c">: "</span><span class="w">On</span> <span class="w">t</span><span class="c">he</span> <span class="w">Phone</span><span class="c">",</span>
    <span class="w">STATUS_LUNCH</span>   <span class="c">: "</span><span class="w">Out</span> <span class="w">t</span><span class="pc">o</span> <span class="w">Lunch</span><span class="pc">"</span>

<span class="w">}</span>


<span class="w">listIDToCode</span> <span class="w">=</span><span class="pc"> </span><span class="c">{</span>

    <span class="w">FORWARD_LIST</span> <span class="w">:</span><span class="pc"> '</span><span class="w">fl</span><span class="pc">'</span><span class="c">,</span>
    <span class="w">BLOCK_LIST</span>   <span class="pc">: '</span><span class="w">bl</span><span class="c">',</span>
    <span class="w">ALLOW_LIST</span>   <span class="pc">:</span><span class="c"> '</span><span class="w">al</span><span class="c">',</span>
    <span class="w">REVERSE_LIST</span> <span class="c">: '</span><span class="w">rl</span><span class="pc">'</span>

<span class="w">}</span>


<span class="w">listCodeToID</span> <span class="w">= {</span><span class="pc">}</span>
<span class="w">f</span><span class="c">or</span> <span class="w">id</span><span class="c">,</span><span class="w">co</span><span class="pc">d</span><span class="c">e</span> <span class="c">in</span> <span class="w">l</span><span class="pc">i</span><span class="c">stIDToCode</span><span class="pc">.i</span><span class="c">tems():</span>
    <span class="w">l</span><span class="c">istCodeToID</span><span class="pc">[</span><span class="w">c</span><span class="pc">od</span><span class="c">e] =</span> <span class="w">i</span><span class="pc">d</span>

<span class="w">d</span><span class="pc">el</span> <span class="w">i</span><span class="pc">d</span><span class="w">,</span> <span class="w">c</span><span class="pc">od</span><span class="c">e</span>


<span class="w">guidToClassName</span> <span class="w">=</span><span class="c"> {</span>
    <span class="w">"{5D3E02AB</span><span class="pc">-</span><span class="w">6190-11d3</span><span class="pc">-</span><span class="w">BBBB</span><span class="pc">-</span><span class="w">00C04F795683}": "f</span><span class="pc">i</span><span class="c">le</span> <span class="w">transfer"</span><span class="pc">,</span>
    <span class="w">}</span>


<span class="w">classNameToGUID</span> <span class="w">= {</span><span class="pc">}</span>
<span class="c">for</span> <span class="w">guid</span><span class="pc">,</span> <span class="w">n</span><span class="pc">a</span><span class="c">me</span> <span class="pc">i</span><span class="c">n</span> <span class="w">g</span><span class="pc">uidT</span><span class="c">oClassName.</span><span class="w">iteritems</span><span class="pc">(</span><span class="c">):</span>
    <span class="w">c</span><span class="pc">lassN</span><span class="c">ameToGUID</span><span class="pc">[n</span><span class="c">ame] =</span> <span class="pc">g</span><span class="c">uid</span>

</pre>
</body>
</html>

