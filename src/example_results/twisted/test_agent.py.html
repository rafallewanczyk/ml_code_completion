<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>





<span class="w">import</span> <span class="w">zlib</span>

<span class="w">from</span> <span class="w">io</span> <span class="w">import</span> <span class="w">BytesIO</span>

<span class="w">from</span> <span class="w">zope.interface.verify</span> <span class="w">import</span> <span class="w">verifyObject</span>

<span class="w">from</span> <span class="w">twisted.trial.unittest</span> <span class="w">import</span> <span class="w">TestCase</span>
<span class="w">from</span> <span class="w">twisted.web</span> <span class="w">import</span> <span class="w">client,</span> <span class="w">error,</span> <span class="w">http_headers</span>
<span class="w">from</span> <span class="w">twisted.web._newclient</span> <span class="w">import</span> <span class="w">RequestNotSent</span><span class="pc">,</span> <span class="w">RequestTransmissionFailed</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">w</span><span class="c">eb._newclient</span> <span class="c">import</span> <span class="w">ResponseNeverReceived</span><span class="c">,</span> <span class="w">ResponseFailed</span>
<span class="c">from</span> <span class="c">twisted.web._newclient</span> <span class="c">import</span> <span class="w">PotentialDataLoss</span>
<span class="c">from</span> <span class="c">twisted.internet</span> <span class="pc">i</span><span class="c">mport</span> <span class="pc">d</span><span class="c">efer</span><span class="pc">,</span> <span class="w">t</span><span class="c">ask</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">p</span><span class="c">ython</span><span class="pc">.f</span><span class="c">ailure</span> <span class="c">import</span> <span class="c">Failure</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">p</span><span class="c">ython.</span><span class="pc">c</span><span class="c">ompat</span> <span class="c">import</span> <span class="w">cookielib</span><span class="pc">,</span> <span class="w">intToBytes</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">p</span><span class="c">ython.</span><span class="w">co</span><span class="pc">mpo</span><span class="c">nents</span> <span class="c">import</span> <span class="w">proxyForInterface</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="w">t</span><span class="pc">e</span><span class="c">st.</span><span class="w">p</span><span class="pc">roto_</span><span class="c">helpers</span> <span class="c">import</span> <span class="c">StringTransport</span><span class="pc">,</span> <span class="w">MemoryReactorClock</span>
<span class="c">from</span> <span class="c">twisted.internet.</span><span class="w">t</span><span class="pc">a</span><span class="c">sk</span> <span class="c">import</span> <span class="w">C</span><span class="c">lock</span>
<span class="c">from</span> <span class="c">twisted.internet.</span><span class="w">e</span><span class="c">rror</span> <span class="c">import</span> <span class="w">ConnectionRefusedError</span><span class="pc">,</span> <span class="w">C</span><span class="pc">onnectionD</span><span class="c">one</span>
<span class="c">from</span> <span class="c">twisted.internet.</span><span class="pc">e</span><span class="c">rror</span> <span class="c">import</span> <span class="w">ConnectionLost</span>
<span class="c">from</span> <span class="c">twisted.internet.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="c">import</span> <span class="pc">P</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">F</span><span class="c">actory</span>
<span class="c">from</span> <span class="c">twisted.internet.</span><span class="w">d</span><span class="c">efer</span> <span class="c">import</span> <span class="c">Deferred</span><span class="pc">,</span> <span class="w">s</span><span class="pc">u</span><span class="c">cceed</span><span class="pc">,</span> <span class="w">CancelledError</span>
<span class="c">from</span> <span class="c">twisted.internet.</span><span class="w">e</span><span class="pc">n</span><span class="c">dpoints</span> <span class="c">import</span> <span class="w">TCP4ClientEndpoint</span><span class="c">,</span> <span class="w">SSL4ClientEndpoint</span>

<span class="c">from</span> <span class="c">twisted.</span><span class="pc">w</span><span class="c">eb.</span><span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="pc">i</span><span class="c">mport</span> <span class="w">(FileBodyProducer</span><span class="c">,</span> <span class="w">R</span><span class="c">equest,</span> <span class="w">HTTPConnectionPool</span><span class="c">,</span>
                                <span class="w">ResponseDone</span><span class="pc">,</span> <span class="w">_HTTP11ClientFactory</span><span class="c">,</span> <span class="w">URI</span><span class="pc">)</span>

<span class="w">f</span><span class="c">rom</span> <span class="c">twisted.</span><span class="pc">w</span><span class="c">eb.</span><span class="w">iweb</span> <span class="c">import</span> <span class="c">(</span>
    <span class="w">UNKNOWN_LENGTH</span><span class="c">,</span> <span class="w">IAgent</span><span class="c">,</span> <span class="w">IBodyProducer</span><span class="c">,</span> <span class="w">IResponse</span><span class="c">,</span> <span class="w">IAgentEndpointFactory</span><span class="c">,</span>
    <span class="w">)</span>
<span class="pc">f</span><span class="c">rom</span> <span class="c">twisted.</span><span class="pc">w</span><span class="c">eb.</span><span class="w">http_headers</span> <span class="c">import</span> <span class="w">H</span><span class="pc">e</span><span class="c">aders</span>
<span class="pc">f</span><span class="c">rom</span> <span class="c">twisted.web.</span><span class="w">_newclient</span> <span class="c">import</span> <span class="w">HTTP11ClientProtocol</span><span class="pc">,</span> <span class="w">Response</span>

<span class="pc">f</span><span class="c">rom</span> <span class="c">twisted.</span><span class="pc">i</span><span class="c">nternet.interfaces</span> <span class="c">import</span> <span class="w">IOpenSSLClientConnectionCreator</span>
<span class="c">from</span> <span class="pc">z</span><span class="c">ope.</span><span class="w">i</span><span class="pc">nterf</span><span class="c">ace</span><span class="pc">.</span><span class="w">declarations</span> <span class="c">import</span> <span class="w">i</span><span class="pc">m</span><span class="c">plementer</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">w</span><span class="c">eb</span><span class="pc">.</span><span class="w">iweb</span> <span class="c">import</span> <span class="w">IPolicyForHTTPS</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">p</span><span class="c">ython.</span><span class="w">deprecate</span> <span class="c">import</span> <span class="w">getDeprecationWarningString</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">p</span><span class="c">ython.</span><span class="w">versions</span> <span class="c">import</span> <span class="w">V</span><span class="c">ersion</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">w</span><span class="c">eb.</span><span class="w">c</span><span class="pc">l</span><span class="c">ient</span> <span class="c">import</span> <span class="w">BrowserLikePolicyForHTTPS</span>
<span class="c">from</span> <span class="c">twisted.web.</span><span class="w">e</span><span class="c">rror</span> <span class="c">import</span> <span class="w">SchemeNotSupported</span>

<span class="w">t</span><span class="c">ry:</span>
    <span class="c">from</span> <span class="c">twisted.internet</span> <span class="c">import</span> <span class="w">s</span><span class="c">sl</span>
    <span class="c">from</span> <span class="c">twisted.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocols</span><span class="pc">.</span><span class="w">tls</span> <span class="c">import</span> <span class="w">TLSMemoryBIOFactory</span><span class="pc">,</span> <span class="w">TLSMemoryBIOProtocol</span>
<span class="w">e</span><span class="c">xcept</span> <span class="c">ImportError:</span>
    <span class="w">ss</span><span class="pc">l</span> <span class="c">=</span> <span class="c">None</span>
<span class="w">e</span><span class="c">lse:</span>
    <span class="c">from</span> <span class="c">twisted.internet</span><span class="pc">.</span><span class="w">_sslverify</span> <span class="c">import</span> <span class="w">ClientTLSOptions</span><span class="pc">,</span> <span class="w">IOpenSSLTrustRoot</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">StubHTTPProtocol</span><span class="c">(</span><span class="w">P</span><span class="c">rotocol):</span>
    
    <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">req</span><span class="pc">uests</span> <span class="pc">= </span><span class="c">[]</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">tate</span> <span class="pc">= '</span><span class="w">QUIESCENT</span><span class="c">'</span>


    <span class="c">def</span> <span class="w">r</span><span class="pc">eq</span><span class="c">uest(self</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eq</span><span class="c">uest):</span>
        
        <span class="w">res</span><span class="pc">u</span><span class="c">lt</span> <span class="c">=</span> <span class="w">D</span><span class="c">eferred()</span>
        <span class="c">self.</span><span class="w">req</span><span class="pc">uests.</span><span class="c">append</span><span class="pc">((req</span><span class="c">uest,</span> <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span><span class="pc">))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">FileConsumer</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
    <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">outputFile</span><span class="c">):</span>
        <span class="c">self.outputFile</span> <span class="c">=</span> <span class="c">outputFile</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">w</span><span class="c">rite(self,</span> <span class="w">b</span><span class="c">ytes):</span>
        <span class="pc">s</span><span class="c">elf.outputFile</span><span class="pc">.w</span><span class="c">rite(</span><span class="pc">by</span><span class="c">tes)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">FileBodyProducerTests</span><span class="c">(</span><span class="w">T</span><span class="c">estCase):</span>
    
    <span class="c">def</span> <span class="w">_termination</span><span class="c">(self):</span>
        
        <span class="c">return</span> <span class="w">l</span><span class="pc">a</span><span class="c">mbda</span><span class="pc">:</span> <span class="w">T</span><span class="c">rue</span>


    <span class="c">def</span> <span class="w">s</span><span class="pc">e</span><span class="c">tUp(self):</span>
        
        <span class="c">self.</span><span class="w">_scheduled</span> <span class="pc">= </span><span class="c">[]</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">cooperator</span> <span class="c">=</span> <span class="w">t</span><span class="pc">a</span><span class="c">sk.</span><span class="w">Cooperator</span><span class="pc">(</span>
            <span class="c">self.</span><span class="w">_</span><span class="pc">t</span><span class="c">ermination,</span> <span class="c">self.</span><span class="pc">_</span><span class="c">scheduled</span><span class="pc">.a</span><span class="c">ppend</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_interface</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertT</span><span class="c">rue(</span><span class="w">v</span><span class="c">erifyObject(</span>
                <span class="w">IBodyProducer</span><span class="c">,</span> <span class="w">FileBodyProducer(B</span><span class="pc">y</span><span class="c">tesIO</span><span class="w">(</span><span class="pc">b</span><span class="w">""))))</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_unknownLength</span><span class="c">(self):</span>
        
        <span class="w">c</span><span class="c">lass</span> <span class="w">HasSeek</span><span class="c">(object):</span>
            <span class="c">def</span> <span class="w">see</span><span class="c">k(self,</span> <span class="w">of</span><span class="c">fset</span><span class="pc">,</span> <span class="w">whence</span><span class="c">):</span>
                <span class="w">p</span><span class="c">ass</span>

        <span class="pc">c</span><span class="c">lass</span> <span class="w">HasTell</span><span class="c">(object):</span>
            <span class="c">def</span> <span class="w">tell</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
                <span class="pc">p</span><span class="c">ass</span>

        <span class="w">p</span><span class="pc">r</span><span class="c">oducer</span> <span class="c">=</span> <span class="w">F</span><span class="pc">i</span><span class="c">leBodyProducer(</span><span class="pc">H</span><span class="c">asSeek</span><span class="pc">(</span><span class="c">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">a</span><span class="c">ssertEqual(</span><span class="w">UNKNOWN_LENGTH</span><span class="c">,</span> <span class="w">p</span><span class="c">roducer</span><span class="pc">.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth)</span>
        <span class="w">p</span><span class="pc">r</span><span class="c">oducer</span> <span class="pc">=</span> <span class="w">F</span><span class="c">ileBodyProducer</span><span class="pc">(</span><span class="w">H</span><span class="pc">asT</span><span class="c">ell</span><span class="pc">()</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">U</span><span class="c">NKNOWN_LENGTH</span><span class="pc">,</span> <span class="pc">p</span><span class="c">roducer.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_knownLength</span><span class="c">(self):</span>
        
        <span class="w">inputBytes</span> <span class="c">=</span> <span class="pc">b</span><span class="c">"</span><span class="w">here</span> <span class="w">are</span> <span class="w">so</span><span class="c">me</span> <span class="w">b</span><span class="pc">y</span><span class="c">tes</span><span class="pc">"</span>
        <span class="w">inputFile</span> <span class="c">=</span> <span class="w">B</span><span class="c">ytesIO</span><span class="pc">(i</span><span class="c">nputBytes)</span>
        <span class="pc">i</span><span class="c">nputFile.</span><span class="w">s</span><span class="pc">e</span><span class="c">ek(</span><span class="w">5</span><span class="pc">)</span>
        <span class="w">pr</span><span class="pc">od</span><span class="c">ucer</span> <span class="pc">=</span> <span class="w">FileBodyProducer</span><span class="c">(inputFile)</span>
        <span class="c">self.assertEqual(len(</span><span class="pc">i</span><span class="c">nputBytes</span><span class="w">) -</span> <span class="w">5</span><span class="pc">,</span> <span class="w">p</span><span class="c">roducer</span><span class="pc">.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth)</span>
        <span class="c">self.assertEqual(</span><span class="pc">i</span><span class="c">nputFile.</span><span class="w">tell</span><span class="pc">()</span><span class="c">,</span> <span class="w">5</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_defaultCooperator</span><span class="c">(self):</span>
        
        <span class="w">p</span><span class="pc">rod</span><span class="c">ucer</span> <span class="c">=</span> <span class="w">F</span><span class="pc">ileB</span><span class="c">odyProducer</span><span class="pc">(</span><span class="w">B</span><span class="pc">y</span><span class="c">tesIO</span><span class="pc">(b</span><span class="w">""))</span>
        <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="w">ta</span><span class="pc">s</span><span class="c">k.</span><span class="w">cooperate</span><span class="c">,</span> <span class="w">p</span><span class="c">roducer.</span><span class="w">_cooperate</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_startProducing</span><span class="c">(self):</span>
        
        <span class="w">expectedResult</span> <span class="c">=</span> <span class="pc">b</span><span class="c">"</span><span class="w">h</span><span class="pc">e</span><span class="c">llo</span><span class="w">,</span> <span class="w">w</span><span class="c">orld</span><span class="pc">"</span>
        <span class="w">readSize</span> <span class="pc">=</span> <span class="w">3</span>
        <span class="w">o</span><span class="pc">u</span><span class="c">tput</span> <span class="c">=</span> <span class="w">B</span><span class="c">ytesIO()</span>
        <span class="w">co</span><span class="pc">ns</span><span class="c">umer</span> <span class="pc">=</span> <span class="w">FileConsumer</span><span class="pc">(</span><span class="w">o</span><span class="pc">u</span><span class="c">tput)</span>
        <span class="w">p</span><span class="c">roducer</span> <span class="c">=</span> <span class="w">FileBodyProducer</span><span class="c">(</span>
            <span class="w">B</span><span class="c">ytesIO(</span><span class="pc">e</span><span class="c">xpectedResult</span><span class="w">)</span><span class="pc">,</span> <span class="w">s</span><span class="c">elf.</span><span class="w">cooperator</span><span class="pc">,</span> <span class="w">rea</span><span class="pc">d</span><span class="c">Size)</span>
        <span class="w">complete</span> <span class="c">=</span> <span class="w">p</span><span class="c">roducer.</span><span class="w">startProducing</span><span class="c">(</span><span class="w">c</span><span class="c">onsumer)</span>
        <span class="w">f</span><span class="c">or</span> <span class="pc">i</span> <span class="c">in</span> <span class="c">range(</span><span class="w">l</span><span class="c">en(</span><span class="w">e</span><span class="pc">x</span><span class="c">pectedResult</span><span class="w">) //</span> <span class="w">r</span><span class="pc">ea</span><span class="c">dSize</span> <span class="w">+</span> <span class="c">1</span><span class="pc">):</span>
            <span class="c">self.</span><span class="w">_scheduled</span><span class="pc">.</span><span class="w">p</span><span class="c">op(0</span><span class="w">)()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">a</span><span class="c">ssertEqual</span><span class="w">([],</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_</span><span class="c">scheduled</span><span class="w">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">e</span><span class="c">xpectedResult</span><span class="pc">,</span> <span class="w">o</span><span class="pc">u</span><span class="c">tput</span><span class="pc">.</span><span class="w">g</span><span class="c">etvalue</span><span class="pc">())</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">N</span><span class="c">one,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="pc">u</span><span class="c">ccessResultOf(</span><span class="w">complete)</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_inputClosedAtEOF</span><span class="c">(self):</span>
        
        <span class="w">readSize</span> <span class="c">=</span> <span class="w">4</span>
        <span class="w">inputBytes</span> <span class="c">=</span> <span class="w">b</span><span class="c">"</span><span class="w">s</span><span class="c">ome</span> <span class="w">friendly</span> <span class="w">b</span><span class="c">ytes</span><span class="w">"</span>
        <span class="w">inputFile</span> <span class="pc">=</span> <span class="w">B</span><span class="c">ytesIO</span><span class="pc">(</span><span class="w">i</span><span class="c">nputBytes)</span>
        <span class="w">pr</span><span class="pc">od</span><span class="c">ucer</span> <span class="c">=</span> <span class="w">FileBodyProducer</span><span class="pc">(</span><span class="w">i</span><span class="pc">nputF</span><span class="c">ile</span><span class="pc">,</span> <span class="c">self.</span><span class="w">cooperator</span><span class="pc">,</span> <span class="pc">r</span><span class="c">eadSize</span><span class="pc">)</span>
        <span class="w">c</span><span class="pc">o</span><span class="c">nsumer</span> <span class="pc">=</span> <span class="w">FileConsumer</span><span class="c">(</span><span class="w">B</span><span class="pc">y</span><span class="c">tesIO</span><span class="pc">()</span><span class="c">)</span>
        <span class="w">p</span><span class="pc">r</span><span class="c">oducer</span><span class="pc">.</span><span class="w">startProducing</span><span class="c">(</span><span class="w">c</span><span class="pc">on</span><span class="c">sumer)</span>
        <span class="w">f</span><span class="c">or</span> <span class="w">i</span> <span class="c">in</span> <span class="pc">r</span><span class="c">ange(</span><span class="w">l</span><span class="c">en(</span><span class="w">i</span><span class="pc">nputB</span><span class="c">ytes</span><span class="w">) //</span> <span class="w">r</span><span class="pc">e</span><span class="c">adSize</span> <span class="w">+</span> <span class="pc">2):</span>
            <span class="c">self.</span><span class="w">_scheduled</span><span class="pc">.</span><span class="w">p</span><span class="c">op(0</span><span class="w">)()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">ssertT</span><span class="c">rue(</span><span class="w">inputFile</span><span class="pc">.</span><span class="w">cl</span><span class="pc">osed)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_failedReadWhileProducing</span><span class="c">(self):</span>
        
        <span class="w">c</span><span class="c">lass</span> <span class="w">BrokenFile</span><span class="c">(object):</span>
            <span class="c">def</span> <span class="w">rea</span><span class="pc">d</span><span class="c">(self</span><span class="pc">,</span> <span class="w">cou</span><span class="c">nt):</span>
                <span class="pc">ra</span><span class="c">ise</span> <span class="w">I</span><span class="c">OError("</span><span class="w">Simulated</span> <span class="w">ba</span><span class="pc">d</span> <span class="w">thing</span><span class="c">")</span>
        <span class="w">pr</span><span class="pc">od</span><span class="c">ucer</span> <span class="pc">=</span> <span class="w">FileBodyProducer</span><span class="pc">(B</span><span class="c">rokenFile</span><span class="w">(</span><span class="pc">),</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">cooperator</span><span class="pc">)</span>
        <span class="w">complete</span> <span class="c">=</span> <span class="w">pr</span><span class="pc">od</span><span class="c">ucer.</span><span class="w">startProducing</span><span class="c">(</span><span class="w">FileConsumer</span><span class="c">(</span><span class="w">B</span><span class="pc">y</span><span class="c">tesIO</span><span class="w">(</span><span class="pc">)))</span>
        <span class="c">self.</span><span class="w">_scheduled</span><span class="pc">.</span><span class="w">p</span><span class="c">op(0</span><span class="w">)()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">failureResultOf</span><span class="pc">(</span><span class="c">complete</span><span class="w">).tr</span><span class="pc">ap</span><span class="c">(</span><span class="w">I</span><span class="c">OError</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_stopProducing</span><span class="c">(self):</span>
        
        <span class="w">expectedResult</span> <span class="c">=</span> <span class="w">b</span><span class="c">"</span><span class="w">h</span><span class="pc">e</span><span class="c">llo</span><span class="w">,</span> <span class="w">w</span><span class="c">orld</span><span class="pc">"</span>
        <span class="w">readSize</span> <span class="pc">=</span> <span class="w">3</span>
        <span class="w">o</span><span class="pc">u</span><span class="c">tput</span> <span class="c">=</span> <span class="w">B</span><span class="c">ytesIO()</span>
        <span class="w">co</span><span class="pc">ns</span><span class="c">umer</span> <span class="pc">=</span> <span class="w">FileConsumer</span><span class="c">(</span><span class="w">o</span><span class="pc">u</span><span class="c">tput)</span>
        <span class="w">inputFile</span> <span class="c">=</span> <span class="w">B</span><span class="c">ytesIO</span><span class="pc">(</span><span class="w">e</span><span class="pc">x</span><span class="c">pectedResult)</span>
        <span class="w">p</span><span class="pc">r</span><span class="c">oducer</span> <span class="c">=</span> <span class="w">FileBodyProducer</span><span class="c">(</span>
            <span class="pc">i</span><span class="c">nputFile</span><span class="pc">,</span> <span class="w">s</span><span class="c">elf.</span><span class="w">cooperator</span><span class="pc">,</span> <span class="pc">r</span><span class="c">eadSize)</span>
        <span class="w">complete</span> <span class="c">=</span> <span class="w">p</span><span class="c">roducer.</span><span class="w">startProducing</span><span class="c">(</span><span class="w">c</span><span class="pc">on</span><span class="c">sumer)</span>
        <span class="pc">p</span><span class="c">roducer</span><span class="pc">.</span><span class="w">s</span><span class="pc">topP</span><span class="c">roducing()</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">i</span><span class="c">nputFile.</span><span class="w">cl</span><span class="pc">osed)</span>
        <span class="c">self.</span><span class="w">_scheduled</span><span class="pc">.</span><span class="w">p</span><span class="pc">o</span><span class="c">p(0</span><span class="w">)()</span>
        <span class="c">self.</span><span class="pc">a</span><span class="c">ssertEqual(</span><span class="w">b"",</span> <span class="w">o</span><span class="c">utput</span><span class="pc">.g</span><span class="c">etvalue</span><span class="pc">())</span>
        <span class="c">self.</span><span class="w">assertNoResult</span><span class="pc">(</span><span class="w">complete</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_pauseProducing</span><span class="c">(self):</span>
        
        <span class="w">expectedResult</span> <span class="c">=</span> <span class="w">b</span><span class="c">"</span><span class="w">h</span><span class="pc">e</span><span class="c">llo</span><span class="w">,</span> <span class="pc">w</span><span class="c">orld</span><span class="pc">"</span>
        <span class="w">readSize</span> <span class="pc">=</span> <span class="w">5</span>
        <span class="w">o</span><span class="pc">u</span><span class="c">tput</span> <span class="c">=</span> <span class="w">B</span><span class="c">ytesIO()</span>
        <span class="w">co</span><span class="pc">ns</span><span class="c">umer</span> <span class="pc">=</span> <span class="w">FileConsumer</span><span class="pc">(</span><span class="w">o</span><span class="pc">u</span><span class="c">tput)</span>
        <span class="w">p</span><span class="c">roducer</span> <span class="c">=</span> <span class="w">FileBodyProducer</span><span class="c">(</span>
            <span class="w">B</span><span class="c">ytesIO(</span><span class="pc">e</span><span class="c">xpectedResult</span><span class="w">)</span><span class="pc">,</span> <span class="w">s</span><span class="c">elf.</span><span class="w">cooperator</span><span class="pc">,</span> <span class="w">rea</span><span class="pc">d</span><span class="c">Size)</span>
        <span class="w">complete</span> <span class="c">=</span> <span class="w">p</span><span class="c">roducer.</span><span class="w">startProducing</span><span class="c">(</span><span class="w">c</span><span class="c">onsumer)</span>
        <span class="c">self.</span><span class="w">_scheduled</span><span class="pc">.</span><span class="w">p</span><span class="pc">o</span><span class="c">p(</span><span class="pc">0</span><span class="w">)()</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">o</span><span class="c">utput.</span><span class="pc">g</span><span class="c">etvalue(),</span> <span class="w">e</span><span class="c">xpectedResult</span><span class="w">[</span><span class="pc">:</span><span class="w">5</span><span class="c">])</span>
        <span class="w">p</span><span class="pc">rod</span><span class="c">ucer</span><span class="pc">.</span><span class="w">p</span><span class="c">auseProducing()</span>

        
        
        
        
        <span class="c">self.</span><span class="pc">_</span><span class="c">scheduled.</span><span class="w">p</span><span class="c">op(0</span><span class="w">)(</span><span class="c">)</span>

        
        <span class="c">self.</span><span class="pc">a</span><span class="c">ssertEqual(</span><span class="w">o</span><span class="c">utput.</span><span class="pc">g</span><span class="c">etvalue(),</span> <span class="pc">e</span><span class="c">xpectedResult</span><span class="w">[</span><span class="pc">:</span><span class="w">5</span><span class="c">])</span>
        <span class="pc">s</span><span class="c">elf.assertEqual</span><span class="w">([],</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">_</span><span class="c">scheduled</span><span class="w">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">assertNoResult</span><span class="c">(</span><span class="w">complete</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_resumeProducing</span><span class="c">(self):</span>
        
        <span class="pc">e</span><span class="c">xpectedResult</span> <span class="c">=</span> <span class="w">b</span><span class="c">"</span><span class="pc">h</span><span class="c">ello</span><span class="w">,</span> <span class="w">w</span><span class="c">orld</span><span class="pc">"</span>
        <span class="w">readSize</span> <span class="pc">=</span> <span class="w">5</span>
        <span class="w">o</span><span class="pc">u</span><span class="c">tput</span> <span class="c">=</span> <span class="w">B</span><span class="c">ytesIO()</span>
        <span class="w">co</span><span class="pc">ns</span><span class="c">umer</span> <span class="pc">=</span> <span class="w">FileConsumer</span><span class="pc">(</span><span class="w">o</span><span class="pc">u</span><span class="c">tput)</span>
        <span class="w">p</span><span class="pc">rod</span><span class="c">ucer</span> <span class="c">=</span> <span class="w">FileBodyProducer</span><span class="c">(</span>
            <span class="w">B</span><span class="c">ytesIO(</span><span class="pc">e</span><span class="c">xpectedResult</span><span class="w">)</span><span class="pc">,</span> <span class="w">s</span><span class="c">elf.</span><span class="w">cooperator</span><span class="pc">,</span> <span class="w">rea</span><span class="pc">d</span><span class="c">Size)</span>
        <span class="w">p</span><span class="c">roducer</span><span class="pc">.</span><span class="w">startProducing</span><span class="c">(</span><span class="w">c</span><span class="c">onsumer)</span>
        <span class="c">self.</span><span class="w">_scheduled</span><span class="pc">.</span><span class="w">p</span><span class="pc">o</span><span class="c">p(0</span><span class="w">)()</span>
        <span class="c">self.assertEqual(</span><span class="w">e</span><span class="c">xpectedResult</span><span class="w">[</span><span class="pc">:</span><span class="c">readSize</span><span class="w">]</span><span class="pc">,</span> <span class="w">o</span><span class="c">utput</span><span class="pc">.g</span><span class="c">etvalue())</span>
        <span class="w">p</span><span class="c">roducer</span><span class="pc">.</span><span class="w">p</span><span class="pc">a</span><span class="c">useProducing()</span>
        <span class="w">p</span><span class="c">roducer.</span><span class="pc">res</span><span class="c">umeProducing()</span>
        <span class="c">self.</span><span class="w">_</span><span class="c">scheduled</span><span class="pc">.</span><span class="w">p</span><span class="pc">o</span><span class="c">p(0</span><span class="w">)(</span><span class="c">)</span>
        <span class="c">self.</span><span class="pc">assertE</span><span class="c">qual(</span><span class="w">e</span><span class="c">xpectedResult</span><span class="w">[</span><span class="pc">:r</span><span class="c">eadSize</span> <span class="w">*</span> <span class="pc">2</span><span class="w">]</span><span class="pc">,</span> <span class="w">o</span><span class="c">utput.</span><span class="pc">g</span><span class="c">etvalue</span><span class="pc">())</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">FakeReactorAndConnectMixin</span><span class="pc">:</span>
    
    <span class="w">Reactor</span> <span class="pc">=</span> <span class="w">MemoryReactorClock</span>

    <span class="w">@</span><span class="c">implementer(</span><span class="w">IPolicyForHTTPS</span><span class="c">)</span>
    <span class="pc">c</span><span class="c">lass</span> <span class="w">StubPolicy</span><span class="c">(object):</span>
        
        <span class="c">def</span> <span class="w">creatorForNetloc</span><span class="c">(self</span><span class="pc">,</span> <span class="w">h</span><span class="c">ostname,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">)</span><span class="c">:</span>
            

    <span class="w">c</span><span class="pc">l</span><span class="c">ass</span> <span class="w">StubEndpoint</span><span class="c">(object):</span>
        

        <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">en</span><span class="pc">d</span><span class="c">point</span><span class="pc">,</span> <span class="w">testCase</span><span class="c">):</span>
            <span class="c">self.</span><span class="w">en</span><span class="pc">dpoint</span> <span class="c">=</span> <span class="w">e</span><span class="pc">n</span><span class="c">dpoint</span>
            <span class="c">self.testCase</span> <span class="c">=</span> <span class="c">testCase</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory</span> <span class="c">=</span> <span class="w">_HTTP11ClientFactory</span><span class="pc">(</span><span class="w">l</span><span class="c">ambda</span> <span class="w">p</span><span class="c">:</span> <span class="w">N</span><span class="c">one</span><span class="w">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">StubHTTPProtocol</span><span class="pc">()</span>
            <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="pc">b</span><span class="c">uildProtocol</span> <span class="w">=</span> <span class="pc">l</span><span class="c">ambda</span> <span class="w">a</span><span class="c">ddr:</span> <span class="c">self.protocol</span>

        <span class="w">d</span><span class="c">ef</span> <span class="pc">connect</span><span class="c">(self</span><span class="pc">,</span> <span class="w">ignoredFactory</span><span class="c">):</span>
            <span class="c">self.</span><span class="w">t</span><span class="pc">e</span><span class="c">stCase.</span><span class="w">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">p</span><span class="c">rotocol</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">e</span><span class="c">ndpoint.</span><span class="pc">c</span><span class="c">onnect(self.factory</span><span class="pc">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">su</span><span class="c">cceed(self.</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">buildAgentForWrapperTest</span><span class="c">(self</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="c">(</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">StubPolicy</span><span class="pc">()</span><span class="c">)</span>
        <span class="w">_oldGetEndpoint</span> <span class="pc">=</span> <span class="w">a</span><span class="c">gent.</span><span class="w">_getEndpoint</span>
        <span class="w">ag</span><span class="c">ent</span><span class="pc">.</span><span class="w">_</span><span class="pc">g</span><span class="c">etEndpoint</span> <span class="c">=</span> <span class="w">l</span><span class="c">ambda</span> <span class="w">*a</span><span class="c">rgs</span><span class="w">: (</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">StubEndpoint</span><span class="c">(</span><span class="pc">_</span><span class="c">oldGetEndpoint</span><span class="w">(*</span><span class="c">args</span><span class="pc">)</span><span class="c">,</span> <span class="pc">s</span><span class="c">elf</span><span class="pc">))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">onnect</span><span class="c">(self,</span> <span class="pc">f</span><span class="c">actory):</span>
        
        <span class="w">pr</span><span class="pc">otoc</span><span class="c">ol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
        <span class="pc">p</span><span class="c">rotocol</span><span class="pc">.</span><span class="c">makeConnection(</span><span class="w">N</span><span class="c">one)</span>
        <span class="c">self.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="pc">p</span><span class="c">rotocol</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="w">s</span><span class="pc">u</span><span class="c">cceed(</span><span class="pc">p</span><span class="c">rotocol)</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">DummyEndpoint</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
    

    <span class="c">def</span> <span class="pc">connect</span><span class="c">(self</span><span class="pc">,</span> <span class="pc">f</span><span class="c">actory):</span>
        <span class="pc">protoc</span><span class="c">ol</span> <span class="c">=</span> <span class="w">f</span><span class="c">actory.</span><span class="pc">b</span><span class="c">uildProtocol(</span><span class="pc">N</span><span class="c">one)</span>
        <span class="c">protocol</span><span class="pc">.m</span><span class="c">akeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">s</span><span class="pc">u</span><span class="c">cceed(</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">BadEndpoint</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
    

    <span class="c">def</span> <span class="pc">connect</span><span class="c">(self</span><span class="pc">,</span> <span class="pc">f</span><span class="c">actory):</span>
        <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="pc">R</span><span class="c">untimeError</span><span class="pc">("</span><span class="w">T</span><span class="pc">h</span><span class="c">is</span> <span class="w">end</span><span class="pc">p</span><span class="c">oint</span> <span class="w">s</span><span class="pc">h</span><span class="c">ould</span> <span class="c">not</span> <span class="w">h</span><span class="c">ave</span> <span class="w">been</span> <span class="w">used.</span><span class="c">")</span>


<span class="c">class</span> <span class="w">DummyFactory</span><span class="c">(</span><span class="w">F</span><span class="c">actory):</span>
    
    <span class="pc">d</span><span class="c">ef</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">quiescentCallback</span><span class="c">):</span>
        <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

    <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">HTTPConnectionPoolTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="pc">s</span><span class="c">etUp(self):</span>
        <span class="c">self.</span><span class="w">fakeReactor</span> <span class="c">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">HTTPConnectionPool</span><span class="c">(self.fakeReactor)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">_factory</span> <span class="pc">=</span> <span class="w">DummyFactory</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">retryAutomatically</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_getReturnsNewIfCacheEmpty</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">a</span><span class="c">ssertEqual(self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections, {})</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">gotConnection</span><span class="c">(</span><span class="w">conn</span><span class="c">):</span>
            <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">conn</span><span class="pc">,</span> <span class="w">StubHTTPProtocol</span><span class="c">)</span>
            
            <span class="c">self.</span><span class="w">assertN</span><span class="c">otIn(</span><span class="w">con</span><span class="pc">n,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_</span><span class="c">connections</span><span class="pc">.</span><span class="w">v</span><span class="pc">alues())</span>

        <span class="w">unknownKey</span> <span class="c">=</span> <span class="w">12245</span>
        <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection</span><span class="c">(unknownKey</span><span class="pc">,</span> <span class="w">DummyEndpoint(</span><span class="pc">)</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d.addCallback(</span><span class="w">gotConnection</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_putStartsTimeout</span><span class="c">(self):</span>
        
        
        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="pc">()</span>
        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.makeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">_putConnection(("h</span><span class="pc">t</span><span class="c">tp</span><span class="w">"</span><span class="c">,</span> <span class="w">b</span><span class="pc">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">),</span> <span class="w">p</span><span class="c">rotocol</span><span class="pc">)</span>

        
        <span class="pc">s</span><span class="c">elf.assertEqual(protocol.transport.</span><span class="pc">d</span><span class="c">isconnecting</span><span class="pc">,</span> <span class="c">False)</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">n</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">,</span>
                      <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[("h</span><span class="c">ttp</span><span class="pc">"</span><span class="c">,</span> <span class="pc">b"e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)]</span><span class="c">)</span>

        
        <span class="c">self.</span><span class="w">fakeReactor</span><span class="pc">.</span><span class="w">a</span><span class="pc">d</span><span class="c">vance(</span><span class="w">239</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">p</span><span class="c">rotocol.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">d</span><span class="c">isconnecting</span><span class="pc">,</span> <span class="pc">F</span><span class="c">alse)</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">n</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">,</span>
                      <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="w">b</span><span class="pc">"e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)]</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">n</span><span class="c">(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">,</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_timeouts</span><span class="pc">)</span>

        
        <span class="c">self.</span><span class="w">fakeReactor</span><span class="pc">.a</span><span class="c">dvance(</span><span class="pc">1.</span><span class="c">1</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">p</span><span class="c">rotocol.transport.</span><span class="pc">d</span><span class="c">isconnecting,</span> <span class="w">T</span><span class="c">rue)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">assertN</span><span class="c">otIn(</span><span class="w">p</span><span class="c">rotocol</span><span class="pc">,</span>
                         <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="w">b</span><span class="pc">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)]</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">assertN</span><span class="c">otIn(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">,</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">_timeouts</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_putExceedsMaxPersistent</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span>

        
        <span class="w">origCached</span> <span class="w">=</span><span class="pc"> [</span><span class="w">StubHTTPProtocol(</span><span class="pc">)</span><span class="c">,</span> <span class="w">S</span><span class="c">tubHTTPProtocol</span><span class="w">()]</span>
        <span class="w">f</span><span class="pc">or</span> <span class="w">p</span> <span class="c">in</span> <span class="w">o</span><span class="c">rigCached</span><span class="pc">:</span>
            <span class="w">p</span><span class="c">.</span><span class="pc">m</span><span class="c">akeConnection(</span><span class="w">S</span><span class="c">tringTransport())</span>
            <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection(("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="w">b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">),</span> <span class="w">p</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[("h</span><span class="c">ttp</span><span class="w">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)],</span>
                         <span class="w">origCached</span><span class="pc">)</span>
        <span class="w">timeouts</span> <span class="c">=</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_timeouts</span><span class="pc">.</span><span class="w">c</span><span class="pc">op</span><span class="c">y()</span>

        
        <span class="w">newProtocol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="pc">()</span>
        <span class="pc">n</span><span class="c">ewProtocol.</span><span class="pc">m</span><span class="c">akeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection(("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="pc">b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">),</span> <span class="pc">n</span><span class="c">ewProtocol)</span>

        
        <span class="w">newCached</span> <span class="c">=</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="pc">b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)]</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">l</span><span class="c">en(newCached),</span> <span class="pc">2</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(newCached</span><span class="pc">, </span><span class="c">[</span><span class="w">origCached[</span><span class="pc">1</span><span class="w">],</span> <span class="w">n</span><span class="pc">ewP</span><span class="c">rotocol</span><span class="pc">]</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual</span><span class="pc">([</span><span class="w">p</span><span class="c">.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">d</span><span class="c">isconnecting</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="pc">p</span> <span class="c">in</span> <span class="pc">newC</span><span class="c">ached</span><span class="w">]</span><span class="pc">,</span>
                         <span class="pc">[</span><span class="w">F</span><span class="c">alse</span><span class="w">,</span> <span class="pc">F</span><span class="c">alse</span><span class="pc">]</span><span class="c">)</span>
        <span class="c">self.assertEqual(origCached</span><span class="pc">[</span><span class="c">0</span><span class="pc">].t</span><span class="c">ransport.</span><span class="w">d</span><span class="pc">i</span><span class="c">sconnecting</span><span class="pc">,</span> <span class="pc">T</span><span class="c">rue)</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">timeouts</span><span class="pc">[</span><span class="w">o</span><span class="c">rigCached</span><span class="w">[</span><span class="c">0</span><span class="w">]].cancelled)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">assertN</span><span class="c">otIn(</span><span class="pc">o</span><span class="c">rigCached[0</span><span class="pc">],</span> <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">_timeouts</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_maxPersistentPerHost</span><span class="c">(self):</span>
        
        <span class="w">d</span><span class="c">ef</span> <span class="w">addProtocol</span><span class="c">(</span><span class="w">sc</span><span class="c">heme</span><span class="pc">,</span> <span class="pc">h</span><span class="c">ost,</span> <span class="c">port</span><span class="pc">)</span><span class="c">:</span>
            <span class="w">p</span> <span class="pc">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
            <span class="pc">p</span><span class="c">.</span><span class="w">m</span><span class="c">akeConnection(</span><span class="w">S</span><span class="c">tringTransport())</span>
            <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection((sc</span><span class="c">heme,</span> <span class="w">h</span><span class="c">ost,</span> <span class="c">port</span><span class="w">)</span><span class="pc">,</span> <span class="pc">p</span><span class="c">)</span>
            <span class="w">r</span><span class="c">eturn</span> <span class="w">p</span>
        <span class="w">persistent</span> <span class="w">=</span><span class="pc"> </span><span class="c">[]</span>
        <span class="w">pe</span><span class="c">rsistent.</span><span class="pc">a</span><span class="c">ppend(</span><span class="w">a</span><span class="pc">ddP</span><span class="c">rotocol</span><span class="w">(</span><span class="pc">"</span><span class="w">h</span><span class="pc">t</span><span class="c">tp</span><span class="pc">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"</span><span class="pc">e</span><span class="c">xample.com</span><span class="pc">"</span><span class="c">,</span> <span class="w">8</span><span class="c">0</span><span class="pc">))</span>
        <span class="w">p</span><span class="pc">e</span><span class="c">rsistent.</span><span class="pc">ap</span><span class="c">pend(</span><span class="w">a</span><span class="c">ddProtocol</span><span class="w">(</span><span class="pc">"</span><span class="w">h</span><span class="pc">t</span><span class="c">tp</span><span class="pc">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"example.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">))</span>
        <span class="w">a</span><span class="c">ddProtocol</span><span class="w">(</span><span class="pc">"</span><span class="w">https</span><span class="c">",</span> <span class="c">b"</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">443)</span>
        <span class="w">a</span><span class="c">ddProtocol</span><span class="w">(</span><span class="pc">"</span><span class="w">h</span><span class="c">ttp</span><span class="pc">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"</span><span class="w">www2.</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">)</span>

        <span class="c">self.assertEqual(</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[("h</span><span class="c">ttp</span><span class="w">"</span><span class="c">,</span> <span class="pc">b</span><span class="c">"</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)],</span> <span class="w">persistent</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span>
            <span class="w">l</span><span class="c">en(self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_</span><span class="c">connections</span><span class="w">[</span><span class="pc">(</span><span class="c">"</span><span class="w">https"</span><span class="pc">,</span> <span class="w">b</span><span class="c">"</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">443)]),</span> <span class="pc">1)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span>
            <span class="w">l</span><span class="c">en(self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_</span><span class="c">connections</span><span class="w">[</span><span class="pc">(</span><span class="c">"</span><span class="w">h</span><span class="pc">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="w">b</span><span class="c">"</span><span class="w">www2.</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)]</span><span class="c">),</span> <span class="pc">1</span><span class="w">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_getCachedConnection</span><span class="c">(self):</span>
        
        
        <span class="w">pr</span><span class="pc">ot</span><span class="c">ocol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span><span class="pc">.</span><span class="c">makeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection(("h</span><span class="c">ttp</span><span class="w">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">),</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">)</span>

        <span class="c">def</span> <span class="w">gotConnection</span><span class="c">(</span><span class="w">conn</span><span class="c">):</span>
            
            <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">conn</span><span class="pc">)</span>
            <span class="c">self.</span><span class="w">assertN</span><span class="c">otIn(</span>
                <span class="w">conn</span><span class="pc">,</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">_connections[("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="pc">b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">)]</span><span class="c">)</span>
            
            <span class="c">self.</span><span class="w">fakeReactor</span><span class="pc">.</span><span class="w">a</span><span class="pc">d</span><span class="c">vance(</span><span class="w">241</span><span class="c">)</span>
            <span class="c">self.assertEqual(</span><span class="w">conn</span><span class="c">.transport.</span><span class="w">d</span><span class="c">isconnecting</span><span class="pc">,</span> <span class="pc">F</span><span class="c">alse)</span>
            <span class="c">self.</span><span class="w">assertN</span><span class="c">otIn(</span><span class="w">conn</span><span class="pc">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_timeouts</span><span class="c">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection(("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="w">b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">)</span><span class="c">,</span>
                                       <span class="w">BadEndpoint(</span><span class="pc">)</span><span class="c">,</span>
                                       <span class="w">).a</span><span class="c">ddCallback(</span><span class="w">gotConnection</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_newConnection</span><span class="c">(self):</span>
        
        
        <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
        <span class="w">p</span><span class="c">rotocol</span><span class="pc">.</span><span class="c">makeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="w">k</span><span class="c">ey</span> <span class="c">=</span> <span class="w">12245</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection</span><span class="c">(</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">pr</span><span class="pc">otoc</span><span class="c">ol</span><span class="pc">)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">g</span><span class="pc">o</span><span class="c">tConnection(</span><span class="w">newConnection</span><span class="pc">)</span><span class="c">:</span>
            
            <span class="c">self.</span><span class="w">assertNotIdentical</span><span class="pc">(</span><span class="w">p</span><span class="c">rotocol</span><span class="pc">,</span> <span class="c">newConnection</span><span class="pc">)</span>
            
            <span class="pc">s</span><span class="c">elf.</span><span class="w">assertI</span><span class="pc">n</span><span class="c">(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[k</span><span class="c">ey</span><span class="pc">])</span>
            
            <span class="c">self.</span><span class="w">assertN</span><span class="pc">otIn</span><span class="c">(</span><span class="w">n</span><span class="pc">e</span><span class="c">wConnection,</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="pc">_</span><span class="c">connections</span><span class="pc">.</span><span class="w">v</span><span class="pc">alues())</span>

        <span class="w">d</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_newConnection</span><span class="c">(</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">DummyEndpoint</span><span class="pc">(</span><span class="c">))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d.addCallback(</span><span class="w">gotConnection</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_getSkipsDisconnected</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span>
        <span class="w">k</span><span class="pc">e</span><span class="c">y</span> <span class="w">= ("h</span><span class="pc">t</span><span class="c">tp</span><span class="w">",</span> <span class="w">b</span><span class="pc">"</span><span class="w">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0)</span>

        
        <span class="w">origCached</span> <span class="pc">= [</span><span class="w">StubHTTPProtocol(</span><span class="pc">)</span><span class="c">,</span> <span class="w">S</span><span class="c">tubHTTPProtocol</span><span class="w">()]</span>
        <span class="w">f</span><span class="pc">or</span> <span class="w">p</span> <span class="c">in</span> <span class="w">o</span><span class="c">rigCached:</span>
            <span class="w">p</span><span class="c">.</span><span class="w">m</span><span class="c">akeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
            <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection</span><span class="c">(</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="pc">p</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections[k</span><span class="c">ey</span><span class="pc">],</span> <span class="w">o</span><span class="c">rigCached)</span>

        
        <span class="w">o</span><span class="c">rigCached</span><span class="w">[</span><span class="pc">0].</span><span class="w">sta</span><span class="pc">t</span><span class="c">e</span> <span class="w">= </span><span class="pc">"</span><span class="w">DISCONNECTED</span><span class="pc">"</span>

        
        <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span> <span class="w">=</span><span class="pc"> [</span><span class="c">]</span>
        <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection</span><span class="c">(</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span>
                                <span class="w">BadEndpoint()).ad</span><span class="c">dCallback(</span><span class="w">r</span><span class="c">esult</span><span class="pc">.</span><span class="c">append)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span><span class="pc">r</span><span class="c">esult</span><span class="pc">[</span><span class="c">0</span><span class="pc">],</span> <span class="w">o</span><span class="c">rigCached</span><span class="pc">[1</span><span class="c">])</span>

        
        
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections</span><span class="pc">[</span><span class="w">k</span><span class="c">ey</span><span class="w">], [])</span>
        <span class="c">self.assertEqual(</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_timeouts, {})</span>


    <span class="c">def</span> <span class="w">test_putNotQuiescent</span><span class="c">(self):</span>
        
        <span class="w">pr</span><span class="pc">otoc</span><span class="c">ol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
        
        <span class="c">self.assertEqual(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span><span class="pc">, </span><span class="c">"</span><span class="w">QUIESCENT</span><span class="c">")</span>

        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="w">st</span><span class="pc">a</span><span class="c">te</span> <span class="pc">= </span><span class="c">"</span><span class="w">NOTQUIESCENT</span><span class="c">"</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection(("h</span><span class="c">ttp</span><span class="w">"</span><span class="pc">,</span> <span class="w">b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com</span><span class="pc">",</span> <span class="w">8</span><span class="c">0</span><span class="pc">),</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">)</span>
        <span class="w">e</span><span class="pc">xc</span><span class="w">, =</span> <span class="c">self.</span><span class="w">f</span><span class="pc">lushL</span><span class="c">oggedErrors(</span><span class="w">R</span><span class="pc">u</span><span class="c">ntimeError)</span>
        <span class="c">self.assertEqual(</span>
            <span class="w">e</span><span class="pc">x</span><span class="c">c.</span><span class="pc">v</span><span class="c">alue</span><span class="w">.a</span><span class="pc">r</span><span class="c">gs</span><span class="w">[</span><span class="c">0</span><span class="pc">],</span>
            <span class="w">"BUG:</span> <span class="w">Non-quiescent</span> <span class="w">pr</span><span class="c">otocol</span> <span class="w">added</span> <span class="w">t</span><span class="c">o</span> <span class="w">co</span><span class="pc">nn</span><span class="c">ection</span> <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="w">.</span><span class="pc">"</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span><span class="w">N</span><span class="pc">one</span><span class="c">,</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections.g</span><span class="c">et(</span>
                <span class="w">("h</span><span class="c">ttp</span><span class="pc">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="w">))</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_getUsesQuiescentCallback</span><span class="c">(self):</span>
        
        <span class="w">c</span><span class="c">lass</span> <span class="w">StringEndpoint</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
            <span class="c">def</span> <span class="w">co</span><span class="pc">nnect</span><span class="c">(self</span><span class="pc">,</span> <span class="w">f</span><span class="c">actory):</span>
                <span class="w">p</span> <span class="c">=</span> <span class="w">f</span><span class="c">actory.buildProtocol(None)</span>
                <span class="w">p</span><span class="pc">.m</span><span class="c">akeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="w">s</span><span class="pc">u</span><span class="c">cceed(</span><span class="w">p</span><span class="c">)</span>

        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">HTTPConnectionPool</span><span class="pc">(s</span><span class="c">elf</span><span class="pc">.</span><span class="w">fakeReactor</span><span class="c">,</span> <span class="w">T</span><span class="c">rue)</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">retryAutomatically</span> <span class="pc">=</span> <span class="pc">F</span><span class="c">alse</span>
        <span class="w">res</span><span class="pc">u</span><span class="c">lt</span> <span class="pc">= </span><span class="c">[]</span>
        <span class="w">k</span><span class="pc">e</span><span class="c">y</span> <span class="w">= "a</span> <span class="w">k</span><span class="c">ey</span><span class="w">"</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">getConnection</span><span class="c">(</span>
            <span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">StringEndpoint()).ad</span><span class="pc">dC</span><span class="c">allback(</span>
            <span class="pc">res</span><span class="c">ult</span><span class="pc">.</span><span class="c">append)</span>
        <span class="w">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">[</span><span class="c">0]</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">as</span><span class="pc">sertIs</span><span class="c">Instance(</span><span class="w">p</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">HTTP11ClientProtocol</span><span class="pc">)</span>

        
        
        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="w">_state</span> <span class="w">= </span><span class="pc">"</span><span class="w">QUIESCENT</span><span class="c">"</span>
        <span class="w">p</span><span class="c">rotocol.</span><span class="w">_quiescentCallback</span><span class="c">(</span><span class="w">p</span><span class="c">rotocol)</span>

        
        
        
        <span class="w">result2</span> <span class="w">=</span><span class="pc"> []</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">getConnection</span><span class="pc">(</span>
            <span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">StringEndpoint()).ad</span><span class="pc">dC</span><span class="c">allback(</span>
            <span class="pc">r</span><span class="c">esult2</span><span class="pc">.</span><span class="c">append)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="pc">r</span><span class="c">esult2</span><span class="w">[</span><span class="c">0</span><span class="pc">],</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_closeCachedConnections</span><span class="c">(self):</span>
        
        <span class="w">persistent</span> <span class="pc">= </span><span class="c">[]</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">addProtocol</span><span class="c">(</span><span class="w">sc</span><span class="c">heme</span><span class="pc">,</span> <span class="c">host,</span> <span class="c">port):</span>
            <span class="pc">p</span> <span class="pc">=</span> <span class="w">HTTP11ClientProtocol</span><span class="c">()</span>
            <span class="pc">p</span><span class="c">.</span><span class="w">m</span><span class="c">akeConnection(</span><span class="w">S</span><span class="c">tringTransport())</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection((sc</span><span class="c">heme,</span> <span class="w">h</span><span class="c">ost,</span> <span class="c">port</span><span class="pc">),</span> <span class="w">p</span><span class="c">)</span>
            <span class="w">pe</span><span class="c">rsistent.</span><span class="w">a</span><span class="pc">p</span><span class="c">pend(</span><span class="pc">p)</span>
        <span class="w">a</span><span class="pc">ddP</span><span class="c">rotocol</span><span class="w">(</span><span class="pc">"</span><span class="w">h</span><span class="pc">t</span><span class="c">tp</span><span class="w">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"</span><span class="pc">e</span><span class="c">xample.com</span><span class="pc">",</span> <span class="w">8</span><span class="c">0)</span>
        <span class="w">a</span><span class="c">ddProtocol</span><span class="w">(</span><span class="pc">"h</span><span class="c">ttp</span><span class="pc">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"</span><span class="w">www2.</span><span class="pc">e</span><span class="c">xample.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">)</span>
        <span class="w">doneDeferred</span> <span class="c">=</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">closeCachedConnections</span><span class="pc">()</span>

        
        <span class="w">f</span><span class="c">or</span> <span class="w">p</span> <span class="pc">i</span><span class="c">n</span> <span class="w">persistent</span><span class="pc">:</span>
            <span class="c">self.assertEqual(</span><span class="w">p</span><span class="c">.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">d</span><span class="pc">i</span><span class="c">sconnecting</span><span class="pc">,</span> <span class="pc">T</span><span class="c">rue)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections, {})</span>
        
        <span class="w">f</span><span class="pc">or</span> <span class="w">dc</span> <span class="pc">i</span><span class="c">n</span> <span class="c">self.</span><span class="w">fakeReactor</span><span class="pc">.</span><span class="w">getDelayedCalls</span><span class="pc">()</span><span class="c">:</span>
            <span class="c">self.assertEqual(</span><span class="pc">d</span><span class="c">c.</span><span class="w">cancelled</span><span class="pc">,</span> <span class="w">T</span><span class="c">rue)</span>
        <span class="c">self.assertEqual(self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_timeouts, {</span><span class="c">})</span>

        
        <span class="w">r</span><span class="pc">es</span><span class="c">ult</span> <span class="w">=</span><span class="pc"> </span><span class="c">[]</span>
        <span class="w">doneDeferred</span><span class="pc">.a</span><span class="c">ddCallback(</span><span class="w">r</span><span class="c">esult</span><span class="pc">.</span><span class="c">append)</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="c">esult</span><span class="w">,</span><span class="pc"> []</span><span class="c">)</span>
        <span class="w">persistent[</span><span class="c">0].</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectionLost(</span><span class="pc">F</span><span class="c">ailure(</span><span class="w">C</span><span class="c">onnectionDone</span><span class="pc">()))</span>
        <span class="c">self.assertEqual(</span><span class="pc">r</span><span class="c">esult</span><span class="w">,</span><span class="pc"> []</span><span class="c">)</span>
        <span class="w">p</span><span class="c">ersistent</span><span class="pc">[1].</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectionLost(</span><span class="w">F</span><span class="c">ailure(</span><span class="w">C</span><span class="c">onnectionDone()))</span>
        <span class="c">self.assertEqual(</span><span class="pc">r</span><span class="c">esult</span><span class="pc">,</span><span class="c"> [</span><span class="w">N</span><span class="c">one</span><span class="pc">]</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_cancelGetConnectionCancelsEndpointConnect</span><span class="c">(self):</span>
        
        <span class="c">self.assertEqual(self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_connections, {})</span>
        <span class="w">connectionResult</span> <span class="pc">=</span> <span class="w">D</span><span class="c">eferred()</span>

        <span class="pc">c</span><span class="c">lass</span> <span class="w">Endpoint</span><span class="pc">:</span>
            <span class="c">def</span> <span class="w">c</span><span class="pc">onnect</span><span class="c">(self</span><span class="pc">,</span> <span class="w">f</span><span class="pc">ac</span><span class="c">tory):</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="c">onnectionResult</span>

        <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection</span><span class="c">(</span><span class="w">12</span><span class="pc">345</span><span class="c">,</span> <span class="w">E</span><span class="c">ndpoint</span><span class="w">(</span><span class="c">))</span>
        <span class="pc">d</span><span class="c">.</span><span class="w">c</span><span class="pc">an</span><span class="c">cel()</span>
        <span class="c">self.assertEqual(self.</span><span class="w">failureResultOf</span><span class="pc">(c</span><span class="c">onnectionResult</span><span class="w">)</span><span class="pc">.</span><span class="w">ty</span><span class="c">pe</span><span class="pc">,</span>
                         <span class="w">CancelledError</span><span class="c">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">AgentTestsMixin</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
    
    <span class="c">def</span> <span class="w">test_interface</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertT</span><span class="c">rue(</span><span class="w">v</span><span class="c">erifyObject(</span><span class="w">IAgent</span><span class="c">,</span> <span class="c">self.</span><span class="w">makeAgent(</span><span class="pc">)))</span>



<span class="w">@</span><span class="c">implementer(</span><span class="w">IAgentEndpointFactory</span><span class="c">)</span>
<span class="c">class</span> <span class="w">StubEndpointFactory</span><span class="c">(object):</span>
    
    <span class="c">def</span> <span class="w">endpointForURI</span><span class="c">(self</span><span class="pc">,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">(</span><span class="w">u</span><span class="pc">ri.</span><span class="w">s</span><span class="c">cheme,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">.</span><span class="w">h</span><span class="c">ost,</span> <span class="w">u</span><span class="c">ri.port</span><span class="pc">)</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">AgentTests</span><span class="c">(</span><span class="w">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="pc">,</span> <span class="w">AgentTestsMixin</span><span class="c">):</span>
    
    <span class="pc">d</span><span class="c">ef</span> <span class="w">makeAgent</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent.</span><span class="w">Agent</span><span class="c">(self.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">s</span><span class="c">etUp(self):</span>
        
        <span class="c">self.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">m</span><span class="c">akeAgent</span><span class="pc">(</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_defaultPool</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">A</span><span class="c">gent</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="c">eactor)</span>
        <span class="c">self.</span><span class="w">as</span><span class="pc">sertIs</span><span class="c">Instance(</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_pool</span><span class="c">,</span> <span class="w">HTTPConnectionPool</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">ag</span><span class="c">ent.</span><span class="pc">_</span><span class="c">pool.</span><span class="w">persistent</span><span class="pc">,</span> <span class="pc">F</span><span class="c">alse)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_r</span><span class="c">eactor,</span> <span class="w">ag</span><span class="c">ent._pool</span><span class="pc">.</span><span class="w">_r</span><span class="c">eactor</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_persistent</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="pc">H</span><span class="c">TTPConnectionPool</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="pc">e</span><span class="c">actor)</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="c">(self.</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">=</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">)</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span> <span class="pc">=</span> <span class="c">lambda</span> <span class="w">*a</span><span class="pc">r</span><span class="c">gs</span><span class="pc">:</span> <span class="c">self</span>
        <span class="w">ag</span><span class="c">ent</span><span class="w">.req</span><span class="c">uest(</span><span class="pc">b"</span><span class="c">GET</span><span class="pc">",</span> <span class="c">b"</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://</span><span class="pc">1</span><span class="c">27.0.0.1</span><span class="pc">")</span>
        <span class="c">self.assertEqual(self.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">[</span><span class="pc">0][0].</span><span class="w">persistent</span><span class="c">,</span> <span class="w">T</span><span class="c">rue)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_nonPersistent</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">HTTPConnectionPool</span><span class="pc">(</span><span class="c">self.</span><span class="w">re</span><span class="pc">ac</span><span class="c">tor</span><span class="pc">,</span> <span class="w">p</span><span class="pc">e</span><span class="c">rsistent=False)</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">Agent</span><span class="c">(self.</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">=</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">)</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ambda</span> <span class="w">*a</span><span class="pc">r</span><span class="c">gs</span><span class="w">:</span> <span class="c">self</span>
        <span class="w">ag</span><span class="c">ent</span><span class="w">.req</span><span class="c">uest</span><span class="pc">(b"G</span><span class="c">ET</span><span class="pc">",</span> <span class="c">b"</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://</span><span class="w">1</span><span class="c">27.0.0.1</span><span class="pc">")</span>
        <span class="c">self.assertEqual(self.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">[</span><span class="pc">0][0].</span><span class="w">persistent</span><span class="c">,</span> <span class="w">F</span><span class="c">alse)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_connectUsesConnectionPool</span><span class="c">(self):</span>
        
        <span class="w">en</span><span class="c">dpoint</span> <span class="c">=</span> <span class="w">DummyEndpoint</span><span class="c">()</span>
        <span class="w">c</span><span class="pc">la</span><span class="c">ss</span> <span class="w">MyAgent</span><span class="c">(</span><span class="w">cl</span><span class="c">ient</span><span class="pc">.</span><span class="w">Agent</span><span class="c">):</span>
            <span class="c">def</span> <span class="w">_getEndpoint</span><span class="c">(</span><span class="w">th</span><span class="c">is</span><span class="pc">,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span><span class="c">:</span>
                <span class="pc">s</span><span class="c">elf.assertEqual</span><span class="pc">((</span><span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">.</span><span class="w">sc</span><span class="c">heme,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i.</span><span class="w">h</span><span class="c">ost,</span> <span class="w">u</span><span class="c">ri.port</span><span class="w">)</span><span class="pc">,</span>
                                 <span class="w">(</span><span class="pc">b"</span><span class="w">h</span><span class="c">ttp</span><span class="pc">"</span><span class="c">,</span> <span class="c">b"</span><span class="pc">f</span><span class="c">oo</span><span class="pc">"</span><span class="c">,</span> <span class="w">8</span><span class="pc">0))</span>
                <span class="pc">ret</span><span class="c">urn</span> <span class="w">e</span><span class="pc">n</span><span class="c">dpoint</span>

        <span class="w">c</span><span class="c">lass</span> <span class="w">DummyPool</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
            <span class="w">con</span><span class="pc">n</span><span class="c">ected</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>
            <span class="w">persistent</span> <span class="c">=</span> <span class="c">False</span>
            <span class="c">def</span> <span class="w">getConnection</span><span class="c">(</span><span class="w">th</span><span class="c">is</span><span class="pc">,</span> <span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">ep</span><span class="pc">)</span><span class="c">:</span>
                <span class="w">th</span><span class="c">is.</span><span class="w">connecte</span><span class="c">d</span> <span class="c">=</span> <span class="c">True</span>
                <span class="c">self.</span><span class="pc">assertE</span><span class="c">qual(</span><span class="w">ep</span><span class="c">,</span> <span class="w">en</span><span class="pc">dp</span><span class="c">oint</span><span class="pc">)</span>
                
                
                <span class="c">self.assertEqual(</span><span class="w">k</span><span class="pc">e</span><span class="c">y</span><span class="w">, </span><span class="pc">(</span><span class="w">b</span><span class="pc">"</span><span class="w">h</span><span class="pc">t</span><span class="c">tp</span><span class="pc">"</span><span class="c">,</span> <span class="w">b</span><span class="c">"foo</span><span class="pc">",</span> <span class="w">8</span><span class="pc">0))</span>
                <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.succeed(</span><span class="w">StubHTTPProtocol</span><span class="pc">(</span><span class="c">))</span>

        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="pc">=</span> <span class="w">DummyPool</span><span class="pc">()</span>
        <span class="w">a</span><span class="pc">g</span><span class="c">ent</span> <span class="c">=</span> <span class="w">MyAgent</span><span class="pc">(s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">=</span><span class="w">po</span><span class="pc">o</span><span class="c">l)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">,</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent</span><span class="pc">.</span><span class="w">_pool</span><span class="c">)</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders()</span>
        <span class="w">h</span><span class="pc">e</span><span class="c">aders.</span><span class="w">addRawHeader</span><span class="c">(b</span><span class="pc">"</span><span class="w">h</span><span class="pc">o</span><span class="c">st",</span> <span class="c">b"</span><span class="w">f</span><span class="c">oo</span><span class="pc">")</span>
        <span class="w">bodyProducer</span> <span class="c">=</span> <span class="w">o</span><span class="c">bject()</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="pc">r</span><span class="c">equest(b</span><span class="pc">'</span><span class="c">GET</span><span class="pc">',</span> <span class="c">b'</span><span class="pc">h</span><span class="c">ttp://</span><span class="pc">f</span><span class="c">oo</span><span class="w">/',</span>
                      <span class="w">b</span><span class="pc">odyP</span><span class="c">roducer</span><span class="pc">=bo</span><span class="c">dyProducer</span><span class="w">,</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders=</span><span class="w">h</span><span class="pc">e</span><span class="c">aders)</span>
        <span class="c">self.assertEqual(</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_pool.conn</span><span class="pc">ecte</span><span class="c">d</span><span class="pc">,</span> <span class="w">T</span><span class="c">rue)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_unsupportedScheme</span><span class="c">(self):</span>
        
        <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="c">self.</span><span class="pc">assertF</span><span class="c">ailure(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">(</span><span class="c">b'</span><span class="pc">G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">mailto:a</span><span class="pc">l</span><span class="c">ice</span><span class="w">@</span><span class="c">example.com</span><span class="w">')</span><span class="pc">,</span>
            <span class="w">SchemeNotSupported</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_connectionFailed</span><span class="c">(self):</span>
        
        <span class="w">resu</span><span class="pc">lt</span> <span class="c">=</span> <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="pc">r</span><span class="c">equest(b'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://</span><span class="pc">f</span><span class="c">oo</span><span class="w">/')</span>
        
        <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="w">p</span><span class="c">ort</span><span class="pc">,</span> <span class="w">f</span><span class="c">actory</span> <span class="c">=</span> <span class="c">self.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor.</span><span class="w">tcpClients.p</span><span class="pc">op</span><span class="w">()[:3</span><span class="pc">]</span>
        <span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">clientConnectionFailed</span><span class="c">(</span><span class="w">N</span><span class="c">one</span><span class="pc">,</span> <span class="w">F</span><span class="pc">ai</span><span class="c">lure(</span><span class="w">ConnectionRefusedError(</span><span class="pc">)))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">ailure(</span><span class="w">resu</span><span class="pc">lt</span><span class="c">,</span> <span class="w">C</span><span class="c">onnectionRefusedError</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_connectHTTP</span><span class="c">(self):</span>
        
        <span class="w">expectedHost</span> <span class="c">=</span> <span class="w">b</span><span class="pc">'</span><span class="w">e</span><span class="pc">xa</span><span class="c">mple.com</span><span class="pc">'</span>
        <span class="w">expectedPort</span> <span class="c">=</span> <span class="w">12</span><span class="pc">34</span>
        <span class="w">e</span><span class="pc">n</span><span class="c">dpoint</span> <span class="c">=</span> <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span><span class="c">(</span><span class="w">URI.fromBytes</span><span class="pc">(</span>
            <span class="pc">b</span><span class="c">'</span><span class="pc">h</span><span class="c">ttp</span><span class="w">://' +</span> <span class="w">e</span><span class="pc">xp</span><span class="c">ectedHost</span> <span class="w">+</span> <span class="c">b</span><span class="w">":" +</span> <span class="w">intToBytes(e</span><span class="pc">xpectedP</span><span class="c">ort</span><span class="w">))</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">end</span><span class="pc">p</span><span class="c">oint.</span><span class="w">_host,</span><span class="pc"> "</span><span class="w">e</span><span class="pc">xa</span><span class="c">mple.com")</span>
        <span class="c">self.assertEqual(</span><span class="w">en</span><span class="pc">dp</span><span class="c">oint.</span><span class="w">_port</span><span class="pc">,</span> <span class="pc">e</span><span class="c">xpectedPort)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">sInstance(</span><span class="w">en</span><span class="pc">dpoint,</span> <span class="w">TCP4ClientEndpoint</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_nonDecodableURI</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="pc">r</span><span class="c">i</span> <span class="c">=</span> <span class="w">URI</span><span class="pc">.</span><span class="w">fromBytes</span><span class="c">(b</span><span class="pc">"h</span><span class="c">ttp://example.com</span><span class="w">:8</span><span class="pc">0</span><span class="w">"</span><span class="pc">)</span>
        <span class="w">u</span><span class="pc">ri.</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span> <span class="c">=</span> <span class="w">u</span><span class="pc">'\</span><span class="w">u2603.</span><span class="pc">c</span><span class="c">om</span><span class="w">'.e</span><span class="pc">n</span><span class="c">code('</span><span class="w">utf8</span><span class="c">')</span>

        <span class="w">w</span><span class="c">ith</span> <span class="c">self.</span><span class="pc">assertR</span><span class="c">aises(ValueError</span><span class="pc">)</span> <span class="w">a</span><span class="c">s</span> <span class="w">e</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span><span class="c">(</span><span class="w">u</span><span class="pc">ri</span><span class="c">)</span>

        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">e</span><span class="c">.</span><span class="w">ex</span><span class="pc">c</span><span class="c">eption</span><span class="pc">.a</span><span class="c">rgs</span><span class="pc">[</span><span class="c">0</span><span class="pc">],</span>
                         <span class="w">(</span><span class="pc">"</span><span class="w">T</span><span class="pc">he</span> <span class="w">h</span><span class="pc">o</span><span class="c">st</span> <span class="w">o</span><span class="c">f</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">provided</span> <span class="w">URI</span> <span class="w">({reprout}</span><span class="pc">)</span> <span class="w">contains</span> <span class="w">"</span>
                          <span class="c">"</span><span class="w">non-ASCII</span> <span class="w">octets,</span> <span class="w">i</span><span class="c">t</span> <span class="w">sh</span><span class="c">ould</span> <span class="pc">b</span><span class="c">e</span> <span class="pc">A</span><span class="c">SCII</span> <span class="c">"</span>
                          <span class="c">"</span><span class="w">decodable.").f</span><span class="pc">o</span><span class="c">rmat</span><span class="pc">(r</span><span class="c">eprout</span><span class="w">=re</span><span class="pc">pr</span><span class="c">(</span><span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">.</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="w">))</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_connectHTTPSCustomContextFactory</span><span class="c">(self):</span>
        
        <span class="w">expectedHost</span> <span class="c">=</span> <span class="w">b</span><span class="pc">'</span><span class="w">e</span><span class="c">xample.</span><span class="pc">o</span><span class="c">rg</span><span class="w">'</span>
        <span class="w">expectedPort</span> <span class="c">=</span> <span class="w">20443</span>
        <span class="w">expectedContext</span> <span class="c">=</span> <span class="w">o</span><span class="pc">b</span><span class="c">ject()</span>

        <span class="w">contextArgs</span> <span class="w">=</span><span class="pc"> []</span>
        <span class="pc">c</span><span class="c">lass</span> <span class="w">StubWebContextFactory</span><span class="c">(object):</span>
            <span class="c">def</span> <span class="w">getContext</span><span class="c">(self</span><span class="pc">,</span> <span class="w">h</span><span class="pc">ostn</span><span class="c">ame,</span> <span class="c">port):</span>
                <span class="w">c</span><span class="pc">ontextA</span><span class="c">rgs.append</span><span class="pc">((</span><span class="w">h</span><span class="pc">ostn</span><span class="c">ame,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">))</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="pc">xpectedC</span><span class="c">ontext</span>

        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">Agent</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">S</span><span class="pc">tu</span><span class="c">bWebContextFactory</span><span class="w">(</span><span class="pc">)</span><span class="c">)</span>
        <span class="w">en</span><span class="pc">d</span><span class="c">point</span> <span class="pc">=</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent.</span><span class="w">_getEndpoint</span><span class="c">(</span><span class="w">URI</span><span class="pc">.</span><span class="w">fromBytes</span><span class="pc">(</span>
            <span class="c">b</span><span class="pc">'</span><span class="w">https://' +</span> <span class="w">expectedHost</span> <span class="w">+</span> <span class="pc">b</span><span class="w">":" +</span> <span class="w">intToBytes</span><span class="pc">(</span><span class="w">expectedPort))</span><span class="pc">)</span>
        <span class="w">co</span><span class="pc">n</span><span class="c">textFactory</span> <span class="pc">=</span> <span class="w">e</span><span class="pc">n</span><span class="c">dpoint.</span><span class="w">_sslContextFactory</span>
        <span class="w">cont</span><span class="pc">ext</span> <span class="c">=</span> <span class="w">c</span><span class="pc">ont</span><span class="c">extFactory.</span><span class="w">getContext</span><span class="c">()</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">cont</span><span class="pc">ext,</span> <span class="w">expectedContext</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">contextArgs, [(e</span><span class="pc">xpectedH</span><span class="c">ost</span><span class="w">,</span> <span class="w">e</span><span class="pc">xpectedP</span><span class="c">ort</span><span class="w">)</span><span class="pc">]</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_hostProvided</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span> <span class="pc">=</span> <span class="w">l</span><span class="c">ambda</span> <span class="w">*a</span><span class="c">rgs</span><span class="w">:</span> <span class="c">self</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">req</span><span class="c">uest(</span>
            <span class="w">b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="pc">/f</span><span class="c">oo</span><span class="w">?b</span><span class="pc">a</span><span class="c">r</span><span class="pc">'</span><span class="c">)</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">.</span><span class="w">getRawHeaders</span><span class="pc">(</span><span class="c">b</span><span class="pc">'</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="w">'), [</span><span class="pc">b</span><span class="c">'example.com</span><span class="w">'</span><span class="pc">]</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_hostOverride</span><span class="c">(self):</span>
        
        <span class="w">h</span><span class="c">eaders</span> <span class="c">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="c">eaders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="c">b'</span><span class="pc">b</span><span class="c">ar</span><span class="w">']</span><span class="pc">,</span> <span class="c">b'</span><span class="w">ho</span><span class="c">st</span><span class="w">':</span><span class="pc"> [b</span><span class="c">'</span><span class="w">quux']})</span>
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span> <span class="pc">=</span> <span class="w">l</span><span class="c">ambda</span> <span class="w">*a</span><span class="pc">r</span><span class="c">gs</span><span class="w">:</span> <span class="c">self</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent</span><span class="pc">.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">(</span>
            <span class="c">b'GET</span><span class="pc">',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com</span><span class="pc">/f</span><span class="c">oo</span><span class="w">?b</span><span class="pc">a</span><span class="c">r</span><span class="w">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">)</span>

        <span class="pc">req,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.po</span><span class="pc">p()</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders.</span><span class="w">getRawHeaders</span><span class="pc">(</span><span class="c">b</span><span class="pc">'</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="w">'), [</span><span class="c">b'</span><span class="w">quux</span><span class="pc">']</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_headersUnmodified</span><span class="c">(self):</span>
        
        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="c">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="c">eaders()</span>
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span> <span class="c">=</span> <span class="w">l</span><span class="c">ambda</span> <span class="w">*a</span><span class="pc">r</span><span class="c">gs</span><span class="w">:</span> <span class="c">self</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest(</span>
            <span class="pc">b</span><span class="c">'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="pc">/f</span><span class="c">oo</span><span class="pc">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">)</span>

        <span class="w">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span>

        
        <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">req</span><span class="pc">uests</span><span class="c">),</span> <span class="pc">1</span><span class="c">)</span>
        
        <span class="c">self.assertEqual(</span><span class="w">h</span><span class="c">eaders</span><span class="pc">,</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="c">eaders</span><span class="pc">())</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_hostValueStandardHTTP</span><span class="c">(self):</span>
        
        <span class="c">self.assertEqual(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_computeHostValue</span><span class="pc">(b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp</span><span class="pc">'</span><span class="c">,</span> <span class="c">b'</span><span class="w">e</span><span class="c">xample.com',</span> <span class="w">8</span><span class="c">0),</span>
            <span class="c">b'example.com</span><span class="pc">')</span>


    <span class="c">def</span> <span class="w">test_hostValueNonStandardHTTP</span><span class="c">(self):</span>
        
        <span class="c">self.assertEqual(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_</span><span class="c">computeHostValue(b</span><span class="pc">'h</span><span class="c">ttp</span><span class="pc">'</span><span class="c">,</span> <span class="c">b'example.com',</span> <span class="w">54321</span><span class="pc">)</span><span class="c">,</span>
            <span class="pc">b</span><span class="c">'example.com</span><span class="pc">:</span><span class="w">5</span><span class="c">4321</span><span class="w">'</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_hostValueStandardHTTPS</span><span class="c">(self):</span>
        
        <span class="c">self.assertEqual(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="pc">_</span><span class="c">computeHostValue(b'</span><span class="w">https</span><span class="c">',</span> <span class="c">b'example.com',</span> <span class="w">443</span><span class="pc">)</span><span class="c">,</span>
            <span class="c">b'example.com</span><span class="pc">')</span>


    <span class="c">def</span> <span class="w">test_hostValueNonStandardHTTPS</span><span class="c">(self):</span>
        
        <span class="c">self.assertEqual(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_</span><span class="c">computeHostValue(b</span><span class="pc">'</span><span class="w">h</span><span class="pc">ttps'</span><span class="c">,</span> <span class="c">b'example.com',</span> <span class="w">54321</span><span class="pc">)</span><span class="c">,</span>
            <span class="pc">b</span><span class="c">'example.com</span><span class="pc">:</span><span class="w">5</span><span class="c">4321</span><span class="w">'</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_request</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_getEndpoint</span> <span class="pc">=</span> <span class="w">l</span><span class="c">ambda</span> <span class="w">*a</span><span class="c">rgs</span><span class="pc">:</span> <span class="c">self</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="w">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="c">eaders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="c">b'</span><span class="pc">b</span><span class="c">ar</span><span class="w">']})</span>
        
        
        <span class="w">b</span><span class="pc">o</span><span class="c">dy</span> <span class="pc">=</span> <span class="w">o</span><span class="c">bject()</span>
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest</span><span class="pc">(</span>
            <span class="c">b'GET</span><span class="pc">'</span><span class="c">,</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com</span><span class="w">:1</span><span class="pc">234/</span><span class="w">f</span><span class="c">oo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="w">'</span><span class="pc">,</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="w">,</span> <span class="w">b</span><span class="pc">o</span><span class="c">dy</span><span class="pc">)</span>

        <span class="w">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="c">self.protocol</span>

        
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">req</span><span class="pc">uests</span><span class="c">),</span> <span class="pc">1</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">o</span><span class="c">p</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">req</span><span class="pc">,</span> <span class="w">R</span><span class="c">equest</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">m</span><span class="pc">et</span><span class="c">hod,</span> <span class="c">b'</span><span class="pc">G</span><span class="c">ET')</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(req.</span><span class="w">u</span><span class="c">ri,</span> <span class="c">b</span><span class="pc">'/</span><span class="c">foo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="pc">'</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span>
            <span class="pc">r</span><span class="c">eq.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">,</span>
            <span class="w">http_headers.H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="pc">b</span><span class="c">'</span><span class="pc">bar</span><span class="w">'</span><span class="pc">],</span>
                                  <span class="pc">b</span><span class="c">'</span><span class="w">ho</span><span class="c">st</span><span class="w">':</span><span class="pc"> [b</span><span class="c">'</span><span class="pc">e</span><span class="c">xample.com</span><span class="pc">:</span><span class="w">1</span><span class="pc">234</span><span class="w">']}))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="pc">r</span><span class="c">eq.</span><span class="w">bodyProducer</span><span class="pc">,</span> <span class="w">b</span><span class="pc">ody</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_connectTimeout</span><span class="c">(self):</span>
        
        <span class="w">a</span><span class="pc">g</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">re</span><span class="pc">ac</span><span class="c">tor</span><span class="pc">,</span> <span class="w">connectTimeout</span><span class="c">=</span><span class="w">5</span><span class="pc">)</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">(</span><span class="c">b'</span><span class="pc">G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://</span><span class="pc">f</span><span class="c">oo</span><span class="w">/')</span>
        <span class="w">ti</span><span class="pc">meo</span><span class="c">ut</span> <span class="c">=</span> <span class="w">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">tcpClients.</span><span class="pc">pop</span><span class="w">()[</span><span class="pc">3]</span>
        <span class="c">self.assertEqual(</span><span class="w">5</span><span class="pc">,</span> <span class="w">t</span><span class="pc">i</span><span class="c">meout</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_connectSSLTimeout</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">,</span> <span class="c">self.</span><span class="w">StubPolicy(</span><span class="pc">),</span> <span class="w">connectTimeout</span><span class="pc">=</span><span class="w">5</span><span class="pc">)</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="w">req</span><span class="c">uest</span><span class="pc">(b</span><span class="c">'GET',</span> <span class="c">b'</span><span class="w">https:</span><span class="pc">/</span><span class="c">/</span><span class="pc">f</span><span class="c">oo</span><span class="w">/')</span>
        <span class="w">ti</span><span class="c">meout</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">sslClients.p</span><span class="pc">op</span><span class="w">()[4</span><span class="pc">]</span>
        <span class="c">self.assertEqual(</span><span class="w">5</span><span class="c">,</span> <span class="w">t</span><span class="pc">i</span><span class="c">meout</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_bindAddress</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor</span><span class="pc">,</span> <span class="w">b</span><span class="pc">i</span><span class="c">ndAddress</span><span class="w">=</span><span class="pc">'</span><span class="w">192</span><span class="pc">.</span><span class="w">168</span><span class="pc">.</span><span class="w">0</span><span class="c">.1</span><span class="w">'</span><span class="pc">)</span>
        <span class="w">ag</span><span class="c">ent</span><span class="pc">.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">(b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET</span><span class="pc">'</span><span class="c">,</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://</span><span class="pc">f</span><span class="c">oo</span><span class="w">/')</span>
        <span class="w">ad</span><span class="pc">dr</span><span class="c">ess</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">tcpClients</span><span class="pc">.</span><span class="w">p</span><span class="pc">op</span><span class="w">()[</span><span class="pc">4]</span>
        <span class="c">self.assertEqual</span><span class="w">('1</span><span class="pc">9</span><span class="c">2.</span><span class="pc">16</span><span class="c">8.</span><span class="w">0</span><span class="c">.1</span><span class="pc">'</span><span class="c">,</span> <span class="w">a</span><span class="pc">d</span><span class="c">dress</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_bindAddressSSL</span><span class="c">(self):</span>
        
        <span class="w">a</span><span class="pc">g</span><span class="c">ent</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="c">self.</span><span class="w">StubPolicy(</span><span class="pc">),</span>
                             <span class="w">b</span><span class="pc">i</span><span class="c">ndAddress</span><span class="w">=</span><span class="pc">'</span><span class="w">1</span><span class="pc">9</span><span class="c">2</span><span class="pc">.</span><span class="c">168.</span><span class="pc">0</span><span class="c">.1</span><span class="w">'</span><span class="pc">)</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="w">req</span><span class="c">uest(</span><span class="pc">b</span><span class="c">'</span><span class="w">G</span><span class="c">ET</span><span class="pc">'</span><span class="c">,</span> <span class="c">b'</span><span class="w">https:</span><span class="pc">/</span><span class="c">/</span><span class="pc">f</span><span class="c">oo</span><span class="w">/')</span>
        <span class="w">ad</span><span class="pc">dr</span><span class="c">ess</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">sslClients</span><span class="pc">.</span><span class="w">p</span><span class="pc">op</span><span class="w">()[5</span><span class="pc">]</span>
        <span class="c">self.assertEqual</span><span class="w">('1</span><span class="pc">9</span><span class="c">2.</span><span class="pc">16</span><span class="c">8.</span><span class="w">0</span><span class="c">.1</span><span class="pc">'</span><span class="c">,</span> <span class="w">a</span><span class="pc">d</span><span class="c">dress</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_responseIncludesRequest</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="pc">ri</span> <span class="c">=</span> <span class="w">b</span><span class="c">'</span><span class="w">h</span><span class="c">ttp</span><span class="pc">:</span><span class="c">//example.com</span><span class="w">/'</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">)</span>
        <span class="pc">d</span> <span class="c">=</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest</span><span class="pc">(b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="w">u</span><span class="pc">ri)</span>

        
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">l</span><span class="c">en(self.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">req</span><span class="pc">uests),</span> <span class="pc">1</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.protocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.</span><span class="pc">p</span><span class="c">op</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertIs</span><span class="c">Instance(</span><span class="w">req</span><span class="pc">,</span> <span class="w">R</span><span class="c">equest</span><span class="pc">)</span>

        <span class="w">res</span><span class="pc">p</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Response</span><span class="pc">.</span><span class="w">_construct</span><span class="c">(</span>
            <span class="w">(</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="pc">1,</span> <span class="pc">1</span><span class="c">),</span>
            <span class="w">2</span><span class="pc">0</span><span class="c">0</span><span class="pc">,</span>
            <span class="c">b'</span><span class="w">O</span><span class="c">K',</span>
            <span class="w">cl</span><span class="c">ient.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({}),</span>
            <span class="w">N</span><span class="c">one</span><span class="w">,</span>
            <span class="w">r</span><span class="pc">eq)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="w">res</span><span class="pc">p</span><span class="c">)</span>

        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">s</span><span class="c">uccessResultOf(</span><span class="pc">d)</span>
        <span class="c">self.assertEqual(</span>
            <span class="w">(r</span><span class="pc">esp</span><span class="c">onse</span><span class="w">.r</span><span class="c">equest.</span><span class="w">m</span><span class="c">ethod</span><span class="pc">,</span> <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span><span class="pc">.</span><span class="c">request.</span><span class="w">absoluteURI</span><span class="pc">,</span>
             <span class="w">r</span><span class="pc">es</span><span class="c">ponse.request.</span><span class="pc">h</span><span class="c">eaders</span><span class="pc">),</span>
            <span class="pc">(</span><span class="w">req</span><span class="c">.</span><span class="w">m</span><span class="pc">et</span><span class="c">hod,</span> <span class="w">req</span><span class="c">.</span><span class="w">a</span><span class="pc">b</span><span class="c">soluteURI</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">h</span><span class="c">eaders</span><span class="w">)</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_requestAbsoluteURI</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="c">ri</span> <span class="c">=</span> <span class="w">b</span><span class="pc">'h</span><span class="c">ttp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="w">;1</span><span class="pc">234</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="w">=</span> <span class="pc">sel</span><span class="c">f.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="w">s</span><span class="c">elf.</span><span class="w">rea</span><span class="pc">c</span><span class="c">tor)</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">(</span><span class="c">b'</span><span class="pc">G</span><span class="c">ET</span><span class="pc">'</span><span class="c">,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>

        
        <span class="c">self.assertEqual(</span><span class="w">l</span><span class="c">en(self.</span><span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="w">req</span><span class="pc">uests</span><span class="c">),</span> <span class="pc">1</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="c">op</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertIs</span><span class="c">Instance(</span><span class="w">req</span><span class="pc">,</span> <span class="w">R</span><span class="c">equest</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">assertEquals</span><span class="pc">(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">absoluteURI</span><span class="c">,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_requestMissingAbsoluteURI</span><span class="c">(self):</span>
        
        <span class="w">r</span><span class="pc">equ</span><span class="c">est</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="pc">R</span><span class="c">equest(b'</span><span class="w">FOO</span><span class="c">',</span> <span class="c">b</span><span class="w">'/',</span> <span class="w">cl</span><span class="c">ient.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="pc">(),</span> <span class="pc">N</span><span class="c">one)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="pc">r</span><span class="c">equest.</span><span class="pc">ab</span><span class="c">soluteURI</span><span class="pc">,</span> <span class="pc">N</span><span class="c">one)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_endpointFactory</span><span class="c">(self):</span>
        
        <span class="w">f</span><span class="pc">a</span><span class="c">ctory</span> <span class="c">=</span> <span class="w">StubEndpointFactory</span><span class="c">()</span>
        <span class="w">a</span><span class="pc">g</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="pc">.</span><span class="w">usingEndpointFactory</span><span class="c">(</span>
            <span class="w">N</span><span class="c">one,</span> <span class="w">endpointFactory</span><span class="pc">=</span><span class="w">f</span><span class="c">actory</span><span class="pc">)</span>
        <span class="w">u</span><span class="pc">ri</span> <span class="pc">=</span> <span class="w">URI</span><span class="pc">.</span><span class="w">fromBytes</span><span class="c">(</span><span class="pc">b</span><span class="c">'http://example.com</span><span class="w">/')</span>
        <span class="w">returnedEndpoint</span> <span class="c">=</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent.</span><span class="w">_getEndpoint</span><span class="c">(</span><span class="w">u</span><span class="pc">ri)</span>
        <span class="c">self.assertEqual(returnedEndpoint</span><span class="w">, </span><span class="pc">(b"h</span><span class="c">ttp</span><span class="pc">"</span><span class="c">,</span> <span class="pc">b"</span><span class="c">example.com",</span> <span class="w">8</span><span class="c">0</span><span class="pc">))</span>


    <span class="c">def</span> <span class="w">test_endpointFactoryDefaultPool</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="pc">.</span><span class="w">usingEndpointFactory</span><span class="c">(</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">rea</span><span class="pc">c</span><span class="c">tor</span><span class="pc">,</span> <span class="w">StubEndpointFactory</span><span class="pc">(</span><span class="c">))</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="pc">=</span> <span class="w">a</span><span class="c">gent.</span><span class="w">_pool</span>
        <span class="w">s</span><span class="c">elf.assertEqual</span><span class="pc">((</span><span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_</span><span class="pc">_c</span><span class="c">lass__</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">persistent</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_r</span><span class="c">eactor</span><span class="w">)</span><span class="pc">,</span>
                          <span class="pc">(</span><span class="w">HTTPConnectionPool</span><span class="c">,</span> <span class="w">F</span><span class="c">alse,</span> <span class="w">ag</span><span class="c">ent.</span><span class="w">_r</span><span class="c">eactor</span><span class="pc">))</span>


    <span class="c">def</span> <span class="w">test_endpointFactoryPool</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">o</span><span class="c">bject()</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="pc">.</span><span class="w">usingEndpointFactory</span><span class="c">(</span>
            <span class="c">self.</span><span class="w">r</span><span class="c">eactor,</span> <span class="w">StubEndpointFactory(</span><span class="pc">),</span> <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">(</span><span class="w">po</span><span class="pc">o</span><span class="c">l,</span> <span class="w">ag</span><span class="c">ent.</span><span class="w">_pool</span><span class="c">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">AgentHTTPSTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="c">):</span>
    
    <span class="pc">i</span><span class="c">f</span> <span class="w">ss</span><span class="c">l</span> <span class="pc">i</span><span class="c">s</span> <span class="c">None:</span>
        <span class="c">skip</span> <span class="c">= "</span><span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="w">n</span><span class="c">ot</span> <span class="w">present,</span> <span class="w">cannot</span> <span class="w">r</span><span class="pc">u</span><span class="c">n</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="w">tests</span><span class="pc">"</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">makeEndpoint</span><span class="c">(self</span><span class="pc">,</span> <span class="w">h</span><span class="c">ost</span><span class="pc">=</span><span class="w">b</span><span class="pc">'</span><span class="w">e</span><span class="c">xample.com',</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt=</span><span class="w">443)</span><span class="pc">:</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">Agent</span><span class="c">(self.</span><span class="w">Reactor())._getEndpoint</span><span class="pc">(</span>
            <span class="w">URI</span><span class="pc">.</span><span class="w">fromBytes</span><span class="c">(</span><span class="pc">b</span><span class="c">'</span><span class="w">https://' +</span> <span class="w">ho</span><span class="pc">st</span> <span class="w">+</span> <span class="pc">b</span><span class="w">":" +</span> <span class="w">intToBytes</span><span class="pc">(</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="w">) </span><span class="c">+</span> <span class="pc">b</span><span class="w">"/"))</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_endpointType</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">sInstance(self.</span><span class="w">makeEndpoint</span><span class="pc">()</span><span class="c">,</span> <span class="w">SSL4ClientEndpoint</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_hostArgumentIsRespected</span><span class="c">(self):</span>
        
        <span class="w">en</span><span class="c">dpoint</span> <span class="c">=</span> <span class="c">self.</span><span class="w">m</span><span class="pc">a</span><span class="c">keEndpoint</span><span class="pc">(</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">=b</span><span class="c">"</span><span class="w">e</span><span class="c">xample.com")</span>
        <span class="c">self.</span><span class="pc">assertE</span><span class="c">qual(</span><span class="w">en</span><span class="pc">dp</span><span class="c">oint.</span><span class="w">_host,</span><span class="pc"> </span><span class="c">"</span><span class="w">e</span><span class="c">xample.com")</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_portArgumentIsRespected</span><span class="c">(self):</span>
        
        <span class="w">expectedPort</span> <span class="c">=</span> <span class="w">4321</span>
        <span class="w">en</span><span class="pc">d</span><span class="c">point</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">m</span><span class="c">akeEndpoint</span><span class="pc">(p</span><span class="c">ort</span><span class="pc">=e</span><span class="c">xpectedPort</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">en</span><span class="pc">dp</span><span class="c">oint.</span><span class="w">_port</span><span class="c">,</span> <span class="pc">e</span><span class="c">xpectedPort)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_contextFactoryType</span><span class="c">(self):</span>
        
        <span class="w">en</span><span class="c">dpoint</span> <span class="c">=</span> <span class="c">self.</span><span class="w">m</span><span class="c">akeEndpoint</span><span class="pc">()</span>
        <span class="w">cont</span><span class="pc">ex</span><span class="c">tFactory</span> <span class="c">=</span> <span class="w">e</span><span class="pc">n</span><span class="c">dpoint.</span><span class="w">_sslContextFactory</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">assertI</span><span class="c">sInstance(</span><span class="w">c</span><span class="pc">ont</span><span class="c">extFactory,</span> <span class="w">ClientTLSOptions</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">con</span><span class="pc">tex</span><span class="c">tFactory</span><span class="pc">.</span><span class="w">_hostname</span><span class="c">,</span> <span class="w">u</span><span class="pc">"</span><span class="w">e</span><span class="c">xample.com</span><span class="pc">")</span>


    <span class="c">def</span> <span class="w">test_connectHTTPSCustomConnectionCreator</span><span class="c">(self):</span>
        
        <span class="w">expectedHost</span> <span class="c">=</span> <span class="pc">b'</span><span class="w">e</span><span class="c">xample.</span><span class="pc">o</span><span class="c">rg</span><span class="pc">'</span>
        <span class="w">expectedPort</span> <span class="pc">=</span> <span class="w">20443</span>
        <span class="w">c</span><span class="c">lass</span> <span class="w">JustEnoughConnection</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
            <span class="w">handshakeStarted</span> <span class="c">=</span> <span class="c">False</span>
            <span class="w">connectState</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>
            <span class="c">def</span> <span class="w">do_handshake</span><span class="c">(self):</span>
                
                <span class="c">self.</span><span class="w">h</span><span class="pc">a</span><span class="c">ndshakeStarted</span> <span class="pc">=</span> <span class="c">True</span>
            <span class="pc">d</span><span class="c">ef</span> <span class="w">set_connect_state</span><span class="c">(self):</span>
                
                <span class="pc">s</span><span class="c">elf.</span><span class="w">c</span><span class="c">onnectState</span> <span class="c">=</span> <span class="c">True</span>

        <span class="w">contextArgs</span> <span class="pc">= </span><span class="c">[]</span>

        <span class="w">@</span><span class="c">implementer(</span><span class="w">IOpenSSLClientConnectionCreator</span><span class="c">)</span>
        <span class="pc">c</span><span class="c">lass</span> <span class="w">JustEnoughCreator</span><span class="c">(object):</span>
            <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">h</span><span class="pc">ostn</span><span class="c">ame,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">)</span><span class="c">:</span>
                <span class="c">self.</span><span class="w">h</span><span class="pc">o</span><span class="c">stname</span> <span class="c">=</span> <span class="w">h</span><span class="pc">ostn</span><span class="c">ame</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="pc">p</span><span class="c">ort</span>

            <span class="pc">d</span><span class="c">ef</span> <span class="w">clientConnectionForTLS</span><span class="c">(self</span><span class="pc">,</span> <span class="w">tlsProtocol</span><span class="c">):</span>
                
                <span class="w">c</span><span class="pc">o</span><span class="c">ntextArgs.</span><span class="pc">a</span><span class="c">ppend</span><span class="pc">((t</span><span class="c">lsProtocol,</span> <span class="c">self.</span><span class="pc">h</span><span class="c">ostname,</span> <span class="c">self.port</span><span class="pc">))</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="w">expectedConnection</span>

        <span class="w">e</span><span class="pc">xp</span><span class="c">ectedConnection</span> <span class="pc">=</span> <span class="w">JustEnoughConnection</span><span class="pc">()</span>
        <span class="w">@</span><span class="c">implementer(</span><span class="w">IPolicyForHTTPS</span><span class="c">)</span>
        <span class="pc">c</span><span class="c">lass</span> <span class="w">StubBrowserLikePolicyForHTTPS</span><span class="c">(object):</span>
            <span class="c">def</span> <span class="w">creatorForNetloc</span><span class="c">(self</span><span class="pc">,</span> <span class="w">h</span><span class="pc">ostn</span><span class="c">ame</span><span class="pc">,</span> <span class="pc">p</span><span class="c">ort</span><span class="pc">)</span><span class="c">:</span>
                
                <span class="pc">r</span><span class="c">eturn</span> <span class="w">JustEnoughCreator</span><span class="c">(</span><span class="w">h</span><span class="pc">ostn</span><span class="c">ame,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">)</span>

        <span class="w">expectedCreatorCreator</span> <span class="c">=</span> <span class="w">S</span><span class="c">tubBrowserLikePolicyForHTTPS</span><span class="pc">(</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor</span> <span class="c">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="c">()</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Agent</span><span class="c">(</span><span class="pc">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">e</span><span class="c">xpectedCreatorCreator)</span>
        <span class="w">en</span><span class="pc">d</span><span class="c">point</span> <span class="pc">=</span> <span class="w">a</span><span class="c">gent.</span><span class="w">_getEndpoint</span><span class="c">(</span><span class="w">URI</span><span class="pc">.</span><span class="w">fromBytes</span><span class="c">(</span>
            <span class="pc">b'</span><span class="w">https://' +</span> <span class="w">expectedHost</span> <span class="w">+</span> <span class="c">b</span><span class="w">":" +</span> <span class="w">intToBytes(expectedPort))</span><span class="pc">)</span>
        <span class="w">en</span><span class="c">dpoint.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnect(</span><span class="w">F</span><span class="c">actory</span><span class="pc">.</span><span class="w">forProtocol</span><span class="pc">(</span><span class="w">P</span><span class="c">rotocol</span><span class="pc">))</span>
        <span class="w">passedFactory</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="w">sslClients[</span><span class="pc">-</span><span class="c">1</span><span class="pc">][2</span><span class="c">]</span>
        <span class="w">passedContextFactory</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">s</span><span class="c">slClients</span><span class="w">[</span><span class="pc">-</span><span class="c">1</span><span class="pc">][</span><span class="w">3</span><span class="c">]</span>
        <span class="w">tlsFactory</span> <span class="c">=</span> <span class="w">TLSMemoryBIOFactory</span><span class="pc">(</span>
            <span class="pc">passedC</span><span class="c">ontextFactory,</span> <span class="pc">T</span><span class="c">rue</span><span class="pc">,</span> <span class="w">p</span><span class="pc">assedF</span><span class="c">actory</span>
        <span class="c">)</span>
        <span class="w">tlsProtocol</span> <span class="c">=</span> <span class="c">tlsFactory.</span><span class="pc">b</span><span class="c">uildProtocol(None)</span>
        <span class="pc">t</span><span class="c">lsProtocol.</span><span class="w">m</span><span class="c">akeConnection(</span><span class="w">S</span><span class="c">tringTransport())</span>
        <span class="w">tls</span> <span class="c">=</span> <span class="w">contextArgs[</span><span class="c">0</span><span class="w">]</span><span class="pc">[0</span><span class="c">]</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(tls,</span> <span class="w">TLSMemoryBIOProtocol</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">c</span><span class="c">ontextArgs</span><span class="pc">[</span><span class="c">0][</span><span class="pc">1</span><span class="w">:], (expectedHost</span><span class="c">,</span> <span class="w">expectedPort)</span><span class="pc">)</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">expectedConnection</span><span class="c">.</span><span class="w">handshakeStarted</span><span class="pc">)</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">e</span><span class="pc">xpectedC</span><span class="c">onnection.</span><span class="w">connectState</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_deprecatedDuckPolicy</span><span class="c">(self):</span>
        
        <span class="w">d</span><span class="c">ef</span> <span class="w">warnMe</span><span class="pc">()</span><span class="c">:</span>
            <span class="w">cl</span><span class="pc">ient</span><span class="c">.</span><span class="w">Agent</span><span class="pc">(</span><span class="w">MemoryReactorClock()</span><span class="pc">,</span>
                         <span class="w">"d</span><span class="pc">oe</span><span class="c">s</span><span class="w">-n</span><span class="c">ot</span><span class="w">-provide</span><span class="pc">-</span><span class="w">IPolicyForHTTPS</span><span class="pc">"</span><span class="c">)</span>
        <span class="w">w</span><span class="c">arnMe</span><span class="w">(</span><span class="pc">)</span>
        <span class="w">wa</span><span class="pc">rnings</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">f</span><span class="c">lushWarnings</span><span class="pc">([</span><span class="w">w</span><span class="c">arnMe</span><span class="pc">])</span>
        <span class="c">self.assertEqual(len(</span><span class="w">w</span><span class="pc">arnings</span><span class="c">),</span> <span class="c">1)</span>
        <span class="w">[warning</span><span class="pc">]</span><span class="c"> =</span> <span class="w">w</span><span class="pc">arnings</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">w</span><span class="pc">arning</span><span class="w">[</span><span class="pc">'</span><span class="w">c</span><span class="c">ategory</span><span class="pc">'</span><span class="c">],</span> <span class="c">DeprecationWarning)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span>
            <span class="w">w</span><span class="pc">arning</span><span class="w">[</span><span class="pc">'m</span><span class="c">essage'],</span>
            <span class="w">"'d</span><span class="pc">o</span><span class="c">es</span><span class="w">-n</span><span class="pc">o</span><span class="c">t</span><span class="w">-provide-IPolicyForHTTPS'</span> <span class="w">wa</span><span class="pc">s</span> <span class="w">passed</span> <span class="w">a</span><span class="pc">s</span> <span class="c">the</span> <span class="w">HTTPS</span> <span class="pc">"</span>
            <span class="c">"</span><span class="w">policy</span> <span class="w">f</span><span class="pc">or</span> <span class="w">a</span><span class="pc">n</span> <span class="w">Agent,</span> <span class="w">but</span> <span class="w">i</span><span class="pc">t</span> <span class="w">d</span><span class="pc">o</span><span class="c">es</span> <span class="c">not</span> <span class="w">p</span><span class="c">rovide</span> <span class="w">I</span><span class="c">PolicyForHTTPS</span><span class="w">.  "</span>
            <span class="pc">"</span><span class="w">Since</span> <span class="w">T</span><span class="c">wisted</span> <span class="w">14</span><span class="pc">.</span><span class="c">0</span><span class="pc">,</span> <span class="w">you</span> <span class="w">m</span><span class="c">ust</span> <span class="w">p</span><span class="pc">ass</span> <span class="w">a</span> <span class="w">provider</span> <span class="w">o</span><span class="c">f</span> <span class="w">I</span><span class="pc">P</span><span class="c">olicyForHTTPS</span><span class="w">.</span><span class="pc">"</span>
        <span class="w">)</span>


    <span class="c">def</span> <span class="w">test_alternateTrustRoot</span><span class="c">(self):</span>
        
        <span class="w">@</span><span class="c">implementer(</span><span class="w">IOpenSSLTrustRoot</span><span class="c">)</span>
        <span class="c">class</span> <span class="w">CustomOpenSSLTrustRoot</span><span class="c">(object):</span>
            <span class="w">ca</span><span class="pc">l</span><span class="c">led</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>
            <span class="w">con</span><span class="pc">tex</span><span class="c">t</span> <span class="c">=</span> <span class="c">None</span>
            <span class="c">def</span> <span class="w">_addCACertsToContext</span><span class="c">(self</span><span class="pc">,</span> <span class="w">cont</span><span class="pc">ext</span><span class="c">):</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">calle</span><span class="c">d</span> <span class="c">=</span> <span class="pc">T</span><span class="c">rue</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">cont</span><span class="pc">ext</span> <span class="c">=</span> <span class="w">cont</span><span class="pc">ext</span>
        <span class="w">trustRoot</span> <span class="c">=</span> <span class="w">C</span><span class="c">ustomOpenSSLTrustRoot()</span>
        <span class="w">policy</span> <span class="c">=</span> <span class="w">BrowserLikePolicyForHTTPS</span><span class="c">(trustRoot</span><span class="pc">=</span><span class="w">t</span><span class="c">rustRoot)</span>
        <span class="w">creator</span> <span class="c">=</span> <span class="pc">p</span><span class="c">olicy.</span><span class="w">creatorForNetloc</span><span class="c">(</span><span class="w">b</span><span class="pc">"</span><span class="w">thingy</span><span class="pc">",</span> <span class="w">4321</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">assertT</span><span class="c">rue(</span><span class="w">t</span><span class="pc">r</span><span class="c">ustRoot.</span><span class="w">ca</span><span class="pc">lle</span><span class="c">d</span><span class="pc">)</span>
        <span class="w">conn</span><span class="pc">ecti</span><span class="c">on</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">reator.</span><span class="w">clientConnectionForTLS</span><span class="c">(</span><span class="w">N</span><span class="c">one)</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">(</span><span class="pc">t</span><span class="c">rustRoot</span><span class="pc">.</span><span class="w">cont</span><span class="pc">ext</span><span class="c">,</span> <span class="w">conne</span><span class="pc">ction.</span><span class="w">get_context</span><span class="pc">(</span><span class="c">))</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">WebClientContextFactoryTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase):</span>
    

    <span class="c">def</span> <span class="c">setUp(self):</span>
        
        <span class="w">f</span><span class="c">rom</span> <span class="c">twisted.</span><span class="pc">w</span><span class="c">eb</span><span class="pc">.</span><span class="w">cl</span><span class="pc">ient</span> <span class="pc">i</span><span class="c">mport</span> <span class="w">WebClientContextFactory</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">warned</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">f</span><span class="c">lushWarnings</span><span class="pc">([</span><span class="w">W</span><span class="pc">ebClientContextFactoryT</span><span class="c">ests.</span><span class="w">se</span><span class="pc">tU</span><span class="c">p</span><span class="w">]</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">webClientContextFactory</span> <span class="c">=</span> <span class="w">W</span><span class="pc">ebClientContextFactory</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_deprecated</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="pc">a</span><span class="c">ssertEqual(</span><span class="pc">l</span><span class="c">en(self.warned),</span> <span class="pc">1</span><span class="c">)</span>
        <span class="w">[warning</span><span class="c">] =</span> <span class="c">self.warned</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">ssertE</span><span class="c">qual(</span><span class="pc">wa</span><span class="c">rning</span><span class="pc">['</span><span class="w">c</span><span class="pc">a</span><span class="c">tegory'],</span> <span class="pc">D</span><span class="c">eprecationWarning)</span>
        <span class="c">self.assertEqual(</span>
            <span class="w">w</span><span class="pc">arning['</span><span class="w">m</span><span class="c">essage</span><span class="pc">'],</span>
            <span class="w">getDeprecationWarningString</span><span class="pc">(</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">webClientContextFactory</span><span class="pc">,</span> <span class="w">V</span><span class="pc">e</span><span class="c">rsion</span><span class="pc">("T</span><span class="c">wisted",</span> <span class="w">14</span><span class="pc">,</span> <span class="pc">0</span><span class="c">,</span> <span class="c">0),</span>
                <span class="w">replacement</span><span class="pc">=</span><span class="w">BrowserLikePolicyForHTTPS</span><span class="pc">,</span>
            <span class="w">)</span>

            
            <span class="w">.r</span><span class="pc">eplace</span><span class="w">(";", ":")</span>
        <span class="w">)</span>


    <span class="c">def</span> <span class="w">test_missingSSL</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertR</span><span class="c">aises(</span>
            <span class="w">N</span><span class="c">otImplementedError,</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">w</span><span class="c">ebClientContextFactory</span><span class="w">()</span><span class="pc">.</span><span class="w">getContext</span><span class="c">,</span>
            <span class="w">b</span><span class="pc">'</span><span class="w">e</span><span class="c">xample.com',</span> <span class="w">443</span><span class="pc">,</span>
        <span class="w">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_returnsContext</span><span class="c">(self):</span>
        
        <span class="w">ct</span><span class="c">x</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">w</span><span class="c">ebClientContextFactory</span><span class="w">()</span><span class="pc">.getC</span><span class="c">ontext</span><span class="w">('e</span><span class="c">xample.com',</span> <span class="w">4</span><span class="c">43</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">ct</span><span class="c">x</span><span class="pc">,</span> <span class="w">ss</span><span class="c">l.</span><span class="w">SS</span><span class="c">L</span><span class="pc">.</span><span class="w">Context</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_setsTrustRootOnContextToDefaultTrustRoot</span><span class="c">(self):</span>
        
        <span class="w">ct</span><span class="c">x</span> <span class="c">=</span> <span class="c">self.</span><span class="w">w</span><span class="c">ebClientContextFactory</span><span class="pc">(</span><span class="c">)</span>
        <span class="w">certificateOptions</span> <span class="c">=</span> <span class="w">ct</span><span class="c">x.</span><span class="w">_getCertificateOptions</span><span class="pc">('e</span><span class="c">xample.com',</span> <span class="w">4</span><span class="c">43</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">as</span><span class="pc">sertIs</span><span class="c">Instance(</span>
            <span class="c">certificateOptions.</span><span class="w">trustRoot</span><span class="c">,</span> <span class="w">ss</span><span class="c">l.</span><span class="w">OpenSSLDefaultPaths</span><span class="c">)</span>


    <span class="pc">i</span><span class="c">f</span> <span class="w">ss</span><span class="c">l</span> <span class="pc">i</span><span class="c">s</span> <span class="c">None:</span>
        <span class="w">test_returnsContext</span><span class="pc">.s</span><span class="c">kip</span> <span class="c">= "</span><span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">present,</span> <span class="w">cannot</span> <span class="w">r</span><span class="pc">u</span><span class="c">n</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="w">tests.</span><span class="pc">"</span>
        <span class="w">test_setsTrustRootOnContextToDefaultTrustRoot</span><span class="pc">.</span><span class="c">skip</span> <span class="pc">= (</span>
            <span class="c">"</span><span class="w">S</span><span class="c">SL</span> <span class="w">n</span><span class="c">ot</span> <span class="c">present</span><span class="w">,</span> <span class="w">c</span><span class="c">annot</span> <span class="w">r</span><span class="c">un</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="w">t</span><span class="pc">ests</span><span class="w">.</span><span class="pc">"</span><span class="c">)</span>
    <span class="pc">e</span><span class="c">lse:</span>
        <span class="w">test_missingSSL</span><span class="pc">.sk</span><span class="c">ip</span> <span class="pc">= </span><span class="c">"</span><span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="w">p</span><span class="pc">re</span><span class="c">sent</span><span class="w">.</span><span class="pc">"</span>



<span class="c">class</span> <span class="w">HTTPConnectionPoolRetryTests</span><span class="c">(TestCase</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="c">):</span>
    

    <span class="c">def</span> <span class="w">test_onlyRetryIdempotentMethods</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(N</span><span class="c">one)</span>
        <span class="w">conn</span><span class="pc">ecti</span><span class="c">on</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="c">(</span><span class="pc">N</span><span class="c">one</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l)</span>
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertT</span><span class="c">rue(</span><span class="w">co</span><span class="pc">nnecti</span><span class="c">on.</span><span class="w">_shouldRetry</span><span class="pc">(</span>
            <span class="c">b"</span><span class="w">G</span><span class="c">ET</span><span class="pc">",</span> <span class="w">RequestNotSent(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">c</span><span class="pc">onn</span><span class="c">ection._shouldRetry(</span>
            <span class="c">b"</span><span class="w">HEAD</span><span class="c">",</span> <span class="pc">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection._shouldRetry(</span>
            <span class="c">b"</span><span class="w">OPTIONS</span><span class="c">",</span> <span class="w">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection.</span><span class="pc">_</span><span class="c">shouldRetry(</span>
            <span class="c">b"</span><span class="w">TRACE</span><span class="c">",</span> <span class="w">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection.</span><span class="pc">_</span><span class="c">shouldRetry(</span>
            <span class="c">b"</span><span class="w">DELETE</span><span class="c">",</span> <span class="w">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="w">con</span><span class="pc">nection</span><span class="c">._shouldRetry(</span>
            <span class="c">b"</span><span class="w">POST</span><span class="c">",</span> <span class="w">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="w">con</span><span class="pc">nection</span><span class="c">._shouldRetry(</span>
            <span class="c">b"</span><span class="w">MYMETHOD</span><span class="c">",</span> <span class="w">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        
        
        


    <span class="c">def</span> <span class="w">test_onlyRetryIfNoResponseReceived</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(</span><span class="w">N</span><span class="c">one)</span>
        <span class="w">conn</span><span class="pc">ecti</span><span class="c">on</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="c">(</span><span class="pc">N</span><span class="c">one</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l)</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection.</span><span class="pc">_</span><span class="c">shouldRetry(</span>
            <span class="c">b"</span><span class="w">G</span><span class="c">ET</span><span class="pc">",</span> <span class="pc">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">c</span><span class="pc">onn</span><span class="c">ection._shouldRetry(</span>
            <span class="c">b"</span><span class="w">G</span><span class="c">ET",</span> <span class="w">RequestTransmissionFailed([]),</span> <span class="w">N</span><span class="c">one</span><span class="w">)</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection._shouldRetry(</span>
            <span class="c">b"</span><span class="w">G</span><span class="c">ET</span><span class="pc">"</span><span class="c">,</span> <span class="w">ResponseNeverReceived([</span><span class="c">]),</span><span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="w">con</span><span class="pc">nection</span><span class="c">._shouldRetry(</span>
            <span class="c">b"</span><span class="pc">G</span><span class="c">ET</span><span class="pc">"</span><span class="c">,</span> <span class="w">ResponseFailed(</span><span class="pc">[</span><span class="c">]),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="w">con</span><span class="pc">nection</span><span class="c">._shouldRetry(</span>
            <span class="c">b"</span><span class="pc">G</span><span class="c">ET</span><span class="pc">"</span><span class="c">,</span> <span class="w">ConnectionRefusedError(</span><span class="pc">)</span><span class="c">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>


    <span class="c">def</span> <span class="w">test_dontRetryIfFailedDueToCancel</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(N</span><span class="c">one)</span>
        <span class="w">conn</span><span class="pc">ecti</span><span class="c">on</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="c">(</span><span class="pc">N</span><span class="c">one</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l)</span>
        <span class="w">ex</span><span class="pc">cepti</span><span class="c">on</span> <span class="c">=</span> <span class="w">ResponseNeverReceived</span><span class="pc">([</span><span class="w">F</span><span class="c">ailure(</span><span class="w">d</span><span class="pc">efer</span><span class="c">.</span><span class="w">CancelledError())])</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">assertF</span><span class="pc">al</span><span class="c">se(</span><span class="w">con</span><span class="pc">necti</span><span class="c">on.</span><span class="w">_shouldRetry</span><span class="pc">(b</span><span class="c">"</span><span class="w">G</span><span class="c">ET</span><span class="pc">",</span> <span class="w">ex</span><span class="pc">c</span><span class="c">eption</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_retryIfFailedDueToNonCancelException</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(</span><span class="w">N</span><span class="c">one)</span>
        <span class="w">conn</span><span class="pc">ecti</span><span class="c">on</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="c">(</span><span class="pc">N</span><span class="c">one</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l)</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection.</span><span class="pc">_</span><span class="c">shouldRetry(</span>
            <span class="c">b"</span><span class="w">G</span><span class="c">ET</span><span class="pc">",</span> <span class="w">ResponseNeverReceived([F</span><span class="pc">ai</span><span class="c">lure(</span><span class="w">E</span><span class="c">xception</span><span class="w">())]),</span> <span class="pc">N</span><span class="c">one</span><span class="pc">))</span>


    <span class="c">def</span> <span class="w">test_wrappedOnPersistentReturned</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(</span><span class="w">C</span><span class="pc">lo</span><span class="c">ck())</span>

        
        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="pc">()</span>
        <span class="pc">p</span><span class="c">rotocol.makeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection</span><span class="c">(</span><span class="w">12</span><span class="pc">3,</span> <span class="w">p</span><span class="pc">rot</span><span class="c">ocol)</span>

        
        
        <span class="w">d</span> <span class="pc">=</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection</span><span class="c">(</span><span class="w">12</span><span class="pc">3</span><span class="c">,</span> <span class="w">DummyEndpoint</span><span class="pc">(</span><span class="c">))</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">gotConnection</span><span class="c">(</span><span class="w">c</span><span class="pc">onn</span><span class="c">ection):</span>
            <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection</span><span class="pc">,</span>
                                  <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">assertI</span><span class="pc">d</span><span class="c">entical(</span><span class="w">con</span><span class="pc">ne</span><span class="c">ction.</span><span class="w">_clientProtocol</span><span class="c">,</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">g</span><span class="c">otConnection)</span>


    <span class="c">def</span> <span class="w">test_notWrappedOnNewReturned</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">HTTPConnectionPool</span><span class="c">(</span><span class="pc">N</span><span class="c">one)</span>
        <span class="pc">d</span> <span class="c">=</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection</span><span class="c">(</span><span class="w">12</span><span class="pc">3,</span> <span class="w">DummyEndpoint</span><span class="pc">(</span><span class="c">))</span>

        <span class="pc">de</span><span class="c">f</span> <span class="w">g</span><span class="pc">o</span><span class="c">tConnection(</span><span class="w">c</span><span class="pc">onn</span><span class="c">ection):</span>
            
            
            <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span><span class="w">conn</span><span class="pc">ection</span><span class="c">.</span><span class="w">_</span><span class="c">_class__</span><span class="pc">,</span> <span class="w">HTTP11ClientProtocol</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">g</span><span class="pc">o</span><span class="c">tConnection)</span>


    <span class="c">def</span> <span class="w">retryAttempt</span><span class="c">(self</span><span class="pc">,</span> <span class="w">willWeRetry</span><span class="c">):</span>
        
        <span class="w">pr</span><span class="pc">otocols</span> <span class="pc">= </span><span class="c">[]</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">newProtocol</span><span class="pc">()</span><span class="c">:</span>
            <span class="w">pr</span><span class="pc">otoc</span><span class="c">ol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
            <span class="w">prot</span><span class="pc">ocols.</span><span class="c">append(</span><span class="w">p</span><span class="c">rotocol)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="c">defer.succeed(</span><span class="w">p</span><span class="c">rotocol</span><span class="pc">)</span>

        <span class="w">bodyProducer</span> <span class="c">=</span> <span class="w">o</span><span class="c">bject()</span>
        <span class="pc">req</span><span class="c">uest</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.Request(</span><span class="pc">b"</span><span class="w">FOO</span><span class="pc">",</span> <span class="c">b</span><span class="w">"/",</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="pc">()</span><span class="c">,</span> <span class="pc">bo</span><span class="c">dyProducer</span><span class="w">,</span>
                                 <span class="w">persistent</span><span class="pc">=T</span><span class="c">rue)</span>
        <span class="w">newProtocol(</span><span class="pc">)</span>
        <span class="pc">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">prot</span><span class="pc">ocols</span><span class="w">[</span><span class="c">0]</span>
        <span class="w">retrier</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="pc">(p</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">n</span><span class="c">ewProtocol)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">_shouldRetry</span><span class="c">(</span><span class="w">m</span><span class="pc">,</span> <span class="w">e</span><span class="pc">,</span> <span class="w">bp</span><span class="pc">)</span><span class="c">:</span>
            <span class="c">self.assertEqual(</span><span class="w">m</span><span class="pc">,</span> <span class="w">b</span><span class="pc">"</span><span class="w">FOO"</span><span class="pc">)</span>
            <span class="c">self.</span><span class="pc">assertId</span><span class="c">entical(bp</span><span class="pc">,</span> <span class="w">bodyProducer</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">e,</span><span class="pc"> (</span><span class="w">RequestNotSent</span><span class="c">,</span> <span class="w">ResponseNeverReceived)</span><span class="pc">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">willWeRetry</span>
        <span class="w">retrier._</span><span class="pc">s</span><span class="c">houldRetry</span> <span class="pc">=</span> <span class="w">_</span><span class="c">shouldRetry</span>

        <span class="w">d</span> <span class="c">=</span> <span class="w">r</span><span class="c">etrier.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">(</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest)</span>

        
        <span class="pc">s</span><span class="c">elf.assertEqual(len(</span><span class="w">prot</span><span class="pc">ocols</span><span class="c">),</span> <span class="c">1)</span>
        <span class="c">self.assertEqual(len(</span><span class="w">pro</span><span class="pc">tocols[</span><span class="c">0</span><span class="pc">].</span><span class="w">req</span><span class="pc">uests</span><span class="c">),</span> <span class="c">1)</span>

        
        <span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests[</span><span class="c">0</span><span class="pc">][</span><span class="c">1</span><span class="pc">].</span><span class="w">e</span><span class="pc">rrb</span><span class="c">ack(</span><span class="w">RequestNotSent</span><span class="pc">()</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span><span class="pc">,</span> <span class="w">prot</span><span class="pc">ocols</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_retryIfShouldRetryReturnsTrue</span><span class="c">(self):</span>
        
        <span class="pc">d,</span> <span class="w">prot</span><span class="pc">ocols</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">retryAttempt</span><span class="c">(</span><span class="w">T</span><span class="c">rue</span><span class="pc">)</span>
        
        <span class="c">self.assertEqual(len(</span><span class="w">pr</span><span class="pc">otocols</span><span class="c">),</span> <span class="pc">2</span><span class="c">)</span>
        <span class="w">re</span><span class="pc">sp</span><span class="c">onse</span> <span class="pc">=</span> <span class="w">o</span><span class="c">bject()</span>
        <span class="w">pro</span><span class="pc">tocols[1].</span><span class="w">req</span><span class="pc">uests[</span><span class="c">0</span><span class="pc">][</span><span class="c">1</span><span class="pc">].</span><span class="w">c</span><span class="c">allback(</span><span class="w">r</span><span class="pc">esp</span><span class="c">onse)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(self.</span><span class="w">assertI</span><span class="c">dentical</span><span class="pc">,</span> <span class="w">r</span><span class="pc">esp</span><span class="c">onse</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_dontRetryIfShouldRetryReturnsFalse</span><span class="c">(self):</span>
        
        <span class="pc">d,</span> <span class="w">prot</span><span class="pc">ocols</span> <span class="c">=</span> <span class="c">self.</span><span class="w">retryAttempt</span><span class="c">(</span><span class="w">F</span><span class="c">alse)</span>
        
        <span class="pc">s</span><span class="c">elf.assertEqual(len(</span><span class="w">pro</span><span class="pc">tocols</span><span class="c">),</span> <span class="c">1)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">s</span><span class="c">elf.assertFailure(d,</span> <span class="w">RequestNotSent</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_onlyRetryWithoutBody</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(N</span><span class="c">one)</span>
        <span class="w">conn</span><span class="pc">ecti</span><span class="c">on</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="c">(</span><span class="pc">N</span><span class="c">one</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l)</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">con</span><span class="pc">necti</span><span class="c">on.</span><span class="w">_shouldRetry</span><span class="c">(b"</span><span class="w">G</span><span class="c">ET</span><span class="pc">",</span> <span class="w">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">N</span><span class="c">one</span><span class="pc">))</span>
        <span class="c">self.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection._shouldRetry(</span><span class="pc">b</span><span class="c">"</span><span class="w">G</span><span class="c">ET",</span> <span class="pc">R</span><span class="c">equestNotSent</span><span class="w">(</span><span class="pc">),</span> <span class="w">o</span><span class="c">bject</span><span class="pc">()))</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_onlyRetryOnce</span><span class="c">(self):</span>
        
        <span class="w">d</span><span class="pc">,</span> <span class="w">prot</span><span class="pc">ocols</span> <span class="c">=</span> <span class="c">self.</span><span class="w">retryAttempt</span><span class="pc">(</span><span class="w">T</span><span class="c">rue)</span>
        <span class="c">self.assertEqual(len(</span><span class="w">prot</span><span class="pc">ocols</span><span class="c">),</span> <span class="pc">2</span><span class="c">)</span>
        
        <span class="w">prot</span><span class="pc">ocols</span><span class="w">[</span><span class="pc">1</span><span class="c">].</span><span class="w">req</span><span class="pc">uests[</span><span class="c">0][1</span><span class="pc">].</span><span class="w">e</span><span class="pc">rrb</span><span class="c">ack(</span><span class="w">ResponseNeverReceived([]))</span>
        
        <span class="pc">s</span><span class="c">elf.assertEqual(len(</span><span class="w">pr</span><span class="pc">otoc</span><span class="c">ols),</span> <span class="pc">2</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">s</span><span class="c">elf.assertFailure(d,</span> <span class="w">R</span><span class="c">esponseNeverReceived)</span>


    <span class="c">def</span> <span class="w">test_dontRetryIfRetryAutomaticallyFalse</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(</span><span class="w">C</span><span class="pc">lo</span><span class="c">ck())</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">.</span><span class="w">retryAutomatically</span> <span class="c">=</span> <span class="w">F</span><span class="c">alse</span>

        
        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span> <span class="c">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
        <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span><span class="pc">.m</span><span class="c">akeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection</span><span class="c">(</span><span class="w">1</span><span class="pc">2</span><span class="c">3</span><span class="pc">,</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span><span class="pc">)</span>

        
        <span class="pc">d</span> <span class="pc">=</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection</span><span class="c">(</span><span class="w">12</span><span class="pc">3,</span> <span class="w">DummyEndpoint(</span><span class="pc">)</span><span class="c">)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">gotConnection</span><span class="c">(</span><span class="w">c</span><span class="pc">onn</span><span class="c">ection):</span>
            <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span><span class="w">con</span><span class="pc">nection,</span> <span class="pc">p</span><span class="c">rotocol</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="pc">g</span><span class="c">otConnection)</span>


    <span class="c">def</span> <span class="w">test_retryWithNewConnection</span><span class="c">(self):</span>
        
        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">HTTPConnectionPool</span><span class="pc">(</span><span class="w">C</span><span class="pc">lo</span><span class="c">ck</span><span class="pc">(</span><span class="c">))</span>
        <span class="w">k</span><span class="c">ey</span> <span class="c">=</span> <span class="w">12</span><span class="pc">3</span>
        <span class="w">e</span><span class="pc">n</span><span class="c">dpoint</span> <span class="c">=</span> <span class="w">D</span><span class="c">ummyEndpoint()</span>
        <span class="w">newConnections</span> <span class="pc">= </span><span class="c">[]</span>

        
        <span class="c">def</span> <span class="w">newConnection</span><span class="c">(</span><span class="w">k</span><span class="pc">,</span> <span class="w">e</span><span class="c">):</span>
            <span class="w">n</span><span class="c">ewConnections.append</span><span class="pc">((</span><span class="w">k</span><span class="c">,</span> <span class="w">e</span><span class="c">))</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_newConnection</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">ewConnection</span>

        
        <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="pc">=</span> <span class="w">StubHTTPProtocol</span><span class="c">()</span>
        <span class="pc">p</span><span class="c">rotocol.</span><span class="pc">m</span><span class="c">akeConnection(</span><span class="pc">S</span><span class="c">tringTransport())</span>
        <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">_putConnection</span><span class="c">(</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="pc">pr</span><span class="c">otocol</span><span class="pc">)</span>

        
        
        <span class="w">d</span> <span class="pc">=</span> <span class="w">po</span><span class="pc">o</span><span class="c">l.</span><span class="w">getConnection</span><span class="c">(</span><span class="w">k</span><span class="c">ey,</span> <span class="w">e</span><span class="pc">n</span><span class="c">dpoint)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">gotConnection</span><span class="c">(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ection):</span>
            <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">sInstance(</span><span class="w">co</span><span class="pc">nnecti</span><span class="c">on</span><span class="pc">,</span>
                                  <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">_RetryingHTTP11ClientProtocol</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">assertI</span><span class="pc">d</span><span class="c">entical(</span><span class="w">con</span><span class="pc">necti</span><span class="c">on.</span><span class="w">_clientProtocol</span><span class="c">,</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">)</span>
            
            
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">newConnections,</span><span class="pc"> []</span><span class="c">)</span>
            <span class="w">co</span><span class="c">nnection.</span><span class="w">_newConnection</span><span class="pc">()</span>
            <span class="c">self.assertEqual(</span><span class="pc">l</span><span class="c">en(</span><span class="w">n</span><span class="c">ewConnections</span><span class="pc">)</span><span class="c">,</span> <span class="c">1)</span>
            <span class="c">self.assertEqual(</span><span class="pc">n</span><span class="c">ewConnections</span><span class="pc">[</span><span class="c">0][0</span><span class="pc">],</span> <span class="w">k</span><span class="pc">e</span><span class="c">y)</span>
            <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(newConnections[0][1</span><span class="pc">],</span> <span class="w">end</span><span class="pc">point</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">gotConnection</span><span class="c">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">CookieTestsMixin</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
    
    <span class="c">def</span> <span class="w">addCookies</span><span class="c">(self</span><span class="pc">,</span> <span class="w">cookieJar</span><span class="pc">,</span> <span class="w">ur</span><span class="c">i</span><span class="pc">,</span> <span class="w">cookies</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">res</span><span class="pc">p</span><span class="c">onse</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">_FakeUrllib2Response</span><span class="c">(</span>
            <span class="w">c</span><span class="pc">l</span><span class="c">ient</span><span class="pc">.</span><span class="w">Response</span><span class="c">(</span>
                <span class="w">(b</span><span class="c">'</span><span class="w">H</span><span class="pc">T</span><span class="c">TP',</span> <span class="pc">1,</span> <span class="pc">1),</span>
                <span class="w">2</span><span class="pc">00,</span>
                <span class="pc">b</span><span class="c">'</span><span class="w">O</span><span class="c">K</span><span class="pc">'</span><span class="c">,</span>
                <span class="w">cl</span><span class="c">ient.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="w">Set</span><span class="pc">-</span><span class="w">Cookie':</span> <span class="pc">c</span><span class="c">ookies</span><span class="w">}),</span>
                <span class="w">N</span><span class="c">one</span><span class="w">)</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">equ</span><span class="c">est</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">_FakeUrllib2Request</span><span class="c">(</span><span class="w">u</span><span class="pc">ri</span><span class="c">)</span>
        <span class="w">cookieJar</span><span class="pc">.</span><span class="w">extract_cookies</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse,</span> <span class="pc">r</span><span class="c">equest</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">equest</span><span class="pc">,</span> <span class="pc">res</span><span class="c">ponse</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">CookieJarTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">CookieTestsMixin</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="w">makeCookieJar</span><span class="c">(self):</span>
        
        <span class="w">c</span><span class="pc">ookieJ</span><span class="c">ar</span> <span class="c">=</span> <span class="w">cookielib</span><span class="pc">.</span><span class="w">CookieJar</span><span class="c">()</span>
        <span class="w">reqres</span> <span class="c">=</span> <span class="c">self.</span><span class="w">addCookies</span><span class="c">(</span>
            <span class="c">cookieJar,</span>
            <span class="pc">b</span><span class="c">'</span><span class="w">h</span><span class="c">ttp://example.com</span><span class="w">:1</span><span class="pc">2</span><span class="c">34/</span><span class="w">f</span><span class="c">oo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="w">',</span>
            <span class="w">[b</span><span class="c">'</span><span class="w">f</span><span class="c">oo</span><span class="w">=</span><span class="pc">1</span><span class="w">;</span> <span class="w">cow</span><span class="c">=</span><span class="w">moo;</span> <span class="w">Path=/</span><span class="pc">f</span><span class="c">oo</span><span class="w">;</span> <span class="w">Comment</span><span class="c">=</span><span class="w">he</span><span class="pc">l</span><span class="c">lo</span><span class="w">'</span><span class="c">,</span>
             <span class="c">b'</span><span class="w">b</span><span class="c">ar</span><span class="w">=2;</span> <span class="w">C</span><span class="c">omment=</span><span class="w">goodbye']</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">cookieJar,</span> <span class="w">reqres</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_extractCookies</span><span class="c">(self):</span>
        
        <span class="w">jar</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">makeCookieJar()</span><span class="pc">[0</span><span class="c">]</span>
        <span class="w">cookies</span> <span class="c">=</span> <span class="w">d</span><span class="pc">i</span><span class="c">ct</span><span class="w">([(c</span><span class="pc">.</span><span class="w">n</span><span class="pc">ame,</span> <span class="w">c</span><span class="pc">)</span> <span class="w">f</span><span class="c">or</span> <span class="w">c</span> <span class="c">in</span> <span class="pc">j</span><span class="c">ar</span><span class="pc">])</span>

        <span class="w">coo</span><span class="pc">kie</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ookies</span><span class="w">[</span><span class="pc">'</span><span class="w">f</span><span class="c">oo']</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">coo</span><span class="pc">kie.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion,</span> <span class="c">0)</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="pc">kie</span><span class="c">.</span><span class="w">n</span><span class="c">ame</span><span class="w">,</span><span class="pc"> 'f</span><span class="c">oo')</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="pc">kie</span><span class="c">.</span><span class="w">v</span><span class="c">alue</span><span class="w">,</span><span class="pc"> '</span><span class="w">1</span><span class="c">')</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="pc">kie</span><span class="c">.</span><span class="w">p</span><span class="c">ath</span><span class="w">, '/f</span><span class="c">oo</span><span class="pc">'</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="c">kie.</span><span class="w">comment</span><span class="pc">, </span><span class="c">'</span><span class="pc">h</span><span class="c">ello')</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="c">kie.</span><span class="w">get_nonstandard_attr</span><span class="pc">('</span><span class="w">cow'), 'moo</span><span class="c">')</span>

        <span class="w">coo</span><span class="c">kie</span> <span class="c">=</span> <span class="w">cookies</span><span class="pc">[</span><span class="c">'</span><span class="w">b</span><span class="c">ar</span><span class="pc">']</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="pc">kie</span><span class="c">.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion,</span> <span class="c">0)</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="pc">kie</span><span class="c">.</span><span class="w">n</span><span class="c">ame</span><span class="pc">, '</span><span class="w">b</span><span class="c">ar')</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="pc">kie</span><span class="c">.</span><span class="w">v</span><span class="c">alue</span><span class="w">,</span><span class="pc"> '</span><span class="w">2</span><span class="c">')</span>
        <span class="c">self.assertEqual(</span><span class="w">coo</span><span class="pc">kie</span><span class="c">.</span><span class="w">p</span><span class="pc">a</span><span class="c">th</span><span class="w">, '/')</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">coo</span><span class="c">kie.</span><span class="w">comment</span><span class="pc">, '</span><span class="w">goodbye</span><span class="c">')</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">d</span><span class="c">entical(</span><span class="w">coo</span><span class="c">kie.</span><span class="w">get_nonstandard_attr</span><span class="pc">('</span><span class="w">cow</span><span class="pc">'),</span> <span class="w">N</span><span class="c">one)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_sendCookie</span><span class="c">(self):</span>
        
        <span class="w">jar,</span><span class="pc"> (</span><span class="w">re</span><span class="pc">q</span><span class="c">uest,</span> <span class="w">re</span><span class="pc">spo</span><span class="c">nse</span><span class="w">) =</span> <span class="c">self.</span><span class="w">makeCookieJar(</span><span class="pc">)</span>

        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span>
            <span class="w">r</span><span class="pc">equ</span><span class="c">est.</span><span class="w">get_header(</span><span class="pc">'</span><span class="w">Cookie</span><span class="pc">',</span> <span class="pc">N</span><span class="c">one</span><span class="pc">),</span>
            <span class="c">None)</span>

        <span class="w">j</span><span class="c">ar.</span><span class="w">add_cookie_header</span><span class="pc">(</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span>
            <span class="w">r</span><span class="c">equest.</span><span class="pc">g</span><span class="c">et_header</span><span class="w">(</span><span class="pc">'C</span><span class="c">ookie</span><span class="pc">',</span> <span class="pc">N</span><span class="c">one</span><span class="pc">),</span>
            <span class="pc">'</span><span class="w">f</span><span class="c">oo</span><span class="w">=</span><span class="pc">1</span><span class="w">;</span> <span class="pc">b</span><span class="c">ar=</span><span class="pc">2</span><span class="w">'</span><span class="c">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">CookieAgentTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">CookieTestsMixin</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="pc">,</span>
                       <span class="w">AgentTestsMixin</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="w">makeAgent</span><span class="c">(self):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent.</span><span class="w">CookieAgent</span><span class="c">(</span>
            <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(self.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">),</span>
            <span class="w">cookielib.CookieJar</span><span class="pc">()</span><span class="c">)</span>


    <span class="c">def</span> <span class="c">setUp(self):</span>
        <span class="c">self.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="pc">()</span>


    <span class="c">def</span> <span class="w">test_emptyCookieJarRequest</span><span class="c">(self):</span>
        
        <span class="w">cookieJar</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ookielib</span><span class="pc">.</span><span class="w">C</span><span class="pc">ookieJ</span><span class="c">ar()</span>
        <span class="c">self.</span><span class="pc">assertE</span><span class="c">qual(</span><span class="w">l</span><span class="pc">i</span><span class="c">st(cookieJar</span><span class="w">), [])</span>

        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="c">eactor</span><span class="pc">)</span>
        <span class="w">cookieAgent</span> <span class="pc">=</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent.</span><span class="w">CookieAgent</span><span class="c">(</span><span class="w">ag</span><span class="c">ent</span><span class="pc">,</span> <span class="c">cookieJar)</span>
        <span class="pc">d</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ookieAgent.</span><span class="w">req</span><span class="c">uest(</span>
            <span class="w">b</span><span class="c">'</span><span class="w">G</span><span class="c">ET</span><span class="pc">'</span><span class="c">,</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="pc">:</span><span class="w">1</span><span class="pc">2</span><span class="c">34/</span><span class="w">f</span><span class="c">oo</span><span class="w">?b</span><span class="pc">a</span><span class="c">r</span><span class="pc">'</span><span class="c">)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">_checkCookie</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="w">cookies</span> <span class="c">=</span> <span class="w">l</span><span class="pc">i</span><span class="c">st(</span><span class="pc">c</span><span class="c">ookieJar</span><span class="pc">)</span>
            <span class="c">self.assertEqual(</span><span class="w">l</span><span class="c">en(cookies),</span> <span class="c">1</span><span class="pc">)</span>
            <span class="c">self.assertEqual(cookies</span><span class="pc">[</span><span class="c">0</span><span class="pc">].</span><span class="w">n</span><span class="c">ame</span><span class="pc">, '</span><span class="c">foo')</span>
            <span class="c">self.assertEqual(cookies</span><span class="pc">[</span><span class="c">0</span><span class="pc">].</span><span class="w">v</span><span class="c">alue</span><span class="w">,</span><span class="pc"> '</span><span class="c">1')</span>

        <span class="w">d</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">_checkCookie</span><span class="c">)</span>

        <span class="w">req</span><span class="pc">,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">pr</span><span class="pc">otoc</span><span class="c">ol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="c">op</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span><span class="w">req</span><span class="c">.</span><span class="w">h</span><span class="pc">ea</span><span class="c">ders.</span><span class="w">getRawHeaders</span><span class="pc">(b'</span><span class="w">co</span><span class="pc">okie</span><span class="w">'</span><span class="pc">),</span> <span class="pc">N</span><span class="c">one)</span>

        <span class="w">resp</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">Response</span><span class="c">(</span>
            <span class="w">(</span><span class="pc">b</span><span class="c">'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="pc">1,</span> <span class="pc">1),</span>
            <span class="w">2</span><span class="pc">00,</span>
            <span class="c">b'</span><span class="w">O</span><span class="c">K',</span>
            <span class="w">cl</span><span class="c">ient.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="w">Set</span><span class="pc">-</span><span class="w">Cookie': [</span><span class="pc">b</span><span class="c">'</span><span class="pc">f</span><span class="c">oo</span><span class="w">=</span><span class="pc">1</span><span class="w">',]}),</span>
            <span class="w">N</span><span class="pc">o</span><span class="c">ne</span><span class="w">)</span>
        <span class="w">res</span><span class="pc">.</span><span class="w">ca</span><span class="pc">llb</span><span class="c">ack(</span><span class="w">resp</span><span class="c">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>


    <span class="c">def</span> <span class="w">test_requestWithCookie</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="pc">ri</span> <span class="c">=</span> <span class="pc">b'h</span><span class="c">ttp://example.com</span><span class="w">:1</span><span class="pc">2</span><span class="c">34/foo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="w">'</span>
        <span class="w">co</span><span class="pc">o</span><span class="c">kie</span> <span class="c">=</span> <span class="pc">b</span><span class="c">'</span><span class="pc">f</span><span class="c">oo</span><span class="w">=</span><span class="c">1</span><span class="pc">'</span>

        <span class="w">cookieJar</span> <span class="c">=</span> <span class="w">cookielib</span><span class="pc">.</span><span class="w">CookieJar</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">addCookies</span><span class="c">(</span><span class="w">c</span><span class="pc">ookieJ</span><span class="c">ar,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="w">, [co</span><span class="pc">okie]</span><span class="c">)</span>
        <span class="c">self.assertEqual(len(</span><span class="w">l</span><span class="pc">i</span><span class="c">st(</span><span class="pc">c</span><span class="c">ookieJar</span><span class="pc">)),</span> <span class="c">1</span><span class="pc">)</span>

        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">)</span>
        <span class="w">cookieAgent</span> <span class="c">=</span> <span class="w">cl</span><span class="c">ient.</span><span class="w">CookieAgent</span><span class="c">(</span><span class="w">ag</span><span class="c">ent</span><span class="pc">,</span> <span class="pc">c</span><span class="c">ookieJar)</span>
        <span class="w">c</span><span class="c">ookieAgent.</span><span class="w">req</span><span class="c">uest(</span><span class="pc">b'G</span><span class="c">ET',</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.protocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">.</span><span class="w">getRawHeaders</span><span class="pc">(</span><span class="c">b</span><span class="pc">'</span><span class="w">co</span><span class="pc">okie</span><span class="w">'), [coo</span><span class="pc">kie</span><span class="w">]</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_secureCookie</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="pc">ri</span> <span class="c">=</span> <span class="pc">b</span><span class="c">'</span><span class="w">https:</span><span class="c">//example.com</span><span class="pc">:</span><span class="w">1</span><span class="pc">2</span><span class="c">34</span><span class="pc">/f</span><span class="c">oo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="w">'</span>
        <span class="w">co</span><span class="pc">o</span><span class="c">kie</span> <span class="c">=</span> <span class="c">b'foo</span><span class="pc">=1;</span><span class="w">secure'</span>

        <span class="w">cookieJar</span> <span class="c">=</span> <span class="w">cookielib</span><span class="c">.</span><span class="w">CookieJar</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">addCookies</span><span class="pc">(c</span><span class="c">ookieJar,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="w">, </span><span class="pc">[</span><span class="w">co</span><span class="pc">okie]</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="pc">l</span><span class="c">en(</span><span class="w">l</span><span class="pc">i</span><span class="c">st(</span><span class="pc">c</span><span class="c">ookieJar</span><span class="pc">)),</span> <span class="pc">1)</span>

        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="pc">sel</span><span class="c">f.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">)</span>
        <span class="w">cookieAgent</span> <span class="c">=</span> <span class="w">cl</span><span class="c">ient.</span><span class="w">CookieAgent</span><span class="c">(</span><span class="w">ag</span><span class="c">ent</span><span class="pc">,</span> <span class="pc">c</span><span class="c">ookieJar)</span>
        <span class="w">c</span><span class="c">ookieAgent.</span><span class="w">req</span><span class="c">uest(</span><span class="pc">b'G</span><span class="c">ET',</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.protocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">.</span><span class="w">getRawHeaders</span><span class="pc">(</span><span class="c">b</span><span class="pc">'</span><span class="w">co</span><span class="pc">okie</span><span class="w">'), [</span><span class="c">b'</span><span class="w">f</span><span class="c">oo</span><span class="w">=1'</span><span class="pc">]</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_secureCookieOnInsecureConnection</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="c">ri</span> <span class="c">=</span> <span class="pc">b</span><span class="c">'</span><span class="pc">h</span><span class="c">ttp://example.com/foo</span><span class="w">?b</span><span class="pc">a</span><span class="c">r</span><span class="w">'</span>
        <span class="w">co</span><span class="pc">o</span><span class="c">kie</span> <span class="c">=</span> <span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="pc">=1</span><span class="w">;secure'</span>

        <span class="w">cookieJar</span> <span class="c">=</span> <span class="w">cookielib</span><span class="c">.</span><span class="w">CookieJar</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">addCookies</span><span class="c">(</span><span class="pc">c</span><span class="c">ookieJar,</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="w">, </span><span class="pc">[</span><span class="w">co</span><span class="pc">okie]</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="pc">l</span><span class="c">en(</span><span class="w">l</span><span class="pc">i</span><span class="c">st(</span><span class="pc">c</span><span class="c">ookieJar</span><span class="pc">)),</span> <span class="pc">1)</span>

        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="pc">sel</span><span class="c">f.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">)</span>
        <span class="w">cookieAgent</span> <span class="c">=</span> <span class="w">cl</span><span class="c">ient.</span><span class="w">CookieAgent</span><span class="c">(</span><span class="w">ag</span><span class="c">ent</span><span class="pc">,</span> <span class="pc">c</span><span class="c">ookieJar)</span>
        <span class="w">c</span><span class="c">ookieAgent.</span><span class="w">req</span><span class="c">uest(</span><span class="pc">b'G</span><span class="c">ET',</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.protocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="w">N</span><span class="c">one,</span> <span class="w">req</span><span class="c">.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">.</span><span class="w">getRawHeaders</span><span class="pc">(</span><span class="c">b'</span><span class="w">co</span><span class="pc">okie</span><span class="w">'</span><span class="pc">))</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_portCookie</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="pc">ri</span> <span class="c">=</span> <span class="pc">b</span><span class="c">'</span><span class="w">https:</span><span class="c">//example.com</span><span class="w">:1</span><span class="pc">2</span><span class="c">34/</span><span class="pc">f</span><span class="c">oo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="w">'</span>
        <span class="w">co</span><span class="pc">o</span><span class="c">kie</span> <span class="c">=</span> <span class="pc">b</span><span class="c">'</span><span class="pc">f</span><span class="c">oo</span><span class="pc">=1;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt=</span><span class="w">1</span><span class="pc">23</span><span class="c">4</span><span class="pc">'</span>

        <span class="w">cookieJar</span> <span class="c">=</span> <span class="w">cookielib</span><span class="pc">.</span><span class="w">CookieJar</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">addCookies</span><span class="pc">(</span><span class="w">c</span><span class="c">ookieJar,</span> <span class="w">u</span><span class="c">ri</span><span class="w">, </span><span class="pc">[</span><span class="w">co</span><span class="pc">okie]</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="pc">l</span><span class="c">en(</span><span class="w">l</span><span class="pc">is</span><span class="c">t(</span><span class="pc">c</span><span class="c">ookieJar</span><span class="pc">)),</span> <span class="c">1</span><span class="pc">)</span>

        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">)</span>
        <span class="w">cookieAgent</span> <span class="c">=</span> <span class="w">cl</span><span class="c">ient.</span><span class="w">CookieAgent</span><span class="c">(</span><span class="w">ag</span><span class="c">ent</span><span class="pc">,</span> <span class="pc">c</span><span class="c">ookieJar)</span>
        <span class="w">c</span><span class="c">ookieAgent.</span><span class="w">req</span><span class="c">uest(</span><span class="pc">b'G</span><span class="c">ET',</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.protocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">.</span><span class="w">getRawHeaders</span><span class="pc">(</span><span class="c">b</span><span class="pc">'</span><span class="w">co</span><span class="pc">okie</span><span class="w">'), [</span><span class="c">b'</span><span class="w">f</span><span class="c">oo</span><span class="w">=1'</span><span class="pc">]</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_portCookieOnWrongPort</span><span class="c">(self):</span>
        
        <span class="w">u</span><span class="c">ri</span> <span class="c">=</span> <span class="pc">b</span><span class="c">'</span><span class="w">https:</span><span class="c">//example.com</span><span class="w">:4567</span><span class="pc">/f</span><span class="c">oo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="w">'</span>
        <span class="w">co</span><span class="pc">o</span><span class="c">kie</span> <span class="c">=</span> <span class="c">b'foo</span><span class="pc">=</span><span class="w">1</span><span class="pc">;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt=</span><span class="w">1</span><span class="pc">23</span><span class="c">4</span><span class="pc">'</span>

        <span class="w">cookieJar</span> <span class="c">=</span> <span class="w">cookielib</span><span class="pc">.</span><span class="w">CookieJar</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">addCookies</span><span class="pc">(</span><span class="w">c</span><span class="c">ookieJar,</span> <span class="w">u</span><span class="c">ri</span><span class="w">, </span><span class="pc">[</span><span class="w">co</span><span class="pc">okie]</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="pc">l</span><span class="c">en(</span><span class="w">l</span><span class="pc">is</span><span class="c">t(</span><span class="pc">c</span><span class="c">ookieJar</span><span class="pc">)),</span> <span class="w">0)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">Decoder1</span><span class="c">(</span><span class="w">proxyForInterface(IResponse)</span><span class="pc">)</span><span class="c">:</span>
    



<span class="pc">c</span><span class="c">lass</span> <span class="w">Decoder2</span><span class="c">(</span><span class="w">D</span><span class="c">ecoder1):</span>
    



<span class="pc">c</span><span class="c">lass</span> <span class="w">ContentDecoderAgentTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="pc">,</span>
                               <span class="w">AgentTestsMixin</span><span class="pc">)</span><span class="c">:</span>
    
    <span class="pc">d</span><span class="c">ef</span> <span class="w">makeAgent</span><span class="c">(self):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent.</span><span class="w">ContentDecoderAgent</span><span class="c">(self.</span><span class="w">ag</span><span class="c">ent</span><span class="w">, [</span><span class="pc">]</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">s</span><span class="c">etUp(self):</span>
        
        <span class="c">self.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span> <span class="c">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="c">eactor</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_acceptHeaders</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">C</span><span class="pc">o</span><span class="c">ntentDecoderAgent</span><span class="pc">(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent</span><span class="w">, [(</span><span class="pc">b'</span><span class="w">decoder1</span><span class="c">',</span> <span class="w">Decoder1),</span><span class="pc"> </span><span class="c">(</span><span class="pc">b</span><span class="c">'</span><span class="w">decoder2</span><span class="c">',</span> <span class="w">Decoder2)</span><span class="pc">]</span><span class="c">)</span>

        <span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest(b'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="pc">/f</span><span class="c">oo</span><span class="pc">'</span><span class="c">)</span>

        <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">p</span><span class="c">rotocol</span>

        <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">req</span><span class="pc">uests</span><span class="c">),</span> <span class="pc">1</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders.</span><span class="w">getRawHeaders</span><span class="pc">(</span><span class="c">b</span><span class="pc">'</span><span class="w">accept</span><span class="c">-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">')</span><span class="pc">,</span>
                         <span class="w">[</span><span class="c">b</span><span class="pc">'</span><span class="w">decoder1,decoder2']</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_existingHeaders</span><span class="c">(self):</span>
        
        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="c">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="c">eaders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="c">b'</span><span class="w">b</span><span class="c">ar</span><span class="w">']</span><span class="pc">,</span>
                                        <span class="c">b'</span><span class="w">a</span><span class="pc">c</span><span class="c">cept</span><span class="w">-e</span><span class="pc">n</span><span class="c">coding</span><span class="w">':</span><span class="pc"> </span><span class="c">[b'</span><span class="w">fizz']})</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">ContentDecoderAgent</span><span class="c">(</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent</span><span class="w">, [(</span><span class="c">b'</span><span class="w">decoder1</span><span class="pc">'</span><span class="c">,</span> <span class="w">Decoder1),</span><span class="pc"> </span><span class="c">(b'</span><span class="w">decoder2</span><span class="c">',</span> <span class="w">Decoder2)</span><span class="pc">]</span><span class="c">)</span>
        <span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest(b'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">=</span><span class="w">h</span><span class="pc">e</span><span class="c">aders)</span>

        <span class="w">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span>

        <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="w">l</span><span class="c">en(</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="c">),</span> <span class="w">1</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>
        <span class="c">self.assertEqual(</span>
            <span class="w">l</span><span class="pc">i</span><span class="c">st(</span><span class="w">sorted(req</span><span class="c">.</span><span class="w">h</span><span class="c">eaders</span><span class="w">.getAllRawHeaders())),</span>
            <span class="w">[</span><span class="c">(b'</span><span class="w">Accept</span><span class="pc">-</span><span class="w">Encoding', [</span><span class="pc">b</span><span class="c">'</span><span class="w">fizz</span><span class="c">',</span> <span class="pc">b</span><span class="c">'</span><span class="w">decoder1,decoder2']),</span>
             <span class="w">(</span><span class="c">b'</span><span class="w">F</span><span class="c">oo</span><span class="w">',</span><span class="pc"> [b</span><span class="c">'</span><span class="w">b</span><span class="pc">ar</span><span class="w">']</span><span class="pc">),</span>
             <span class="w">(</span><span class="c">b'</span><span class="w">Host',</span><span class="pc"> </span><span class="c">[b'</span><span class="pc">e</span><span class="c">xample.com</span><span class="w">'])])</span>


    <span class="c">def</span> <span class="w">test_plainEncodingResponse</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ContentDecoderAgent</span><span class="c">(</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent</span><span class="w">, [(</span><span class="c">b'</span><span class="w">decoder1</span><span class="c">',</span> <span class="w">Decoder1),</span><span class="pc"> </span><span class="c">(b'</span><span class="w">decoder2</span><span class="c">',</span> <span class="w">Decoder2)</span><span class="pc">]</span><span class="c">)</span>
        <span class="w">def</span><span class="pc">err</span><span class="c">ed</span> <span class="c">=</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest(b'</span><span class="pc">G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">')</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="pc">res</span><span class="c">ponse</span> <span class="pc">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="c">1</span><span class="pc">),</span> <span class="w">2</span><span class="pc">00,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">',</span> <span class="w">http_headers.H</span><span class="pc">e</span><span class="c">aders</span><span class="pc">(),</span>
                            <span class="pc">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="c">allback(</span><span class="pc">r</span><span class="c">esponse)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">eferr</span><span class="c">ed</span><span class="pc">.</span><span class="c">addCallback(self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical</span><span class="pc">,</span> <span class="pc">res</span><span class="c">ponse</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_unsupportedEncoding</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ContentDecoderAgent</span><span class="pc">(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent</span><span class="w">, [(</span><span class="pc">b</span><span class="c">'</span><span class="w">decoder1</span><span class="pc">',</span> <span class="w">Decoder1),</span><span class="pc"> </span><span class="c">(</span><span class="pc">b</span><span class="c">'</span><span class="w">decoder2</span><span class="c">',</span> <span class="w">Decoder2)</span><span class="pc">]</span><span class="c">)</span>
        <span class="w">def</span><span class="pc">err</span><span class="c">ed</span> <span class="pc">=</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest(b'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">')</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="pc">b</span><span class="c">'bar</span><span class="w">']</span><span class="pc">,</span>
                                        <span class="c">b'</span><span class="w">c</span><span class="c">ontent</span><span class="pc">-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">':</span><span class="pc"> [</span><span class="c">b'</span><span class="w">fizz']})</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">',</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1),</span> <span class="w">2</span><span class="pc">00,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">'</span><span class="c">,</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="pc">ret</span><span class="c">urn</span> <span class="w">d</span><span class="pc">eferr</span><span class="c">ed</span><span class="pc">.</span><span class="c">addCallback(self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical</span><span class="pc">,</span> <span class="pc">res</span><span class="c">ponse</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_unknownEncoding</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ContentDecoderAgent</span><span class="pc">(</span>
            <span class="c">self.</span><span class="w">ag</span><span class="c">ent</span><span class="w">, [(</span><span class="c">b'</span><span class="w">decoder1</span><span class="pc">'</span><span class="c">,</span> <span class="w">Decoder1),</span><span class="pc"> </span><span class="c">(</span><span class="pc">b</span><span class="c">'</span><span class="w">decoder2</span><span class="c">',</span> <span class="w">Decoder2)</span><span class="pc">]</span><span class="c">)</span>
        <span class="w">def</span><span class="pc">err</span><span class="c">ed</span> <span class="pc">=</span> <span class="w">a</span><span class="pc">g</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest(b'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">')</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="pc">b</span><span class="c">'bar</span><span class="w">']</span><span class="pc">,</span>
                                        <span class="c">b'</span><span class="w">c</span><span class="c">ontent</span><span class="pc">-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">':</span>
                                        <span class="w">[</span><span class="c">b'</span><span class="w">decoder1,fizz</span><span class="pc">,</span><span class="w">decoder2']})</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="pc">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="pc">1,</span> <span class="c">1),</span> <span class="w">2</span><span class="pc">00</span><span class="c">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">'</span><span class="c">,</span> <span class="w">h</span><span class="c">eaders</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="c">allback(</span><span class="w">r</span><span class="c">esponse)</span>

        <span class="c">def</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="w">res</span><span class="pc">ult</span><span class="c">):</span>
            <span class="c">self.</span><span class="w">assertNotIdentical</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse</span><span class="pc">,</span> <span class="w">res</span><span class="pc">u</span><span class="c">lt)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">as</span><span class="pc">sertIs</span><span class="c">Instance(</span><span class="w">r</span><span class="pc">esu</span><span class="c">lt,</span> <span class="w">Decoder2</span><span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.assertEqual</span><span class="pc">([</span><span class="w">b</span><span class="pc">'</span><span class="w">decoder1,fizz']</span><span class="c">,</span>
                             <span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">.</span><span class="w">h</span><span class="c">eaders</span><span class="w">.getRawHeaders</span><span class="pc">(</span><span class="c">b</span><span class="pc">'c</span><span class="c">ontent-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">')</span><span class="pc">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="w">de</span><span class="pc">ferr</span><span class="c">ed</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="c">heck)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">SimpleAgentProtocol</span><span class="c">(</span><span class="w">P</span><span class="c">rotocol):</span>
    

    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self):</span>
        <span class="c">self.</span><span class="w">made</span> <span class="c">=</span> <span class="w">D</span><span class="pc">e</span><span class="c">ferred()</span>
        <span class="c">self.</span><span class="w">fi</span><span class="pc">n</span><span class="c">ished</span> <span class="c">=</span> <span class="w">D</span><span class="c">eferred()</span>
        <span class="c">self.</span><span class="w">rec</span><span class="c">eived</span> <span class="pc">= </span><span class="c">[]</span>


    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        <span class="c">self.</span><span class="pc">m</span><span class="c">ade</span><span class="pc">.c</span><span class="c">allback(</span><span class="pc">N</span><span class="c">one)</span>


    <span class="c">def</span> <span class="c">connectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">i</span><span class="c">nished.</span><span class="pc">c</span><span class="c">allback(None)</span>


    <span class="c">def</span> <span class="pc">d</span><span class="c">ataReceived(self,</span> <span class="pc">d</span><span class="c">ata):</span>
        <span class="c">self.</span><span class="w">r</span><span class="pc">ec</span><span class="c">eived.append(data)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ContentDecoderAgentWithGzipTests</span><span class="c">(</span><span class="w">T</span><span class="c">estCase</span><span class="pc">,</span>
                                       <span class="w">FakeReactorAndConnectMixin</span><span class="c">):</span>

    <span class="c">def</span> <span class="c">setUp(self):</span>
        
        <span class="c">self.</span><span class="w">r</span><span class="c">eactor</span> <span class="c">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="c">()</span>
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(self.</span><span class="w">r</span><span class="c">eactor)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ContentDecoderAgent</span><span class="pc">(</span>
            <span class="w">ag</span><span class="c">ent</span><span class="w">, [(</span><span class="pc">b"</span><span class="w">gzip</span><span class="pc">",</span> <span class="w">c</span><span class="c">lient.</span><span class="w">GzipDecoder)]</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_gzipEncodingResponse</span><span class="c">(self):</span>
        
        <span class="w">de</span><span class="pc">fe</span><span class="c">rred</span> <span class="c">=</span> <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="c">equest(b'GET',</span> <span class="c">b'</span><span class="pc">h</span><span class="c">ttp://example.com/foo</span><span class="pc">')</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="pc">b</span><span class="c">'bar</span><span class="w">']</span><span class="pc">,</span>
                                        <span class="c">b'</span><span class="w">c</span><span class="c">ontent</span><span class="pc">-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">':</span><span class="pc"> [</span><span class="c">b'</span><span class="w">gzip']})</span>
        <span class="w">tr</span><span class="c">ansport</span> <span class="pc">=</span> <span class="pc">S</span><span class="c">tringTransport()</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="pc">b</span><span class="c">'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1),</span> <span class="w">2</span><span class="pc">00</span><span class="c">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">'</span><span class="c">,</span> <span class="w">h</span><span class="c">eaders</span><span class="pc">,</span> <span class="w">t</span><span class="c">ransport</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth</span> <span class="c">=</span> <span class="w">1</span><span class="pc">2</span>
        <span class="w">res</span><span class="pc">.</span><span class="w">c</span><span class="c">allback(</span><span class="pc">r</span><span class="c">esponse)</span>

        <span class="w">compressor</span> <span class="c">=</span> <span class="w">zlib</span><span class="pc">.</span><span class="w">compressobj</span><span class="pc">(</span><span class="w">2</span><span class="c">,</span> <span class="w">z</span><span class="c">lib</span><span class="pc">.</span><span class="w">DEFLATED</span><span class="pc">,</span> <span class="w">1</span><span class="pc">6</span> <span class="w">+</span> <span class="w">z</span><span class="c">lib</span><span class="pc">.</span><span class="w">MAX_WBITS</span><span class="pc">)</span>
        <span class="w">da</span><span class="c">ta</span> <span class="w">=</span><span class="pc"> (c</span><span class="c">ompressor.</span><span class="w">compress</span><span class="c">(</span><span class="w">b</span><span class="pc">'</span><span class="w">x</span><span class="pc">' </span><span class="c">*</span> <span class="w">6)</span><span class="pc"> </span><span class="c">+</span> <span class="c">compressor</span><span class="pc">.</span><span class="w">c</span><span class="pc">ompress</span><span class="c">(</span><span class="pc">b</span><span class="c">'</span><span class="w">y'</span><span class="pc"> </span><span class="c">*</span> <span class="w">4)</span><span class="pc"> </span><span class="c">+</span>
                <span class="c">compressor</span><span class="pc">.</span><span class="w">fl</span><span class="pc">u</span><span class="c">sh</span><span class="pc">())</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">checkResponse</span><span class="c">(</span><span class="w">re</span><span class="pc">sult</span><span class="c">):</span>
            <span class="c">self.</span><span class="w">assertNotIdentical</span><span class="c">(</span><span class="w">r</span><span class="pc">esu</span><span class="c">lt</span><span class="pc">,</span> <span class="w">r</span><span class="pc">espo</span><span class="c">nse)</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">r</span><span class="c">esult.</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span><span class="w">, (</span><span class="pc">b</span><span class="c">'</span><span class="w">H</span><span class="pc">T</span><span class="c">TP</span><span class="pc">',</span> <span class="c">1</span><span class="pc">,</span> <span class="c">1))</span>
            <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">esu</span><span class="c">lt.</span><span class="w">c</span><span class="c">ode,</span> <span class="pc">2</span><span class="c">00)</span>
            <span class="c">self.assertEqual(</span><span class="pc">r</span><span class="c">esult.</span><span class="w">phrase</span><span class="pc">,</span> <span class="pc">b</span><span class="c">'</span><span class="w">O</span><span class="c">K')</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">l</span><span class="pc">i</span><span class="c">st(result.</span><span class="w">h</span><span class="c">eaders</span><span class="pc">.</span><span class="w">getAllRawHeaders(</span><span class="pc">)),</span>
                              <span class="w">[</span><span class="c">(b</span><span class="pc">'</span><span class="w">F</span><span class="c">oo</span><span class="w">', [</span><span class="c">b'</span><span class="w">b</span><span class="pc">ar</span><span class="w">'])])</span>
            <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="w">res</span><span class="pc">u</span><span class="c">lt.</span><span class="w">le</span><span class="pc">ng</span><span class="c">th,</span> <span class="w">UNKNOWN_LENGTH</span><span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertR</span><span class="c">aises(</span><span class="w">A</span><span class="c">ttributeError,</span> <span class="w">g</span><span class="pc">eta</span><span class="c">ttr</span><span class="pc">,</span> <span class="pc">r</span><span class="c">esult</span><span class="w">,</span><span class="pc"> '</span><span class="w">unknown</span><span class="c">')</span>

            <span class="w">r</span><span class="pc">esp</span><span class="c">onse</span><span class="pc">.</span><span class="w">_bodyDataReceived</span><span class="c">(</span><span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="w">[</span><span class="pc">:</span><span class="w">5</span><span class="c">])</span>
            <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span><span class="pc">.</span><span class="w">_</span><span class="c">bodyDataReceived</span><span class="pc">(d</span><span class="c">ata</span><span class="pc">[</span><span class="w">5:</span><span class="pc">])</span>
            <span class="pc">res</span><span class="c">ponse.</span><span class="w">_bodyDataFinished</span><span class="pc">()</span>

            <span class="w">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">SimpleAgentProtocol</span><span class="pc">()</span>
            <span class="w">r</span><span class="pc">esu</span><span class="c">lt.</span><span class="w">deliverBody</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol)</span>

            <span class="c">self.assertEqual(protocol.</span><span class="w">r</span><span class="pc">ec</span><span class="c">eived</span><span class="pc">, </span><span class="c">[b'</span><span class="w">x</span><span class="pc">'</span><span class="c"> *</span> <span class="w">6</span> <span class="w">+</span> <span class="pc">b</span><span class="c">'</span><span class="w">y</span><span class="pc">' </span><span class="c">*</span> <span class="w">4</span><span class="pc">]</span><span class="c">)</span>
            <span class="pc">ret</span><span class="c">urn</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">g</span><span class="c">atherResults</span><span class="pc">([p</span><span class="c">rotocol.</span><span class="w">made</span><span class="c">,</span> <span class="pc">p</span><span class="c">rotocol.</span><span class="w">f</span><span class="pc">i</span><span class="c">nished</span><span class="w">]</span><span class="c">)</span>

        <span class="w">de</span><span class="pc">fe</span><span class="c">rred.addCallback(</span><span class="w">checkResponse</span><span class="c">)</span>

        <span class="c">return</span> <span class="w">d</span><span class="pc">eferr</span><span class="c">ed</span>


    <span class="c">def</span> <span class="w">test_brokenContent</span><span class="c">(self):</span>
        
        <span class="w">d</span><span class="pc">efe</span><span class="c">rred</span> <span class="c">=</span> <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="pc">r</span><span class="c">equest(b'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="pc">/</span><span class="c">foo</span><span class="pc">')</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="pc">b</span><span class="c">'bar</span><span class="w">']</span><span class="pc">,</span>
                                        <span class="c">b'</span><span class="w">c</span><span class="c">ontent</span><span class="pc">-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">':</span><span class="pc"> [</span><span class="c">b'</span><span class="w">gzip']})</span>
        <span class="w">tr</span><span class="c">ansport</span> <span class="pc">=</span> <span class="pc">S</span><span class="c">tringTransport()</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="pc">b</span><span class="c">'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1),</span> <span class="w">2</span><span class="pc">00</span><span class="c">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">'</span><span class="c">,</span> <span class="w">h</span><span class="c">eaders</span><span class="pc">,</span> <span class="w">t</span><span class="c">ransport</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse.</span><span class="w">l</span><span class="pc">e</span><span class="c">ngth</span> <span class="c">=</span> <span class="w">1</span><span class="pc">2</span>
        <span class="w">res</span><span class="pc">.</span><span class="w">c</span><span class="c">allback(</span><span class="pc">r</span><span class="c">esponse)</span>

        <span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="c">=</span> <span class="c">b</span><span class="pc">"</span><span class="w">n</span><span class="pc">ot</span> <span class="w">gzipped</span> <span class="w">c</span><span class="c">ontent</span><span class="w">"</span>

        <span class="w">de</span><span class="c">f</span> <span class="w">checkResponse</span><span class="c">(</span><span class="w">r</span><span class="pc">esu</span><span class="c">lt):</span>
            <span class="w">r</span><span class="pc">esp</span><span class="c">onse.</span><span class="w">_bodyDataReceived</span><span class="c">(</span><span class="pc">d</span><span class="c">ata)</span>

            <span class="w">re</span><span class="pc">su</span><span class="c">lt.</span><span class="w">deliverBody</span><span class="c">(</span><span class="w">P</span><span class="c">rotocol</span><span class="pc">(</span><span class="c">))</span>

        <span class="w">d</span><span class="pc">efe</span><span class="c">rred.addCallback(</span><span class="w">c</span><span class="pc">heckR</span><span class="c">esponse)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">ssertFai</span><span class="c">lure(</span><span class="w">d</span><span class="pc">eferr</span><span class="c">ed,</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">ResponseFailed</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">checkFailure</span><span class="c">(</span><span class="w">er</span><span class="pc">ror</span><span class="c">):</span>
            <span class="w">e</span><span class="c">rror</span><span class="pc">.</span><span class="w">reasons[</span><span class="c">0].</span><span class="w">t</span><span class="pc">rap</span><span class="c">(</span><span class="w">zlib</span><span class="pc">.</span><span class="w">e</span><span class="pc">rror</span><span class="c">)</span>
            <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">e</span><span class="pc">r</span><span class="c">ror.</span><span class="w">res</span><span class="pc">p</span><span class="c">onse,</span> <span class="w">Response</span><span class="c">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">eferr</span><span class="c">ed</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="c">heckFailure)</span>


    <span class="c">def</span> <span class="w">test_flushData</span><span class="c">(self):</span>
        
        <span class="w">c</span><span class="c">lass</span> <span class="w">decompressobj</span><span class="c">(object):</span>

            <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">wbits</span><span class="c">):</span>
                <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

            <span class="c">def</span> <span class="w">decompress</span><span class="c">(self</span><span class="pc">,</span> <span class="pc">d</span><span class="c">ata):</span>
                <span class="pc">re</span><span class="c">turn</span> <span class="w">b</span><span class="c">'</span><span class="w">x'</span>

            <span class="c">def</span> <span class="w">fl</span><span class="c">ush(self):</span>
                <span class="c">return</span> <span class="w">b</span><span class="c">'</span><span class="w">y</span><span class="pc">'</span>


        <span class="w">oldDecompressObj</span> <span class="c">=</span> <span class="w">zlib</span><span class="pc">.</span><span class="w">de</span><span class="pc">compresso</span><span class="c">bj</span>
        <span class="w">z</span><span class="c">lib</span><span class="w">.d</span><span class="pc">ecom</span><span class="c">pressobj</span> <span class="c">=</span> <span class="w">d</span><span class="pc">ecompresso</span><span class="c">bj</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">ad</span><span class="c">dCleanup(</span><span class="w">setattr</span><span class="pc">,</span> <span class="c">zlib</span><span class="w">,</span><span class="pc"> '</span><span class="w">d</span><span class="pc">ecompresso</span><span class="c">bj',</span> <span class="c">oldDecompressObj)</span>

        <span class="w">def</span><span class="pc">err</span><span class="c">ed</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest(</span><span class="w">b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">')</span>

        <span class="w">re</span><span class="pc">q,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="w">c</span><span class="c">ontent-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">': [</span><span class="c">b'</span><span class="w">gzip']})</span>
        <span class="w">t</span><span class="pc">r</span><span class="c">ansport</span> <span class="pc">=</span> <span class="pc">S</span><span class="c">tringTransport()</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="pc">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1),</span> <span class="w">2</span><span class="pc">0</span><span class="c">0,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders,</span> <span class="w">t</span><span class="c">ransport</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="c">def</span> <span class="w">checkResponse</span><span class="c">(</span><span class="w">resu</span><span class="pc">lt</span><span class="c">):</span>
            <span class="w">r</span><span class="pc">es</span><span class="c">ponse.</span><span class="w">_bodyDataReceived</span><span class="c">(b'</span><span class="w">d</span><span class="c">ata</span><span class="pc">')</span>
            <span class="w">r</span><span class="pc">es</span><span class="c">ponse.</span><span class="w">_bodyDataFinished</span><span class="pc">()</span>

            <span class="pc">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">SimpleAgentProtocol</span><span class="c">()</span>
            <span class="w">res</span><span class="pc">u</span><span class="c">lt.</span><span class="w">deliverBody</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">)</span>

            <span class="c">self.assertEqual(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="w">r</span><span class="pc">ec</span><span class="c">eived</span><span class="pc">, </span><span class="c">[b'</span><span class="w">x</span><span class="pc">',</span> <span class="c">b'</span><span class="w">y</span><span class="pc">']</span><span class="c">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="c">efer.</span><span class="pc">g</span><span class="c">atherResults</span><span class="pc">([</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">made</span><span class="c">,</span> <span class="pc">p</span><span class="c">rotocol.</span><span class="w">f</span><span class="pc">i</span><span class="c">nished</span><span class="w">]</span><span class="c">)</span>

        <span class="w">d</span><span class="pc">efe</span><span class="c">rred.addCallback(</span><span class="w">checkResponse</span><span class="c">)</span>

        <span class="c">return</span> <span class="w">d</span><span class="pc">eferr</span><span class="c">ed</span>


    <span class="c">def</span> <span class="w">test_flushError</span><span class="c">(self):</span>
        
        <span class="w">c</span><span class="c">lass</span> <span class="w">decompressobj</span><span class="c">(object):</span>

            <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">wbits</span><span class="c">):</span>
                <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>

            <span class="c">def</span> <span class="w">decompress</span><span class="c">(self</span><span class="pc">,</span> <span class="pc">d</span><span class="c">ata):</span>
                <span class="pc">re</span><span class="c">turn</span> <span class="w">b</span><span class="pc">'</span><span class="w">x'</span>

            <span class="c">def</span> <span class="w">fl</span><span class="c">ush(self):</span>
                <span class="pc">ra</span><span class="c">ise</span> <span class="w">zlib.e</span><span class="pc">rro</span><span class="c">r</span><span class="w">(</span><span class="pc">)</span>


        <span class="w">oldDecompressObj</span> <span class="c">=</span> <span class="w">z</span><span class="c">lib.</span><span class="w">de</span><span class="pc">compresso</span><span class="c">bj</span>
        <span class="w">z</span><span class="c">lib</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">compressobj</span> <span class="c">=</span> <span class="w">d</span><span class="pc">ecompresso</span><span class="c">bj</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">ad</span><span class="c">dCleanup(</span><span class="w">setattr</span><span class="pc">,</span> <span class="pc">z</span><span class="c">lib</span><span class="w">,</span><span class="pc"> '</span><span class="w">d</span><span class="pc">ecompresso</span><span class="c">bj',</span> <span class="c">oldDecompressObj)</span>

        <span class="w">def</span><span class="pc">err</span><span class="c">ed</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">req</span><span class="c">uest(</span><span class="w">b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">')</span>

        <span class="w">re</span><span class="pc">q,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">({</span><span class="c">b'</span><span class="w">c</span><span class="c">ontent-</span><span class="w">e</span><span class="pc">n</span><span class="c">coding</span><span class="w">': [</span><span class="c">b'</span><span class="w">gzip']})</span>
        <span class="w">t</span><span class="pc">r</span><span class="c">ansport</span> <span class="pc">=</span> <span class="pc">S</span><span class="c">tringTransport()</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="pc">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1),</span> <span class="w">2</span><span class="pc">0</span><span class="c">0,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders,</span> <span class="w">t</span><span class="c">ransport</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="c">def</span> <span class="w">checkResponse</span><span class="c">(</span><span class="w">resu</span><span class="pc">lt</span><span class="c">):</span>
            <span class="w">r</span><span class="pc">es</span><span class="c">ponse.</span><span class="w">_bodyDataReceived</span><span class="c">(b'</span><span class="w">d</span><span class="c">ata</span><span class="pc">')</span>
            <span class="w">r</span><span class="pc">es</span><span class="c">ponse.</span><span class="w">_bodyDataFinished</span><span class="pc">()</span>

            <span class="pc">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">SimpleAgentProtocol</span><span class="c">()</span>
            <span class="w">res</span><span class="pc">u</span><span class="c">lt.</span><span class="w">deliverBody</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">)</span>

            <span class="c">self.assertEqual(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="w">r</span><span class="pc">ec</span><span class="c">eived</span><span class="pc">, </span><span class="c">[b'</span><span class="w">x</span><span class="pc">',</span> <span class="c">b'</span><span class="w">y</span><span class="pc">']</span><span class="c">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="c">efer.</span><span class="pc">g</span><span class="c">atherResults</span><span class="pc">([</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">made</span><span class="c">,</span> <span class="pc">p</span><span class="c">rotocol.</span><span class="w">f</span><span class="pc">i</span><span class="c">nished</span><span class="w">]</span><span class="c">)</span>

        <span class="w">d</span><span class="pc">efe</span><span class="c">rred.addCallback(</span><span class="w">checkResponse</span><span class="c">)</span>

        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">ssertF</span><span class="c">ailure(</span><span class="w">d</span><span class="pc">eferr</span><span class="c">ed,</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ResponseFailed</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">checkFailure</span><span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r):</span>
            <span class="w">e</span><span class="c">rror.</span><span class="w">reasons[</span><span class="pc">1</span><span class="c">].</span><span class="w">t</span><span class="pc">rap</span><span class="c">(</span><span class="w">zlib</span><span class="pc">.</span><span class="w">e</span><span class="pc">rror</span><span class="c">)</span>
            <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">e</span><span class="pc">r</span><span class="c">ror.</span><span class="w">res</span><span class="pc">p</span><span class="c">onse,</span> <span class="w">Response</span><span class="c">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">eferr</span><span class="c">ed</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="c">heckFailure)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ProxyAgentTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="pc">,</span> <span class="w">AgentTestsMixin</span><span class="c">):</span>
    
    <span class="pc">d</span><span class="c">ef</span> <span class="w">makeAgent</span><span class="c">(self):</span>
        
        <span class="pc">ret</span><span class="c">urn</span> <span class="w">c</span><span class="pc">li</span><span class="c">ent.</span><span class="w">ProxyAgent</span><span class="c">(</span>
            <span class="w">TCP4ClientEndpoint</span><span class="pc">(s</span><span class="c">elf.</span><span class="w">r</span><span class="c">eactor</span><span class="w">,</span><span class="pc"> "</span><span class="w">1</span><span class="c">27.0.0.1</span><span class="pc">",</span> <span class="w">1</span><span class="pc">234),</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">r</span><span class="c">eactor</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="pc">s</span><span class="c">etUp(self):</span>
        <span class="c">self.</span><span class="w">r</span><span class="c">eactor</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ProxyAgent</span><span class="pc">(</span>
            <span class="w">TCP4ClientEndpoint</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="c">eactor</span><span class="w">,</span><span class="pc"> "</span><span class="w">ba</span><span class="pc">r",</span> <span class="w">5678)</span><span class="pc">,</span> <span class="c">self.</span><span class="pc">r</span><span class="c">eactor)</span>
        <span class="w">oldEndpoint</span> <span class="c">=</span> <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_proxyEndpoint</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent</span><span class="pc">.</span><span class="w">_</span><span class="pc">p</span><span class="c">roxyEndpoint</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">StubEndpoint</span><span class="c">(</span><span class="pc">o</span><span class="c">ldEndpoint</span><span class="pc">,</span> <span class="c">self</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_proxyRequest</span><span class="c">(self):</span>
        
        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="c">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">ea</span><span class="c">ders</span><span class="w">({</span><span class="pc">b</span><span class="c">'foo</span><span class="w">': [</span><span class="pc">b</span><span class="c">'</span><span class="pc">b</span><span class="c">ar</span><span class="w">']})</span>
        
        
        <span class="w">bo</span><span class="c">dy</span> <span class="pc">=</span> <span class="w">o</span><span class="pc">b</span><span class="c">ject()</span>
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest(</span>
            <span class="c">b'</span><span class="pc">G</span><span class="c">ET</span><span class="pc">',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="w">:1</span><span class="pc">234/</span><span class="w">f</span><span class="c">oo</span><span class="w">?</span><span class="pc">ba</span><span class="c">r</span><span class="w">'</span><span class="pc">,</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="w">,</span> <span class="w">b</span><span class="pc">o</span><span class="c">dy</span><span class="pc">)</span>

        <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="c">port</span><span class="pc">,</span> <span class="w">f</span><span class="c">actory</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor.</span><span class="w">tcpClients.</span><span class="pc">p</span><span class="c">op</span><span class="w">()[:3</span><span class="pc">]</span>
        <span class="c">self.assertEqual(</span><span class="w">h</span><span class="c">ost</span><span class="w">,</span><span class="pc"> "</span><span class="w">b</span><span class="c">ar")</span>
        <span class="c">self.assertEqual(</span><span class="pc">p</span><span class="c">ort</span><span class="pc">,</span> <span class="w">5678</span><span class="pc">)</span>

        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertI</span><span class="c">sInstance(</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">_wrappedFactory</span><span class="c">,</span>
                              <span class="w">c</span><span class="c">lient.</span><span class="w">_HTTP11ClientFactory</span><span class="c">)</span>

        <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">p</span><span class="c">rotocol</span>

        
        <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="pc">l</span><span class="c">en(</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="c">),</span> <span class="pc">1</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="c">.</span><span class="w">p</span><span class="pc">o</span><span class="c">p</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">s</span><span class="c">Instance(</span><span class="w">req</span><span class="pc">,</span> <span class="w">R</span><span class="c">equest</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">m</span><span class="pc">et</span><span class="c">hod,</span> <span class="c">b'</span><span class="pc">G</span><span class="c">ET')</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(req.</span><span class="w">u</span><span class="c">ri,</span> <span class="c">b'</span><span class="pc">ht</span><span class="c">tp://example.com</span><span class="w">:1</span><span class="pc">234</span><span class="c">/</span><span class="w">f</span><span class="c">oo</span><span class="w">?b</span><span class="pc">a</span><span class="c">r')</span>
        <span class="c">self.assertEqual(</span>
            <span class="pc">r</span><span class="c">eq.</span><span class="w">h</span><span class="pc">e</span><span class="c">aders,</span>
            <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="c">eaders</span><span class="w">({</span><span class="c">b'</span><span class="pc">f</span><span class="c">oo</span><span class="w">': [</span><span class="pc">b</span><span class="c">'bar</span><span class="w">'</span><span class="pc">],</span>
                                  <span class="pc">b</span><span class="c">'</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="w">':</span><span class="pc"> [</span><span class="w">b</span><span class="c">'</span><span class="w">e</span><span class="c">xample.com</span><span class="pc">:</span><span class="w">1</span><span class="pc">23</span><span class="c">4</span><span class="w">']}))</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="pc">r</span><span class="c">eq.</span><span class="w">bodyProducer</span><span class="pc">,</span> <span class="w">b</span><span class="pc">ody</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_nonPersistent</span><span class="c">(self):</span>
        
        <span class="c">self.assertEqual(self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">_pool.persistent,</span> <span class="w">F</span><span class="c">alse)</span>


    <span class="c">def</span> <span class="w">test_connectUsesConnectionPool</span><span class="c">(self):</span>
        
        <span class="w">en</span><span class="c">dpoint</span> <span class="c">=</span> <span class="w">DummyEndpoint</span><span class="c">()</span>
        <span class="w">c</span><span class="c">lass</span> <span class="w">DummyPool</span><span class="c">(object):</span>
            <span class="w">conn</span><span class="pc">ecte</span><span class="c">d</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>
            <span class="w">p</span><span class="c">ersistent</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>
            <span class="c">def</span> <span class="w">getConnection</span><span class="c">(</span><span class="w">th</span><span class="c">is</span><span class="pc">,</span> <span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">ep</span><span class="c">):</span>
                <span class="w">th</span><span class="c">is.</span><span class="w">connecte</span><span class="c">d</span> <span class="pc">=</span> <span class="c">True</span>
                <span class="c">self.</span><span class="w">a</span><span class="pc">ssertI</span><span class="c">dentical(</span><span class="w">ep</span><span class="c">,</span> <span class="w">en</span><span class="pc">d</span><span class="c">point</span><span class="pc">)</span>
                
                
                
                <span class="c">self.assertEqual(</span><span class="w">k</span><span class="pc">e</span><span class="c">y</span><span class="w">, ("h</span><span class="pc">t</span><span class="c">tp</span><span class="w">-prox</span><span class="c">y</span><span class="pc">"</span><span class="c">,</span> <span class="w">en</span><span class="pc">dpoint</span><span class="w">)</span><span class="pc">)</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span><span class="c">efer.succeed(</span><span class="w">StubHTTPProtocol</span><span class="pc">(</span><span class="c">))</span>

        <span class="w">po</span><span class="pc">o</span><span class="c">l</span> <span class="c">=</span> <span class="w">DummyPool</span><span class="pc">()</span>
        <span class="w">a</span><span class="pc">g</span><span class="c">ent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ProxyAgent</span><span class="c">(</span><span class="w">en</span><span class="c">dpoint</span><span class="pc">,</span> <span class="c">self.</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">po</span><span class="pc">o</span><span class="c">l=</span><span class="w">po</span><span class="pc">o</span><span class="c">l)</span>
        <span class="c">self.</span><span class="w">assertI</span><span class="pc">d</span><span class="c">entical(</span><span class="w">po</span><span class="pc">o</span><span class="c">l</span><span class="pc">,</span> <span class="w">ag</span><span class="c">ent.</span><span class="w">_pool</span><span class="c">)</span>

        <span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">e</span><span class="c">quest</span><span class="pc">(b</span><span class="c">'GET',</span> <span class="c">b'</span><span class="pc">h</span><span class="c">ttp://</span><span class="pc">f</span><span class="c">oo</span><span class="w">/')</span>
        <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="w">ag</span><span class="c">ent.</span><span class="pc">_</span><span class="c">pool</span><span class="pc">.</span><span class="w">conn</span><span class="pc">ecte</span><span class="c">d,</span> <span class="w">T</span><span class="c">rue)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">_RedirectAgentTestsMixin</span><span class="c">(</span><span class="pc">o</span><span class="c">bject):</span>
    
    <span class="c">def</span> <span class="w">test_noRedirect</span><span class="c">(self):</span>
        
        <span class="w">d</span><span class="pc">efe</span><span class="c">rred</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent.</span><span class="pc">r</span><span class="c">equest(b</span><span class="pc">'G</span><span class="c">ET</span><span class="pc">',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com/foo</span><span class="pc">')</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders()</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="pc">=</span> <span class="w">Response((</span><span class="pc">b</span><span class="c">'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="pc">1,</span> <span class="pc">1),</span> <span class="w">2</span><span class="pc">0</span><span class="c">0,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="pc">.</span><span class="w">c</span><span class="c">allback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">0</span><span class="c">,</span> <span class="pc">l</span><span class="c">en(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">pr</span><span class="pc">otoc</span><span class="c">ol.</span><span class="w">req</span><span class="pc">uests))</span>
        <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">s</span><span class="c">uccessResultOf(</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="pc">resp</span><span class="c">onse</span><span class="pc">,</span> <span class="pc">r</span><span class="c">esult)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(result.</span><span class="w">previousResponse</span><span class="pc">,</span> <span class="pc">N</span><span class="c">one)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">_testRedirectDefault</span><span class="c">(self</span><span class="pc">,</span> <span class="w">c</span><span class="pc">od</span><span class="c">e</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest(</span><span class="w">b</span><span class="pc">'G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp</span><span class="pc">:</span><span class="c">//example.com</span><span class="pc">/f</span><span class="c">oo</span><span class="pc">'</span><span class="c">)</span>

        <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="pc">p</span><span class="c">ort</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor.</span><span class="w">tcpClients</span><span class="pc">.</span><span class="w">p</span><span class="pc">op</span><span class="w">()[:2</span><span class="pc">]</span>
        <span class="c">self.assertEqual</span><span class="w">("e</span><span class="c">xample.com</span><span class="pc">"</span><span class="c">,</span> <span class="w">h</span><span class="c">ost</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">8</span><span class="c">0,</span> <span class="pc">p</span><span class="c">ort)</span>

        <span class="w">req</span><span class="pc">,</span> <span class="w">res</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">pr</span><span class="pc">otoc</span><span class="c">ol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="w">(</span>
            <span class="w">{</span><span class="pc">b'</span><span class="w">location': [</span><span class="pc">b</span><span class="c">'</span><span class="w">https:</span><span class="pc">/</span><span class="c">/example.com</span><span class="pc">/b</span><span class="c">ar</span><span class="w">']})</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1</span><span class="c">),</span> <span class="w">c</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">'</span><span class="c">,</span> <span class="w">h</span><span class="c">eaders</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="pc">allb</span><span class="c">ack(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">req2,</span> <span class="w">res2</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="c">op</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="w">r</span><span class="pc">eq2.</span><span class="w">m</span><span class="c">ethod</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">b'/b</span><span class="c">ar',</span> <span class="w">r</span><span class="pc">eq</span><span class="c">2.</span><span class="w">u</span><span class="c">ri</span><span class="pc">)</span>

        <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="pc">p</span><span class="c">ort</span> <span class="c">=</span> <span class="c">self.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">sslClients.</span><span class="pc">p</span><span class="c">op</span><span class="w">()[:2</span><span class="pc">]</span>
        <span class="c">self.assertEqual</span><span class="pc">("</span><span class="w">e</span><span class="pc">xa</span><span class="c">mple.com</span><span class="pc">",</span> <span class="w">h</span><span class="c">ost</span><span class="pc">)</span>
        <span class="c">self.assertEqual(</span><span class="w">443</span><span class="pc">,</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_redirect301</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_testRedirectDefault</span><span class="c">(</span><span class="w">301</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_redirect302</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="pc">_</span><span class="c">testRedirectDefault</span><span class="pc">(</span><span class="w">302</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_redirect307</span><span class="c">(self):</span>
        
        <span class="c">self._testRedirectDefault(</span><span class="w">307</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">_testRedirectToGet</span><span class="c">(self</span><span class="pc">,</span> <span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="w">m</span><span class="pc">et</span><span class="c">hod):</span>
        
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">req</span><span class="c">uest(</span><span class="w">m</span><span class="pc">et</span><span class="c">hod</span><span class="pc">,</span> <span class="w">b</span><span class="c">'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">'</span><span class="c">)</span>

        <span class="w">req</span><span class="pc">,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="pc">(</span>
            <span class="w">{</span><span class="pc">b</span><span class="c">'</span><span class="w">location': [</span><span class="c">b'</span><span class="pc">h</span><span class="c">ttp://example.com/</span><span class="pc">b</span><span class="c">ar</span><span class="w">']})</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1</span><span class="c">),</span> <span class="w">c</span><span class="pc">od</span><span class="c">e</span><span class="pc">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">'</span><span class="c">,</span> <span class="w">h</span><span class="c">eaders</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">ca</span><span class="pc">llb</span><span class="c">ack(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">req2,</span> <span class="w">res2</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="c">op</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="w">r</span><span class="pc">eq2.</span><span class="w">m</span><span class="c">ethod</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">b'/b</span><span class="c">ar',</span> <span class="w">r</span><span class="pc">eq</span><span class="c">2.</span><span class="w">u</span><span class="c">ri</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_redirect303</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_testRedirectToGet</span><span class="pc">(</span><span class="w">303</span><span class="pc">,</span> <span class="c">b'</span><span class="w">POST</span><span class="pc">')</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_noLocationField</span><span class="c">(self):</span>
        
        <span class="w">de</span><span class="pc">fe</span><span class="c">rred</span> <span class="c">=</span> <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">equ</span><span class="c">est(</span><span class="pc">b'G</span><span class="c">ET',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com/foo</span><span class="pc">'</span><span class="c">)</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders()</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="pc">=</span> <span class="w">Response((</span><span class="pc">b</span><span class="c">'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="pc">1,</span> <span class="pc">1),</span> <span class="w">301</span><span class="c">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="pc">.</span><span class="w">c</span><span class="c">allback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">fail</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">failureResultOf</span><span class="c">(</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">,</span> <span class="w">c</span><span class="pc">li</span><span class="c">ent.</span><span class="w">ResponseFailed</span><span class="c">)</span>
        <span class="w">fai</span><span class="pc">l.</span><span class="w">v</span><span class="c">alue</span><span class="pc">.</span><span class="w">reasons[</span><span class="c">0</span><span class="pc">].</span><span class="w">t</span><span class="pc">rap</span><span class="c">(</span><span class="pc">e</span><span class="c">rror.</span><span class="w">RedirectWithNoLocation</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">b</span><span class="pc">'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">'</span><span class="c">,</span>
                         <span class="w">fa</span><span class="pc">il.</span><span class="w">v</span><span class="c">alue</span><span class="pc">.</span><span class="w">r</span><span class="pc">ea</span><span class="c">sons</span><span class="w">[</span><span class="c">0</span><span class="pc">].</span><span class="w">v</span><span class="c">alue</span><span class="w">.u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">301</span><span class="pc">,</span> <span class="w">fa</span><span class="pc">il</span><span class="c">.value</span><span class="w">.res</span><span class="c">ponse.</span><span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">_testPageRedirectFailure</span><span class="c">(self</span><span class="pc">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">m</span><span class="pc">et</span><span class="c">hod):</span>
        
        <span class="w">d</span><span class="pc">efe</span><span class="c">rred</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest(</span><span class="w">m</span><span class="pc">et</span><span class="c">hod</span><span class="pc">,</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="pc">/f</span><span class="c">oo</span><span class="pc">'</span><span class="c">)</span>

        <span class="w">req</span><span class="pc">,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders()</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="w">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="pc">1,</span> <span class="pc">1),</span> <span class="w">c</span><span class="pc">o</span><span class="c">de,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="pc">.</span><span class="w">c</span><span class="c">allback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">fail</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">failureResultOf</span><span class="c">(</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">,</span> <span class="w">c</span><span class="pc">li</span><span class="c">ent.</span><span class="w">ResponseFailed</span><span class="c">)</span>
        <span class="w">fai</span><span class="pc">l</span><span class="c">.</span><span class="w">v</span><span class="c">alue</span><span class="pc">.</span><span class="w">reasons[</span><span class="c">0].</span><span class="w">t</span><span class="pc">rap</span><span class="c">(</span><span class="pc">e</span><span class="c">rror.</span><span class="w">PageRedirect</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">b</span><span class="pc">'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">'</span><span class="c">,</span>
                         <span class="w">fa</span><span class="pc">il.</span><span class="w">v</span><span class="c">alue</span><span class="pc">.</span><span class="w">r</span><span class="pc">ea</span><span class="c">sons</span><span class="w">[</span><span class="c">0</span><span class="pc">].</span><span class="w">v</span><span class="c">alue</span><span class="w">.location</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">co</span><span class="pc">d</span><span class="c">e,</span> <span class="w">fa</span><span class="pc">il</span><span class="c">.value</span><span class="pc">.</span><span class="w">res</span><span class="c">ponse.</span><span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_307OnPost</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_testPageRedirectFailure</span><span class="pc">(</span><span class="w">307</span><span class="c">,</span> <span class="pc">b'</span><span class="w">POST</span><span class="pc">')</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_redirectLimit</span><span class="c">(self):</span>
        
        <span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor)</span>
        <span class="w">redirectAgent</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">RedirectAgent</span><span class="c">(</span><span class="w">ag</span><span class="c">ent</span><span class="pc">,</span> <span class="w">1</span><span class="c">)</span>

        <span class="w">de</span><span class="pc">fe</span><span class="c">rred</span> <span class="c">=</span> <span class="pc">r</span><span class="c">edirectAgent.</span><span class="w">req</span><span class="c">uest(</span><span class="w">b</span><span class="c">'GET',</span> <span class="c">b'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com</span><span class="pc">/f</span><span class="c">oo</span><span class="pc">')</span>

        <span class="w">re</span><span class="pc">q,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="pc">(</span>
            <span class="w">{</span><span class="pc">b</span><span class="c">'</span><span class="w">location': [</span><span class="c">b'</span><span class="pc">h</span><span class="c">ttp://example.com/</span><span class="pc">b</span><span class="c">ar</span><span class="w">']})</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1</span><span class="c">),</span> <span class="w">302</span><span class="pc">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">ca</span><span class="pc">llb</span><span class="c">ack(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">req2,</span> <span class="w">res2</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="c">op</span><span class="pc">()</span>

        <span class="w">response2</span> <span class="c">=</span> <span class="pc">R</span><span class="c">esponse</span><span class="w">((</span><span class="pc">b</span><span class="c">'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="c">1</span><span class="pc">),</span> <span class="w">3</span><span class="pc">02,</span> <span class="pc">b</span><span class="c">'</span><span class="w">O</span><span class="c">K',</span> <span class="w">h</span><span class="pc">eaders</span><span class="c">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">es2</span><span class="c">.</span><span class="w">ca</span><span class="pc">llb</span><span class="c">ack(</span><span class="w">r</span><span class="pc">esp</span><span class="c">onse2)</span>

        <span class="w">fai</span><span class="pc">l</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">failureResultOf</span><span class="c">(</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">,</span> <span class="w">c</span><span class="pc">li</span><span class="c">ent</span><span class="pc">.</span><span class="w">ResponseFailed</span><span class="c">)</span>

        <span class="w">fai</span><span class="pc">l</span><span class="c">.</span><span class="w">v</span><span class="c">alue</span><span class="pc">.</span><span class="w">reasons[</span><span class="c">0</span><span class="pc">].</span><span class="w">t</span><span class="pc">rap</span><span class="c">(</span><span class="pc">e</span><span class="c">rror.</span><span class="w">InfiniteRedirection</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">b</span><span class="pc">'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">'</span><span class="c">,</span>
                         <span class="w">fa</span><span class="pc">il.</span><span class="w">v</span><span class="c">alue</span><span class="pc">.</span><span class="w">r</span><span class="pc">ea</span><span class="c">sons</span><span class="w">[</span><span class="c">0</span><span class="pc">].</span><span class="w">v</span><span class="c">alue</span><span class="w">.location</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">302</span><span class="pc">,</span> <span class="w">fa</span><span class="pc">il</span><span class="c">.value</span><span class="w">.res</span><span class="c">ponse.</span><span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">_testRedirectURI</span><span class="c">(self</span><span class="pc">,</span> <span class="w">u</span><span class="pc">ri,</span> <span class="pc">l</span><span class="c">ocation</span><span class="pc">,</span> <span class="w">finalURI</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">self.</span><span class="w">ag</span><span class="c">ent.</span><span class="w">req</span><span class="c">uest(</span><span class="pc">b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="w">u</span><span class="pc">r</span><span class="c">i</span><span class="pc">)</span>

        <span class="w">re</span><span class="pc">q,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.protocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="pc">o</span><span class="c">p</span><span class="pc">()</span>

        <span class="w">h</span><span class="c">eaders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="pc">(</span>
            <span class="w">{</span><span class="pc">b</span><span class="c">'</span><span class="w">l</span><span class="c">ocation</span><span class="w">': [l</span><span class="c">ocation</span><span class="w">]})</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1),</span> <span class="w">302</span><span class="pc">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">,</span> <span class="w">N</span><span class="c">one)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">req2,</span> <span class="w">res2</span> <span class="c">=</span> <span class="w">s</span><span class="c">elf.</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="c">op</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">b</span><span class="c">'</span><span class="pc">G</span><span class="c">ET',</span> <span class="w">r</span><span class="pc">eq</span><span class="c">2</span><span class="pc">.</span><span class="w">m</span><span class="c">ethod</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">finalURI</span><span class="pc">,</span> <span class="pc">r</span><span class="c">eq2.</span><span class="w">absoluteURI</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_relativeURI</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_testRedirectURI</span><span class="c">(</span>
            <span class="pc">b'h</span><span class="c">ttp://example.com</span><span class="pc">/f</span><span class="c">oo/bar</span><span class="pc">',</span> <span class="c">b'</span><span class="pc">b</span><span class="c">az</span><span class="pc">',</span>
            <span class="c">b'</span><span class="pc">h</span><span class="c">ttp://example.com/foo/</span><span class="pc">baz')</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">_</span><span class="c">testRedirectURI(</span>
            <span class="c">b'http://example.com/foo/bar</span><span class="w">'</span><span class="pc">,</span> <span class="c">b</span><span class="pc">'/baz'</span><span class="c">,</span>
            <span class="c">b'http://example.com/</span><span class="pc">baz'</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">_</span><span class="c">testRedirectURI(</span>
            <span class="pc">b</span><span class="c">'http://example.com/foo/bar</span><span class="w">'</span><span class="pc">,</span> <span class="c">b</span><span class="pc">'/baz</span><span class="w">?a'</span><span class="pc">,</span>
            <span class="c">b'</span><span class="pc">h</span><span class="c">ttp://</span><span class="pc">e</span><span class="c">xample.com/</span><span class="pc">baz</span><span class="w">?a'</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_relativeURIPreserveFragments</span><span class="c">(self):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">_</span><span class="c">testRedirectURI(</span>
            <span class="c">b</span><span class="pc">'</span><span class="c">http://</span><span class="pc">e</span><span class="c">xample.com/</span><span class="pc">f</span><span class="c">oo/bar</span>
            <span class="w">b</span><span class="c">'http://</span><span class="pc">e</span><span class="c">xample.com/</span><span class="pc">baz</span><span class="w">?a</span>
        <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">_</span><span class="c">testRedirectURI(</span>
            <span class="pc">b</span><span class="c">'http://example.com/</span><span class="pc">f</span><span class="c">oo/bar</span><span class="w">'</span><span class="pc">,</span> <span class="c">b</span><span class="pc">'/</span><span class="w">b</span><span class="pc">az</span><span class="w">?a</span>
            <span class="w">b</span><span class="pc">'</span><span class="c">http://example.com/</span><span class="w">b</span><span class="pc">az</span><span class="w">?a</span>


    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">test_relativeURISchemeRelative</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_</span><span class="c">testRedirectURI(</span>
            <span class="c">b'http://</span><span class="pc">e</span><span class="c">xample.com/foo/bar</span><span class="w">'</span><span class="pc">,</span> <span class="c">b</span><span class="w">'//</span><span class="c">foo</span><span class="w">.</span><span class="c">com</span><span class="pc">/baz</span><span class="w">'</span><span class="pc">,</span>
            <span class="c">b'</span><span class="pc">h</span><span class="c">ttp://</span><span class="pc">f</span><span class="c">oo.com/</span><span class="pc">baz')</span>
        <span class="c">self.</span><span class="w">_</span><span class="c">testRedirectURI(</span>
            <span class="c">b'http://example.com/foo/bar</span><span class="w">'</span><span class="pc">,</span> <span class="c">b</span><span class="w">'</span><span class="pc">//</span><span class="c">foo</span><span class="pc">.</span><span class="c">com</span><span class="w">:81</span><span class="pc">/</span><span class="w">b</span><span class="pc">az',</span>
            <span class="c">b'</span><span class="pc">h</span><span class="c">ttp://foo</span><span class="pc">.</span><span class="c">com</span><span class="w">:</span><span class="c">81/</span><span class="w">b</span><span class="pc">az'</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_responseHistory</span><span class="c">(self):</span>
        
        <span class="w">a</span><span class="pc">g</span><span class="c">ent</span> <span class="c">=</span> <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">buildAgentForWrapperTest</span><span class="c">(</span><span class="w">s</span><span class="c">elf.</span><span class="w">re</span><span class="pc">ac</span><span class="c">tor)</span>
        <span class="w">redirectAgent</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">RedirectAgent</span><span class="c">(</span><span class="w">a</span><span class="pc">g</span><span class="c">ent</span><span class="pc">)</span>

        <span class="w">de</span><span class="pc">fe</span><span class="c">rred</span> <span class="c">=</span> <span class="pc">r</span><span class="c">edirectAgent.</span><span class="w">r</span><span class="pc">eq</span><span class="c">uest(</span><span class="pc">b'G</span><span class="c">ET</span><span class="pc">',</span> <span class="c">b'</span><span class="w">h</span><span class="c">ttp://example.com/</span><span class="pc">f</span><span class="c">oo</span><span class="pc">'</span><span class="c">)</span>

        <span class="w">redirectReq</span><span class="pc">,</span> <span class="w">redirectRes</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">req</span><span class="pc">uests.</span><span class="w">p</span><span class="pc">op()</span>

        <span class="w">h</span><span class="pc">e</span><span class="c">aders</span> <span class="pc">=</span> <span class="w">http_headers</span><span class="pc">.</span><span class="w">H</span><span class="pc">e</span><span class="c">aders</span><span class="pc">(</span>
            <span class="w">{</span><span class="pc">b</span><span class="c">'</span><span class="w">location': [</span><span class="c">b'</span><span class="pc">h</span><span class="c">ttp://example.com</span><span class="pc">/b</span><span class="c">ar</span><span class="w">']})</span>
        <span class="w">redirectResponse</span> <span class="c">=</span> <span class="w">Response((</span><span class="pc">b</span><span class="c">'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">1</span><span class="c">),</span> <span class="w">302</span><span class="pc">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K',</span> <span class="w">h</span><span class="pc">e</span><span class="c">aders</span><span class="pc">,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">redirectRes</span><span class="pc">.</span><span class="w">ca</span><span class="pc">llb</span><span class="c">ack(</span><span class="w">r</span><span class="pc">ed</span><span class="c">irectResponse)</span>

        <span class="w">r</span><span class="pc">eq,</span> <span class="w">res</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">req</span><span class="pc">uests</span><span class="w">.p</span><span class="c">op</span><span class="pc">()</span>

        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="pc">=</span> <span class="pc">R</span><span class="c">esponse</span><span class="w">((</span><span class="c">b'</span><span class="pc">H</span><span class="c">TTP</span><span class="pc">'</span><span class="c">,</span> <span class="c">1</span><span class="pc">,</span> <span class="c">1</span><span class="pc">),</span> <span class="w">2</span><span class="pc">00</span><span class="c">,</span> <span class="c">b'</span><span class="w">O</span><span class="c">K</span><span class="pc">',</span> <span class="w">h</span><span class="c">eaders,</span> <span class="w">N</span><span class="c">one</span><span class="pc">)</span>
        <span class="w">res</span><span class="c">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">finalResponse</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">s</span><span class="c">uccessResultOf(</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred)</span>
        <span class="c">self.</span><span class="pc">assertI</span><span class="c">dentical(finalResponse</span><span class="pc">.</span><span class="w">previousResponse</span><span class="pc">,</span> <span class="w">redirectResponse</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertI</span><span class="c">dentical(</span><span class="w">r</span><span class="pc">ed</span><span class="c">irectResponse.</span><span class="pc">p</span><span class="c">reviousResponse,</span> <span class="pc">N</span><span class="c">one)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">RedirectAgentTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span> <span class="w">FakeReactorAndConnectMixin</span><span class="pc">,</span>
                         <span class="w">_RedirectAgentTestsMixin</span><span class="pc">,</span> <span class="w">AgentTestsMixin</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="w">makeAgent</span><span class="c">(self):</span>
        
        <span class="pc">ret</span><span class="c">urn</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent.</span><span class="w">RedirectAgent</span><span class="c">(</span>
            <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="pc">ea</span><span class="c">ctor</span><span class="pc">))</span>


    <span class="c">def</span> <span class="pc">s</span><span class="c">etUp(self):</span>
        <span class="c">self.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span> <span class="c">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="c">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">m</span><span class="pc">a</span><span class="c">keAgent</span><span class="pc">(</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_301OnPost</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_testPageRedirectFailure</span><span class="pc">(</span><span class="w">301</span><span class="pc">,</span> <span class="pc">b</span><span class="c">'</span><span class="w">POST</span><span class="pc">')</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_302OnPost</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_</span><span class="c">testPageRedirectFailure</span><span class="pc">(</span><span class="w">302</span><span class="c">,</span> <span class="pc">b</span><span class="c">'</span><span class="w">P</span><span class="c">OST</span><span class="pc">')</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">BrowserLikeRedirectAgentTests</span><span class="c">(</span><span class="pc">T</span><span class="c">estCase</span><span class="pc">,</span>
                                    <span class="w">FakeReactorAndConnectMixin</span><span class="pc">,</span>
                                    <span class="w">_RedirectAgentTestsMixin</span><span class="pc">,</span>
                                    <span class="w">AgentTestsMixin</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="w">makeAgent</span><span class="c">(self):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent.</span><span class="w">BrowserLikeRedirectAgent</span><span class="c">(</span>
            <span class="c">self.</span><span class="w">buildAgentForWrapperTest</span><span class="pc">(</span><span class="c">self.</span><span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">))</span>


    <span class="c">def</span> <span class="w">s</span><span class="c">etUp(self):</span>
        <span class="c">self.</span><span class="w">rea</span><span class="pc">c</span><span class="c">tor</span> <span class="c">=</span> <span class="c">self.</span><span class="w">Reactor</span><span class="c">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">ag</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.</span><span class="w">m</span><span class="pc">a</span><span class="c">keAgent</span><span class="pc">(</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_redirectToGet301</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_testRedirectToGet</span><span class="pc">(</span><span class="w">301</span><span class="pc">,</span> <span class="pc">b</span><span class="c">'</span><span class="w">POST</span><span class="pc">')</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_redirectToGet302</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">_</span><span class="c">testRedirectToGet</span><span class="pc">(</span><span class="w">302</span><span class="c">,</span> <span class="pc">b</span><span class="c">'</span><span class="w">P</span><span class="c">OST</span><span class="pc">')</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">AbortableStringTransport</span><span class="c">(</span><span class="w">S</span><span class="c">tringTransport):</span>
    
    
    <span class="w">aborting</span> <span class="c">=</span> <span class="w">F</span><span class="c">alse</span>


    <span class="c">def</span> <span class="w">abortConnection</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">a</span><span class="pc">borti</span><span class="c">ng</span> <span class="c">=</span> <span class="c">True</span>
        <span class="c">self.</span><span class="w">los</span><span class="c">eConnection()</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">DummyResponse</span><span class="c">(object):</span>
    

    <span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="pc">b</span><span class="c">"</span><span class="w">2</span><span class="pc">0</span><span class="c">0</span><span class="pc">"</span>
    <span class="w">phrase</span> <span class="pc">=</span> <span class="pc">b</span><span class="c">"</span><span class="w">O</span><span class="c">K</span><span class="pc">"</span>

    <span class="w">d</span><span class="c">ef</span> <span class="pc">_</span><span class="c">_init__(self</span><span class="pc">,</span> <span class="w">h</span><span class="c">eaders</span><span class="pc">=</span><span class="c">None</span><span class="pc">,</span> <span class="w">transportFactory</span><span class="c">=</span><span class="w">AbortableStringTransport</span><span class="c">):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="pc">h</span><span class="c">eaders</span> <span class="c">is</span> <span class="c">None:</span>
            <span class="c">headers</span> <span class="c">=</span> <span class="w">H</span><span class="c">eaders()</span>
        <span class="w">s</span><span class="c">elf.headers</span> <span class="c">=</span> <span class="pc">h</span><span class="c">eaders</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">t</span><span class="pc">ransport</span> <span class="c">=</span> <span class="pc">t</span><span class="c">ransportFactory</span><span class="pc">(</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">deliverBody</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">rot</span><span class="c">ocol):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">rot</span><span class="c">ocol</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span><span class="pc">.m</span><span class="c">akeConnection(self.transport)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">AlreadyCompletedDummyResponse</span><span class="c">(</span><span class="w">DummyResponse</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="w">d</span><span class="pc">e</span><span class="c">liverBody(self</span><span class="pc">,</span> <span class="c">protocol):</span>
        
        <span class="c">self.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="pc">p</span><span class="c">rotocol</span>
        <span class="c">self.protocol.</span><span class="pc">m</span><span class="c">akeConnection(self</span><span class="pc">.</span><span class="c">transport)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">t</span><span class="c">ransport</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">one</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ReadBodyTests</span><span class="c">(</span><span class="w">T</span><span class="c">estCase):</span>
    
    <span class="c">def</span> <span class="w">test_success</span><span class="c">(self):</span>
        
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">DummyResponse</span><span class="c">()</span>
        <span class="w">d</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">readBody</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">sponse</span><span class="pc">)</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span><span class="pc">.p</span><span class="c">rotocol.dataReceived(b</span><span class="pc">"</span><span class="w">fi</span><span class="pc">r</span><span class="c">st</span><span class="pc">")</span>
        <span class="pc">r</span><span class="c">esponse.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.dataReceived(b"</span><span class="w">se</span><span class="pc">c</span><span class="c">ond")</span>
        <span class="pc">res</span><span class="c">ponse.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">c</span><span class="c">onnectionLost(Failure</span><span class="pc">(</span><span class="w">ResponseDone(</span><span class="pc">)))</span>
        <span class="c">self.assertEqual(</span><span class="w">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">uccessResultOf(</span><span class="w">d</span><span class="pc">)</span><span class="c">,</span> <span class="pc">b</span><span class="c">"</span><span class="w">firstsecond</span><span class="c">")</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_cancel</span><span class="c">(self):</span>
        
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">DummyResponse</span><span class="c">()</span>
        <span class="w">de</span><span class="pc">fe</span><span class="c">rred</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">readBody</span><span class="pc">(</span><span class="w">r</span><span class="c">esponse)</span>
        <span class="w">de</span><span class="pc">fe</span><span class="c">rred.</span><span class="w">c</span><span class="pc">an</span><span class="c">cel()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">failureResultOf</span><span class="c">(</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">,</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="w">CancelledError</span><span class="pc">)</span>
        <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="pc">resp</span><span class="c">onse.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">aborting</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_withPotentialDataLoss</span><span class="c">(self):</span>
        
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">DummyResponse</span><span class="pc">()</span>
        <span class="c">d</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">readBody</span><span class="pc">(</span><span class="w">r</span><span class="c">esponse)</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span><span class="pc">.</span><span class="w">p</span><span class="c">rotocol.dataReceived(b</span><span class="pc">"</span><span class="w">f</span><span class="pc">ir</span><span class="c">st</span><span class="pc">"</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">esponse.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.dataReceived(b"</span><span class="w">se</span><span class="pc">c</span><span class="c">ond")</span>
        <span class="pc">res</span><span class="c">ponse.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">c</span><span class="c">onnectionLost(Failure</span><span class="pc">(</span><span class="w">PotentialDataLoss(</span><span class="pc">)))</span>
        <span class="w">fa</span><span class="pc">i</span><span class="c">lure</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">failureResultOf</span><span class="c">(</span><span class="w">d</span><span class="c">)</span>
        <span class="w">fa</span><span class="pc">ilure</span><span class="c">.trap(</span><span class="w">cl</span><span class="c">ient.</span><span class="w">PartialDownloadError</span><span class="c">)</span>
        <span class="c">self.assertEqual</span><span class="w">({</span>
            <span class="w">"st</span><span class="c">atus</span><span class="w">"</span><span class="pc">:</span> <span class="w">f</span><span class="pc">ailure</span><span class="c">.</span><span class="w">v</span><span class="c">alue</span><span class="pc">.</span><span class="w">sta</span><span class="pc">t</span><span class="c">us</span><span class="pc">,</span>
            <span class="w">"m</span><span class="c">essage</span><span class="pc">":</span> <span class="w">f</span><span class="pc">a</span><span class="c">ilure.</span><span class="pc">v</span><span class="c">alue.</span><span class="w">m</span><span class="c">essage</span><span class="w">,</span>
            <span class="c">"</span><span class="w">bo</span><span class="c">dy</span><span class="pc">":</span> <span class="w">f</span><span class="pc">a</span><span class="c">ilure.</span><span class="w">v</span><span class="c">alue.</span><span class="w">res</span><span class="pc">po</span><span class="c">nse</span><span class="w">,</span>
        <span class="w">}, {</span>
            <span class="pc">"</span><span class="w">s</span><span class="c">tatus</span><span class="w">":</span> <span class="pc">b</span><span class="c">"</span><span class="w">2</span><span class="c">00",</span>
            <span class="c">"</span><span class="w">m</span><span class="c">essage</span><span class="pc">":</span> <span class="pc">b</span><span class="c">"</span><span class="w">O</span><span class="c">K",</span>
            <span class="c">"</span><span class="w">b</span><span class="pc">o</span><span class="c">dy</span><span class="pc">":</span> <span class="c">b"</span><span class="w">firstsecond</span><span class="c">",</span>
        <span class="w">}</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_otherErrors</span><span class="c">(self):</span>
        
        <span class="w">res</span><span class="pc">p</span><span class="c">onse</span> <span class="c">=</span> <span class="w">DummyResponse</span><span class="pc">()</span>
        <span class="w">d</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">readBody</span><span class="c">(</span><span class="w">r</span><span class="pc">esp</span><span class="c">onse)</span>
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse.</span><span class="w">p</span><span class="c">rotocol.dataReceived(b"</span><span class="w">f</span><span class="pc">irst</span><span class="c">")</span>
        <span class="pc">res</span><span class="c">ponse.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">c</span><span class="c">onnectionLost(</span>
            <span class="pc">F</span><span class="c">ailure(</span><span class="w">ConnectionLost("mystery</span> <span class="w">problem")))</span>
        <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">=</span> <span class="c">self.</span><span class="w">failureResultOf</span><span class="c">(</span><span class="w">d</span><span class="pc">)</span>
        <span class="w">rea</span><span class="pc">s</span><span class="c">on.</span><span class="pc">t</span><span class="c">rap(</span><span class="w">C</span><span class="c">onnectionLost)</span>
        <span class="c">self.assertEqual(</span><span class="w">r</span><span class="pc">ea</span><span class="c">son.value</span><span class="pc">.</span><span class="w">ar</span><span class="c">gs</span><span class="w">, ("m</span><span class="c">ystery</span> <span class="w">p</span><span class="c">roblem</span><span class="w">",))</span>


    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">test_deprecatedTransport</span><span class="c">(self):</span>
        
        <span class="w">re</span><span class="pc">sp</span><span class="c">onse</span> <span class="c">=</span> <span class="w">DummyResponse</span><span class="pc">(</span><span class="w">transportFactory</span><span class="pc">=</span><span class="w">S</span><span class="pc">tringT</span><span class="c">ransport</span><span class="pc">)</span>
        <span class="pc">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">assertWarns</span><span class="c">(</span>
            <span class="w">De</span><span class="pc">p</span><span class="c">recationWarning,</span>
            <span class="w">'Using</span> <span class="w">readBody</span> <span class="w">w</span><span class="c">ith</span> <span class="w">a</span> <span class="w">tr</span><span class="pc">ansport</span> <span class="w">that</span> <span class="w">do</span><span class="pc">e</span><span class="c">s</span> <span class="c">not</span> <span class="w">h</span><span class="c">ave</span> <span class="w">a</span><span class="pc">n</span> <span class="w">'</span>
            <span class="w">'abortConnection</span> <span class="w">me</span><span class="pc">t</span><span class="c">hod</span><span class="pc">',</span>
            <span class="w">_</span><span class="c">_file__,</span>
            <span class="w">l</span><span class="pc">a</span><span class="c">mbda:</span> <span class="w">cl</span><span class="pc">ient</span><span class="c">.</span><span class="pc">r</span><span class="c">eadBody</span><span class="pc">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse</span><span class="pc">)</span><span class="c">)</span>
        <span class="w">d</span><span class="pc">.</span><span class="w">c</span><span class="pc">an</span><span class="c">cel()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">failureResultOf</span><span class="c">(</span><span class="w">d</span><span class="pc">,</span> <span class="pc">de</span><span class="c">fer.</span><span class="w">CancelledError</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">test_deprecatedTransportNoWarning</span><span class="c">(self):</span>
        
        <span class="w">r</span><span class="pc">es</span><span class="c">ponse</span> <span class="c">=</span> <span class="w">AlreadyCompletedDummyResponse</span><span class="c">()</span>
        <span class="w">c</span><span class="c">lient.</span><span class="w">r</span><span class="c">eadBody</span><span class="pc">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ponse)</span>

        <span class="w">w</span><span class="pc">arnings</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">f</span><span class="c">lushWarnings</span><span class="pc">()</span>
        <span class="c">self.assertEqual(len(</span><span class="w">w</span><span class="pc">arnings</span><span class="c">),</span> <span class="pc">0</span><span class="c">)</span>

</pre>
</body>
</html>

