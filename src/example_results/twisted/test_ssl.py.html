<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>




<span class="w">from</span> <span class="w">__future__</span> <span class="w">import</span> <span class="w">division,</span> <span class="w">absolute_import</span>

<span class="w">from</span> <span class="w">twisted.python.filepath</span> <span class="w">import</span> <span class="w">FilePath</span>
<span class="w">from</span> <span class="w">twisted.trial</span> <span class="w">import</span> <span class="w">unittest</span>
<span class="w">from</span> <span class="w">twisted.internet</span> <span class="w">import</span> <span class="w">protocol,</span> <span class="w">reactor,</span> <span class="w">interfaces,</span> <span class="w">defer</span>
<span class="w">from</span> <span class="w">twisted.internet.error</span> <span class="w">import</span> <span class="w">ConnectionDone</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocols</span> <span class="c">import</span> <span class="w">b</span><span class="c">asic</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">p</span><span class="c">ython</span><span class="pc">.</span><span class="w">r</span><span class="c">eflect</span> <span class="c">import</span> <span class="w">requireModule</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="pc">p</span><span class="c">ython.</span><span class="w">r</span><span class="pc">u</span><span class="c">ntime</span> <span class="c">import</span> <span class="c">platform</span>
<span class="pc">f</span><span class="c">rom</span> <span class="c">twisted.</span><span class="pc">te</span><span class="c">st.</span><span class="w">test_tcp</span> <span class="c">import</span> <span class="w">ProperlyCloseFilesMixin</span>

<span class="w">i</span><span class="pc">m</span><span class="c">port</span> <span class="w">o</span><span class="pc">s,</span> <span class="w">er</span><span class="pc">rn</span><span class="c">o</span>

<span class="w">t</span><span class="c">ry:</span>
    <span class="c">from</span> <span class="w">OpenSSL</span> <span class="c">import</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span><span class="w">,</span> <span class="w">crypto</span>
    <span class="pc">f</span><span class="c">rom</span> <span class="c">twisted.internet</span> <span class="c">import</span> <span class="w">s</span><span class="c">sl</span>
    <span class="c">from</span> <span class="c">twisted.</span><span class="w">t</span><span class="pc">e</span><span class="c">st.</span><span class="w">ssl_helpers</span> <span class="c">import</span> <span class="w">ClientTLSContext</span><span class="pc">,</span> <span class="w">certPath</span>
<span class="w">e</span><span class="pc">x</span><span class="c">cept</span> <span class="c">ImportError:</span>
    <span class="w">d</span><span class="c">ef</span> <span class="w">_noSSL</span><span class="pc">()</span><span class="c">:</span>
        
        <span class="w">global</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span>
        <span class="w">g</span><span class="pc">l</span><span class="c">obal</span> <span class="w">s</span><span class="pc">sl</span>
        <span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="c">=</span> <span class="w">ss</span><span class="pc">l</span> <span class="w">=</span> <span class="pc">N</span><span class="c">one</span>
    <span class="w">_</span><span class="pc">n</span><span class="c">oSSL</span><span class="w">(</span><span class="pc">)</span>

<span class="w">t</span><span class="c">ry:</span>
    <span class="c">from</span> <span class="c">twisted.</span><span class="pc">pr</span><span class="c">otocols</span> <span class="c">import</span> <span class="w">tls</span> <span class="pc">a</span><span class="c">s</span> <span class="w">newTLS</span>
<span class="w">e</span><span class="c">xcept</span> <span class="c">ImportError:</span>
    
    <span class="w">n</span><span class="c">ewTLS</span> <span class="c">=</span> <span class="c">None</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">UnintelligentProtocol</span><span class="c">(</span><span class="w">b</span><span class="c">asic.</span><span class="pc">L</span><span class="c">ineReceiver):</span>
    
    <span class="w">pretext</span> <span class="pc">= [</span>
        <span class="w">b</span><span class="c">"</span><span class="w">fi</span><span class="pc">r</span><span class="c">st</span> <span class="w">l</span><span class="pc">i</span><span class="c">ne</span><span class="pc">",</span>
        <span class="pc">b</span><span class="c">"</span><span class="w">last</span> <span class="w">thing</span> <span class="w">be</span><span class="pc">f</span><span class="c">ore</span> <span class="w">tl</span><span class="c">s</span> <span class="w">starts</span><span class="c">",</span>
        <span class="pc">b</span><span class="c">"</span><span class="w">STARTTLS"]</span>

    <span class="w">posttext</span> <span class="pc">= </span><span class="c">[</span>
        <span class="pc">b</span><span class="c">"</span><span class="w">fi</span><span class="c">rst</span> <span class="w">t</span><span class="pc">hin</span><span class="c">g</span> <span class="w">af</span><span class="c">ter</span> <span class="w">t</span><span class="c">ls</span> <span class="w">started</span><span class="c">",</span>
        <span class="pc">b</span><span class="c">"</span><span class="w">l</span><span class="pc">a</span><span class="c">st</span> <span class="w">t</span><span class="c">hing</span> <span class="w">ever"]</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="c">__init__(self):</span>
        <span class="c">self.</span><span class="w">de</span><span class="pc">f</span><span class="c">erred</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">l</span> <span class="c">in</span> <span class="c">self.</span><span class="w">pretext</span><span class="c">:</span>
            <span class="c">self.</span><span class="pc">s</span><span class="c">endLine(</span><span class="w">l</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">l</span><span class="c">ineReceived(self,</span> <span class="pc">l</span><span class="c">ine):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">li</span><span class="c">ne</span> <span class="pc">=</span><span class="c">=</span> <span class="w">b</span><span class="c">"</span><span class="w">READY</span><span class="c">":</span>
            <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">startTLS</span><span class="pc">(</span><span class="w">ClientTLSContext(</span><span class="pc">),</span> <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">cl</span><span class="pc">i</span><span class="c">ent</span><span class="pc">)</span>
            <span class="w">f</span><span class="c">or</span> <span class="w">l</span> <span class="c">in</span> <span class="c">self.</span><span class="w">posttext</span><span class="c">:</span>
                <span class="c">self.</span><span class="w">s</span><span class="pc">e</span><span class="c">ndLine(</span><span class="w">l</span><span class="c">)</span>
            <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="pc">c</span><span class="c">onnectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.</span><span class="pc">c</span><span class="c">allback(None)</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">LineCollector</span><span class="c">(</span><span class="w">b</span><span class="c">asic.</span><span class="pc">L</span><span class="c">ineReceiver):</span>
    

    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">doTLS</span><span class="pc">,</span> <span class="w">fillBuffer</span><span class="pc">=F</span><span class="c">alse):</span>
        <span class="c">self.doTLS</span> <span class="c">=</span> <span class="pc">d</span><span class="c">oTLS</span>
        <span class="pc">s</span><span class="c">elf.fillBuffer</span> <span class="c">=</span> <span class="c">fillBuffer</span>
        <span class="c">self.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="pc">connectionM</span><span class="c">ade(self):</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">rawdata</span> <span class="pc">=</span> <span class="pc">b</span><span class="w">''</span>
        <span class="c">self.</span><span class="pc">fa</span><span class="c">ctory.</span><span class="w">li</span><span class="pc">nes</span> <span class="pc">= </span><span class="c">[]</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="pc">l</span><span class="c">ineReceived(self,</span> <span class="pc">l</span><span class="c">ine):</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">l</span><span class="pc">ines.</span><span class="c">append(</span><span class="pc">l</span><span class="c">ine)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">li</span><span class="c">ne</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">b'</span><span class="w">STARTTLS</span><span class="c">':</span>
            <span class="w">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">fillBuffer</span><span class="c">:</span>
                <span class="w">f</span><span class="c">or</span> <span class="w">x</span> <span class="c">in</span> <span class="pc">r</span><span class="c">ange(</span><span class="w">500</span><span class="c">):</span>
                    <span class="pc">s</span><span class="c">elf.sendLine(</span><span class="w">b</span><span class="c">'</span><span class="w">X'</span><span class="pc"> </span><span class="c">*</span> <span class="w">1000</span><span class="pc">)</span>
            <span class="w">s</span><span class="c">elf.</span><span class="pc">s</span><span class="c">endLine(</span><span class="pc">b</span><span class="c">'</span><span class="w">READY</span><span class="pc">')</span>
            <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">doTLS</span><span class="c">:</span>
                <span class="w">ct</span><span class="c">x</span> <span class="c">=</span> <span class="w">ServerTLSContext</span><span class="pc">(</span>
                    <span class="w">privateKeyFileName</span><span class="pc">=</span><span class="w">certPath</span><span class="pc">,</span>
                    <span class="w">certificateFileName</span><span class="c">=</span><span class="w">c</span><span class="pc">ertP</span><span class="c">ath</span><span class="pc">,</span>
                <span class="w">)</span>
                <span class="w">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport</span><span class="pc">.</span><span class="w">startTLS</span><span class="c">(</span><span class="w">ct</span><span class="c">x</span><span class="pc">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory.</span><span class="w">se</span><span class="pc">rve</span><span class="c">r</span><span class="pc">)</span>
            <span class="pc">e</span><span class="c">lse:</span>
                <span class="c">self.</span><span class="w">setRawMode</span><span class="pc">()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">rawDataReceived</span><span class="c">(self</span><span class="pc">,</span> <span class="pc">d</span><span class="c">ata):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory.</span><span class="w">rawdata</span> <span class="w">+</span><span class="c">=</span> <span class="pc">d</span><span class="c">ata</span>
        <span class="c">self.transport.loseConnection()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="c">connectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.</span><span class="pc">c</span><span class="c">allback(</span><span class="pc">N</span><span class="c">one)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">SingleLineServerProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.Protocol):</span>
    

    <span class="c">def</span> <span class="c">connectionMade(self):</span>
        <span class="c">self.transport.write(</span><span class="pc">b</span><span class="w">"+O</span><span class="c">K</span> <span class="w">&lt;so</span><span class="c">me</span> <span class="w">crap&gt;\r</span><span class="c">\n</span><span class="pc">"</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">getPeerCertificate</span><span class="pc">()</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">RecordingClientProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.Protocol):</span>
    

    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self):</span>
        <span class="c">self.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="pc">co</span><span class="c">nnectionMade(self):</span>
        <span class="c">self.transport.</span><span class="w">g</span><span class="pc">etPeerC</span><span class="c">ertificate()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="pc">d</span><span class="c">ataReceived(self</span><span class="pc">,</span> <span class="pc">d</span><span class="c">ata):</span>
        <span class="c">self.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.callback(</span><span class="pc">d</span><span class="c">ata)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ImmediatelyDisconnectingProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.Protocol):</span>
    

    <span class="c">def</span> <span class="c">connectionMade(self):</span>
        <span class="c">self.transport.loseConnection()</span>


    <span class="c">def</span> <span class="c">connectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">connectionDisconnected</span><span class="pc">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(None)</span>



<span class="pc">d</span><span class="c">ef</span> <span class="w">generateCertificateObjects</span><span class="c">(</span><span class="w">organization</span><span class="pc">,</span> <span class="w">organizationalUnit</span><span class="c">):</span>
    
    <span class="w">pkey</span> <span class="c">=</span> <span class="w">crypto</span><span class="pc">.</span><span class="w">PKey</span><span class="c">()</span>
    <span class="pc">p</span><span class="c">key.</span><span class="w">generate_key</span><span class="c">(</span><span class="w">c</span><span class="c">rypto</span><span class="pc">.</span><span class="w">TYPE_RSA</span><span class="pc">,</span> <span class="w">512</span><span class="c">)</span>
    <span class="w">req</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">r</span><span class="c">ypto.</span><span class="w">X509Req</span><span class="c">()</span>
    <span class="w">subject</span> <span class="c">=</span> <span class="w">req</span><span class="c">.</span><span class="w">get_subject</span><span class="c">()</span>
    <span class="w">s</span><span class="pc">u</span><span class="c">bject.</span><span class="w">O</span> <span class="pc">=</span> <span class="w">o</span><span class="c">rganization</span>
    <span class="w">s</span><span class="pc">u</span><span class="c">bject</span><span class="pc">.</span><span class="w">OU</span> <span class="c">=</span> <span class="w">o</span><span class="c">rganizationalUnit</span>
    <span class="w">re</span><span class="pc">q</span><span class="c">.</span><span class="w">set_pubkey</span><span class="pc">(p</span><span class="c">key</span><span class="pc">)</span>
    <span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">sign</span><span class="pc">(</span><span class="w">p</span><span class="c">key</span><span class="w">,</span><span class="pc"> "</span><span class="w">md</span><span class="c">5")</span>

    
    <span class="w">cert</span> <span class="c">=</span> <span class="pc">c</span><span class="c">rypto.</span><span class="w">X509</span><span class="pc">()</span>
    <span class="pc">c</span><span class="c">ert.</span><span class="w">set_serial_number</span><span class="c">(</span><span class="w">1</span><span class="c">)</span>
    <span class="pc">c</span><span class="c">ert.</span><span class="w">gmtime_adj_notBefore</span><span class="c">(</span><span class="w">0</span><span class="c">)</span>
    <span class="pc">c</span><span class="c">ert.</span><span class="w">gmtime_adj_notAfter</span><span class="pc">(</span><span class="w">6</span><span class="c">0)</span> 
    <span class="pc">c</span><span class="c">ert.</span><span class="w">set_issuer</span><span class="c">(</span><span class="w">req</span><span class="c">.</span><span class="w">get_subject</span><span class="pc">())</span>
    <span class="pc">c</span><span class="c">ert.</span><span class="w">set_subject</span><span class="pc">(</span><span class="w">req</span><span class="c">.</span><span class="pc">g</span><span class="c">et_subject</span><span class="w">(</span><span class="pc">))</span>
    <span class="pc">c</span><span class="c">ert.</span><span class="w">set_pubkey</span><span class="c">(</span><span class="w">r</span><span class="pc">eq</span><span class="c">.</span><span class="w">get_pubkey</span><span class="c">())</span>
    <span class="pc">c</span><span class="c">ert.</span><span class="w">sign</span><span class="c">(</span><span class="w">pkey,</span><span class="pc"> "</span><span class="w">m</span><span class="pc">d</span><span class="c">5")</span>

    <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">pk</span><span class="c">ey</span><span class="w">,</span> <span class="w">r</span><span class="pc">eq,</span> <span class="pc">c</span><span class="c">ert</span>



<span class="w">d</span><span class="c">ef</span> <span class="w">generateCertificateFiles</span><span class="c">(</span><span class="w">bas</span><span class="pc">en</span><span class="c">ame</span><span class="pc">,</span> <span class="w">organization</span><span class="pc">,</span> <span class="w">organizationalUnit</span><span class="c">):</span>
    
    <span class="w">p</span><span class="pc">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">req</span><span class="pc">,</span> <span class="pc">c</span><span class="c">ert</span> <span class="pc">=</span> <span class="w">generateCertificateObjects</span><span class="c">(organization</span><span class="pc">,</span> <span class="pc">o</span><span class="c">rganizationalUnit</span><span class="pc">)</span>

    <span class="pc">f</span><span class="c">or</span> <span class="w">ext</span><span class="pc">,</span> <span class="w">ob</span><span class="pc">j,</span> <span class="w">dumpFunc</span> <span class="pc">i</span><span class="c">n</span> <span class="w">[</span>
        <span class="w">('k</span><span class="c">ey</span><span class="pc">',</span> <span class="w">p</span><span class="c">key,</span> <span class="w">crypto.dump_privatekey)</span><span class="pc">,</span>
        <span class="w">(</span><span class="pc">'</span><span class="w">req</span><span class="pc">'</span><span class="c">,</span> <span class="w">req</span><span class="pc">,</span> <span class="w">c</span><span class="pc">r</span><span class="c">ypto</span><span class="pc">.</span><span class="w">dump_certificate_request)</span><span class="pc">,</span>
        <span class="w">(</span><span class="pc">'</span><span class="c">cert',</span> <span class="w">c</span><span class="c">ert</span><span class="pc">,</span> <span class="pc">c</span><span class="c">rypto</span><span class="pc">.</span><span class="w">dump_certificate)]:</span>
        <span class="w">fName</span> <span class="pc">=</span> <span class="w">o</span><span class="pc">s</span><span class="c">.</span><span class="w">extsep</span><span class="pc">.j</span><span class="c">oin</span><span class="pc">((</span><span class="w">ba</span><span class="pc">sen</span><span class="c">ame,</span> <span class="w">ext)).enc</span><span class="c">ode</span><span class="w">(</span><span class="pc">"u</span><span class="c">tf-8</span><span class="pc">")</span>
        <span class="w">F</span><span class="c">ilePath(</span><span class="w">f</span><span class="pc">N</span><span class="c">ame</span><span class="w">)</span><span class="pc">.</span><span class="c">setContent(</span><span class="w">dumpFunc</span><span class="pc">(</span><span class="w">c</span><span class="c">rypto</span><span class="pc">.</span><span class="w">FILETYPE_PEM</span><span class="c">,</span> <span class="w">o</span><span class="pc">b</span><span class="c">j</span><span class="pc">))</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">ContextGeneratingMixin</span><span class="pc">:</span>
    

    <span class="c">def</span> <span class="w">makeContextFactory</span><span class="c">(self</span><span class="pc">,</span> <span class="w">or</span><span class="pc">g,</span> <span class="w">orgUnit</span><span class="pc">, </span><span class="c">*args, **</span><span class="w">kwArgs</span><span class="c">):</span>
        <span class="w">b</span><span class="c">ase</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">m</span><span class="c">ktemp()</span>
        <span class="w">generateCertificateFiles</span><span class="pc">(</span><span class="w">b</span><span class="pc">a</span><span class="c">se</span><span class="pc">,</span> <span class="w">or</span><span class="pc">g</span><span class="c">,</span> <span class="pc">o</span><span class="c">rgUnit</span><span class="pc">)</span>
        <span class="w">serverCtxFactory</span> <span class="c">=</span> <span class="w">ss</span><span class="c">l.</span><span class="w">DefaultOpenSSLContextFactory</span><span class="c">(</span>
            <span class="w">o</span><span class="pc">s</span><span class="c">.</span><span class="w">extsep</span><span class="pc">.</span><span class="c">join</span><span class="pc">((</span><span class="w">b</span><span class="c">ase</span><span class="pc">, </span><span class="c">'</span><span class="w">k</span><span class="pc">e</span><span class="c">y</span><span class="w">')),</span>
            <span class="w">o</span><span class="pc">s</span><span class="c">.</span><span class="w">e</span><span class="c">xtsep.</span><span class="pc">j</span><span class="c">oin</span><span class="pc">((</span><span class="w">b</span><span class="c">ase</span><span class="pc">, </span><span class="c">'</span><span class="w">cert'))</span><span class="pc">,</span>
            <span class="w">*a</span><span class="c">rgs</span><span class="w">,</span><span class="c"> **</span><span class="w">kwArgs</span><span class="c">)</span>

        <span class="w">r</span><span class="c">eturn</span> <span class="w">b</span><span class="c">ase</span><span class="pc">,</span> <span class="c">serverCtxFactory</span>


    <span class="w">d</span><span class="c">ef</span> <span class="w">setupServerAndClient</span><span class="c">(self</span><span class="pc">,</span> <span class="w">clientArgs</span><span class="pc">,</span> <span class="w">clientKwArgs</span><span class="c">,</span> <span class="w">serverArgs</span><span class="pc">,</span>
                             <span class="w">serverKwArgs</span><span class="c">):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">clientBase,</span> <span class="pc">sel</span><span class="c">f.</span><span class="w">clientCtxFactory</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">makeContextFactory</span><span class="pc">(</span>
            <span class="w">*</span><span class="pc">c</span><span class="c">lientArgs</span><span class="w">,</span><span class="pc"> </span><span class="c">**</span><span class="pc">c</span><span class="c">lientKwArgs)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">serverBase,</span> <span class="pc">sel</span><span class="c">f.</span><span class="pc">serverC</span><span class="c">txFactory</span> <span class="w">=</span> <span class="c">self.</span><span class="w">m</span><span class="c">akeContextFactory</span><span class="w">(</span>
            <span class="w">*s</span><span class="pc">erverA</span><span class="c">rgs</span><span class="w">,</span><span class="pc"> *</span><span class="c">*</span><span class="pc">serverK</span><span class="c">wArgs</span><span class="pc">)</span>



<span class="pc">i</span><span class="c">f</span> <span class="w">SS</span><span class="c">L</span> <span class="pc">i</span><span class="c">s</span> <span class="c">not</span> <span class="c">None:</span>
    <span class="w">cla</span><span class="c">ss</span> <span class="w">ServerTLSContext</span><span class="c">(</span><span class="w">ss</span><span class="c">l.</span><span class="w">DefaultOpenSSLContextFactory</span><span class="c">):</span>
        
        <span class="w">isClient</span> <span class="c">=</span> <span class="c">False</span>

        <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">, </span><span class="c">*args, **kw):</span>
            <span class="w">k</span><span class="pc">w</span><span class="w">[</span><span class="c">'</span><span class="w">sslmethod</span><span class="c">'] =</span> <span class="w">S</span><span class="pc">S</span><span class="c">L.</span><span class="w">TLSv1_METHOD</span>
            <span class="w">ss</span><span class="pc">l.D</span><span class="c">efaultOpenSSLContextFactory</span><span class="pc">._</span><span class="c">_init__(self</span><span class="pc">, </span><span class="c">*args, **</span><span class="pc">kw</span><span class="c">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">StolenTCPTests</span><span class="c">(</span><span class="w">ProperlyCloseFilesMixin</span><span class="pc">,</span> <span class="c">unittest</span><span class="pc">.</span><span class="c">TestCase):</span>
    

    <span class="c">def</span> <span class="w">createServer</span><span class="c">(self</span><span class="pc">,</span> <span class="w">ad</span><span class="pc">dre</span><span class="c">ss</span><span class="pc">,</span> <span class="w">portNumber</span><span class="pc">,</span> <span class="w">f</span><span class="c">actory):</span>
        
        <span class="w">cert</span> <span class="c">=</span> <span class="w">ss</span><span class="pc">l</span><span class="c">.</span><span class="w">PrivateCertificate</span><span class="pc">.</span><span class="w">loadPEM</span><span class="c">(</span><span class="w">F</span><span class="pc">ileP</span><span class="c">ath(</span><span class="w">certPath</span><span class="pc">).</span><span class="w">getContent</span><span class="pc">()</span><span class="c">)</span>
        <span class="w">co</span><span class="pc">nte</span><span class="c">xtFactory</span> <span class="c">=</span> <span class="c">cert.</span><span class="w">o</span><span class="pc">pti</span><span class="c">ons()</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">eactor.</span><span class="w">listenSSL</span><span class="c">(</span>
            <span class="pc">p</span><span class="c">ortNumber,</span> <span class="w">f</span><span class="c">actory</span><span class="pc">,</span> <span class="w">c</span><span class="c">ontextFactory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface=</span><span class="w">a</span><span class="c">ddress</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">connectClient</span><span class="c">(self</span><span class="pc">,</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss,</span> <span class="w">po</span><span class="pc">rtN</span><span class="c">umber,</span> <span class="w">clientCreator</span><span class="c">):</span>
        
        <span class="w">c</span><span class="pc">o</span><span class="c">ntextFactory</span> <span class="c">=</span> <span class="w">ss</span><span class="c">l.</span><span class="w">CertificateOptions</span><span class="pc">()</span>
        <span class="pc">ret</span><span class="c">urn</span> <span class="w">c</span><span class="c">lientCreator</span><span class="pc">.</span><span class="w">connectSSL</span><span class="c">(</span><span class="w">a</span><span class="pc">d</span><span class="c">dress,</span> <span class="w">p</span><span class="pc">ortN</span><span class="c">umber,</span> <span class="w">c</span><span class="pc">o</span><span class="c">ntextFactory</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">getHandleExceptionType</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="c">return</span> <span class="w">SS</span><span class="c">L.</span><span class="w">E</span><span class="pc">r</span><span class="c">ror</span>


    <span class="w">d</span><span class="c">ef</span> <span class="w">getHandleErrorCode</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        
        
        
        

        
        
        
        

        
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">requireModule(</span><span class="pc">'</span><span class="w">t</span><span class="pc">w</span><span class="c">isted.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocols.</span><span class="w">tls'</span><span class="pc">)</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">N</span><span class="c">one:</span>
            
            <span class="pc">i</span><span class="c">f</span> <span class="pc">p</span><span class="c">latform.</span><span class="w">getType() == 'win32</span><span class="pc">'</span><span class="c">:</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="w">er</span><span class="pc">rn</span><span class="c">o.</span><span class="w">WSAENOTSOCK</span>

        
        
        <span class="w">r</span><span class="c">eturn</span> <span class="w">[('S</span><span class="pc">S</span><span class="c">L</span> <span class="w">routines'</span><span class="pc">, </span><span class="c">'</span><span class="w">SSL_write</span><span class="pc">', </span><span class="c">'</span><span class="w">pr</span><span class="pc">o</span><span class="c">tocol</span> <span class="w">i</span><span class="c">s</span> <span class="w">shutdown')]</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">TLSTests</span><span class="c">(</span><span class="pc">u</span><span class="c">nittest.TestCase):</span>
    
    <span class="w">fillBuffer</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>

    <span class="w">clientProto</span> <span class="c">=</span> <span class="c">None</span>
    <span class="w">serverProto</span> <span class="c">=</span> <span class="c">None</span>


    <span class="c">def</span> <span class="w">t</span><span class="c">earDown(self):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">lientProto</span><span class="pc">.</span><span class="w">t</span><span class="c">ransport</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">None:</span>
            <span class="c">self.</span><span class="pc">c</span><span class="c">lientProto.</span><span class="pc">t</span><span class="c">ransport</span><span class="pc">.</span><span class="c">loseConnection()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="pc">s</span><span class="c">erverProto</span><span class="pc">.</span><span class="w">t</span><span class="c">ransport</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">None:</span>
            <span class="c">self.</span><span class="pc">s</span><span class="c">erverProto.</span><span class="pc">t</span><span class="c">ransport.loseConnection()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">_runTest</span><span class="c">(self,</span> <span class="w">c</span><span class="pc">l</span><span class="c">ientProto</span><span class="pc">,</span> <span class="pc">s</span><span class="c">erverProto</span><span class="pc">,</span> <span class="w">clientIsServer</span><span class="pc">=F</span><span class="c">alse):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">lientProto</span> <span class="pc">=</span> <span class="pc">clientP</span><span class="c">roto</span>
        <span class="w">cf</span> <span class="c">=</span> <span class="c">self.</span><span class="w">cl</span><span class="pc">ientF</span><span class="c">actory</span> <span class="pc">=</span> <span class="w">pr</span><span class="pc">otoc</span><span class="c">ol.</span><span class="w">C</span><span class="c">lientFactory()</span>
        <span class="w">cf</span><span class="pc">.p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ambda:</span> <span class="w">c</span><span class="pc">lientP</span><span class="c">roto</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">c</span><span class="c">lientIsServer</span><span class="pc">:</span>
            <span class="pc">cf.</span><span class="w">ser</span><span class="pc">ver</span> <span class="pc">=</span> <span class="w">F</span><span class="c">alse</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="w">c</span><span class="pc">f.</span><span class="w">cl</span><span class="pc">ient</span> <span class="c">=</span> <span class="pc">T</span><span class="c">rue</span>

        <span class="pc">s</span><span class="c">elf.</span><span class="w">serverProto</span> <span class="c">=</span> <span class="w">s</span><span class="pc">erverP</span><span class="c">roto</span>
        <span class="w">sf</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol</span><span class="pc">.</span><span class="w">S</span><span class="c">erverFactory()</span>
        <span class="w">s</span><span class="pc">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ambda:</span> <span class="w">s</span><span class="pc">er</span><span class="c">verProto</span>
        <span class="w">i</span><span class="c">f</span> <span class="pc">clientI</span><span class="c">sServer:</span>
            <span class="w">s</span><span class="pc">f</span><span class="c">.</span><span class="w">cl</span><span class="pc">ient</span> <span class="pc">=</span> <span class="w">F</span><span class="c">alse</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="w">s</span><span class="pc">f.</span><span class="w">se</span><span class="pc">rver</span> <span class="c">=</span> <span class="pc">T</span><span class="c">rue</span>

        <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="pc">s</span><span class="c">f,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">"</span><span class="c">127.0.0.1</span><span class="pc">")</span>
        <span class="c">self.addCleanup(</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening</span><span class="pc">)</span>

        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">co</span><span class="c">nnectTCP</span><span class="pc">('</span><span class="c">127.0.0.1</span><span class="pc">'</span><span class="c">,</span> <span class="w">p</span><span class="c">ort</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="w">cf</span><span class="pc">)</span>

        <span class="pc">ret</span><span class="c">urn</span> <span class="c">defer.</span><span class="pc">g</span><span class="c">atherResults([</span><span class="w">clientProto</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred,</span> <span class="w">serverProto</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="w">]</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_TLS</span><span class="c">(self):</span>
        
        <span class="pc">de</span><span class="c">f</span> <span class="pc">ch</span><span class="c">eck(</span><span class="w">ignore</span><span class="c">):</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">serve</span><span class="pc">rF</span><span class="c">actory.</span><span class="w">l</span><span class="c">ines</span><span class="pc">,</span>
                <span class="w">UnintelligentProtocol</span><span class="pc">.</span><span class="w">pretext</span> <span class="w">+</span> <span class="w">U</span><span class="c">nintelligentProtocol.</span><span class="w">posttext</span>
            <span class="c">)</span>
        <span class="pc">d</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">_runTest</span><span class="pc">(U</span><span class="c">nintelligentProtocol</span><span class="w">(</span><span class="pc">),</span>
                          <span class="w">LineCollector</span><span class="pc">(</span><span class="w">T</span><span class="c">rue</span><span class="pc">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">fillBuffer)</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="w">c</span><span class="c">heck)</span>


    <span class="c">def</span> <span class="w">test_unTLS</span><span class="c">(self):</span>
        
        <span class="pc">de</span><span class="c">f</span> <span class="pc">ch</span><span class="c">eck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">l</span><span class="pc">ines,</span>
                <span class="pc">U</span><span class="c">nintelligentProtocol</span><span class="pc">.</span><span class="w">pretext</span>
            <span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">ailUnless(self.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">rawdata</span><span class="pc">,</span>
                            <span class="w">"N</span><span class="c">o</span> <span class="w">encrypted</span> <span class="w">b</span><span class="pc">y</span><span class="c">tes</span> <span class="w">rec</span><span class="c">eived</span><span class="pc">"</span><span class="c">)</span>
        <span class="w">d</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">_runTest</span><span class="c">(</span><span class="w">U</span><span class="c">nintelligentProtocol</span><span class="w">(</span><span class="pc">),</span>
                          <span class="w">LineCollector</span><span class="pc">(</span><span class="w">F</span><span class="c">alse</span><span class="pc">,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">fillBuffer)</span><span class="pc">)</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="w">c</span><span class="c">heck)</span>


    <span class="c">def</span> <span class="w">test_backwardsTLS</span><span class="c">(self):</span>
        
        <span class="pc">de</span><span class="c">f</span> <span class="pc">c</span><span class="c">heck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">cli</span><span class="pc">entF</span><span class="c">actory.</span><span class="w">l</span><span class="pc">ines,</span>
                <span class="pc">U</span><span class="c">nintelligentProtocol</span><span class="pc">.</span><span class="w">pretext</span> <span class="w">+</span> <span class="w">U</span><span class="c">nintelligentProtocol</span><span class="pc">.</span><span class="w">posttext</span>
            <span class="c">)</span>
        <span class="pc">d</span> <span class="c">=</span> <span class="c">self.</span><span class="w">_runTest</span><span class="c">(</span><span class="w">LineCollector(T</span><span class="c">rue</span><span class="pc">,</span> <span class="c">self.</span><span class="w">fillBuffer)</span><span class="pc">,</span>
                          <span class="pc">U</span><span class="c">nintelligentProtocol</span><span class="w">(</span><span class="pc">),</span> <span class="w">T</span><span class="c">rue)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d.</span><span class="c">addCallback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eck)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">SpammyTLSTests</span><span class="c">(</span><span class="w">TLSTests</span><span class="c">):</span>
    
    <span class="w">f</span><span class="pc">i</span><span class="c">llBuffer</span> <span class="c">=</span> <span class="w">T</span><span class="c">rue</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">BufferingTests</span><span class="c">(</span><span class="pc">u</span><span class="c">nittest.TestCase):</span>
    <span class="w">serverProto</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span>
    <span class="w">clientProto</span> <span class="c">=</span> <span class="c">None</span>


    <span class="c">def</span> <span class="w">t</span><span class="c">earDown(self):</span>
        <span class="w">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="c">erverProto</span><span class="pc">.</span><span class="w">t</span><span class="c">ransport</span> <span class="pc">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">None:</span>
            <span class="c">self.serverProto.</span><span class="w">t</span><span class="c">ransport</span><span class="pc">.</span><span class="c">loseConnection()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">c</span><span class="c">lientProto</span><span class="pc">.</span><span class="w">t</span><span class="c">ransport</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">None:</span>
            <span class="c">self.</span><span class="pc">c</span><span class="c">lientProto.</span><span class="pc">t</span><span class="c">ransport.loseConnection()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_openSSLBuffering</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="w">s</span><span class="pc">erverP</span><span class="c">roto</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">s</span><span class="c">erverProto</span> <span class="w">=</span> <span class="w">SingleLineServerProtocol</span><span class="c">()</span>
        <span class="w">c</span><span class="pc">lientProto</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">c</span><span class="pc">lientP</span><span class="c">roto</span> <span class="pc">=</span> <span class="w">RecordingClientProtocol</span><span class="c">()</span>

        <span class="w">s</span><span class="pc">erver</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">S</span><span class="c">erverFactory()</span>
        <span class="w">c</span><span class="pc">lient</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">c</span><span class="c">lient</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">C</span><span class="c">lientFactory()</span>

        <span class="w">s</span><span class="pc">er</span><span class="c">ver.protocol</span> <span class="c">=</span> <span class="w">l</span><span class="c">ambda:</span> <span class="w">s</span><span class="pc">erverP</span><span class="c">roto</span>
        <span class="w">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="c">=</span> <span class="w">l</span><span class="c">ambda:</span> <span class="w">c</span><span class="pc">lientProto</span>

        <span class="w">sCTX</span> <span class="c">=</span> <span class="w">s</span><span class="pc">s</span><span class="c">l.</span><span class="w">DefaultOpenSSLContextFactory</span><span class="c">(</span><span class="w">certPath</span><span class="c">,</span> <span class="w">ce</span><span class="c">rtPath</span><span class="pc">)</span>
        <span class="w">cCTX</span> <span class="c">=</span> <span class="w">ss</span><span class="c">l.</span><span class="w">ClientContextFactory</span><span class="pc">()</span>

        <span class="w">p</span><span class="pc">ort</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="w">listenSSL</span><span class="pc">(</span><span class="w">0</span><span class="c">,</span> <span class="w">s</span><span class="pc">e</span><span class="c">rver</span><span class="pc">,</span> <span class="w">s</span><span class="c">CTX,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">='</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="pc">p</span><span class="c">ort.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening</span><span class="pc">)</span>

        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">connectSSL(</span><span class="pc">'</span><span class="c">127.0.0.1',</span> <span class="w">p</span><span class="c">ort</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="pc">c</span><span class="c">lient</span><span class="pc">,</span> <span class="w">cCTX</span><span class="pc">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="w">clientProto.d</span><span class="pc">eferr</span><span class="c">ed.addCallback(</span>
            <span class="c">self.assertEqual,</span> <span class="pc">b</span><span class="w">"+O</span><span class="c">K</span> <span class="w">&lt;so</span><span class="pc">m</span><span class="c">e</span> <span class="w">crap&gt;\r</span><span class="c">\n</span><span class="pc">"</span><span class="c">)</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">ConnectionLostTests</span><span class="c">(unittest.TestCase</span><span class="pc">,</span> <span class="w">ContextGeneratingMixin</span><span class="c">):</span>
    

    <span class="c">def</span> <span class="w">testImmediateDisconnect</span><span class="c">(self):</span>
        <span class="w">or</span><span class="pc">g</span> <span class="pc">= "</span><span class="w">t</span><span class="pc">w</span><span class="c">isted.</span><span class="w">t</span><span class="pc">est</span><span class="c">.</span><span class="w">test_ssl"</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">setupServerAndClient</span><span class="pc">(</span>
            <span class="w">(or</span><span class="pc">g</span><span class="w">,</span> <span class="w">or</span><span class="pc">g</span> <span class="w">+ ",</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent</span><span class="w">"), {},</span>
            <span class="w">(or</span><span class="pc">g</span><span class="w">,</span> <span class="w">or</span><span class="pc">g</span> <span class="w">+</span><span class="pc"> </span><span class="c">",</span> <span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="w">"), {})</span>

        
        
        <span class="w">serverProtocolFactory</span> <span class="c">=</span> <span class="w">pr</span><span class="pc">otocol</span><span class="c">.</span><span class="w">S</span><span class="pc">e</span><span class="c">rverFactory()</span>
        <span class="pc">ser</span><span class="c">verProtocolFactory.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="pc">P</span><span class="c">rotocol</span>
        <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">serverPort</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">erverPo</span><span class="c">rt</span> <span class="w">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="w">listenSSL</span><span class="c">(</span><span class="w">0</span><span class="pc">,</span>
            <span class="w">s</span><span class="pc">erverPr</span><span class="c">otocolFactory</span><span class="pc">,</span> <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">serverCtxFactory</span><span class="pc">)</span>

        <span class="w">clientProtocolFactory</span> <span class="c">=</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="w">C</span><span class="c">lientFactory()</span>
        <span class="w">c</span><span class="c">lientProtocolFactory.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">ImmediatelyDisconnectingProtocol</span>
        <span class="w">c</span><span class="pc">li</span><span class="c">entProtocolFactory</span><span class="pc">.</span><span class="w">connectionDisconnected</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>
        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">connectSSL(</span><span class="pc">'</span><span class="c">127.0.0.1',</span>
            <span class="w">serverPort</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="w">c</span><span class="pc">lientP</span><span class="c">rotocolFactory</span><span class="pc">,</span> <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">clientCtxFactory</span><span class="pc">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">lientP</span><span class="c">rotocolFactory.</span><span class="pc">co</span><span class="c">nnectionDisconnected</span><span class="pc">.a</span><span class="c">ddCallback(</span>
            <span class="pc">l</span><span class="c">ambda</span> <span class="w">ignoredResult</span><span class="c">:</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="pc">erverP</span><span class="c">ort.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening</span><span class="pc">())</span>


    <span class="c">def</span> <span class="w">test_bothSidesLoseConnection</span><span class="c">(self):</span>
        
        <span class="w">c</span><span class="c">lass</span> <span class="w">CloseAfterHandshake</span><span class="c">(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.Protocol):</span>
            <span class="w">gotData</span> <span class="c">=</span> <span class="c">False</span>

            <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">)</span><span class="c">:</span>
                <span class="c">self.</span><span class="w">do</span><span class="pc">n</span><span class="c">e</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>

            <span class="pc">d</span><span class="c">ef</span> <span class="c">connectionMade(self):</span>
                <span class="c">self.transport.</span><span class="pc">w</span><span class="c">rite</span><span class="pc">(b"</span><span class="w">a</span><span class="c">")</span>

            <span class="pc">d</span><span class="c">ef</span> <span class="pc">d</span><span class="c">ataReceived(self</span><span class="pc">,</span> <span class="c">data):</span>
                
                <span class="c">self.</span><span class="pc">g</span><span class="c">otData</span> <span class="pc">=</span> <span class="pc">T</span><span class="c">rue</span>
                <span class="pc">s</span><span class="c">elf.transport.loseConnection()</span>

            <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionLost(self,</span> <span class="c">reason):</span>
                <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="pc">g</span><span class="c">otData:</span>
                    <span class="pc">rea</span><span class="c">son</span> <span class="c">=</span> <span class="w">R</span><span class="c">untimeError</span><span class="pc">("</span><span class="w">We</span> <span class="w">never</span> <span class="w">rec</span><span class="c">eived</span> <span class="w">th</span><span class="pc">e</span> <span class="pc">d</span><span class="c">ata</span><span class="w">!</span><span class="pc">"</span><span class="c">)</span>
                <span class="c">self.</span><span class="w">d</span><span class="pc">o</span><span class="c">ne.</span><span class="pc">e</span><span class="c">rrback(reason)</span>
                <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="w">d</span><span class="pc">o</span><span class="c">ne</span>

        <span class="w">or</span><span class="pc">g</span> <span class="w">=</span><span class="pc"> "</span><span class="w">t</span><span class="pc">w</span><span class="c">isted.</span><span class="pc">t</span><span class="c">est.</span><span class="w">test_ssl"</span>
        <span class="c">self.</span><span class="w">setupServerAndClient</span><span class="pc">(</span>
            <span class="w">(or</span><span class="pc">g</span><span class="c">,</span> <span class="w">or</span><span class="pc">g</span> <span class="w">+ ",</span> <span class="w">cl</span><span class="pc">i</span><span class="c">ent</span><span class="w">"), {},</span>
            <span class="w">(or</span><span class="pc">g,</span> <span class="w">or</span><span class="pc">g</span> <span class="w">+</span><span class="pc"> </span><span class="c">",</span> <span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="w">"), {})</span>

        <span class="w">se</span><span class="pc">rverP</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">CloseAfterHandshake</span><span class="pc">()</span>
        <span class="w">serverProtocolFactory</span> <span class="c">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">S</span><span class="pc">e</span><span class="c">rverFactory()</span>
        <span class="pc">ser</span><span class="c">verProtocolFactory.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ambda:</span> <span class="w">se</span><span class="pc">rverProtocol</span>
        <span class="w">serverPort</span> <span class="c">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">listenSSL</span><span class="c">(</span><span class="w">0</span><span class="c">,</span>
            <span class="pc">s</span><span class="c">erverProtocolFactory,</span> <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">serverCtxFactory</span><span class="pc">)</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">s</span><span class="pc">erverPo</span><span class="c">rt.</span><span class="w">st</span><span class="pc">opL</span><span class="c">istening)</span>

        <span class="w">c</span><span class="pc">li</span><span class="c">entProtocol</span> <span class="pc">=</span> <span class="w">C</span><span class="c">loseAfterHandshake</span><span class="pc">()</span>
        <span class="w">clientProtocolFactory</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">C</span><span class="c">lientFactory()</span>
        <span class="w">c</span><span class="c">lientProtocolFactory.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="c">lambda:</span> <span class="w">c</span><span class="pc">lientProtocol</span>
        <span class="w">r</span><span class="c">eactor.</span><span class="w">connectSSL(</span><span class="pc">'</span><span class="c">127.0.0.1',</span>
            <span class="w">s</span><span class="pc">er</span><span class="c">verPort</span><span class="pc">.g</span><span class="c">etHost().port</span><span class="pc">,</span> <span class="pc">c</span><span class="c">lientProtocolFactory</span><span class="pc">,</span> <span class="w">s</span><span class="c">elf.</span><span class="w">clientCtxFactory</span><span class="c">)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">checkResult</span><span class="c">(</span><span class="w">f</span><span class="pc">a</span><span class="c">ilure):</span>
            <span class="w">f</span><span class="pc">ai</span><span class="c">lure.</span><span class="pc">t</span><span class="c">rap(</span><span class="w">C</span><span class="c">onnectionDone)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">de</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults(</span>
            <span class="w">[cli</span><span class="pc">entProtocol</span><span class="c">.</span><span class="w">d</span><span class="pc">on</span><span class="c">e.</span><span class="w">a</span><span class="pc">ddE</span><span class="c">rrback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eckResult</span><span class="w">)</span><span class="pc">,</span>
             <span class="w">ser</span><span class="pc">verPr</span><span class="c">otocol</span><span class="pc">.</span><span class="w">do</span><span class="pc">n</span><span class="c">e.</span><span class="pc">addE</span><span class="c">rrback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eckResult</span><span class="w">)]</span><span class="c">)</span>

    <span class="pc">i</span><span class="c">f</span> <span class="w">newTLS</span> <span class="pc">i</span><span class="c">s</span> <span class="c">None:</span>
        <span class="w">test_bothSidesLoseConnection</span><span class="pc">.s</span><span class="c">kip</span> <span class="c">= "</span><span class="w">Old</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="w">cod</span><span class="c">e</span> <span class="w">doesn'</span><span class="c">t</span> <span class="w">always</span> <span class="w">cl</span><span class="pc">ose</span> <span class="w">cleanly.</span><span class="pc">"</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">testFailedVerify</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="w">or</span><span class="pc">g</span> <span class="pc">= "</span><span class="w">t</span><span class="pc">w</span><span class="c">isted.</span><span class="w">t</span><span class="pc">est</span><span class="c">.</span><span class="w">test_ssl"</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">setupServerAndClient</span><span class="pc">(</span>
            <span class="w">(or</span><span class="pc">g</span><span class="w">,</span> <span class="w">or</span><span class="pc">g</span> <span class="w">+ ",</span> <span class="w">c</span><span class="pc">li</span><span class="c">ent</span><span class="w">"), {},</span>
            <span class="w">(or</span><span class="pc">g</span><span class="w">,</span> <span class="w">or</span><span class="pc">g</span> <span class="w">+</span><span class="pc"> </span><span class="c">",</span> <span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="w">"), {})</span>

        <span class="c">def</span> <span class="w">v</span><span class="pc">eri</span><span class="c">fy</span><span class="pc">(*a</span><span class="c">):</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">F</span><span class="c">alse</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">clientCtxFactory.getContext(</span><span class="pc">).</span><span class="w">set_verify</span><span class="c">(</span><span class="w">S</span><span class="pc">S</span><span class="c">L.</span><span class="w">VERIFY_PEER</span><span class="c">,</span> <span class="w">ve</span><span class="pc">rify)</span>

        <span class="w">serverConnLost</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>
        <span class="w">s</span><span class="pc">erverP</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="pc">P</span><span class="c">rotocol()</span>
        <span class="w">s</span><span class="pc">erverP</span><span class="c">rotocol.</span><span class="w">c</span><span class="pc">onnecti</span><span class="c">onLost</span> <span class="pc">=</span> <span class="pc">ser</span><span class="c">verConnLost.</span><span class="w">c</span><span class="c">allback</span>
        <span class="w">serverProtocolFactory</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">S</span><span class="c">erverFactory()</span>
        <span class="w">s</span><span class="pc">erverP</span><span class="c">rotocolFactory</span><span class="pc">.p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="c">lambda:</span> <span class="w">s</span><span class="pc">erverProtocol</span>
        <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">serverPort</span> <span class="pc">=</span> <span class="w">ser</span><span class="pc">verPo</span><span class="c">rt</span> <span class="w">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="w">listenSSL</span><span class="c">(</span><span class="w">0</span><span class="c">,</span>
            <span class="w">serverP</span><span class="pc">rotocolF</span><span class="c">actory</span><span class="pc">,</span> <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">serverCtxFactory</span><span class="pc">)</span>

        <span class="w">clientConnLost</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="w">c</span><span class="pc">lientP</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">P</span><span class="c">rotocol()</span>
        <span class="w">cl</span><span class="pc">ientP</span><span class="c">rotocol.</span><span class="w">c</span><span class="pc">onnecti</span><span class="c">onLost</span> <span class="pc">=</span> <span class="w">c</span><span class="c">lientConnLost.</span><span class="pc">c</span><span class="c">allback</span>
        <span class="w">clientProtocolFactory</span> <span class="c">=</span> <span class="pc">p</span><span class="c">rotocol.</span><span class="w">C</span><span class="c">lientFactory()</span>
        <span class="w">cli</span><span class="pc">entProtocolF</span><span class="c">actory.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="c">lambda:</span> <span class="pc">clientProtocol</span>
        <span class="w">r</span><span class="c">eactor.</span><span class="w">connectSSL('</span><span class="c">127.0.0.1',</span>
            <span class="w">serverPort.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="w">c</span><span class="pc">lientP</span><span class="c">rotocolFactory</span><span class="pc">,</span> <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">clientCtxFactory</span><span class="pc">)</span>

        <span class="w">dl</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.</span><span class="w">D</span><span class="pc">eferredL</span><span class="c">ist</span><span class="pc">([</span><span class="w">serverConnLost</span><span class="pc">,</span> <span class="w">clientConnLost]</span><span class="pc">,</span> <span class="w">consumeErrors</span><span class="c">=</span><span class="pc">T</span><span class="c">rue)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">l</span><span class="c">.addCallback(self.</span><span class="w">_cbLostConns</span><span class="pc">)</span>


    <span class="c">def</span> <span class="c">_cbLostConns(self</span><span class="pc">,</span> <span class="w">res</span><span class="pc">ults</span><span class="c">):</span>
        <span class="w">(sSuccess</span><span class="c">,</span> <span class="w">sResult),</span><span class="pc"> </span><span class="c">(</span><span class="w">cSuccess</span><span class="c">,</span> <span class="w">cResult) =</span> <span class="w">res</span><span class="pc">ults</span>

        <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">fa</span><span class="pc">ilI</span><span class="c">f(</span><span class="w">s</span><span class="pc">S</span><span class="c">uccess</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ailI</span><span class="c">f(</span><span class="w">c</span><span class="pc">S</span><span class="c">uccess</span><span class="pc">)</span>

        <span class="w">acceptableErrors</span> <span class="pc">= [</span><span class="w">SS</span><span class="c">L.</span><span class="w">E</span><span class="pc">r</span><span class="c">ror</span><span class="w">]</span>

        
        
        
        
        
        
        

        <span class="w">i</span><span class="c">f</span> <span class="w">p</span><span class="c">latform.</span><span class="w">isWindows</span><span class="pc">(</span><span class="c">):</span>
            <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="c">twisted.internet</span><span class="pc">.</span><span class="w">e</span><span class="c">rror</span> <span class="c">import</span> <span class="w">ConnectionLost</span>
            <span class="w">a</span><span class="pc">c</span><span class="c">ceptableErrors</span><span class="pc">.</span><span class="w">ap</span><span class="pc">pe</span><span class="c">nd(</span><span class="w">C</span><span class="c">onnectionLost)</span>

        <span class="w">sResult</span><span class="pc">.</span><span class="w">t</span><span class="c">rap</span><span class="w">(*a</span><span class="pc">c</span><span class="c">ceptableErrors)</span>
        <span class="w">cResult</span><span class="pc">.</span><span class="w">t</span><span class="c">rap</span><span class="w">(*</span><span class="pc">ac</span><span class="c">ceptableErrors)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">serverPort</span><span class="pc">.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening()</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">FakeContext</span><span class="pc">:</span>
    
    <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">m</span><span class="pc">et</span><span class="c">hod):</span>
        <span class="c">self.</span><span class="w">_method</span> <span class="c">=</span> <span class="w">m</span><span class="pc">e</span><span class="c">thod</span>
        <span class="c">self.</span><span class="w">_options</span> <span class="c">=</span> <span class="w">0</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">set_options</span><span class="c">(self,</span> <span class="w">op</span><span class="pc">tions)</span><span class="c">:</span>
        <span class="c">self._options</span> <span class="w">|=</span> <span class="w">op</span><span class="pc">tions</span>


    <span class="w">d</span><span class="c">ef</span> <span class="w">use_certificate_file</span><span class="c">(self</span><span class="pc">,</span> <span class="w">fileName</span><span class="c">):</span>
        <span class="w">p</span><span class="pc">a</span><span class="c">ss</span>


    <span class="c">def</span> <span class="w">use_privatekey_file</span><span class="c">(self</span><span class="pc">,</span> <span class="c">fileName):</span>
        <span class="w">p</span><span class="c">ass</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">DefaultOpenSSLContextFactoryTests</span><span class="c">(unittest.TestCase):</span>
    
    <span class="c">def</span> <span class="c">setUp(self):</span>
        
        
        <span class="c">self.</span><span class="w">cont</span><span class="pc">extF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">ss</span><span class="c">l.</span><span class="w">DefaultOpenSSLContextFactory</span><span class="c">(</span>
            <span class="w">certPath</span><span class="pc">,</span> <span class="w">c</span><span class="c">ertPath</span><span class="pc">,</span> <span class="w">_contextFactory</span><span class="c">=</span><span class="w">FakeContext</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">cont</span><span class="pc">ext</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">co</span><span class="pc">nt</span><span class="c">extFactory.</span><span class="w">getContext</span><span class="pc">()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_method</span><span class="c">(self):</span>
        
        
        <span class="c">self.assertEqual(self.</span><span class="w">cont</span><span class="pc">ext</span><span class="c">.</span><span class="w">_method</span><span class="c">,</span> <span class="w">S</span><span class="pc">S</span><span class="c">L.</span><span class="w">SSLv23_METHOD</span><span class="c">)</span>

        
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(self.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">t.</span><span class="w">_options</span> <span class="w">&amp;</span> <span class="w">S</span><span class="pc">SL</span><span class="c">.</span><span class="w">OP_NO_SSLv2</span><span class="c">)</span>

        
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">t.</span><span class="pc">_</span><span class="c">options</span> <span class="w">&amp;</span> <span class="w">SS</span><span class="pc">L</span><span class="c">.</span><span class="w">OP_NO_SSLv3</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">t.</span><span class="pc">_</span><span class="c">options</span> <span class="w">&amp;</span> <span class="w">SS</span><span class="pc">L</span><span class="c">.</span><span class="w">OP_NO_TLSv1</span><span class="c">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_missingCertificateFile</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="pc">assertR</span><span class="c">aises(</span>
            <span class="w">SS</span><span class="c">L.</span><span class="w">E</span><span class="pc">r</span><span class="c">ror,</span>
            <span class="w">ss</span><span class="c">l.</span><span class="w">DefaultOpenSSLContextFactory</span><span class="pc">,</span> <span class="w">certPath</span><span class="pc">,</span> <span class="c">self.</span><span class="w">m</span><span class="pc">k</span><span class="c">temp())</span>


    <span class="c">def</span> <span class="w">test_missingPrivateKeyFile</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="pc">assertR</span><span class="c">aises(</span>
            <span class="w">SS</span><span class="c">L.</span><span class="w">E</span><span class="pc">r</span><span class="c">ror,</span>
            <span class="w">ss</span><span class="c">l.</span><span class="pc">D</span><span class="c">efaultOpenSSLContextFactory,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">m</span><span class="c">ktemp</span><span class="pc">(),</span> <span class="w">c</span><span class="c">ertPath</span><span class="pc">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ClientContextFactoryTests</span><span class="c">(unittest.TestCase):</span>
    
    <span class="c">def</span> <span class="c">setUp(self):</span>
        <span class="c">self.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">tFactory</span> <span class="c">=</span> <span class="w">ss</span><span class="c">l.</span><span class="w">ClientContextFactory</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">tFactory</span><span class="pc">.</span><span class="w">_contextFactory</span> <span class="c">=</span> <span class="w">FakeContext</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">cont</span><span class="pc">ext</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">tFactory.</span><span class="w">getContext</span><span class="pc">()</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_method</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="pc">a</span><span class="c">ssertEqual(self.</span><span class="w">cont</span><span class="pc">ext</span><span class="c">.</span><span class="w">_method</span><span class="c">,</span> <span class="w">S</span><span class="pc">S</span><span class="c">L.</span><span class="w">SSLv23_METHOD</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(self.</span><span class="w">cont</span><span class="pc">ext</span><span class="c">.</span><span class="w">_options</span> <span class="w">&amp;</span> <span class="w">S</span><span class="pc">SL</span><span class="c">.</span><span class="w">OP_NO_SSLv2</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">t.</span><span class="pc">_</span><span class="c">options</span> <span class="w">&amp;</span> <span class="w">SS</span><span class="pc">L</span><span class="c">.</span><span class="w">OP_NO_SSLv3</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertF</span><span class="c">alse(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">cont</span><span class="pc">ex</span><span class="c">t.</span><span class="pc">_</span><span class="c">options</span> <span class="w">&amp;</span> <span class="w">SS</span><span class="pc">L</span><span class="c">.</span><span class="w">OP_NO_TLSv1</span><span class="c">)</span>



<span class="pc">i</span><span class="c">f</span> <span class="w">i</span><span class="pc">nt</span><span class="c">erfaces.</span><span class="w">IReactorSSL(r</span><span class="c">eactor</span><span class="pc">,</span> <span class="c">None</span><span class="pc">)</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">N</span><span class="c">one:</span>
    <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">tCase</span> <span class="c">in</span> <span class="w">[StolenTCPTests</span><span class="pc">,</span> <span class="w">TLSTests</span><span class="c">,</span> <span class="w">SpammyTLSTests</span><span class="c">,</span>
                  <span class="w">BufferingTests</span><span class="c">,</span> <span class="w">ConnectionLostTests</span><span class="pc">,</span>
                  <span class="w">DefaultOpenSSLContextFactoryTests</span><span class="pc">,</span>
                  <span class="w">ClientContextFactoryTests]:</span>
        <span class="w">t</span><span class="pc">C</span><span class="c">ase</span><span class="pc">.</span><span class="w">s</span><span class="pc">k</span><span class="c">ip</span> <span class="pc">= "</span><span class="w">Reactor</span> <span class="w">d</span><span class="pc">o</span><span class="c">es</span> <span class="c">not</span> <span class="w">su</span><span class="pc">pport</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span><span class="w">,</span> <span class="w">cannot</span> <span class="w">r</span><span class="pc">u</span><span class="c">n</span> <span class="w">S</span><span class="pc">S</span><span class="c">L</span> <span class="w">tests</span><span class="pc">"</span>


</pre>
</body>
</html>

