<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>






<span class="w">import</span> <span class="w">struct</span>

<span class="w">from</span> <span class="w">twisted.conch.ssh</span> <span class="w">import</span> <span class="w">service,</span> <span class="w">common</span>
<span class="w">from</span> <span class="w">twisted.conch</span> <span class="w">import</span> <span class="w">error</span>
<span class="w">from</span> <span class="w">twisted.internet</span> <span class="w">import</span> <span class="w">defer</span>
<span class="w">from</span> <span class="w">twisted.python</span> <span class="w">import</span> <span class="w">log</span>

<span class="w">class</span> <span class="w">SSHConnection(service.SSHService):</span>
    
    <span class="w">name</span> <span class="w">= 'ssh</span><span class="pc">-</span><span class="w">c</span><span class="pc">onn</span><span class="c">ection</span><span class="pc">'</span>

    <span class="w">d</span><span class="c">ef</span> <span class="pc">_</span><span class="c">_init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">localChannelID</span> <span class="c">=</span> <span class="w">0</span> 
        <span class="c">self.</span><span class="w">localToRemoteChannel</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span> 
        <span class="c">self.</span><span class="w">channels</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span> 
        <span class="pc">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel</span> <span class="w">=</span><span class="pc"> {</span><span class="c">}</span> 
                                          
        <span class="c">self.</span><span class="w">deferreds</span> <span class="w">= {"global": []}</span> 
                            
                            
        <span class="pc">s</span><span class="c">elf.</span><span class="w">t</span><span class="c">ransport</span> <span class="pc">=</span> <span class="c">None</span> 


    <span class="pc">d</span><span class="c">ef</span> <span class="w">serviceStarted</span><span class="c">(self):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">h</span><span class="c">asattr(self.</span><span class="w">t</span><span class="c">ransport</span><span class="pc">, </span><span class="c">'</span><span class="w">a</span><span class="pc">v</span><span class="c">atar'):</span>
            <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">a</span><span class="pc">v</span><span class="c">atar</span><span class="pc">.</span><span class="w">con</span><span class="pc">n</span> <span class="pc">=</span> <span class="c">self</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">serviceStopped</span><span class="c">(self):</span>
        
        <span class="w">ma</span><span class="pc">p</span><span class="c">(self.</span><span class="w">channelClosed</span><span class="c">,</span> <span class="c">self.</span><span class="w">channels.v</span><span class="pc">alues())</span>
        <span class="c">self.</span><span class="w">_cleanupGlobalDeferreds</span><span class="c">()</span>


    <span class="c">def</span> <span class="w">_</span><span class="c">cleanupGlobalDeferreds(self):</span>
        
        <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">d</span> <span class="c">in</span> <span class="c">self.</span><span class="w">deferreds[</span><span class="pc">"</span><span class="w">global"]:</span>
            <span class="w">d</span><span class="pc">.e</span><span class="c">rrback(</span><span class="pc">e</span><span class="c">rror.</span><span class="w">ConchError</span><span class="pc">("</span><span class="w">C</span><span class="c">onnection</span> <span class="w">sto</span><span class="c">pped</span><span class="w">."))</span>
        <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="pc">d</span><span class="c">eferreds</span><span class="w">[</span><span class="pc">"</span><span class="w">g</span><span class="c">lobal</span><span class="w">"][:]</span>


    
    <span class="w">d</span><span class="c">ef</span> <span class="w">ssh_GLOBAL_REQUEST</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket):</span>
        
        <span class="w">requestType,</span> <span class="pc">r</span><span class="c">est</span> <span class="c">=</span> <span class="w">c</span><span class="c">ommon.</span><span class="w">g</span><span class="pc">e</span><span class="c">tNS(</span><span class="w">p</span><span class="c">acket)</span>
        <span class="w">wantReply,</span> <span class="w">r</span><span class="pc">es</span><span class="c">t</span> <span class="c">=</span> <span class="w">ord</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">t</span><span class="pc">[</span><span class="c">0</span><span class="w">])</span><span class="pc">,</span> <span class="w">r</span><span class="pc">es</span><span class="c">t[</span><span class="pc">1:</span><span class="c">]</span>
        <span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">self.</span><span class="w">gotGlobalRequest</span><span class="c">(</span><span class="pc">r</span><span class="c">equestType,</span> <span class="w">r</span><span class="pc">es</span><span class="c">t</span><span class="pc">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">w</span><span class="c">antReply</span><span class="pc">:</span>
            <span class="w">reply</span> <span class="c">=</span> <span class="w">MSG_REQUEST_FAILURE</span>
            <span class="w">da</span><span class="c">ta</span> <span class="w">= '</span><span class="pc">'</span>
            <span class="c">if</span> <span class="w">ret</span><span class="c">:</span>
                <span class="w">r</span><span class="pc">ep</span><span class="c">ly</span> <span class="pc">=</span> <span class="w">MSG_REQUEST_SUCCESS</span>
                <span class="pc">i</span><span class="c">f</span> <span class="w">i</span><span class="c">sinstance(</span><span class="w">ret,</span><span class="pc"> (</span><span class="w">tu</span><span class="c">ple</span><span class="pc">,</span> <span class="w">l</span><span class="pc">is</span><span class="c">t</span><span class="pc">))</span><span class="c">:</span>
                    <span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="c">=</span> <span class="w">ret</span><span class="pc">[1</span><span class="c">]</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="c">(reply,</span> <span class="pc">d</span><span class="c">ata)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_REQUEST_SUCCESS</span><span class="c">(self,</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket):</span>
        
        <span class="w">l</span><span class="c">og.msg('</span><span class="w">RS</span><span class="pc">')</span>
        <span class="c">self.</span><span class="w">deferreds[</span><span class="pc">'</span><span class="w">global'].po</span><span class="pc">p</span><span class="c">(0</span><span class="w">)</span><span class="pc">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="w">p</span><span class="pc">a</span><span class="c">cket)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_REQUEST_FAILURE</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket):</span>
        
        <span class="w">l</span><span class="c">og.msg('</span><span class="w">RF</span><span class="pc">')</span>
        <span class="c">self.</span><span class="w">d</span><span class="c">eferreds</span><span class="w">[</span><span class="pc">'</span><span class="w">g</span><span class="pc">l</span><span class="c">obal</span><span class="w">'].po</span><span class="pc">p(</span><span class="c">0</span><span class="pc">).</span><span class="w">e</span><span class="pc">r</span><span class="c">rback(</span>
            <span class="w">e</span><span class="c">rror</span><span class="pc">.</span><span class="w">ConchError</span><span class="pc">('</span><span class="w">g</span><span class="c">lobal</span> <span class="w">req</span><span class="pc">uest</span> <span class="w">fa</span><span class="c">iled</span><span class="w">'</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="w">)</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_CHANNEL_OPEN</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="c">acket):</span>
        
        <span class="w">channelType</span><span class="pc">,</span> <span class="c">rest</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ommon.</span><span class="pc">g</span><span class="c">etNS(</span><span class="w">p</span><span class="c">acket)</span>
        <span class="w">senderChannel</span><span class="pc">,</span> <span class="w">windowSize</span><span class="pc">,</span> <span class="w">maxPacket</span> <span class="c">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('&gt;3L</span><span class="c">',</span> <span class="w">r</span><span class="c">est</span><span class="w">[</span><span class="pc">:</span><span class="w">1</span><span class="pc">2</span><span class="c">])</span>
        <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span> <span class="c">=</span> <span class="w">r</span><span class="c">est[</span><span class="w">12</span><span class="pc">:]</span>
        <span class="w">t</span><span class="c">ry:</span>
            <span class="w">ch</span><span class="pc">annel</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">getChannel</span><span class="c">(</span><span class="w">ch</span><span class="pc">annelT</span><span class="c">ype</span><span class="pc">,</span> <span class="w">w</span><span class="c">indowSize</span><span class="pc">,</span> <span class="c">maxPacket</span><span class="pc">,</span>
                            <span class="w">pa</span><span class="pc">c</span><span class="c">ket</span><span class="pc">)</span>
            <span class="w">localChannel</span> <span class="c">=</span> <span class="c">self.</span><span class="w">localChannelID</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">l</span><span class="pc">ocalChannelI</span><span class="c">D</span> <span class="w">+</span><span class="c">=</span> <span class="w">1</span>
            <span class="w">c</span><span class="pc">hannel.</span><span class="w">i</span><span class="c">d</span> <span class="c">=</span> <span class="w">l</span><span class="pc">o</span><span class="c">calChannel</span>
            <span class="c">self.</span><span class="w">channels[l</span><span class="c">ocalChannel</span><span class="pc">] </span><span class="c">=</span> <span class="w">c</span><span class="c">hannel</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel[c</span><span class="pc">hannel] </span><span class="c">=</span> <span class="w">senderChannel</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">localToRemoteChannel[</span><span class="pc">l</span><span class="c">ocalChannel</span><span class="pc">] </span><span class="c">=</span> <span class="w">se</span><span class="pc">n</span><span class="c">derChannel</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="pc">(</span><span class="w">MSG_CHANNEL_OPEN_CONFIRMATION</span><span class="pc">,</span>
                <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('&gt;4L</span><span class="c">',</span> <span class="w">s</span><span class="pc">en</span><span class="c">derChannel</span><span class="pc">,</span> <span class="w">l</span><span class="pc">ocalC</span><span class="c">hannel,</span>
                    <span class="w">c</span><span class="pc">hannel</span><span class="c">.</span><span class="w">localWindowSize</span><span class="pc">,</span>
                    <span class="w">c</span><span class="pc">hannel.</span><span class="w">localMaxPacket)+c</span><span class="pc">hannel</span><span class="c">.</span><span class="w">specificData</span><span class="pc">)</span>
            <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(</span><span class="pc">c</span><span class="c">hannel,</span> <span class="pc">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">channelOpen</span><span class="pc">,</span> <span class="w">p</span><span class="c">acket)</span>
        <span class="w">e</span><span class="pc">x</span><span class="c">cept</span> <span class="w">E</span><span class="c">xception</span><span class="w">,</span> <span class="w">e</span><span class="c">:</span>
            <span class="pc">l</span><span class="c">og.</span><span class="pc">e</span><span class="c">rr(</span><span class="w">e</span><span class="pc">, </span><span class="c">'</span><span class="w">ch</span><span class="pc">annel</span> <span class="w">op</span><span class="pc">e</span><span class="c">n</span> <span class="w">f</span><span class="pc">a</span><span class="c">iled</span><span class="w">'</span><span class="c">)</span>
            <span class="c">if</span> <span class="w">i</span><span class="pc">s</span><span class="c">instance(</span><span class="pc">e</span><span class="c">,</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="pc">.</span><span class="w">ConchError</span><span class="c">):</span>
                <span class="w">textualInfo,</span> <span class="w">r</span><span class="pc">eas</span><span class="c">on</span> <span class="pc">=</span> <span class="w">e</span><span class="c">.</span><span class="pc">a</span><span class="c">rgs</span>
                <span class="w">i</span><span class="c">f</span> <span class="w">i</span><span class="c">sinstance(</span><span class="w">t</span><span class="c">extualInfo</span><span class="w">,</span><span class="pc"> (</span><span class="w">i</span><span class="c">nt,</span> <span class="w">lo</span><span class="pc">n</span><span class="c">g</span><span class="pc">))</span><span class="c">:</span>
                    
                    <span class="w">t</span><span class="pc">e</span><span class="c">xtualInfo</span><span class="pc">,</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="c">=</span> <span class="w">r</span><span class="c">eason</span><span class="w">,</span> <span class="w">t</span><span class="c">extualInfo</span>
            <span class="w">e</span><span class="c">lse:</span>
                <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="c">=</span> <span class="w">OPEN_CONNECT_FAILED</span>
                <span class="w">t</span><span class="pc">e</span><span class="c">xtualInfo</span> <span class="w">= "unknown</span> <span class="w">fa</span><span class="pc">ilu</span><span class="c">re</span><span class="w">"</span>
            <span class="w">s</span><span class="c">elf.</span><span class="w">t</span><span class="pc">r</span><span class="c">ansport.</span><span class="w">sendPacket</span><span class="pc">(</span>
                <span class="w">MSG_CHANNEL_OPEN_FAILURE</span><span class="pc">,</span>
                <span class="w">s</span><span class="pc">tr</span><span class="c">uct.pack</span><span class="w">('&gt;2L</span><span class="c">',</span> <span class="w">senderChannel</span><span class="c">,</span> <span class="w">r</span><span class="pc">eas</span><span class="c">on</span><span class="w">) </span><span class="c">+</span>
                <span class="w">c</span><span class="c">ommon.</span><span class="pc">N</span><span class="c">S(</span><span class="w">t</span><span class="pc">e</span><span class="c">xtualInfo</span><span class="w">)</span><span class="pc"> </span><span class="c">+</span> <span class="w">c</span><span class="c">ommon.NS</span><span class="w">(''))</span>

    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">ssh_CHANNEL_OPEN_CONFIRMATION</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket):</span>
        
        <span class="w">(localChannel</span><span class="c">,</span> <span class="w">remoteChannel</span><span class="c">,</span> <span class="w">windowSize</span><span class="c">,</span>
                <span class="w">maxPacket) =</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.unpack</span><span class="w">(</span><span class="pc">'&gt;</span><span class="w">4L</span><span class="c">',</span> <span class="w">p</span><span class="c">acket</span><span class="w">[</span><span class="pc">:</span> <span class="w">1</span><span class="pc">6</span><span class="c">])</span>
        <span class="w">specificData</span> <span class="c">=</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="pc">[</span><span class="w">1</span><span class="pc">6:</span><span class="c">]</span>
        <span class="w">c</span><span class="c">hannel</span> <span class="c">=</span> <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">channels</span><span class="pc">[</span><span class="w">l</span><span class="pc">o</span><span class="c">calChannel]</span>
        <span class="c">channel</span><span class="pc">.</span><span class="w">c</span><span class="c">onn</span> <span class="pc">=</span> <span class="c">self</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">localToRemoteChannel[l</span><span class="c">ocalChannel] =</span> <span class="w">remoteChannel</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel[</span><span class="pc">c</span><span class="c">hannel] =</span> <span class="w">rem</span><span class="pc">oteC</span><span class="c">hannel</span>
        <span class="w">c</span><span class="c">hannel.</span><span class="w">remoteWindowLeft</span> <span class="pc">=</span> <span class="w">windowSize</span>
        <span class="w">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">remoteMaxPacket</span> <span class="pc">=</span> <span class="w">maxPacket</span>
        <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="pc">(</span><span class="w">c</span><span class="c">hannel,</span> <span class="c">channel</span><span class="pc">.</span><span class="w">channelOpen</span><span class="pc">,</span> <span class="w">specificData</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_CHANNEL_OPEN_FAILURE</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket):</span>
        
        <span class="w">l</span><span class="c">ocalChannel</span><span class="pc">,</span> <span class="w">reasonCode</span> <span class="c">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('&gt;2L</span><span class="c">',</span> <span class="w">p</span><span class="c">acket</span><span class="pc">[</span><span class="c">:</span><span class="w">8</span><span class="c">])</span>
        <span class="w">reasonDesc</span> <span class="c">=</span> <span class="pc">co</span><span class="c">mmon.</span><span class="w">g</span><span class="c">etNS(</span><span class="w">p</span><span class="c">acket</span><span class="pc">[</span><span class="w">8:])[0</span><span class="c">]</span>
        <span class="w">c</span><span class="c">hannel</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">channels</span><span class="pc">[</span><span class="w">l</span><span class="c">ocalChannel]</span>
        <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="w">c</span><span class="pc">h</span><span class="c">annels</span><span class="pc">[</span><span class="w">l</span><span class="pc">o</span><span class="c">calChannel]</span>
        <span class="w">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">c</span><span class="pc">onn</span> <span class="pc">=</span> <span class="c">self</span>
        <span class="w">r</span><span class="pc">eason</span> <span class="w">=</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r.</span><span class="w">ConchError</span><span class="c">(</span><span class="w">r</span><span class="pc">easonD</span><span class="c">esc</span><span class="pc">,</span> <span class="w">reasonCode</span><span class="pc">)</span>
        <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">annel</span><span class="pc">,</span> <span class="w">c</span><span class="pc">hannel</span><span class="w">.openFailed</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eason)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_CHANNEL_WINDOW_ADJUST</span><span class="c">(self,</span> <span class="w">p</span><span class="c">acket):</span>
        
        <span class="w">l</span><span class="pc">oc</span><span class="c">alChannel,</span> <span class="w">bytesToAdd</span> <span class="c">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('&gt;2L</span><span class="c">',</span> <span class="w">p</span><span class="c">acket</span><span class="pc">[:</span><span class="w">8</span><span class="c">])</span>
        <span class="w">c</span><span class="pc">h</span><span class="c">annel</span> <span class="c">=</span> <span class="pc">se</span><span class="c">lf.</span><span class="w">channels</span><span class="pc">[</span><span class="w">l</span><span class="pc">o</span><span class="c">calChannel]</span>
        <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(</span><span class="pc">c</span><span class="c">hannel,</span> <span class="c">channel</span><span class="pc">.</span><span class="w">addWindowBytes</span><span class="pc">,</span> <span class="pc">b</span><span class="c">ytesToAdd)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_CHANNEL_DATA</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket):</span>
        
        <span class="w">l</span><span class="pc">oc</span><span class="c">alChannel</span><span class="pc">,</span> <span class="w">dataLength</span> <span class="c">=</span> <span class="pc">s</span><span class="c">truct.unpack</span><span class="w">('&gt;2L</span><span class="c">',</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="pc">[</span><span class="c">:</span><span class="w">8</span><span class="c">])</span>
        <span class="w">c</span><span class="c">hannel</span> <span class="c">=</span> <span class="pc">se</span><span class="c">lf.</span><span class="w">channels</span><span class="pc">[</span><span class="w">l</span><span class="pc">o</span><span class="c">calChannel]</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">(</span><span class="pc">dataL</span><span class="c">ength</span> <span class="w">&gt;</span> <span class="w">c</span><span class="pc">hannel.</span><span class="w">localWindowLeft</span> <span class="w">o</span><span class="c">r</span>
           <span class="pc">d</span><span class="c">ataLength</span> <span class="w">&gt;</span> <span class="w">ch</span><span class="pc">annel</span><span class="c">.</span><span class="w">localMaxPacket)</span><span class="pc">:</span> 
            <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(</span><span class="w">c</span><span class="pc">hannel,</span> <span class="w">lo</span><span class="pc">g</span><span class="c">.msg</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">too</span> <span class="w">much</span> <span class="w">d</span><span class="c">ata</span><span class="pc">'</span><span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">sendClose</span><span class="c">(channel</span><span class="pc">)</span>
            <span class="w">r</span><span class="c">eturn</span>
            
        <span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="w">=</span> <span class="w">c</span><span class="pc">o</span><span class="c">mmon.</span><span class="w">g</span><span class="pc">etN</span><span class="c">S(</span><span class="w">p</span><span class="c">acket</span><span class="pc">[</span><span class="w">4:])[</span><span class="c">0</span><span class="pc">]</span>
        <span class="pc">c</span><span class="c">hannel.</span><span class="w">localWindowLeft</span> <span class="w">-=</span> <span class="w">dataLength</span>
        <span class="w">i</span><span class="c">f</span> <span class="c">channel</span><span class="pc">.</span><span class="w">l</span><span class="pc">oc</span><span class="c">alWindowLeft</span> <span class="w">&lt;</span> <span class="w">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">localWindowSize</span> <span class="w">//</span> <span class="w">2</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">adjustWindow</span><span class="c">(channel,</span> <span class="c">channel</span><span class="pc">.l</span><span class="c">ocalWindowSize</span> <span class="w">- \</span>
                                       <span class="pc">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">l</span><span class="c">ocalWindowLeft</span><span class="w">)</span>
            
            
        <span class="w">l</span><span class="c">og.</span><span class="w">callWithLogger</span><span class="pc">(</span><span class="c">channel,</span> <span class="c">channel.</span><span class="w">d</span><span class="pc">ataR</span><span class="c">eceived</span><span class="pc">,</span> <span class="c">data)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_CHANNEL_EXTENDED_DATA</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket):</span>
        
        <span class="w">localChannel</span><span class="pc">,</span> <span class="w">typeCode</span><span class="pc">,</span> <span class="w">dataLength</span> <span class="pc">=</span> <span class="c">struct.unpack</span><span class="w">('&gt;3L</span><span class="c">',</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="pc">[</span><span class="c">:</span><span class="w">1</span><span class="pc">2</span><span class="c">])</span>
        <span class="w">c</span><span class="c">hannel</span> <span class="pc">=</span> <span class="pc">se</span><span class="c">lf.</span><span class="w">channels</span><span class="pc">[l</span><span class="c">ocalChannel]</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">(</span><span class="pc">dataL</span><span class="c">ength</span> <span class="w">&gt;</span> <span class="w">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">localWindowLeft</span> <span class="w">o</span><span class="c">r</span>
                <span class="pc">d</span><span class="c">ataLength</span> <span class="w">&gt;</span> <span class="w">ch</span><span class="pc">annel</span><span class="c">.</span><span class="w">localMaxPacket)</span><span class="pc">:</span>
            <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(</span><span class="w">c</span><span class="pc">hannel,</span> <span class="w">lo</span><span class="pc">g</span><span class="c">.msg</span><span class="w">,</span><span class="pc"> </span><span class="c">'</span><span class="w">too</span> <span class="w">much</span> <span class="w">extdata'</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">sendClose</span><span class="c">(</span><span class="w">c</span><span class="pc">hannel)</span>
            <span class="w">r</span><span class="c">eturn</span>
        <span class="w">d</span><span class="pc">ata</span> <span class="w">=</span> <span class="w">c</span><span class="pc">o</span><span class="c">mmon.</span><span class="w">g</span><span class="pc">etN</span><span class="c">S(</span><span class="w">p</span><span class="c">acket</span><span class="pc">[</span><span class="w">8:])[0</span><span class="pc">]</span>
        <span class="pc">c</span><span class="c">hannel.</span><span class="w">localWindowLeft</span> <span class="w">-=</span> <span class="w">dataLength</span>
        <span class="w">i</span><span class="c">f</span> <span class="c">channel</span><span class="pc">.</span><span class="w">l</span><span class="pc">oc</span><span class="c">alWindowLeft</span> <span class="w">&lt;</span> <span class="w">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">localWindowSize</span> <span class="w">//</span> <span class="w">2</span><span class="c">:</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">adjustWindow</span><span class="c">(channel,</span> <span class="c">channel</span><span class="pc">.l</span><span class="c">ocalWindowSize</span> <span class="w">-</span>
                                       <span class="pc">c</span><span class="c">hannel</span><span class="w">.l</span><span class="c">ocalWindowLeft</span><span class="w">)</span>
        <span class="w">l</span><span class="pc">o</span><span class="c">g.</span><span class="w">callWithLogger</span><span class="pc">(c</span><span class="c">hannel,</span> <span class="c">channel.</span><span class="w">extReceived</span><span class="pc">,</span> <span class="w">typeCode</span><span class="pc">,</span> <span class="c">data)</span>

    <span class="c">def</span> <span class="w">ssh_CHANNEL_EOF</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">localChannel</span> <span class="c">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('&gt;</span><span class="pc">L</span><span class="c">',</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="pc">[</span><span class="c">:</span><span class="w">4])[0</span><span class="pc">]</span>
        <span class="pc">c</span><span class="c">hannel</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">channels</span><span class="pc">[</span><span class="w">l</span><span class="c">ocalChannel]</span>
        <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(</span><span class="pc">c</span><span class="c">hannel,</span> <span class="c">channel</span><span class="pc">.</span><span class="w">eofReceived</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">ssh_CHANNEL_CLOSE</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket):</span>
        
        <span class="w">l</span><span class="pc">oc</span><span class="c">alChannel</span> <span class="c">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('</span><span class="pc">&gt;</span><span class="c">L',</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="pc">[:4</span><span class="w">])</span><span class="pc">[</span><span class="w">0</span><span class="c">]</span>
        <span class="pc">c</span><span class="c">hannel</span> <span class="c">=</span> <span class="pc">se</span><span class="c">lf.</span><span class="w">c</span><span class="pc">hannels[</span><span class="w">l</span><span class="pc">o</span><span class="c">calChannel]</span>
        <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llWithLogger(</span><span class="pc">c</span><span class="c">hannel,</span> <span class="c">channel</span><span class="pc">.</span><span class="w">closeReceived</span><span class="c">)</span>
        <span class="w">c</span><span class="pc">h</span><span class="c">annel.</span><span class="w">remoteClosed</span> <span class="pc">=</span> <span class="pc">T</span><span class="c">rue</span>
        <span class="c">if</span> <span class="pc">c</span><span class="c">hannel.</span><span class="w">localClosed</span> <span class="w">a</span><span class="c">nd</span> <span class="pc">c</span><span class="c">hannel.</span><span class="pc">r</span><span class="c">emoteClosed:</span>
            <span class="c">self.</span><span class="w">channelClosed</span><span class="pc">(channel</span><span class="c">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">ssh_CHANNEL_REQUEST</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">cket):</span>
        
        <span class="w">l</span><span class="pc">ocalCh</span><span class="c">annel</span> <span class="c">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('&gt;</span><span class="c">L',</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="pc">[</span><span class="c">:</span><span class="pc">4</span><span class="w">])[0</span><span class="pc">]</span>
        <span class="w">requestType</span><span class="pc">,</span> <span class="w">r</span><span class="c">est</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ommon.</span><span class="w">g</span><span class="c">etNS(</span><span class="w">p</span><span class="c">acket</span><span class="w">[</span><span class="pc">4</span><span class="w">:</span><span class="pc">])</span>
        <span class="w">wantReply</span> <span class="c">=</span> <span class="w">ord</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">t[0])</span>
        <span class="w">c</span><span class="c">hannel</span> <span class="c">=</span> <span class="c">self.</span><span class="w">channels</span><span class="pc">[</span><span class="w">l</span><span class="pc">o</span><span class="c">calChannel]</span>
        <span class="w">d</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">m</span><span class="c">aybeDeferred(</span><span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="pc">,</span> <span class="w">ch</span><span class="pc">annel,</span>
                <span class="w">c</span><span class="pc">hannel.</span><span class="w">requestReceived</span><span class="pc">,</span> <span class="w">requestType</span><span class="pc">,</span> <span class="w">r</span><span class="pc">es</span><span class="c">t</span><span class="w">[</span><span class="pc">1</span><span class="w">:</span><span class="pc">])</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">w</span><span class="c">antReply:</span>
            <span class="w">d</span><span class="pc">.ad</span><span class="c">dCallback(self.</span><span class="w">_cbChannelRequest</span><span class="c">,</span> <span class="w">l</span><span class="c">ocalChannel)</span>
            <span class="w">d</span><span class="c">.</span><span class="pc">addE</span><span class="c">rrback(self.</span><span class="w">_ebChannelRequest</span><span class="c">,</span> <span class="w">l</span><span class="c">ocalChannel)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>

    <span class="c">def</span> <span class="w">_</span><span class="pc">c</span><span class="c">bChannelRequest(self,</span> <span class="w">res</span><span class="pc">u</span><span class="c">lt</span><span class="pc">,</span> <span class="pc">l</span><span class="c">ocalChannel):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="c">not</span> <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span><span class="pc">:</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="w">e</span><span class="c">rror.</span><span class="w">ConchError</span><span class="pc">('</span><span class="w">f</span><span class="pc">aile</span><span class="c">d</span> <span class="w">req</span><span class="pc">ue</span><span class="c">st</span><span class="w">'</span><span class="pc">)</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="pc">(</span><span class="w">MSG_CHANNEL_SUCCESS</span><span class="pc">,</span> <span class="w">s</span><span class="pc">tru</span><span class="c">ct.pack</span><span class="w">('&gt;L</span><span class="c">',</span>
                                <span class="pc">s</span><span class="c">elf.</span><span class="w">localToRemoteChannel</span><span class="pc">[l</span><span class="c">ocalChannel</span><span class="w">])</span><span class="pc">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">_ebChannelRequest</span><span class="c">(self</span><span class="pc">,</span> <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span><span class="pc">,</span> <span class="w">l</span><span class="pc">ocalC</span><span class="c">hannel):</span>
        
        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">s</span><span class="pc">e</span><span class="c">ndPacket(</span><span class="w">MSG_CHANNEL_FAILURE</span><span class="pc">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('</span><span class="pc">&gt;</span><span class="w">L</span><span class="c">',</span>
                                <span class="pc">s</span><span class="c">elf.</span><span class="w">l</span><span class="pc">ocalT</span><span class="c">oRemoteChannel</span><span class="pc">[l</span><span class="c">ocalChannel</span><span class="w">]</span><span class="pc">))</span>

    <span class="c">def</span> <span class="w">ssh_CHANNEL_SUCCESS</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket):</span>
        
        <span class="w">l</span><span class="pc">ocalC</span><span class="c">hannel</span> <span class="pc">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('</span><span class="pc">&gt;L</span><span class="c">',</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="w">[</span><span class="pc">:4</span><span class="w">])[</span><span class="pc">0</span><span class="c">]</span>
        <span class="w">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">deferreds</span><span class="pc">.g</span><span class="c">et(</span><span class="w">l</span><span class="pc">ocalC</span><span class="c">hannel):</span>
            <span class="w">d</span> <span class="c">=</span> <span class="c">self.deferreds</span><span class="pc">[</span><span class="w">l</span><span class="c">ocalChannel</span><span class="w">]</span><span class="pc">.</span><span class="w">p</span><span class="pc">o</span><span class="c">p(0)</span>
            <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(self.</span><span class="w">channels</span><span class="pc">[l</span><span class="c">ocalChannel</span><span class="w">],</span>
                               <span class="w">d</span><span class="pc">.c</span><span class="c">allback</span><span class="w">, '')</span>

    <span class="w">d</span><span class="pc">ef</span> <span class="w">ssh_CHANNEL_FAILURE</span><span class="c">(self</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket):</span>
        
        <span class="pc">l</span><span class="c">ocalChannel</span> <span class="c">=</span> <span class="pc">st</span><span class="c">ruct.unpack</span><span class="w">('&gt;</span><span class="pc">L</span><span class="c">',</span> <span class="w">p</span><span class="pc">ac</span><span class="c">ket</span><span class="w">[</span><span class="pc">:4</span><span class="w">])[0</span><span class="c">]</span>
        <span class="pc">if</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">deferreds.</span><span class="pc">g</span><span class="c">et(</span><span class="w">l</span><span class="c">ocalChannel):</span>
            <span class="w">d</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">d</span><span class="c">eferreds</span><span class="pc">[l</span><span class="c">ocalChannel</span><span class="w">]</span><span class="pc">.</span><span class="w">p</span><span class="c">op(0)</span>
            <span class="w">l</span><span class="pc">og</span><span class="c">.</span><span class="w">callWithLogger</span><span class="c">(self.</span><span class="w">channels</span><span class="pc">[l</span><span class="c">ocalChannel</span><span class="w">],</span>
                               <span class="w">d</span><span class="pc">.e</span><span class="c">rrback</span><span class="pc">,</span>
                               <span class="w">e</span><span class="c">rror.</span><span class="w">ConchError(</span><span class="pc">'</span><span class="w">cha</span><span class="pc">nnel</span> <span class="w">req</span><span class="pc">uest</span> <span class="w">fa</span><span class="c">iled</span><span class="w">'</span><span class="pc">))</span>

    

    <span class="pc">d</span><span class="c">ef</span> <span class="w">sendGlobalRequest</span><span class="c">(self</span><span class="pc">,</span> <span class="w">req</span><span class="c">uest</span><span class="pc">,</span> <span class="c">data</span><span class="pc">,</span> <span class="w">wantReply</span><span class="pc">=</span><span class="w">0</span><span class="c">):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="c">(</span><span class="w">MSG_GLOBAL_REQUEST</span><span class="c">,</span>
                                  <span class="w">c</span><span class="pc">o</span><span class="c">mmon.NS(</span><span class="w">req</span><span class="c">uest</span><span class="pc">)</span>
                                  <span class="w">+ (w</span><span class="c">antReply</span> <span class="w">an</span><span class="pc">d</span> <span class="w">'</span><span class="pc">\</span><span class="w">x</span><span class="pc">f</span><span class="c">f</span><span class="pc">'</span> <span class="w">o</span><span class="pc">r</span> <span class="pc">'</span><span class="c">\</span><span class="pc">x</span><span class="c">00</span><span class="pc">')</span>
                                  <span class="w">+</span> <span class="pc">d</span><span class="c">ata</span><span class="pc">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">wantReply:</span>
            <span class="w">d</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
            <span class="c">self.</span><span class="w">deferreds[</span><span class="pc">'</span><span class="w">global'].a</span><span class="pc">p</span><span class="c">pend</span><span class="pc">(</span><span class="c">d)</span>
            <span class="c">return</span> <span class="c">d</span>

    <span class="c">def</span> <span class="w">openChannel</span><span class="c">(self</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">annel,</span> <span class="w">extra=''):</span>
        
        <span class="w">l</span><span class="c">og.msg</span><span class="pc">('</span><span class="w">opening</span> <span class="w">c</span><span class="pc">h</span><span class="c">annel</span> <span class="w">%</span><span class="c">s</span> <span class="w">w</span><span class="pc">i</span><span class="c">th</span> <span class="w">%</span><span class="c">s</span> <span class="pc">%</span><span class="c">s</span><span class="w">'%(</span><span class="pc">se</span><span class="c">lf.</span><span class="w">localChannelID</span><span class="c">,</span>
                <span class="w">c</span><span class="pc">h</span><span class="c">annel</span><span class="pc">.</span><span class="w">localWindowSize</span><span class="c">,</span> <span class="pc">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">localMaxPacket</span><span class="pc">))</span>
        <span class="c">self.</span><span class="w">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="c">(</span><span class="w">MSG_CHANNEL_OPEN</span><span class="pc">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">mmon.NS(</span><span class="pc">c</span><span class="c">hannel.</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span><span class="pc">)</span>
                    <span class="w">+</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('&gt;3L</span><span class="c">',</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">l</span><span class="pc">ocalC</span><span class="c">hannelID</span><span class="pc">,</span>
                    <span class="c">channel</span><span class="pc">.localW</span><span class="c">indowSize</span><span class="pc">,</span> <span class="pc">ch</span><span class="c">annel.</span><span class="pc">l</span><span class="c">ocalMaxPacket</span><span class="pc">)</span>
                    <span class="w">+</span> <span class="w">extra)</span>
        <span class="w">c</span><span class="pc">h</span><span class="c">annel.</span><span class="w">i</span><span class="c">d</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">l</span><span class="c">ocalChannelID</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">channels[</span><span class="c">self.</span><span class="pc">l</span><span class="c">ocalChannelID</span><span class="w">]</span><span class="pc"> </span><span class="c">=</span> <span class="w">c</span><span class="pc">hannel</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">localC</span><span class="c">hannelID</span> <span class="w">+</span><span class="c">=</span> <span class="c">1</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">sendRequest</span><span class="c">(self</span><span class="pc">,</span> <span class="pc">c</span><span class="c">hannel</span><span class="pc">,</span> <span class="w">requestType</span><span class="pc">,</span> <span class="c">data</span><span class="pc">,</span> <span class="w">wantReply</span><span class="pc">=</span><span class="w">0</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">c</span><span class="c">hannel.</span><span class="w">localClosed</span><span class="c">:</span>
            <span class="pc">r</span><span class="c">eturn</span>
        <span class="w">lo</span><span class="pc">g</span><span class="c">.msg</span><span class="pc">('</span><span class="w">sending</span> <span class="w">req</span><span class="pc">uest</span> <span class="pc">%</span><span class="c">s' %</span> <span class="w">r</span><span class="c">equestType)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="pc">(</span><span class="w">MSG_CHANNEL_REQUEST</span><span class="c">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('&gt;L</span><span class="c">',</span>
                                    <span class="pc">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel[c</span><span class="c">hannel</span><span class="pc">]</span><span class="c">)</span>
                                  <span class="w">+</span> <span class="w">c</span><span class="pc">o</span><span class="c">mmon.</span><span class="pc">N</span><span class="c">S</span><span class="pc">(</span><span class="w">r</span><span class="c">equestType</span><span class="w">)+ch</span><span class="pc">r</span><span class="c">(</span><span class="w">wantReply</span><span class="pc">)</span>
                                  <span class="w">+</span> <span class="pc">d</span><span class="c">ata</span><span class="w">)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">w</span><span class="pc">a</span><span class="c">ntReply:</span>
            <span class="w">d</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
            <span class="c">self.</span><span class="w">deferreds</span><span class="pc">.</span><span class="w">setdefault</span><span class="c">(</span><span class="w">c</span><span class="pc">hannel.</span><span class="w">i</span><span class="c">d</span><span class="w">, []).a</span><span class="pc">p</span><span class="c">pend(</span><span class="w">d</span><span class="pc">)</span>
            <span class="c">return</span> <span class="c">d</span>

    <span class="c">def</span> <span class="w">adjustWindow</span><span class="c">(self</span><span class="pc">,</span> <span class="w">c</span><span class="c">hannel,</span> <span class="w">bytesToAdd</span><span class="c">):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">c</span><span class="pc">ha</span><span class="c">nnel.</span><span class="w">localClosed</span><span class="c">:</span>
            <span class="pc">r</span><span class="c">eturn</span> 
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="c">(</span><span class="w">MSG_CHANNEL_WINDOW_ADJUST</span><span class="c">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('&gt;2L</span><span class="c">',</span>
                                    <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">channelsToRemoteChannel[c</span><span class="c">hannel</span><span class="pc">],</span>
                                    <span class="pc">b</span><span class="c">ytesToAdd</span><span class="w">)</span><span class="pc">)</span>
        <span class="w">l</span><span class="c">og.msg</span><span class="pc">('</span><span class="w">adding</span> <span class="pc">%</span><span class="w">i</span> <span class="w">t</span><span class="c">o</span> <span class="c">%</span><span class="pc">i</span> <span class="w">i</span><span class="pc">n</span> <span class="w">c</span><span class="pc">hannel</span> <span class="w">%i</span><span class="c">' % (</span><span class="w">b</span><span class="c">ytesToAdd,</span>
            <span class="w">c</span><span class="pc">hannel.</span><span class="w">localWindowLeft</span><span class="c">,</span> <span class="w">c</span><span class="pc">hannel</span><span class="c">.</span><span class="w">i</span><span class="pc">d</span><span class="w">)</span><span class="pc">)</span>
        <span class="w">c</span><span class="pc">h</span><span class="c">annel.</span><span class="w">l</span><span class="c">ocalWindowLeft</span> <span class="w">+</span><span class="c">=</span> <span class="w">b</span><span class="c">ytesToAdd</span>

    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">sendData</span><span class="c">(self</span><span class="pc">,</span> <span class="c">channel</span><span class="pc">,</span> <span class="pc">d</span><span class="c">ata):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">c</span><span class="c">hannel.</span><span class="w">localClosed</span><span class="c">:</span>
            <span class="pc">r</span><span class="c">eturn</span> 
        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="c">(</span><span class="w">MSG_CHANNEL_DATA</span><span class="c">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('&gt;L</span><span class="c">',</span>
                                    <span class="w">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel[c</span><span class="c">hannel</span><span class="w">]) +</span>
                                   <span class="w">c</span><span class="pc">om</span><span class="c">mon.NS(data</span><span class="pc">))</span>

    <span class="c">def</span> <span class="w">sendExtendedData</span><span class="c">(self</span><span class="pc">,</span> <span class="c">channel,</span> <span class="w">dataType</span><span class="pc">,</span> <span class="c">data):</span>
        
        <span class="c">if</span> <span class="w">c</span><span class="c">hannel.</span><span class="w">localClosed</span><span class="c">:</span>
            <span class="w">r</span><span class="c">eturn</span> 
        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="c">(</span><span class="w">MSG_CHANNEL_EXTENDED_DATA</span><span class="c">,</span> <span class="w">s</span><span class="pc">tr</span><span class="c">uct.pack</span><span class="w">('&gt;2L</span><span class="c">',</span>
                            <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">channelsToRemoteChannel[c</span><span class="c">hannel</span><span class="w">]</span><span class="pc">,</span><span class="w">d</span><span class="pc">ataT</span><span class="c">ype</span><span class="w">) \</span>
                            <span class="w">+</span> <span class="pc">c</span><span class="c">ommon.NS(</span><span class="pc">d</span><span class="c">ata</span><span class="pc">))</span>

    <span class="c">def</span> <span class="w">sendEOF</span><span class="c">(self,</span> <span class="pc">c</span><span class="c">hannel):</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">c</span><span class="pc">hannel</span><span class="c">.</span><span class="w">localClosed</span><span class="c">:</span>
            <span class="pc">r</span><span class="c">eturn</span> 
        <span class="w">lo</span><span class="pc">g</span><span class="c">.msg('</span><span class="w">sending</span> <span class="w">eof'</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="c">(</span><span class="w">MSG_CHANNEL_EOF</span><span class="pc">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('&gt;L</span><span class="c">',</span>
                                    <span class="pc">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel[c</span><span class="c">hannel</span><span class="w">]</span><span class="pc">))</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">sendClose</span><span class="c">(self</span><span class="pc">,</span> <span class="c">channel</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">c</span><span class="pc">hannel</span><span class="c">.</span><span class="w">l</span><span class="pc">oc</span><span class="c">alClosed:</span>
            <span class="pc">r</span><span class="c">eturn</span> 
        <span class="w">l</span><span class="pc">og</span><span class="c">.msg</span><span class="pc">('</span><span class="w">s</span><span class="pc">endi</span><span class="c">ng</span> <span class="w">clo</span><span class="pc">se</span> <span class="pc">%</span><span class="w">i</span><span class="c">' %</span> <span class="w">c</span><span class="pc">hannel.</span><span class="w">i</span><span class="pc">d)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">t</span><span class="c">ransport.</span><span class="w">sendPacket</span><span class="pc">(</span><span class="w">MSG_CHANNEL_CLOSE</span><span class="c">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct.pack</span><span class="w">('&gt;L</span><span class="c">',</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel[c</span><span class="c">hannel</span><span class="w">]</span><span class="pc">))</span>
        <span class="pc">c</span><span class="c">hannel.</span><span class="w">l</span><span class="pc">oc</span><span class="c">alClosed</span> <span class="pc">=</span> <span class="w">T</span><span class="c">rue</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">channel</span><span class="pc">.</span><span class="w">l</span><span class="pc">oc</span><span class="c">alClosed</span> <span class="w">a</span><span class="c">nd</span> <span class="pc">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">remoteClosed</span><span class="c">:</span>
            <span class="c">self.</span><span class="w">channelClosed</span><span class="c">(</span><span class="pc">c</span><span class="c">hannel</span><span class="pc">)</span>

    
    <span class="pc">d</span><span class="c">ef</span> <span class="w">getChannel</span><span class="c">(self</span><span class="pc">,</span> <span class="w">channelType</span><span class="pc">,</span> <span class="w">windowSize</span><span class="pc">,</span> <span class="w">maxPacket</span><span class="pc">,</span> <span class="pc">d</span><span class="c">ata):</span>
        
        <span class="w">l</span><span class="c">og.msg('</span><span class="w">g</span><span class="c">ot</span> <span class="pc">c</span><span class="c">hannel</span> <span class="pc">%</span><span class="c">s</span> <span class="w">req</span><span class="pc">uest</span><span class="w">' </span><span class="pc">%</span> <span class="pc">c</span><span class="c">hannelType)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">h</span><span class="c">asattr(self.</span><span class="pc">t</span><span class="c">ransport</span><span class="w">,</span><span class="pc"> "</span><span class="w">a</span><span class="c">vatar</span><span class="pc">"</span><span class="c">):</span> 
            <span class="w">chan</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">a</span><span class="pc">v</span><span class="c">atar</span><span class="w">.lookupChannel</span><span class="c">(</span><span class="w">c</span><span class="pc">hannelT</span><span class="c">ype</span><span class="pc">,</span>
                                                       <span class="w">w</span><span class="c">indowSize</span><span class="pc">,</span>
                                                       <span class="w">m</span><span class="c">axPacket</span><span class="pc">,</span>
                                                       <span class="pc">d</span><span class="c">ata</span><span class="pc">)</span>
        <span class="w">e</span><span class="c">lse:</span>
            <span class="w">c</span><span class="pc">hann</span><span class="c">elType</span> <span class="c">=</span> <span class="w">c</span><span class="pc">hann</span><span class="c">elType.</span><span class="w">translate</span><span class="pc">(</span><span class="w">TRANSLATE_TABLE</span><span class="pc">)</span>
            <span class="w">f</span> <span class="c">=</span> <span class="pc">g</span><span class="c">etattr(self</span><span class="pc">, </span><span class="c">'</span><span class="w">channel_</span><span class="c">%s</span><span class="w">'</span><span class="pc"> %</span> <span class="pc">c</span><span class="c">hannelType</span><span class="pc">,</span> <span class="c">None</span><span class="pc">)</span>
            <span class="pc">i</span><span class="c">f</span> <span class="w">f</span> <span class="pc">i</span><span class="c">s</span> <span class="c">not</span> <span class="c">None:</span>
                <span class="w">chan</span> <span class="c">=</span> <span class="w">f</span><span class="pc">(</span><span class="w">w</span><span class="c">indowSize</span><span class="pc">,</span> <span class="w">m</span><span class="c">axPacket</span><span class="pc">,</span> <span class="w">d</span><span class="c">ata</span><span class="pc">)</span>
            <span class="pc">e</span><span class="c">lse:</span>
                <span class="pc">c</span><span class="c">han</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span>
        <span class="c">if</span> <span class="c">chan</span> <span class="c">is</span> <span class="c">None:</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="pc">.</span><span class="w">ConchError</span><span class="pc">('</span><span class="w">unknown</span> <span class="w">c</span><span class="pc">hannel</span><span class="w">'</span><span class="pc">,</span>
                    <span class="w">OPEN_UNKNOWN_CHANNEL_TYPE</span><span class="c">)</span>
        <span class="pc">e</span><span class="c">lse:</span>
            <span class="c">chan</span><span class="pc">.</span><span class="w">conn</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">ch</span><span class="c">an</span>

    <span class="c">def</span> <span class="w">gotGlobalRequest</span><span class="c">(self,</span> <span class="w">requestType</span><span class="pc">,</span> <span class="c">data):</span>
        
        <span class="w">l</span><span class="c">og.msg</span><span class="pc">('</span><span class="w">g</span><span class="pc">ot</span> <span class="w">global</span> <span class="c">%s</span> <span class="w">req</span><span class="pc">uest</span><span class="w">' </span><span class="pc">%</span> <span class="pc">req</span><span class="c">uestType)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="w">h</span><span class="c">asattr(self.</span><span class="w">t</span><span class="c">ransport</span><span class="pc">, </span><span class="c">'</span><span class="w">a</span><span class="pc">v</span><span class="c">atar'):</span> 
            <span class="pc">r</span><span class="c">eturn</span> <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">a</span><span class="pc">v</span><span class="c">atar</span><span class="pc">.</span><span class="w">g</span><span class="pc">o</span><span class="c">tGlobalRequest(</span><span class="pc">r</span><span class="c">equestType</span><span class="pc">,</span> <span class="c">data)</span>

        <span class="w">r</span><span class="pc">eq</span><span class="c">uestType</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">equestType.</span><span class="w">r</span><span class="pc">ep</span><span class="c">lace</span><span class="w">('-','_'</span><span class="pc">)</span>
        <span class="w">f</span> <span class="pc">=</span> <span class="pc">g</span><span class="c">etattr(self</span><span class="pc">,</span><span class="c"> '</span><span class="w">global_</span><span class="pc">%</span><span class="c">s</span><span class="pc">' %</span> <span class="pc">r</span><span class="c">equestType</span><span class="pc">,</span> <span class="pc">N</span><span class="c">one)</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">f</span><span class="c">:</span>
            <span class="c">return</span> <span class="w">0</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="w">f(d</span><span class="c">ata)</span>

    <span class="c">def</span> <span class="w">channelClosed</span><span class="c">(self,</span> <span class="w">ch</span><span class="pc">annel)</span><span class="c">:</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="w">ch</span><span class="pc">annel</span> <span class="pc">in</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">channelsToRemoteChannel</span><span class="c">:</span> 
            <span class="w">c</span><span class="pc">hannel.</span><span class="w">localClosed</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">hannel</span><span class="c">.</span><span class="w">remoteClosed</span> <span class="w">=</span> <span class="pc">T</span><span class="c">rue</span>
            <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="w">localToRemoteChannel</span><span class="pc">[</span><span class="w">c</span><span class="pc">hannel.</span><span class="w">i</span><span class="c">d</span><span class="w">]</span>
            <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="w">channels</span><span class="pc">[</span><span class="w">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">i</span><span class="c">d</span><span class="pc">]</span>
            <span class="w">d</span><span class="pc">el</span> <span class="c">self.</span><span class="pc">c</span><span class="c">hannelsToRemoteChannel</span><span class="pc">[</span><span class="w">c</span><span class="pc">hannel</span><span class="c">]</span>
            <span class="w">f</span><span class="c">or</span> <span class="w">d</span> <span class="c">in</span> <span class="c">self.</span><span class="w">deferreds</span><span class="pc">.</span><span class="w">setdefault</span><span class="c">(</span><span class="w">c</span><span class="pc">hannel.</span><span class="w">i</span><span class="c">d</span><span class="w">, []):</span>
                <span class="w">d</span><span class="c">.</span><span class="pc">e</span><span class="c">rrback(</span><span class="pc">e</span><span class="c">rror.</span><span class="w">ConchError("Channel</span> <span class="w">cl</span><span class="pc">o</span><span class="c">sed</span><span class="w">."))</span>
            <span class="w">de</span><span class="pc">l</span> <span class="c">self.deferreds</span><span class="pc">[</span><span class="w">c</span><span class="pc">hannel.</span><span class="w">i</span><span class="c">d</span><span class="w">][:]</span>
            <span class="w">l</span><span class="pc">o</span><span class="c">g.</span><span class="w">callWithLogger</span><span class="pc">(</span><span class="w">c</span><span class="pc">h</span><span class="c">annel</span><span class="pc">,</span> <span class="w">c</span><span class="c">hannel</span><span class="pc">.</span><span class="w">c</span><span class="pc">l</span><span class="c">osed)</span>

<span class="w">MSG_GLOBAL_REQUEST</span> <span class="c">=</span> <span class="w">8</span><span class="c">0</span>
<span class="w">MSG_REQUEST_SUCCESS</span> <span class="c">=</span> <span class="w">81</span>
<span class="w">MSG_REQUEST_FAILURE</span> <span class="c">=</span> <span class="w">82</span>
<span class="w">MSG_CHANNEL_OPEN</span> <span class="c">=</span> <span class="w">90</span>
<span class="w">MSG_CHANNEL_OPEN_CONFIRMATION</span> <span class="c">=</span> <span class="w">91</span>
<span class="w">MSG_CHANNEL_OPEN_FAILURE</span> <span class="c">=</span> <span class="w">92</span>
<span class="w">MSG_CHANNEL_WINDOW_ADJUST</span> <span class="c">=</span> <span class="w">93</span>
<span class="w">MSG_CHANNEL_DATA</span> <span class="c">=</span> <span class="w">94</span>
<span class="w">MSG_CHANNEL_EXTENDED_DATA</span> <span class="c">=</span> <span class="w">95</span>
<span class="w">MSG_CHANNEL_EOF</span> <span class="c">=</span> <span class="w">96</span>
<span class="w">MSG_CHANNEL_CLOSE</span> <span class="c">=</span> <span class="w">97</span>
<span class="w">MSG_CHANNEL_REQUEST</span> <span class="c">=</span> <span class="w">98</span>
<span class="w">MSG_CHANNEL_SUCCESS</span> <span class="c">=</span> <span class="w">99</span>
<span class="w">MSG_CHANNEL_FAILURE</span> <span class="c">=</span> <span class="w">1</span><span class="pc">0</span><span class="c">0</span>

<span class="w">OPEN_ADMINISTRATIVELY_PROHIBITED</span> <span class="c">=</span> <span class="pc">1</span>
<span class="w">OPEN_CONNECT_FAILED</span> <span class="c">=</span> <span class="w">2</span>
<span class="w">OPEN_UNKNOWN_CHANNEL_TYPE</span> <span class="c">=</span> <span class="w">3</span>
<span class="w">OPEN_RESOURCE_SHORTAGE</span> <span class="c">=</span> <span class="w">4</span>

<span class="w">EXTENDED_DATA_STDERR</span> <span class="c">=</span> <span class="pc">1</span>

<span class="w">me</span><span class="pc">ssages</span> <span class="pc">= {</span><span class="c">}</span>
<span class="pc">f</span><span class="c">or</span> <span class="w">n</span><span class="pc">a</span><span class="c">me</span><span class="pc">,</span> <span class="pc">va</span><span class="c">lue</span> <span class="c">in</span> <span class="w">locals()</span><span class="pc">.</span><span class="w">c</span><span class="c">opy</span><span class="w">()</span><span class="pc">.i</span><span class="c">tems</span><span class="pc">()</span><span class="c">:</span>
    <span class="c">if</span> <span class="pc">n</span><span class="c">ame</span><span class="w">[</span><span class="pc">:</span><span class="w">4] == 'MSG_</span><span class="pc">'</span><span class="c">:</span>
        <span class="w">me</span><span class="pc">ssages[</span><span class="w">v</span><span class="pc">alu</span><span class="c">e] =</span> <span class="w">n</span><span class="c">ame</span> 

<span class="w">im</span><span class="c">port</span> <span class="w">st</span><span class="pc">rin</span><span class="c">g</span>
<span class="w">alphanums</span> <span class="pc">=</span> <span class="w">st</span><span class="pc">ri</span><span class="c">ng.</span><span class="w">letters</span> <span class="w">+</span> <span class="w">st</span><span class="pc">ri</span><span class="c">ng.</span><span class="w">digits</span>
<span class="w">TRANSLATE_TABLE</span> <span class="w">= ''.j</span><span class="c">oin</span><span class="w">(</span><span class="pc">[</span><span class="w">ch</span><span class="pc">r</span><span class="c">(</span><span class="w">i</span><span class="pc">)</span> <span class="w">i</span><span class="pc">n</span> <span class="w">a</span><span class="pc">l</span><span class="c">phanums</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">ch</span><span class="pc">r</span><span class="c">(</span><span class="w">i</span><span class="pc">)</span> <span class="w">o</span><span class="c">r</span> <span class="w">'_</span><span class="pc">'</span>
    <span class="pc">f</span><span class="c">or</span> <span class="c">i</span> <span class="c">in</span> <span class="c">range(</span><span class="w">256)]</span><span class="pc">)</span>
<span class="w">SSHConnection</span><span class="pc">.</span><span class="w">protocolMessages</span> <span class="pc">=</span> <span class="w">me</span><span class="pc">ssages</span>

</pre>
</body>
</html>

