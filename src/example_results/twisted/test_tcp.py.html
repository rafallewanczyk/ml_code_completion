<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>





<span class="w">from</span> <span class="w">__future__</span> <span class="w">import</span> <span class="w">division,</span> <span class="w">absolute_import</span>

<span class="w">import</span> <span class="w">socket,</span> <span class="w">random,</span> <span class="w">errno</span>
<span class="w">from</span> <span class="w">functools</span> <span class="w">import</span> <span class="w">wraps</span>

<span class="w">from</span> <span class="w">zope.interface</span> <span class="w">import</span> <span class="w">implementer</span>

<span class="w">from</span> <span class="w">twisted.trial</span> <span class="w">import</span> <span class="w">unittest</span>

<span class="w">from</span> <span class="w">twisted.python.log</span> <span class="w">import</span> <span class="w">msg,</span> <span class="w">err</span>
<span class="w">from</span> <span class="w">twisted</span><span class="c">.</span><span class="pc">i</span><span class="c">nternet</span> <span class="pc">i</span><span class="c">mport</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">,</span> <span class="w">r</span><span class="c">eactor,</span> <span class="w">d</span><span class="c">efer,</span> <span class="c">interfaces</span>
<span class="pc">f</span><span class="c">rom</span> <span class="c">twisted.internet</span> <span class="c">import</span> <span class="w">e</span><span class="c">rror</span>
<span class="c">from</span> <span class="c">twisted.internet</span><span class="pc">.</span><span class="w">a</span><span class="c">ddress</span> <span class="c">import</span> <span class="w">I</span><span class="pc">P</span><span class="c">v4Address</span>
<span class="c">from</span> <span class="c">twisted.internet.interfaces</span> <span class="c">import</span> <span class="w">IHalfCloseableProtocol</span><span class="pc">,</span> <span class="w">IPullProducer</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocols</span> <span class="pc">i</span><span class="c">mport</span> <span class="w">policies</span>
<span class="c">from</span> <span class="c">twisted.</span><span class="w">t</span><span class="pc">e</span><span class="c">st.</span><span class="w">p</span><span class="pc">roto_</span><span class="c">helpers</span> <span class="c">import</span> <span class="w">AccumulatingProtocol</span>


<span class="pc">d</span><span class="c">ef</span> <span class="w">loopUntil</span><span class="c">(</span><span class="w">predicate</span><span class="pc">,</span> <span class="w">interval</span><span class="pc">=0</span><span class="c">):</span>
    
    <span class="w">f</span><span class="c">rom</span> <span class="c">twisted.internet</span> <span class="c">import</span> <span class="w">t</span><span class="c">ask</span>
    <span class="w">d</span> <span class="c">=</span> <span class="c">defer.Deferred()</span>
    <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck</span><span class="pc">()</span><span class="c">:</span>
        <span class="w">res</span> <span class="c">=</span> <span class="w">p</span><span class="c">redicate</span><span class="pc">(</span><span class="c">)</span>
        <span class="w">i</span><span class="pc">f</span> <span class="w">res</span><span class="c">:</span>
            <span class="w">d</span><span class="pc">.c</span><span class="c">allback(</span><span class="w">r</span><span class="pc">es</span><span class="c">)</span>
    <span class="w">cal</span><span class="pc">l</span> <span class="pc">=</span> <span class="w">t</span><span class="pc">a</span><span class="c">sk.</span><span class="w">LoopingCall</span><span class="c">(</span><span class="w">ch</span><span class="c">eck)</span>
    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">s</span><span class="pc">t</span><span class="c">op</span><span class="pc">(r</span><span class="c">esult):</span>
        <span class="w">ca</span><span class="pc">ll</span><span class="c">.</span><span class="pc">s</span><span class="c">top()</span>
        <span class="pc">ret</span><span class="c">urn</span> <span class="pc">r</span><span class="c">esult</span>
    <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">s</span><span class="pc">t</span><span class="c">op)</span>
    <span class="w">d2</span> <span class="pc">=</span> <span class="w">ca</span><span class="pc">ll</span><span class="c">.</span><span class="w">sta</span><span class="pc">rt(</span><span class="w">interval</span><span class="c">)</span>
    <span class="w">d</span><span class="pc">2</span><span class="c">.</span><span class="pc">addE</span><span class="c">rrback(</span><span class="w">d</span><span class="pc">.e</span><span class="c">rrback</span><span class="pc">)</span>
    <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ClosingProtocol</span><span class="c">(</span><span class="w">p</span><span class="c">rotocol.</span><span class="pc">P</span><span class="c">rotocol):</span>

    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">"</span><span class="w">C</span><span class="c">losingProtocol</span><span class="pc">.</span><span class="w">c</span><span class="pc">onnectionM</span><span class="c">ade</span><span class="pc">"</span><span class="c">)</span>
        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>

    <span class="c">def</span> <span class="c">connectionLost(self,</span> <span class="c">reason):</span>
        <span class="w">m</span><span class="c">sg</span><span class="pc">(</span><span class="c">"</span><span class="w">C</span><span class="c">losingProtocol</span><span class="pc">.co</span><span class="c">nnectionLost</span><span class="pc">"</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eason.</span><span class="pc">t</span><span class="c">rap(</span><span class="pc">e</span><span class="c">rror.</span><span class="w">C</span><span class="c">onnectionDone)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ClosingFactory</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">S</span><span class="c">erverFactory):</span>
    

    <span class="w">_cleanerUpper</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span>

    <span class="c">def</span> <span class="c">buildProtocol(self</span><span class="pc">,</span> <span class="w">con</span><span class="pc">n</span><span class="c">):</span>
        <span class="c">self.</span><span class="w">_</span><span class="c">cleanerUpper</span> <span class="c">=</span> <span class="w">s</span><span class="c">elf.</span><span class="w">po</span><span class="pc">rt</span><span class="c">.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening()</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="w">C</span><span class="pc">losingP</span><span class="c">rotocol</span><span class="w">(</span><span class="pc">)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">cleanUp</span><span class="c">(self):</span>
        
        <span class="w">i</span><span class="c">f</span> <span class="c">self.</span><span class="pc">_</span><span class="c">cleanerUpper</span> <span class="pc">i</span><span class="c">s</span> <span class="c">None:</span>
            <span class="c">return</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening()</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">self._cleanerUpper</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">MyProtocolFactoryMixin</span><span class="c">(object):</span>
    
    <span class="w">protocolFactory</span> <span class="c">=</span> <span class="w">AccumulatingProtocol</span>

    <span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="c">None</span>
    <span class="w">protocolConnectionLost</span> <span class="c">=</span> <span class="c">None</span>
    <span class="w">p</span><span class="pc">rotocol</span> <span class="c">=</span> <span class="c">None</span>
    <span class="w">cal</span><span class="pc">le</span><span class="c">d</span> <span class="c">=</span> <span class="pc">0</span>

    <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">peerAddresses</span> <span class="pc">= </span><span class="c">[]</span>


    <span class="c">def</span> <span class="w">b</span><span class="c">uildProtocol(self,</span> <span class="pc">a</span><span class="c">ddr):</span>
        
        <span class="pc">s</span><span class="c">elf.peerAddresses</span><span class="pc">.</span><span class="c">append(</span><span class="w">a</span><span class="pc">d</span><span class="c">dr)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">cal</span><span class="pc">le</span><span class="c">d</span> <span class="w">+</span><span class="c">=</span> <span class="c">1</span>
        <span class="w">p</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">protocolFactory</span><span class="pc">()</span>
        <span class="w">p</span><span class="c">.</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory</span> <span class="c">=</span> <span class="c">self</span>
        <span class="w">p</span><span class="c">.</span><span class="w">closedDeferred</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">protocolConnectionLost</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">pr</span><span class="pc">otocolC</span><span class="c">onnectionLost</span> <span class="c">=</span> <span class="c">None</span>
        <span class="c">self.</span><span class="w">p</span><span class="pc">rotocol</span> <span class="c">=</span> <span class="pc">p</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">p</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">MyServerFactory</span><span class="c">(</span><span class="w">MyProtocolFactoryMixin</span><span class="pc">,</span> <span class="pc">p</span><span class="c">rotocol</span><span class="pc">.S</span><span class="c">erverFactory):</span>
    



<span class="w">c</span><span class="c">lass</span> <span class="w">MyClientFactory</span><span class="c">(</span><span class="pc">M</span><span class="c">yProtocolFactoryMixin</span><span class="pc">,</span> <span class="c">protocol</span><span class="pc">.</span><span class="w">C</span><span class="c">lientFactory):</span>
    
    <span class="w">fa</span><span class="pc">ile</span><span class="c">d</span> <span class="c">=</span> <span class="w">0</span>
    <span class="w">s</span><span class="pc">to</span><span class="c">pped</span> <span class="c">=</span> <span class="w">0</span>

    <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="w">M</span><span class="c">yProtocolFactoryMixin</span><span class="pc">.</span><span class="c">__init__(self)</span>
        <span class="c">self.</span><span class="w">d</span><span class="c">eferred</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">failDeferred</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">clientConnectionFailed</span><span class="c">(self</span><span class="pc">,</span> <span class="w">c</span><span class="pc">onn</span><span class="c">ector</span><span class="pc">,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">faile</span><span class="c">d</span> <span class="c">=</span> <span class="w">1</span>
        <span class="c">self.</span><span class="w">r</span><span class="pc">eas</span><span class="c">on</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eason</span>
        <span class="pc">s</span><span class="c">elf.failDeferred</span><span class="pc">.c</span><span class="c">allback(</span><span class="pc">N</span><span class="c">one)</span>

    <span class="c">def</span> <span class="w">clientConnectionLost</span><span class="c">(self</span><span class="pc">,</span> <span class="w">c</span><span class="c">onnector</span><span class="pc">,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">lostReason</span> <span class="pc">=</span> <span class="c">reason</span>
        <span class="c">self.</span><span class="pc">d</span><span class="c">eferred</span><span class="pc">.c</span><span class="c">allback(</span><span class="pc">N</span><span class="c">one)</span>

    <span class="c">def</span> <span class="w">stopFactory</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed</span> <span class="c">=</span> <span class="pc">1</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">ListeningTests</span><span class="c">(unittest.TestCase):</span>

    <span class="c">def</span> <span class="w">test_listen</span><span class="c">(self):</span>
        
        <span class="w">f</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="w">p1</span> <span class="c">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">=</span><span class="c">"127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p1</span><span class="c">.</span><span class="w">s</span><span class="c">topListening)</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">ailUnless(</span><span class="w">i</span><span class="pc">nt</span><span class="c">erfaces.</span><span class="w">IListeningPort</span><span class="pc">.</span><span class="w">p</span><span class="pc">r</span><span class="c">ovidedBy(</span><span class="w">p1</span><span class="pc">))</span>


    <span class="c">def</span> <span class="w">testStopListening</span><span class="c">(self):</span>
        
        <span class="w">f</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="w">po</span><span class="pc">r</span><span class="c">t</span> <span class="c">=</span> <span class="w">re</span><span class="pc">a</span><span class="c">ctor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
        <span class="w">n</span> <span class="c">=</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt.getHost</span><span class="pc">().</span><span class="c">port</span>

        <span class="w">d</span><span class="c">ef</span> <span class="w">cbStopListening</span><span class="c">(</span><span class="w">i</span><span class="pc">g</span><span class="c">nored):</span>
            
            <span class="pc">p</span><span class="c">ort</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">eactor.listenTCP(</span><span class="w">n</span><span class="c">,</span> <span class="pc">f,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">po</span><span class="c">rt.</span><span class="w">s</span><span class="pc">topL</span><span class="c">istening()</span>

        <span class="pc">d</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">m</span><span class="c">aybeDeferred(</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">s</span><span class="c">topListening</span><span class="pc">)</span>
        <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">cbStopListening</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>


    <span class="c">def</span> <span class="w">testNumberedInterface</span><span class="c">(self):</span>
        <span class="w">f</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        
        <span class="w">p1</span> <span class="c">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">'</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">p1</span><span class="c">.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening()</span>

    <span class="pc">de</span><span class="c">f</span> <span class="w">testPortRepr</span><span class="c">(self):</span>
        <span class="pc">f</span> <span class="c">=</span> <span class="pc">M</span><span class="c">yServerFactory</span><span class="pc">()</span>
        <span class="w">p</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eactor.listenTCP(0,</span> <span class="w">f</span><span class="pc">)</span>
        <span class="w">portNo</span> <span class="c">=</span> <span class="w">st</span><span class="c">r(</span><span class="w">p</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port)</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">ailI</span><span class="c">f(</span><span class="w">rep</span><span class="c">r(</span><span class="pc">p).</span><span class="w">fi</span><span class="pc">nd</span><span class="c">(</span><span class="pc">p</span><span class="c">ortNo</span><span class="w">) == -</span><span class="c">1)</span>
        <span class="c">def</span> <span class="w">stoppedListening</span><span class="c">(</span><span class="w">i</span><span class="pc">gn</span><span class="c">):</span>
            <span class="c">self.</span><span class="w">f</span><span class="pc">ailI</span><span class="c">f(</span><span class="w">r</span><span class="pc">ep</span><span class="c">r(</span><span class="w">p)</span><span class="pc">.</span><span class="w">fin</span><span class="pc">d</span><span class="c">(</span><span class="pc">p</span><span class="c">ortNo</span><span class="w">) != -</span><span class="c">1)</span>
        <span class="w">d</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">m</span><span class="c">aybeDeferred(</span><span class="w">p</span><span class="c">.</span><span class="w">st</span><span class="pc">opL</span><span class="c">istening</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d.addCallback(</span><span class="pc">st</span><span class="c">oppedListening)</span>


    <span class="c">def</span> <span class="w">test_serverRepr</span><span class="c">(self):</span>
        
        <span class="w">s</span><span class="pc">er</span><span class="c">ver</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="pc">()</span>
        <span class="w">serverConnMade</span> <span class="c">=</span> <span class="w">s</span><span class="pc">er</span><span class="c">ver.</span><span class="w">protocolConnectionMade</span> <span class="w">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.listenTCP(0,</span> <span class="w">s</span><span class="pc">erver)</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">s</span><span class="pc">topL</span><span class="c">istening</span><span class="pc">)</span>

        <span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
        <span class="w">clientConnMade</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="pc">p</span><span class="c">rotocolConnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="pc">co</span><span class="c">nnectTCP</span><span class="pc">("</span><span class="c">127.0.0.1",</span>
                                       <span class="w">p</span><span class="c">ort</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="pc">c</span><span class="c">lient</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">a</span><span class="pc">d</span><span class="c">dCleanup(</span><span class="w">c</span><span class="pc">onnecto</span><span class="c">r.</span><span class="w">di</span><span class="pc">sconnect)</span>
        <span class="c">def</span> <span class="w">ch</span><span class="c">eck(</span><span class="pc">res</span><span class="c">ult):</span>
            <span class="w">serverProto</span><span class="pc">,</span> <span class="w">clientProto</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span>
            <span class="w">portNumber</span> <span class="c">=</span> <span class="w">p</span><span class="pc">ort</span><span class="c">.</span><span class="w">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span>
            <span class="w">s</span><span class="c">elf.</span><span class="pc">a</span><span class="c">ssertEqual(</span>
                <span class="w">rep</span><span class="c">r(</span><span class="pc">s</span><span class="c">erverProto</span><span class="w">.t</span><span class="pc">r</span><span class="c">ansport),</span>
                <span class="w">"</span><span class="pc">&lt;</span><span class="w">AccumulatingProtocol</span> 
            <span class="pc">s</span><span class="c">erverProto</span><span class="w">.t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
            <span class="w">c</span><span class="pc">li</span><span class="c">entProto</span><span class="pc">.t</span><span class="c">ransport.loseConnection()</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults([</span><span class="w">serverConnMade</span><span class="c">,</span> <span class="w">clientConnMade]</span>
            <span class="w">)</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="c">heck)</span>


    <span class="c">def</span> <span class="w">test_restartListening</span><span class="c">(self):</span>
        
        <span class="w">serverF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">"</span><span class="c">127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="pc">p</span><span class="c">ort.</span><span class="w">s</span><span class="c">topListening)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">cbStopListening</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">startListening</span><span class="c">()</span>

            <span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
            <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">protocolConnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
            <span class="pc">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">rotocolC</span><span class="c">onnectionMade</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
            <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">("</span><span class="c">127.0.0.1</span><span class="pc">"</span><span class="c">,</span>
                                           <span class="w">p</span><span class="c">ort</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="pc">c</span><span class="c">lient</span><span class="pc">)</span>
            <span class="c">self.</span><span class="w">a</span><span class="pc">d</span><span class="c">dCleanup(</span><span class="w">c</span><span class="pc">onnecto</span><span class="c">r.</span><span class="w">di</span><span class="pc">sconnect)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">de</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults([</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">.</span><span class="w">protocolConnectionMade</span><span class="c">,</span>
                                        <span class="w">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocolConnectionMade</span><span class="w">]</span>
                <span class="w">)</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">clo</span><span class="pc">se</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">cl</span><span class="c">ose(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult):</span>
            <span class="w">serverProto,</span> <span class="w">clientProto</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span>
            <span class="w">cli</span><span class="pc">entProto.</span><span class="w">t</span><span class="c">ransport.loseConnection()</span>
            <span class="w">s</span><span class="pc">er</span><span class="c">verProto</span><span class="pc">.t</span><span class="c">ransport.loseConnection()</span>

        <span class="w">d</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">m</span><span class="c">aybeDeferred(</span><span class="w">po</span><span class="pc">rt</span><span class="c">.</span><span class="w">s</span><span class="pc">topL</span><span class="c">istening</span><span class="pc">)</span>
        <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">cbStopListening</span><span class="c">)</span>
        <span class="c">return</span> <span class="c">d</span>


    <span class="c">def</span> <span class="w">test_exceptInStop</span><span class="c">(self):</span>
        
        <span class="w">serve</span><span class="pc">rF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="pc">de</span><span class="c">f</span> <span class="w">raiseException</span><span class="pc">()</span><span class="c">:</span>
            <span class="w">ra</span><span class="c">ise</span> <span class="c">RuntimeError("</span><span class="w">An</span> <span class="w">e</span><span class="c">rror</span><span class="pc">"</span><span class="c">)</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">stopFactory</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">a</span><span class="c">iseException</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="pc">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1</span><span class="pc">"</span><span class="c">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">s</span><span class="c">elf.assertFailure(</span><span class="w">p</span><span class="pc">ort.</span><span class="w">s</span><span class="pc">topL</span><span class="c">istening(),</span> <span class="w">R</span><span class="c">untimeError)</span>


    <span class="c">def</span> <span class="w">test_restartAfterExcept</span><span class="c">(self):</span>
        
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="pc">de</span><span class="c">f</span> <span class="w">raiseException</span><span class="pc">()</span><span class="c">:</span>
            <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="pc">R</span><span class="c">untimeError("</span><span class="w">An</span> <span class="w">e</span><span class="c">rror</span><span class="pc">")</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">stopFactory</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">a</span><span class="c">iseException</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1</span><span class="pc">"</span><span class="c">)</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="pc">p</span><span class="c">ort.</span><span class="w">s</span><span class="pc">topL</span><span class="c">istening)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">cbStopListening</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="w">d</span><span class="pc">el</span> <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">s</span><span class="pc">topF</span><span class="c">actory</span>
            <span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">startListening</span><span class="c">()</span>

            <span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
            <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
            <span class="pc">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">rotocolC</span><span class="c">onnectionMade</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
            <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">("</span><span class="c">127.0.0.1</span><span class="pc">"</span><span class="c">,</span>
                                           <span class="w">p</span><span class="c">ort</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="pc">c</span><span class="c">lient</span><span class="pc">)</span>
            <span class="c">self.</span><span class="w">a</span><span class="pc">d</span><span class="c">dCleanup(</span><span class="w">c</span><span class="pc">onnecto</span><span class="c">r.</span><span class="w">di</span><span class="pc">sconnect)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">de</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults([</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">.</span><span class="w">protocolConnectionMade</span><span class="c">,</span>
                                        <span class="w">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocolConnectionMade</span><span class="w">]</span>
                <span class="w">)</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">clo</span><span class="pc">se</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">cl</span><span class="c">ose(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult):</span>
            <span class="w">serverProto,</span> <span class="w">clientProto</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span>
            <span class="w">cli</span><span class="pc">entProto.</span><span class="w">t</span><span class="c">ransport.loseConnection()</span>
            <span class="w">s</span><span class="pc">er</span><span class="c">verProto</span><span class="pc">.t</span><span class="c">ransport.loseConnection()</span>

        <span class="pc">ret</span><span class="c">urn</span> <span class="pc">s</span><span class="c">elf.assertFailure(</span><span class="w">po</span><span class="pc">rt.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening</span><span class="pc">(</span><span class="c">),</span> <span class="w">R</span><span class="c">untimeError</span>
            <span class="w">)</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">cbStopListening</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_directConnectionLostCall</span><span class="c">(self):</span>
        
        <span class="w">serve</span><span class="pc">rF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">serve</span><span class="pc">rF</span><span class="c">actory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">"</span><span class="c">127.0.0.1")</span>
        <span class="w">portNumber</span> <span class="c">=</span> <span class="w">p</span><span class="c">ort.getHost</span><span class="pc">().</span><span class="c">port</span>
        <span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">c</span><span class="pc">onnecti</span><span class="c">onLost(</span><span class="pc">N</span><span class="c">one</span><span class="pc">)</span>

        <span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="pc">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">rotocolC</span><span class="c">onnectionMade</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">co</span><span class="c">nnectTCP("127.0.0.1",</span> <span class="w">portNumber</span><span class="pc">,</span> <span class="w">c</span><span class="c">lient</span><span class="pc">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="w">i</span><span class="pc">gn</span><span class="c">):</span>
            <span class="w">c</span><span class="c">lient.</span><span class="w">rea</span><span class="c">son</span><span class="pc">.t</span><span class="c">rap(</span><span class="pc">e</span><span class="c">rror.</span><span class="w">ConnectionRefusedError</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">failDeferred</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">ch</span><span class="c">eck)</span>


    <span class="c">def</span> <span class="w">test_exceptInConnectionLostCall</span><span class="c">(self):</span>
        
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="pc">de</span><span class="c">f</span> <span class="w">raiseException</span><span class="pc">()</span><span class="c">:</span>
            <span class="w">ra</span><span class="c">ise</span> <span class="c">RuntimeError</span><span class="pc">("</span><span class="w">An</span> <span class="w">e</span><span class="c">rror</span><span class="pc">")</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">stopFactory</span> <span class="w">=</span> <span class="w">r</span><span class="pc">a</span><span class="c">iseException</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1</span><span class="pc">"</span><span class="c">)</span>
        <span class="c">self.</span><span class="w">as</span><span class="pc">sertR</span><span class="c">aises(RuntimeError,</span> <span class="w">p</span><span class="c">ort.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectionLost,</span> <span class="pc">N</span><span class="c">one)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">LoopbackTests</span><span class="c">(unittest.TestCase):</span>
    
    <span class="c">def</span> <span class="w">test_closePortInProtocolFactory</span><span class="c">(self):</span>
        
        <span class="w">f</span> <span class="c">=</span> <span class="w">ClosingFactory</span><span class="c">()</span>
        <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.listenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
        <span class="pc">f.</span><span class="w">p</span><span class="c">ort</span> <span class="c">=</span> <span class="pc">p</span><span class="c">ort</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="pc">f</span><span class="c">.</span><span class="w">cleanUp)</span>
        <span class="w">portNumber</span> <span class="c">=</span> <span class="w">p</span><span class="c">ort.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span>
        <span class="w">clientF</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
        <span class="pc">r</span><span class="c">eactor.</span><span class="pc">co</span><span class="c">nnectTCP</span><span class="pc">("</span><span class="c">127.0.0.1",</span> <span class="w">p</span><span class="c">ortNumber</span><span class="pc">,</span> <span class="w">c</span><span class="pc">li</span><span class="c">entF</span><span class="pc">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">ch</span><span class="c">eck(</span><span class="w">x</span><span class="c">):</span>
            <span class="c">self.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="pc">c</span><span class="c">lientF.</span><span class="w">prot</span><span class="pc">ocol</span><span class="c">.</span><span class="w">made</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="w">p</span><span class="pc">ort</span><span class="c">.</span><span class="w">di</span><span class="pc">sconnecte</span><span class="c">d)</span>
            <span class="w">c</span><span class="pc">li</span><span class="c">entF.</span><span class="w">lostReason</span><span class="pc">.</span><span class="w">t</span><span class="pc">rap</span><span class="c">(</span><span class="w">e</span><span class="c">rror.</span><span class="w">C</span><span class="c">onnectionDone)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">lientF</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eck)</span>

    <span class="c">def</span> <span class="w">_trapCnxDone</span><span class="c">(self</span><span class="pc">,</span> <span class="w">o</span><span class="pc">b</span><span class="c">j):</span>
        <span class="w">g</span><span class="pc">e</span><span class="c">tattr(</span><span class="w">o</span><span class="pc">bj, '</span><span class="w">tr</span><span class="pc">ap</span><span class="c">',</span> <span class="w">l</span><span class="pc">a</span><span class="c">mbda</span> <span class="w">x</span><span class="c">:</span> <span class="w">N</span><span class="c">one</span><span class="w">)(er</span><span class="pc">ror</span><span class="c">.</span><span class="w">C</span><span class="pc">onnectionD</span><span class="c">one</span><span class="w">)</span>


    <span class="c">def</span> <span class="w">_connectedClientAndServerTest</span><span class="c">(self</span><span class="pc">,</span> <span class="w">cal</span><span class="pc">lb</span><span class="c">ack):</span>
        
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="w">serverConnMade</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">protocolConnectionMade</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">erverConnMade</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">serve</span><span class="pc">rF</span><span class="c">actory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="pc">p</span><span class="c">ort.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening)</span>

        <span class="w">portNumber</span> <span class="c">=</span> <span class="pc">p</span><span class="c">ort.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span>
        <span class="w">clientF</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
        <span class="w">clientConnMade</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>
        <span class="w">c</span><span class="pc">lientF</span><span class="c">.</span><span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lientConnMade</span>
        <span class="w">r</span><span class="c">eactor.</span><span class="pc">co</span><span class="c">nnectTCP</span><span class="pc">("</span><span class="c">127.0.0.1</span><span class="pc">"</span><span class="c">,</span> <span class="pc">p</span><span class="c">ortNumber</span><span class="pc">,</span> <span class="w">c</span><span class="c">lientF)</span>

        <span class="w">connsMade</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults([</span><span class="w">serverConnMade</span><span class="pc">,</span> <span class="w">c</span><span class="pc">l</span><span class="c">ientConnMade</span><span class="pc">]</span><span class="c">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">conne</span><span class="pc">cte</span><span class="c">d(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult):</span>
            <span class="w">ser</span><span class="pc">verP</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">cli</span><span class="pc">entP</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span>
            <span class="w">cal</span><span class="pc">lb</span><span class="c">ack</span><span class="pc">(</span><span class="w">se</span><span class="pc">rverP</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">cl</span><span class="pc">ientP</span><span class="c">rotocol)</span>
            <span class="w">s</span><span class="pc">erverP</span><span class="c">rotocol.transport.loseConnection()</span>
            <span class="w">cl</span><span class="pc">ientP</span><span class="c">rotocol.transport.loseConnection()</span>
        <span class="w">co</span><span class="pc">nns</span><span class="c">Made</span><span class="pc">.a</span><span class="c">ddCallback(</span><span class="w">co</span><span class="pc">nnecte</span><span class="c">d)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">onn</span><span class="c">sMade</span>


    <span class="c">def</span> <span class="w">test_tcpNoDelay</span><span class="c">(self):</span>
        
        <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="w">s</span><span class="pc">erverP</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">cl</span><span class="c">ientProtocol):</span>
            <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">p</span> <span class="c">in</span> <span class="w">[ser</span><span class="pc">verP</span><span class="c">rotocol</span><span class="w">,</span> <span class="w">cl</span><span class="c">ientProtocol</span><span class="w">]:</span>
                <span class="c">transport</span> <span class="pc">=</span> <span class="w">p</span><span class="c">.transport</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="pc">a</span><span class="c">ssertEqual(transport.</span><span class="w">getTcpNoDelay</span><span class="c">(),</span> <span class="w">0</span><span class="pc">)</span>
                <span class="pc">t</span><span class="c">ransport.</span><span class="w">setTcpNoDelay</span><span class="c">(</span><span class="w">1</span><span class="pc">)</span>
                <span class="c">self.assertEqual(</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">g</span><span class="c">etTcpNoDelay(),</span> <span class="w">1</span><span class="c">)</span>
                <span class="w">t</span><span class="c">ransport.</span><span class="w">s</span><span class="c">etTcpNoDelay(</span><span class="pc">0)</span>
                <span class="c">self.assertEqual(</span><span class="pc">t</span><span class="c">ransport.getTcpNoDelay(),</span> <span class="w">0</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_connectedClientAndServerTest</span><span class="pc">(</span><span class="w">ch</span><span class="pc">eck)</span>


    <span class="c">def</span> <span class="w">test_tcpKeepAlive</span><span class="c">(self):</span>
        
        <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="w">ser</span><span class="pc">verP</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">c</span><span class="pc">l</span><span class="c">ientProtocol):</span>
            <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">p</span> <span class="c">in</span> <span class="pc">[</span><span class="w">ser</span><span class="pc">verP</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">cl</span><span class="c">ientProtocol</span><span class="w">]:</span>
                <span class="c">transport</span> <span class="pc">=</span> <span class="w">p</span><span class="c">.</span><span class="pc">t</span><span class="c">ransport</span>
                <span class="w">s</span><span class="c">elf.</span><span class="pc">a</span><span class="c">ssertEqual(</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">getTcpKeepAlive</span><span class="c">(),</span> <span class="w">0</span><span class="pc">)</span>
                <span class="pc">t</span><span class="c">ransport.</span><span class="w">setTcpKeepAlive</span><span class="c">(</span><span class="w">1</span><span class="pc">)</span>
                <span class="c">self.assertEqual(</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">g</span><span class="c">etTcpKeepAlive(),</span> <span class="w">1</span><span class="c">)</span>
                <span class="w">t</span><span class="c">ransport.</span><span class="w">s</span><span class="c">etTcpKeepAlive(</span><span class="pc">0)</span>
                <span class="c">self.assertEqual(</span><span class="pc">t</span><span class="c">ransport.getTcpKeepAlive(),</span> <span class="w">0</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_connectedClientAndServerTest</span><span class="pc">(</span><span class="w">ch</span><span class="pc">eck)</span>


    <span class="c">def</span> <span class="w">testFailing</span><span class="c">(self):</span>
        <span class="w">clientF</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
        
        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor</span><span class="pc">.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">("1</span><span class="c">27.0.0.1</span><span class="pc">"</span><span class="c">,</span> <span class="w">69,</span> <span class="c">clientF</span><span class="pc">,</span> <span class="w">t</span><span class="pc">i</span><span class="c">meout</span><span class="pc">=</span><span class="w">5</span><span class="c">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="pc">c</span><span class="c">lientF.</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span><span class="pc">.</span><span class="w">t</span><span class="c">rap(</span><span class="w">e</span><span class="c">rror.</span><span class="w">ConnectionRefusedError</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">lientF</span><span class="c">.</span><span class="w">failDeferred.</span><span class="pc">a</span><span class="c">ddCallback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eck)</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_connectionRefusedErrorNumber</span><span class="c">(self):</span>
        

        
        
        
        
        
        
        

        
        
        
        
        
        
        
        
        
        

        <span class="w">serverSockets</span> <span class="pc">= </span><span class="c">[]</span>
        <span class="pc">f</span><span class="c">or</span> <span class="pc">i</span> <span class="c">in</span> <span class="pc">r</span><span class="c">ange(</span><span class="w">1</span><span class="c">0):</span>
            <span class="w">serverSocket</span> <span class="c">=</span> <span class="w">so</span><span class="c">cket.</span><span class="w">s</span><span class="pc">o</span><span class="c">cket()</span>
            <span class="w">s</span><span class="pc">er</span><span class="c">verSocket.</span><span class="w">bind((</span><span class="pc">'</span><span class="w">1</span><span class="pc">2</span><span class="c">7.0.0.1',</span> <span class="pc">0))</span>
            <span class="w">s</span><span class="pc">er</span><span class="c">verSocket.</span><span class="w">listen</span><span class="c">(</span><span class="pc">1</span><span class="c">)</span>
            <span class="w">s</span><span class="pc">erverSockets.</span><span class="w">a</span><span class="pc">p</span><span class="c">pend(</span><span class="pc">ser</span><span class="c">verSocket)</span>
        <span class="w">ra</span><span class="pc">n</span><span class="c">dom.</span><span class="w">shuffle</span><span class="c">(</span><span class="w">s</span><span class="pc">erverSockets</span><span class="c">)</span>

        <span class="w">clientCreator</span> <span class="c">=</span> <span class="w">pr</span><span class="pc">ot</span><span class="c">ocol.</span><span class="w">ClientCreator</span><span class="c">(</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">p</span><span class="c">rotocol</span><span class="pc">.</span><span class="w">P</span><span class="c">rotocol</span><span class="pc">)</span>

        <span class="c">def</span> <span class="w">tryConnectFailure</span><span class="pc">()</span><span class="c">:</span>
            <span class="pc">d</span><span class="c">ef</span> <span class="w">co</span><span class="pc">nnecte</span><span class="c">d(</span><span class="w">pr</span><span class="pc">oto</span><span class="c">):</span>
                
                <span class="w">p</span><span class="pc">roto.</span><span class="c">transport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
                <span class="w">i</span><span class="c">f</span> <span class="w">s</span><span class="pc">erverS</span><span class="c">ockets</span><span class="pc">:</span>
                    <span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">ry</span><span class="c">ConnectFailure</span><span class="pc">()</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ail</span><span class="w">(</span><span class="pc">"</span><span class="w">Could</span> <span class="w">n</span><span class="c">ot</span> <span class="w">fa</span><span class="pc">il</span> <span class="w">t</span><span class="c">o</span> <span class="w">connect</span> <span class="w">-</span> <span class="w">could</span> <span class="w">n</span><span class="c">ot</span> <span class="w">t</span><span class="pc">e</span><span class="c">st</span> <span class="w">er</span><span class="pc">rn</span><span class="c">o</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">that</span> <span class="w">cas</span><span class="c">e</span><span class="pc">."</span><span class="c">)</span>

            <span class="w">serverSocket</span> <span class="c">=</span> <span class="w">se</span><span class="pc">rverS</span><span class="c">ockets</span><span class="pc">.</span><span class="w">p</span><span class="c">op</span><span class="pc">()</span>
            <span class="w">serverHost,</span> <span class="w">serverPort</span> <span class="c">=</span> <span class="w">s</span><span class="pc">er</span><span class="c">verSocket.</span><span class="w">getsockname</span><span class="c">()</span>
            <span class="w">s</span><span class="pc">erverS</span><span class="c">ocket.</span><span class="w">c</span><span class="c">lose()</span>

            <span class="w">connectDeferred</span> <span class="c">=</span> <span class="w">clientCreator</span><span class="pc">.</span><span class="w">co</span><span class="pc">nnectT</span><span class="c">CP</span><span class="pc">(</span><span class="w">s</span><span class="pc">erverH</span><span class="c">ost,</span> <span class="pc">serverP</span><span class="c">ort)</span>
            <span class="c">connectDeferred.</span><span class="pc">a</span><span class="c">ddCallback(</span><span class="w">conn</span><span class="pc">ecte</span><span class="c">d)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="c">onnectDeferred</span>

        <span class="w">refusedDeferred</span> <span class="c">=</span> <span class="w">tryConnectFailure</span><span class="c">()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">assertF</span><span class="pc">ai</span><span class="c">lure(</span><span class="pc">r</span><span class="c">efusedDeferred,</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="pc">.</span><span class="w">ConnectionRefusedError</span><span class="c">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">connRefused</span><span class="c">(</span><span class="w">e</span><span class="pc">x</span><span class="c">c):</span>
            <span class="c">self.assertEqual(</span><span class="w">e</span><span class="c">xc.</span><span class="w">osError</span><span class="pc">,</span> <span class="w">er</span><span class="pc">rn</span><span class="c">o.</span><span class="w">ECONNREFUSED</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">ef</span><span class="c">usedDeferred.addCallback(</span><span class="pc">c</span><span class="c">onnRefused)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">cleanup</span><span class="c">(</span><span class="w">passthrough</span><span class="c">):</span>
            <span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="w">serverSockets</span><span class="c">:</span>
                <span class="w">s</span><span class="pc">er</span><span class="c">verSockets.</span><span class="w">p</span><span class="pc">o</span><span class="c">p</span><span class="w">()</span><span class="pc">.</span><span class="w">c</span><span class="c">lose()</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">p</span><span class="c">assthrough</span>
        <span class="w">r</span><span class="pc">ef</span><span class="c">usedDeferred.</span><span class="w">ad</span><span class="pc">dB</span><span class="c">oth(</span><span class="w">c</span><span class="pc">l</span><span class="c">eanup)</span>
        <span class="c">return</span> <span class="pc">r</span><span class="c">efusedDeferred</span>


    <span class="c">def</span> <span class="w">test_connectByServiceFail</span><span class="c">(self):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertR</span><span class="c">aises(</span>
            <span class="w">e</span><span class="c">rror</span><span class="pc">.</span><span class="w">ServiceNameUnknownError</span><span class="c">,</span>
            <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP,</span>
            <span class="w">"1</span><span class="c">27.0.0.1</span><span class="w">"</span><span class="pc">, </span><span class="c">"</span><span class="w">thisbetternotexist</span><span class="c">",</span> <span class="w">MyClientFactory(</span><span class="c">))</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_connectByService</span><span class="c">(self):</span>
        
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="w">serverConnMade</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="w">s</span><span class="pc">er</span><span class="c">verConnMade</span>
        <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eactor.listenTCP(0,</span> <span class="w">serve</span><span class="pc">rF</span><span class="c">actory,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">"</span><span class="c">127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="pc">p</span><span class="c">ort.</span><span class="w">s</span><span class="pc">t</span><span class="c">opListening)</span>
        <span class="w">portNumber</span> <span class="c">=</span> <span class="pc">p</span><span class="c">ort.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span>
        <span class="w">cl</span><span class="pc">ientF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
        <span class="w">clientConnMade</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>
        <span class="w">c</span><span class="pc">lientF</span><span class="c">actory.</span><span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lientConnMade</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">fakeGetServicePortByName</span><span class="c">(</span><span class="w">serviceName</span><span class="pc">,</span> <span class="w">protocolName</span><span class="c">):</span>
            <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">erviceName</span> <span class="w">=</span><span class="pc">= </span><span class="c">'</span><span class="w">ht</span><span class="c">tp</span><span class="w">'</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">p</span><span class="c">rotocolName</span> <span class="w">=</span><span class="pc">= </span><span class="c">'</span><span class="w">tcp</span><span class="c">':</span>
                <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">p</span><span class="pc">o</span><span class="c">rtNumber</span>
            <span class="w">r</span><span class="c">eturn</span> <span class="w">1</span><span class="pc">0</span>
        <span class="w">s</span><span class="pc">el</span><span class="c">f.</span><span class="w">p</span><span class="pc">a</span><span class="c">tch(</span><span class="w">so</span><span class="c">cket</span><span class="pc">,</span><span class="c"> '</span><span class="w">getservbyname</span><span class="c">',</span> <span class="w">f</span><span class="c">akeGetServicePortByName)</span>

        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP('</span><span class="w">1</span><span class="c">27.0.0.1</span><span class="w">'</span><span class="pc">, </span><span class="c">'</span><span class="w">h</span><span class="pc">t</span><span class="c">tp</span><span class="pc">'</span><span class="c">,</span> <span class="w">cli</span><span class="pc">entF</span><span class="c">actory</span><span class="pc">)</span>

        <span class="w">connMade</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="w">g</span><span class="pc">a</span><span class="c">therResults</span><span class="pc">([</span><span class="w">serverConnMade</span><span class="pc">,</span> <span class="w">clientConnMade</span><span class="pc">]</span><span class="c">)</span>
        <span class="c">def</span> <span class="w">conne</span><span class="pc">cte</span><span class="c">d(</span><span class="w">r</span><span class="pc">esult</span><span class="c">):</span>
            <span class="w">se</span><span class="pc">rverP</span><span class="c">rotocol</span><span class="pc">,</span> <span class="w">cli</span><span class="pc">entP</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span>
                <span class="w">serve</span><span class="pc">rF</span><span class="c">actory.</span><span class="w">cal</span><span class="pc">le</span><span class="c">d,</span>
                <span class="w">"S</span><span class="c">erver</span> <span class="w">fa</span><span class="pc">c</span><span class="c">tory</span> <span class="w">w</span><span class="c">as</span> <span class="w">n</span><span class="c">ot</span> <span class="w">ca</span><span class="pc">lle</span><span class="c">d</span> <span class="w">upon</span> <span class="w">t</span><span class="c">o</span> <span class="w">build</span> <span class="pc">a</span> <span class="w">pr</span><span class="pc">otocol</span><span class="w">.</span><span class="pc">"</span><span class="c">)</span>
            <span class="w">ser</span><span class="pc">verP</span><span class="c">rotocol</span><span class="pc">.t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
            <span class="w">c</span><span class="pc">lientP</span><span class="c">rotocol.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
        <span class="w">connMade</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">con</span><span class="pc">necte</span><span class="c">d)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">o</span><span class="c">nnMade</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">StartStopFactory</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="w">F</span><span class="c">actory):</span>

    <span class="w">started</span> <span class="c">=</span> <span class="w">0</span>
    <span class="w">s</span><span class="pc">t</span><span class="c">opped</span> <span class="c">=</span> <span class="pc">0</span>

    <span class="c">def</span> <span class="w">startFactory</span><span class="c">(self):</span>
        <span class="w">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">s</span><span class="pc">t</span><span class="c">arted</span> <span class="w">o</span><span class="c">r</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">sto</span><span class="c">pped:</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="c">RuntimeError</span>
        <span class="w">se</span><span class="c">lf.</span><span class="w">s</span><span class="pc">tarte</span><span class="c">d</span> <span class="c">=</span> <span class="w">1</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">stopFactory</span><span class="c">(self):</span>
        <span class="c">if</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="pc">sta</span><span class="c">rted</span> <span class="w">o</span><span class="c">r</span> <span class="c">self.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed</span><span class="pc">:</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="c">RuntimeError</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">st</span><span class="pc">opp</span><span class="c">ed</span> <span class="c">=</span> <span class="w">1</span>


<span class="w">c</span><span class="c">lass</span> <span class="w">ClientStartStopFactory</span><span class="c">(</span><span class="w">MyClientFactory</span><span class="c">):</span>

    <span class="w">s</span><span class="pc">t</span><span class="c">arted</span> <span class="pc">=</span> <span class="pc">0</span>
    <span class="w">s</span><span class="pc">to</span><span class="c">pped</span> <span class="c">=</span> <span class="pc">0</span>

    <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">, </span><span class="c">*</span><span class="pc">a,</span><span class="c"> **kw):</span>
        <span class="w">M</span><span class="c">yClientFactory</span><span class="pc">.</span><span class="c">__init__(self</span><span class="pc">, </span><span class="c">*</span><span class="pc">a</span><span class="c">, **kw)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">whenStopped</span> <span class="c">=</span> <span class="w">d</span><span class="pc">efe</span><span class="c">r.Deferred()</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">startFactory</span><span class="c">(self):</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="w">started</span> <span class="w">o</span><span class="c">r</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed:</span>
            <span class="pc">r</span><span class="c">aise</span> <span class="pc">R</span><span class="c">untimeError</span>
        <span class="w">s</span><span class="pc">e</span><span class="c">lf.started</span> <span class="pc">=</span> <span class="w">1</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">stopFactory</span><span class="c">(self):</span>
        <span class="c">if</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">self.</span><span class="pc">sta</span><span class="c">rted</span> <span class="w">o</span><span class="c">r</span> <span class="c">self.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed:</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="c">RuntimeError</span>
        <span class="w">s</span><span class="c">elf.</span><span class="w">st</span><span class="pc">opp</span><span class="c">ed</span> <span class="c">=</span> <span class="w">1</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">whenStopped</span><span class="pc">.</span><span class="w">c</span><span class="c">allback(</span><span class="w">T</span><span class="c">rue)</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">FactoryTests</span><span class="c">(unittest.TestCase):</span>
    

    <span class="c">def</span> <span class="w">test_serverStartStop</span><span class="c">(self):</span>
        
        
        
        
        
        

        <span class="w">f</span> <span class="c">=</span> <span class="w">StartStopFactory</span><span class="c">()</span>

        
        <span class="w">p1</span> <span class="c">=</span> <span class="w">r</span><span class="pc">e</span><span class="c">actor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">='</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p1</span><span class="c">.</span><span class="w">s</span><span class="c">topListening)</span>

        <span class="c">self.assertEqual</span><span class="pc">((f</span><span class="c">.</span><span class="w">started</span><span class="c">,</span> <span class="pc">f</span><span class="c">.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed</span><span class="w">),</span><span class="pc"> </span><span class="c">(</span><span class="w">1</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">)</span>

        
        <span class="w">p2</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">eactor.listenTCP(0,</span> <span class="pc">f,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">'</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="w">p3</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="w">i</span><span class="c">nterface</span><span class="pc">='</span><span class="c">127.0.0.1</span><span class="pc">')</span>

        <span class="c">self.assertEqual</span><span class="pc">((f</span><span class="c">.</span><span class="w">started</span><span class="c">,</span> <span class="pc">f</span><span class="c">.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed</span><span class="w">),</span><span class="pc"> </span><span class="c">(</span><span class="pc">1,</span> <span class="c">0</span><span class="pc">)</span><span class="c">)</span>

        
        <span class="w">d</span><span class="pc">1</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="pc">m</span><span class="c">aybeDeferred(</span><span class="w">p1</span><span class="c">.</span><span class="w">s</span><span class="pc">to</span><span class="c">pListening)</span>
        <span class="w">d</span><span class="pc">2</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">m</span><span class="c">aybeDeferred(</span><span class="w">p2</span><span class="c">.</span><span class="w">s</span><span class="pc">to</span><span class="c">pListening</span><span class="pc">)</span>
        <span class="w">closedDeferred</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="w">g</span><span class="c">atherResults</span><span class="pc">([d1</span><span class="c">,</span> <span class="c">d2])</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">cbClosed</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="c">self.assertEqual</span><span class="w">((</span><span class="pc">f</span><span class="c">.</span><span class="w">started</span><span class="c">,</span> <span class="w">f</span><span class="c">.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed</span><span class="w">),</span><span class="pc"> (</span><span class="w">1</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">)</span>
            
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">p3</span><span class="pc">.</span><span class="w">st</span><span class="pc">opL</span><span class="c">istening()</span>
        <span class="pc">clo</span><span class="c">sedDeferred</span><span class="pc">.</span><span class="c">addCallback(</span><span class="pc">cb</span><span class="c">Closed)</span>

        <span class="c">def</span> <span class="w">cbClosedAll</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="c">self.assertEqual</span><span class="w">((f</span><span class="pc">.</span><span class="w">s</span><span class="c">tarted</span><span class="pc">,</span> <span class="w">f</span><span class="c">.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed</span><span class="w">),</span><span class="pc"> (</span><span class="w">1</span><span class="pc">,</span> <span class="pc">1)</span><span class="c">)</span>
        <span class="w">c</span><span class="pc">lo</span><span class="c">sedDeferred.addCallback(</span><span class="pc">c</span><span class="c">bClosedAll)</span>
        <span class="c">return</span> <span class="w">c</span><span class="pc">lo</span><span class="c">sedDeferred</span>


    <span class="c">def</span> <span class="w">test_clientStartStop</span><span class="c">(self):</span>
        
        <span class="w">f</span> <span class="c">=</span> <span class="w">ClosingFactory</span><span class="c">()</span>
        <span class="w">p</span> <span class="c">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
        <span class="pc">f.</span><span class="w">p</span><span class="c">ort</span> <span class="c">=</span> <span class="pc">p</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">ad</span><span class="c">dCleanup(f.</span><span class="w">cleanUp)</span>
        <span class="w">portNumber</span> <span class="c">=</span> <span class="w">p</span><span class="c">.</span><span class="w">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span>

        <span class="w">f</span><span class="pc">a</span><span class="c">ctory</span> <span class="pc">=</span> <span class="w">ClientStartStopFactory</span><span class="c">()</span>
        <span class="pc">r</span><span class="c">eactor.</span><span class="pc">co</span><span class="c">nnectTCP</span><span class="pc">("</span><span class="c">127.0.0.1",</span> <span class="w">p</span><span class="c">ortNumber</span><span class="pc">,</span> <span class="w">f</span><span class="pc">a</span><span class="c">ctory</span><span class="pc">)</span>
        <span class="c">self.</span><span class="w">a</span><span class="pc">ssertT</span><span class="c">rue(</span><span class="w">f</span><span class="pc">a</span><span class="c">ctory.</span><span class="w">started</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">loopUntil</span><span class="c">(</span><span class="w">l</span><span class="c">ambda:</span> <span class="w">f</span><span class="pc">a</span><span class="c">ctory</span><span class="pc">.</span><span class="w">st</span><span class="pc">opp</span><span class="c">ed</span><span class="pc">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">CannotBindTests</span><span class="c">(unittest.TestCase):</span>
    

    <span class="c">def</span> <span class="w">test_cannotBind</span><span class="c">(self):</span>
        
        <span class="w">f</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>

        <span class="w">p1</span> <span class="pc">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">f</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">'</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p1</span><span class="c">.</span><span class="w">s</span><span class="c">topListening)</span>
        <span class="w">n</span> <span class="c">=</span> <span class="w">p1</span><span class="c">.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().p</span><span class="c">ort</span>
        <span class="w">de</span><span class="pc">s</span><span class="c">t</span> <span class="c">=</span> <span class="w">p1</span><span class="c">.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">()</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">d</span><span class="pc">e</span><span class="c">st.</span><span class="w">ty</span><span class="c">pe</span><span class="w">,</span><span class="pc"> "</span><span class="w">T</span><span class="c">CP</span><span class="pc">"</span><span class="c">)</span>
        <span class="c">self.assertEqual(</span><span class="w">de</span><span class="pc">s</span><span class="c">t.</span><span class="pc">h</span><span class="c">ost</span><span class="pc">, </span><span class="c">"127.0.0.1")</span>
        <span class="c">self.assertEqual(</span><span class="w">d</span><span class="pc">e</span><span class="c">st.</span><span class="pc">p</span><span class="c">ort,</span> <span class="w">n</span><span class="c">)</span>

        
        <span class="c">self.</span><span class="pc">assertR</span><span class="c">aises(</span><span class="w">e</span><span class="c">rror.</span><span class="w">CannotListenError</span><span class="c">,</span>
                          <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP</span><span class="pc">,</span> <span class="w">n</span><span class="c">,</span> <span class="w">f</span><span class="c">,</span> <span class="w">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">'</span><span class="c">127.0.0.1</span><span class="pc">')</span>



    <span class="pc">d</span><span class="c">ef</span> <span class="w">_fireWhenDoneFunc</span><span class="c">(self</span><span class="pc">,</span> <span class="w">d</span><span class="pc">,</span> <span class="w">f</span><span class="c">):</span>
        
        <span class="w">@wraps</span><span class="pc">(</span><span class="w">f</span><span class="pc">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">newf</span><span class="pc">(*</span><span class="c">args, **</span><span class="pc">kw</span><span class="c">):</span>
            <span class="w">rtn</span> <span class="c">=</span> <span class="w">f</span><span class="pc">(*</span><span class="c">args, **</span><span class="pc">kw</span><span class="c">)</span>
            <span class="pc">d.</span><span class="w">c</span><span class="c">allback</span><span class="w">('')</span>
            <span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">r</span><span class="pc">t</span><span class="c">n</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">n</span><span class="c">ewf</span>


    <span class="c">def</span> <span class="w">test_clientBind</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">theDeferred</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="w">sf</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="pc">()</span>
        <span class="w">s</span><span class="pc">f</span><span class="c">.</span><span class="w">startFactory</span> <span class="pc">=</span> <span class="pc">se</span><span class="c">lf.</span><span class="w">_fireWhenDoneFunc</span><span class="c">(</span><span class="pc">t</span><span class="c">heDeferred</span><span class="pc">,</span> <span class="pc">sf.st</span><span class="c">artFactory)</span>
        <span class="w">p</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">e</span><span class="c">actor.listenTCP(0,</span> <span class="pc">sf,</span> <span class="w">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p</span><span class="c">.</span><span class="w">s</span><span class="pc">to</span><span class="c">pListening</span><span class="pc">)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">_connect1</span><span class="c">(</span><span class="w">r</span><span class="pc">esults</span><span class="c">):</span>
            <span class="w">d</span> <span class="c">=</span> <span class="c">defer.Deferred()</span>
            <span class="w">cf1</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
            <span class="w">c</span><span class="pc">f</span><span class="c">1.</span><span class="w">b</span><span class="c">uildProtocol</span> <span class="w">=</span> <span class="w">s</span><span class="c">elf.</span><span class="w">_fireWhenDoneFunc</span><span class="pc">(</span><span class="w">d</span><span class="pc">,</span> <span class="c">cf1</span><span class="pc">.</span><span class="w">b</span><span class="c">uildProtocol)</span>
            <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">co</span><span class="c">nnectTCP</span><span class="pc">("</span><span class="c">127.0.0.1</span><span class="pc">",</span> <span class="w">p</span><span class="c">.</span><span class="w">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="pc">c</span><span class="c">f1</span><span class="pc">,</span>
                               <span class="w">b</span><span class="pc">i</span><span class="c">ndAddress</span><span class="w">=("1</span><span class="pc">2</span><span class="c">7.0.0.1</span><span class="pc">"</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">)</span>
            <span class="w">d</span><span class="c">.addCallback(</span><span class="w">_conmade</span><span class="pc">,</span> <span class="w">c</span><span class="pc">f</span><span class="c">1)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="pc">_</span><span class="c">conmade(</span><span class="w">r</span><span class="pc">esu</span><span class="c">lts</span><span class="pc">,</span> <span class="pc">c</span><span class="c">f1):</span>
            <span class="w">d</span> <span class="c">=</span> <span class="c">defer.Deferred()</span>
            <span class="w">c</span><span class="pc">f</span><span class="c">1.</span><span class="w">pr</span><span class="pc">ot</span><span class="c">ocol.</span><span class="w">co</span><span class="pc">nnectionM</span><span class="c">ade</span> <span class="w">=</span> <span class="w">s</span><span class="c">elf.</span><span class="w">_fireWhenDoneFunc</span><span class="c">(</span>
                <span class="c">d</span><span class="pc">,</span> <span class="pc">c</span><span class="c">f1</span><span class="pc">.</span><span class="w">pr</span><span class="pc">otoc</span><span class="c">ol.</span><span class="w">co</span><span class="pc">nnectionM</span><span class="c">ade</span><span class="pc">)</span>
            <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">_check1connect2</span><span class="pc">,</span> <span class="c">cf1</span><span class="pc">)</span>
            <span class="c">return</span> <span class="c">d</span>

        <span class="c">def</span> <span class="pc">_</span><span class="c">check1connect2(</span><span class="w">r</span><span class="pc">esults,</span> <span class="w">c</span><span class="c">f1</span><span class="pc">)</span><span class="c">:</span>
            <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="w">c</span><span class="pc">f</span><span class="c">1.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">made</span><span class="pc">,</span> <span class="w">1</span><span class="c">)</span>

            <span class="w">d</span><span class="pc">1</span> <span class="pc">=</span> <span class="pc">de</span><span class="c">fer.Deferred()</span>
            <span class="w">d</span><span class="pc">2</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
            <span class="w">po</span><span class="pc">rt</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">f</span><span class="c">1.</span><span class="w">pr</span><span class="pc">ot</span><span class="c">ocol.</span><span class="w">t</span><span class="c">ransport.</span><span class="w">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span>
            <span class="w">cf2</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
            <span class="w">c</span><span class="pc">f</span><span class="c">2.</span><span class="w">clientConnectionFailed</span> <span class="pc">=</span> <span class="pc">sel</span><span class="c">f.</span><span class="w">_fireWhenDoneFunc</span><span class="pc">(</span>
                <span class="w">d</span><span class="pc">1</span><span class="c">,</span> <span class="w">c</span><span class="pc">f</span><span class="c">2</span><span class="pc">.cl</span><span class="c">ientConnectionFailed)</span>
            <span class="w">c</span><span class="pc">f</span><span class="c">2.</span><span class="w">stopFactory</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">_</span><span class="c">fireWhenDoneFunc</span><span class="pc">(</span><span class="w">d</span><span class="pc">2,</span> <span class="c">cf2.</span><span class="pc">s</span><span class="c">topFactory)</span>
            <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP("</span><span class="pc">1</span><span class="c">27.0.0.1</span><span class="pc">",</span> <span class="w">p</span><span class="c">.</span><span class="w">g</span><span class="c">etHost().port</span><span class="pc">,</span> <span class="c">cf2</span><span class="pc">,</span>
                               <span class="w">b</span><span class="pc">i</span><span class="c">ndAddress</span><span class="w">=("1</span><span class="pc">2</span><span class="c">7.0.0.1</span><span class="pc">"</span><span class="c">,</span> <span class="w">p</span><span class="c">ort))</span>
            <span class="w">d</span><span class="pc">1.</span><span class="c">addCallback(</span><span class="w">_check2failed</span><span class="pc">,</span> <span class="w">cf1</span><span class="pc">,</span> <span class="pc">c</span><span class="c">f2)</span>
            <span class="w">d</span><span class="pc">2</span><span class="c">.addCallback(</span><span class="w">_check2stopped</span><span class="pc">,</span> <span class="w">c</span><span class="pc">f1,</span> <span class="pc">cf2</span><span class="c">)</span>
            <span class="w">dl</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="w">D</span><span class="pc">eferredL</span><span class="c">ist</span><span class="pc">([</span><span class="w">d</span><span class="pc">1</span><span class="c">,</span> <span class="pc">d</span><span class="c">2</span><span class="pc">]</span><span class="c">)</span>
            <span class="w">d</span><span class="pc">l</span><span class="c">.</span><span class="pc">a</span><span class="c">ddCallback(</span><span class="w">_stop</span><span class="pc">,</span> <span class="c">cf1</span><span class="pc">,</span> <span class="c">cf2)</span>
            <span class="c">return</span> <span class="w">d</span><span class="pc">l</span>

        <span class="c">def</span> <span class="w">_</span><span class="pc">check2f</span><span class="c">ailed(</span><span class="w">r</span><span class="pc">esu</span><span class="c">lts</span><span class="pc">,</span> <span class="pc">c</span><span class="c">f1</span><span class="pc">,</span> <span class="pc">cf2)</span><span class="c">:</span>
            <span class="w">s</span><span class="c">elf.assertEqual(</span><span class="pc">c</span><span class="c">f2.</span><span class="w">fai</span><span class="pc">le</span><span class="c">d,</span> <span class="w">1</span><span class="c">)</span>
            <span class="w">c</span><span class="pc">f2</span><span class="c">.</span><span class="w">rea</span><span class="pc">s</span><span class="c">on.</span><span class="w">t</span><span class="c">rap(</span><span class="pc">e</span><span class="c">rror</span><span class="pc">.</span><span class="w">ConnectBindError</span><span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">assertT</span><span class="c">rue(</span><span class="pc">c</span><span class="c">f2.</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span><span class="pc">.</span><span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="w">e</span><span class="c">rror.</span><span class="w">C</span><span class="c">onnectBindError</span><span class="pc">))</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">esults</span>

        <span class="c">def</span> <span class="w">_check2stopped</span><span class="c">(</span><span class="w">r</span><span class="pc">esults,</span> <span class="w">cf1</span><span class="pc">,</span> <span class="c">cf2):</span>
            <span class="c">self.assertEqual(</span><span class="w">c</span><span class="pc">f2</span><span class="c">.</span><span class="w">s</span><span class="pc">t</span><span class="c">opped,</span> <span class="w">1</span><span class="c">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">re</span><span class="pc">sults</span>

        <span class="c">def</span> <span class="w">_stop</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">sults</span><span class="pc">,</span> <span class="c">cf1</span><span class="pc">,</span> <span class="c">cf2):</span>
            <span class="w">d</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
            <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">_check1cleanup</span><span class="pc">,</span> <span class="pc">cf1</span><span class="c">)</span>
            <span class="w">c</span><span class="pc">f1</span><span class="c">.</span><span class="w">stopFactory</span> <span class="pc">=</span> <span class="w">s</span><span class="c">elf.</span><span class="w">_fireWhenDoneFunc</span><span class="c">(</span><span class="pc">d</span><span class="c">,</span> <span class="pc">cf1.</span><span class="w">s</span><span class="c">topFactory)</span>
            <span class="pc">c</span><span class="c">f1.</span><span class="w">pr</span><span class="c">otocol.</span><span class="w">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
            <span class="c">return</span> <span class="c">d</span>

        <span class="c">def</span> <span class="w">_</span><span class="pc">c</span><span class="c">heck1cleanup(</span><span class="pc">r</span><span class="c">esults</span><span class="pc">,</span> <span class="pc">c</span><span class="c">f1):</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">c</span><span class="c">f1.</span><span class="w">sto</span><span class="pc">pp</span><span class="c">ed,</span> <span class="w">1</span><span class="c">)</span>

        <span class="w">theDeferred</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">_connect1</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">t</span><span class="c">heDeferred</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">MyOtherClientFactory</span><span class="c">(</span><span class="w">p</span><span class="c">rotocol.</span><span class="pc">C</span><span class="c">lientFactory):</span>
    <span class="c">def</span> <span class="w">b</span><span class="c">uildProtocol(self,</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss):</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">ad</span><span class="pc">dr</span><span class="c">ess</span> <span class="c">=</span> <span class="w">a</span><span class="c">ddress</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">AccumulatingProtocol</span><span class="pc">()</span>
        <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="c">self.protocol</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">LocalRemoteAddressTests</span><span class="c">(</span><span class="pc">u</span><span class="c">nittest.TestCase):</span>
    
    <span class="c">def</span> <span class="w">test_hostAddress</span><span class="c">(self):</span>
        
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="pc">()</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">protocolConnectionLost</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>
        <span class="w">serverConnectionLost</span> <span class="c">=</span> <span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="pc">p</span><span class="c">rotocolConnectionLost</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.listenTCP(0,</span> <span class="w">serve</span><span class="pc">rF</span><span class="c">actory</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">='</span><span class="c">127.0.0.1</span><span class="pc">'</span><span class="c">)</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(port.</span><span class="w">s</span><span class="c">topListening</span><span class="pc">)</span>
        <span class="w">n</span> <span class="c">=</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span>

        <span class="w">cl</span><span class="pc">ientF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
        <span class="w">onConnection</span> <span class="c">=</span> <span class="w">cl</span><span class="pc">ientF</span><span class="c">actory</span><span class="pc">.</span><span class="w">protocolConnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">co</span><span class="c">nnectTCP('127.0.0.1',</span> <span class="w">n</span><span class="pc">,</span> <span class="w">cl</span><span class="pc">ientF</span><span class="c">actory)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">ch</span><span class="c">eck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="c">self.assertEqual</span><span class="pc">([</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="pc">g</span><span class="c">etHost</span><span class="w">()],</span> <span class="w">cl</span><span class="pc">ientF</span><span class="c">actory.</span><span class="w">peerAddresses</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span>
                <span class="pc">p</span><span class="c">ort.getHost(),</span> <span class="w">cl</span><span class="pc">ientF</span><span class="c">actory.</span><span class="w">pr</span><span class="c">otocol.</span><span class="w">t</span><span class="c">ransport.</span><span class="w">g</span><span class="pc">etP</span><span class="c">eer</span><span class="pc">())</span>
        <span class="w">onConnection</span><span class="c">.addCallback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eck)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">cleanup</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            
            
            
            <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span><span class="pc">.</span><span class="w">di</span><span class="pc">sc</span><span class="c">onnect()</span>
            <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">serverConnectionLost</span>
        <span class="w">o</span><span class="pc">nC</span><span class="c">onnection</span><span class="pc">.a</span><span class="c">ddCallback(</span><span class="w">c</span><span class="c">leanup)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="w">o</span><span class="c">nConnection</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">WriterProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.Protocol):</span>
    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        
        
        
        
        
        <span class="c">self.transport.</span><span class="pc">w</span><span class="c">rite</span><span class="pc">(</span><span class="c">b"</span><span class="w">H</span><span class="c">ello</span> <span class="w">Cleveland!\n</span><span class="c">")</span>
        <span class="w">seq</span> <span class="pc">= </span><span class="c">[</span><span class="w">b</span><span class="c">"</span><span class="w">Goodbye</span><span class="c">",</span> <span class="pc">b</span><span class="c">"</span> <span class="w">cruel</span><span class="c">",</span> <span class="c">b"</span> <span class="w">w</span><span class="c">orld",</span> <span class="c">b</span><span class="pc">"\n</span><span class="w">"]</span>
        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">w</span><span class="pc">riteS</span><span class="c">equence(</span><span class="w">s</span><span class="pc">eq</span><span class="c">)</span>
        <span class="w">peer</span> <span class="c">=</span> <span class="c">self.transport.</span><span class="w">g</span><span class="pc">etP</span><span class="c">eer()</span>
        <span class="w">i</span><span class="c">f</span> <span class="c">peer</span><span class="pc">.</span><span class="w">ty</span><span class="c">pe</span> <span class="w">!= "T</span><span class="pc">C</span><span class="c">P</span><span class="pc">"</span><span class="c">:</span>
            <span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="w">(</span><span class="pc">"</span><span class="w">ge</span><span class="pc">tP</span><span class="c">eer</span> <span class="w">returned</span> <span class="w">non-T</span><span class="pc">C</span><span class="c">P</span> <span class="w">so</span><span class="pc">c</span><span class="c">ket</span><span class="w">:</span><span class="c"> %</span><span class="pc">s</span><span class="c">" % (peer</span><span class="pc">,)</span><span class="c">)</span>
            <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">problem</span> <span class="pc">=</span> <span class="w">1</span>
        <span class="w">us</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">g</span><span class="pc">etH</span><span class="c">ost()</span>
        <span class="pc">i</span><span class="c">f</span> <span class="pc">u</span><span class="c">s.</span><span class="w">ty</span><span class="c">pe</span> <span class="w">!</span><span class="pc">= </span><span class="c">"</span><span class="w">T</span><span class="c">CP</span><span class="w">"</span><span class="c">:</span>
            <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="c">"</span><span class="w">ge</span><span class="pc">tH</span><span class="c">ost</span> <span class="w">r</span><span class="pc">et</span><span class="c">urned</span> <span class="w">n</span><span class="pc">on</span><span class="w">-T</span><span class="pc">C</span><span class="c">P</span> <span class="w">so</span><span class="c">cket</span><span class="w">:</span><span class="c"> %s" % (</span><span class="pc">u</span><span class="c">s</span><span class="pc">,)</span><span class="c">)</span>
            <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="pc">p</span><span class="c">roblem</span> <span class="w">=</span> <span class="w">1</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">d</span><span class="pc">o</span><span class="c">ne</span> <span class="c">=</span> <span class="w">1</span>

        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.loseConnection()</span>

<span class="w">c</span><span class="c">lass</span> <span class="w">ReaderProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">P</span><span class="c">rotocol):</span>
    <span class="c">def</span> <span class="pc">d</span><span class="c">ataReceived(self</span><span class="pc">,</span> <span class="c">data):</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">d</span><span class="pc">ata</span> <span class="w">+</span><span class="c">=</span> <span class="c">data</span>
    <span class="pc">d</span><span class="c">ef</span> <span class="pc">c</span><span class="c">onnectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">do</span><span class="c">ne</span> <span class="pc">=</span> <span class="w">1</span>

<span class="pc">c</span><span class="c">lass</span> <span class="w">WriterClientFactory</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">C</span><span class="c">lientFactory):</span>
    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">do</span><span class="pc">n</span><span class="c">e</span> <span class="c">=</span> <span class="w">0</span>
        <span class="c">self.</span><span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="c">=</span> <span class="w">b""</span>
    <span class="pc">d</span><span class="c">ef</span> <span class="pc">b</span><span class="c">uildProtocol(self,</span> <span class="pc">a</span><span class="c">ddr):</span>
        <span class="w">p</span> <span class="c">=</span> <span class="w">ReaderProtocol</span><span class="c">()</span>
        <span class="w">p</span><span class="c">.</span><span class="w">f</span><span class="c">actory</span> <span class="c">=</span> <span class="c">self</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">p</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="pc">p</span>

<span class="pc">c</span><span class="c">lass</span> <span class="w">WriteDataTests</span><span class="c">(</span><span class="pc">u</span><span class="c">nittest.TestCase):</span>
    

    <span class="c">def</span> <span class="w">test_writer</span><span class="c">(self):</span>
        
        <span class="w">f</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">F</span><span class="c">actory()</span>
        <span class="w">f</span><span class="pc">.</span><span class="c">protocol</span> <span class="c">=</span> <span class="w">WriterProtocol</span>
        <span class="w">f</span><span class="pc">.</span><span class="w">d</span><span class="pc">o</span><span class="c">ne</span> <span class="c">=</span> <span class="w">0</span>
        <span class="w">f</span><span class="pc">.</span><span class="w">problem</span> <span class="pc">=</span> <span class="w">0</span>
        <span class="w">wrappedF</span> <span class="c">=</span> <span class="w">WiredFactory</span><span class="pc">(f</span><span class="c">)</span>
        <span class="w">p</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.listenTCP(0,</span> <span class="w">w</span><span class="c">rappedF</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1</span><span class="pc">")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p</span><span class="c">.</span><span class="w">s</span><span class="c">topListening</span><span class="pc">)</span>
        <span class="w">n</span> <span class="c">=</span> <span class="pc">p</span><span class="c">.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().p</span><span class="c">ort</span>
        <span class="w">clientF</span> <span class="c">=</span> <span class="w">WriterClientFactory</span><span class="pc">()</span>
        <span class="w">wrappedClientF</span> <span class="c">=</span> <span class="w">WiredFactory</span><span class="c">(</span><span class="pc">c</span><span class="c">lientF)</span>
        <span class="w">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">("1</span><span class="c">27.0.0.1</span><span class="pc">"</span><span class="c">,</span> <span class="w">n</span><span class="pc">,</span> <span class="pc">w</span><span class="c">rappedClientF</span><span class="pc">)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="c">self.</span><span class="w">f</span><span class="c">ailUnless(</span><span class="w">f</span><span class="c">.</span><span class="w">do</span><span class="pc">n</span><span class="c">e</span><span class="pc">, </span><span class="c">"</span><span class="w">wr</span><span class="pc">iter</span> <span class="w">didn'</span><span class="c">t</span> <span class="w">fi</span><span class="pc">n</span><span class="c">ish</span><span class="w">,</span> <span class="w">it</span> <span class="w">probably</span> <span class="w">died</span><span class="pc">"</span><span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">f</span><span class="c">ailUnless(</span><span class="pc">f</span><span class="c">.</span><span class="w">problem</span> <span class="w">=</span><span class="pc">=</span> <span class="c">0</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="w">wr</span><span class="pc">iter</span> <span class="w">indicated</span> <span class="w">an</span> <span class="w">e</span><span class="c">rror</span><span class="pc">"</span><span class="c">)</span>
            <span class="c">self.</span><span class="pc">f</span><span class="c">ailUnless(</span><span class="w">clientF</span><span class="c">.</span><span class="w">do</span><span class="c">ne,</span>
                            <span class="w">"cl</span><span class="pc">ient</span> <span class="w">di</span><span class="pc">d</span><span class="c">n</span><span class="w">'</span><span class="c">t</span> <span class="w">see</span> <span class="w">con</span><span class="pc">n</span><span class="c">ection</span> <span class="w">dropped</span><span class="pc">")</span>
            <span class="w">e</span><span class="pc">x</span><span class="c">pected</span> <span class="c">=</span> <span class="w">b"".</span><span class="pc">j</span><span class="c">oin</span><span class="pc">([</span><span class="w">b</span><span class="c">"</span><span class="w">H</span><span class="c">ello</span> <span class="w">Cleveland!\n</span><span class="pc">",</span>
                                <span class="c">b"</span><span class="w">Goodbye</span><span class="c">",</span> <span class="pc">b</span><span class="c">"</span> <span class="w">cruel</span><span class="c">",</span> <span class="c">b"</span> <span class="w">w</span><span class="c">orld",</span> <span class="c">b</span><span class="pc">"\n</span><span class="w">"</span><span class="pc">]</span><span class="c">)</span>
            <span class="c">self.</span><span class="w">f</span><span class="c">ailUnless(</span><span class="w">clientF</span><span class="pc">.</span><span class="w">d</span><span class="c">ata</span> <span class="w">=</span><span class="c">=</span> <span class="w">e</span><span class="c">xpected</span><span class="pc">,</span>
                            <span class="w">"cli</span><span class="pc">ent</span> <span class="w">didn'</span><span class="pc">t</span> <span class="w">receive</span> <span class="w">all</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">d</span><span class="c">ata</span> <span class="w">i</span><span class="pc">t</span> <span class="w">e</span><span class="pc">x</span><span class="c">pected</span><span class="w">"</span><span class="pc">)</span>
        <span class="w">d</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults</span><span class="pc">([</span><span class="w">wrappedF</span><span class="c">.</span><span class="w">onDisconnect</span><span class="c">,</span>
                                 <span class="w">wrappedClientF</span><span class="pc">.o</span><span class="c">nDisconnect</span><span class="w">]</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d.addCallback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eck)</span>


    <span class="c">def</span> <span class="w">test_writeAfterShutdownWithoutReading</span><span class="c">(self):</span>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <span class="w">i</span><span class="c">f</span> <span class="w">rea</span><span class="pc">c</span><span class="c">tor.</span><span class="w">_</span><span class="c">_class__.</span><span class="pc">__n</span><span class="c">ame__</span> <span class="w">=</span><span class="c">= '</span><span class="w">IOCPReactor</span><span class="c">':</span>
            <span class="pc">ra</span><span class="c">ise</span> <span class="w">u</span><span class="pc">n</span><span class="c">ittest.</span><span class="w">S</span><span class="c">kipTest</span><span class="pc">(</span>
                <span class="w">"iocpreactor</span> <span class="w">d</span><span class="c">oes</span> <span class="c">not</span><span class="w">,</span> <span class="w">in</span> <span class="w">fact,</span> <span class="w">sto</span><span class="c">p</span> <span class="w">reading</span> <span class="w">immediately</span> <span class="w">af</span><span class="c">ter</span> <span class="c">"</span>
                <span class="c">"</span><span class="w">pau</span><span class="pc">seP</span><span class="c">roducing</span> <span class="w">i</span><span class="pc">s</span> <span class="w">cal</span><span class="pc">le</span><span class="c">d</span><span class="pc">.</span> <span class="w">T</span><span class="pc">h</span><span class="c">is</span> <span class="w">res</span><span class="pc">ults</span> <span class="w">in</span> <span class="w">a</span> <span class="w">bonus</span> <span class="w">disconnection</span> <span class="pc">"</span>
                <span class="c">"</span><span class="w">notification.</span> <span class="w">Under</span> <span class="w">so</span><span class="c">me</span> <span class="w">circumstances</span><span class="pc">,</span> <span class="w">i</span><span class="pc">t</span> <span class="w">might</span> <span class="w">b</span><span class="pc">e</span> <span class="w">possible</span> <span class="pc">t</span><span class="c">o</span> <span class="c">"</span>
                <span class="c">"</span><span class="w">n</span><span class="pc">ot</span> <span class="w">receive</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">notifications</span> <span class="w">(specifically</span><span class="c">,</span> <span class="w">pau</span><span class="pc">seP</span><span class="c">roducing</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span>
                <span class="c">"</span><span class="w">deliver</span> <span class="w">so</span><span class="c">me</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="w">,</span> <span class="w">proceed</span> <span class="w">w</span><span class="c">ith</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">te</span><span class="pc">s</span><span class="c">t</span><span class="w">).")</span>
        <span class="w">i</span><span class="c">f</span> <span class="w">rea</span><span class="pc">c</span><span class="c">tor.</span><span class="w">_</span><span class="pc">_c</span><span class="c">lass__.</span><span class="pc">_</span><span class="c">_name__</span> <span class="w">=</span><span class="c">= '</span><span class="w">GtkReactor</span><span class="c">':</span>
            <span class="pc">r</span><span class="c">aise</span> <span class="w">u</span><span class="pc">n</span><span class="c">ittest.</span><span class="w">S</span><span class="pc">k</span><span class="c">ipTest(</span>
                <span class="c">"</span><span class="w">gtkreactor</span> <span class="w">d</span><span class="pc">o</span><span class="c">es</span> <span class="c">not</span> <span class="w">implement</span> <span class="w">unclean</span> <span class="w">disconnection</span> <span class="c">"</span>
                <span class="c">"</span><span class="w">notification</span> <span class="w">correctly.</span>  <span class="w">T</span><span class="pc">hi</span><span class="c">s</span> <span class="w">might</span> <span class="w">more</span> <span class="w">properly</span> <span class="w">b</span><span class="c">e</span> <span class="c">"</span>
                <span class="c">"</span><span class="w">a</span> <span class="w">to</span><span class="pc">d</span><span class="c">o</span><span class="w">,</span> <span class="w">but</span> <span class="w">due</span> <span class="pc">t</span><span class="c">o</span> <span class="w">technical</span> <span class="w">limitations</span> <span class="w">i</span><span class="pc">t</span> <span class="w">cannot</span> <span class="w">b</span><span class="c">e</span><span class="w">.</span><span class="c">")</span>

        
        
        
        
        
        <span class="w">clientPaused</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>

        
        
        <span class="w">serverLost</span> <span class="c">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>

        <span class="w">c</span><span class="pc">la</span><span class="c">ss</span> <span class="w">Disconnecter</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">P</span><span class="c">rotocol):</span>
            
            <span class="c">def</span> <span class="pc">co</span><span class="c">nnectionMade(self):</span>
                
                <span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="w">(</span><span class="pc">'</span><span class="w">Disconnector</span><span class="pc">.</span><span class="w">c</span><span class="pc">onnectionM</span><span class="c">ade</span><span class="w">'</span><span class="pc">)</span>
                <span class="pc">d</span><span class="c">ef</span> <span class="w">d</span><span class="pc">i</span><span class="c">sconnect(</span><span class="pc">i</span><span class="c">gnored):</span>
                    <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="c">Disconnector</span><span class="pc">.</span><span class="w">co</span><span class="pc">nnectionM</span><span class="c">ade</span> <span class="w">di</span><span class="pc">sconnect</span><span class="w">'</span><span class="pc">)</span>
                    <span class="pc">s</span><span class="c">elf.</span><span class="pc">t</span><span class="c">ransport.loseConnection()</span>
                    <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">los</span><span class="c">eConnection</span> <span class="w">ca</span><span class="c">lled</span><span class="w">')</span>
                <span class="w">clientPaused</span><span class="pc">.a</span><span class="c">ddCallback(</span><span class="w">di</span><span class="pc">sconnect</span><span class="c">)</span>

            <span class="pc">d</span><span class="c">ef</span> <span class="c">connectionLost(self</span><span class="pc">,</span> <span class="c">reason):</span>
                
                <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">Disconnecter</span><span class="pc">.c</span><span class="c">onnectionLost</span><span class="pc">'</span><span class="c">)</span>
                <span class="w">serverLost</span><span class="pc">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(</span><span class="pc">N</span><span class="c">one)</span>
                <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="c">serverLost</span> <span class="w">ca</span><span class="c">lled</span> <span class="w">back'</span><span class="c">)</span>

        
        <span class="w">s</span><span class="pc">erver</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">S</span><span class="pc">e</span><span class="c">rverFactory()</span>
        <span class="w">s</span><span class="pc">er</span><span class="c">ver.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">D</span><span class="pc">i</span><span class="c">sconnecter</span>
        <span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">s</span><span class="c">erver</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">'</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(port.</span><span class="w">s</span><span class="c">topListening</span><span class="pc">)</span>
        <span class="w">a</span><span class="pc">d</span><span class="c">dr</span> <span class="c">=</span> <span class="pc">p</span><span class="c">ort.</span><span class="pc">g</span><span class="c">etHost()</span>

        <span class="w">@</span><span class="c">implementer(</span><span class="w">IPullProducer</span><span class="c">)</span>
        <span class="c">class</span> <span class="w">Infinite</span><span class="c">(object):</span>
            

            <span class="c">def</span> <span class="c">__init__(self</span><span class="pc">,</span> <span class="w">c</span><span class="pc">on</span><span class="c">sumer):</span>
                <span class="c">self.consumer</span> <span class="c">=</span> <span class="pc">c</span><span class="c">onsumer</span>

            <span class="pc">d</span><span class="c">ef</span> <span class="pc">r</span><span class="c">esumeProducing(self):</span>
                <span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="w">(</span><span class="pc">'</span><span class="w">I</span><span class="pc">n</span><span class="c">finite.</span><span class="w">r</span><span class="pc">es</span><span class="c">umeProducing</span><span class="w">'</span><span class="c">)</span>
                <span class="c">self.</span><span class="pc">c</span><span class="c">onsumer</span><span class="pc">.w</span><span class="c">rite(</span><span class="pc">b</span><span class="c">'</span><span class="pc">x')</span>
                <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">I</span><span class="c">nfinite</span><span class="w">.r</span><span class="c">esumeProducing</span> <span class="w">wrote</span> <span class="w">t</span><span class="pc">o</span> <span class="w">co</span><span class="pc">ns</span><span class="c">umer</span><span class="w">'</span><span class="pc">)</span>

            <span class="pc">d</span><span class="c">ef</span> <span class="w">s</span><span class="pc">t</span><span class="c">opProducing(self):</span>
                <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">I</span><span class="c">nfinite.</span><span class="w">st</span><span class="c">opProducing</span><span class="w">'</span><span class="c">)</span>


        <span class="pc">c</span><span class="c">lass</span> <span class="w">UnreadingWriter</span><span class="c">(</span><span class="w">p</span><span class="c">rotocol.Protocol):</span>
            
            <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
                <span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="w">(</span><span class="pc">'</span><span class="w">U</span><span class="c">nreadingWriter</span><span class="w">.c</span><span class="pc">onnectionM</span><span class="c">ade</span><span class="w">'</span><span class="c">)</span>
                <span class="c">self.transport.</span><span class="w">p</span><span class="c">auseProducing()</span>
                <span class="w">clientPaused</span><span class="pc">.</span><span class="w">c</span><span class="pc">a</span><span class="c">llback(None)</span>
                <span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="w">('</span><span class="pc">c</span><span class="c">lientPaused</span> <span class="w">ca</span><span class="pc">lle</span><span class="c">d</span> <span class="w">back</span><span class="pc">'</span><span class="c">)</span>
                <span class="pc">d</span><span class="c">ef</span> <span class="w">w</span><span class="c">rite(</span><span class="pc">i</span><span class="c">gnored):</span>
                    <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="c">'</span><span class="pc">U</span><span class="c">nreadingWriter</span><span class="pc">.</span><span class="w">co</span><span class="pc">nnectionM</span><span class="c">ade</span> <span class="w">wr</span><span class="pc">ite'</span><span class="c">)</span>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    <span class="w">pro</span><span class="pc">d</span><span class="c">ucer</span> <span class="pc">=</span> <span class="w">Infinite</span><span class="pc">(</span><span class="c">self.</span><span class="pc">t</span><span class="c">ransport</span><span class="pc">)</span>
                    <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">U</span><span class="c">nreadingWriter</span><span class="w">.co</span><span class="pc">nnectionM</span><span class="c">ade</span> <span class="w">wr</span><span class="pc">ite</span> <span class="w">created</span> <span class="w">p</span><span class="pc">rod</span><span class="c">ucer</span><span class="pc">'</span><span class="c">)</span>
                    <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">r</span><span class="c">egisterProducer(</span><span class="pc">p</span><span class="c">roducer</span><span class="pc">,</span> <span class="pc">F</span><span class="c">alse)</span>
                    <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">U</span><span class="c">nreadingWriter</span><span class="pc">.</span><span class="w">c</span><span class="pc">onnectionM</span><span class="c">ade</span> <span class="w">wr</span><span class="pc">ite</span> <span class="w">registered</span> <span class="w">p</span><span class="c">roducer</span><span class="w">'</span><span class="pc">)</span>
                <span class="w">serverLost</span><span class="pc">.ad</span><span class="c">dCallback(</span><span class="w">wr</span><span class="pc">ite</span><span class="c">)</span>

        
        <span class="w">c</span><span class="pc">lient</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
        <span class="w">c</span><span class="pc">li</span><span class="c">ent.</span><span class="w">protocolFactory</span> <span class="pc">=</span> <span class="w">U</span><span class="c">nreadingWriter</span>
        <span class="w">clientConnectionLost</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">cbClientLost</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">c</span><span class="pc">b</span><span class="c">ClientLost</span><span class="pc">')</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">lostReason</span>
        <span class="w">c</span><span class="c">lientConnectionLost</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="pc">bC</span><span class="c">lientLost)</span>
        <span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="w">(</span><span class="c">'</span><span class="w">Connecting</span> <span class="w">t</span><span class="c">o</span> <span class="pc">%</span><span class="c">s</span><span class="w">:</span><span class="c">%s' % (</span><span class="w">ad</span><span class="pc">dr</span><span class="w">.h</span><span class="c">ost,</span> <span class="w">a</span><span class="pc">ddr.p</span><span class="c">ort</span><span class="pc">)</span><span class="c">)</span>
        <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">co</span><span class="c">nnectTCP</span><span class="pc">(</span><span class="w">a</span><span class="pc">ddr.h</span><span class="c">ost,</span> <span class="w">a</span><span class="pc">ddr</span><span class="c">.port,</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient</span><span class="pc">)</span>

        
        
        <span class="w">m</span><span class="c">sg</span><span class="w">(</span><span class="pc">'</span><span class="w">Returning</span> <span class="w">D</span><span class="pc">eferred</span><span class="w">'</span><span class="pc">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="c">ssertFailure(</span><span class="w">clientConnectionLost</span><span class="c">,</span> <span class="w">e</span><span class="c">rror.</span><span class="w">ConnectionLost</span><span class="c">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ConnectionLosingProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.Protocol):</span>
    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        <span class="c">self.transport.write(b"</span><span class="w">1</span><span class="pc">"</span><span class="c">)</span>
        <span class="c">self.transport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">master</span><span class="pc">.</span><span class="w">_connectionMade</span><span class="c">()</span>
        <span class="c">self.</span><span class="pc">m</span><span class="c">aster.</span><span class="w">ports</span><span class="pc">.a</span><span class="c">ppend(self.transport</span><span class="pc">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">NoopProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.Protocol):</span>
    <span class="c">def</span> <span class="c">connectionMade(self):</span>
        <span class="c">self.</span><span class="w">d</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">m</span><span class="c">aster.</span><span class="w">serverConns</span><span class="pc">.a</span><span class="c">ppend(self.</span><span class="w">d</span><span class="pc">)</span>

    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">d</span><span class="c">.</span><span class="pc">c</span><span class="c">allback(</span><span class="w">T</span><span class="c">rue)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ConnectionLostNotifyingProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">P</span><span class="c">rotocol):</span>
    
    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">onConnectionLost</span><span class="c">):</span>
        <span class="c">self.</span><span class="w">lostConnectionReason</span> <span class="c">=</span> <span class="pc">N</span><span class="c">one</span>
        <span class="pc">s</span><span class="c">elf.onConnectionLost</span> <span class="c">=</span> <span class="pc">o</span><span class="c">nConnectionLost</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">onnectionL</span><span class="c">ost(self,</span> <span class="c">reason):</span>
        <span class="c">self.lostConnectionReason</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eason</span>
        <span class="c">self.</span><span class="pc">o</span><span class="c">nConnectionLost</span><span class="pc">.c</span><span class="c">allback(self</span><span class="pc">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">HandleSavingProtocol</span><span class="c">(</span><span class="w">ConnectionLostNotifyingProtocol</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="w">m</span><span class="pc">a</span><span class="c">keConnection(self</span><span class="pc">,</span> <span class="w">t</span><span class="c">ransport):</span>
        
        <span class="c">self.</span><span class="w">h</span><span class="pc">a</span><span class="c">ndle</span> <span class="c">=</span> <span class="w">t</span><span class="c">ransport</span><span class="pc">.</span><span class="w">getHandle</span><span class="c">()</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="w">p</span><span class="c">rotocol</span><span class="pc">.</span><span class="w">P</span><span class="c">rotocol</span><span class="w">.</span><span class="pc">m</span><span class="c">akeConnection(self</span><span class="pc">,</span> <span class="pc">t</span><span class="c">ransport)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ProperlyCloseFilesMixin</span><span class="pc">:</span>
    
    <span class="c">def</span> <span class="w">createServer</span><span class="c">(self</span><span class="pc">,</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss,</span> <span class="w">portNumber</span><span class="c">,</span> <span class="w">f</span><span class="c">actory):</span>
        
        <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="c">NotImplementedError</span><span class="pc">()</span>


    <span class="c">def</span> <span class="w">connectClient</span><span class="c">(self,</span> <span class="w">a</span><span class="c">ddress</span><span class="pc">,</span> <span class="pc">portN</span><span class="c">umber</span><span class="pc">,</span> <span class="w">clientCreator</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="c">NotImplementedError</span><span class="pc">()</span>


    <span class="c">def</span> <span class="w">getHandleExceptionType</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">ra</span><span class="c">ise</span> <span class="c">NotImplementedError</span><span class="pc">()</span>


    <span class="c">def</span> <span class="w">getHandleErrorCode</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        
        
        
        
        <span class="c">return</span> <span class="w">er</span><span class="pc">rn</span><span class="c">o.</span><span class="w">EBADF</span>


    <span class="pc">d</span><span class="c">ef</span> <span class="w">test_properlyCloseFiles</span><span class="c">(self):</span>
        
        <span class="w">onServerConnectionLost</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">S</span><span class="pc">e</span><span class="c">rverFactory()</span>
        <span class="w">se</span><span class="pc">rverF</span><span class="c">actory.protocol</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ambda:</span> <span class="w">ConnectionLostNotifyingProtocol</span><span class="c">(</span>
            <span class="pc">o</span><span class="c">nServerConnectionLost)</span>
        <span class="w">serverPort</span> <span class="c">=</span> <span class="c">self.</span><span class="w">createServer</span><span class="pc">('</span><span class="w">1</span><span class="c">27.0.0.1',</span> <span class="pc">0,</span> <span class="w">serve</span><span class="pc">rF</span><span class="c">actory</span><span class="pc">)</span>

        <span class="w">onClientConnectionLost</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="w">serverAddr</span> <span class="c">=</span> <span class="w">s</span><span class="pc">erverP</span><span class="c">ort.</span><span class="w">g</span><span class="c">etHost()</span>
        <span class="w">clientCreator</span> <span class="c">=</span> <span class="w">p</span><span class="c">rotocol.</span><span class="w">ClientCreator</span><span class="c">(</span>
            <span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">l</span><span class="c">ambda:</span> <span class="w">HandleSavingProtocol</span><span class="pc">(</span><span class="w">o</span><span class="c">nClientConnectionLost</span><span class="pc">))</span>
        <span class="w">clientDeferred</span> <span class="c">=</span> <span class="c">self.</span><span class="w">connectClient</span><span class="c">(</span>
            <span class="pc">serverA</span><span class="c">ddr</span><span class="pc">.</span><span class="w">h</span><span class="c">ost,</span> <span class="w">s</span><span class="pc">er</span><span class="c">verAddr</span><span class="pc">.p</span><span class="c">ort,</span> <span class="pc">clientC</span><span class="c">reator)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">clientConnected</span><span class="c">(</span><span class="w">cl</span><span class="pc">ient</span><span class="c">):</span>
            
            <span class="w">c</span><span class="pc">lient.</span><span class="c">transport.</span><span class="pc">w</span><span class="c">rite(</span>
                <span class="c">b'</span><span class="w">s</span><span class="pc">o</span><span class="c">me</span> <span class="w">b</span><span class="c">ytes</span> <span class="w">t</span><span class="pc">o</span> <span class="w">make</span> <span class="w">sure</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">co</span><span class="pc">nnecti</span><span class="c">on</span> <span class="w">i</span><span class="c">s</span> <span class="w">se</span><span class="pc">t</span> <span class="w">up</span><span class="pc">'</span><span class="c">)</span>
            <span class="w">c</span><span class="pc">lient</span><span class="c">.transport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="pc">e</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults([</span>
                <span class="w">onClientConnectionLost</span><span class="c">,</span> <span class="w">onServerConnectionLost</span><span class="pc">]</span><span class="c">)</span>
        <span class="w">clientDeferred</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">clientConnected</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">clientDisconnected</span><span class="c">(</span><span class="w">r</span><span class="pc">esu</span><span class="c">lt):</span>
            
            <span class="w">c</span><span class="pc">lient,</span> <span class="pc">s</span><span class="c">erver</span> <span class="c">=</span> <span class="w">res</span><span class="pc">u</span><span class="c">lt</span>
            <span class="w">i</span><span class="c">f</span> <span class="c">not</span> <span class="w">cl</span><span class="pc">ient.</span><span class="w">lostConnectionReason</span><span class="pc">.</span><span class="w">c</span><span class="pc">h</span><span class="c">eck(error.</span><span class="w">ConnectionClosed)</span><span class="pc">:</span>
                <span class="w">er</span><span class="pc">r(</span><span class="w">c</span><span class="pc">lient</span><span class="c">.</span><span class="pc">l</span><span class="c">ostConnectionReason</span><span class="pc">,</span>
                    <span class="w">"Client</span> <span class="w">lost</span> <span class="w">co</span><span class="c">nnection</span> <span class="w">fo</span><span class="pc">r</span> <span class="w">unexpected</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span><span class="pc">"</span><span class="c">)</span>
            <span class="pc">i</span><span class="c">f</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">se</span><span class="pc">r</span><span class="c">ver.</span><span class="pc">l</span><span class="c">ostConnectionReason</span><span class="w">.c</span><span class="pc">h</span><span class="c">eck(error.</span><span class="w">C</span><span class="c">onnectionClosed</span><span class="w">)</span><span class="pc">:</span>
                <span class="w">er</span><span class="pc">r(</span><span class="w">s</span><span class="pc">er</span><span class="c">ver.</span><span class="w">l</span><span class="pc">ostC</span><span class="c">onnectionReason</span><span class="pc">,</span>
                    <span class="w">"S</span><span class="c">erver</span> <span class="c">lost</span> <span class="w">c</span><span class="pc">o</span><span class="c">nnection</span> <span class="w">fo</span><span class="c">r</span> <span class="w">u</span><span class="c">nexpected</span> <span class="w">r</span><span class="pc">ea</span><span class="c">son")</span>
            <span class="w">expectedErrorCode</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">getHandleErrorCode</span><span class="pc">()</span>
            <span class="w">ex</span><span class="pc">cepti</span><span class="c">on</span> <span class="pc">=</span> <span class="c">self.</span><span class="w">a</span><span class="c">ssertRaises(</span>
                <span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="w">getHandleExceptionType</span><span class="pc">(</span><span class="c">),</span> <span class="w">c</span><span class="c">lient.</span><span class="w">ha</span><span class="pc">n</span><span class="c">dle</span><span class="pc">.</span><span class="w">se</span><span class="pc">n</span><span class="c">d</span><span class="pc">,</span> <span class="w">b</span><span class="pc">'</span><span class="w">b</span><span class="pc">y</span><span class="c">tes')</span>
            <span class="c">self.assertEqual(</span><span class="w">ex</span><span class="pc">ce</span><span class="c">ption.</span><span class="w">a</span><span class="c">rgs</span><span class="pc">[</span><span class="c">0</span><span class="pc">],</span> <span class="pc">e</span><span class="c">xpectedErrorCode)</span>
        <span class="w">clientDeferred</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">clientDisconnected</span><span class="c">)</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">cleanup</span><span class="c">(</span><span class="w">passthrough</span><span class="c">):</span>
            
            <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span> <span class="c">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">m</span><span class="c">aybeDeferred(</span><span class="w">serverPort</span><span class="pc">.</span><span class="w">st</span><span class="pc">opL</span><span class="c">istening</span><span class="pc">)</span>
            <span class="pc">r</span><span class="c">esult.addCallback(lambda</span> <span class="pc">ign</span><span class="c">:</span> <span class="w">p</span><span class="c">assthrough</span><span class="w">)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">esult</span>
        <span class="w">c</span><span class="pc">li</span><span class="c">entDeferred</span><span class="pc">.</span><span class="w">a</span><span class="pc">ddB</span><span class="c">oth(</span><span class="pc">c</span><span class="c">leanup)</span>

        <span class="c">return</span> <span class="w">c</span><span class="pc">lientDe</span><span class="c">ferred</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">ProperlyCloseFilesTests</span><span class="c">(unittest.TestCase</span><span class="pc">,</span> <span class="w">ProperlyCloseFilesMixin</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="w">createServer</span><span class="c">(self</span><span class="pc">,</span> <span class="w">a</span><span class="pc">d</span><span class="c">dress</span><span class="pc">,</span> <span class="w">portNumber</span><span class="pc">,</span> <span class="w">f</span><span class="c">actory):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">l</span><span class="c">istenTCP(</span><span class="pc">p</span><span class="c">ortNumber,</span> <span class="w">f</span><span class="c">actory,</span> <span class="c">interface</span><span class="pc">=a</span><span class="c">ddress</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">connectClient</span><span class="c">(self,</span> <span class="pc">a</span><span class="c">ddress</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ortN</span><span class="c">umber,</span> <span class="w">clientCreator</span><span class="c">):</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="pc">lientC</span><span class="c">reator</span><span class="pc">.</span><span class="w">c</span><span class="pc">onnectT</span><span class="c">CP</span><span class="pc">(a</span><span class="c">ddress</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ortN</span><span class="c">umber</span><span class="pc">)</span>


    <span class="c">def</span> <span class="w">getHandleExceptionType</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="pc">ret</span><span class="c">urn</span> <span class="w">so</span><span class="c">cket.</span><span class="w">e</span><span class="pc">rro</span><span class="c">r</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">WiredForDeferreds</span><span class="c">(</span><span class="w">policies</span><span class="pc">.</span><span class="w">ProtocolWrapper</span><span class="c">):</span>
    <span class="c">def</span> <span class="c">__init__(self,</span> <span class="w">f</span><span class="c">actory,</span> <span class="w">wrappedProtocol</span><span class="pc">)</span><span class="c">:</span>
        <span class="w">p</span><span class="pc">o</span><span class="c">licies.</span><span class="w">P</span><span class="c">rotocolWrapper</span><span class="pc">.</span><span class="c">__init__(self,</span> <span class="w">f</span><span class="pc">a</span><span class="c">ctory,</span> <span class="w">w</span><span class="c">rappedProtocol</span><span class="pc">)</span>

    <span class="c">def</span> <span class="w">c</span><span class="c">onnectionMade(self):</span>
        <span class="w">p</span><span class="c">olicies</span><span class="pc">.P</span><span class="c">rotocolWrapper</span><span class="pc">.</span><span class="w">c</span><span class="pc">onnectionM</span><span class="c">ade(self)</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">onConnect</span><span class="pc">.c</span><span class="c">allback(</span><span class="pc">N</span><span class="c">one)</span>

    <span class="c">def</span> <span class="c">connectionLost(self,</span> <span class="c">reason):</span>
        <span class="w">p</span><span class="pc">o</span><span class="c">licies.</span><span class="w">P</span><span class="c">rotocolWrapper.</span><span class="pc">c</span><span class="c">onnectionLost(self</span><span class="pc">,</span> <span class="c">reason)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">actory.</span><span class="w">onDisconnect</span><span class="pc">.c</span><span class="c">allback(None)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">WiredFactory</span><span class="c">(</span><span class="w">p</span><span class="pc">o</span><span class="c">licies</span><span class="pc">.</span><span class="w">WrappingFactory</span><span class="c">):</span>
    <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="c">=</span> <span class="w">WiredForDeferreds</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="c">__init__(self,</span> <span class="w">wrappedFactory</span><span class="c">):</span>
        <span class="w">po</span><span class="pc">l</span><span class="c">icies.</span><span class="w">W</span><span class="c">rappingFactory.__init__(self</span><span class="pc">,</span> <span class="pc">w</span><span class="c">rappedFactory)</span>
        <span class="c">self.</span><span class="w">onConnect</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">onDisconnect</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">AddressTests</span><span class="c">(unittest.TestCase):</span>
    
    <span class="c">def</span> <span class="c">setUp(self):</span>
        
        <span class="pc">c</span><span class="c">lass</span> <span class="w">RememberingWrapper</span><span class="c">(</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">C</span><span class="c">lientFactory):</span>
            
            <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self</span><span class="pc">,</span> <span class="w">f</span><span class="pc">ac</span><span class="c">tory):</span>
                <span class="c">self.</span><span class="w">addresses</span> <span class="pc">= </span><span class="c">[]</span>
                <span class="pc">s</span><span class="c">elf.</span><span class="pc">f</span><span class="c">actory</span> <span class="c">=</span> <span class="w">f</span><span class="c">actory</span>

            
            
            
            <span class="pc">d</span><span class="c">ef</span> <span class="c">buildProtocol(self,</span> <span class="pc">a</span><span class="c">ddr):</span>
                
                <span class="c">self.</span><span class="w">a</span><span class="c">ddresses.append(</span><span class="pc">a</span><span class="c">ddr)</span>
                <span class="pc">r</span><span class="c">eturn</span> <span class="c">self.</span><span class="pc">f</span><span class="c">actory.buildProtocol(</span><span class="pc">a</span><span class="c">ddr)</span>

        
        
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">se</span><span class="pc">r</span><span class="c">ver</span> <span class="pc">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">serverConnMade</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">s</span><span class="pc">erver</span><span class="c">.</span><span class="w">protocolConnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">serverConnLost</span> <span class="c">=</span> <span class="c">self.</span><span class="w">se</span><span class="pc">rver</span><span class="c">.</span><span class="w">protocolConnectionLost</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        
        
        <span class="c">self.</span><span class="w">serverWrapper</span> <span class="c">=</span> <span class="w">RememberingWrapper</span><span class="c">(self.</span><span class="w">se</span><span class="pc">rver)</span>

        
        <span class="c">self.</span><span class="pc">c</span><span class="c">lient</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="pc">()</span>
        <span class="c">self.</span><span class="w">clientConnMade</span> <span class="c">=</span> <span class="c">self.client.</span><span class="w">protocolConnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">clientConnLost</span> <span class="c">=</span> <span class="c">self.client.</span><span class="w">protocolConnectionLost</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">clientWrapper</span> <span class="c">=</span> <span class="w">RememberingWrapper</span><span class="c">(self.client</span><span class="pc">)</span>

        <span class="c">self.</span><span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="c">self.</span><span class="w">serverWrapper</span><span class="pc">,</span> <span class="w">i</span><span class="c">nterface</span><span class="pc">='</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="w">conn</span><span class="pc">ecto</span><span class="c">r</span> <span class="pc">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">(</span>
            <span class="c">self.port.getHost</span><span class="pc">(</span><span class="c">).</span><span class="pc">h</span><span class="c">ost,</span> <span class="pc">s</span><span class="c">elf.port</span><span class="pc">.g</span><span class="c">etHost().port</span><span class="pc">,</span> <span class="c">self.</span><span class="w">clientWrapper</span><span class="pc">)</span>

        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">de</span><span class="c">fer.</span><span class="pc">g</span><span class="c">atherResults([</span><span class="pc">s</span><span class="c">elf.</span><span class="w">serverConnMade</span><span class="pc">,</span> <span class="c">self.</span><span class="w">clientConnMade]</span><span class="c">)</span>


    <span class="c">def</span> <span class="pc">t</span><span class="c">earDown(self):</span>
        
        <span class="c">self.</span><span class="w">conn</span><span class="pc">ecto</span><span class="c">r.</span><span class="w">di</span><span class="pc">sconnect</span><span class="c">()</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span><span class="c">efer.</span><span class="w">g</span><span class="c">atherResults([</span>
            <span class="c">self.</span><span class="w">serverConnLost</span><span class="pc">,</span> <span class="c">self.</span><span class="w">clientConnLost</span><span class="pc">,</span>
            <span class="w">de</span><span class="pc">fer</span><span class="c">.</span><span class="pc">m</span><span class="c">aybeDeferred(self.</span><span class="w">p</span><span class="pc">ort.</span><span class="w">s</span><span class="pc">topL</span><span class="c">istening</span><span class="w">)]</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">test_buildProtocolClient</span><span class="c">(self</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">serverHost</span> <span class="c">=</span> <span class="c">self.</span><span class="w">se</span><span class="pc">rver</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">t</span><span class="pc">r</span><span class="c">ansport.</span><span class="pc">getH</span><span class="c">ost()</span>
        <span class="w">clientPeer</span> <span class="c">=</span> <span class="c">self.</span><span class="pc">client</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">.t</span><span class="c">ransport.</span><span class="w">g</span><span class="pc">etP</span><span class="c">eer()</span>

        <span class="c">self.</span><span class="pc">a</span><span class="c">ssertEqual(</span>
            <span class="c">self.</span><span class="w">clientWrapper</span><span class="c">.</span><span class="w">addresses</span><span class="c">,</span>
            <span class="w">[I</span><span class="c">Pv4Address</span><span class="pc">(</span><span class="c">'</span><span class="pc">T</span><span class="c">CP</span><span class="pc">',</span> <span class="w">s</span><span class="pc">erverH</span><span class="c">ost.</span><span class="w">h</span><span class="c">ost,</span> <span class="w">s</span><span class="pc">er</span><span class="c">verHost.port</span><span class="w">)]</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.assertEqual(</span>
            <span class="c">self.</span><span class="w">c</span><span class="pc">lientW</span><span class="c">rapper.addresses,</span>
            <span class="w">[I</span><span class="c">Pv4Address('</span><span class="w">T</span><span class="c">CP</span><span class="pc">',</span> <span class="w">clientPeer</span><span class="c">.</span><span class="w">h</span><span class="c">ost,</span> <span class="w">c</span><span class="pc">lientP</span><span class="c">eer.port</span><span class="w">)]</span><span class="c">)</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">LargeBufferWriterProtocol</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">P</span><span class="c">rotocol):</span>

    
    

    <span class="c">def</span> <span class="pc">c</span><span class="c">onnectionMade(self):</span>
        
        <span class="c">self.</span><span class="pc">t</span><span class="c">ransport.write</span><span class="pc">(</span><span class="c">b'</span><span class="w">X'*</span><span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">le</span><span class="pc">n</span><span class="w">)</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">d</span><span class="pc">o</span><span class="c">ne</span> <span class="c">=</span> <span class="w">1</span>
        <span class="pc">s</span><span class="c">elf.transport.loseConnection()</span>

<span class="pc">c</span><span class="c">lass</span> <span class="w">LargeBufferReaderProtocol</span><span class="c">(protocol.Protocol):</span>
    <span class="c">def</span> <span class="pc">d</span><span class="c">ataReceived(self,</span> <span class="c">data):</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">actory.</span><span class="w">le</span><span class="pc">n</span> <span class="w">+</span><span class="c">=</span> <span class="w">l</span><span class="pc">e</span><span class="c">n(data)</span>
    <span class="pc">d</span><span class="c">ef</span> <span class="pc">c</span><span class="c">onnectionLost(self,</span> <span class="c">reason):</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">d</span><span class="pc">o</span><span class="c">ne</span> <span class="c">=</span> <span class="w">1</span>

<span class="w">c</span><span class="c">lass</span> <span class="w">LargeBufferReaderClientFactory</span><span class="c">(</span><span class="pc">p</span><span class="c">rotocol.</span><span class="pc">C</span><span class="c">lientFactory):</span>
    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.</span><span class="w">do</span><span class="pc">n</span><span class="c">e</span> <span class="c">=</span> <span class="w">0</span>
        <span class="c">self.</span><span class="w">le</span><span class="pc">n</span> <span class="pc">=</span> <span class="w">0</span>
    <span class="pc">d</span><span class="c">ef</span> <span class="pc">b</span><span class="c">uildProtocol(self</span><span class="pc">,</span> <span class="pc">a</span><span class="c">ddr):</span>
        <span class="w">p</span> <span class="c">=</span> <span class="w">LargeBufferReaderProtocol</span><span class="pc">(</span><span class="c">)</span>
        <span class="w">p</span><span class="pc">.</span><span class="w">f</span><span class="c">actory</span> <span class="c">=</span> <span class="c">self</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">p</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="pc">p</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">FireOnClose</span><span class="c">(</span><span class="w">policies</span><span class="pc">.</span><span class="w">ProtocolWrapper</span><span class="c">):</span>
    
    <span class="c">def</span> <span class="pc">connectionL</span><span class="c">ost(self,</span> <span class="pc">r</span><span class="c">eason):</span>
        <span class="w">p</span><span class="pc">o</span><span class="c">licies.</span><span class="w">P</span><span class="c">rotocolWrapper</span><span class="pc">.c</span><span class="c">onnectionLost(</span><span class="pc">s</span><span class="c">elf</span><span class="pc">,</span> <span class="c">reason)</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">ac</span><span class="c">tory.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">.c</span><span class="c">allback(None)</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">FireOnCloseFactory</span><span class="c">(</span><span class="w">p</span><span class="pc">o</span><span class="c">licies</span><span class="pc">.</span><span class="w">WrappingFactory</span><span class="c">):</span>
    <span class="w">p</span><span class="pc">r</span><span class="c">otocol</span> <span class="pc">=</span> <span class="w">FireOnClose</span>

    <span class="c">def</span> <span class="pc">_</span><span class="c">_init__(self,</span> <span class="w">wrappedFactory</span><span class="c">):</span>
        <span class="w">po</span><span class="pc">l</span><span class="c">icies</span><span class="pc">.</span><span class="w">W</span><span class="c">rappingFactory.__init__(self</span><span class="pc">,</span> <span class="pc">w</span><span class="c">rappedFactory)</span>
        <span class="c">self.</span><span class="w">d</span><span class="c">eferred</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">LargeBufferTests</span><span class="c">(unittest.TestCase):</span>
    

    <span class="w">datalen</span> <span class="c">=</span> <span class="w">6</span><span class="c">0</span><span class="w">*1024*1</span><span class="pc">0</span><span class="c">24</span>
    <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">testWriter</span><span class="c">(self):</span>
        <span class="w">f</span> <span class="c">=</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="w">F</span><span class="c">actory()</span>
        <span class="w">f</span><span class="c">.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="c">=</span> <span class="w">LargeBufferWriterProtocol</span>
        <span class="w">f</span><span class="pc">.</span><span class="w">d</span><span class="pc">o</span><span class="c">ne</span> <span class="c">=</span> <span class="w">0</span>
        <span class="w">f</span><span class="pc">.</span><span class="w">problem</span> <span class="c">=</span> <span class="w">0</span>
        <span class="w">f</span><span class="pc">.</span><span class="w">le</span><span class="pc">n</span> <span class="w">=</span> <span class="c">self.</span><span class="pc">d</span><span class="c">atalen</span>
        <span class="w">wrappedF</span> <span class="c">=</span> <span class="w">FireOnCloseFactory</span><span class="pc">(f)</span>
        <span class="w">p</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">e</span><span class="c">actor.listenTCP(0,</span> <span class="w">w</span><span class="c">rappedF,</span> <span class="w">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p</span><span class="c">.</span><span class="w">s</span><span class="c">topListening</span><span class="pc">)</span>
        <span class="w">n</span> <span class="c">=</span> <span class="pc">p</span><span class="c">.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().p</span><span class="c">ort</span>
        <span class="w">clientF</span> <span class="c">=</span> <span class="w">LargeBufferReaderClientFactory</span><span class="pc">()</span>
        <span class="w">wrappedClientF</span> <span class="c">=</span> <span class="w">FireOnCloseFactory</span><span class="c">(</span><span class="pc">c</span><span class="c">lientF)</span>
        <span class="w">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">("1</span><span class="c">27.0.0.1</span><span class="pc">"</span><span class="c">,</span> <span class="w">n</span><span class="pc">,</span> <span class="pc">w</span><span class="c">rappedClientF</span><span class="pc">)</span>

        <span class="w">d</span> <span class="pc">=</span> <span class="c">defer.</span><span class="w">g</span><span class="c">atherResults</span><span class="pc">([</span><span class="w">wrappedF</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred</span><span class="pc">,</span> <span class="c">wrappedClientF.</span><span class="w">d</span><span class="c">eferred</span><span class="w">]</span><span class="c">)</span>
        <span class="pc">de</span><span class="c">f</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="c">self.</span><span class="pc">f</span><span class="c">ailUnless(</span><span class="w">f</span><span class="c">.</span><span class="w">do</span><span class="pc">n</span><span class="c">e</span><span class="pc">, "</span><span class="w">wri</span><span class="pc">ter</span> <span class="w">didn'</span><span class="c">t</span> <span class="w">fi</span><span class="pc">n</span><span class="c">ish</span><span class="w">,</span> <span class="w">it</span> <span class="w">probably</span> <span class="w">died</span><span class="pc">"</span><span class="c">)</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="pc">f</span><span class="c">ailUnless(</span><span class="w">clientF</span><span class="c">.</span><span class="w">le</span><span class="c">n</span> <span class="w">=</span><span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">datalen</span><span class="pc">,</span>
                            <span class="w">"cli</span><span class="pc">ent</span> <span class="w">d</span><span class="c">idn</span><span class="w">'</span><span class="c">t</span> <span class="w">receive</span> <span class="w">all</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">da</span><span class="pc">ta</span> <span class="w">i</span><span class="pc">t</span> <span class="w">e</span><span class="pc">x</span><span class="c">pected</span> <span class="w">"</span>
                            <span class="w">"(%d</span> <span class="w">!= %d)" % (c</span><span class="c">lientF</span><span class="w">.le</span><span class="pc">n</span><span class="w">,</span> <span class="c">self.</span><span class="w">d</span><span class="pc">a</span><span class="c">talen</span><span class="w">)</span><span class="pc">)</span>
            <span class="c">self.</span><span class="pc">f</span><span class="c">ailUnless(</span><span class="pc">c</span><span class="c">lientF.</span><span class="w">do</span><span class="c">ne</span><span class="pc">,</span>
                            <span class="w">"c</span><span class="c">lient</span> <span class="w">d</span><span class="pc">i</span><span class="c">dn</span><span class="w">'</span><span class="pc">t</span> <span class="w">see</span> <span class="w">co</span><span class="pc">nn</span><span class="c">ection</span> <span class="w">dropped"</span><span class="pc">)</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="c">d.addCallback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eck)</span>


<span class="w">@</span><span class="c">implementer(</span><span class="w">IHalfCloseableProtocol</span><span class="c">)</span>
<span class="pc">c</span><span class="c">lass</span> <span class="w">MyHCProtocol</span><span class="c">(</span><span class="w">AccumulatingProtocol</span><span class="c">):</span>


    <span class="w">readHalfClosed</span> <span class="c">=</span> <span class="c">False</span>
    <span class="w">writeHalfClosed</span> <span class="c">=</span> <span class="pc">F</span><span class="c">alse</span>

    <span class="c">def</span> <span class="w">readConnectionLost</span><span class="c">(self):</span>
        <span class="c">self.</span><span class="w">rea</span><span class="pc">dH</span><span class="c">alfClosed</span> <span class="c">=</span> <span class="c">True</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="pc">s</span><span class="c">elf.</span><span class="pc">w</span><span class="c">riteHalfClosed</span><span class="w">:</span>
            <span class="c">self.</span><span class="w">co</span><span class="pc">nnectionL</span><span class="c">ost</span><span class="pc">(N</span><span class="c">one</span><span class="pc">)</span>

    <span class="c">def</span> <span class="w">writeConnectionLost</span><span class="c">(self):</span>
        <span class="c">self.</span><span class="pc">w</span><span class="c">riteHalfClosed</span> <span class="c">=</span> <span class="c">True</span>
        
        <span class="pc">i</span><span class="c">f</span> <span class="c">self.</span><span class="pc">readH</span><span class="c">alfClosed</span><span class="pc">:</span>
            <span class="c">self.</span><span class="w">co</span><span class="pc">nne</span><span class="c">ctionLost(</span><span class="pc">N</span><span class="c">one</span><span class="pc">)</span>


<span class="w">c</span><span class="c">lass</span> <span class="w">MyHCFactory</span><span class="c">(</span><span class="w">p</span><span class="c">rotocol.</span><span class="pc">S</span><span class="c">erverFactory):</span>

    <span class="w">ca</span><span class="pc">lle</span><span class="c">d</span> <span class="c">=</span> <span class="pc">0</span>
    <span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="c">None</span>

    <span class="c">def</span> <span class="pc">b</span><span class="c">uildProtocol(self</span><span class="pc">,</span> <span class="w">a</span><span class="c">ddr):</span>
        <span class="c">self.</span><span class="w">cal</span><span class="pc">le</span><span class="c">d</span> <span class="pc">+</span><span class="c">=</span> <span class="c">1</span>
        <span class="w">p</span> <span class="c">=</span> <span class="w">MyHCProtocol</span><span class="c">()</span>
        <span class="w">p</span><span class="pc">.</span><span class="w">f</span><span class="c">actory</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">p</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="pc">p</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="pc">p</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">HalfCloseTests</span><span class="c">(unittest.TestCase):</span>
    

    <span class="c">def</span> <span class="c">setUp(self):</span>
        <span class="c">self.</span><span class="w">f</span> <span class="c">=</span> <span class="w">f</span> <span class="w">=</span> <span class="w">MyHCFactory</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">p</span> <span class="c">=</span> <span class="pc">p</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="pc">f,</span> <span class="w">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="w">p</span><span class="c">.</span><span class="w">s</span><span class="c">topListening</span><span class="pc">)</span>
        <span class="pc">d</span> <span class="c">=</span> <span class="w">loopUntil</span><span class="pc">(l</span><span class="c">ambda</span> <span class="c">:</span><span class="w">p</span><span class="c">.</span><span class="w">connecte</span><span class="c">d</span><span class="pc">)</span>

        <span class="c">self.</span><span class="w">cf</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">rotoc</span><span class="c">ol.</span><span class="w">ClientCreator</span><span class="pc">(r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">MyHCProtocol</span><span class="c">)</span>

        <span class="pc">d</span><span class="c">.addCallback(lambda</span> <span class="w">_</span><span class="c">:</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">c</span><span class="pc">f.</span><span class="w">con</span><span class="pc">nectT</span><span class="c">CP</span><span class="pc">(</span><span class="w">p</span><span class="pc">.</span><span class="w">g</span><span class="c">etHost</span><span class="pc">().</span><span class="w">h</span><span class="c">ost,</span>
                                                   <span class="pc">p</span><span class="c">.</span><span class="w">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">))</span>
        <span class="w">d</span><span class="c">.addCallback(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">_setUp</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>

    <span class="c">def</span> <span class="c">_setUp(self</span><span class="pc">,</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient</span><span class="pc">)</span><span class="c">:</span>
        <span class="c">self.client</span> <span class="pc">=</span> <span class="c">client</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">clientProtoConnectionLost</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.client.</span><span class="w">closedDeferred</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">a</span><span class="c">ssertEqual(self.client.</span><span class="w">t</span><span class="c">ransport.</span><span class="w">conne</span><span class="pc">cte</span><span class="c">d</span><span class="pc">,</span> <span class="pc">1</span><span class="c">)</span>
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">loopUntil</span><span class="pc">(l</span><span class="c">ambda:</span> <span class="w">ge</span><span class="pc">ta</span><span class="c">ttr(self.</span><span class="w">f</span><span class="pc">, </span><span class="c">'</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">',</span> <span class="c">None)</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">None</span><span class="w">)</span>

    <span class="pc">d</span><span class="c">ef</span> <span class="w">t</span><span class="c">earDown(self):</span>
        <span class="c">self.assertEqual(self.</span><span class="pc">c</span><span class="c">lient.</span><span class="w">cl</span><span class="pc">o</span><span class="c">sed,</span> <span class="pc">0</span><span class="c">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">c</span><span class="pc">li</span><span class="c">ent.transport.loseConnection()</span>
        <span class="w">d</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="pc">m</span><span class="c">aybeDeferred(self.</span><span class="w">p</span><span class="c">.</span><span class="w">s</span><span class="c">topListening</span><span class="pc">)</span>
        <span class="pc">d</span><span class="c">.addCallback(</span><span class="pc">l</span><span class="c">ambda</span> <span class="pc">ign</span><span class="c">:</span> <span class="c">self.</span><span class="w">clientProtoConnectionLost)</span>
        <span class="c">d</span><span class="pc">.</span><span class="c">addCallback(self.</span><span class="w">_tearDown</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>

    <span class="c">def</span> <span class="c">_tearDown(self,</span> <span class="w">i</span><span class="c">gnored):</span>
        <span class="c">self.assertEqual(</span><span class="pc">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">lient.</span><span class="w">cl</span><span class="pc">o</span><span class="c">sed,</span> <span class="pc">1</span><span class="c">)</span>
        
        
        <span class="pc">s</span><span class="c">elf.assertEqual(self.</span><span class="w">f</span><span class="c">.</span><span class="w">pr</span><span class="pc">otocol</span><span class="c">.</span><span class="w">cl</span><span class="pc">o</span><span class="c">sed</span><span class="pc">,</span> <span class="w">0</span><span class="c">)</span>
        <span class="pc">d</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">_connectionLost</span><span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on):</span>
            <span class="c">self.</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">cl</span><span class="pc">osed</span> <span class="c">=</span> <span class="pc">1</span>
            <span class="w">d</span><span class="pc">.</span><span class="c">callback(None)</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">.</span><span class="w">pr</span><span class="pc">ot</span><span class="c">ocol.</span><span class="w">c</span><span class="pc">onnecti</span><span class="c">onLost</span> <span class="pc">=</span> <span class="w">_</span><span class="c">connectionLost</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">.t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
        <span class="w">d</span><span class="c">.addCallback(</span><span class="pc">l</span><span class="c">ambda</span> <span class="w">x</span><span class="c">:</span><span class="pc">s</span><span class="c">elf.</span><span class="pc">a</span><span class="c">ssertEqual(self.</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">cl</span><span class="pc">osed,</span> <span class="w">1</span><span class="pc">))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span>

    <span class="c">def</span> <span class="w">testCloseWriteCloser</span><span class="c">(self):</span>
        <span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="c">=</span> <span class="c">self.client</span>
        <span class="w">f</span> <span class="c">=</span> <span class="c">self.</span><span class="w">f</span>
        <span class="w">t</span> <span class="c">=</span> <span class="w">c</span><span class="c">lient.</span><span class="pc">t</span><span class="c">ransport</span>

        <span class="w">t</span><span class="pc">.w</span><span class="c">rite</span><span class="pc">(</span><span class="c">b</span><span class="pc">"h</span><span class="c">ello")</span>
        <span class="pc">d</span> <span class="pc">=</span> <span class="w">loopUntil</span><span class="c">(</span><span class="w">l</span><span class="c">ambda</span> <span class="pc">:</span><span class="w">l</span><span class="pc">e</span><span class="c">n(</span><span class="w">t</span><span class="c">.</span><span class="w">_tempDataBuffer) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="w">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">loseWrite</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="w">t</span><span class="pc">.</span><span class="w">loseWriteConnection</span><span class="c">()</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">l</span><span class="pc">oo</span><span class="c">pUntil</span><span class="pc">(</span><span class="w">l</span><span class="pc">a</span><span class="c">mbda</span> <span class="c">:</span><span class="w">t</span><span class="c">.</span><span class="w">_writeDisconnected)</span>
        <span class="c">def</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">c</span><span class="pc">l</span><span class="c">ient.</span><span class="w">c</span><span class="pc">l</span><span class="c">osed</span><span class="pc">,</span> <span class="pc">F</span><span class="c">alse)</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">c</span><span class="c">lient.</span><span class="w">writeHalfClosed</span><span class="c">,</span> <span class="pc">T</span><span class="c">rue)</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">c</span><span class="c">lient.</span><span class="w">readHalfClosed</span><span class="c">,</span> <span class="pc">F</span><span class="c">alse)</span>
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">loopUntil</span><span class="pc">(</span><span class="w">l</span><span class="c">ambda</span> <span class="c">:</span><span class="w">f</span><span class="pc">.</span><span class="w">p</span><span class="c">rotocol.</span><span class="w">r</span><span class="pc">ea</span><span class="c">dHalfClosed</span><span class="w">)</span>
        <span class="c">def</span> <span class="w">w</span><span class="pc">rite</span><span class="c">(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="w">w</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">lient.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">w</span><span class="pc">rite</span>
            <span class="w">w(</span><span class="c">b</span><span class="pc">"</span> <span class="w">w</span><span class="c">orld")</span>
            <span class="w">w(</span><span class="c">b"</span><span class="w">lalala</span> <span class="w">fooled</span> <span class="w">you</span><span class="pc">")</span>
            <span class="c">self.assertEqual(</span><span class="w">0</span><span class="c">,</span> <span class="pc">l</span><span class="c">en(</span><span class="w">c</span><span class="pc">l</span><span class="c">ient.transport.</span><span class="w">_tempDataBuffer)</span><span class="pc">)</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">f</span><span class="c">.</span><span class="w">pr</span><span class="pc">ot</span><span class="c">ocol.</span><span class="w">d</span><span class="pc">ata,</span> <span class="c">b"hello")</span>
            <span class="c">self.assertEqual(</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">cl</span><span class="pc">os</span><span class="c">ed</span><span class="pc">,</span> <span class="w">F</span><span class="c">alse)</span>
            <span class="c">self.assertEqual(</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">readHalfClosed</span><span class="pc">,</span> <span class="pc">T</span><span class="c">rue)</span>
        <span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="c">d</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">loseWrite)</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="pc">h</span><span class="c">eck</span><span class="w">)</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">wr</span><span class="pc">ite</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">testWriteCloseNotification</span><span class="c">(self):</span>
        <span class="w">f</span> <span class="c">=</span> <span class="c">self.</span><span class="w">f</span>
        <span class="w">f</span><span class="c">.</span><span class="w">pr</span><span class="pc">ot</span><span class="c">ocol.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">loseWriteConnection</span><span class="pc">()</span>

        <span class="pc">d</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.</span><span class="w">g</span><span class="c">atherResults([</span>
            <span class="w">loopUntil(l</span><span class="pc">a</span><span class="c">mbda</span> <span class="c">:</span><span class="pc">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">writeHalfClosed)</span><span class="pc">,</span>
            <span class="w">l</span><span class="pc">o</span><span class="c">opUntil</span><span class="pc">(</span><span class="w">l</span><span class="c">ambda</span> <span class="c">:</span><span class="w">s</span><span class="pc">e</span><span class="c">lf.</span><span class="pc">c</span><span class="c">lient.</span><span class="w">readHalfClosed)]</span><span class="c">)</span>
        <span class="w">d</span><span class="c">.addCallback(lambda</span> <span class="w">_</span><span class="c">:</span> <span class="c">self.assertEqual(</span>
            <span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="pc">r</span><span class="c">eadHalfClosed,</span> <span class="w">F</span><span class="c">alse</span><span class="pc">))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">d</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">HalfCloseNoNotificationAndShutdownExceptionTests</span><span class="c">(unittest.TestCase):</span>

    <span class="c">def</span> <span class="c">setUp(self):</span>
        <span class="c">self.</span><span class="w">f</span> <span class="c">=</span> <span class="w">f</span> <span class="w">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">f</span><span class="pc">.</span><span class="w">protocolConnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">p</span> <span class="pc">=</span> <span class="w">p</span> <span class="pc">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="pc">f,</span> <span class="w">i</span><span class="c">nterface</span><span class="pc">="</span><span class="c">127.0.0.1")</span>

        
        <span class="pc">d</span> <span class="c">=</span> <span class="w">pr</span><span class="pc">otocol</span><span class="c">.</span><span class="w">ClientCreator</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">actor</span><span class="pc">,</span> <span class="w">AccumulatingProtocol)</span><span class="pc">.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP(</span>
            <span class="w">p</span><span class="pc">.</span><span class="w">g</span><span class="c">etHost</span><span class="pc">().h</span><span class="c">ost,</span> <span class="w">p</span><span class="c">.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port)</span>
        <span class="pc">d</span><span class="c">.addCallback(self.</span><span class="w">_gotClient</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="c">d</span>

    <span class="c">def</span> <span class="c">_gotClient(self</span><span class="pc">,</span> <span class="w">c</span><span class="c">lient</span><span class="pc">)</span><span class="c">:</span>
        <span class="pc">s</span><span class="c">elf.client</span> <span class="pc">=</span> <span class="c">client</span>
        
        
        
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">sel</span><span class="c">f.</span><span class="w">f</span><span class="c">.</span><span class="w">protocolConnectionMade</span>

    <span class="w">d</span><span class="c">ef</span> <span class="pc">t</span><span class="c">earDown(self):</span>
        <span class="c">self.client.</span><span class="pc">t</span><span class="c">ransport.loseConnection()</span>
        <span class="c">return</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">p</span><span class="c">.</span><span class="w">s</span><span class="c">topListening()</span>

    <span class="c">def</span> <span class="w">testNoNotification</span><span class="c">(self):</span>
        
        <span class="pc">s</span><span class="c">elf.client.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">w</span><span class="c">rite(b</span><span class="pc">"h</span><span class="c">ello")</span>
        <span class="c">self.</span><span class="pc">c</span><span class="c">lient.transport.</span><span class="w">loseWriteConnection</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">rot</span><span class="c">ocol.</span><span class="w">closedDeferred</span> <span class="w">=</span> <span class="w">d</span> <span class="w">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="pc">c</span><span class="c">lient.</span><span class="w">c</span><span class="pc">lo</span><span class="c">sedDeferred</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">2</span> <span class="w">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="pc">d</span><span class="c">.addCallback(</span><span class="pc">l</span><span class="c">ambda</span> <span class="w">x</span><span class="c">:</span>
                      <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">.</span><span class="w">pr</span><span class="pc">otocol</span><span class="c">.</span><span class="w">d</span><span class="pc">ata</span><span class="c">,</span> <span class="pc">b</span><span class="c">'hello</span><span class="pc">'))</span>
        <span class="pc">d</span><span class="c">.addCallback(</span><span class="pc">l</span><span class="c">ambda</span> <span class="pc">x</span><span class="c">:</span> <span class="c">self.assertEqual(self.</span><span class="w">f</span><span class="c">.</span><span class="w">pr</span><span class="pc">otocol</span><span class="c">.</span><span class="w">cl</span><span class="pc">o</span><span class="c">sed,</span> <span class="w">T</span><span class="c">rue</span><span class="pc">))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">de</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults</span><span class="pc">([d</span><span class="c">,</span> <span class="c">d2</span><span class="pc">]</span><span class="c">)</span>

    <span class="c">def</span> <span class="w">testShutdownException</span><span class="c">(self):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">.</span><span class="w">t</span><span class="pc">r</span><span class="c">ansport.</span><span class="pc">l</span><span class="c">oseConnection()</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="pc">c</span><span class="c">lient.transport.</span><span class="w">w</span><span class="c">rite(b</span><span class="pc">"</span><span class="w">X</span><span class="c">")</span>
        <span class="c">self.</span><span class="pc">c</span><span class="c">lient.transport.</span><span class="w">loseWriteConnection</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">f</span><span class="c">.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">closedDeferred</span> <span class="pc">=</span> <span class="w">d</span> <span class="w">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="pc">c</span><span class="c">lient.</span><span class="w">c</span><span class="pc">lo</span><span class="c">sedDeferred</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">2</span> <span class="w">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
        <span class="pc">d</span><span class="c">.addCallback(</span><span class="pc">l</span><span class="c">ambda</span> <span class="w">x</span><span class="c">:</span>
                      <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="pc">s</span><span class="c">elf.</span><span class="w">f</span><span class="c">.</span><span class="w">pr</span><span class="pc">otocol</span><span class="c">.</span><span class="w">cl</span><span class="pc">osed</span><span class="c">,</span> <span class="w">T</span><span class="c">rue</span><span class="pc">))</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">de</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults</span><span class="pc">([d</span><span class="c">,</span> <span class="c">d2</span><span class="pc">]</span><span class="c">)</span>


<span class="pc">c</span><span class="c">lass</span> <span class="w">HalfCloseBuggyApplicationTests</span><span class="c">(unittest.TestCase):</span>
    

    <span class="c">def</span> <span class="c">setUp(self):</span>
        
        <span class="c">self.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span> <span class="c">=</span> <span class="w">MyHCFactory</span><span class="c">()</span>
        <span class="c">self.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">.</span><span class="w">protocolConnectionMade</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">po</span><span class="pc">rt</span> <span class="c">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(</span>
            <span class="c">0,</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory</span><span class="pc">,</span> <span class="w">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">"</span><span class="c">127.0.0.1")</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(self.</span><span class="pc">po</span><span class="c">rt</span><span class="pc">.</span><span class="w">s</span><span class="c">topListening)</span>
        <span class="w">a</span><span class="pc">ddr</span> <span class="c">=</span> <span class="c">self.</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.getHost()</span>
        <span class="w">creator</span> <span class="c">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">otocol.</span><span class="w">ClientCreator</span><span class="c">(</span><span class="w">r</span><span class="c">eactor</span><span class="pc">,</span> <span class="w">MyHCProtocol</span><span class="c">)</span>
        <span class="w">clientDeferred</span> <span class="c">=</span> <span class="pc">c</span><span class="c">reator.</span><span class="w">co</span><span class="pc">nnectT</span><span class="c">CP</span><span class="pc">(</span><span class="w">a</span><span class="pc">ddr.h</span><span class="c">ost,</span> <span class="w">a</span><span class="pc">ddr.</span><span class="c">port</span><span class="pc">)</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">setClient</span><span class="c">(</span><span class="w">cl</span><span class="pc">ientP</span><span class="c">rotocol):</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">cli</span><span class="pc">entP</span><span class="c">rotocol</span> <span class="pc">=</span> <span class="w">cl</span><span class="pc">ientP</span><span class="c">rotocol</span>
        <span class="w">c</span><span class="pc">li</span><span class="c">entDeferred.</span><span class="w">a</span><span class="pc">d</span><span class="c">dCallback(</span><span class="w">s</span><span class="pc">et</span><span class="c">Client)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">de</span><span class="c">fer.</span><span class="w">g</span><span class="c">atherResults([</span>
            <span class="pc">s</span><span class="c">elf.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">protocolConnectionMade</span><span class="pc">,</span>
            <span class="w">cl</span><span class="pc">ientD</span><span class="c">eferred</span><span class="w">]</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">aBug</span><span class="c">(self</span><span class="pc">, </span><span class="c">*args</span><span class="pc">)</span><span class="c">:</span>
        
        <span class="w">r</span><span class="pc">a</span><span class="c">ise</span> <span class="pc">R</span><span class="c">untimeError("</span><span class="w">ONO</span> <span class="w">I</span> <span class="w">AM</span> <span class="w">BUGGY</span> <span class="w">CODE</span><span class="pc">"</span><span class="c">)</span>


    <span class="c">def</span> <span class="w">_notificationRaisesTest</span><span class="c">(self):</span>
        
        <span class="w">clo</span><span class="pc">s</span><span class="c">ed</span> <span class="c">=</span> <span class="pc">s</span><span class="c">elf.</span><span class="w">cli</span><span class="pc">entP</span><span class="c">rotocol.</span><span class="w">closedDeferred</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="c">self.</span><span class="w">cli</span><span class="pc">entP</span><span class="c">rotocol.</span><span class="pc">t</span><span class="c">ransport</span><span class="pc">.</span><span class="w">loseWriteConnection</span><span class="c">()</span>
        <span class="pc">d</span><span class="c">ef</span> <span class="w">c</span><span class="pc">h</span><span class="c">eck(</span><span class="pc">i</span><span class="c">gnored):</span>
            <span class="w">e</span><span class="c">rrors</span> <span class="c">=</span> <span class="c">self.</span><span class="w">f</span><span class="pc">lushL</span><span class="c">oggedErrors</span><span class="pc">(</span><span class="w">R</span><span class="c">untimeError)</span>
            <span class="c">self.assertEqual(len(</span><span class="pc">e</span><span class="c">rrors),</span> <span class="c">1)</span>
        <span class="w">clo</span><span class="pc">sed.</span><span class="c">addCallback(</span><span class="w">c</span><span class="c">heck)</span>
        <span class="c">return</span> <span class="w">clo</span><span class="pc">s</span><span class="c">ed</span>


    <span class="c">def</span> <span class="w">test_readNotificationRaises</span><span class="c">(self):</span>
        
        <span class="c">self.</span><span class="w">ser</span><span class="pc">verF</span><span class="c">actory.</span><span class="w">p</span><span class="pc">r</span><span class="c">otocol</span><span class="pc">.</span><span class="w">readConnectionLost</span> <span class="w">=</span> <span class="w">s</span><span class="c">elf.</span><span class="w">aBug</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="c">self.</span><span class="w">_notificationRaisesTest</span><span class="pc">()</span>


    <span class="c">def</span> <span class="w">test_writeNotificationRaises</span><span class="c">(self):</span>
        
        <span class="pc">s</span><span class="c">elf.</span><span class="w">cli</span><span class="pc">entP</span><span class="c">rotocol.</span><span class="w">writeConnectionLost</span> <span class="pc">=</span> <span class="c">self.</span><span class="pc">a</span><span class="c">Bug</span>
        <span class="w">r</span><span class="c">eturn</span> <span class="c">self.</span><span class="pc">_</span><span class="c">notificationRaisesTest</span><span class="pc">()</span>



<span class="pc">c</span><span class="c">lass</span> <span class="w">LogTests</span><span class="c">(</span><span class="pc">u</span><span class="c">nittest.TestCase):</span>
    

    <span class="c">def</span> <span class="w">test_logstrClientSetup</span><span class="c">(self):</span>
        
        <span class="w">s</span><span class="pc">er</span><span class="c">ver</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>

        <span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="c">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
        <span class="pc">c</span><span class="c">lient</span><span class="pc">.</span><span class="w">protocolConnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>

        <span class="w">po</span><span class="pc">rt</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="pc">,</span> <span class="c">interface</span><span class="w">=</span><span class="pc">'</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(port</span><span class="pc">.</span><span class="w">s</span><span class="c">topListening)</span>

        <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">(</span>
            <span class="c">port</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().h</span><span class="c">ost</span><span class="pc">,</span> <span class="c">port.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="w">c</span><span class="c">lient</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">d</span><span class="c">dCleanup(</span><span class="w">co</span><span class="pc">nnecto</span><span class="c">r.</span><span class="w">dis</span><span class="pc">connect)</span>

        
        <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">c</span><span class="pc">o</span><span class="c">nnector.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">logstr</span><span class="pc">,</span>
                          <span class="w">"Uninitialized</span><span class="pc">"</span><span class="c">)</span>

        <span class="c">def</span> <span class="w">cb</span><span class="c">(</span><span class="w">i</span><span class="pc">gn</span><span class="c">):</span>
            <span class="c">self.assertEqual(</span><span class="w">co</span><span class="pc">nn</span><span class="c">ector</span><span class="pc">.t</span><span class="c">ransport.</span><span class="w">l</span><span class="pc">og</span><span class="c">str,</span>
                              <span class="pc">"</span><span class="w">AccumulatingProtocol,c</span><span class="pc">l</span><span class="c">ient</span><span class="w">"</span><span class="c">)</span>
        <span class="w">c</span><span class="pc">li</span><span class="c">ent.</span><span class="w">protocolConnectionMade</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">c</span><span class="pc">b</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="pc">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">rotocolC</span><span class="c">onnectionMade</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">PauseProducingTests</span><span class="c">(unittest.TestCase):</span>
    

    <span class="c">def</span> <span class="w">test_pauseProducingInConnectionMade</span><span class="c">(self):</span>
        
        <span class="w">s</span><span class="pc">er</span><span class="c">ver</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>

        <span class="pc">c</span><span class="c">lient</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
        <span class="c">client.</span><span class="w">p</span><span class="c">rotocolConnectionMade</span> <span class="c">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>

        <span class="w">po</span><span class="pc">rt</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="pc">,</span> <span class="c">interface</span><span class="pc">='</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(port</span><span class="pc">.</span><span class="w">s</span><span class="c">topListening)</span>

        <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP</span><span class="pc">(</span>
            <span class="c">port</span><span class="pc">.g</span><span class="c">etHost</span><span class="pc">().h</span><span class="c">ost</span><span class="pc">,</span> <span class="c">port.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="w">c</span><span class="c">lient</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">d</span><span class="c">dCleanup(</span><span class="w">co</span><span class="pc">nnecto</span><span class="c">r.</span><span class="w">dis</span><span class="pc">connect)</span>

        <span class="c">def</span> <span class="w">checkInConnectionMade</span><span class="c">(</span><span class="w">pr</span><span class="pc">oto</span><span class="c">):</span>
            <span class="w">tr</span> <span class="c">=</span> <span class="w">pr</span><span class="pc">oto</span><span class="c">.</span><span class="w">t</span><span class="pc">ra</span><span class="c">nsport</span>
            
            <span class="w">s</span><span class="c">elf.</span><span class="w">assertI</span><span class="pc">n</span><span class="c">(tr</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eac</span><span class="c">tor.</span><span class="w">getReaders() +</span>
                              <span class="pc">r</span><span class="c">eactor.</span><span class="w">getWriters</span><span class="pc">())</span>
            <span class="w">p</span><span class="pc">roto</span><span class="c">.</span><span class="pc">t</span><span class="c">ransport.</span><span class="w">p</span><span class="pc">au</span><span class="c">seProducing()</span>
            <span class="c">self.</span><span class="w">assertN</span><span class="c">otIn(</span><span class="pc">tr</span><span class="c">,</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">g</span><span class="c">etReaders</span><span class="w">() </span><span class="c">+</span>
                                 <span class="w">r</span><span class="c">eactor.</span><span class="pc">g</span><span class="c">etWriters</span><span class="pc">()</span><span class="c">)</span>
            <span class="w">d</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efer.Deferred()</span>
            <span class="pc">d</span><span class="c">.addCallback(</span><span class="w">checkAfterConnectionMade</span><span class="c">)</span>
            <span class="c">reactor.</span><span class="pc">c</span><span class="c">allLater(0,</span> <span class="w">d</span><span class="pc">.c</span><span class="c">allback</span><span class="pc">,</span> <span class="w">pr</span><span class="pc">oto)</span>
            <span class="c">return</span> <span class="c">d</span>
        <span class="c">def</span> <span class="w">c</span><span class="pc">heckA</span><span class="c">fterConnectionMade(</span><span class="w">p</span><span class="pc">r</span><span class="c">oto):</span>
            <span class="w">tr</span> <span class="c">=</span> <span class="w">p</span><span class="pc">roto</span><span class="c">.</span><span class="pc">t</span><span class="c">ransport</span>
            
            <span class="pc">s</span><span class="c">elf.</span><span class="w">assertN</span><span class="c">otIn(</span><span class="pc">t</span><span class="c">r,</span> <span class="w">r</span><span class="pc">eac</span><span class="c">tor</span><span class="pc">.</span><span class="w">getReaders() +</span>
                                 <span class="w">r</span><span class="c">eactor.</span><span class="w">getWriters</span><span class="pc">())</span>
        <span class="w">c</span><span class="pc">li</span><span class="c">ent.</span><span class="w">protocolConnectionMade</span><span class="pc">.a</span><span class="c">ddCallback(</span><span class="w">checkInConnectionMade</span><span class="c">)</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">c</span><span class="c">lient.</span><span class="w">p</span><span class="c">rotocolConnectionMade</span>

    <span class="w">i</span><span class="c">f</span> <span class="w">n</span><span class="c">ot</span> <span class="w">i</span><span class="pc">nt</span><span class="c">erfaces.</span><span class="w">IReactorFDSet</span><span class="pc">.</span><span class="w">p</span><span class="c">rovidedBy(</span><span class="pc">r</span><span class="c">eactor</span><span class="pc">):</span>
        <span class="w">test_pauseProducingInConnectionMade</span><span class="pc">.</span><span class="w">s</span><span class="pc">k</span><span class="c">ip</span> <span class="pc">= </span><span class="c">"</span><span class="w">Reactor</span> <span class="w">n</span><span class="c">ot</span> <span class="w">providing</span> <span class="w">I</span><span class="pc">R</span><span class="c">eactorFDSet</span><span class="pc">"</span>



<span class="w">c</span><span class="c">lass</span> <span class="w">CallBackOrderTests</span><span class="c">(</span><span class="pc">u</span><span class="c">nittest.TestCase):</span>
    

    <span class="c">def</span> <span class="w">test_loseOrder</span><span class="c">(self):</span>
        
        <span class="w">s</span><span class="pc">er</span><span class="c">ver</span> <span class="c">=</span> <span class="w">MyServerFactory</span><span class="c">()</span>
        <span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="pc">.protocolC</span><span class="c">onnectionMade</span> <span class="w">=</span><span class="pc"> (</span><span class="w">d</span><span class="pc">e</span><span class="c">fer.Deferred()</span>
                <span class="w">.</span><span class="pc">a</span><span class="c">ddCallback(</span><span class="pc">l</span><span class="c">ambda</span> <span class="w">prot</span><span class="pc">o</span><span class="c">:</span> <span class="c">self.</span><span class="w">ad</span><span class="c">dCleanup(</span>
                             <span class="w">prot</span><span class="pc">o</span><span class="c">.transport.</span><span class="pc">l</span><span class="c">oseConnection</span><span class="w">))</span><span class="pc">)</span>

        <span class="w">c</span><span class="pc">li</span><span class="c">ent</span> <span class="pc">=</span> <span class="w">MyClientFactory</span><span class="c">()</span>
        <span class="pc">c</span><span class="c">lient.</span><span class="w">protocolConnectionLost</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>
        <span class="pc">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">rotocolC</span><span class="c">onnectionMade</span> <span class="pc">=</span> <span class="w">d</span><span class="c">efer.Deferred()</span>

        <span class="w">d</span><span class="pc">e</span><span class="c">f</span> <span class="w">_cbCM</span><span class="c">(</span><span class="w">res</span><span class="c">):</span>
            
            <span class="w">r</span><span class="pc">ea</span><span class="c">ctor.</span><span class="pc">c</span><span class="c">allLater(0,</span> <span class="w">c</span><span class="c">lient.</span><span class="w">p</span><span class="pc">rotocol</span><span class="c">.</span><span class="pc">t</span><span class="c">ransport.</span><span class="pc">l</span><span class="c">oseConnection</span><span class="pc">)</span>

        <span class="w">c</span><span class="pc">li</span><span class="c">ent</span><span class="pc">.</span><span class="w">p</span><span class="pc">rotocolC</span><span class="c">onnectionMade</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">_</span><span class="c">cbCM)</span>

        <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="pc">=</span> <span class="w">r</span><span class="c">eactor.</span><span class="pc">l</span><span class="c">istenTCP(0,</span> <span class="w">s</span><span class="pc">er</span><span class="c">ver</span><span class="pc">,</span> <span class="w">i</span><span class="c">nterface</span><span class="w">=</span><span class="pc">'</span><span class="c">127.0.0.1</span><span class="pc">')</span>
        <span class="c">self.</span><span class="pc">ad</span><span class="c">dCleanup(</span><span class="pc">p</span><span class="c">ort.</span><span class="w">s</span><span class="c">topListening)</span>

        <span class="w">co</span><span class="pc">nnecto</span><span class="c">r</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eactor.</span><span class="w">c</span><span class="pc">o</span><span class="c">nnectTCP(</span>
            <span class="pc">p</span><span class="c">ort</span><span class="pc">.g</span><span class="c">etHost</span><span class="w">(</span><span class="pc">).h</span><span class="c">ost</span><span class="pc">,</span> <span class="c">port.</span><span class="pc">g</span><span class="c">etHost</span><span class="pc">().</span><span class="c">port</span><span class="pc">,</span> <span class="w">c</span><span class="c">lient</span><span class="pc">)</span>
        <span class="pc">s</span><span class="c">elf.</span><span class="w">a</span><span class="pc">d</span><span class="c">dCleanup(</span><span class="w">co</span><span class="pc">nnecto</span><span class="c">r.</span><span class="w">dis</span><span class="pc">connect)</span>

        <span class="c">def</span> <span class="w">_cbCCL</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">):</span>
            
            <span class="pc">r</span><span class="c">eturn</span> <span class="w">'CCL'</span>

        <span class="pc">d</span><span class="c">ef</span> <span class="w">_cbCL</span><span class="c">(</span><span class="w">res</span><span class="c">):</span>
            
            <span class="pc">r</span><span class="c">eturn</span> <span class="pc">'</span><span class="w">CL</span><span class="pc">'</span>

        <span class="c">def</span> <span class="w">_cbGather</span><span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">):</span>
            <span class="pc">s</span><span class="c">elf.assertEqual(</span><span class="w">r</span><span class="pc">es</span><span class="w">, [</span><span class="pc">'</span><span class="w">C</span><span class="pc">L', </span><span class="c">'</span><span class="w">C</span><span class="c">CL</span><span class="pc">'])</span>

        <span class="pc">d</span> <span class="c">=</span> <span class="c">defer.</span><span class="w">g</span><span class="c">atherResults</span><span class="pc">([</span>
                <span class="w">c</span><span class="c">lient.</span><span class="w">protocolConnectionLost.</span><span class="c">addCallback(</span><span class="pc">_</span><span class="c">cbCL</span><span class="pc">),</span>
                <span class="w">c</span><span class="pc">l</span><span class="c">ient</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">ferred.addCallback(</span><span class="w">_cbCCL)]</span><span class="c">)</span>
        <span class="c">return</span> <span class="c">d</span><span class="pc">.</span><span class="c">addCallback(</span><span class="w">_cbGather</span><span class="c">)</span>



<span class="w">t</span><span class="pc">ry</span><span class="c">:</span>
    <span class="w">i</span><span class="pc">m</span><span class="c">port</span> <span class="w">reso</span><span class="pc">u</span><span class="c">rce</span>
<span class="w">ex</span><span class="pc">ce</span><span class="c">pt</span> <span class="c">ImportError:</span>
    <span class="pc">p</span><span class="c">ass</span>
<span class="pc">e</span><span class="c">lse:</span>
    <span class="w">numRounds</span> <span class="c">=</span> <span class="w">r</span><span class="pc">es</span><span class="c">ource.</span><span class="w">getrlimit</span><span class="c">(</span><span class="w">r</span><span class="pc">eso</span><span class="c">urce.</span><span class="w">RLIMIT_NOFILE)[</span><span class="c">0</span><span class="w">] +</span> <span class="w">10</span>
    <span class="w">ProperlyCloseFilesTests.numberRounds</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">umR</span><span class="c">ounds</span>

</pre>
</body>
</html>

