<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>




<span class="w">#include</span> <span class="w">"ubifs.h"</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/random.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/math64.h&gt;</span>


<span class="w">#define</span> <span class="w">DEFAULT_JNL_PERCENT</span> <span class="w">5</span>


<span class="w">#define</span> <span class="w">DEFAULT_MAX_JNL</span> <span class="pc">(</span><span class="w">3</span><span class="pc">2</span><span class="c">*1024</span><span class="pc">*</span><span class="c">1024)</span>


<span class="c">#define</span> <span class="w">DEFAULT_FANOUT</span> <span class="w">8</span>


<span class="c">#define</span> <span class="w">DEFAULT_JHEADS_CNT</span> <span class="w">1</span>


<span class="c">#define</span> <span class="w">DEFAULT_IDX_LEB</span>  <span class="pc">0</span>
<span class="c">#define</span> <span class="w">DEFAULT_DATA_LEB</span> <span class="pc">1</span>
<span class="c">#define</span> <span class="w">DEFAULT_GC_LEB</span>   <span class="c">2</span>


<span class="c">#define</span> <span class="w">DEFAULT_LSAVE_CNT</span> <span class="w">2</span><span class="pc">5</span><span class="c">6</span>


<span class="c">#define</span> <span class="w">DEFAULT_RP_PERCENT</span> <span class="w">5</span>


<span class="c">#define</span> <span class="w">DEFAULT_MAX_RP_SIZE</span> <span class="w">(5</span><span class="c">*1024</span><span class="pc">*</span><span class="c">1024)</span>


<span class="c">#define</span> <span class="w">DEFAULT_TIME_GRAN</span> <span class="w">1000000000</span>


<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">create_default_filesystem</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_sb_node</span> <span class="c">*</span><span class="w">sup</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ubifs_mst_node</span> <span class="c">*</span><span class="w">mst</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ubifs_idx_node</span> <span class="c">*</span><span class="w">id</span><span class="pc">x</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ubifs_branch</span> <span class="c">*</span><span class="w">br</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ubifs_ino_node</span> <span class="c">*</span><span class="w">ino</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ubifs_cs_node</span> <span class="c">*</span><span class="w">cs</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="w">ubifs_key</span> <span class="w">k</span><span class="c">ey;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">t</span><span class="pc">m</span><span class="c">p</span><span class="pc">,</span> <span class="w">jnl_lebs</span><span class="pc">,</span> <span class="w">log_lebs</span><span class="c">,</span> <span class="w">max_buds</span><span class="c">,</span> <span class="w">main_lebs</span><span class="c">,</span> <span class="w">main_first;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">lpt_lebs</span><span class="pc">,</span> <span class="w">lpt_first</span><span class="pc">,</span> <span class="w">orph_lebs</span><span class="pc">,</span> <span class="w">big_lpt</span><span class="c">,</span> <span class="w">ino_waste</span><span class="c">,</span> <span class="w">sup_flags</span> <span class="w">=</span> <span class="pc">0;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">min_leb_cnt</span> <span class="c">=</span> <span class="w">UBIFS_MIN_LEB_CNT</span><span class="c">;</span>
	<span class="w">l</span><span class="pc">o</span><span class="c">ng</span> <span class="w">l</span><span class="c">ong</span> <span class="w">tmp64</span><span class="pc">,</span> <span class="w">main_bytes</span><span class="c">;</span>
	<span class="w">__l</span><span class="pc">e6</span><span class="c">4</span> <span class="w">tmp_le64</span><span class="c">;</span>

	
	<span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">key_len</span> <span class="c">=</span> <span class="w">UBIFS_SK_LEN</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">leb_cnt</span> <span class="w">&lt;</span> <span class="w">0x7FFFFFFF</span> <span class="w">/</span> <span class="w">DEFAULT_JNL_PERCENT</span><span class="c">)</span>
		
		<span class="w">jnl_lebs</span> <span class="pc">=</span> <span class="w">c</span><span class="c">-&gt;leb_cnt</span> <span class="w">*</span> <span class="pc">D</span><span class="c">EFAULT_JNL_PERCENT</span> <span class="w">/</span> <span class="w">1</span><span class="pc">00</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="pc">j</span><span class="c">nl_lebs</span> <span class="pc">= </span><span class="c">(</span><span class="pc">c</span><span class="c">-&gt;leb_cnt</span> <span class="pc">/</span> <span class="w">10</span><span class="pc">0</span><span class="w">)</span><span class="pc"> *</span> <span class="w">D</span><span class="c">EFAULT_JNL_PERCENT;</span>

	<span class="c">if</span> <span class="c">(jnl_lebs</span> <span class="pc">&lt;</span> <span class="w">UBIFS_MIN_JNL_LEBS</span><span class="c">)</span>
		<span class="pc">j</span><span class="c">nl_lebs</span> <span class="c">=</span> <span class="pc">U</span><span class="c">BIFS_MIN_JNL_LEBS;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(jnl_lebs</span> <span class="w">*</span> <span class="w">c-</span><span class="c">&gt;</span><span class="w">leb_size</span> <span class="pc">&gt;</span> <span class="w">DEFAULT_MAX_JNL</span><span class="c">)</span>
		<span class="c">jnl_lebs</span> <span class="c">=</span> <span class="pc">DEFAULT_M</span><span class="c">AX_JNL</span> <span class="pc">/</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;leb_size;</span>

	
	<span class="w">t</span><span class="c">mp</span> <span class="c">=</span> <span class="w">2</span> <span class="w">*</span><span class="pc"> </span><span class="c">(c-&gt;</span><span class="w">ref_node_alsz</span> <span class="w">*</span> <span class="pc">j</span><span class="c">nl_lebs</span><span class="w">)</span><span class="pc"> +</span> <span class="w">c</span><span class="c">-&gt;</span><span class="pc">leb</span><span class="c">_size</span> <span class="pc">-</span> <span class="c">1;</span>
	<span class="w">log_lebs</span> <span class="pc">=</span> <span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="w">/</span> <span class="w">c</span><span class="c">-&gt;</span><span class="pc">le</span><span class="c">b_size</span><span class="pc">;</span>
	
	<span class="pc">l</span><span class="c">og_lebs</span> <span class="w">+</span><span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">leb_cnt</span> <span class="w">-</span> <span class="w">min_leb_cnt</span> <span class="w">&gt;</span> <span class="w">8</span><span class="c">) {</span>
		
		<span class="w">l</span><span class="pc">o</span><span class="c">g_lebs</span> <span class="w">+</span><span class="c">=</span> <span class="c">1;</span>
		<span class="w">m</span><span class="pc">i</span><span class="c">n_leb_cnt</span> <span class="pc">+</span><span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">max_buds</span> <span class="pc">=</span> <span class="w">jnl_lebs</span> <span class="w">-</span> <span class="pc">l</span><span class="c">og_lebs;</span>
	<span class="c">if</span> <span class="c">(max_buds</span> <span class="w">&lt;</span> <span class="w">UBIFS_MIN_BUD_LEBS</span><span class="c">)</span>
		<span class="c">max_buds</span> <span class="c">=</span> <span class="pc">U</span><span class="c">BIFS_MIN_BUD_LEBS;</span>

	
	<span class="w">orph_lebs</span> <span class="c">=</span> <span class="w">UBIFS_MIN_ORPH_LEBS</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">eb_cnt</span> <span class="w">-</span> <span class="pc">mi</span><span class="c">n_leb_cnt</span> <span class="w">&gt;</span> <span class="pc">1</span><span class="c">)</span>
		
		<span class="pc">o</span><span class="c">rph_lebs</span> <span class="w">+</span><span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="w">main_lebs</span> <span class="c">=</span> <span class="w">c</span><span class="c">-&gt;leb_cnt</span> <span class="pc">-</span> <span class="w">UBIFS_SB_LEBS</span> <span class="pc">-</span> <span class="w">UBIFS_MST_LEBS</span> <span class="pc">-</span> <span class="w">l</span><span class="pc">o</span><span class="c">g_lebs;</span>
	<span class="pc">m</span><span class="c">ain_lebs</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">o</span><span class="c">rph_lebs</span><span class="pc">;</span>

	<span class="w">lpt_first</span> <span class="c">=</span> <span class="w">UBIFS_LOG_LNUM</span> <span class="w">+</span> <span class="w">l</span><span class="pc">o</span><span class="c">g_lebs</span><span class="pc">;</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">lsave_cnt</span> <span class="c">=</span> <span class="w">DEFAULT_LSAVE_CNT</span><span class="c">;</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">max_leb_cnt</span> <span class="c">=</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">le</span><span class="c">b_cnt;</span>
	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ubifs_create_dflt_lpt</span><span class="c">(</span><span class="pc">c, </span><span class="c">&amp;</span><span class="w">m</span><span class="c">ain_lebs</span><span class="pc">,</span> <span class="w">l</span><span class="pc">p</span><span class="c">t_first</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">lpt_lebs</span><span class="pc">,</span>
				    <span class="pc">&amp;</span><span class="w">big_lpt</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">dbg_gen(</span><span class="pc">"</span><span class="w">LEB</span> <span class="w">Properties</span> <span class="w">Tree</span> <span class="w">created</span> <span class="pc">(</span><span class="w">LEBs</span> <span class="w">%</span><span class="c">d</span><span class="w">-</span><span class="pc">%</span><span class="c">d</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span> <span class="pc">lpt_f</span><span class="c">irst,</span>
		<span class="w">l</span><span class="pc">pt_f</span><span class="c">irst</span> <span class="w">+</span> <span class="c">lpt_lebs</span> <span class="w">-</span> <span class="c">1</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">main_first</span> <span class="w">=</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">leb_cnt</span> <span class="pc">-</span> <span class="w">main_lebs</span><span class="c">;</span>

	
	<span class="w">tm</span><span class="pc">p</span> <span class="c">=</span> <span class="w">ALIGN</span><span class="c">(</span><span class="w">UBIFS_SB_NODE_SZ</span><span class="c">,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">min_io_size</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">sup</span> <span class="pc">=</span> <span class="w">k</span><span class="c">zalloc(</span><span class="w">t</span><span class="pc">m</span><span class="c">p,</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">sup</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="w">tmp64</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span> <span class="w">l</span><span class="c">ong</span><span class="pc">)</span><span class="w">max_buds</span> <span class="w">*</span> <span class="w">c-</span><span class="c">&gt;</span><span class="w">leb_size</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">big_lpt</span><span class="pc">)</span>
		<span class="w">sup_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">UBIFS_FLG_BIGLPT</span><span class="c">;</span>

	<span class="pc">s</span><span class="c">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ch</span><span class="c">.</span><span class="w">node_type</span>  <span class="c">=</span> <span class="w">UBIFS_SB_NODE</span><span class="c">;</span>
	<span class="w">s</span><span class="c">up-&gt;</span><span class="w">key_hash</span>      <span class="c">=</span> <span class="w">UBIFS_KEY_HASH_R5</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">up-&gt;</span><span class="pc">f</span><span class="c">lags</span>         <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e32(</span><span class="pc">sup_</span><span class="c">flags);</span>
	<span class="pc">s</span><span class="c">up-&gt;</span><span class="w">min_io_size</span>   <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">c</span><span class="c">-&gt;min_io_size);</span>
	<span class="pc">sup</span><span class="c">-&gt;</span><span class="w">leb_size</span>      <span class="c">=</span> <span class="pc">cpu_to_l</span><span class="c">e32(</span><span class="w">c</span><span class="c">-&gt;leb_size);</span>
	<span class="c">sup-&gt;</span><span class="w">leb_cnt</span>       <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">c</span><span class="c">-&gt;leb_cnt);</span>
	<span class="pc">s</span><span class="c">up-&gt;</span><span class="w">max_leb_cnt</span>   <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">c</span><span class="c">-&gt;max_leb_cnt);</span>
	<span class="c">sup-&gt;</span><span class="w">max_bud_bytes</span> <span class="c">=</span> <span class="w">cpu_to_le64</span><span class="c">(</span><span class="w">tmp64</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">up-&gt;</span><span class="w">log_lebs</span>      <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="pc">lo</span><span class="c">g_lebs);</span>
	<span class="c">sup-&gt;</span><span class="w">lpt_lebs</span>      <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">l</span><span class="pc">p</span><span class="c">t_lebs);</span>
	<span class="c">sup-&gt;</span><span class="w">orph_lebs</span>     <span class="c">=</span> <span class="c">cpu_to_le32(orph_lebs);</span>
	<span class="c">sup-&gt;</span><span class="w">jhead_cnt</span>     <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">DEFAULT_JHEADS_CNT</span><span class="c">);</span>
	<span class="c">sup-&gt;</span><span class="w">fanout</span>        <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">DEFAULT_FANOUT</span><span class="c">);</span>
	<span class="c">sup-&gt;</span><span class="w">lsave_cnt</span>     <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;lsave_cnt);</span>
	<span class="c">sup-&gt;</span><span class="w">fmt_version</span>   <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">UBIFS_FORMAT_VERSION</span><span class="c">);</span>
	<span class="pc">s</span><span class="c">up-&gt;</span><span class="w">time_gran</span>     <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">DEFAULT_TIME_GRAN</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">mount_opts.override_compr</span><span class="pc">)</span>
		<span class="c">sup-&gt;</span><span class="w">default_compr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;mount_opts.</span><span class="w">compr_type</span><span class="c">);</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="pc">s</span><span class="c">up-&gt;default_compr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">UBIFS_COMPR_LZO</span><span class="c">);</span>

	<span class="w">generate_random_uuid</span><span class="c">(sup-&gt;</span><span class="w">uuid</span><span class="c">);</span>

	<span class="w">main_bytes</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">l</span><span class="c">ong</span> <span class="w">l</span><span class="c">ong)</span><span class="w">main_lebs</span> <span class="w">*</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">leb_size</span><span class="pc">;</span>
	<span class="w">tmp64</span> <span class="pc">=</span> <span class="w">div_u64</span><span class="c">(</span><span class="pc">m</span><span class="c">ain_bytes</span> <span class="pc">*</span> <span class="w">DEFAULT_RP_PERCENT</span><span class="c">,</span> <span class="w">1</span><span class="pc">00)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(tmp64</span> <span class="pc">&gt;</span> <span class="w">DEFAULT_MAX_RP_SIZE</span><span class="c">)</span>
		<span class="w">t</span><span class="c">mp64</span> <span class="c">=</span> <span class="w">D</span><span class="pc">EFAULT_M</span><span class="c">AX_RP_SIZE;</span>
	<span class="w">s</span><span class="c">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rp_size</span> <span class="c">=</span> <span class="w">cpu_to_le64</span><span class="pc">(</span><span class="c">tmp64);</span>
	<span class="pc">s</span><span class="c">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ro_compat_version</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e32(</span><span class="w">UBIFS_RO_COMPAT_VERSION</span><span class="c">);</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_write_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="pc">s</span><span class="c">up</span><span class="pc">,</span> <span class="w">UBIFS_SB_NODE_SZ</span><span class="pc">,</span> <span class="c">0,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">k</span><span class="c">free(sup);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">dbg_gen</span><span class="pc">("</span><span class="w">def</span><span class="c">ault</span> <span class="w">superblock</span> <span class="w">created</span> <span class="w">a</span><span class="pc">t</span> <span class="w">LEB</span> <span class="w">0:0</span><span class="pc">"</span><span class="c">);</span>

	
	<span class="w">mst</span> <span class="w">=</span> <span class="w">k</span><span class="c">zalloc(</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mst_node_alsz</span><span class="c">,</span> <span class="pc">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">mst)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="c">mst-&gt;</span><span class="w">ch</span><span class="c">.</span><span class="w">node_type</span> <span class="c">=</span> <span class="w">UBIFS_MST_NODE</span><span class="c">;</span>
	<span class="c">mst-&gt;</span><span class="w">log_lnum</span>     <span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le32(</span><span class="w">UBIFS_LOG_LNUM</span><span class="c">);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">highest_inum</span> <span class="c">=</span> <span class="w">cpu_to_le64</span><span class="pc">(</span><span class="w">UBIFS_FIRST_INO</span><span class="c">);</span>
	<span class="w">m</span><span class="pc">st</span><span class="c">-&gt;</span><span class="w">cmt_no</span>       <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">root_lnum</span>    <span class="c">=</span> <span class="w">c</span><span class="c">pu_to_le32(</span><span class="w">main_first</span> <span class="w">+</span> <span class="w">DEFAULT_IDX_LEB</span><span class="c">);</span>
	<span class="c">mst-&gt;</span><span class="w">root_offs</span>    <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="c">=</span> <span class="w">ubifs_idx_node_sz</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">root_len</span>     <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e32(</span><span class="w">t</span><span class="c">mp);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">gc_lnum</span>      <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="pc">ma</span><span class="c">in_first</span> <span class="pc">+</span> <span class="w">DEFAULT_GC_LEB</span><span class="c">);</span>
	<span class="c">mst-&gt;</span><span class="w">ihead_lnum</span>   <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="pc">ma</span><span class="c">in_first</span> <span class="pc">+</span> <span class="w">DEFAULT_IDX_LEB</span><span class="c">);</span>
	<span class="c">mst-&gt;</span><span class="w">ihead_offs</span>   <span class="c">=</span> <span class="pc">cpu_to_l</span><span class="c">e32(</span><span class="w">ALIGN</span><span class="pc">(</span><span class="w">tm</span><span class="pc">p,</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">min_io_size</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">mst-&gt;</span><span class="w">index_size</span>   <span class="c">=</span> <span class="w">cpu_to_le64</span><span class="pc">(</span><span class="w">A</span><span class="c">LIGN</span><span class="w">(tm</span><span class="pc">p</span><span class="c">,</span> <span class="w">8</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">mst-&gt;</span><span class="w">lpt_lnum</span>     <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">c</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">pt_lnum);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">lpt_offs</span>     <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">c</span><span class="c">-&gt;lpt_offs);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">nhead_lnum</span>   <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(</span><span class="w">c</span><span class="c">-&gt;nhead_lnum);</span>
	<span class="c">mst-&gt;</span><span class="w">nhead_offs</span>   <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">c</span><span class="c">-&gt;nhead_offs);</span>
	<span class="c">mst-&gt;</span><span class="w">ltab_lnum</span>    <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">c</span><span class="c">-&gt;ltab_lnum);</span>
	<span class="c">mst-&gt;</span><span class="w">ltab_offs</span>    <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">c</span><span class="c">-&gt;ltab_offs);</span>
	<span class="c">mst-&gt;</span><span class="w">lsave_lnum</span>   <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">c</span><span class="c">-&gt;lsave_lnum);</span>
	<span class="c">mst-&gt;</span><span class="w">lsave_offs</span>   <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">c</span><span class="c">-&gt;lsave_offs);</span>
	<span class="c">mst-&gt;</span><span class="w">lscan_lnum</span>   <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">main_first</span><span class="c">);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">empty_lebs</span>   <span class="c">=</span> <span class="pc">c</span><span class="c">pu_to_le32(</span><span class="w">main_lebs</span> <span class="w">-</span> <span class="w">2</span><span class="c">);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">idx_lebs</span>     <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="pc">1</span><span class="c">);</span>
	<span class="c">mst-&gt;</span><span class="w">leb_cnt</span>      <span class="c">=</span> <span class="c">cpu_to_le32(</span><span class="w">c</span><span class="c">-&gt;</span><span class="pc">le</span><span class="c">b_cnt);</span>

	
	<span class="w">tmp64</span> <span class="pc">=</span> <span class="w">main_bytes</span><span class="pc">;</span>
	<span class="w">t</span><span class="c">mp64</span> <span class="pc">-=</span> <span class="w">ALIGN</span><span class="pc">(</span><span class="w">ubifs_idx_node_sz</span><span class="pc">(</span><span class="w">c</span><span class="c">,</span> <span class="pc">1</span><span class="w">)</span><span class="pc">,</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">min_io_size</span><span class="c">);</span>
	<span class="w">t</span><span class="c">mp64</span> <span class="w">-</span><span class="pc">=</span> <span class="w">A</span><span class="c">LIGN(</span><span class="w">UBIFS_INO_NODE_SZ</span><span class="c">,</span> <span class="w">c</span><span class="c">-&gt;min_io_size);</span>
	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">total_free</span> <span class="c">=</span> <span class="w">cpu_to_le64</span><span class="c">(</span><span class="w">t</span><span class="pc">m</span><span class="c">p64</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">t</span><span class="c">mp64</span> <span class="pc">=</span> <span class="w">A</span><span class="c">LIGN(</span><span class="pc">u</span><span class="c">bifs_idx_node_sz</span><span class="w">(c</span><span class="c">,</span> <span class="w">1</span><span class="pc">),</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">mi</span><span class="c">n_io_size);</span>
	<span class="w">ino_waste</span> <span class="pc">=</span> <span class="w">A</span><span class="c">LIGN(UBIFS_INO_NODE_SZ,</span> <span class="w">c</span><span class="c">-&gt;min_io_size</span><span class="w">) -</span>
			  <span class="w">U</span><span class="c">BIFS_INO_NODE_SZ</span><span class="pc">;</span>
	<span class="pc">t</span><span class="c">mp64</span> <span class="w">+</span><span class="c">=</span> <span class="c">ino_waste</span><span class="pc">;</span>
	<span class="w">t</span><span class="c">mp64</span> <span class="pc">-=</span> <span class="w">A</span><span class="c">LIGN</span><span class="pc">(</span><span class="c">ubifs_idx_node_sz</span><span class="pc">(</span><span class="w">c</span><span class="c">,</span> <span class="pc">1</span><span class="w">)</span><span class="pc">,</span> <span class="w">8</span><span class="c">);</span>
	<span class="w">mst-</span><span class="pc">&gt;</span><span class="w">total_dirty</span> <span class="c">=</span> <span class="w">cpu_to_le64</span><span class="pc">(</span><span class="w">t</span><span class="pc">m</span><span class="c">p64</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">t</span><span class="c">mp64</span> <span class="w">=</span><span class="pc"> ((</span><span class="w">l</span><span class="c">ong</span> <span class="w">l</span><span class="c">ong</span><span class="w">)</span><span class="pc">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">main_lebs</span> <span class="pc">-</span> <span class="c">1</span><span class="pc">) *</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">dark_wm)</span><span class="c">;</span>
	<span class="w">m</span><span class="c">st</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">total_dark</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e64</span><span class="pc">(t</span><span class="c">mp64</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">m</span><span class="c">st-&gt;</span><span class="w">total_used</span> <span class="c">=</span> <span class="w">c</span><span class="c">pu_to_le64</span><span class="pc">(</span><span class="w">UBIFS_INO_NODE_SZ</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_write_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="c">mst,</span> <span class="w">UBIFS_MST_NODE_SZ</span><span class="c">,</span> <span class="w">UBIFS_MST_LNUM</span><span class="c">,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">k</span><span class="c">free(mst);</span>
		<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="c">}</span>
	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">u</span><span class="c">bifs_write_node(</span><span class="w">c</span><span class="c">,</span> <span class="pc">m</span><span class="c">st,</span> <span class="c">UBIFS_MST_NODE_SZ</span><span class="pc">,</span> <span class="c">UBIFS_MST_LNUM</span> <span class="w">+</span> <span class="c">1</span><span class="pc">,</span>
			       <span class="c">0);</span>
	<span class="w">k</span><span class="c">free(mst);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>

	<span class="w">dbg_gen(</span><span class="pc">"</span><span class="w">def</span><span class="pc">a</span><span class="c">ult</span> <span class="w">mas</span><span class="pc">t</span><span class="c">er</span> <span class="w">no</span><span class="pc">d</span><span class="c">e</span> <span class="w">created</span> <span class="w">a</span><span class="pc">t</span> <span class="w">LEB</span> <span class="pc">%</span><span class="c">d</span><span class="w">:0</span><span class="c">",</span> <span class="pc">U</span><span class="c">BIFS_MST_LNUM);</span>

	
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="c">=</span> <span class="w">ubifs_idx_node_sz</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="w">id</span><span class="c">x</span> <span class="c">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(</span><span class="w">ALIGN</span><span class="pc">(</span><span class="w">t</span><span class="pc">m</span><span class="c">p</span><span class="pc">,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">min_io_size</span><span class="pc">),</span> <span class="w">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">id</span><span class="pc">x)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="w">c</span><span class="c">-&gt;</span><span class="w">key_fmt</span> <span class="c">=</span> <span class="w">UBIFS_SIMPLE_KEY_FMT</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">key_hash</span> <span class="c">=</span> <span class="w">key_r5_hash</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">dx-</span><span class="c">&gt;</span><span class="w">ch</span><span class="pc">.</span><span class="w">node_type</span> <span class="c">=</span> <span class="w">UBIFS_IDX_NODE</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">d</span><span class="c">x</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">child_cnt</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(1);</span>
	<span class="w">ino_key_init</span><span class="pc">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">ey,</span> <span class="w">UBIFS_ROOT_INO</span><span class="c">);</span>
	<span class="w">b</span><span class="pc">r</span> <span class="pc">=</span> <span class="w">ubifs_idx_branch</span><span class="c">(c,</span> <span class="w">i</span><span class="pc">dx,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="w">key_write_idx</span><span class="c">(c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">ey, </span><span class="c">&amp;</span><span class="w">b</span><span class="pc">r</span><span class="c">-&gt;</span><span class="w">k</span><span class="c">ey);</span>
	<span class="w">b</span><span class="pc">r</span><span class="c">-&gt;</span><span class="w">ln</span><span class="c">um</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e32(</span><span class="w">main_first</span> <span class="w">+</span> <span class="w">DEFAULT_DATA_LEB</span><span class="c">);</span>
	<span class="w">b</span><span class="pc">r</span><span class="c">-&gt;</span><span class="w">l</span><span class="c">en</span>  <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(</span><span class="w">UBIFS_INO_NODE_SZ</span><span class="c">);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_write_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">id</span><span class="c">x</span><span class="pc">,</span> <span class="w">tm</span><span class="c">p,</span> <span class="w">m</span><span class="c">ain_first</span> <span class="w">+</span> <span class="w">DEFAULT_IDX_LEB</span><span class="pc">,</span> <span class="c">0);</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">i</span><span class="pc">d</span><span class="c">x);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">dbg_gen(</span><span class="pc">"</span><span class="w">def</span><span class="pc">a</span><span class="c">ult</span> <span class="w">ro</span><span class="c">ot</span> <span class="w">indexing</span> <span class="w">no</span><span class="pc">d</span><span class="c">e</span> <span class="w">created</span> <span class="w">LEB</span> <span class="pc">%</span><span class="c">d</span><span class="w">:0</span><span class="c">",</span>
		<span class="pc">m</span><span class="c">ain_first</span> <span class="w">+</span> <span class="c">DEFAULT_IDX_LEB);</span>

	
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="c">=</span> <span class="w">ALIGN</span><span class="c">(</span><span class="w">UBIFS_INO_NODE_SZ</span><span class="c">,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">min_io_size</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ino</span> <span class="c">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(</span><span class="w">t</span><span class="c">mp,</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">ino</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-ENOMEM;</span>

	<span class="w">ino_key_init_flash</span><span class="pc">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ino</span><span class="c">-&gt;</span><span class="w">k</span><span class="pc">e</span><span class="c">y,</span> <span class="w">UBIFS_ROOT_INO</span><span class="c">);</span>
	<span class="w">ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ch</span><span class="c">.</span><span class="w">node_type</span> <span class="c">=</span> <span class="w">UBIFS_INO_NODE</span><span class="c">;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">creat_sqnum</span> <span class="c">=</span> <span class="w">cpu_to_le64(++c</span><span class="c">-&gt;</span><span class="w">max_sqnum)</span><span class="c">;</span>
	<span class="w">ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nlink</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(</span><span class="w">2</span><span class="c">);</span>
	<span class="w">tmp_le64</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le6</span><span class="c">4</span><span class="pc">(</span><span class="w">CURRENT_TIME_SEC.t</span><span class="pc">v</span><span class="c">_sec</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">atime_sec</span>   <span class="c">=</span> <span class="pc">t</span><span class="c">mp_le64</span><span class="pc">;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">ctime_sec</span>   <span class="c">=</span> <span class="pc">t</span><span class="c">mp_le64;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">mtime_sec</span>   <span class="c">=</span> <span class="pc">t</span><span class="c">mp_le64;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">atime_nsec</span>  <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">ctime_nsec</span>  <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">mtime_nsec</span>  <span class="c">=</span> <span class="c">0;</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">mo</span><span class="c">de</span> <span class="c">=</span> <span class="w">c</span><span class="c">pu_to_le32(</span><span class="w">S_IFDIR</span> <span class="pc">|</span> <span class="w">S</span><span class="pc">_IR</span><span class="c">UGO</span> <span class="c">|</span> <span class="c">S_IWUSR</span> <span class="pc">|</span> <span class="w">S_IXUGO</span><span class="c">);</span>
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="c">=</span> <span class="w">cpu_to_le64</span><span class="c">(</span><span class="w">UBIFS_INO_NODE_SZ</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">ino</span><span class="c">-&gt;</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le3</span><span class="c">2(</span><span class="w">UBIFS_COMPR_FL</span><span class="c">);</span>

	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">ubifs_write_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ino</span><span class="c">,</span> <span class="w">U</span><span class="c">BIFS_INO_NODE_SZ,</span>
			       <span class="w">main_first</span> <span class="w">+</span> <span class="w">DEFAULT_DATA_LEB</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">ino</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="c">rr)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">dbg_gen(</span><span class="pc">"</span><span class="w">ro</span><span class="c">ot</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="w">created</span> <span class="w">a</span><span class="pc">t</span> <span class="w">LEB</span> <span class="c">%d</span><span class="w">:0</span><span class="pc">"</span><span class="c">,</span>
		<span class="pc">m</span><span class="c">ain_first</span> <span class="w">+</span> <span class="c">DEFAULT_DATA_LEB);</span>

	
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="c">=</span> <span class="w">ALIGN</span><span class="c">(</span><span class="w">UBIFS_CS_NODE_SZ</span><span class="c">,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">min_io_size</span><span class="c">);</span>
	<span class="w">cs</span> <span class="pc">=</span> <span class="w">k</span><span class="c">zalloc(</span><span class="w">t</span><span class="c">mp,</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">cs</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">-</span><span class="c">ENOMEM;</span>

	<span class="w">c</span><span class="c">s-&gt;</span><span class="w">ch</span><span class="pc">.</span><span class="w">node_type</span> <span class="c">=</span> <span class="w">UBIFS_CS_NODE</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_write_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">c</span><span class="pc">s,</span> <span class="c">UBIFS_CS_NODE_SZ,</span> <span class="w">UBIFS_LOG_LNUM</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">k</span><span class="c">free(cs</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">ubifs_msg</span><span class="c">(</span><span class="w">c</span><span class="pc">, "</span><span class="w">def</span><span class="pc">a</span><span class="c">ult</span> <span class="w">fi</span><span class="pc">l</span><span class="c">e</span><span class="w">-system</span> <span class="w">created"</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">validate_sb</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span><span class="c">,</span> <span class="c">struct</span> <span class="w">ubifs_sb_node</span> <span class="c">*</span><span class="w">sup</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">l</span><span class="c">ong</span> <span class="w">l</span><span class="c">ong</span> <span class="w">max_bytes</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">1</span><span class="pc">,</span> <span class="w">min_leb_cnt</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">key_hash</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">2</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(sup-&gt;</span><span class="w">key_fmt</span> <span class="pc">!</span><span class="c">=</span> <span class="w">UBIFS_SIMPLE_KEY_FMT</span><span class="c">) {</span>
		<span class="c">err</span> <span class="c">=</span> <span class="w">3</span><span class="c">;</span>
		<span class="c">goto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">le3</span><span class="c">2_to_cpu(</span><span class="pc">s</span><span class="c">up-&gt;</span><span class="w">min_io_size) !</span><span class="c">=</span> <span class="w">c</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">in_io_size) {</span>
		<span class="w">ubifs_err</span><span class="c">(</span><span class="pc">c, "</span><span class="w">mi</span><span class="pc">n</span><span class="w">.</span> <span class="w">I</span><span class="c">/</span><span class="w">O</span> <span class="w">un</span><span class="pc">i</span><span class="c">t</span> <span class="w">mismatch:</span><span class="c"> %d</span> <span class="w">i</span><span class="c">n</span> <span class="w">superblock,</span><span class="pc"> %</span><span class="c">d</span> <span class="w">real"</span><span class="pc">,</span>
			  <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(sup-&gt;min_io_size),</span> <span class="w">c</span><span class="c">-&gt;min_io_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">le3</span><span class="c">2_to_cpu(</span><span class="pc">s</span><span class="c">up-&gt;</span><span class="w">leb_size) </span><span class="pc">!</span><span class="c">=</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;leb_size) {</span>
		<span class="w">ubifs_err</span><span class="c">(</span><span class="pc">c, </span><span class="c">"</span><span class="w">LEB</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">mismatch:</span><span class="c"> %d</span> <span class="w">i</span><span class="c">n</span> <span class="w">superblock,</span><span class="c"> %d</span> <span class="w">real"</span><span class="pc">,</span>
			  <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(sup-&gt;leb_size</span><span class="pc">),</span> <span class="w">c</span><span class="c">-&gt;leb_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">log_lebs</span> <span class="w">&lt;</span> <span class="w">UBIFS_MIN_LOG_LEBS</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="pc">c</span><span class="c">-&gt;</span><span class="w">lpt_lebs</span> <span class="w">&lt;</span> <span class="w">UBIFS_MIN_LPT_LEBS</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="pc">c</span><span class="c">-&gt;</span><span class="w">orph_lebs</span> <span class="w">&lt;</span> <span class="w">UBIFS_MIN_ORPH_LEBS</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="c">c-&gt;</span><span class="w">main_lebs</span> <span class="w">&lt;</span> <span class="w">UBIFS_MIN_MAIN_LEBS</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">4</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	
	<span class="w">min_leb_cnt</span> <span class="c">=</span> <span class="w">UBIFS_SB_LEBS</span> <span class="w">+</span> <span class="w">UBIFS_MST_LEBS</span> <span class="w">+</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">o</span><span class="c">g_lebs;</span>
	<span class="pc">m</span><span class="c">in_leb_cnt</span> <span class="pc">+</span><span class="c">=</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">l</span><span class="pc">p</span><span class="c">t_lebs</span> <span class="c">+</span> <span class="w">c</span><span class="c">-&gt;</span><span class="pc">o</span><span class="c">rph_lebs</span> <span class="c">+</span> <span class="c">c-&gt;</span><span class="w">jhead_cnt</span> <span class="pc">+</span> <span class="w">6</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(c-&gt;</span><span class="w">leb_cnt</span> <span class="w">&lt;</span> <span class="w">m</span><span class="c">in_leb_cnt</span> <span class="w">|</span><span class="c">|</span> <span class="c">c-&gt;leb_cnt</span> <span class="pc">&gt;</span> <span class="c">c-&gt;</span><span class="w">vi.si</span><span class="c">ze</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">ubifs_err</span><span class="c">(c</span><span class="pc">, </span><span class="c">"</span><span class="w">b</span><span class="pc">a</span><span class="c">d</span> <span class="w">LEB</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">:</span><span class="c"> %d</span> <span class="w">i</span><span class="c">n</span> <span class="w">superblock,</span><span class="pc"> </span><span class="c">%d</span> <span class="w">o</span><span class="pc">n</span> <span class="w">UBI</span> <span class="w">volume,</span><span class="pc"> </span><span class="c">%d</span> <span class="w">minimum</span> <span class="w">required</span><span class="pc">"</span><span class="c">,</span>
			  <span class="w">c</span><span class="c">-&gt;leb_cnt</span><span class="pc">,</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="pc">v</span><span class="c">i</span><span class="pc">.</span><span class="w">s</span><span class="pc">i</span><span class="c">ze,</span> <span class="w">min_leb_cnt</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">max_leb_cnt</span> <span class="pc">&lt;</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">l</span><span class="pc">eb</span><span class="c">_cnt</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">ubifs_err</span><span class="c">(c</span><span class="pc">, </span><span class="c">"</span><span class="w">ma</span><span class="pc">x</span><span class="w">.</span> <span class="w">LEB</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="pc">%</span><span class="c">d</span> <span class="w">less</span> <span class="w">than</span> <span class="w">L</span><span class="c">EB</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="c">%d</span><span class="pc">"</span><span class="c">,</span>
			  <span class="w">c</span><span class="c">-&gt;max_leb_cnt,</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">eb_cnt);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(c-&gt;</span><span class="w">main_lebs</span> <span class="w">&lt;</span> <span class="w">UBIFS_MIN_MAIN_LEBS</span><span class="c">) {</span>
		<span class="pc">u</span><span class="c">bifs_err(c</span><span class="pc">, </span><span class="c">"</span><span class="w">to</span><span class="pc">o</span> <span class="w">few</span> <span class="w">main</span> <span class="w">LEBs</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="c">%d</span><span class="pc">,</span> <span class="w">must</span> <span class="w">b</span><span class="pc">e</span> <span class="w">at</span> <span class="w">least</span> <span class="c">%d</span><span class="w">"</span><span class="pc">,</span>
			  <span class="w">c</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">ain_lebs,</span> <span class="c">UBIFS_MIN_MAIN_LEBS</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="w">max_bytes</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">l</span><span class="c">ong</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">leb_size</span> <span class="w">*</span> <span class="w">UBIFS_MIN_BUD_LEBS</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">max_bud_bytes</span> <span class="w">&lt;</span> <span class="w">m</span><span class="pc">ax_by</span><span class="c">tes</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ubifs_err</span><span class="c">(c</span><span class="pc">, </span><span class="c">"</span><span class="w">to</span><span class="pc">o</span> <span class="w">small</span> <span class="w">j</span><span class="pc">o</span><span class="c">urnal</span> <span class="w">(</span><span class="c">%</span><span class="w">ll</span><span class="pc">d</span> <span class="w">b</span><span class="c">ytes</span><span class="w">),</span> <span class="w">must</span> <span class="w">b</span><span class="pc">e</span> <span class="w">a</span><span class="pc">t</span> <span class="w">least</span> <span class="pc">%</span><span class="w">ll</span><span class="pc">d</span> <span class="w">b</span><span class="c">ytes</span><span class="pc">",</span>
			  <span class="w">c</span><span class="c">-&gt;max_bud_bytes,</span> <span class="pc">m</span><span class="c">ax_bytes</span><span class="w">)</span><span class="pc">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="w">ma</span><span class="pc">x_by</span><span class="c">tes</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span> <span class="pc">l</span><span class="c">ong</span><span class="pc">)</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">leb_size</span> <span class="w">*</span> <span class="pc">c-</span><span class="c">&gt;</span><span class="w">main_lebs</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">-&gt;max_bud_bytes</span> <span class="c">&gt;</span> <span class="pc">m</span><span class="c">ax_bytes</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ubifs_err</span><span class="c">(c</span><span class="pc">, </span><span class="c">"</span><span class="w">to</span><span class="pc">o</span> <span class="w">large</span> <span class="w">j</span><span class="pc">o</span><span class="c">urnal</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">ll</span><span class="pc">d</span> <span class="w">b</span><span class="c">ytes</span><span class="w">),</span> <span class="w">on</span><span class="pc">l</span><span class="c">y</span> <span class="c">%</span><span class="w">ll</span><span class="pc">d</span> <span class="w">b</span><span class="c">ytes</span> <span class="w">available</span> <span class="w">i</span><span class="c">n</span> <span class="w">t</span><span class="pc">he</span> <span class="w">main</span> <span class="w">ar</span><span class="pc">ea</span><span class="w">"</span><span class="c">,</span>
			  <span class="w">c</span><span class="c">-&gt;</span><span class="pc">max</span><span class="c">_bud_bytes</span><span class="pc">,</span> <span class="c">max_bytes</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">jhead_cnt</span> <span class="w">&lt;</span> <span class="w">NONDATA_JHEADS_CNT</span> <span class="w">+</span> <span class="c">1</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="pc">c</span><span class="c">-&gt;</span><span class="pc">j</span><span class="c">head_cnt</span> <span class="pc">&gt;</span> <span class="pc">N</span><span class="c">ONDATA_JHEADS_CNT</span> <span class="w">+</span> <span class="w">UBIFS_MAX_JHEADS</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">9</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">fanout</span> <span class="pc">&lt;</span> <span class="w">UBIFS_MIN_FANOUT</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="w">ubifs_idx_node_sz</span><span class="c">(</span><span class="pc">c</span><span class="c">,</span> <span class="pc">c</span><span class="c">-&gt;fanout</span><span class="w">) &gt;</span> <span class="c">c-&gt;</span><span class="w">leb_size</span><span class="c">) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">10</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">lsave_cnt</span> <span class="w">&lt;</span> <span class="c">0</span> <span class="w">|</span><span class="pc">| (</span><span class="c">c-&gt;lsave_cnt</span> <span class="c">&gt;</span> <span class="w">DEFAULT_LSAVE_CNT</span> <span class="w">&amp;</span><span class="c">&amp;</span>
	    <span class="c">c-&gt;lsave_cnt</span> <span class="pc">&gt;</span> <span class="c">c-&gt;</span><span class="w">max_leb_cnt</span> <span class="pc">-</span> <span class="w">UBIFS_SB_LEBS</span> <span class="pc">-</span> <span class="w">UBIFS_MST_LEBS</span> <span class="pc">-</span>
	    <span class="c">c-&gt;</span><span class="w">log_lebs</span> <span class="c">-</span> <span class="c">c-&gt;</span><span class="w">lpt_lebs</span> <span class="c">-</span> <span class="c">c-&gt;</span><span class="w">orph_lebs)</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">11</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">U</span><span class="c">BIFS_SB_LEBS</span> <span class="w">+</span> <span class="pc">U</span><span class="c">BIFS_MST_LEBS</span> <span class="w">+</span> <span class="w">c</span><span class="c">-&gt;log_lebs</span> <span class="w">+</span> <span class="w">c</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">pt_lebs</span> <span class="c">+</span>
	    <span class="w">c</span><span class="c">-&gt;orph_lebs</span> <span class="c">+</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="w">main_lebs</span> <span class="w">!</span><span class="c">=</span> <span class="c">c-&gt;</span><span class="w">leb_cnt</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">12</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">default_compr</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">UBIFS_COMPR_TYPES_CNT</span><span class="c">) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">13</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">rp_size</span> <span class="w">&lt;</span> <span class="c">0</span> <span class="pc">|</span><span class="c">|</span> <span class="w">max_bytes</span> <span class="w">&lt;</span> <span class="w">c</span><span class="c">-&gt;rp_size) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">14</span><span class="c">;</span>
		<span class="c">goto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">le3</span><span class="c">2_to_cpu(</span><span class="w">sup</span><span class="c">-&gt;</span><span class="w">time_gran) </span><span class="pc">&gt;</span> <span class="w">1000000000</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(</span><span class="pc">s</span><span class="c">up-&gt;time_gran</span><span class="w">) </span><span class="pc">&lt;</span> <span class="w">1</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">15</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">fa</span><span class="pc">ile</span><span class="c">d:</span>
	<span class="w">ubifs_err</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">"</span><span class="w">b</span><span class="c">ad</span> <span class="w">superblock,</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">%d</span><span class="pc">"</span><span class="c">,</span> <span class="pc">e</span><span class="c">rr);</span>
	<span class="w">ubifs_dump_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="c">sup</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">return</span> <span class="pc">-</span><span class="c">EINVAL;</span>
<span class="c">}</span>


<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">ubifs_sb_node</span> <span class="pc">*</span><span class="w">ubifs_read_sb_node</span><span class="pc">(</span><span class="c">struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="pc">c)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">ubifs_sb_node</span> <span class="c">*</span><span class="w">su</span><span class="pc">p;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">su</span><span class="pc">p</span> <span class="c">=</span> <span class="pc">km</span><span class="c">alloc(</span><span class="w">ALIGN</span><span class="pc">(</span><span class="w">UBIFS_SB_NODE_SZ</span><span class="pc">,</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">min_io_size</span><span class="pc">),</span> <span class="w">GFP_NOFS</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">sup)</span>
		<span class="c">return</span> <span class="w">E</span><span class="c">RR_PTR(-</span><span class="pc">EN</span><span class="c">OMEM);</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_read_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="c">sup,</span> <span class="w">UBIFS_SB_NODE</span><span class="pc">,</span> <span class="w">U</span><span class="pc">BIFS_SB_NODE_</span><span class="c">SZ</span><span class="pc">,</span>
			      <span class="w">UBIFS_SB_LNUM</span><span class="pc">,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">k</span><span class="c">free(</span><span class="w">s</span><span class="c">up);</span>
		<span class="c">return</span> <span class="w">E</span><span class="c">RR_PTR</span><span class="pc">(</span><span class="c">err);</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">s</span><span class="c">up;</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">ubifs_write_sb_node</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_sb_node</span> <span class="c">*</span><span class="pc">s</span><span class="c">up)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="w">l</span><span class="c">en</span> <span class="pc">=</span> <span class="w">ALIGN</span><span class="c">(</span><span class="w">UBIFS_SB_NODE_SZ</span><span class="c">,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">min_io_size</span><span class="c">);</span>

	<span class="w">ubifs_prepare_node</span><span class="c">(</span><span class="w">c</span><span class="pc">,</span> <span class="w">s</span><span class="c">up,</span> <span class="pc">U</span><span class="c">BIFS_SB_NODE_SZ</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">ubifs_leb_change</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">UBIFS_SB_LNUM</span><span class="c">,</span> <span class="pc">s</span><span class="c">up,</span> <span class="w">l</span><span class="c">en);</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">ubifs_read_superblock</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="pc">c)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">sup_flags</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_sb_node</span> <span class="c">*sup</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">em</span><span class="pc">p</span><span class="c">ty</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">create_default_filesystem</span><span class="c">(c</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(err)</span>
			<span class="c">return</span> <span class="c">err;</span>
	<span class="pc">}</span>

	<span class="w">s</span><span class="pc">up</span> <span class="c">=</span> <span class="w">ubifs_read_sb_node</span><span class="c">(</span><span class="pc">c</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">sup</span><span class="c">))</span>
		<span class="c">return</span> <span class="pc">P</span><span class="c">TR_ERR(sup);</span>

	<span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fmt_version</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(sup-&gt;fmt_version);</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">ro_compat_version</span> <span class="c">=</span> <span class="w">l</span><span class="c">e32_to_cpu(sup-&gt;ro_compat_version);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="pc">f</span><span class="c">mt_version</span> <span class="pc">&gt;</span> <span class="w">UBIFS_FORMAT_VERSION</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ubifs_assert(!</span><span class="pc">c-</span><span class="c">&gt;</span><span class="w">ro_media</span> <span class="w">|</span><span class="c">|</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="w">ro_mount</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">c-&gt;</span><span class="pc">ro_m</span><span class="c">ount</span> <span class="pc">|</span><span class="c">|</span>
		    <span class="c">c-&gt;</span><span class="pc">r</span><span class="c">o_compat_version</span> <span class="pc">&gt;</span> <span class="w">UBIFS_RO_COMPAT_VERSION</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ubifs_err</span><span class="c">(c</span><span class="pc">, </span><span class="c">"</span><span class="w">on-fl</span><span class="pc">as</span><span class="c">h</span> <span class="w">fo</span><span class="pc">rm</span><span class="c">at</span> <span class="w">ve</span><span class="pc">rs</span><span class="c">ion</span> <span class="w">i</span><span class="pc">s</span> <span class="w">w%</span><span class="c">d</span><span class="w">/r</span><span class="c">%d</span><span class="pc">,</span> <span class="w">but</span> <span class="w">software</span> <span class="w">on</span><span class="pc">l</span><span class="c">y</span> <span class="w">supports</span> <span class="w">u</span><span class="pc">p</span> <span class="w">t</span><span class="c">o</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="w">w</span><span class="pc">%</span><span class="c">d</span><span class="w">/r</span><span class="c">%d</span><span class="pc">"</span><span class="c">,</span>
				  <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fmt_version</span><span class="c">,</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">ro_compat_version</span><span class="c">,</span>
				  <span class="w">UBIFS_FORMAT_VERSION</span><span class="pc">,</span>
				  <span class="w">UBIFS_RO_COMPAT_VERSION</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">-&gt;ro_compat_version</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">U</span><span class="pc">BIFS_R</span><span class="c">O_COMPAT_VERSION</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">ubifs_msg</span><span class="c">(c</span><span class="pc">, </span><span class="c">"</span><span class="w">on</span><span class="pc">l</span><span class="c">y</span> <span class="w">R/O</span> <span class="w">mounting</span> <span class="w">i</span><span class="pc">s</span> <span class="w">possible"</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">e</span><span class="pc">rr</span> <span class="c">= -</span><span class="w">EROFS</span><span class="c">;</span>
			<span class="pc">}</span> <span class="c">else</span>
				<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
			<span class="c">goto</span> <span class="c">out;</span>
		<span class="c">}</span>

		
		<span class="w">c</span><span class="c">-&gt;</span><span class="w">rw_incompat</span> <span class="c">=</span> <span class="c">1;</span>
	<span class="pc">}</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">fmt_version</span> <span class="w">&lt;</span> <span class="w">3</span><span class="c">) {</span>
		<span class="w">ubifs_err</span><span class="c">(c</span><span class="pc">, </span><span class="c">"</span><span class="w">on</span><span class="pc">-</span><span class="w">fl</span><span class="pc">as</span><span class="c">h</span> <span class="w">fo</span><span class="pc">rm</span><span class="c">at</span> <span class="w">ve</span><span class="pc">rs</span><span class="c">ion</span> <span class="pc">%</span><span class="c">d</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">supported</span><span class="w">"</span><span class="pc">,</span>
			  <span class="pc">c</span><span class="c">-&gt;fmt_version);</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">= -EINVAL;</span>
		<span class="c">goto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="w">sup</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">key_hash</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">UBIFS_KEY_HASH_R5</span><span class="c">:</span>
		<span class="w">c</span><span class="pc">-</span><span class="c">&gt;key_hash</span> <span class="c">=</span> <span class="w">key_r5_hash</span><span class="c">;</span>
		<span class="w">c</span><span class="c">-&gt;</span><span class="w">key_hash_type</span> <span class="c">=</span> <span class="w">U</span><span class="c">BIFS_KEY_HASH_R5;</span>
		<span class="c">break;</span>

	<span class="c">case</span> <span class="w">UBIFS_KEY_HASH_TEST</span><span class="c">:</span>
		<span class="pc">c</span><span class="c">-&gt;key_hash</span> <span class="c">=</span> <span class="w">key_test_hash</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">-&gt;key_hash_type</span> <span class="c">=</span> <span class="w">U</span><span class="pc">BIFS_KEY_HASH_T</span><span class="c">EST;</span>
		<span class="c">break;</span>
	<span class="w">}</span><span class="pc">;</span>

	<span class="w">c</span><span class="c">-&gt;</span><span class="w">key_fmt</span> <span class="c">=</span> <span class="w">sup</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">k</span><span class="c">ey_fmt;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="pc">c-</span><span class="c">&gt;key_fmt) {</span>
	<span class="c">case</span> <span class="w">UBIFS_SIMPLE_KEY_FMT</span><span class="c">:</span>
		<span class="pc">c</span><span class="c">-&gt;</span><span class="w">key_len</span> <span class="c">=</span> <span class="w">UBIFS_SK_LEN</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">ubifs_err</span><span class="c">(c</span><span class="pc">, "</span><span class="w">unsupported</span> <span class="w">k</span><span class="pc">ey</span> <span class="w">fo</span><span class="pc">rm</span><span class="c">at</span><span class="w">"</span><span class="c">);</span>
		<span class="w">e</span><span class="pc">rr</span> <span class="c">= -EINVAL;</span>
		<span class="c">goto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="w">c</span><span class="c">-&gt;</span><span class="w">leb_cnt</span>       <span class="c">=</span> <span class="w">le</span><span class="pc">3</span><span class="c">2_to_cpu(</span><span class="w">sup</span><span class="c">-&gt;leb_cnt);</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">max_leb_cnt</span>   <span class="c">=</span> <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(</span><span class="pc">s</span><span class="c">up-&gt;max_leb_cnt);</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">max_bud_bytes</span> <span class="c">=</span> <span class="w">le64_to_cpu</span><span class="c">(sup-&gt;max_bud_bytes);</span>
	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">log_lebs</span>      <span class="c">=</span> <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(sup-&gt;log_lebs);</span>
	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">lpt_lebs</span>      <span class="c">=</span> <span class="pc">l</span><span class="c">e32_to_cpu(sup-&gt;lpt_lebs);</span>
	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">orph_lebs</span>     <span class="c">=</span> <span class="pc">l</span><span class="c">e32_to_cpu(sup-&gt;orph_lebs);</span>
	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">jhead_cnt</span>     <span class="c">=</span> <span class="pc">l</span><span class="c">e32_to_cpu(sup-&gt;jhead_cnt</span><span class="w">)</span><span class="pc"> +</span> <span class="w">NONDATA_JHEADS_CNT</span><span class="c">;</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">fanout</span>        <span class="c">=</span> <span class="pc">l</span><span class="c">e32_to_cpu(sup-&gt;fanout);</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">lsave_cnt</span>     <span class="c">=</span> <span class="w">l</span><span class="c">e32_to_cpu(sup-&gt;lsave_cnt);</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">rp_size</span>       <span class="c">=</span> <span class="w">le64_to_cpu</span><span class="c">(sup-&gt;rp_size);</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">rp_uid</span>        <span class="c">=</span> <span class="w">make_kuid</span><span class="pc">(&amp;</span><span class="w">init_user_ns</span><span class="pc">,</span> <span class="w">le</span><span class="pc">3</span><span class="c">2_to_cpu(</span><span class="pc">s</span><span class="c">up-&gt;</span><span class="pc">rp_u</span><span class="c">id));</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">rp_gid</span>        <span class="c">=</span> <span class="w">make_kgid</span><span class="pc">(&amp;</span><span class="w">i</span><span class="c">nit_user_ns</span><span class="pc">,</span> <span class="w">le</span><span class="pc">3</span><span class="c">2_to_cpu(sup-&gt;</span><span class="pc">r</span><span class="c">p_gid));</span>
	<span class="w">sup_flags</span>        <span class="pc">=</span> <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(sup-&gt;</span><span class="w">f</span><span class="c">lags);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mount_opts.override_compr</span><span class="pc">)</span>
		<span class="w">c</span><span class="c">-&gt;</span><span class="w">default_compr</span> <span class="c">=</span> <span class="w">l</span><span class="c">e16_to_cpu(sup-&gt;</span><span class="pc">d</span><span class="c">efault_compr);</span>

	<span class="w">c</span><span class="c">-&gt;</span><span class="w">vfs_sb-</span><span class="c">&gt;</span><span class="w">s_time_gran</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(sup-&gt;</span><span class="w">time_gran</span><span class="c">);</span>
	<span class="w">m</span><span class="c">emcpy</span><span class="pc">(&amp;</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">uuid</span><span class="pc">, </span><span class="c">&amp;sup-&gt;</span><span class="pc">u</span><span class="c">uid</span><span class="pc">,</span> <span class="w">1</span><span class="pc">6</span><span class="c">);</span>
	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">big_lpt</span> <span class="w">= !!(sup_flags</span> <span class="w">&amp;</span> <span class="w">UBIFS_FLG_BIGLPT</span><span class="c">);</span>
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">space_fixup</span> <span class="w">= !</span><span class="c">!(sup_flags</span> <span class="w">&amp;</span> <span class="w">UBIFS_FLG_SPACE_FIXUP</span><span class="c">);</span>

	
	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">old_leb_cnt</span> <span class="c">=</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">leb_cnt</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(c-&gt;</span><span class="pc">l</span><span class="c">eb_cnt</span> <span class="pc">&lt;</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="w">vi.si</span><span class="pc">z</span><span class="c">e</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="c">c-&gt;</span><span class="w">l</span><span class="pc">eb</span><span class="c">_cnt</span> <span class="w">&lt;</span> <span class="c">c-&gt;</span><span class="w">max_leb_cnt</span><span class="c">) {</span>
		<span class="c">c-&gt;</span><span class="pc">l</span><span class="c">eb_cnt</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">i</span><span class="c">n_t(</span><span class="w">i</span><span class="c">nt,</span> <span class="c">c-&gt;</span><span class="pc">m</span><span class="c">ax_leb_cnt,</span> <span class="c">c-&gt;</span><span class="pc">v</span><span class="c">i</span><span class="w">.si</span><span class="c">ze);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(c-&gt;</span><span class="w">ro_mount</span><span class="c">)</span>
			<span class="w">dbg_mnt</span><span class="pc">("</span><span class="w">Auto</span> <span class="w">resizing</span> <span class="w">(ro)</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="pc">%</span><span class="c">d</span> <span class="w">LEBs</span> <span class="w">t</span><span class="c">o</span> <span class="c">%d</span> <span class="w">L</span><span class="c">EBs</span><span class="w">"</span><span class="pc">,</span>
				<span class="pc">c</span><span class="c">-&gt;</span><span class="w">old_leb_cnt</span><span class="c">,</span>	<span class="pc">c</span><span class="c">-&gt;</span><span class="w">leb_cnt</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="c">lse</span> <span class="w">{</span>
			<span class="w">d</span><span class="pc">b</span><span class="c">g_mnt</span><span class="pc">("</span><span class="w">A</span><span class="c">uto</span> <span class="pc">r</span><span class="c">esizing</span> <span class="pc">(</span><span class="w">sb)</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="pc">%d</span> <span class="pc">L</span><span class="c">EBs</span> <span class="w">t</span><span class="pc">o</span> <span class="c">%d</span> <span class="pc">L</span><span class="c">EBs</span><span class="w">"</span><span class="pc">,</span>
				<span class="w">c</span><span class="c">-&gt;</span><span class="pc">o</span><span class="c">ld_leb_cnt</span><span class="pc">,</span> <span class="w">c</span><span class="c">-&gt;leb_cnt</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">sup-</span><span class="c">&gt;</span><span class="w">l</span><span class="c">eb_cnt</span> <span class="c">=</span> <span class="w">cp</span><span class="pc">u_to_l</span><span class="c">e32(</span><span class="pc">c</span><span class="c">-&gt;leb_cnt);</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_write_sb_node</span><span class="c">(c,</span> <span class="c">sup</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(err</span><span class="pc">)</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
			<span class="w">c</span><span class="c">-&gt;</span><span class="pc">o</span><span class="c">ld_leb_cnt</span> <span class="c">=</span> <span class="c">c</span><span class="pc">-</span><span class="c">&gt;leb_cnt</span><span class="pc">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="w">c</span><span class="c">-&gt;</span><span class="w">log_bytes</span> <span class="w">=</span><span class="pc"> (</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span> <span class="w">l</span><span class="c">ong)</span><span class="w">c</span><span class="c">-&gt;</span><span class="w">log_lebs</span> <span class="w">*</span> <span class="c">c-&gt;</span><span class="w">leb_size</span><span class="c">;</span>
	<span class="c">c-&gt;</span><span class="w">log_last</span> <span class="c">=</span> <span class="w">UBIFS_LOG_LNUM</span> <span class="w">+</span> <span class="c">c-&gt;</span><span class="pc">log_le</span><span class="c">bs</span> <span class="w">-</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">c-&gt;</span><span class="w">lpt_first</span> <span class="c">=</span> <span class="pc">U</span><span class="c">BIFS_LOG_LNUM</span> <span class="pc">+</span> <span class="c">c-&gt;</span><span class="w">lo</span><span class="pc">g_le</span><span class="c">bs;</span>
	<span class="c">c-&gt;</span><span class="w">lpt_last</span> <span class="c">=</span> <span class="c">c-&gt;</span><span class="pc">lpt_f</span><span class="c">irst</span> <span class="c">+</span> <span class="c">c-&gt;</span><span class="w">lpt_lebs</span> <span class="pc">-</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">c-&gt;</span><span class="w">orph_first</span> <span class="c">=</span> <span class="c">c-&gt;</span><span class="w">l</span><span class="pc">pt_l</span><span class="c">ast</span> <span class="pc">+</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">c-&gt;</span><span class="w">orph_last</span> <span class="c">=</span> <span class="c">c-&gt;</span><span class="pc">o</span><span class="c">rph_first</span> <span class="c">+</span> <span class="c">c-&gt;</span><span class="w">orph_lebs</span> <span class="pc">-</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">c-&gt;</span><span class="w">main_lebs</span> <span class="c">=</span> <span class="c">c-&gt;</span><span class="w">leb_cnt</span> <span class="pc">-</span> <span class="w">UBIFS_SB_LEBS</span> <span class="pc">-</span> <span class="w">UBIFS_MST_LEBS</span><span class="c">;</span>
	<span class="c">c-&gt;</span><span class="w">m</span><span class="c">ain_lebs</span> <span class="w">-</span><span class="pc">=</span> <span class="c">c-&gt;</span><span class="w">log_lebs</span> <span class="pc">+</span> <span class="c">c-&gt;</span><span class="w">lpt_lebs</span> <span class="pc">+</span> <span class="c">c-&gt;</span><span class="pc">o</span><span class="c">rph_lebs</span><span class="pc">;</span>
	<span class="c">c-&gt;</span><span class="w">main_first</span> <span class="c">=</span> <span class="c">c-&gt;</span><span class="pc">l</span><span class="c">eb_cnt</span> <span class="pc">-</span> <span class="c">c-&gt;</span><span class="pc">m</span><span class="c">ain_lebs;</span>

	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">validate_sb</span><span class="c">(c</span><span class="pc">,</span> <span class="w">sup</span><span class="pc">)</span><span class="c">;</span>
<span class="w">o</span><span class="pc">ut</span><span class="c">:</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">s</span><span class="pc">u</span><span class="c">p);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">fixup_leb</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="pc">c</span><span class="c">,</span> <span class="c">int</span> <span class="w">ln</span><span class="c">um,</span> <span class="c">int</span> <span class="pc">l</span><span class="c">en)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="c">err;</span>

	<span class="w">ubifs_assert</span><span class="c">(</span><span class="w">l</span><span class="c">en</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="c">0);</span>
	<span class="pc">u</span><span class="c">bifs_assert(</span><span class="pc">l</span><span class="c">en</span> <span class="w">%</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">min_io_size</span> <span class="w">=</span><span class="c">=</span> <span class="c">0);</span>
	<span class="w">u</span><span class="c">bifs_assert(</span><span class="w">l</span><span class="c">en</span> <span class="w">&lt;</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">leb_size</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">l</span><span class="c">en</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">dbg_mnt</span><span class="pc">("</span><span class="w">unmap</span> <span class="w">em</span><span class="c">pty</span> <span class="w">LEB</span> <span class="w">%</span><span class="c">d</span><span class="pc">"</span><span class="c">,</span> <span class="w">ln</span><span class="c">um);</span>
		<span class="c">return</span> <span class="w">ubifs_leb_unmap</span><span class="pc">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ln</span><span class="c">um);</span>
	<span class="c">}</span>

	<span class="w">d</span><span class="c">bg_mnt</span><span class="pc">("</span><span class="w">fixup</span> <span class="w">L</span><span class="c">EB</span> <span class="pc">%</span><span class="c">d</span><span class="pc">,</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="w">l</span><span class="c">en</span> <span class="c">%d",</span> <span class="w">ln</span><span class="c">um</span><span class="pc">,</span> <span class="c">len</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ubifs_leb_read</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ln</span><span class="c">um,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sbuf</span><span class="pc">,</span> <span class="w">0</span><span class="c">,</span> <span class="c">len</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">ubifs_leb_change</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ln</span><span class="c">um,</span> <span class="pc">c-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">buf</span><span class="pc">,</span> <span class="pc">l</span><span class="c">en</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">fixup_free_space</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="pc">c)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">ln</span><span class="c">um,</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ubifs_lprops</span> <span class="c">*</span><span class="w">lprops</span><span class="pc">;</span>

	<span class="w">ubifs_get_lprops</span><span class="c">(</span><span class="pc">c)</span><span class="c">;</span>

	
	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">ln</span><span class="c">um</span> <span class="c">=</span> <span class="w">UBIFS_MST_LNUM</span><span class="c">;</span> <span class="w">ln</span><span class="c">um</span> <span class="c">&lt;</span> <span class="w">UBIFS_LOG_LNUM</span><span class="c">;</span> <span class="w">ln</span><span class="c">um++) {</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">fixup_leb</span><span class="c">(</span><span class="pc">c</span><span class="c">,</span> <span class="w">ln</span><span class="c">um</span><span class="pc">,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mst_offs</span> <span class="pc">+</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="w">mst_node_alsz</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	
	<span class="w">ln</span><span class="c">um</span> <span class="c">=</span> <span class="w">ubifs_next_log_lnum</span><span class="c">(</span><span class="pc">c</span><span class="c">,</span> <span class="pc">c-</span><span class="c">&gt;</span><span class="w">lhead_lnum</span><span class="c">);</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">ln</span><span class="c">um</span> <span class="pc">!</span><span class="c">=</span> <span class="c">c-&gt;</span><span class="w">ltail_lnum</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">fixup_leb</span><span class="c">(c</span><span class="pc">,</span> <span class="w">ln</span><span class="c">um</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(err)</span>
			<span class="c">goto</span> <span class="pc">o</span><span class="c">ut;</span>
		<span class="w">ln</span><span class="c">um</span> <span class="c">=</span> <span class="w">u</span><span class="c">bifs_next_log_lnum(</span><span class="pc">c</span><span class="c">,</span> <span class="w">ln</span><span class="c">um);</span>
	<span class="pc">}</span>

	
	<span class="pc">er</span><span class="c">r</span> <span class="c">=</span> <span class="pc">f</span><span class="c">ixup_leb(c,</span> <span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">lhead_lnum</span><span class="pc">,</span>
			<span class="w">ALIGN</span><span class="pc">(</span><span class="w">UBIFS_CS_NODE_SZ</span><span class="c">,</span> <span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">min_io_size</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>

	
	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">ln</span><span class="c">um</span> <span class="c">=</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">lpt_first</span><span class="pc">;</span> <span class="w">ln</span><span class="c">um</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="w">lpt_last</span><span class="c">;</span> <span class="w">ln</span><span class="c">um++) {</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">fr</span><span class="pc">ee</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="w">ltab</span><span class="c">[</span><span class="w">ln</span><span class="c">um</span> <span class="pc">-</span> <span class="pc">c-</span><span class="c">&gt;</span><span class="pc">lpt_f</span><span class="c">irst</span><span class="w">]</span><span class="pc">.</span><span class="w">fr</span><span class="pc">e</span><span class="c">e</span><span class="pc">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">fr</span><span class="pc">ee</span> <span class="c">&gt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">fixup_leb</span><span class="c">(c,</span> <span class="w">ln</span><span class="c">um</span><span class="pc">,</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">leb_size</span> <span class="w">-</span> <span class="w">fr</span><span class="pc">ee</span><span class="c">);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">ln</span><span class="c">um</span> <span class="c">=</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">orph_first</span><span class="pc">;</span> <span class="w">ln</span><span class="c">um</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">c</span><span class="c">-&gt;</span><span class="w">orph_last</span><span class="pc">;</span> <span class="w">ln</span><span class="c">um++) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">f</span><span class="c">ixup_leb(c,</span> <span class="w">ln</span><span class="c">um,</span> <span class="pc">0)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(err</span><span class="pc">)</span>
			<span class="c">goto</span> <span class="c">out;</span>
	<span class="pc">}</span>

	
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">ln</span><span class="c">um</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">main_first</span><span class="pc">;</span> <span class="w">ln</span><span class="c">um</span> <span class="pc">&lt;</span> <span class="pc">c</span><span class="c">-&gt;</span><span class="w">leb_cnt</span><span class="c">;</span> <span class="w">ln</span><span class="c">um++) {</span>
		<span class="w">lprops</span> <span class="pc">=</span> <span class="w">ubifs_lpt_lookup</span><span class="c">(c,</span> <span class="w">ln</span><span class="c">um);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(lprops</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">err</span> <span class="pc">=</span> <span class="pc">P</span><span class="c">TR_ERR(lprops);</span>
			<span class="c">goto</span> <span class="c">out;</span>
		<span class="c">}</span>

		<span class="c">if</span> <span class="c">(lprops-&gt;</span><span class="w">fr</span><span class="pc">ee</span> <span class="pc">&gt;</span> <span class="c">0) {</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">fixup_leb</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ln</span><span class="c">um</span><span class="pc">,</span> <span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">leb_size</span> <span class="w">-</span> <span class="pc">l</span><span class="c">props</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fr</span><span class="pc">ee)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(err)</span>
				<span class="c">goto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="w">}</span>

<span class="w">o</span><span class="c">ut:</span>
	<span class="w">ubifs_release_lprops</span><span class="c">(</span><span class="w">c</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">ubifs_fixup_free_space</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*c</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ubifs_sb_node</span> <span class="c">*</span><span class="w">sup</span><span class="pc">;</span>

	<span class="w">ubifs_assert</span><span class="c">(</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">space_fixup</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="c">bifs_assert</span><span class="w">(!</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">ro_mount</span><span class="c">);</span>

	<span class="w">ubifs_msg</span><span class="c">(c</span><span class="w">,</span><span class="pc"> "</span><span class="w">sta</span><span class="pc">r</span><span class="c">t</span> <span class="w">fixing</span> <span class="w">up</span> <span class="w">fr</span><span class="pc">ee</span> <span class="w">sp</span><span class="pc">ace"</span><span class="c">);</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">fixup_free_space</span><span class="c">(c</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="pc">s</span><span class="c">up</span> <span class="pc">=</span> <span class="w">ubifs_read_sb_node</span><span class="c">(</span><span class="pc">c</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(sup))</span>
		<span class="c">return</span> <span class="c">PTR_ERR(sup);</span>

	
	<span class="w">c</span><span class="c">-&gt;</span><span class="w">space_fixup</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">up-&gt;</span><span class="pc">f</span><span class="c">lags</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e32</span><span class="w">(~UBIFS_FLG_SPACE_FIXUP)</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_write_sb_node</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="c">sup</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">k</span><span class="c">free(sup);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">ubifs_msg</span><span class="c">(</span><span class="pc">c, </span><span class="c">"</span><span class="w">fr</span><span class="pc">ee</span> <span class="w">sp</span><span class="pc">ace</span> <span class="w">fixup</span> <span class="w">com</span><span class="pc">p</span><span class="c">lete</span><span class="pc">"</span><span class="c">);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

</pre>
</body>
</html>

