<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#ifdef</span> <span class="w">CONFIG_COMPAT</span>
<span class="w">#include</span> <span class="w">&lt;linux/compat.h&gt;</span>	
<span class="w">#endif</span>
<span class="w">#include</span> <span class="w">&lt;linux/sched.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/signal.h</span><span class="c">&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">e</span><span class="c">rrno.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">w</span><span class="c">ait.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ptrace</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">tracehook</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">unistd</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">m</span><span class="pc">m</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">t</span><span class="pc">t</span><span class="c">y.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">binfmts</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">bitops</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">context_tracking</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="pc">u</span><span class="c">access.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">ptrace</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">pgtable</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">fpumacro</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">uctx</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">siginfo</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">visasm</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">switch_to</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">cacheflush</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">sigutil</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">systbls</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">k</span><span class="c">ernel.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">en</span><span class="pc">t</span><span class="c">ry.h"</span>


<span class="w">as</span><span class="c">mlinkage</span> <span class="w">v</span><span class="c">oid</span> <span class="w">sparc64_set_context</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="w">r</span><span class="pc">egs)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ucontext</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">ucp</span> <span class="pc">= </span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="c">ucontext</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)</span>
		<span class="w">r</span><span class="c">egs-&gt;</span><span class="w">u_regs[UREG_I0</span><span class="c">];</span>
	<span class="w">e</span><span class="pc">n</span><span class="c">um</span> <span class="w">ctx_state</span> <span class="w">prev_state</span> <span class="pc">=</span> <span class="w">exception_enter</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">mc_gregset_t</span> <span class="w">_</span><span class="pc">_us</span><span class="c">er</span> <span class="c">*</span><span class="w">g</span><span class="pc">rp;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">pc</span><span class="pc">,</span> <span class="w">npc</span><span class="pc">,</span> <span class="w">tstate</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">fp</span><span class="pc">,</span> <span class="w">i7</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">fenab</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="c">rr;</span>

	<span class="w">flush_user_windows(</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(</span><span class="w">get_thread_wsaved()					||</span>
	    <span class="w">((</span><span class="pc">(</span><span class="c">unsigned</span> <span class="c">long)</span><span class="w">ucp) &amp;</span><span class="pc"> (</span><span class="w">s</span><span class="c">izeof(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span><span class="w">)-</span><span class="c">1</span><span class="w">))	||</span>
	    <span class="w">(!__access_ok</span><span class="pc">(</span><span class="w">u</span><span class="pc">c</span><span class="c">p</span><span class="pc">,</span> <span class="c">sizeof</span><span class="pc">(*u</span><span class="c">cp</span><span class="w">))))</span>
		<span class="w">go</span><span class="c">to</span> <span class="w">do_sigsegv</span><span class="c">;</span>
	<span class="w">gr</span><span class="pc">p</span>  <span class="pc">= &amp;u</span><span class="c">cp-&gt;</span><span class="w">uc_mcontext</span><span class="pc">.</span><span class="w">mc_gregs</span><span class="pc">;</span>
	<span class="w">er</span><span class="pc">r</span>  <span class="c">=</span> <span class="w">__get_user</span><span class="c">(</span><span class="w">pc, &amp;((*gr</span><span class="pc">p</span><span class="w">)[MC_PC])</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_g</span><span class="c">et_user(</span><span class="w">npc, &amp;</span><span class="pc">(</span><span class="c">(*</span><span class="w">gr</span><span class="pc">p</span><span class="w">)[MC_NPC])</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="w">|| ((pc</span> <span class="w">|</span> <span class="c">npc</span><span class="w">) &amp;</span> <span class="w">3</span><span class="pc">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">do_sigsegv</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">u_regs[UREG_I1</span><span class="pc">])</span><span class="c"> {</span>
		<span class="w">sigset_t</span> <span class="w">se</span><span class="pc">t</span><span class="w">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">_NSIG_WORDS</span> <span class="c">==</span> <span class="pc">1</span><span class="c">) {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">_</span><span class="c">_get_user(</span><span class="w">se</span><span class="pc">t</span><span class="w">.si</span><span class="pc">g[0</span><span class="w">],</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">ucp-</span><span class="c">&gt;</span><span class="w">uc_sigmask.si</span><span class="pc">g</span><span class="c">[0</span><span class="w">]))</span>
				<span class="w">g</span><span class="c">oto</span> <span class="pc">d</span><span class="c">o_sigsegv;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">__copy_from_user</span><span class="pc">(&amp;</span><span class="w">set,</span><span class="pc"> </span><span class="c">&amp;ucp-&gt;uc_sigmask</span><span class="pc">,</span> <span class="w">s</span><span class="c">izeof(</span><span class="w">sigset_t)</span><span class="pc">))</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="pc">d</span><span class="c">o_sigsegv;</span>
		<span class="c">}</span>
		<span class="w">set_current_blocked</span><span class="pc">(&amp;</span><span class="w">set</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">test_thread_flag</span><span class="c">(</span><span class="w">TIF_32BIT</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">pc</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">0xf</span><span class="pc">ffff</span><span class="c">fff;</span>
		<span class="w">npc</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">0</span><span class="pc">xfffff</span><span class="c">fff;</span>
	<span class="c">}</span>
	<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">tpc</span> <span class="c">=</span> <span class="w">pc</span><span class="pc">;</span>
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tnpc</span> <span class="c">=</span> <span class="w">n</span><span class="c">pc;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__get_user</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">y, &amp;((*gr</span><span class="c">p</span><span class="w">)[MC_Y])</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">_</span><span class="c">_get_user(</span><span class="w">tstate, &amp;</span><span class="pc">(</span><span class="c">(*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_TSTATE])</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">s</span><span class="c">tate</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">TSTATE_ASI</span> <span class="c">|</span> <span class="w">TSTATE_ICC</span> <span class="c">|</span> <span class="w">TSTATE_XCC</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="pc">ts</span><span class="c">tate</span> <span class="w">|</span><span class="pc">= </span><span class="c">(tstate</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="pc">T</span><span class="c">STATE_ASI</span> <span class="c">|</span> <span class="pc">T</span><span class="c">STATE_ICC</span> <span class="c">|</span> <span class="pc">T</span><span class="c">STATE_XCC</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">|=</span> <span class="pc">_</span><span class="c">_get_user(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">u_regs[UREG_G1], (&amp;(*g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G1])</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_get_user(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs</span><span class="pc">[</span><span class="w">UREG_G2],</span><span class="pc"> (</span><span class="c">&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G2])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">er</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G3</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G3])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G4</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G4])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G5</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G5])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G6</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G6])</span><span class="pc">)</span><span class="c">;</span>

	

	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I0</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O0])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I1</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O1])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I2</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O2])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I3</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O3])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I4</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O4])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I5</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O5])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I6</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O6])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I7</span><span class="c">], (&amp;(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_O7])</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">__get_user</span><span class="pc">(</span><span class="w">fp, &amp;(ucp-</span><span class="pc">&gt;</span><span class="w">uc_mcontext.mc_fp)</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">er</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">_</span><span class="c">_get_user(</span><span class="w">i7, &amp;</span><span class="pc">(u</span><span class="c">cp</span><span class="w">-</span><span class="c">&gt;uc_mcontext.</span><span class="w">mc_i7)</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user(</span><span class="w">fp</span><span class="pc">,</span>
	      <span class="w">(&amp;(((s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">reg_window</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)(</span><span class="w">STACK_BIAS</span><span class="pc">+</span><span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">u_regs[UREG_I6]))-&gt;ins[6])));</span>
	<span class="w">e</span><span class="c">rr</span> <span class="w">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user(</span><span class="w">i</span><span class="pc">7,</span>
	      <span class="w">(</span><span class="c">&amp;(((</span><span class="w">st</span><span class="pc">r</span><span class="c">uct</span> <span class="pc">r</span><span class="c">eg_window</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)(</span><span class="c">STACK_BIAS</span><span class="pc">+</span><span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">_regs</span><span class="pc">[U</span><span class="c">REG_I6</span><span class="w">])</span><span class="pc">)-</span><span class="c">&gt;ins</span><span class="pc">[</span><span class="w">7])</span><span class="pc">)</span><span class="c">);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="w">|</span><span class="pc">=</span> <span class="w">__get_user</span><span class="pc">(</span><span class="w">fenab, &amp;(ucp-</span><span class="c">&gt;</span><span class="w">uc_mcontext</span><span class="pc">.</span><span class="w">mc_fpregs</span><span class="pc">.</span><span class="w">mcfpu_enab)</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">f</span><span class="c">enab</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">*fpregs</span> <span class="c">=</span> <span class="w">current_thread_info()-&gt;f</span><span class="pc">p</span><span class="c">regs;</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="w">fprs</span><span class="c">;</span>
		
		<span class="w">fprs_write</span><span class="pc">(</span><span class="w">0</span><span class="c">);</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_get_user(</span><span class="pc">fprs</span><span class="w">, &amp;</span><span class="pc">(</span><span class="c">ucp</span><span class="pc">-</span><span class="c">&gt;uc_mcontext</span><span class="pc">.</span><span class="c">mc_fpregs</span><span class="pc">.</span><span class="w">mcfpu_fprs</span><span class="pc">))</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">f</span><span class="pc">prs</span> <span class="w">&amp;</span> <span class="w">FPRS_DL</span><span class="c">)</span>
			<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">cop</span><span class="pc">y_f</span><span class="c">rom_user(</span><span class="pc">fpre</span><span class="c">gs,</span>
					      <span class="w">&amp;(u</span><span class="pc">cp-</span><span class="c">&gt;uc_mcontext.mc_fpregs.</span><span class="w">mcfpu_fregs),</span>
					      <span class="w">(si</span><span class="pc">zeo</span><span class="c">f(</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="w">i</span><span class="c">nt</span><span class="w">)</span><span class="pc"> </span><span class="c">*</span> <span class="w">3</span><span class="pc">2));</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">f</span><span class="c">prs</span> <span class="w">&amp;</span> <span class="w">FPRS_DU</span><span class="c">)</span>
			<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">cop</span><span class="pc">y_f</span><span class="c">rom_user(fpregs</span><span class="w">+1</span><span class="pc">6</span><span class="c">,</span>
			 <span class="w">(</span><span class="pc">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="w">*)&amp;(u</span><span class="pc">c</span><span class="c">p</span><span class="w">-</span><span class="pc">&gt;</span><span class="c">uc_mcontext</span><span class="pc">.</span><span class="c">mc_fpregs.mcfpu_fregs</span><span class="w">))+1</span><span class="pc">6,</span>
			 <span class="pc">(</span><span class="w">si</span><span class="pc">zeo</span><span class="c">f(unsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">)</span><span class="pc"> </span><span class="c">*</span> <span class="w">3</span><span class="c">2</span><span class="w">)</span><span class="pc">);</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">|</span><span class="c">=</span> <span class="w">__get_user</span><span class="c">(</span><span class="w">current_thread_info()-&gt;xfsr[</span><span class="c">0],</span>
				  <span class="w">&amp;(u</span><span class="c">cp</span><span class="w">-</span><span class="c">&gt;uc_mcontext</span><span class="pc">.</span><span class="c">mc_fpregs.</span><span class="w">mcfpu_fsr)</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_get_user(</span><span class="w">c</span><span class="c">urrent_thread_info</span><span class="w">(</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">gsr[</span><span class="pc">0],</span>
				  <span class="w">&amp;</span><span class="c">(</span><span class="w">u</span><span class="c">cp</span><span class="w">-</span><span class="c">&gt;uc_mcontext</span><span class="pc">.</span><span class="c">mc_fpregs</span><span class="pc">.</span><span class="w">mcfpu_gsr)</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">regs</span><span class="c">-&gt;</span><span class="w">tstate</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">TSTATE_PEF</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">do_sigsegv</span><span class="c">;</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
<span class="w">d</span><span class="pc">o</span><span class="c">_sigsegv:</span>
	<span class="w">force_sig</span><span class="c">(</span><span class="w">SIGSEGV</span><span class="pc">,</span> <span class="w">cu</span><span class="c">rrent);</span>
	<span class="w">g</span><span class="c">oto</span> <span class="c">out;</span>
<span class="c">}</span>

<span class="w">as</span><span class="pc">m</span><span class="c">linkage</span> <span class="w">v</span><span class="c">oid</span> <span class="w">sparc64_get_context</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ucontext</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">ucp</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">ucontext</span> <span class="pc">_</span><span class="c">_user</span> <span class="pc">*)</span>
		<span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">u_regs[UREG_I0</span><span class="c">];</span>
	<span class="w">e</span><span class="pc">n</span><span class="c">um</span> <span class="w">ctx_state</span> <span class="w">prev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">mc_gregset_t</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">g</span><span class="pc">rp;</span>
	<span class="w">mcontext_t</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">mc</span><span class="pc">p</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">fp</span><span class="pc">,</span> <span class="w">i7</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">fenab</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">synchronize_user_stack</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">get_thread_wsaved() ||</span> <span class="w">clear_user(ucp</span><span class="c">,</span> <span class="pc">s</span><span class="c">izeof</span><span class="pc">(*</span><span class="w">u</span><span class="c">cp)))</span>
		<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">do_sigsegv</span><span class="c">;</span>

<span class="w">#</span><span class="pc">if</span> <span class="w">1</span>
	<span class="w">f</span><span class="c">enab</span> <span class="w">=</span> <span class="pc">0</span><span class="c">;</span> 
<span class="pc">#el</span><span class="c">se</span>
	<span class="pc">f</span><span class="c">enab</span> <span class="pc">= </span><span class="c">(</span><span class="w">current_thread_info()-&gt;fpsaved[</span><span class="c">0</span><span class="pc">] &amp;</span> <span class="w">FPRS_FEF</span><span class="c">);</span>
<span class="pc">#en</span><span class="c">dif</span>
		
	<span class="w">mc</span><span class="pc">p</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="c">ucp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">uc_mcontext</span><span class="pc">;</span>
	<span class="w">gr</span><span class="c">p</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">mc</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">mc_gregs</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">test_thread_flag</span><span class="c">(</span><span class="w">TIF_32BIT</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tpc</span>   <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tnpc</span> <span class="pc">&amp;</span> <span class="w">0xf</span><span class="pc">ffff</span><span class="c">fff);</span>
		<span class="w">r</span><span class="c">egs-&gt;</span><span class="pc">tn</span><span class="c">pc</span>  <span class="w">=</span><span class="pc"> </span><span class="c">(regs-&gt;</span><span class="pc">tn</span><span class="c">pc</span> <span class="pc">+</span> <span class="w">4</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">0xf</span><span class="pc">ffff</span><span class="c">fff;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="pc">r</span><span class="c">egs-&gt;</span><span class="w">t</span><span class="pc">p</span><span class="c">c</span>   <span class="c">=</span> <span class="c">regs-&gt;</span><span class="pc">t</span><span class="c">npc;</span>
		<span class="pc">r</span><span class="c">egs-&gt;</span><span class="pc">tn</span><span class="c">pc</span> <span class="w">+</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">er</span><span class="pc">r</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">_NSIG_WORDS</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">1)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user(</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">blocked.si</span><span class="pc">g[</span><span class="c">0</span><span class="pc">],</span>
				  <span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="w">_</span><span class="pc">_</span><span class="c">user</span> <span class="pc">*)&amp;</span><span class="w">ucp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">uc_sigmask</span><span class="c">);</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__copy_to_user</span><span class="pc">(&amp;u</span><span class="c">cp-&gt;</span><span class="pc">u</span><span class="c">c_sigmask</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;blocked</span><span class="pc">,</span>
				      <span class="pc">s</span><span class="c">izeof(</span><span class="w">sigset_t</span><span class="c">));</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">regs</span><span class="c">-&gt;</span><span class="w">tstate, &amp;((*g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_TSTATE])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user(</span><span class="w">reg</span><span class="c">s-&gt;</span><span class="w">tpc, &amp;</span><span class="pc">(</span><span class="c">(*</span><span class="w">g</span><span class="pc">rp</span><span class="w">)[MC_PC])</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">err</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">__p</span><span class="c">ut_user(</span><span class="w">reg</span><span class="c">s-&gt;</span><span class="w">tnpc, &amp;</span><span class="pc">(</span><span class="c">(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_NPC])</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">err</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s-&gt;</span><span class="w">y, </span><span class="pc">&amp;(</span><span class="c">(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_Y])</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">err</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s-&gt;</span><span class="w">u_regs</span><span class="pc">[</span><span class="w">UREG_G1], &amp;((*g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G1])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G2],</span><span class="pc"> &amp;(</span><span class="c">(*</span><span class="w">g</span><span class="pc">r</span><span class="c">p</span><span class="w">)[MC_G2])</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">err</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G3</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_G3])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G4</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_G4])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G5</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_G5])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G6</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_G6])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_G7</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_G7])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I0</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O0])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I1</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O1])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I2</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O2])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I3</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O3])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I4</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O4])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I5</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O5])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I6</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O6])</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs[</span><span class="w">UREG_I7</span><span class="pc">],</span><span class="c"> &amp;((*</span><span class="w">gr</span><span class="c">p</span><span class="w">)[MC_O7])</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__get_user</span><span class="c">(</span><span class="w">fp</span><span class="c">,</span>
		 <span class="w">(&amp;(((st</span><span class="pc">ru</span><span class="c">ct</span> <span class="w">reg_window</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)(</span><span class="w">STACK_BIAS</span><span class="pc">+</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;u_regs</span><span class="pc">[</span><span class="w">U</span><span class="c">REG_I6</span><span class="w">]))-&gt;ins</span><span class="pc">[</span><span class="w">6])));</span>
	<span class="w">e</span><span class="c">rr</span> <span class="w">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_get_user(</span><span class="w">i7</span><span class="c">,</span>
		 <span class="pc">(</span><span class="c">&amp;(((</span><span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="pc">r</span><span class="c">eg_window</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)(</span><span class="c">STACK_BIAS+</span><span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;u_regs</span><span class="pc">[U</span><span class="c">REG_I6</span><span class="w">])</span><span class="pc">)</span><span class="c">-&gt;ins</span><span class="pc">[</span><span class="w">7]</span><span class="pc">))</span><span class="c">);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">|</span><span class="pc">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user(</span><span class="w">fp, &amp;(mc</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">mc_fp)</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(i7</span><span class="w">, </span><span class="pc">&amp;(</span><span class="w">mc</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">mc_i7))</span><span class="c">;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">fenab,</span><span class="pc"> &amp;(</span><span class="w">mc</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">mc_fpregs.mcfpu_enab)</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">f</span><span class="c">enab</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">*fpregs</span> <span class="c">=</span> <span class="w">current_thread_info()-&gt;f</span><span class="c">pregs;</span>
		<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">fprs</span><span class="pc">;</span>
		
		<span class="pc">fprs</span> <span class="c">=</span> <span class="w">c</span><span class="pc">u</span><span class="c">rrent_thread_info</span><span class="w">()</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fpsaved[</span><span class="c">0</span><span class="pc">];</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">fprs</span> <span class="w">&amp;</span> <span class="w">FPRS_DL</span><span class="c">)</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">co</span><span class="pc">py_</span><span class="c">to_user</span><span class="w">(&amp;</span><span class="pc">(</span><span class="w">mc</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">mc_fpregs</span><span class="pc">.</span><span class="w">mcfpu_fregs</span><span class="pc">)</span><span class="c">,</span> <span class="w">f</span><span class="pc">pre</span><span class="c">gs</span><span class="pc">,</span>
					    <span class="w">(si</span><span class="pc">zeo</span><span class="c">f(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">) </span><span class="pc">*</span> <span class="w">3</span><span class="c">2</span><span class="pc">))</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">f</span><span class="c">prs</span> <span class="w">&amp;</span> <span class="w">FPRS_DU</span><span class="c">)</span>
			<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">co</span><span class="c">py_to_user(</span>
                          <span class="w">(</span><span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="w">*)&amp;(mc</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">c_fpregs</span><span class="pc">.</span><span class="c">mcfpu_fregs</span><span class="w">))+1</span><span class="pc">6,</span> <span class="w">fp</span><span class="pc">re</span><span class="c">gs</span><span class="w">+1</span><span class="pc">6,</span>
			  <span class="w">(si</span><span class="pc">zeo</span><span class="c">f(unsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">)</span><span class="pc"> </span><span class="c">*</span> <span class="w">3</span><span class="c">2</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">current_thread_info()-&gt;xfsr[</span><span class="c">0</span><span class="w">], &amp;(mc</span><span class="pc">p</span><span class="c">-&gt;mc_fpregs</span><span class="pc">.</span><span class="w">mcfpu_fsr)</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="pc">c</span><span class="c">urrent_thread_info</span><span class="w">(</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">gsr</span><span class="pc">[</span><span class="c">0</span><span class="w">],</span><span class="pc"> &amp;(</span><span class="w">mc</span><span class="pc">p</span><span class="c">-&gt;mc_fpregs.</span><span class="w">mcfpu_gsr)</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">fprs, &amp;(mcp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">c_fpregs.</span><span class="w">mcfpu_fprs)</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err)</span>
		<span class="c">goto</span> <span class="w">do_sigsegv</span><span class="c">;</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="c">);</span>
	<span class="c">return</span><span class="w">;</span>
<span class="w">d</span><span class="pc">o</span><span class="c">_sigsegv:</span>
	<span class="w">force_sig</span><span class="c">(</span><span class="w">SIGSEGV</span><span class="pc">,</span> <span class="w">cu</span><span class="c">rrent);</span>
	<span class="w">g</span><span class="c">oto</span> <span class="c">out</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">rt_signal_frame</span> <span class="pc">{</span>
	<span class="c">struct</span> <span class="w">sparc_stackf</span>	<span class="w">ss</span><span class="c">;</span>
	<span class="w">siginfo_t</span>		<span class="w">i</span><span class="c">nfo;</span>
	<span class="c">struct</span> <span class="w">pt</span><span class="pc">_</span><span class="c">regs</span>		<span class="w">regs</span><span class="pc">;</span>
	<span class="w">__siginfo_fpu_t</span> <span class="w">__u</span><span class="c">ser</span>	<span class="c">*</span><span class="w">fpu_save</span><span class="c">;</span>
	<span class="w">stack_t</span>			<span class="w">stack</span><span class="c">;</span>
	<span class="w">sigset_t</span>		<span class="w">m</span><span class="pc">as</span><span class="c">k;</span>
	<span class="w">__siginfo_rwin_t</span>	<span class="pc">*</span><span class="w">rwin_save</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">do_rt_sigreturn</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">r</span><span class="c">t_signal_frame</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="c">*</span><span class="w">sf</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">tpc</span><span class="pc">,</span> <span class="w">tnpc</span><span class="pc">,</span> <span class="w">tstate</span><span class="c">;</span>
	<span class="w">_</span><span class="pc">_s</span><span class="c">iginfo_fpu_t</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">f</span><span class="pc">p</span><span class="c">u_save;</span>
	<span class="w">_</span><span class="pc">_siginfo_r</span><span class="c">win_t</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">r</span><span class="c">win_save;</span>
	<span class="w">sigset_t</span> <span class="w">se</span><span class="c">t;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">e</span><span class="c">rr;</span>

	
	<span class="w">cu</span><span class="pc">rre</span><span class="c">nt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">restart_block</span><span class="pc">.</span><span class="w">fn</span> <span class="c">=</span> <span class="w">do_no_restart_syscall</span><span class="c">;</span>

	<span class="w">synchronize_user_stack</span> <span class="pc">()</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">f</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="w">rt_signal_frame</span> <span class="pc">_</span><span class="c">_user</span> <span class="pc">*)</span>
		<span class="w">(reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">u_regs</span> <span class="pc">[</span><span class="w">UREG_FP] </span><span class="pc">+</span> <span class="w">STACK_BIAS</span><span class="c">);</span>

	
	<span class="c">if</span> <span class="w">((</span><span class="pc">(</span><span class="w">u</span><span class="pc">ns</span><span class="c">igned</span> <span class="c">long)</span> <span class="pc">s</span><span class="c">f</span><span class="w">) &amp;</span> <span class="w">3</span><span class="pc">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">segv</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">get_user</span><span class="c">(</span><span class="w">tpc</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">f-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">.</span><span class="w">t</span><span class="c">pc);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__get_user</span><span class="c">(</span><span class="w">tnpc</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">sf-</span><span class="c">&gt;</span><span class="w">r</span><span class="c">egs.</span><span class="pc">tn</span><span class="c">pc);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">test_thread_flag</span><span class="c">(</span><span class="w">TIF_32BIT</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">t</span><span class="pc">p</span><span class="c">c</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">0xff</span><span class="pc">fff</span><span class="c">fff;</span>
		<span class="w">t</span><span class="pc">n</span><span class="c">pc</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">0</span><span class="pc">xfffff</span><span class="c">fff;</span>
	<span class="c">}</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">|= ((t</span><span class="c">pc</span> <span class="w">|</span> <span class="pc">tn</span><span class="c">pc</span><span class="w">) </span><span class="pc">&amp;</span> <span class="w">3</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">_</span><span class="c">_get_user(</span><span class="w">re</span><span class="pc">gs-</span><span class="c">&gt;</span><span class="w">y,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">f</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">egs</span><span class="pc">.</span><span class="w">y</span><span class="c">);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_get_user(</span><span class="w">tstate</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">f</span><span class="pc">-</span><span class="c">&gt;regs</span><span class="pc">.ts</span><span class="c">tate);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">cop</span><span class="pc">y_f</span><span class="c">rom_user</span><span class="pc">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">u_regs</span><span class="c">,</span> <span class="c">sf-&gt;</span><span class="pc">r</span><span class="c">egs.</span><span class="pc">u</span><span class="c">_regs</span><span class="pc">,</span> <span class="pc">si</span><span class="c">zeof(</span><span class="pc">r</span><span class="c">egs-&gt;</span><span class="pc">u</span><span class="c">_regs));</span>

	
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">t</span><span class="c">state</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">TSTATE_ASI</span> <span class="c">|</span> <span class="w">TSTATE_ICC</span> <span class="pc">|</span> <span class="w">TSTATE_XCC</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="pc">t</span><span class="c">state</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">t</span><span class="c">state</span> <span class="w">&amp;</span><span class="pc"> (T</span><span class="c">STATE_ASI</span> <span class="c">|</span> <span class="pc">T</span><span class="c">STATE_ICC</span> <span class="c">|</span> <span class="c">TSTATE_XCC</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__get_user</span><span class="c">(</span><span class="w">fpu_save</span><span class="pc">, </span><span class="c">&amp;sf</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">f</span><span class="c">pu_save);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr</span> <span class="pc">&amp;&amp;</span> <span class="c">fpu_save</span><span class="pc">)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">restore_fpu_state</span><span class="pc">(</span><span class="w">reg</span><span class="pc">s,</span> <span class="pc">f</span><span class="c">pu_save);</span>

	<span class="pc">er</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__copy_from_user</span><span class="pc">(&amp;</span><span class="w">se</span><span class="pc">t, </span><span class="c">&amp;</span><span class="w">s</span><span class="c">f</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ma</span><span class="pc">s</span><span class="c">k,</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">sigset_t</span><span class="c">));</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">restore_altstack</span><span class="pc">(&amp;</span><span class="c">sf</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stack</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">goto</span> <span class="w">segv</span><span class="c">;</span>

	<span class="c">err</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__get_user</span><span class="c">(</span><span class="w">rwin_save</span><span class="pc">, </span><span class="c">&amp;sf</span><span class="pc">-</span><span class="c">&gt;rwin_save);</span>
	<span class="c">if</span> <span class="pc">(!e</span><span class="c">rr</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">r</span><span class="pc">w</span><span class="c">in_save</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">restore_rwin_state</span><span class="c">(</span><span class="pc">r</span><span class="c">win_save))</span>
			<span class="c">goto</span> <span class="pc">s</span><span class="c">egv;</span>
	<span class="pc">}</span>

	<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tpc</span> <span class="c">=</span> <span class="w">t</span><span class="pc">p</span><span class="c">c;</span>
	<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tnpc</span> <span class="c">=</span> <span class="pc">t</span><span class="c">npc;</span>

	
	<span class="w">pt_regs_clear_syscall</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s);</span>

	<span class="w">set_current_blocked</span><span class="pc">(&amp;</span><span class="w">se</span><span class="pc">t)</span><span class="c">;</span>
	<span class="c">return</span><span class="w">;</span>
<span class="w">s</span><span class="pc">eg</span><span class="c">v</span><span class="pc">:</span>
	<span class="w">force_sig</span><span class="c">(</span><span class="w">SIGSEGV</span><span class="pc">,</span> <span class="w">cu</span><span class="c">rrent);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">invalid_frame_pointer</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="pc">__u</span><span class="c">ser</span> <span class="c">*</span><span class="w">fp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="w">((</span><span class="pc">(</span><span class="w">u</span><span class="c">nsigned</span> <span class="c">long)</span> <span class="w">fp) &amp;</span> <span class="w">1</span><span class="pc">5)</span>
		<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="c">*</span><span class="w">get_sigframe</span><span class="c">(struct</span> <span class="w">ksignal</span> <span class="c">*</span><span class="w">ksig</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="c">t_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="c">long</span> <span class="w">framesize</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">sp</span> <span class="pc">=</span> <span class="w">re</span><span class="pc">gs</span><span class="c">-&gt;</span><span class="w">u_regs</span><span class="pc">[</span><span class="w">UREG_FP] </span><span class="pc">+</span> <span class="w">STACK_BIAS</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">on_sig_stack</span><span class="c">(</span><span class="w">sp) &amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">lik</span><span class="c">ely(</span><span class="w">o</span><span class="c">n_sig_stack</span><span class="w">(sp</span> <span class="w">-</span> <span class="c">framesize</span><span class="pc">)))</span>
		<span class="c">return</span> <span class="w">(v</span><span class="pc">o</span><span class="c">id</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="w">*) -1L</span><span class="pc">;</span>

	
	<span class="w">sp</span> <span class="c">=</span> <span class="w">sigsp</span><span class="c">(</span><span class="w">s</span><span class="pc">p</span><span class="c">,</span> <span class="w">ksig) -</span> <span class="w">f</span><span class="c">ramesize</span><span class="pc">;</span>

	
	<span class="w">s</span><span class="pc">p</span> <span class="w">&amp;</span><span class="pc">= </span><span class="c">~</span><span class="w">15UL</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">(v</span><span class="c">oid</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)</span> <span class="w">s</span><span class="pc">p</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span>
<span class="w">setup_rt_frame</span><span class="c">(struct</span> <span class="w">ksignal</span> <span class="c">*</span><span class="w">k</span><span class="pc">sig</span><span class="c">,</span> <span class="c">struct</span> <span class="w">p</span><span class="c">t_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">rt_signal_frame</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">sf</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">wsaved</span><span class="pc">,</span> <span class="w">e</span><span class="pc">r</span><span class="c">r</span><span class="pc">,</span> <span class="w">sf_size</span><span class="c">;</span>
	<span class="w">v</span><span class="c">oid</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">tai</span><span class="c">l</span><span class="pc">;</span>

	
	<span class="w">synchronize_user_stack</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">save_and_clear_fpu</span><span class="pc">()</span><span class="c">;</span>
	
	<span class="w">w</span><span class="c">saved</span> <span class="c">=</span> <span class="w">get_thread_wsaved</span><span class="pc">()</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">f</span><span class="c">_size</span> <span class="c">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="c">rt_signal_frame);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">current_thread_info()-&gt;fpsaved[</span><span class="c">0</span><span class="w">] </span><span class="pc">&amp;</span> <span class="w">FPRS_FEF</span><span class="c">)</span>
		<span class="w">s</span><span class="pc">f_</span><span class="c">size</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">s</span><span class="c">izeof(</span><span class="w">__siginfo_fpu_t</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(wsaved</span><span class="pc">)</span>
		<span class="pc">s</span><span class="c">f_size</span> <span class="w">+</span><span class="c">=</span> <span class="pc">si</span><span class="c">zeof(</span><span class="w">__siginfo_rwin_t</span><span class="c">);</span>
	<span class="w">sf</span> <span class="pc">= </span><span class="c">(</span><span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="pc">r</span><span class="c">t_signal_frame</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="pc">*)</span>
		<span class="w">get_sigframe</span><span class="pc">(</span><span class="w">ksig</span><span class="pc">,</span> <span class="w">reg</span><span class="c">s</span><span class="pc">,</span> <span class="w">s</span><span class="pc">f_</span><span class="c">size);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">invalid_frame_pointer</span> <span class="c">(</span><span class="pc">s</span><span class="c">f</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">do_exit</span><span class="c">(</span><span class="w">SIGILL</span><span class="pc">)</span><span class="c">;</span>	
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-EI</span><span class="c">NVAL;</span>
	<span class="c">}</span>

	<span class="w">ta</span><span class="pc">i</span><span class="c">l</span> <span class="pc">= </span><span class="c">(</span><span class="w">s</span><span class="pc">f</span> <span class="w">+</span> <span class="c">1);</span>

	
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">c</span><span class="pc">op</span><span class="c">y_to_user</span><span class="pc">(&amp;</span><span class="c">sf</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs,</span> <span class="w">reg</span><span class="c">s,</span> <span class="pc">si</span><span class="c">zeof</span> <span class="pc">(*</span><span class="w">r</span><span class="pc">egs</span><span class="c">));</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">current_thread_info()-&gt;fpsaved[</span><span class="c">0</span><span class="pc">] </span><span class="c">&amp;</span> <span class="w">FPRS_FEF</span><span class="c">) {</span>
		<span class="w">__siginfo_fpu_t</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="pc">*</span><span class="w">fpu_save</span> <span class="c">=</span> <span class="w">ta</span><span class="pc">i</span><span class="c">l;</span>
		<span class="w">ta</span><span class="pc">i</span><span class="c">l</span> <span class="w">+</span><span class="pc">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="pc">_</span><span class="c">_siginfo_fpu_t</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="c">rr</span> <span class="w">|</span><span class="c">=</span> <span class="w">save_fpu_state</span><span class="pc">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s,</span> <span class="pc">f</span><span class="c">pu_save</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user</span><span class="pc">((</span><span class="w">u</span><span class="pc">6</span><span class="c">4)fpu_save</span><span class="w">,</span><span class="pc"> &amp;</span><span class="w">sf</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">f</span><span class="c">pu_save);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user(</span><span class="w">0</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">f-&gt;</span><span class="w">f</span><span class="pc">p</span><span class="c">u_save);</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">wsaved)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">__siginfo_rwin_t</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*</span><span class="w">rwin_save</span> <span class="c">=</span> <span class="w">ta</span><span class="pc">i</span><span class="c">l;</span>
		<span class="w">ta</span><span class="pc">i</span><span class="c">l</span> <span class="w">+</span><span class="pc">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">_</span><span class="c">_siginfo_rwin_t</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="c">rr</span> <span class="w">|</span><span class="c">=</span> <span class="w">save_rwin_state</span><span class="pc">(w</span><span class="c">saved,</span> <span class="pc">r</span><span class="c">win_save</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user</span><span class="pc">((</span><span class="w">u</span><span class="c">64)</span><span class="pc">r</span><span class="c">win_save</span><span class="w">,</span><span class="pc"> &amp;</span><span class="c">sf-&gt;</span><span class="pc">r</span><span class="c">win_save);</span>
		<span class="w">set_thread_wsaved</span><span class="c">(</span><span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="pc">_p</span><span class="c">ut_user(</span><span class="w">0</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">f</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">win_save</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	
	
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">__save_altstack</span><span class="pc">(&amp;s</span><span class="c">f</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stack</span><span class="pc">,</span> <span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">u_regs[UREG_FP</span><span class="c">]);</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">cop</span><span class="c">y_to_user</span><span class="pc">(&amp;</span><span class="c">sf-&gt;</span><span class="w">mas</span><span class="pc">k</span><span class="c">,</span> <span class="w">sigmask_to_save()</span><span class="pc">,</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">sigset_t</span><span class="c">));</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">wsaved</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">copy_in_user(</span><span class="pc">(</span><span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*)</span><span class="pc">s</span><span class="c">f</span><span class="w">,</span>
				    <span class="w">(u</span><span class="pc">6</span><span class="c">4</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)(</span><span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">_regs</span><span class="pc">[U</span><span class="c">REG_FP</span><span class="w">] </span><span class="pc">+</span>
						   <span class="w">STACK_BIAS)</span><span class="pc">,</span>
				    <span class="w">s</span><span class="pc">iz</span><span class="c">eof(</span><span class="pc">st</span><span class="c">ruct</span> <span class="w">reg_window</span><span class="c">));</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">r</span><span class="c">eg_window</span> <span class="c">*</span><span class="w">rp</span><span class="pc">;</span>

		<span class="w">rp</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">current_thread_info()-&gt;r</span><span class="c">eg_window</span><span class="pc">[</span><span class="w">wsaved</span> <span class="w">-</span> <span class="c">1];</span>
		<span class="w">e</span><span class="c">rr</span> <span class="w">|</span><span class="c">=</span> <span class="w">cop</span><span class="pc">y_</span><span class="c">to_user(</span><span class="w">sf</span><span class="pc">,</span> <span class="w">rp</span><span class="c">,</span> <span class="c">sizeof(struct</span> <span class="pc">r</span><span class="c">eg_window));</span>
	<span class="pc">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">ksig-</span><span class="c">&gt;</span><span class="w">ka.sa</span><span class="c">.</span><span class="w">sa_flags</span> <span class="w">&amp;</span> <span class="w">SA_SIGINFO</span><span class="pc">)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">copy_siginfo_to_user</span><span class="pc">(&amp;</span><span class="c">sf-&gt;</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">s</span><span class="c">ig-&gt;</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span> <span class="w">{</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(ksig-&gt;</span><span class="w">si</span><span class="pc">g, </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">f-&gt;</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">.</span><span class="w">si_signo</span><span class="c">);</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">_</span><span class="c">_put_user(</span><span class="w">SI_NOINFO</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">f-&gt;</span><span class="w">i</span><span class="c">nfo.</span><span class="w">si_code</span><span class="c">);</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>
	
	
	<span class="w">regs</span><span class="c">-&gt;</span><span class="w">u_regs[UREG_FP] = ((u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong)</span> <span class="c">sf</span><span class="w">) -</span> <span class="w">STACK_BIAS</span><span class="c">;</span>
	<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">u</span><span class="c">_regs</span><span class="pc">[</span><span class="w">UREG_I0</span><span class="c">] =</span> <span class="w">ksig-</span><span class="pc">&gt;</span><span class="w">si</span><span class="pc">g;</span>
	<span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">_regs[</span><span class="w">UREG_I1] =</span><span class="pc"> (un</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span><span class="w">) &amp;</span><span class="pc">s</span><span class="c">f-&gt;</span><span class="w">i</span><span class="c">nfo</span><span class="w">;</span>

	
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;u_regs[</span><span class="w">UREG_I2] =</span><span class="pc"> (</span><span class="c">unsigned</span> <span class="c">long</span><span class="w">) &amp;</span><span class="pc">s</span><span class="c">f-&gt;</span><span class="w">i</span><span class="c">nfo</span><span class="pc">;</span>

	
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tpc</span> <span class="pc">= </span><span class="c">(unsigned</span> <span class="c">long)</span> <span class="w">k</span><span class="c">sig-&gt;</span><span class="w">ka</span><span class="pc">.</span><span class="w">sa</span><span class="c">.</span><span class="w">sa_handler</span><span class="pc">;</span>
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tnpc</span> <span class="pc">= </span><span class="c">(</span><span class="w">r</span><span class="c">egs-&gt;tpc</span> <span class="pc">+</span> <span class="w">4</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">test_thread_flag</span><span class="c">(</span><span class="w">TIF_32BIT)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">t</span><span class="pc">p</span><span class="c">c</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">0xf</span><span class="pc">ffff</span><span class="c">fff;</span>
		<span class="pc">r</span><span class="c">egs-&gt;tnpc</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">0</span><span class="pc">xfffff</span><span class="c">fff;</span>
	<span class="c">}</span>
	
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">u_regs</span><span class="pc">[</span><span class="w">UREG_I7] </span><span class="pc">= (</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">ksig-</span><span class="c">&gt;</span><span class="w">ka</span><span class="pc">.</span><span class="w">ka_restorer</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="c">void</span> <span class="w">syscall_restart</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">orig_i0</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">,</span>
				   <span class="pc">s</span><span class="c">truct</span> <span class="w">sigaction</span> <span class="c">*</span><span class="w">sa</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">r</span><span class="c">egs-&gt;</span><span class="w">u_regs</span><span class="pc">[</span><span class="w">UREG_I0</span><span class="pc">])</span><span class="c"> {</span>
	<span class="c">case</span> <span class="w">ERESTART_RESTARTBLOCK</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">ERESTARTNOHAND</span><span class="c">:</span>
	<span class="w">no_system_call_restart:</span>
		<span class="w">re</span><span class="pc">gs-</span><span class="c">&gt;u_regs</span><span class="pc">[U</span><span class="c">REG_I0] =</span> <span class="w">EINTR</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tstate</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">TSTATE_ICARRY</span><span class="pc">|</span><span class="w">TSTATE_XCARRY</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">ERESTARTSYS</span><span class="c">:</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sa</span><span class="c">-&gt;</span><span class="w">sa_flags</span> <span class="c">&amp;</span> <span class="w">SA_RESTART</span><span class="c">))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">n</span><span class="c">o_system_call_restart;</span>
		
	<span class="pc">c</span><span class="c">ase</span> <span class="w">ERESTARTNOINTR</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;u_regs</span><span class="pc">[U</span><span class="c">REG_I0] =</span> <span class="w">orig_i0</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">tpc</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">4</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tnpc</span> <span class="w">-</span><span class="pc">=</span> <span class="c">4;</span>
	<span class="c">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">do_signal</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*regs,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">o</span><span class="pc">r</span><span class="c">ig_i0)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ksignal</span> <span class="w">ksig</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">restart_syscall</span><span class="c">;</span>
	<span class="w">b</span><span class="c">ool</span> <span class="w">has_handler</span><span class="c">;</span>
	
	
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">pt_regs_is_syscall</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="w">)</span><span class="pc"> &amp;</span><span class="c">&amp;</span>
	    <span class="w">(r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tstate</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">TSTATE_XCARRY</span> <span class="c">|</span> <span class="w">TSTATE_ICARRY</span><span class="pc">)))</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">u_regs</span><span class="pc">[</span><span class="w">UREG_G6</span><span class="pc">] </span><span class="c">=</span> <span class="c">orig_i0;</span>

<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_COMPAT</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">test_thread_flag</span><span class="c">(</span><span class="w">TIF_32BIT</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">do_signal32</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>	

	<span class="w">has_handler</span> <span class="pc">=</span> <span class="w">get_signal</span><span class="pc">(&amp;</span><span class="w">ksig</span><span class="c">);</span>

	<span class="w">restart_syscall</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">pt_regs_is_syscall</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="w">)</span><span class="pc"> &amp;</span><span class="c">&amp;</span>
	    <span class="w">(r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">tstate</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">TSTATE_XCARRY</span> <span class="c">|</span> <span class="w">TSTATE_ICARRY))</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">es</span><span class="c">tart_syscall</span> <span class="pc">=</span> <span class="c">1;</span>
		<span class="w">orig_i0</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">u_regs</span><span class="pc">[</span><span class="w">UREG_G6</span><span class="c">];</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">h</span><span class="c">as_handler</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">estart_syscall</span><span class="pc">)</span>
			<span class="w">syscall_restart</span><span class="c">(</span><span class="pc">o</span><span class="c">rig_i0,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">ksig.ka.sa</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">signal_setup_done</span><span class="c">(</span><span class="w">setup_rt_frame(</span><span class="pc">&amp;</span><span class="c">ksig</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs</span><span class="w">),</span><span class="pc"> </span><span class="c">&amp;ksig</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">estart_syscall</span><span class="w">)</span><span class="c"> {</span>
			<span class="w">sw</span><span class="c">itch</span> <span class="c">(</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">u_regs</span><span class="pc">[</span><span class="w">UREG_I0</span><span class="c">]) {</span>
			<span class="c">case</span> <span class="w">ERESTARTNOHAND</span><span class="c">:</span>
	     		<span class="pc">c</span><span class="c">ase</span> <span class="w">ERESTARTSYS</span><span class="c">:</span>
			<span class="c">case</span> <span class="w">ERESTARTNOINTR</span><span class="c">:</span>
				
				<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;u_regs[</span><span class="pc">U</span><span class="c">REG_I0</span><span class="pc">] </span><span class="c">=</span> <span class="w">orig_i0</span><span class="c">;</span>
				<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">tpc</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">4</span><span class="c">;</span>
				<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tnpc</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">4</span><span class="c">;</span>
				<span class="w">pt_regs_clear_syscall</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">c</span><span class="pc">as</span><span class="c">e</span> <span class="w">ERESTART_RESTARTBLOCK</span><span class="c">:</span>
				<span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;u_regs[</span><span class="w">UREG_G1</span><span class="c">] =</span> <span class="w">__NR_restart_syscall</span><span class="c">;</span>
				<span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">t</span><span class="c">pc</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">4</span><span class="c">;</span>
				<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="pc">t</span><span class="c">npc</span> <span class="w">-</span><span class="pc">=</span> <span class="c">4;</span>
				<span class="w">p</span><span class="pc">t</span><span class="c">_regs_clear_syscall</span><span class="pc">(r</span><span class="c">egs</span><span class="w">)</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span>
		<span class="w">restore_saved_sigmask</span><span class="pc">()</span><span class="c">;</span>
	<span class="pc">}</span>
<span class="w">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">do_notify_resume</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">orig_i0</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">thread_info_flags</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">user_exit</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="pc">h</span><span class="c">read_info_flags</span> <span class="pc">&amp;</span> <span class="w">_TIF_SIGPENDING</span><span class="c">)</span>
		<span class="w">do_signal</span><span class="c">(</span><span class="w">r</span><span class="c">egs,</span> <span class="c">orig_i0);</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(thread_info_flags</span> <span class="c">&amp;</span> <span class="w">_TIF_NOTIFY_RESUME</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">clear_thread_flag</span><span class="c">(</span><span class="w">TIF_NOTIFY_RESUME</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">tracehook_notify_resume</span><span class="c">(</span><span class="w">r</span><span class="pc">egs)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">user_enter</span><span class="pc">()</span><span class="c">;</span>
<span class="c">}</span>


</pre>
</body>
</html>

