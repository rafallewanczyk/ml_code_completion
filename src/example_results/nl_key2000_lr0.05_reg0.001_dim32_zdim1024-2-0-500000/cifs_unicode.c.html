<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>

<span class="w">#include</span> <span class="w">&lt;linux/fs.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">"cifs_fs_sb.h"</span>
<span class="w">#include</span> <span class="w">"cifs_unicode.h"</span>
<span class="w">#include</span> <span class="w">"cifs_uniupr.h"</span>
<span class="w">#</span><span class="c">include</span> <span class="c">"</span><span class="w">cifspdu</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">cifsglob</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">cifs_debug</span><span class="c">.h"</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">cifs_remap</span><span class="c">(struct</span> <span class="w">cifs_sb_info</span> <span class="c">*</span><span class="w">cifs_sb</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">map_type</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(cifs_sb-&gt;</span><span class="w">mnt_cifs_flags</span> <span class="w">&amp;</span> <span class="w">CIFS_MOUNT_MAP_SFM_CHR</span><span class="pc">)</span>
		<span class="pc">m</span><span class="c">ap_type</span> <span class="pc">=</span> <span class="w">SFM_MAP_UNI_RSVD</span><span class="pc">;</span>
	<span class="c">else</span> <span class="c">if</span> <span class="c">(cifs_sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">nt_cifs_flags</span> <span class="pc">&amp;</span> <span class="w">CIFS_MOUNT_MAP_SPECIAL_CHR</span><span class="c">)</span>
		<span class="pc">m</span><span class="c">ap_type</span> <span class="pc">=</span> <span class="w">SFU_MAP_UNI_RSVD</span><span class="pc">;</span>
	<span class="c">else</span>
		<span class="w">m</span><span class="c">ap_type</span> <span class="pc">=</span> <span class="w">NO_MAP_UNI_RSVD</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">m</span><span class="c">ap_type;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="w">b</span><span class="c">ool</span>
<span class="w">convert_sfu_char</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="w">__u</span><span class="pc">1</span><span class="c">6</span> <span class="w">src_char</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">)</span>
<span class="c">{</span>
	
	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">s</span><span class="c">rc_char) {</span>
	<span class="c">case</span> <span class="w">UNI_COLON</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= ':';</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">UNI_ASTERISK</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '*';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">case</span> <span class="w">UNI_QUESTION</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '?';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">UNI_PIPE</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '|';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">case</span> <span class="w">UNI_GRTRTHAN</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '&gt;';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">UNI_LESSTHAN</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '&lt;';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">default:</span>
		<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span>
<span class="w">convert_sfm_char</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="w">_</span><span class="pc">_u1</span><span class="c">6</span> <span class="w">src_char</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">t</span><span class="pc">ar</span><span class="c">get</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">sw</span><span class="c">itch</span> <span class="c">(</span><span class="pc">s</span><span class="c">rc_char) {</span>
	<span class="c">case</span> <span class="w">SFM_COLON</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= ':';</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">SFM_ASTERISK</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '*';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">case</span> <span class="w">SFM_QUESTION</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '?';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">SFM_PIPE</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '|';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">case</span> <span class="w">SFM_GRTRTHAN</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '&gt;';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">SFM_LESSTHAN</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '&lt;';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">SFM_SLASH</span><span class="c">:</span>
		<span class="pc">*</span><span class="w">t</span><span class="pc">a</span><span class="c">rget</span> <span class="w">= '\\';</span>
		<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">default:</span>
		<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">int</span>
<span class="w">cifs_mapchar</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">t</span><span class="pc">ar</span><span class="c">get,</span> <span class="pc">c</span><span class="c">onst</span> <span class="w">__u</span><span class="pc">1</span><span class="c">6</span> <span class="c">*</span><span class="w">f</span><span class="pc">r</span><span class="c">om,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">c</span><span class="pc">p,</span>
	     <span class="pc">i</span><span class="c">nt</span> <span class="w">maptype</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="c">en</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">_</span><span class="pc">_u1</span><span class="c">6</span> <span class="w">src_char</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">r</span><span class="c">c_char</span> <span class="w">= *f</span><span class="pc">r</span><span class="c">om;</span>

	<span class="c">if</span> <span class="pc">((m</span><span class="c">aptype</span> <span class="pc">==</span> <span class="w">SFM_MAP_UNI_RSVD</span><span class="pc">)</span><span class="c"> &amp;&amp;</span> <span class="w">convert_sfm_char</span><span class="c">(</span><span class="pc">s</span><span class="c">rc_char,</span> <span class="w">t</span><span class="pc">ar</span><span class="c">get</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">l</span><span class="c">en;</span>
	<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">((</span><span class="c">maptype</span> <span class="c">==</span> <span class="w">SFU_MAP_UNI_RSVD</span><span class="c">) &amp;&amp;</span>
		  <span class="w">convert_sfu_char</span><span class="c">(</span><span class="pc">sr</span><span class="c">c_char,</span> <span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">l</span><span class="c">en;</span>

	
	<span class="w">l</span><span class="c">en</span> <span class="c">=</span> <span class="w">cp</span><span class="c">-&gt;</span><span class="w">uni2char(s</span><span class="pc">r</span><span class="c">c_char,</span> <span class="w">ta</span><span class="pc">r</span><span class="c">get,</span> <span class="w">NLS_MAX_CHARSET_SIZE</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">l</span><span class="c">en</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">surrogate_pair</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">l</span><span class="c">en;</span>

<span class="pc">s</span><span class="c">urrogate_pair:</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">st</span><span class="pc">rc</span><span class="c">mp(</span><span class="w">cp</span><span class="c">-&gt;</span><span class="w">charset</span><span class="pc">, </span><span class="c">"</span><span class="w">utf8"</span><span class="pc">))</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">un</span><span class="pc">k</span><span class="c">nown;</span>
	<span class="w">l</span><span class="c">en</span> <span class="pc">=</span> <span class="w">utf16s_to_utf8s</span><span class="c">(</span><span class="w">fr</span><span class="pc">o</span><span class="c">m,</span> <span class="w">3</span><span class="pc">,</span> <span class="w">UTF16_LITTLE_ENDIAN</span><span class="pc">,</span> <span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">,</span> <span class="w">6</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(len</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">un</span><span class="pc">k</span><span class="c">nown;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">l</span><span class="c">en;</span>

<span class="w">un</span><span class="pc">k</span><span class="c">nown:</span>
	<span class="w">*ta</span><span class="pc">r</span><span class="c">get</span> <span class="w">= '?';</span>
	<span class="w">l</span><span class="c">en</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">len;</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span>
<span class="w">cifs_from_utf16</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">t</span><span class="pc">o</span><span class="c">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">_</span><span class="c">_le16</span> <span class="c">*</span><span class="w">f</span><span class="c">rom,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">tolen</span><span class="pc">,</span> <span class="c">int</span> <span class="w">fromlen</span><span class="pc">,</span>
		<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">codepage</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">map_type</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i,</span> <span class="w">charlen</span><span class="pc">,</span> <span class="w">safelen</span><span class="pc">;</span>
	<span class="c">int</span> <span class="w">outlen</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">int</span> <span class="w">nullsize</span> <span class="c">=</span> <span class="w">nls_nullsize</span><span class="pc">(</span><span class="c">codepage);</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">fromwords</span> <span class="c">=</span> <span class="w">f</span><span class="c">romlen</span> <span class="w">/</span> <span class="pc">2</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">har</span> <span class="w">t</span><span class="c">mp</span><span class="pc">[</span><span class="w">NLS_MAX_CHARSET_SIZE</span><span class="c">];</span>
	<span class="w">_</span><span class="pc">_u1</span><span class="c">6</span> <span class="w">ftmp</span><span class="c">[</span><span class="pc">3</span><span class="c">];</span>		

	
	<span class="w">s</span><span class="pc">a</span><span class="c">felen</span> <span class="c">=</span> <span class="w">tolen</span> <span class="w">-</span><span class="pc"> </span><span class="c">(</span><span class="w">N</span><span class="c">LS_MAX_CHARSET_SIZE</span> <span class="c">+</span> <span class="w">n</span><span class="c">ullsize</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">f</span><span class="pc">r</span><span class="c">omwords;</span> <span class="c">i++) {</span>
		<span class="w">f</span><span class="c">tmp</span><span class="pc">[0</span><span class="c">] =</span> <span class="w">get_unaligned_le16(</span><span class="pc">&amp;</span><span class="w">fro</span><span class="pc">m</span><span class="c">[i]);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">f</span><span class="c">tmp[</span><span class="pc">0] =</span><span class="c">=</span> <span class="pc">0)</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="w">+</span> <span class="pc">1</span> <span class="w">&lt;</span> <span class="w">f</span><span class="pc">r</span><span class="c">omwords</span><span class="pc">)</span>
			<span class="w">f</span><span class="pc">t</span><span class="c">mp[</span><span class="pc">1</span><span class="c">] =</span> <span class="pc">g</span><span class="c">et_unaligned_le16</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">fr</span><span class="pc">om</span><span class="c">[</span><span class="pc">i</span> <span class="pc">+</span> <span class="c">1]);</span>
		<span class="w">e</span><span class="c">lse</span>
			<span class="pc">f</span><span class="c">tmp[</span><span class="w">1</span><span class="c">] =</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span> <span class="w">+</span> <span class="pc">2</span> <span class="w">&lt;</span> <span class="w">f</span><span class="c">romwords</span><span class="pc">)</span>
			<span class="c">ftmp[</span><span class="pc">2</span><span class="c">] =</span> <span class="c">get_unaligned_le16</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">fr</span><span class="pc">om</span><span class="c">[i</span> <span class="pc">+</span> <span class="pc">2]</span><span class="c">);</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">f</span><span class="pc">t</span><span class="c">mp[</span><span class="pc">2</span><span class="c">] =</span> <span class="c">0;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">outlen</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">safelen</span><span class="c">) {</span>
			<span class="w">charlen</span> <span class="pc">=</span> <span class="w">cifs_mapchar</span><span class="pc">(</span><span class="w">t</span><span class="c">mp,</span> <span class="w">f</span><span class="pc">t</span><span class="c">mp,</span> <span class="w">codepage</span><span class="pc">,</span> <span class="w">map_type</span><span class="c">);</span>
			<span class="c">if</span> <span class="pc">((</span><span class="w">o</span><span class="c">utlen</span> <span class="w">+</span> <span class="w">c</span><span class="c">harlen</span><span class="w">) &gt; (tolen</span> <span class="pc">-</span> <span class="w">nullsize</span><span class="pc">)</span><span class="c">)</span>
				<span class="c">break;</span>
		<span class="c">}</span>

		
		<span class="w">c</span><span class="c">harlen</span> <span class="c">=</span> <span class="w">c</span><span class="pc">i</span><span class="c">fs_mapchar</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">to[</span><span class="pc">o</span><span class="c">utlen</span><span class="pc">],</span> <span class="pc">f</span><span class="c">tmp,</span> <span class="pc">co</span><span class="c">depage,</span> <span class="c">map_type</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">o</span><span class="c">utlen</span> <span class="w">+</span><span class="c">=</span> <span class="pc">c</span><span class="c">harlen;</span>

		
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">arlen</span> <span class="pc">=</span><span class="c">=</span> <span class="w">4</span><span class="pc">)</span>
			<span class="w">i</span><span class="pc">++</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="pc">ch</span><span class="c">arlen</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">5</span><span class="c">)</span>
			
			<span class="w">i</span> <span class="pc">+=</span> <span class="pc">2</span><span class="c">;</span>
	<span class="w">}</span>

	
	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">nullsize</span><span class="c">;</span> <span class="c">i</span><span class="pc">++)</span>
		<span class="w">to[</span><span class="pc">o</span><span class="c">utlen</span><span class="pc">+</span><span class="c">+] =</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">o</span><span class="c">utlen;</span>
<span class="c">}</span>


<span class="pc">in</span><span class="c">t</span>
<span class="w">cifs_strtoUTF16</span><span class="c">(</span><span class="w">_</span><span class="pc">_le1</span><span class="c">6</span> <span class="c">*</span><span class="w">to</span><span class="c">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">f</span><span class="c">rom,</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">len</span><span class="pc">,</span>
	      <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">codepage</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">charlen</span><span class="c">;</span>
	<span class="c">int</span> <span class="pc">i</span><span class="c">;</span>
	<span class="w">wchar_t</span> <span class="w">wchar_to</span><span class="c">;</span> 

	
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">trc</span><span class="c">mp(codepage-&gt;</span><span class="w">charset</span><span class="pc">, </span><span class="c">"</span><span class="w">utf8"</span><span class="pc">)) </span><span class="c">{</span>
		
		<span class="w">i</span>  <span class="c">=</span> <span class="w">utf8s_to_utf16s</span><span class="c">(</span><span class="w">fr</span><span class="pc">o</span><span class="c">m,</span> <span class="w">l</span><span class="c">en,</span> <span class="w">UTF16_LITTLE_ENDIAN</span><span class="c">,</span>
				       <span class="w">(</span><span class="pc">w</span><span class="c">char_t</span> <span class="w">*</span><span class="pc">)</span> <span class="w">t</span><span class="pc">o,</span> <span class="w">l</span><span class="c">en);</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">i</span> <span class="pc">&gt;</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
			<span class="c">goto</span> <span class="w">success</span><span class="c">;</span>
		
	<span class="pc">}</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="w">&amp;&amp; *f</span><span class="pc">r</span><span class="c">om;</span> <span class="c">i</span><span class="pc">++,</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">+</span><span class="pc">=</span> <span class="w">charlen,</span> <span class="pc">l</span><span class="c">en</span> <span class="w">-</span><span class="pc">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">arlen</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">c</span><span class="pc">harl</span><span class="c">en</span> <span class="pc">=</span> <span class="w">codepage-</span><span class="c">&gt;</span><span class="w">char2uni</span><span class="pc">(</span><span class="w">f</span><span class="pc">ro</span><span class="c">m,</span> <span class="pc">l</span><span class="c">en</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">wchar_to</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(charlen</span> <span class="w">&lt;</span> <span class="w">1</span><span class="c">) {</span>
			<span class="w">cifs_dbg</span><span class="c">(</span><span class="w">VFS</span><span class="pc">, </span><span class="c">"</span><span class="w">strtoUTF16</span><span class="pc">:</span> <span class="pc">c</span><span class="c">har2uni</span> <span class="w">o</span><span class="c">f</span> <span class="pc">0</span><span class="c">x%x</span> <span class="w">returned</span> <span class="c">%d\n",</span>
				 <span class="w">*fr</span><span class="pc">o</span><span class="c">m</span><span class="pc">,</span> <span class="pc">c</span><span class="c">harlen</span><span class="w">)</span><span class="pc">;</span>
			
			<span class="w">w</span><span class="pc">c</span><span class="c">har_to</span> <span class="c">=</span> <span class="w">0x003f</span><span class="pc">;</span>
			<span class="pc">c</span><span class="c">harlen</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">put_unaligned_le16</span><span class="c">(</span><span class="pc">w</span><span class="c">char_to</span><span class="pc">, &amp;</span><span class="w">to[i</span><span class="c">]);</span>
	<span class="pc">}</span>

<span class="w">success:</span>
	<span class="pc">p</span><span class="c">ut_unaligned_le16(</span><span class="w">0</span><span class="pc">, &amp;</span><span class="w">to[</span><span class="pc">i])</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">i</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span>
<span class="w">cifs_utf16_bytes</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="w">_</span><span class="pc">_le1</span><span class="c">6</span> <span class="c">*</span><span class="w">f</span><span class="pc">r</span><span class="c">om,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">maxbytes</span><span class="c">,</span>
		<span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">codepage</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">charlen</span><span class="pc">,</span> <span class="w">outlen</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">int</span> <span class="w">maxwords</span> <span class="c">=</span> <span class="w">m</span><span class="pc">axb</span><span class="c">ytes</span> <span class="w">/</span> <span class="pc">2</span><span class="c">;</span>
	<span class="w">c</span><span class="c">har</span> <span class="w">t</span><span class="c">mp[</span><span class="w">NLS_MAX_CHARSET_SIZE</span><span class="c">];</span>
	<span class="w">_</span><span class="pc">_u1</span><span class="c">6</span> <span class="w">ftmp</span><span class="c">[</span><span class="w">3</span><span class="c">];</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">m</span><span class="c">axwords;</span> <span class="c">i++) {</span>
		<span class="w">f</span><span class="pc">t</span><span class="c">mp[</span><span class="pc">0</span><span class="c">] =</span> <span class="w">get_unaligned_le16</span><span class="pc">(&amp;</span><span class="w">fr</span><span class="pc">o</span><span class="c">m[i]);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">f</span><span class="c">tmp[</span><span class="pc">0] =</span><span class="c">=</span> <span class="pc">0)</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="w">+</span> <span class="pc">1</span> <span class="w">&lt;</span> <span class="w">m</span><span class="c">axwords</span><span class="pc">)</span>
			<span class="w">f</span><span class="c">tmp[</span><span class="pc">1</span><span class="c">] =</span> <span class="pc">g</span><span class="c">et_unaligned_le16</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">fr</span><span class="pc">o</span><span class="c">m[</span><span class="pc">i</span> <span class="pc">+</span> <span class="c">1]);</span>
		<span class="w">e</span><span class="c">lse</span>
			<span class="pc">f</span><span class="c">tmp[</span><span class="w">1</span><span class="c">] =</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span> <span class="w">+</span> <span class="pc">2</span> <span class="w">&lt;</span> <span class="w">m</span><span class="c">axwords</span><span class="pc">)</span>
			<span class="c">ftmp[</span><span class="pc">2</span><span class="c">] =</span> <span class="c">get_unaligned_le16</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">fr</span><span class="pc">o</span><span class="c">m[i</span> <span class="pc">+</span> <span class="pc">2]</span><span class="c">);</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">f</span><span class="pc">t</span><span class="c">mp[</span><span class="pc">2</span><span class="c">] =</span> <span class="c">0;</span>

		<span class="w">charlen</span> <span class="pc">=</span> <span class="w">cifs_mapchar</span><span class="c">(</span><span class="w">t</span><span class="c">mp</span><span class="pc">,</span> <span class="pc">f</span><span class="c">tmp</span><span class="pc">,</span> <span class="w">codepage</span><span class="c">,</span> <span class="w">NO_MAP_UNI_RSVD</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">outlen</span> <span class="w">+</span><span class="c">=</span> <span class="c">charlen</span><span class="pc">;</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">o</span><span class="c">utlen;</span>
<span class="c">}</span>


<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span>
<span class="w">cifs_strndup_from_utf16</span><span class="c">(</span><span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*</span><span class="w">s</span><span class="pc">r</span><span class="c">c,</span> <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="w">i</span><span class="c">nt</span> <span class="w">m</span><span class="pc">axl</span><span class="c">en,</span>
			<span class="c">const</span> <span class="w">b</span><span class="c">ool</span> <span class="w">is_unicode</span><span class="pc">,</span> <span class="c">const</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">c</span><span class="pc">od</span><span class="c">epage</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">l</span><span class="c">en;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*dst;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(</span><span class="w">i</span><span class="pc">s</span><span class="c">_unicode</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="c">=</span> <span class="w">cifs_utf16_bytes(</span><span class="pc">(</span><span class="w">__l</span><span class="c">e16</span> <span class="pc">*</span><span class="c">)</span> <span class="w">s</span><span class="pc">r</span><span class="c">c</span><span class="pc">,</span> <span class="w">max</span><span class="pc">l</span><span class="c">en</span><span class="pc">,</span> <span class="w">c</span><span class="c">odepage);</span>
		<span class="w">l</span><span class="c">en</span> <span class="pc">+</span><span class="c">=</span> <span class="w">nls_nullsize</span><span class="pc">(</span><span class="c">codepage</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">d</span><span class="c">st</span> <span class="c">=</span> <span class="w">k</span><span class="c">malloc(</span><span class="pc">l</span><span class="c">en,</span> <span class="pc">G</span><span class="c">FP_KERNEL);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">ds</span><span class="c">t)</span>
			<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="w">cifs_from_utf16</span><span class="pc">(</span><span class="w">d</span><span class="pc">s</span><span class="c">t</span><span class="w">,</span><span class="pc"> (</span><span class="w">__l</span><span class="pc">e1</span><span class="c">6</span> <span class="c">*)</span> <span class="pc">sr</span><span class="c">c,</span> <span class="pc">l</span><span class="c">en</span><span class="pc">,</span> <span class="w">max</span><span class="pc">l</span><span class="c">en</span><span class="pc">,</span> <span class="w">c</span><span class="c">odepage</span><span class="pc">,</span>
			       <span class="w">NO_MAP_UNI_RSVD</span><span class="c">);</span>
	<span class="pc">}</span> <span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="c">{</span>
		<span class="w">l</span><span class="c">en</span> <span class="c">=</span> <span class="w">strnlen</span><span class="c">(</span><span class="w">s</span><span class="pc">r</span><span class="c">c,</span> <span class="w">max</span><span class="pc">l</span><span class="c">en</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">l</span><span class="c">en</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
		<span class="w">d</span><span class="c">st</span> <span class="c">=</span> <span class="w">k</span><span class="pc">m</span><span class="c">alloc(</span><span class="pc">l</span><span class="c">en,</span> <span class="pc">G</span><span class="c">FP_KERNEL);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">d</span><span class="pc">s</span><span class="c">t)</span>
			<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="w">str</span><span class="pc">l</span><span class="c">cpy(</span><span class="w">d</span><span class="c">st,</span> <span class="w">s</span><span class="pc">r</span><span class="c">c,</span> <span class="pc">l</span><span class="c">en);</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="c">st;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">__l</span><span class="c">e16</span> <span class="w">convert_to_sfu_char</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">src_char</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">__l</span><span class="c">e16</span> <span class="w">dest_char</span><span class="pc">;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(src_char) {</span>
	<span class="c">case</span> <span class="w">':':</span>
		<span class="pc">d</span><span class="c">est_char</span> <span class="pc">=</span> <span class="w">c</span><span class="c">pu_to_le16(</span><span class="w">UNI_COLON</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">'*':</span>
		<span class="w">d</span><span class="c">est_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16(</span><span class="w">UNI_ASTERISK</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'?':</span>
		<span class="w">d</span><span class="pc">es</span><span class="c">t_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">UNI_QUESTION</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'&lt;':</span>
		<span class="w">d</span><span class="pc">es</span><span class="c">t_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">UNI_LESSTHAN</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'&gt;':</span>
		<span class="pc">d</span><span class="c">est_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">UNI_GRTRTHAN</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'|':</span>
		<span class="pc">d</span><span class="c">est_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">UNI_PIPE</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="c">dest_char</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="c">est_char;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">_</span><span class="pc">_l</span><span class="c">e16</span> <span class="w">convert_to_sfm_char</span><span class="c">(</span><span class="w">c</span><span class="c">har</span> <span class="w">src_char</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">_</span><span class="pc">_l</span><span class="c">e16</span> <span class="pc">d</span><span class="c">est_char</span><span class="pc">;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="pc">s</span><span class="c">rc_char) {</span>
	<span class="c">case</span> <span class="w">':':</span>
		<span class="w">d</span><span class="pc">es</span><span class="c">t_char</span> <span class="pc">=</span> <span class="w">c</span><span class="c">pu_to_le16(</span><span class="w">SFM_COLON</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">'*':</span>
		<span class="w">d</span><span class="c">est_char</span> <span class="w">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16(</span><span class="w">SFM_ASTERISK</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'?':</span>
		<span class="pc">d</span><span class="c">est_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">SFM_QUESTION</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'&lt;':</span>
		<span class="w">d</span><span class="pc">es</span><span class="c">t_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">SFM_LESSTHAN</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'&gt;':</span>
		<span class="pc">d</span><span class="c">est_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">SFM_GRTRTHAN</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">'|':</span>
		<span class="pc">d</span><span class="c">est_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">SFM_PIPE</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="c">dest_char</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="c">est_char;</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span>
<span class="w">cifsConvertToUTF16</span><span class="c">(</span><span class="w">_</span><span class="c">_le16</span> <span class="c">*</span><span class="w">ta</span><span class="pc">r</span><span class="c">get,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">s</span><span class="pc">o</span><span class="c">urce,</span> <span class="w">i</span><span class="c">nt</span> <span class="w">srclen</span><span class="c">,</span>
		 <span class="pc">c</span><span class="c">onst</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">c</span><span class="pc">p</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">map_chars</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i,</span> <span class="w">charlen</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">j</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">src_char</span><span class="pc">;</span>
	<span class="w">_</span><span class="c">_le16</span> <span class="w">dst_char</span><span class="c">;</span>
	<span class="w">wchar_t</span> <span class="w">tm</span><span class="c">p;</span>
	<span class="pc">w</span><span class="c">char_t</span> <span class="pc">*</span><span class="w">wchar_to</span><span class="pc">;</span>	
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="w">unicode_t</span> <span class="w">u</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">m</span><span class="c">ap_chars</span> <span class="pc">=</span><span class="c">=</span> <span class="w">NO_MAP_UNI_RSVD</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">cifs_strtoUTF16</span><span class="pc">(</span><span class="w">ta</span><span class="pc">r</span><span class="c">get,</span> <span class="w">so</span><span class="pc">u</span><span class="c">rce</span><span class="pc">,</span> <span class="w">PATH_MAX</span><span class="c">,</span> <span class="w">cp</span><span class="c">);</span>

	<span class="w">w</span><span class="c">char_to</span> <span class="c">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(</span><span class="w">6</span><span class="c">,</span> <span class="c">GFP_KERNEL);</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">srclen</span><span class="c">;</span> <span class="w">j</span><span class="c">++) {</span>
		<span class="w">src_char</span> <span class="c">=</span> <span class="w">so</span><span class="c">urce</span><span class="pc">[</span><span class="c">i];</span>
		<span class="w">charlen</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(src_char</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">ctoUTF16_out</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">map_chars</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SFU_MAP_UNI_RSVD</span><span class="c">)</span>
			<span class="w">dst_char</span> <span class="pc">=</span> <span class="w">convert_to_sfu_char</span><span class="pc">(</span><span class="c">src_char</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="pc">m</span><span class="c">ap_chars</span> <span class="c">==</span> <span class="w">SFM_MAP_UNI_RSVD</span><span class="c">)</span>
			<span class="pc">d</span><span class="c">st_char</span> <span class="c">=</span> <span class="w">convert_to_sfm_char</span><span class="pc">(s</span><span class="c">rc_char);</span>
		<span class="c">else</span>
			<span class="w">d</span><span class="c">st_char</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(dst_char</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">charlen</span> <span class="c">=</span> <span class="w">cp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">char2uni</span><span class="pc">(</span><span class="w">so</span><span class="pc">u</span><span class="c">rce</span> <span class="w">+</span> <span class="w">i</span><span class="c">,</span> <span class="w">srclen</span> <span class="w">-</span> <span class="pc">i</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">t</span><span class="c">mp);</span>
			<span class="pc">d</span><span class="c">st_char</span> <span class="c">=</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6(</span><span class="pc">t</span><span class="c">mp);</span>

			
			<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">harlen</span> <span class="c">&gt;</span> <span class="c">0</span><span class="pc">)</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">ctoUTF16</span><span class="c">;</span>

			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">st</span><span class="pc">rc</span><span class="c">mp(</span><span class="w">cp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">charset,</span><span class="pc"> </span><span class="c">"</span><span class="w">utf8") || !wchar_to)</span>
				<span class="c">goto</span> <span class="w">unk</span><span class="c">nown;</span>
			<span class="c">if</span> <span class="w">(*</span><span class="pc">(</span><span class="w">so</span><span class="c">urce</span> <span class="w">+</span> <span class="pc">i</span><span class="w">) </span><span class="pc">&amp;</span> <span class="w">0</span><span class="pc">x8</span><span class="c">0</span><span class="pc">) </span><span class="c">{</span>
				<span class="pc">c</span><span class="c">harlen</span> <span class="c">=</span> <span class="w">utf8_to_utf32</span><span class="pc">(</span><span class="w">so</span><span class="c">urce</span> <span class="w">+</span> <span class="pc">i,</span> <span class="w">6</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">u</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">if</span> <span class="c">(charlen</span> <span class="w">&lt;</span> <span class="c">0</span><span class="pc">)</span>
					<span class="c">goto</span> <span class="w">unk</span><span class="c">nown;</span>
			<span class="c">}</span> <span class="c">else</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">un</span><span class="pc">k</span><span class="c">nown;</span>
			<span class="w">r</span><span class="pc">et</span>  <span class="c">=</span> <span class="w">utf8s_to_utf16s</span><span class="c">(</span><span class="w">so</span><span class="c">urce</span> <span class="w">+</span> <span class="pc">i</span><span class="c">,</span> <span class="c">charlen</span><span class="pc">,</span>
					       <span class="w">UTF16_LITTLE_ENDIAN</span><span class="pc">,</span>
					       <span class="w">wchar_to</span><span class="pc">,</span> <span class="w">6</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
				<span class="c">goto</span> <span class="w">unk</span><span class="c">nown;</span>

			<span class="w">i</span> <span class="pc">+=</span> <span class="pc">c</span><span class="c">harlen;</span>
			<span class="w">dst_char</span> <span class="pc">=</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="pc">(*</span><span class="w">w</span><span class="c">char_to);</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">harlen</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">3</span><span class="pc">)</span>
				
				<span class="w">put_unaligned</span><span class="pc">(d</span><span class="c">st_char</span><span class="pc">, &amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">[</span><span class="w">j</span><span class="pc">])</span><span class="c">;</span>
			<span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">harlen</span> <span class="pc">=</span><span class="c">=</span> <span class="w">4</span><span class="pc">) </span><span class="c">{</span>
				
				<span class="w">p</span><span class="c">ut_unaligned</span><span class="pc">(</span><span class="c">dst_char</span><span class="pc">, &amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="w">[j</span><span class="pc">])</span><span class="c">;</span>
				<span class="pc">d</span><span class="c">st_char</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="w">(*</span><span class="pc">(</span><span class="c">wchar_to</span> <span class="pc">+</span> <span class="pc">1</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">j</span><span class="pc">++</span><span class="c">;</span>
				<span class="pc">p</span><span class="c">ut_unaligned</span><span class="pc">(</span><span class="c">dst_char</span><span class="pc">, &amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">[j])</span><span class="c">;</span>
			<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(charlen</span> <span class="pc">&gt;</span><span class="c">=</span> <span class="w">5</span><span class="c">) {</span>
				
				<span class="c">put_unaligned</span><span class="pc">(</span><span class="c">dst_char</span><span class="w">,</span><span class="pc"> &amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">[</span><span class="w">j</span><span class="pc">])</span><span class="c">;</span>
				<span class="w">d</span><span class="c">st_char</span> <span class="c">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="w">(*</span><span class="pc">(w</span><span class="c">char_to</span> <span class="pc">+</span> <span class="c">1</span><span class="pc">))</span><span class="c">;</span>
				<span class="w">j</span><span class="pc">++</span><span class="c">;</span>
				<span class="pc">p</span><span class="c">ut_unaligned</span><span class="w">(</span><span class="c">dst_char</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">[j])</span><span class="c">;</span>
				<span class="w">d</span><span class="c">st_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="w">(*</span><span class="c">(</span><span class="pc">w</span><span class="c">char_to</span> <span class="c">+</span> <span class="pc">2</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">j</span><span class="pc">++</span><span class="c">;</span>
				<span class="pc">p</span><span class="c">ut_unaligned</span><span class="pc">(</span><span class="c">dst_char</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">[j])</span><span class="c">;</span>
			<span class="pc">}</span>
			<span class="w">co</span><span class="pc">nt</span><span class="c">inue;</span>

<span class="w">un</span><span class="pc">k</span><span class="c">nown</span><span class="w">:</span>
			<span class="pc">d</span><span class="c">st_char</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6(</span><span class="w">0x003f</span><span class="c">);</span>
			<span class="w">charlen</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="c">}</span>

<span class="w">ctoUTF16</span><span class="pc">:</span>
		
		<span class="w">i</span> <span class="w">+</span><span class="pc">=</span> <span class="w">c</span><span class="c">harlen;</span>
		<span class="w">p</span><span class="c">ut_unaligned</span><span class="pc">(</span><span class="c">dst_char</span><span class="pc">, &amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="w">[j</span><span class="c">]);</span>
	<span class="c">}</span>

<span class="w">ctoUTF16_out</span><span class="pc">:</span>
	<span class="w">p</span><span class="c">ut_unaligned(</span><span class="w">0</span><span class="pc">, &amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="w">[j</span><span class="pc">])</span><span class="c">;</span> 
	<span class="w">k</span><span class="c">free(</span><span class="w">wchar_to</span><span class="c">);</span>
	<span class="c">return</span> <span class="w">j</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_CIFS_SMB2</span>


<span class="c">static</span> <span class="c">int</span>
<span class="w">cifs_local_to_utf16_bytes</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">f</span><span class="pc">r</span><span class="c">om,</span> <span class="c">int</span> <span class="c">len</span><span class="pc">,</span>
			  <span class="pc">c</span><span class="c">onst</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">codepage</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">charlen</span><span class="pc">;</span>
	<span class="c">int</span> <span class="pc">i</span><span class="c">;</span>
	<span class="w">wchar_t</span> <span class="w">w</span><span class="c">char_to;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">l</span><span class="c">en</span> <span class="w">&amp;&amp; *f</span><span class="pc">r</span><span class="c">om;</span> <span class="c">i</span><span class="pc">++,</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">+</span><span class="pc">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">arlen</span><span class="w">,</span> <span class="pc">l</span><span class="c">en</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">c</span><span class="c">harlen</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">c</span><span class="pc">harl</span><span class="c">en</span> <span class="pc">=</span> <span class="pc">co</span><span class="c">depage</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">char2uni</span><span class="pc">(</span><span class="w">f</span><span class="pc">r</span><span class="c">om,</span> <span class="w">l</span><span class="c">en</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">w</span><span class="pc">char_to</span><span class="c">);</span>
		
		<span class="c">if</span> <span class="c">(charlen</span> <span class="w">&lt;</span> <span class="w">1</span><span class="pc">)</span>
			<span class="w">c</span><span class="pc">h</span><span class="c">arlen</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">2</span> <span class="pc">*</span> <span class="w">i</span><span class="c">;</span> 
<span class="c">}</span>


<span class="w">__l</span><span class="c">e16</span> <span class="pc">*</span>
<span class="w">cifs_strndup_to_utf16</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">s</span><span class="pc">r</span><span class="c">c,</span> <span class="pc">c</span><span class="c">onst</span> <span class="w">i</span><span class="c">nt</span> <span class="w">ma</span><span class="pc">xl</span><span class="c">en,</span> <span class="w">i</span><span class="c">nt</span> <span class="c">*</span><span class="w">utf16_len</span><span class="pc">,</span>
		      <span class="c">const</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">cp</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">remap</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="c">en</span><span class="pc">;</span>
	<span class="w">__l</span><span class="c">e16</span> <span class="c">*</span><span class="w">d</span><span class="c">st;</span>

	<span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="c">=</span> <span class="w">cifs_local_to_utf16_bytes</span><span class="c">(</span><span class="w">s</span><span class="pc">r</span><span class="c">c,</span> <span class="w">max</span><span class="pc">l</span><span class="c">en</span><span class="pc">,</span> <span class="w">cp</span><span class="c">);</span>
	<span class="w">l</span><span class="c">en</span> <span class="pc">+</span><span class="c">=</span> <span class="pc">2</span><span class="c">;</span> 
	<span class="w">d</span><span class="c">st</span> <span class="c">=</span> <span class="pc">k</span><span class="c">malloc(</span><span class="pc">l</span><span class="c">en,</span> <span class="pc">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">ds</span><span class="c">t</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">*</span><span class="w">utf16_len</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="w">cifsConvertToUTF16</span><span class="c">(</span><span class="pc">ds</span><span class="c">t,</span> <span class="w">s</span><span class="pc">r</span><span class="c">c,</span> <span class="w">st</span><span class="pc">rl</span><span class="c">en(</span><span class="pc">s</span><span class="c">rc</span><span class="pc">),</span> <span class="w">c</span><span class="pc">p,</span> <span class="w">remap</span><span class="c">);</span>
	<span class="w">*</span><span class="pc">u</span><span class="c">tf16_len</span> <span class="c">=</span> <span class="w">l</span><span class="c">en;</span>
	<span class="c">return</span> <span class="pc">d</span><span class="c">st;</span>
<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 

</pre>
</body>
</html>

