<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>




<span class="w">#include</span> <span class="w">&lt;linux/errno.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/sched.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/mm.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">stddef</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">unistd</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ptrace</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">u</span><span class="pc">se</span><span class="c">r.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">nt</span><span class="c">errupt.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">n</span><span class="c">it.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">m</span><span class="c">odule.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">prctl</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">kprobes</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">kexec</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">backlight</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">bug</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">kdebug</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">debugfs</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ratelimit</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">context_tracking</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="w">emulated_ops</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">pgtable</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="pc">u</span><span class="c">access.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/io.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">machdep</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">rtas</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">pm</span><span class="pc">c</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">re</span><span class="pc">g</span><span class="c">.h&gt;</span>
<span class="c">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_PMAC_BACKLIGHT</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">&lt;asm/</span><span class="w">backlight</span><span class="c">.h&gt;</span>
<span class="c">#endif</span>
<span class="c">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_PPC64</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">fi</span><span class="pc">r</span><span class="c">mware.h&gt;</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">&lt;asm/</span><span class="w">processor</span><span class="c">.h&gt;</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">&lt;asm/</span><span class="w">tm</span><span class="c">.h&gt;</span>
<span class="c">#</span><span class="pc">e</span><span class="c">ndif</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">kexec</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">ppc</span><span class="pc">-</span><span class="w">opc</span><span class="c">ode.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">rio</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">fadump</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">switch_to</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">tm</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">de</span><span class="pc">b</span><span class="c">ug.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">sysdev</span><span class="c">/</span><span class="w">fsl_pci</span><span class="c">.h&gt;</span>

<span class="c">#</span><span class="pc">if</span> <span class="pc">d</span><span class="c">efined(</span><span class="w">CONFIG_DEBUGGER</span><span class="pc">) </span><span class="c">||</span> <span class="c">defined(</span><span class="w">CONFIG_KEXEC</span><span class="c">)</span>
<span class="w">i</span><span class="c">nt</span> <span class="c">(*</span><span class="w">__debugger</span><span class="c">)(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span> <span class="w">_</span><span class="pc">_r</span><span class="c">ead_mostly;</span>
<span class="pc">in</span><span class="c">t</span> <span class="c">(*</span><span class="w">__debugger_ipi</span><span class="pc">)(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="w">)</span> <span class="w">__r</span><span class="pc">e</span><span class="c">ad_mostly;</span>
<span class="pc">in</span><span class="c">t</span> <span class="pc">(</span><span class="c">*</span><span class="w">__debugger_bpt</span><span class="pc">)(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="w">)</span> <span class="w">__r</span><span class="pc">e</span><span class="c">ad_mostly;</span>
<span class="pc">in</span><span class="c">t</span> <span class="c">(*</span><span class="w">__debugger_sstep</span><span class="pc">)(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="w">)</span> <span class="w">__r</span><span class="pc">e</span><span class="c">ad_mostly;</span>
<span class="pc">i</span><span class="c">nt</span> <span class="c">(*</span><span class="w">__debugger_iabr_match</span><span class="pc">)(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="w">)</span> <span class="w">__r</span><span class="pc">e</span><span class="c">ad_mostly;</span>
<span class="pc">i</span><span class="c">nt</span> <span class="c">(*</span><span class="w">__debugger_break_match</span><span class="pc">)(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="w">)</span> <span class="w">__r</span><span class="pc">e</span><span class="c">ad_mostly;</span>
<span class="pc">i</span><span class="c">nt</span> <span class="c">(*</span><span class="w">__debugger_fault_handler</span><span class="pc">)(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="w">)</span> <span class="w">__r</span><span class="pc">e</span><span class="c">ad_mostly;</span>

<span class="w">E</span><span class="pc">XPORT_SYMBOL</span><span class="c">(</span><span class="w">__debugger</span><span class="c">);</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">__debugger_ipi</span><span class="c">);</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">__debugger_bpt</span><span class="c">);</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL(</span><span class="w">__debugger_sstep</span><span class="c">);</span>
<span class="c">EXPORT_SYMBOL(</span><span class="w">__debugger_iabr_match</span><span class="c">);</span>
<span class="c">EXPORT_SYMBOL(</span><span class="w">__debugger_break_match</span><span class="c">);</span>
<span class="c">EXPORT_SYMBOL(</span><span class="pc">__debugger_f</span><span class="c">ault_handler);</span>
<span class="pc">#e</span><span class="c">ndif</span>


<span class="pc">#</span><span class="c">ifdef</span> <span class="w">TM_DEBUG_SW</span>
<span class="pc">#d</span><span class="c">efine</span> <span class="w">TM_DEBUG</span><span class="c">(</span><span class="w">x.</span><span class="c">..)</span> <span class="w">p</span><span class="c">rintk(</span><span class="pc">KERN_I</span><span class="c">NFO</span> <span class="w">x)</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
<span class="c">#define</span> <span class="pc">T</span><span class="c">M_DEBUG(x</span><span class="w">.</span><span class="c">..)</span> <span class="c">do</span> <span class="c">{ }</span> <span class="c">while(0)</span>
<span class="c">#endif</span>



<span class="c">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_PMAC_BACKLIGHT</span>
<span class="pc">sta</span><span class="c">tic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">pmac_backlight_unblank</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">m</span><span class="pc">ut</span><span class="c">ex_lock(&amp;</span><span class="w">pmac_backlight_mutex</span><span class="c">);</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">pmac_backlight</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">backlight_properties</span> <span class="c">*</span><span class="w">prop</span><span class="pc">s;</span>

		<span class="w">pro</span><span class="pc">ps</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">p</span><span class="pc">mac_backlight</span><span class="c">-&gt;</span><span class="w">pr</span><span class="pc">op</span><span class="c">s</span><span class="pc">;</span>
		<span class="w">pro</span><span class="pc">p</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">brightness</span> <span class="c">=</span> <span class="w">p</span><span class="pc">r</span><span class="c">ops-&gt;</span><span class="w">max_brightness</span><span class="c">;</span>
		<span class="w">p</span><span class="pc">r</span><span class="c">ops-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">wer</span> <span class="pc">=</span> <span class="w">FB_BLANK_UNBLANK</span><span class="pc">;</span>
		<span class="w">backlight_update_status</span><span class="c">(</span><span class="w">p</span><span class="pc">mac_backlight)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="pc">p</span><span class="c">mac_backlight_mutex</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>
<span class="w">#</span><span class="pc">e</span><span class="c">lse</span>
<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">pmac_backlight_unblank</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="w">) { }</span>
<span class="w">#</span><span class="c">endif</span>

<span class="c">static</span> <span class="w">arch_spinlock_t</span> <span class="w">die_lock</span> <span class="w">=</span> <span class="w">__ARCH_SPIN_LOCK_UNLOCKED</span><span class="c">;</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">die_owner</span> <span class="pc">= </span><span class="c">-1;</span>
<span class="c">static</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">die_nest_count</span><span class="pc">;</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">die_counter</span><span class="pc">;</span>

<span class="c">static</span> <span class="w">u</span><span class="c">nsigned</span> <span class="w">__kprobes</span> <span class="w">l</span><span class="c">ong</span> <span class="w">oops_begin</span><span class="pc">(s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="c">pu;</span>
	<span class="c">unsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">debugger</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>

	<span class="w">oops_enter</span><span class="pc">()</span><span class="c">;</span>

	
	<span class="w">raw_local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>
	<span class="w">cp</span><span class="c">u</span> <span class="c">=</span> <span class="w">smp_processor_id</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">arch_spin_trylock</span><span class="pc">(&amp;</span><span class="w">die_lock</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">pu</span> <span class="pc">=</span><span class="c">=</span> <span class="w">die_owner</span><span class="c">)</span>
			<span class="w">;</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">arch_spin_lock</span><span class="pc">(&amp;di</span><span class="c">e_lock);</span>
	<span class="pc">}</span>
	<span class="w">die_nest_count+</span><span class="c">+;</span>
	<span class="w">d</span><span class="pc">ie_o</span><span class="c">wner</span> <span class="c">=</span> <span class="w">c</span><span class="pc">p</span><span class="c">u;</span>
	<span class="w">console_verbose</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">bust_spinlocks</span><span class="c">(</span><span class="w">1</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">machine_is</span><span class="c">(</span><span class="w">powermac</span><span class="pc">))</span>
		<span class="w">pmac_backlight_unblank</span><span class="pc">()</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">fl</span><span class="c">ags;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">__kprobes</span> <span class="w">oops_end</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="pc">f</span><span class="c">lags,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">reg</span><span class="c">s</span><span class="pc">,</span>
			       <span class="pc">i</span><span class="c">nt</span> <span class="w">signr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">b</span><span class="pc">u</span><span class="c">st_spinlocks</span><span class="pc">(0)</span><span class="c">;</span>
	<span class="w">die_owner</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>
	<span class="w">add_taint</span><span class="c">(</span><span class="w">TAINT_DIE</span><span class="c">,</span> <span class="w">LOCKDEP_NOW_UNRELIABLE</span><span class="c">);</span>
	<span class="w">die_nest_count-</span><span class="pc">-</span><span class="c">;</span>
	<span class="w">oops_exit</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">p</span><span class="pc">rin</span><span class="c">tk</span><span class="pc">("\</span><span class="c">n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!die_n</span><span class="c">est_count)</span>
		
		<span class="w">arch_spin_unlock</span><span class="pc">(&amp;</span><span class="w">die_lock</span><span class="c">);</span>
	<span class="w">raw_local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>

	<span class="w">crash_fadump</span><span class="c">(</span><span class="w">re</span><span class="pc">g</span><span class="c">s</span><span class="w">,</span><span class="pc"> "</span><span class="w">die</span> <span class="w">oops</span><span class="pc">"</span><span class="c">);</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">kexec_should_crash</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">TRAP</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s) ==</span> <span class="w">0x1</span><span class="pc">00)) </span><span class="c">{</span>
		<span class="w">crash_kexec</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs);</span>

		
		<span class="w">crash_kexec_secondary</span><span class="c">(</span><span class="w">r</span><span class="c">egs);</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">signr</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">in_interrupt() ||</span> <span class="w">panic_on_oops</span> <span class="w">|</span><span class="pc">| !</span><span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">pi</span><span class="pc">d</span> <span class="w">|</span><span class="c">|</span>
	    <span class="w">is_global_init</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">md</span><span class="c">elay(</span><span class="w">MSEC_PER_SEC</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span><span class="c">n_interrupt</span><span class="w">(</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">panic</span><span class="pc">("</span><span class="w">Fatal</span> <span class="w">exception</span> <span class="w">i</span><span class="pc">n</span> <span class="w">i</span><span class="pc">nt</span><span class="c">errupt</span><span class="pc">"</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="pc">anic_</span><span class="c">on_oops)</span>
		<span class="w">p</span><span class="pc">anic("</span><span class="c">Fatal</span> <span class="w">e</span><span class="c">xception</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">do_exit</span><span class="c">(</span><span class="w">signr</span><span class="c">);</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">__kprobes</span> <span class="w">__die</span><span class="c">(</span><span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">s</span><span class="pc">t</span><span class="c">r</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">,</span> <span class="w">l</span><span class="c">ong</span> <span class="w">e</span><span class="pc">rr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Oops</span><span class="pc">: </span><span class="c">%s</span><span class="w">,</span> <span class="w">si</span><span class="pc">g:</span><span class="c"> %</span><span class="w">l</span><span class="pc">d</span> <span class="w">[#%</span><span class="pc">d</span><span class="w">]</span><span class="pc">\</span><span class="c">n",</span> <span class="w">s</span><span class="pc">t</span><span class="c">r,</span> <span class="w">e</span><span class="pc">rr</span><span class="w">, ++die_counter)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_PREEMPT</span>
	<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">PREEMPT</span> <span class="pc">"</span><span class="c">);</span>
<span class="c">#endif</span>
<span class="c">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SMP</span>
	<span class="c">printk</span><span class="pc">("</span><span class="w">SMP</span> <span class="w">NR_CPUS=</span><span class="pc">%</span><span class="c">d</span> <span class="w">"</span><span class="c">,</span> <span class="w">N</span><span class="c">R_CPUS);</span>
<span class="c">#endif</span>
<span class="c">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_DEBUG_PAGEALLOC</span>
	<span class="c">printk("</span><span class="w">DEBUG_PAGEALLOC</span> <span class="pc">"</span><span class="c">);</span>
<span class="c">#endif</span>
<span class="c">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_NUMA</span>
	<span class="c">printk("</span><span class="w">NUMA</span> <span class="pc">"</span><span class="c">);</span>
<span class="c">#endif</span>
	<span class="pc">p</span><span class="c">rintk</span><span class="pc">("%</span><span class="c">s</span><span class="pc">\</span><span class="c">n</span><span class="pc">",</span> <span class="w">ppc_md.</span><span class="pc">n</span><span class="c">ame</span> <span class="w">?</span> <span class="w">p</span><span class="c">pc_md</span><span class="pc">.n</span><span class="c">ame</span> <span class="w">: "");</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">notify_die</span><span class="c">(</span><span class="w">DIE_OOPS</span><span class="c">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">r,</span> <span class="w">reg</span><span class="pc">s</span><span class="c">,</span> <span class="w">er</span><span class="pc">r,</span> <span class="w">2</span><span class="pc">55,</span> <span class="w">SIGSEGV) </span><span class="pc">=</span><span class="c">=</span> <span class="w">NOTIFY_STOP</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">1</span><span class="c">;</span>

	<span class="w">print_modules(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">show_regs</span><span class="c">(</span><span class="w">reg</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">die</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">s</span><span class="pc">t</span><span class="c">r,</span> <span class="pc">st</span><span class="c">ruct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">,</span> <span class="w">l</span><span class="c">ong</span> <span class="w">e</span><span class="c">rr)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags</span> <span class="pc">=</span> <span class="w">oops_begin</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">__die</span><span class="c">(</span><span class="w">st</span><span class="pc">r</span><span class="c">,</span> <span class="w">r</span><span class="c">egs,</span> <span class="w">er</span><span class="c">r))</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">oops_end</span><span class="c">(</span><span class="w">fl</span><span class="c">ags,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="pc">e</span><span class="c">rr);</span>
<span class="pc">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">user_single_step_siginfo</span><span class="c">(struct</span> <span class="w">t</span><span class="pc">a</span><span class="c">sk_struct</span> <span class="c">*</span><span class="w">t</span><span class="pc">s</span><span class="c">k</span><span class="pc">,</span>
				<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs,</span> <span class="w">siginfo_t</span> <span class="pc">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o)</span>
<span class="c">{</span>
	<span class="w">m</span><span class="pc">e</span><span class="c">mset(</span><span class="w">in</span><span class="pc">f</span><span class="c">o,</span> <span class="c">0,</span> <span class="pc">s</span><span class="c">izeof(*</span><span class="w">i</span><span class="c">nfo));</span>
	<span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">si_signo</span> <span class="c">=</span> <span class="w">SIGTRAP</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">si_code</span> <span class="c">=</span> <span class="w">TRAP_TRACE</span><span class="c">;</span>
	<span class="c">info-&gt;</span><span class="w">si_addr</span> <span class="w">=</span><span class="pc"> (</span><span class="w">v</span><span class="c">oid</span> <span class="w">_</span><span class="pc">_u</span><span class="c">ser</span> <span class="c">*)</span><span class="w">re</span><span class="pc">gs</span><span class="c">-&gt;</span><span class="w">nip</span><span class="c">;</span>
<span class="pc">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">_exception</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="w">signr</span><span class="c">,</span> <span class="w">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">reg</span><span class="c">s,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">a</span><span class="pc">d</span><span class="c">dr</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">siginfo_t</span> <span class="w">i</span><span class="c">nfo;</span>
	<span class="w">c</span><span class="c">onst</span> <span class="c">char</span> <span class="w">fmt32[] =</span> <span class="w">K</span><span class="pc">ERN_I</span><span class="c">NFO</span> <span class="w">"%</span><span class="c">s</span><span class="w">[</span><span class="c">%d</span><span class="w">]:</span> <span class="w">unhandled</span> <span class="w">si</span><span class="pc">gna</span><span class="c">l</span> <span class="pc">%</span><span class="c">d</span> <span class="w">" \</span>
			<span class="w">"a</span><span class="pc">t</span> <span class="c">%</span><span class="w">08</span><span class="pc">l</span><span class="c">x</span> <span class="w">nip</span> <span class="pc">%</span><span class="w">08</span><span class="pc">l</span><span class="c">x</span> <span class="w">lr</span> <span class="c">%</span><span class="w">08</span><span class="pc">l</span><span class="c">x</span> <span class="w">co</span><span class="pc">d</span><span class="c">e</span> <span class="c">%</span><span class="w">x</span><span class="c">\n</span><span class="w">";</span>
	<span class="w">cons</span><span class="c">t</span> <span class="c">char</span> <span class="w">fmt64[]</span><span class="pc"> =</span> <span class="w">K</span><span class="pc">ERN_I</span><span class="c">NFO</span> <span class="w">"</span><span class="pc">%</span><span class="c">s</span><span class="w">[</span><span class="pc">%d</span><span class="w">]:</span> <span class="pc">u</span><span class="c">nhandled</span> <span class="w">si</span><span class="pc">g</span><span class="c">nal</span> <span class="pc">%</span><span class="c">d</span> <span class="w">"</span><span class="pc"> </span><span class="c">\</span>
			<span class="pc">"</span><span class="w">at</span> <span class="c">%</span><span class="w">016lx</span> <span class="w">n</span><span class="pc">i</span><span class="c">p</span> <span class="c">%</span><span class="w">0</span><span class="pc">1</span><span class="c">6lx</span> <span class="w">l</span><span class="c">r</span> <span class="c">%</span><span class="w">0</span><span class="pc">1</span><span class="c">6lx</span> <span class="w">cod</span><span class="c">e</span> <span class="c">%</span><span class="pc">x</span><span class="c">\n</span><span class="w">";</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">user_mode</span><span class="c">(</span><span class="w">reg</span><span class="pc">s</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">die</span><span class="pc">("</span><span class="w">Exception</span> <span class="w">i</span><span class="pc">n</span> <span class="w">k</span><span class="pc">er</span><span class="c">nel</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="w">",</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">signr</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">show_unhandled_signals</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">unhandled_signal</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent,</span> <span class="w">s</span><span class="pc">i</span><span class="c">gnr)) {</span>
		<span class="w">printk_ratelimited</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="w">&amp;</span> <span class="w">MSR_64BIT</span> <span class="w">?</span> <span class="w">fmt64</span> <span class="c">:</span> <span class="w">fmt32</span><span class="pc">,</span>
				   <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">comm</span><span class="pc">,</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">pi</span><span class="c">d,</span> <span class="c">signr</span><span class="pc">,</span>
				   <span class="w">a</span><span class="c">ddr</span><span class="pc">,</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">re</span><span class="pc">g</span><span class="c">s-&gt;</span><span class="w">lin</span><span class="pc">k,</span> <span class="w">cod</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">arch_irqs_disabled() &amp;&amp; !arch_irq_disabled_regs</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">local_irq_enable(</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read</span><span class="pc">.</span><span class="w">trap_nr</span> <span class="c">=</span> <span class="w">cod</span><span class="pc">e</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">ems</span><span class="c">et(&amp;</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="c">0,</span> <span class="c">sizeof(</span><span class="pc">i</span><span class="c">nfo));</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">fo</span><span class="pc">.</span><span class="w">si_signo</span> <span class="c">=</span> <span class="w">signr</span><span class="c">;</span>
	<span class="c">info.</span><span class="w">si_code</span> <span class="c">=</span> <span class="w">cod</span><span class="c">e;</span>
	<span class="c">info.</span><span class="w">si_addr</span> <span class="pc">= (</span><span class="w">v</span><span class="c">oid</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*)</span> <span class="w">ad</span><span class="pc">d</span><span class="c">r;</span>
	<span class="w">force_sig_info</span><span class="pc">(</span><span class="w">s</span><span class="pc">ig</span><span class="c">nr</span><span class="pc">, &amp;</span><span class="c">info</span><span class="pc">,</span> <span class="w">cu</span><span class="pc">rre</span><span class="c">nt</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_PPC64</span>
<span class="w">v</span><span class="c">oid</span> <span class="w">system_reset_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">reg</span><span class="c">s</span><span class="pc">)</span>
<span class="c">{</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ppc_md.sy</span><span class="c">stem_reset_exception) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(ppc_md</span><span class="pc">.</span><span class="w">s</span><span class="pc">y</span><span class="c">stem_reset_exception</span><span class="w">(r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">)</span>
			<span class="c">return</span><span class="pc">;</span>
	<span class="pc">}</span>

	<span class="w">die(</span><span class="pc">"</span><span class="w">System</span> <span class="w">Reset"</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">,</span> <span class="w">SIGABRT</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="c">&amp;</span> <span class="w">MSR_RI</span><span class="c">))</span>
		<span class="w">panic(</span><span class="pc">"</span><span class="w">Unrecoverable</span> <span class="w">S</span><span class="pc">y</span><span class="c">stem</span> <span class="w">R</span><span class="c">eset");</span>

	
<span class="pc">}</span>


<span class="w">l</span><span class="pc">o</span><span class="c">ng</span> <span class="w">machine_check_early</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">l</span><span class="c">ong</span> <span class="w">handled</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">__this_cpu_inc</span><span class="c">(</span><span class="w">irq_stat.mce_exceptions</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">add_taint</span><span class="c">(</span><span class="w">TAINT_MACHINE_CHECK</span><span class="pc">,</span> <span class="w">LOCKDEP_NOW_UNRELIABLE</span><span class="c">);</span>

	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cur_cpu_spec</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">c</span><span class="c">ur_cpu_spec</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">ac</span><span class="c">hine_check_early</span><span class="pc">)</span>
		<span class="pc">h</span><span class="c">andled</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">u</span><span class="c">r_cpu_spec</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">a</span><span class="c">chine_check_early</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">h</span><span class="c">andled;</span>
<span class="c">}</span>

<span class="w">l</span><span class="c">ong</span> <span class="w">hmi_exception_realmode</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">__this_cpu_inc</span><span class="c">(</span><span class="w">irq_stat.hmi_exceptions</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ppc_md.hmi_exception_early</span><span class="c">)</span>
		<span class="pc">p</span><span class="c">pc_md</span><span class="pc">.h</span><span class="c">mi_exception_early</span><span class="w">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="pc">#</span><span class="c">endif</span>


<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">check_io_access</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_PPC32</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">ms</span><span class="pc">r</span> <span class="pc">=</span> <span class="pc">reg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="c">r;</span>
	<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">exception_table_entry</span> <span class="c">*</span><span class="w">en</span><span class="pc">tr</span><span class="c">y;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">*nip</span> <span class="w">=</span><span class="pc"> </span><span class="c">(unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">*</span><span class="pc">)</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">i</span><span class="c">p</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="w">((</span><span class="pc">(</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">&amp;</span> <span class="w">0xfff</span><span class="pc">f0</span><span class="c">000</span><span class="pc">) =</span><span class="c">=</span> <span class="pc">0</span> <span class="w">|</span><span class="pc">| (</span><span class="w">ms</span><span class="pc">r</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">0x80000</span> <span class="c">|</span> <span class="w">0x4</span><span class="pc">0000)))</span>
	    <span class="w">&amp;</span><span class="c">&amp; (</span><span class="w">en</span><span class="pc">t</span><span class="c">ry</span> <span class="pc">=</span> <span class="w">search_exception_tables</span><span class="c">(</span><span class="w">re</span><span class="pc">g</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ip</span><span class="w">)) </span><span class="pc">!</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="c">if</span> <span class="pc">(*</span><span class="c">nip</span> <span class="c">==</span> <span class="w">0x60000000</span><span class="c">)</span>		
			<span class="pc">n</span><span class="c">ip</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">2</span><span class="c">;</span>
		<span class="c">else</span> <span class="c">if</span> <span class="pc">(*</span><span class="c">nip</span> <span class="c">==</span> <span class="w">0x4c00012c</span><span class="pc">)</span>	
			<span class="w">--n</span><span class="c">ip</span><span class="w">;</span>
		<span class="c">if</span> <span class="pc">(*n</span><span class="c">ip</span> <span class="c">==</span> <span class="w">0x7c0004ac</span> <span class="w">|| (*</span><span class="c">nip</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">26) </span><span class="pc">=</span><span class="c">=</span> <span class="w">3</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rb</span><span class="pc">;</span>

			<span class="w">-</span><span class="c">-</span><span class="w">n</span><span class="c">ip</span><span class="pc">;</span>
			<span class="w">rb</span> <span class="w">= (*n</span><span class="c">ip</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">11</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">0x1</span><span class="pc">f</span><span class="c">;</span>
			<span class="w">p</span><span class="pc">r</span><span class="c">intk(</span><span class="pc">KERN_D</span><span class="c">EBUG</span> <span class="pc">"%</span><span class="c">s</span> <span class="w">b</span><span class="pc">a</span><span class="c">d</span> <span class="w">p</span><span class="c">ort</span> <span class="c">%</span><span class="w">l</span><span class="pc">x</span> <span class="w">a</span><span class="pc">t</span> <span class="c">%</span><span class="pc">p</span><span class="c">\n",</span>
			       <span class="w">(</span><span class="pc">*</span><span class="c">nip</span> <span class="w">&amp;</span> <span class="w">0x10</span><span class="pc">0</span><span class="w">)? "OUT</span> <span class="w">t</span><span class="pc">o</span><span class="w">": "IN</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span><span class="w">"</span><span class="pc">,</span>
			       <span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">r</span><span class="pc">b</span><span class="w">] -</span> <span class="w">_IO_BASE</span><span class="pc">,</span> <span class="w">n</span><span class="c">ip);</span>
			<span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="w">|</span><span class="c">=</span> <span class="w">MSR_RI</span><span class="c">;</span>
			<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">n</span><span class="c">ip</span> <span class="pc">=</span> <span class="w">ent</span><span class="pc">r</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fixup</span><span class="c">;</span>
			<span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="pc">1</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="w">}</span>
<span class="w">#</span><span class="c">endif</span> 
	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_PPC_ADV_DEBUG_REGS</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">get_reason</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="w">)</span><span class="pc">	((</span><span class="w">r</span><span class="c">egs)-&gt;</span><span class="w">dsisr</span><span class="c">)</span>
<span class="c">#</span><span class="w">i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">CONFIG_FSL_BOOKE</span>
<span class="c">#define</span> <span class="w">get_mc_reason</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="w">)</span><span class="pc">	((r</span><span class="c">egs)-&gt;</span><span class="pc">d</span><span class="c">sisr)</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
<span class="c">#define</span> <span class="c">get_mc_reason(regs</span><span class="pc">)	(</span><span class="w">mfspr</span><span class="c">(</span><span class="w">SPRN_MCSR</span><span class="pc">))</span>
<span class="c">#endif</span>
<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">REASON_FP</span>		<span class="w">ESR_FP</span>
<span class="c">#define</span> <span class="w">REASON_ILLEGAL</span>		<span class="c">(</span><span class="w">ESR_PIL</span> <span class="c">|</span> <span class="w">ESR_PUO</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">REASON_PRIVILEGED</span>	<span class="w">ESR_PPR</span>
<span class="c">#define</span> <span class="w">REASON_TRAP</span>		<span class="w">ESR_PTR</span>


<span class="c">#define</span> <span class="w">single_stepping</span><span class="c">(</span><span class="w">re</span><span class="pc">gs</span><span class="w">)</span><span class="pc">	(</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read</span><span class="w">.de</span><span class="pc">b</span><span class="c">ug</span><span class="pc">.</span><span class="w">dbcr0</span> <span class="w">&amp;</span> <span class="w">DBCR0_IC</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">clear_single_step</span><span class="c">(</span><span class="w">re</span><span class="pc">gs</span><span class="w">)</span><span class="pc">	(</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">d</span><span class="pc">eb</span><span class="c">ug</span><span class="pc">.</span><span class="c">dbcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="pc">D</span><span class="c">BCR0_IC)</span>

<span class="c">#</span><span class="pc">el</span><span class="c">se</span>

<span class="c">#define</span> <span class="w">get_reason</span><span class="c">(</span><span class="w">r</span><span class="pc">egs)	</span><span class="c">((</span><span class="w">r</span><span class="pc">egs</span><span class="c">)-&gt;</span><span class="w">ms</span><span class="pc">r</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">get_mc_reason</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)	(</span><span class="c">(regs)-&gt;</span><span class="w">ms</span><span class="c">r)</span>
<span class="c">#define</span> <span class="w">REASON_TM</span>		<span class="w">0x200000</span>
<span class="c">#define</span> <span class="w">REASON_FP</span>		<span class="w">0x100</span><span class="pc">000</span>
<span class="c">#define</span> <span class="w">REASON_ILLEGAL</span>		<span class="w">0x80000</span>
<span class="c">#define</span> <span class="w">REASON_PRIVILEGED</span>	<span class="w">0x4</span><span class="c">0000</span>
<span class="c">#define</span> <span class="w">REASON_TRAP</span>		<span class="w">0x200</span><span class="pc">00</span>

<span class="c">#define</span> <span class="w">single_stepping</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)	(</span><span class="c">(regs)-&gt;</span><span class="w">ms</span><span class="c">r</span> <span class="w">&amp;</span> <span class="w">MSR_SE</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">clear_single_step</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)	((</span><span class="c">regs)-&gt;</span><span class="w">ms</span><span class="c">r</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~MSR_SE)</span>
<span class="c">#</span><span class="pc">e</span><span class="c">ndif</span>

<span class="c">#</span><span class="pc">if</span> <span class="pc">d</span><span class="c">efined(</span><span class="w">CONFIG_4xx</span><span class="pc">)</span>
<span class="w">i</span><span class="c">nt</span> <span class="w">machine_check_4xx</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">unsigned</span> <span class="c">long</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">=</span> <span class="w">get_mc_reason</span><span class="pc">(r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">ESR_IMCP</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Instruction"</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_ESR</span><span class="pc">,</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">~</span><span class="pc">E</span><span class="c">SR_IMCP);</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span>
		<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Data"</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span> <span class="w">ma</span><span class="pc">c</span><span class="c">hine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">i</span><span class="c">n</span> <span class="w">k</span><span class="c">ernel</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="pc">.</span><span class="c">\n");</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">machine_check_440A</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="w">re</span><span class="pc">a</span><span class="c">son</span> <span class="pc">=</span> <span class="w">get_mc_reason</span><span class="pc">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Machine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">i</span><span class="pc">n</span> <span class="w">k</span><span class="pc">er</span><span class="c">nel</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="w">.</span><span class="pc">\</span><span class="c">n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">ESR_IMCP){</span>
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Instruction</span> <span class="w">Synchronous</span> <span class="w">M</span><span class="c">achine</span> <span class="w">Check</span> <span class="w">exception</span><span class="c">\n");</span>
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_ESR</span><span class="pc">,</span> <span class="w">rea</span><span class="c">son</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">~</span><span class="w">E</span><span class="c">SR_IMCP);</span>
	<span class="pc">}</span>
	<span class="c">else</span> <span class="c">{</span>
		<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">mcsr</span> <span class="c">=</span> <span class="w">mfspr</span><span class="pc">(</span><span class="w">SPRN_MCSR</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(mcsr</span> <span class="pc">&amp;</span> <span class="w">MCSR_IB</span><span class="c">)</span>
			<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">I</span><span class="pc">ns</span><span class="c">truction</span> <span class="w">Read</span> <span class="w">PLB</span> <span class="w">E</span><span class="pc">r</span><span class="c">ror\n");</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">csr</span> <span class="c">&amp;</span> <span class="w">MCSR_DRB</span><span class="c">)</span>
			<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Data</span> <span class="w">R</span><span class="c">ead</span> <span class="w">P</span><span class="pc">L</span><span class="c">B</span> <span class="w">E</span><span class="pc">r</span><span class="c">ror\n");</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_DWB</span><span class="c">)</span>
			<span class="c">printk</span><span class="pc">("</span><span class="w">D</span><span class="c">ata</span> <span class="w">Write</span> <span class="pc">P</span><span class="c">LB</span> <span class="w">E</span><span class="c">rror\n</span><span class="pc">")</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_TLBP</span><span class="c">)</span>
			<span class="c">printk</span><span class="pc">("</span><span class="w">TLB</span> <span class="w">Parity</span> <span class="w">E</span><span class="c">rror\n");</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">csr</span> <span class="c">&amp;</span> <span class="w">MCSR_ICP){</span>
			<span class="w">flush_instruction_cache(</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">I</span><span class="pc">-</span><span class="w">Cache</span> <span class="w">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror</span><span class="pc">\</span><span class="c">n");</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="pc">&amp;</span> <span class="w">MCSR_DCSP</span><span class="pc">)</span>
			<span class="c">printk</span><span class="pc">("</span><span class="w">D</span><span class="pc">-C</span><span class="c">ache</span> <span class="w">Search</span> <span class="pc">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror</span><span class="pc">\</span><span class="c">n");</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_DCFP</span><span class="c">)</span>
			<span class="c">printk</span><span class="pc">("</span><span class="w">D</span><span class="pc">-</span><span class="w">C</span><span class="pc">ac</span><span class="c">he</span> <span class="w">Flush</span> <span class="w">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror\n");</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_IMPE</span><span class="c">)</span>
			<span class="c">printk</span><span class="pc">("</span><span class="w">Machine</span> <span class="w">Check</span> <span class="w">exception</span> <span class="w">i</span><span class="c">s</span> <span class="w">imprecise</span><span class="c">\n");</span>

		
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_MCSR</span><span class="pc">,</span> <span class="c">mcsr</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">machine_check_47x</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">=</span> <span class="w">get_mc_reason</span><span class="pc">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">m</span><span class="c">csr</span><span class="pc">;</span>

	<span class="w">pr</span><span class="pc">in</span><span class="c">tk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">Machine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">i</span><span class="pc">n</span> <span class="w">k</span><span class="pc">er</span><span class="c">nel</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="pc">.</span><span class="c">\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">ESR_IMCP</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">printk(</span><span class="pc">KERN_E</span><span class="c">RR</span>
		       <span class="c">"</span><span class="w">Instruction</span> <span class="w">Synchronous</span> <span class="w">M</span><span class="c">achine</span> <span class="w">Check</span> <span class="w">exception</span><span class="c">\n");</span>
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_ESR</span><span class="pc">,</span> <span class="w">rea</span><span class="c">son</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">E</span><span class="c">SR_IMCP);</span>
		<span class="w">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">mcsr</span> <span class="pc">=</span> <span class="w">mfspr</span><span class="c">(</span><span class="w">SPRN_MCSR</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(mcsr</span> <span class="pc">&amp;</span> <span class="w">MCSR_IB</span><span class="pc">)</span>
		<span class="w">p</span><span class="c">rintk(KERN_ERR</span> <span class="c">"</span><span class="pc">I</span><span class="c">nstruction</span> <span class="w">Read</span> <span class="w">PLB</span> <span class="w">E</span><span class="pc">r</span><span class="c">ror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_DRB</span><span class="c">)</span>
		<span class="pc">p</span><span class="c">rintk(KERN_ERR</span> <span class="c">"</span><span class="w">Data</span> <span class="pc">R</span><span class="c">ead</span> <span class="w">P</span><span class="c">LB</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_DWB</span><span class="c">)</span>
		<span class="c">printk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"Data</span> <span class="w">Write</span> <span class="w">P</span><span class="c">LB</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_TLBP</span><span class="c">)</span>
		<span class="c">printk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">TLB</span> <span class="w">Parity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">MCSR_ICP</span><span class="c">) {</span>
		<span class="w">flush_instruction_cache(</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">p</span><span class="c">rintk(KERN_ERR</span> <span class="c">"</span><span class="w">I</span><span class="pc">-</span><span class="w">Cache</span> <span class="w">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="pc">&amp;</span> <span class="w">MCSR_DCSP</span><span class="pc">)</span>
		<span class="c">printk(KERN_ERR</span> <span class="pc">"</span><span class="w">D</span><span class="pc">-</span><span class="w">C</span><span class="c">ache</span> <span class="w">Search</span> <span class="w">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">PPC47x_MCSR_GPR</span><span class="c">)</span>
		<span class="c">printk(KERN_ERR</span> <span class="c">"</span><span class="w">GPR</span> <span class="w">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">csr</span> <span class="c">&amp;</span> <span class="w">PPC47x_MCSR_FPR</span><span class="pc">)</span>
		<span class="c">printk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">FPR</span> <span class="pc">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mcsr</span> <span class="c">&amp;</span> <span class="w">PPC47x_MCSR_IPR</span><span class="c">)</span>
		<span class="c">printk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">Machine</span> <span class="w">Check</span> <span class="w">exception</span> <span class="w">i</span><span class="c">s</span> <span class="w">imprecise</span><span class="c">\n");</span>

	
	<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_MCSR</span><span class="c">,</span> <span class="c">mcsr);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>
<span class="pc">#</span><span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="c">defined(</span><span class="w">CONFIG_E500</span><span class="c">)</span>
<span class="pc">i</span><span class="c">nt</span> <span class="w">machine_check_e500mc</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">m</span><span class="c">csr</span> <span class="pc">=</span> <span class="w">mfspr</span><span class="c">(</span><span class="w">S</span><span class="c">PRN_MCSR</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">=</span> <span class="w">mc</span><span class="c">sr;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">recoverable</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">MCSR_LD</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">r</span><span class="c">ecoverable</span> <span class="c">=</span> <span class="w">fsl_rio_mcheck_exception</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(recoverable</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">1</span><span class="c">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">silent_out</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">p</span><span class="pc">rin</span><span class="c">tk</span><span class="pc">("</span><span class="w">Machine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">i</span><span class="pc">n</span> <span class="w">k</span><span class="pc">er</span><span class="c">nel</span> <span class="w">m</span><span class="c">ode</span><span class="w">.</span><span class="c">\n");</span>
	<span class="w">p</span><span class="c">rintk("</span><span class="w">Caused</span> <span class="w">by</span> <span class="w">(fr</span><span class="c">om</span> <span class="w">MCSR=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="w">): ",</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span><span class="w">)</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="pc">&amp;</span> <span class="w">MCSR_MCP</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">M</span><span class="pc">a</span><span class="c">chine</span> <span class="w">Check</span> <span class="w">Signal</span><span class="c">\n");</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_ICPERR</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">printk("</span><span class="w">Instruction</span> <span class="w">Cache</span> <span class="w">Parity</span> <span class="w">E</span><span class="c">rror\n");</span>

		
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_L1CSR1</span><span class="pc">,</span> <span class="w">mfspr</span><span class="pc">(S</span><span class="c">PRN_L1CSR1</span><span class="w">) </span><span class="c">|</span> <span class="w">L1CSR1_ICFI</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">m</span><span class="pc">f</span><span class="c">spr</span><span class="w">(S</span><span class="c">PRN_L1CSR1</span><span class="w">) </span><span class="pc">&amp;</span> <span class="w">L</span><span class="c">1CSR1_ICFI</span><span class="w">)</span>
			<span class="w">;</span>

		
		<span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">MCSR_IF</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="c">&amp;</span> <span class="w">MCSR_DCPERR_MC</span><span class="c">) {</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Data</span> <span class="w">C</span><span class="c">ache</span> <span class="w">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror\n");</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(m</span><span class="c">fspr</span><span class="pc">(</span><span class="w">SPRN_L1CSR2</span><span class="c">) &amp;</span> <span class="w">L1CSR2_DCWS</span><span class="c">))</span>
			<span class="w">recoverable</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_L2MMU_MHIT</span><span class="c">) {</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Hit</span> <span class="w">o</span><span class="pc">n</span> <span class="w">multiple</span> <span class="w">TLB</span> <span class="w">ent</span><span class="pc">ri</span><span class="c">es\n");</span>
		<span class="w">r</span><span class="pc">ec</span><span class="c">overable</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">MCSR_NMI</span><span class="pc">)</span>
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Non-maskable</span> <span class="w">in</span><span class="pc">terr</span><span class="c">upt</span><span class="pc">\</span><span class="c">n");</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_IF</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Instruction</span> <span class="w">Fetch</span> <span class="w">E</span><span class="c">rror</span> <span class="w">Report</span><span class="pc">\</span><span class="c">n");</span>
		<span class="w">r</span><span class="pc">ec</span><span class="c">overable</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_LD</span><span class="c">) {</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Load</span> <span class="w">E</span><span class="c">rror</span> <span class="w">R</span><span class="pc">e</span><span class="c">port</span><span class="pc">\</span><span class="c">n");</span>
		<span class="w">r</span><span class="pc">ec</span><span class="c">overable</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">MCSR_ST</span><span class="c">) {</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Store</span> <span class="w">E</span><span class="c">rror</span> <span class="w">R</span><span class="c">eport\n");</span>
		<span class="w">r</span><span class="pc">ec</span><span class="c">overable</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">MCSR_LDG</span><span class="c">) {</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Guarded</span> <span class="w">L</span><span class="c">oad</span> <span class="w">E</span><span class="c">rror</span> <span class="w">R</span><span class="c">eport</span><span class="pc">\</span><span class="c">n");</span>
		<span class="w">r</span><span class="pc">ec</span><span class="c">overable</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_TLBSYNC</span><span class="pc">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Simultaneous</span> <span class="w">tlbsync</span> <span class="w">operations</span><span class="c">\n");</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_BSL2_ERR</span><span class="c">) {</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Level</span> <span class="w">2</span> <span class="w">Cache</span> <span class="w">E</span><span class="c">rror\n");</span>
		<span class="w">r</span><span class="pc">ec</span><span class="c">overable</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_MAV</span><span class="c">) {</span>
		<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">a</span><span class="c">ddr</span><span class="pc">;</span>

		<span class="w">a</span><span class="c">ddr</span> <span class="c">=</span> <span class="w">mfspr</span><span class="c">(</span><span class="w">SPRN_MCAR</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">a</span><span class="c">ddr</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">u</span><span class="pc">6</span><span class="c">4)</span><span class="w">mf</span><span class="c">spr</span><span class="pc">(</span><span class="w">SPRN_MCARU) &lt;</span><span class="c">&lt;</span> <span class="w">3</span><span class="c">2</span><span class="w">;</span>

		<span class="w">p</span><span class="pc">r</span><span class="c">intk</span><span class="pc">("</span><span class="w">Machine</span> <span class="w">Check</span> <span class="pc">%s</span> <span class="w">Address: %#ll</span><span class="pc">x</span><span class="c">\n",</span>
		       <span class="w">rea</span><span class="c">son</span> <span class="w">&amp;</span> <span class="w">MCSR_MEA</span> <span class="w">?</span><span class="pc"> </span><span class="c">"</span><span class="w">Effective</span><span class="c">" : "</span><span class="w">Physical</span><span class="pc">",</span> <span class="pc">a</span><span class="c">ddr</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

<span class="w">silent_out:</span>
	<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_MCSR</span><span class="c">,</span> <span class="w">mcsr</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">m</span><span class="pc">f</span><span class="c">spr</span><span class="pc">(S</span><span class="c">PRN_MCSR</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">recoverable;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">machine_check_e500</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="c">long</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">=</span> <span class="w">get_mc_reason</span><span class="pc">(</span><span class="w">r</span><span class="pc">egs</span><span class="c">);</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">MCSR_BUS_RBERR</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">fsl_rio_mcheck_exception</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">)</span>
			<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">fsl_pci_mcheck_exception</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s))</span>
			<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">p</span><span class="pc">rin</span><span class="c">tk</span><span class="pc">("</span><span class="w">Machine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">i</span><span class="pc">n</span> <span class="w">k</span><span class="pc">er</span><span class="c">nel</span> <span class="w">m</span><span class="c">ode</span><span class="w">.</span><span class="c">\n");</span>
	<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Caused</span> <span class="w">by</span> <span class="w">(f</span><span class="pc">r</span><span class="c">om</span> <span class="w">MCSR=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="w">): ",</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span><span class="w">)</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_MCP</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">M</span><span class="pc">a</span><span class="c">chine</span> <span class="w">Check</span> <span class="w">Signal</span><span class="c">\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_ICPERR</span><span class="c">)</span>
		<span class="c">printk("</span><span class="w">Instruction</span> <span class="w">Cache</span> <span class="w">Parity</span> <span class="w">E</span><span class="c">rror</span><span class="pc">\</span><span class="c">n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="pc">&amp;</span> <span class="w">MCSR_DCP_PERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Data</span> <span class="w">C</span><span class="c">ache</span> <span class="w">Push</span> <span class="w">P</span><span class="c">arity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="c">&amp;</span> <span class="w">MCSR_DCPERR</span><span class="pc">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">D</span><span class="c">ata</span> <span class="w">C</span><span class="c">ache</span> <span class="w">P</span><span class="pc">a</span><span class="c">rity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_BUS_IAERR</span><span class="pc">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">Bus</span> <span class="w">-</span> <span class="w">Instruction</span> <span class="w">Address</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="c">&amp;</span> <span class="w">MCSR_BUS_RAERR</span><span class="pc">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">B</span><span class="c">us</span> <span class="pc">-</span> <span class="w">Read</span> <span class="w">A</span><span class="c">ddress</span> <span class="w">E</span><span class="c">rror</span><span class="pc">\</span><span class="c">n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="c">&amp;</span> <span class="w">MCSR_BUS_WAERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="c">Bus</span> <span class="pc">-</span> <span class="w">Write</span> <span class="pc">A</span><span class="c">ddress</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="c">&amp;</span> <span class="w">MCSR_BUS_IBERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="c">Bus</span> <span class="pc">-</span> <span class="w">Instruction</span> <span class="w">Data</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="c">&amp;</span> <span class="w">MCSR_BUS_RBERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="c">Bus</span> <span class="pc">-</span> <span class="w">Read</span> <span class="w">D</span><span class="c">ata</span> <span class="w">B</span><span class="c">us</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_BUS_WBERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">B</span><span class="c">us</span> <span class="pc">-</span> <span class="w">Write</span> <span class="w">D</span><span class="c">ata</span> <span class="w">B</span><span class="c">us</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="pc">&amp;</span> <span class="w">MCSR_BUS_IPERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("B</span><span class="c">us</span> <span class="pc">-</span> <span class="w">Instruction</span> <span class="w">Parity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_BUS_RPERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="c">Bus</span> <span class="pc">-</span> <span class="w">Read</span> <span class="w">P</span><span class="pc">a</span><span class="c">rity</span> <span class="w">E</span><span class="c">rror\n");</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">machine_check_generic</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>
<span class="pc">#</span><span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="c">defined(</span><span class="w">CONFIG_E200</span><span class="c">)</span>
<span class="pc">i</span><span class="c">nt</span> <span class="w">machine_check_e200</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">=</span> <span class="w">get_mc_reason</span><span class="pc">(</span><span class="w">r</span><span class="c">egs);</span>

	<span class="w">pr</span><span class="pc">in</span><span class="c">tk</span><span class="pc">("</span><span class="w">Machine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">i</span><span class="c">n</span> <span class="w">k</span><span class="c">ernel</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="w">.</span><span class="pc">\</span><span class="c">n");</span>
	<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Caused</span> <span class="w">by</span> <span class="w">(f</span><span class="pc">r</span><span class="c">om</span> <span class="w">MCSR=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="w">): ",</span> <span class="w">rea</span><span class="c">son</span><span class="w">)</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">MCSR_MCP</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">M</span><span class="pc">a</span><span class="c">chine</span> <span class="w">Check</span> <span class="w">Signal</span><span class="c">\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_CP_PERR</span><span class="c">)</span>
		<span class="c">printk("</span><span class="w">Cache</span> <span class="w">Push</span> <span class="w">Parity</span> <span class="w">E</span><span class="c">rror</span><span class="pc">\</span><span class="c">n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="pc">&amp;</span> <span class="w">MCSR_CPERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">C</span><span class="pc">ac</span><span class="c">he</span> <span class="w">P</span><span class="pc">a</span><span class="c">rity</span> <span class="w">E</span><span class="c">rror\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_EXCP_ERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">ISI,</span> <span class="w">ITLB</span><span class="pc">,</span> <span class="w">or</span> <span class="w">Bus</span> <span class="w">E</span><span class="c">rror</span> <span class="w">o</span><span class="pc">n</span> <span class="w">fi</span><span class="pc">rs</span><span class="c">t</span> <span class="w">instruction</span> <span class="w">fetch</span> <span class="w">f</span><span class="c">or</span> <span class="w">an</span> <span class="w">exception</span> <span class="w">ha</span><span class="pc">n</span><span class="c">dler\n");</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="pc">&amp;</span> <span class="w">MCSR_BUS_IRERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">B</span><span class="c">us</span> <span class="w">-</span> <span class="w">Read</span> <span class="pc">B</span><span class="c">us</span> <span class="w">E</span><span class="c">rror</span> <span class="w">o</span><span class="pc">n</span> <span class="w">i</span><span class="pc">ns</span><span class="c">truction</span> <span class="pc">f</span><span class="c">etch\n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_BUS_DRERR</span><span class="c">)</span>
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("B</span><span class="c">us</span> <span class="pc">-</span> <span class="pc">R</span><span class="c">ead</span> <span class="w">B</span><span class="c">us</span> <span class="w">E</span><span class="c">rror</span> <span class="w">o</span><span class="pc">n</span> <span class="w">da</span><span class="c">ta</span> <span class="w">load</span><span class="c">\n");</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">&amp;</span> <span class="w">MCSR_BUS_WRERR</span><span class="c">)</span>
		<span class="c">printk</span><span class="pc">("</span><span class="c">Bus</span> <span class="pc">-</span> <span class="w">Write</span> <span class="c">Bus</span> <span class="w">E</span><span class="c">rror</span> <span class="w">o</span><span class="pc">n</span> <span class="w">buffered</span> <span class="w">store</span> <span class="w">o</span><span class="pc">r</span> <span class="w">cac</span><span class="c">he</span> <span class="w">li</span><span class="pc">ne</span> <span class="w">push</span><span class="pc">\</span><span class="c">n");</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>
<span class="pc">#el</span><span class="c">se</span>
<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">machine_check_generic</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">=</span> <span class="w">get_mc_reason</span><span class="pc">(</span><span class="w">r</span><span class="c">egs);</span>

	<span class="w">p</span><span class="pc">r</span><span class="c">intk</span><span class="pc">("</span><span class="w">Machine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">i</span><span class="c">n</span> <span class="w">k</span><span class="c">ernel</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="w">.</span><span class="c">\n");</span>
	<span class="w">p</span><span class="pc">r</span><span class="c">intk</span><span class="pc">("</span><span class="w">Caused</span> <span class="w">by</span> <span class="w">(f</span><span class="pc">r</span><span class="c">om</span> <span class="w">SRR1=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="w">): ",</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span><span class="w">)</span><span class="pc">;</span>
	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">rea</span><span class="c">son</span> <span class="pc">&amp;</span> <span class="w">0x601F0000</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">0x80000</span><span class="c">:</span>
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">M</span><span class="c">achine</span> <span class="w">che</span><span class="c">ck</span> <span class="w">si</span><span class="pc">g</span><span class="c">nal\n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">0</span><span class="c">:</span>		
	<span class="pc">c</span><span class="c">ase</span> <span class="w">0x40</span><span class="pc">000</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">0x140000</span><span class="c">:</span>	
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Transfer</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="w">ack</span> <span class="w">si</span><span class="pc">g</span><span class="c">nal\n");</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">0x20</span><span class="pc">000</span><span class="c">:</span>
		<span class="c">printk("</span><span class="w">Data</span> <span class="w">parity</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="w">si</span><span class="pc">g</span><span class="c">nal\n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">0x10</span><span class="pc">000</span><span class="c">:</span>
		<span class="c">printk("</span><span class="w">Address</span> <span class="w">p</span><span class="pc">ar</span><span class="c">ity</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="w">si</span><span class="pc">g</span><span class="c">nal\n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">0x20</span><span class="pc">00</span><span class="c">0000:</span>
		<span class="c">printk("</span><span class="w">L1</span> <span class="pc">D</span><span class="c">ata</span> <span class="w">Cache</span> <span class="w">e</span><span class="c">rror\n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">0x4</span><span class="pc">00</span><span class="c">00000:</span>
		<span class="c">printk("</span><span class="pc">L</span><span class="c">1</span> <span class="w">Instruction</span> <span class="w">C</span><span class="c">ache</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror\n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">0x00100000</span><span class="c">:</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">L2</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span> <span class="w">cac</span><span class="c">he</span> <span class="w">parity</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror\n");</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="c">printk("</span><span class="pc">Unk</span><span class="c">nown</span> <span class="w">values</span> <span class="w">i</span><span class="c">n</span> <span class="w">ms</span><span class="pc">r</span><span class="c">\n");</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span> 

<span class="w">v</span><span class="c">oid</span> <span class="w">machine_check_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">ctx_state</span> <span class="w">prev_state</span> <span class="pc">=</span> <span class="w">exception_enter</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">recover</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">__this_cpu_inc</span><span class="c">(</span><span class="w">irq_stat.mce_exceptions</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">if</span> <span class="c">(</span><span class="w">ppc_md.ma</span><span class="pc">c</span><span class="c">hine_check_exception</span><span class="pc">)</span>
		<span class="w">r</span><span class="pc">ec</span><span class="c">over</span> <span class="c">=</span> <span class="c">ppc_md</span><span class="pc">.</span><span class="w">m</span><span class="pc">ac</span><span class="c">hine_check_exception</span><span class="w">(r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cur_cpu_spec-</span><span class="c">&gt;</span><span class="w">machine_check</span><span class="pc">)</span>
		<span class="pc">rec</span><span class="c">over</span> <span class="pc">=</span> <span class="c">cur_cpu_spec</span><span class="pc">-</span><span class="c">&gt;machine_check</span><span class="pc">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">ecover</span> <span class="pc">&gt;</span> <span class="c">0)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

<span class="w">#</span><span class="pc">if</span> <span class="pc">d</span><span class="c">efined(</span><span class="w">CONFIG_8xx</span><span class="pc">) &amp;</span><span class="c">&amp;</span> <span class="c">defined(</span><span class="w">CONFIG_PCI</span><span class="c">)</span>
	
	<span class="w">bad_page_fault</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">dar</span><span class="c">,</span> <span class="w">SIGBUS</span><span class="c">);</span>
	<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
<span class="w">#</span><span class="c">endif</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">debugger_fault_handler</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">check_io_access</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

	<span class="w">die(</span><span class="pc">"</span><span class="w">Machine</span> <span class="w">che</span><span class="pc">ck</span><span class="w">"</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">,</span> <span class="w">S</span><span class="c">IGBUS);</span>

	
	<span class="c">if</span> <span class="pc">(!(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="c">&amp;</span> <span class="w">MSR_RI</span><span class="c">))</span>
		<span class="w">panic(</span><span class="pc">"</span><span class="w">Unrecoverable</span> <span class="w">M</span><span class="pc">a</span><span class="c">chine</span> <span class="w">che</span><span class="pc">ck</span><span class="c">");</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">SMIException</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">d</span><span class="pc">i</span><span class="c">e</span><span class="pc">("</span><span class="w">System</span> <span class="w">Management</span> <span class="w">Interrupt</span><span class="pc">",</span> <span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">SIGABRT</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">handle_hmi_exception</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="w">old_regs</span><span class="c">;</span>

	<span class="w">o</span><span class="c">ld_regs</span> <span class="c">=</span> <span class="w">set_irq_regs</span><span class="c">(</span><span class="pc">r</span><span class="c">egs);</span>
	<span class="w">irq_enter</span><span class="pc">()</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">ppc_md.h</span><span class="pc">a</span><span class="c">ndle_hmi_exception</span><span class="pc">)</span>
		<span class="w">p</span><span class="pc">p</span><span class="c">c_md</span><span class="pc">.</span><span class="w">h</span><span class="c">andle_hmi_exception</span><span class="w">(</span><span class="pc">r</span><span class="c">egs</span><span class="w">)</span><span class="pc">;</span>

	<span class="w">irq_exit(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="c">et_irq_regs</span><span class="pc">(o</span><span class="c">ld_regs);</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">unknown_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">ctx_state</span> <span class="w">prev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">pr</span><span class="pc">in</span><span class="c">tk</span><span class="pc">("</span><span class="w">Bad</span> <span class="w">trap</span> <span class="w">a</span><span class="pc">t</span> <span class="w">PC:</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">x,</span> <span class="w">SR:</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">x,</span> <span class="w">ve</span><span class="pc">c</span><span class="c">tor</span><span class="pc">=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span>
	       <span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r,</span> <span class="pc">r</span><span class="c">egs-&gt;</span><span class="w">t</span><span class="pc">r</span><span class="c">ap);</span>

	<span class="w">_exception</span><span class="c">(</span><span class="w">SIGTRAP</span><span class="c">,</span> <span class="pc">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">0</span><span class="c">,</span> <span class="c">0);</span>

	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">instruction_breakpoint_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="pc">n</span><span class="c">um</span> <span class="w">ctx_state</span> <span class="pc">p</span><span class="c">rev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">notify_die</span><span class="c">(</span><span class="w">DIE_IABR_MATCH</span><span class="pc">, "</span><span class="w">iabr_match</span><span class="c">",</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">5</span><span class="c">,</span>
					<span class="w">5</span><span class="c">,</span> <span class="w">SIGTRAP) </span><span class="pc">=</span><span class="c">=</span> <span class="w">NOTIFY_STOP</span><span class="pc">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="c">ail;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">debugger_iabr_match</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="w">_exception</span><span class="c">(</span><span class="w">S</span><span class="c">IGTRAP,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">TRAP_BRKPT</span><span class="pc">,</span> <span class="pc">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">);</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">RunModeException</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">_</span><span class="pc">e</span><span class="c">xception(SIGTRAP,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="c">0);</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">__kprobes</span> <span class="w">single_step_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">ctx_state</span> <span class="w">p</span><span class="c">rev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">clear_single_step</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">notify_die</span><span class="c">(</span><span class="w">DIE_SSTEP,</span><span class="pc"> "</span><span class="w">single_step</span><span class="pc">",</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">5</span><span class="c">,</span>
					<span class="w">5</span><span class="pc">,</span> <span class="w">SIGTRAP) </span><span class="pc">=</span><span class="c">=</span> <span class="w">NOTIFY_STOP</span><span class="pc">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">debugger_sstep</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

	<span class="w">_exception</span><span class="c">(</span><span class="pc">S</span><span class="c">IGTRAP,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">TRAP_TRACE</span><span class="pc">,</span> <span class="c">regs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">);</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">emulate_single_step</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">single_stepping</span><span class="c">(regs</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">single_step_exception</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">__parse_fpscr</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">fpscr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">et</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">f</span><span class="c">pscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_VE) </span><span class="pc">&amp;&amp; </span><span class="c">(</span><span class="w">f</span><span class="c">pscr</span> <span class="pc">&amp;</span> <span class="w">FPSCR_VX</span><span class="c">))</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">FPE_FLTINV</span><span class="pc">;</span>

	
	<span class="c">else</span> <span class="c">if</span> <span class="pc">((</span><span class="c">fpscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_OE</span><span class="pc">) &amp;&amp; </span><span class="c">(fpscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_OX</span><span class="c">))</span>
		<span class="pc">ret</span> <span class="c">=</span> <span class="w">FPE_FLTOVF</span><span class="pc">;</span>

	
	<span class="c">else</span> <span class="c">if</span> <span class="pc">((f</span><span class="c">pscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_UE</span><span class="pc">) &amp;&amp; </span><span class="c">(</span><span class="pc">f</span><span class="c">pscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_UX</span><span class="c">))</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">FPE_FLTUND</span><span class="c">;</span>

	
	<span class="c">else</span> <span class="c">if</span> <span class="pc">((</span><span class="c">fpscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_ZE) </span><span class="pc">&amp;&amp; </span><span class="c">(fpscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_ZX</span><span class="c">))</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">FPE_FLTDIV</span><span class="c">;</span>

	
	<span class="c">else</span> <span class="c">if</span> <span class="pc">((</span><span class="c">fpscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_XE) </span><span class="pc">&amp;&amp; </span><span class="c">(fpscr</span> <span class="c">&amp;</span> <span class="w">FPSCR_XX</span><span class="c">))</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">FPE_FLTRES</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">parse_fpe</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*</span><span class="w">r</span><span class="c">egs)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">cod</span><span class="c">e</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">flush_fp_to_thread</span><span class="pc">(</span><span class="w">cu</span><span class="pc">rr</span><span class="c">ent);</span>

	<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">__parse_fpscr</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">fp_state</span><span class="pc">.</span><span class="w">fpscr</span><span class="c">);</span>

	<span class="w">_exception</span><span class="c">(</span><span class="w">SIGFPE</span><span class="c">,</span> <span class="w">re</span><span class="pc">gs,</span> <span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">emulate_string_inst</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">instword</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">rT</span> <span class="pc">= </span><span class="c">(</span><span class="w">i</span><span class="c">nstword</span> <span class="c">&gt;&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="c">f;</span>
	<span class="pc">u8</span> <span class="w">rA</span> <span class="pc">= </span><span class="c">(</span><span class="pc">i</span><span class="c">nstword</span> <span class="c">&gt;&gt;</span> <span class="pc">16</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="pc">f</span><span class="c">;</span>
	<span class="pc">u8</span> <span class="w">NB_RB</span> <span class="c">= (</span><span class="pc">i</span><span class="c">nstword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">11</span><span class="c">) &amp;</span> <span class="pc">0x1</span><span class="c">f;</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">num_bytes</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">EA</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">nt</span> <span class="w">po</span><span class="pc">s</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((i</span><span class="c">nstword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_STRING_MASK</span><span class="pc">) =</span><span class="c">=</span> <span class="w">PPC_INST_LSWX</span><span class="c">)</span>
		<span class="pc">if</span> <span class="pc">((</span><span class="w">rT</span> <span class="pc">=</span><span class="c">=</span> <span class="w">rA) </span><span class="pc">|</span><span class="c">| (rT</span> <span class="pc">=</span><span class="c">=</span> <span class="w">N</span><span class="c">B_RB))</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">E</span><span class="c">A</span> <span class="pc">= </span><span class="c">(</span><span class="w">r</span><span class="c">A</span> <span class="w">=</span><span class="pc">=</span> <span class="c">0) ?</span> <span class="pc">0</span> <span class="c">:</span> <span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">r</span><span class="pc">A</span><span class="w">]</span><span class="pc">;</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="pc">i</span><span class="c">nstword</span> <span class="pc">&amp;</span> <span class="c">PPC_INST_STRING_MASK) {</span>
		<span class="c">case</span> <span class="w">P</span><span class="c">PC_INST_LSWX:</span>
		<span class="pc">c</span><span class="c">ase</span> <span class="w">PPC_INST_STSWX</span><span class="c">:</span>
			<span class="pc">E</span><span class="c">A</span> <span class="w">+</span><span class="pc">=</span> <span class="w">N</span><span class="c">B_RB;</span>
			<span class="w">num_bytes</span> <span class="c">=</span> <span class="w">re</span><span class="pc">gs-</span><span class="c">&gt;</span><span class="w">xer</span> <span class="w">&amp;</span> <span class="w">0</span><span class="pc">x7</span><span class="c">f;</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">case</span> <span class="w">PPC_INST_LSWI</span><span class="c">:</span>
		<span class="pc">c</span><span class="c">ase</span> <span class="w">PPC_INST_STSWI</span><span class="c">:</span>
			<span class="w">n</span><span class="c">um_bytes</span> <span class="w">=</span><span class="pc"> (N</span><span class="c">B_RB</span> <span class="w">=</span><span class="c">=</span> <span class="pc">0) </span><span class="c">?</span> <span class="w">3</span><span class="pc">2</span> <span class="c">:</span> <span class="w">N</span><span class="c">B_RB;</span>
			<span class="c">break;</span>
		<span class="pc">d</span><span class="c">efault:</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="pc">n</span><span class="c">um_bytes</span> <span class="w">!</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
	<span class="pc">{</span>
		<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">al;</span>
		<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">s</span><span class="pc">h</span><span class="c">ift</span> <span class="pc">=</span> <span class="w">8</span> <span class="w">*</span><span class="pc"> </span><span class="c">(</span><span class="w">3</span> <span class="w">-</span><span class="pc"> </span><span class="c">(</span><span class="w">po</span><span class="pc">s</span> <span class="w">&amp;</span> <span class="w">0</span><span class="pc">x3</span><span class="c">));</span>

		
		<span class="c">if</span> <span class="pc">((</span><span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">ms</span><span class="c">r</span> <span class="c">&amp;</span> <span class="w">MSR_64BIT</span><span class="pc">) =</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
			<span class="w">EA</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">0xF</span><span class="pc">FFFF</span><span class="c">FFF;</span>

		<span class="w">s</span><span class="c">witch</span> <span class="pc">((</span><span class="w">instword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_STRING_MASK))</span><span class="pc"> {</span>
			<span class="c">case</span> <span class="w">PPC_INST_LSWX</span><span class="c">:</span>
			<span class="c">case</span> <span class="w">PPC_INST_LSWI</span><span class="c">:</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">get_user</span><span class="pc">(</span><span class="w">v</span><span class="c">al</span><span class="w">,</span><span class="pc"> </span><span class="c">(u8</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*)</span><span class="pc">E</span><span class="c">A</span><span class="w">)</span><span class="pc">)</span>
					<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EFAULT;</span>
				
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">po</span><span class="pc">s</span> <span class="c">==</span> <span class="pc">0</span><span class="c">)</span>
					<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">rT</span><span class="pc">] </span><span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
				<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;gpr[</span><span class="pc">r</span><span class="c">T</span><span class="w">]</span><span class="pc"> |</span><span class="c">=</span> <span class="w">v</span><span class="c">al</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">s</span><span class="pc">h</span><span class="c">ift;</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">case</span> <span class="w">PPC_INST_STSWI</span><span class="c">:</span>
			<span class="pc">c</span><span class="c">ase</span> <span class="w">PPC_INST_STSWX</span><span class="c">:</span>
				<span class="pc">v</span><span class="c">al</span> <span class="c">=</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;gpr</span><span class="pc">[</span><span class="c">rT</span><span class="w">] &gt;</span><span class="c">&gt;</span> <span class="w">s</span><span class="c">hift;</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">pu</span><span class="c">t_user(</span><span class="pc">v</span><span class="c">al</span><span class="w">,</span><span class="pc"> (</span><span class="w">u</span><span class="pc">8</span> <span class="w">_</span><span class="c">_user</span> <span class="c">*)</span><span class="w">EA)</span><span class="pc">)</span>
					<span class="c">return</span> <span class="c">-</span><span class="pc">EF</span><span class="c">AULT;</span>
				<span class="pc">b</span><span class="c">reak;</span>
		<span class="pc">}</span>
		
		<span class="w">E</span><span class="c">A</span> <span class="pc">+</span><span class="c">=</span> <span class="c">1;</span>
		<span class="w">num_bytes-</span><span class="pc">-</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="w">(++po</span><span class="c">s</span> <span class="pc">=</span><span class="c">=</span> <span class="w">4</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">po</span><span class="c">s</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="w">(+</span><span class="c">+</span><span class="w">r</span><span class="c">T</span> <span class="w">=</span><span class="pc">=</span> <span class="w">3</span><span class="c">2)</span>
				<span class="w">r</span><span class="pc">T</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">emulate_popcntb_inst</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">instword</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">ra</span><span class="pc">,</span><span class="w">rs</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="w">t</span><span class="pc">m</span><span class="c">p;</span>

	<span class="w">r</span><span class="pc">a</span> <span class="pc">= </span><span class="c">(</span><span class="w">i</span><span class="c">nstword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="pc">1</span><span class="c">6) &amp;</span> <span class="w">0x1</span><span class="pc">f</span><span class="c">;</span>
	<span class="w">rs</span> <span class="pc">=</span><span class="c"> (</span><span class="pc">i</span><span class="c">nstword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="c">f;</span>

	<span class="w">t</span><span class="pc">mp</span> <span class="pc">=</span> <span class="w">re</span><span class="pc">gs-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="c">[</span><span class="w">rs</span><span class="c">];</span>
	<span class="w">t</span><span class="c">mp</span> <span class="c">=</span> <span class="w">t</span><span class="c">mp</span> <span class="w">- ((</span><span class="c">tmp</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">1</span><span class="pc">)</span><span class="c"> &amp;</span> <span class="w">0x5555555555555555ULL</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">tmp</span> <span class="pc">= </span><span class="c">(tmp</span> <span class="c">&amp;</span> <span class="w">0x3333333333333333ULL) + ((</span><span class="c">tmp</span> <span class="c">&gt;&gt;</span> <span class="w">2</span><span class="c">) &amp;</span> <span class="w">0x33</span><span class="c">33333333333333ULL);</span>
	<span class="c">tmp</span> <span class="pc">= </span><span class="c">(tmp</span> <span class="w">+ </span><span class="pc">(</span><span class="c">tmp</span> <span class="c">&gt;&gt;</span> <span class="pc">4</span><span class="w">))</span><span class="c"> &amp;</span> <span class="w">0x0f0f0f0f0f0f0f0fULL</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pr[</span><span class="w">ra</span><span class="pc">] =</span> <span class="c">tmp;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">emulate_isel</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">instword</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">u8</span> <span class="w">rT</span> <span class="pc">= </span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">stword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="c">f;</span>
	<span class="pc">u8</span> <span class="w">rA</span> <span class="pc">= </span><span class="c">(</span><span class="pc">i</span><span class="c">nstword</span> <span class="c">&gt;&gt;</span> <span class="pc">16</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="c">f;</span>
	<span class="pc">u8</span> <span class="w">rB</span> <span class="pc">= </span><span class="c">(</span><span class="pc">i</span><span class="c">nstword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">11</span><span class="c">) &amp;</span> <span class="pc">0x1</span><span class="c">f;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">BC</span> <span class="pc">= </span><span class="c">(</span><span class="pc">i</span><span class="c">nstword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">6</span><span class="c">) &amp;</span> <span class="pc">0x1</span><span class="c">f;</span>
	<span class="pc">u</span><span class="c">8</span> <span class="w">bi</span><span class="pc">t;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="w">l</span><span class="c">ong</span> <span class="w">t</span><span class="pc">m</span><span class="c">p;</span>

	<span class="w">t</span><span class="c">mp</span> <span class="pc">= </span><span class="c">(</span><span class="w">r</span><span class="pc">A</span> <span class="w">=</span><span class="c">=</span> <span class="w">0</span><span class="c">) ?</span> <span class="c">0</span> <span class="c">:</span> <span class="w">re</span><span class="pc">gs-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">r</span><span class="c">A</span><span class="pc">];</span>
	<span class="w">b</span><span class="pc">i</span><span class="c">t</span> <span class="c">= (</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">ccr</span> <span class="w">&gt;</span><span class="pc">&gt; </span><span class="c">(</span><span class="w">3</span><span class="pc">1</span> <span class="pc">-</span> <span class="w">B</span><span class="c">C</span><span class="w">))</span><span class="pc"> </span><span class="c">&amp;</span> <span class="w">0</span><span class="pc">x1</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">egs-&gt;</span><span class="pc">g</span><span class="c">pr</span><span class="pc">[</span><span class="w">rT</span><span class="pc">] </span><span class="c">=</span> <span class="w">b</span><span class="pc">i</span><span class="c">t</span> <span class="w">?</span> <span class="w">tm</span><span class="pc">p</span> <span class="c">:</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="pc">g</span><span class="c">pr[</span><span class="w">rB</span><span class="pc">];</span>

	<span class="pc">re</span><span class="c">turn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_PPC_TRANSACTIONAL_MEM</span>
<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">tm_abort_check</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cause</span><span class="c">)</span>
<span class="c">{</span>
        
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">MSR_TM_TRANSACTIONAL</span><span class="c">(regs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r)) </span><span class="c">{</span>
		<span class="w">tm_enable</span><span class="pc">()</span><span class="c">;</span>
		<span class="w">tm_abort</span><span class="c">(</span><span class="pc">c</span><span class="c">ause);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
	<span class="c">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>
<span class="pc">#el</span><span class="c">se</span>
<span class="c">static</span> <span class="c">inline</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">t</span><span class="pc">m_abort_</span><span class="c">check(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">,</span> <span class="c">int</span> <span class="w">rea</span><span class="c">son)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">emulate_instruction</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">instword</span><span class="c">;</span>
	<span class="c">u32</span> <span class="w">rd</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">user_mode</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs))</span>
		<span class="c">return</span> <span class="pc">-</span><span class="c">EINVAL;</span>
	<span class="w">CHECK_FULL_REGS</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">get_user</span><span class="c">(</span><span class="pc">i</span><span class="c">nstword</span><span class="w">,</span><span class="pc"> (u3</span><span class="c">2</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)(</span><span class="w">r</span><span class="c">egs</span><span class="pc">-&gt;</span><span class="w">nip))</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EFAULT;</span>

	
	<span class="c">if</span> <span class="pc">((</span><span class="c">instword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_MFSPR_PVR_MASK</span><span class="c">) ==</span> <span class="w">PPC_INST_MFSPR_PVR</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">PPC_WARN_EMULATED</span><span class="c">(</span><span class="w">mfpvr</span><span class="c">,</span> <span class="w">r</span><span class="c">egs);</span>
		<span class="w">rd</span> <span class="pc">= </span><span class="c">(instword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="pc">f</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">rd</span><span class="pc">] </span><span class="c">=</span> <span class="w">mfspr</span><span class="pc">(</span><span class="w">SPRN_PVR</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>

	
	<span class="pc">if</span> <span class="pc">((</span><span class="c">instword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_DCBA_MASK</span><span class="c">) ==</span> <span class="w">PPC_INST_DCBA</span><span class="c">) {</span>
		<span class="c">PPC_WARN_EMULATED(</span><span class="w">dcba</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">i</span><span class="c">nstword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_MCRXR_MASK</span><span class="c">) ==</span> <span class="w">PPC_INST_MCRXR</span><span class="c">) {</span>
		<span class="w">i</span><span class="pc">nt</span> <span class="w">sh</span><span class="c">ift</span> <span class="pc">= </span><span class="c">(</span><span class="w">i</span><span class="pc">ns</span><span class="c">tword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1c</span><span class="c">;</span>
		<span class="w">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">msk</span> <span class="pc">=</span> <span class="w">0xf0000000UL</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">s</span><span class="pc">h</span><span class="c">ift;</span>

		<span class="w">P</span><span class="pc">PC_W</span><span class="c">ARN_EMULATED</span><span class="w">(mcrxr</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs)</span><span class="c">;</span>
		<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">ccr</span> <span class="pc">= </span><span class="c">(</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;ccr</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="c">msk</span><span class="w">) | ((r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">xer</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">s</span><span class="pc">h</span><span class="c">ift) &amp;</span> <span class="w">m</span><span class="pc">s</span><span class="c">k);</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="pc">x</span><span class="c">er</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="pc">0</span><span class="c">xf0000000UL;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>

	
	<span class="w">i</span><span class="pc">f</span> <span class="pc">((</span><span class="w">instword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_STRING_GEN_MASK</span><span class="c">) ==</span> <span class="w">PPC_INST_STRING</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">tm_abort_check</span><span class="c">(</span><span class="w">r</span><span class="c">egs,</span>
				   <span class="w">TM_CAUSE_EMULATE</span> <span class="w">|</span> <span class="w">TM_CAUSE_PERSISTENT</span><span class="c">))</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="w">PPC_WARN_EMULATED</span><span class="c">(</span><span class="w">stri</span><span class="c">ng,</span> <span class="pc">r</span><span class="c">egs);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">emulate_string_inst</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">,</span> <span class="w">i</span><span class="c">nstword</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">i</span><span class="c">f</span> <span class="pc">((i</span><span class="c">nstword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_POPCNTB_MASK</span><span class="c">) ==</span> <span class="w">PPC_INST_POPCNTB</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">P</span><span class="pc">PC_W</span><span class="c">ARN_EMULATED(</span><span class="w">popcntb</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">emulate_popcntb_inst</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="c">instword);</span>
	<span class="c">}</span>

	
	<span class="w">i</span><span class="pc">f</span> <span class="pc">((i</span><span class="c">nstword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_ISEL_MASK</span><span class="c">) ==</span> <span class="w">PPC_INST_ISEL</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">P</span><span class="c">PC_WARN_EMULATED(</span><span class="w">isel</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">emulate_isel</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="pc">in</span><span class="c">stword);</span>
	<span class="c">}</span>

	
	<span class="w">i</span><span class="c">f</span> <span class="pc">((in</span><span class="c">stword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_SYNC_MASK</span><span class="c">) ==</span> <span class="w">PPC_INST_SYNC</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">P</span><span class="c">PC_WARN_EMULATED(</span><span class="w">sy</span><span class="pc">n</span><span class="c">c,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">as</span><span class="pc">m</span> <span class="w">v</span><span class="c">olatile</span><span class="w">("sy</span><span class="c">nc</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_PPC64</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="w">((((i</span><span class="pc">ns</span><span class="c">tword</span> <span class="w">&amp;</span> <span class="w">PPC_INST_MFSPR_DSCR_USER_MASK</span><span class="pc">) =</span><span class="c">=</span>
		<span class="w">PPC_INST_MFSPR_DSCR_USER) </span><span class="pc">|</span><span class="c">|</span>
	     <span class="pc">((</span><span class="w">i</span><span class="pc">ns</span><span class="c">tword</span> <span class="pc">&amp;</span> <span class="w">PPC_INST_MFSPR_DSCR_MASK</span><span class="c">) ==</span>
		<span class="w">PPC_INST_MFSPR_DSCR)) &amp;&amp;</span>
			<span class="w">cpu_has_feature</span><span class="c">(</span><span class="w">CPU_FTR_DSCR)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">P</span><span class="pc">PC_W</span><span class="c">ARN_EMULATED(</span><span class="w">mfdscr</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">rd</span> <span class="pc">= </span><span class="c">(</span><span class="w">i</span><span class="c">nstword</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="pc">f</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">rd</span><span class="pc">] </span><span class="c">=</span> <span class="w">mfspr</span><span class="pc">(</span><span class="w">SPRN_DSCR</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>
	
	<span class="w">i</span><span class="pc">f</span> <span class="w">((((i</span><span class="pc">ns</span><span class="c">tword</span> <span class="pc">&amp;</span> <span class="w">PPC_INST_MTSPR_DSCR_USER_MASK)</span><span class="pc"> =</span><span class="c">=</span>
		<span class="w">PPC_INST_MTSPR_DSCR_USER) |</span><span class="c">|</span>
	     <span class="pc">((</span><span class="w">i</span><span class="pc">ns</span><span class="c">tword</span> <span class="c">&amp;</span> <span class="w">PPC_INST_MTSPR_DSCR_MASK</span><span class="c">) ==</span>
		<span class="w">PPC_INST_MTSPR_DSCR)) &amp;&amp;</span>
			<span class="w">cpu_has_feature</span><span class="c">(</span><span class="w">CPU_FTR_DSCR</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">PPC_WARN_EMULATED</span><span class="c">(</span><span class="w">mtdscr</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">rd</span> <span class="pc">= </span><span class="c">(instword</span> <span class="pc">&gt;</span><span class="c">&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="pc">f</span><span class="c">;</span>
		<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">dscr</span> <span class="c">=</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">rd</span><span class="c">];</span>
		<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">dscr_inherit</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_DSCR</span><span class="c">,</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">d</span><span class="pc">scr</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">-</span><span class="c">EINVAL;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">is_valid_bugaddr</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">a</span><span class="pc">d</span><span class="c">dr</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">is_kernel_addr</span><span class="c">(</span><span class="w">a</span><span class="pc">d</span><span class="c">dr);</span>
<span class="c">}</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_MATH_EMULATION</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">emulate_math</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="w">e</span><span class="pc">x</span><span class="c">tern</span> <span class="c">int</span> <span class="w">do_mathemu</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">do</span><span class="c">_mathemu(regs</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">if</span> <span class="c">(</span><span class="pc">ret</span> <span class="w">&gt;</span><span class="c">=</span> <span class="c">0)</span>
		<span class="w">PPC_WARN_EMULATED</span><span class="c">(</span><span class="w">math</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs)</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="pc">ret</span><span class="c">) {</span>
	<span class="c">case</span> <span class="c">0:</span>
		<span class="w">emulate_single_step</span><span class="c">(</span><span class="w">r</span><span class="pc">egs)</span><span class="c">;</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="c">1</span><span class="w">: {</span>
			<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">__parse_fpscr</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read</span><span class="w">.fp_state</span><span class="pc">.</span><span class="w">fpscr</span><span class="c">);</span>
			<span class="w">_exception</span><span class="c">(</span><span class="w">SIGFPE</span><span class="c">,</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
		<span class="c">}</span>
	<span class="w">c</span><span class="pc">a</span><span class="c">se</span> <span class="w">-EF</span><span class="c">AULT:</span>
		<span class="w">_</span><span class="c">exception(</span><span class="w">SIGSEGV</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">SEGV_MAPERR</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;nip</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">1</span><span class="c">;</span>
<span class="c">}</span>
<span class="w">#</span><span class="pc">el</span><span class="c">se</span>
<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="c">int</span> <span class="w">emulate_math</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">) </span><span class="c">{</span> <span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="pc">1; </span><span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">__kprobes</span> <span class="w">program_check_exception</span><span class="pc">(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">ctx_state</span> <span class="w">prev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="pc">=</span> <span class="w">get_reason</span><span class="pc">(r</span><span class="c">egs);</span>

	

	<span class="pc">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">REASON_FP</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">parse_fpe</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">REASON_TRAP</span><span class="c">) {</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">debugger_bpt</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">notify_die</span><span class="c">(</span><span class="w">DIE_BPT,</span><span class="pc"> "</span><span class="w">breakpoint</span><span class="pc">",</span> <span class="w">r</span><span class="c">egs</span><span class="w">,</span> <span class="w">5</span><span class="pc">,</span> <span class="w">5</span><span class="pc">,</span> <span class="w">SIGTRAP)</span>
				<span class="w">=</span><span class="pc">=</span> <span class="w">NOTIFY_STOP)</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="c">&amp;</span> <span class="w">MSR_PR</span><span class="c">) &amp;&amp;</span>  
		    <span class="w">report_bug</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nip</span><span class="pc">,</span> <span class="pc">r</span><span class="c">egs</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="w">BUG_TRAP_TYPE_WARN</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="pc">n</span><span class="c">ip</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">4</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>
		<span class="w">_exception</span><span class="c">(</span><span class="w">S</span><span class="c">IGTRAP,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">,</span> <span class="w">TRAP_BRKPT</span><span class="c">,</span> <span class="w">r</span><span class="c">egs-&gt;</span><span class="pc">n</span><span class="c">ip</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_PPC_TRANSACTIONAL_MEM</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">REASON_TM</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">user_mode</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="w">) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
		    <span class="w">report_bug</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ip</span><span class="pc">,</span> <span class="pc">r</span><span class="c">egs</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="w">BUG_TRAP_TYPE_WARN</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="pc">n</span><span class="c">ip</span> <span class="w">+</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">us</span><span class="c">er_mode</span><span class="pc">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">_exception</span><span class="c">(</span><span class="w">SIGILL</span><span class="c">,</span> <span class="pc">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">ILL_ILLOPN</span><span class="pc">,</span> <span class="c">regs-&gt;</span><span class="pc">n</span><span class="c">ip);</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">a</span><span class="c">il;</span>
		<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">p</span><span class="c">rintk(</span><span class="w">KERN_EMERG</span> <span class="c">"</span><span class="w">Unexpected</span> <span class="w">TM</span> <span class="w">Bad</span> <span class="w">Thing</span> <span class="w">exception</span> <span class="w">"</span>
			       <span class="c">"</span><span class="w">a</span><span class="pc">t</span> <span class="pc">%</span><span class="w">l</span><span class="pc">x</span> <span class="w">(ms</span><span class="pc">r</span> <span class="w">0</span><span class="c">x%x</span><span class="pc">)</span><span class="c">\n",</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;nip</span><span class="pc">,</span> <span class="w">rea</span><span class="pc">s</span><span class="c">on);</span>
			<span class="w">die</span><span class="pc">("</span><span class="w">Unrecoverable</span> <span class="w">e</span><span class="pc">x</span><span class="c">ception</span><span class="w">"</span><span class="pc">,</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">SIGABRT</span><span class="c">);</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
<span class="pc">#</span><span class="c">endif</span>

	
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">user_mode</span><span class="pc">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">))</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">sigill</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">arch_irq_disabled_regs</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">local_irq_enable(</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">emulate_math</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">REASON_ILLEGAL</span> <span class="c">|</span> <span class="w">REASON_PRIVILEGED</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">emulate_instruction</span><span class="c">(</span><span class="w">re</span><span class="pc">gs)) </span><span class="c">{</span>
		<span class="c">case</span> <span class="c">0:</span>
			<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">nip</span> <span class="w">+</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>
			<span class="w">emulate_single_step</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="w">c</span><span class="c">ase</span> <span class="w">-EF</span><span class="c">AULT:</span>
			<span class="w">_exception</span><span class="c">(</span><span class="w">SIGSEGV</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">SEGV_MAPERR</span><span class="pc">,</span> <span class="w">r</span><span class="pc">e</span><span class="c">gs-&gt;nip);</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

<span class="w">sigill</span><span class="pc">:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rea</span><span class="pc">s</span><span class="c">on</span> <span class="w">&amp;</span> <span class="w">REASON_PRIVILEGED</span><span class="pc">)</span>
		<span class="w">_</span><span class="c">exception(</span><span class="w">SIGILL</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">ILL_PRVOPC</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">n</span><span class="c">ip);</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">_</span><span class="c">exception(</span><span class="pc">SIGI</span><span class="c">LL,</span> <span class="w">r</span><span class="c">egs,</span> <span class="w">ILL_ILLOPC</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ip</span><span class="pc">)</span><span class="c">;</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l</span><span class="pc">:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">v</span><span class="c">oid</span> <span class="w">__kprobes</span> <span class="w">emulation_assist_interrupt</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">ms</span><span class="c">r</span> <span class="w">|</span><span class="c">=</span> <span class="w">REASON_ILLEGAL</span><span class="c">;</span>
	<span class="w">program_check_exception</span><span class="c">(regs</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">alignment_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="pc">n</span><span class="c">um</span> <span class="w">ctx_state</span> <span class="w">p</span><span class="pc">r</span><span class="c">ev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">si</span><span class="pc">g,</span> <span class="w">cod</span><span class="pc">e,</span> <span class="w">fixed</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">;</span>

	
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">arch_irq_disabled_regs</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s))</span>
		<span class="w">local_irq_enable()</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">tm_abort_check</span><span class="c">(</span><span class="w">r</span><span class="pc">egs</span><span class="c">,</span> <span class="w">TM_CAUSE_ALIGNMENT</span> <span class="w">|</span> <span class="w">TM_CAUSE_PERSISTENT</span><span class="c">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>

	
	<span class="c">if</span> <span class="pc">(!(</span><span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read</span><span class="w">.align_ctl</span> <span class="pc">&amp;</span> <span class="w">PR_UNALIGN_SIGBUS</span><span class="c">))</span>
		<span class="pc">f</span><span class="c">ixed</span> <span class="c">=</span> <span class="w">fix_alignment</span><span class="c">(</span><span class="w">reg</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">f</span><span class="c">ixed</span> <span class="pc">=</span><span class="c">=</span> <span class="w">1</span><span class="c">) {</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">nip</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">4</span><span class="c">;</span>	
		<span class="w">emulate_single_step</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="c">(fixed</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EF</span><span class="c">AULT) {</span>
		<span class="w">sig</span> <span class="c">=</span> <span class="w">SIGSEGV</span><span class="pc">;</span>
		<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">SEGV_ACCERR</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">sig</span> <span class="c">=</span> <span class="w">SIGBUS</span><span class="c">;</span>
		<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">BUS_ADRALN</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">user_mode</span><span class="c">(</span><span class="w">reg</span><span class="pc">s))</span>
		<span class="w">_exception</span><span class="c">(</span><span class="w">si</span><span class="pc">g,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">co</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs</span><span class="w">-</span><span class="c">&gt;</span><span class="w">dar</span><span class="c">);</span>
	<span class="c">else</span>
		<span class="w">bad_page_fault</span><span class="c">(</span><span class="w">r</span><span class="c">egs,</span> <span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="pc">d</span><span class="c">ar,</span> <span class="w">si</span><span class="pc">g)</span><span class="c">;</span>

<span class="w">bai</span><span class="c">l</span><span class="pc">:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">StackOverflow</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="pc">ri</span><span class="c">ntk(</span><span class="w">KERN_CRIT</span> <span class="pc">"</span><span class="w">Kernel</span> <span class="w">stack</span> <span class="w">overflow</span> <span class="w">i</span><span class="pc">n</span> <span class="w">process</span> <span class="pc">%p</span><span class="w">,</span> <span class="w">r1</span><span class="pc">=</span><span class="c">%</span><span class="w">l</span><span class="pc">x\</span><span class="c">n",</span>
	       <span class="w">cu</span><span class="c">rrent</span><span class="pc">,</span> <span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">gpr</span><span class="pc">[1</span><span class="c">]);</span>
	<span class="w">debugger</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">show_regs</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">panic(</span><span class="pc">"</span><span class="w">ke</span><span class="c">rnel</span> <span class="pc">s</span><span class="c">tack</span> <span class="c">overflow</span><span class="w">"</span><span class="c">);</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">nonrecoverable_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="c">rintk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">Non</span><span class="pc">-</span><span class="w">recoverable</span> <span class="w">exception</span> <span class="w">a</span><span class="c">t</span> <span class="w">PC=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span> <span class="w">MSR</span><span class="pc">=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span>
	       <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r</span><span class="c">);</span>
	<span class="w">debugger</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">die</span><span class="pc">("</span><span class="w">nonrecoverable</span> <span class="w">e</span><span class="pc">x</span><span class="c">ception</span><span class="w">"</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">SIGKILL</span><span class="c">);</span>
<span class="pc">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">trace_syscall</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Task:</span><span class="pc"> </span><span class="c">%</span><span class="pc">p</span><span class="w">(</span><span class="c">%</span><span class="pc">d</span><span class="w">),</span> <span class="w">PC:</span><span class="c"> %</span><span class="w">08lX/</span><span class="pc">%</span><span class="w">0</span><span class="pc">8l</span><span class="c">X</span><span class="pc">,</span> <span class="w">Syscall:</span><span class="pc"> </span><span class="c">%</span><span class="w">3ld</span><span class="pc">,</span> <span class="w">Result</span><span class="pc">:</span><span class="c"> %</span><span class="pc">s</span><span class="w">%l</span><span class="pc">d</span>    <span class="pc">%s\</span><span class="c">n",</span>
	       <span class="w">cu</span><span class="c">rrent</span><span class="pc">,</span> <span class="w">task_pid_nr</span><span class="pc">(</span><span class="w">cu</span><span class="c">rrent),</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">re</span><span class="pc">g</span><span class="c">s-&gt;</span><span class="w">li</span><span class="pc">nk</span><span class="c">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="c">0],</span>
	       <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ccr&amp;0x10</span><span class="pc">0000</span><span class="c">00</span><span class="w">?"Er</span><span class="c">ror</span><span class="w">=":"",</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;gpr</span><span class="pc">[3</span><span class="c">],</span> <span class="w">print_tainted()</span><span class="c">);</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">kernel_fp_unavailable_exception</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">ctx_state</span> <span class="w">prev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">pr</span><span class="pc">intk</span><span class="c">(</span><span class="w">KERN_EMERG</span> <span class="c">"</span><span class="w">Unrecoverable</span> <span class="w">FP</span> <span class="w">Unavailable</span> <span class="w">Exception</span> <span class="w">"</span>
			  <span class="w">"</span><span class="pc">%</span><span class="w">l</span><span class="pc">x</span> <span class="w">a</span><span class="c">t</span> <span class="c">%</span><span class="w">l</span><span class="pc">x\</span><span class="c">n",</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">trap</span><span class="c">,</span> <span class="w">re</span><span class="pc">gs</span><span class="c">-&gt;</span><span class="w">nip</span><span class="c">);</span>
	<span class="w">die</span><span class="pc">("</span><span class="w">U</span><span class="pc">nr</span><span class="c">ecoverable</span> <span class="w">F</span><span class="c">P</span> <span class="c">Unavailable</span> <span class="pc">E</span><span class="c">xception</span><span class="w">"</span><span class="pc">,</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">SIGABRT</span><span class="c">);</span>

	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">altivec_unavailable_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="pc">n</span><span class="c">um</span> <span class="w">ctx_state</span> <span class="w">p</span><span class="c">rev_state</span> <span class="pc">=</span> <span class="w">exception_enter(</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">user_mode</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">) {</span>
		
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGILL</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">ILL_ILLOPC</span><span class="pc">,</span> <span class="pc">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="c">ail;</span>
	<span class="c">}</span>

	<span class="w">p</span><span class="pc">rin</span><span class="c">tk(</span><span class="w">KERN_EMERG</span> <span class="c">"</span><span class="w">Unrecoverable</span> <span class="w">VMX/Altivec</span> <span class="w">Unavailable</span> <span class="w">Exception</span> <span class="pc">"</span>
			<span class="w">"</span><span class="pc">%</span><span class="w">l</span><span class="pc">x</span> <span class="w">a</span><span class="pc">t</span> <span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">trap</span><span class="c">,</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ip</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">die</span><span class="pc">("</span><span class="w">U</span><span class="c">nrecoverable</span> <span class="w">V</span><span class="c">MX</span><span class="w">/</span><span class="pc">A</span><span class="c">ltivec</span> <span class="w">U</span><span class="c">navailable</span> <span class="c">Exception</span><span class="w">"</span><span class="pc">,</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">SIGABRT</span><span class="c">);</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l</span><span class="pc">:</span>
	<span class="w">exception_exit</span><span class="c">(</span><span class="w">prev_state</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">vsx_unavailable_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">user_mode</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)) </span><span class="c">{</span>
		
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGILL</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">ILL_ILLOPC</span><span class="pc">,</span> <span class="pc">r</span><span class="c">egs-&gt;</span><span class="w">nip</span><span class="c">);</span>
		<span class="w">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">p</span><span class="pc">rin</span><span class="c">tk(</span><span class="w">KERN_EMERG</span> <span class="pc">"</span><span class="w">Unrecoverable</span> <span class="w">VSX</span> <span class="w">Unavailable</span> <span class="w">Exception</span> <span class="w">"</span>
			<span class="w">"</span><span class="pc">%</span><span class="w">l</span><span class="pc">x</span> <span class="w">a</span><span class="c">t</span> <span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span> <span class="w">r</span><span class="c">egs-&gt;</span><span class="w">trap</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs-&gt;</span><span class="w">n</span><span class="c">ip);</span>
	<span class="w">die</span><span class="pc">("</span><span class="w">U</span><span class="pc">nr</span><span class="c">ecoverable</span> <span class="w">V</span><span class="c">SX</span> <span class="c">Unavailable</span> <span class="c">Exception</span><span class="w">"</span><span class="pc">,</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">SIGABRT</span><span class="c">);</span>
<span class="pc">}</span>

<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_PPC64</span>
<span class="w">v</span><span class="c">oid</span> <span class="w">facility_unavailable_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">facility_strings[</span><span class="c">] = {</span>
		<span class="c">[</span><span class="w">FSCR_FP_LG</span><span class="pc">] = "</span><span class="w">FPU</span><span class="pc">",</span>
		<span class="c">[</span><span class="w">FSCR_VECVSX_LG</span><span class="pc">]</span><span class="c"> = "</span><span class="w">VMX/V</span><span class="pc">S</span><span class="c">X",</span>
		<span class="pc">[</span><span class="w">FSCR_DSCR_LG</span><span class="c">] = "</span><span class="w">DSCR</span><span class="c">",</span>
		<span class="c">[</span><span class="w">FSCR_PM_LG</span><span class="c">] = "</span><span class="w">PMU</span> <span class="w">SPRs</span><span class="c">",</span>
		<span class="c">[</span><span class="w">FSCR_BHRB_LG</span><span class="c">] = "</span><span class="w">BHRB</span><span class="c">",</span>
		<span class="c">[</span><span class="w">FSCR_TM_LG</span><span class="c">] = "</span><span class="w">TM</span><span class="c">",</span>
		<span class="c">[</span><span class="w">FSCR_EBB_LG</span><span class="c">] = "</span><span class="w">EBB</span><span class="c">",</span>
		<span class="c">[</span><span class="w">FSCR_TAR_LG</span><span class="c">] = "</span><span class="w">TAR</span><span class="c">",</span>
	<span class="pc">}</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">facility</span> <span class="w">=</span><span class="pc"> "</span><span class="w">u</span><span class="pc">nk</span><span class="c">nown</span><span class="w">"</span><span class="pc">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">va</span><span class="pc">lu</span><span class="c">e;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">instword</span><span class="pc">,</span> <span class="w">rd</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">s</span><span class="c">tatus;</span>
	<span class="w">b</span><span class="c">ool</span> <span class="w">hv</span><span class="c">;</span>

	<span class="w">h</span><span class="c">v</span> <span class="pc">= </span><span class="c">(</span><span class="w">reg</span><span class="pc">s-&gt;</span><span class="w">trap</span> <span class="w">=</span><span class="c">=</span> <span class="w">0xf80</span><span class="pc">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">h</span><span class="c">v</span><span class="pc">)</span>
		<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="w">mfspr</span><span class="c">(</span><span class="w">SPRN_HFSCR</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">else</span>
		<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="c">mfspr(</span><span class="w">SPRN_FSCR</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">s</span><span class="c">tatus</span> <span class="c">=</span> <span class="w">v</span><span class="c">alue</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">5</span><span class="pc">6</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(status</span> <span class="pc">=</span><span class="c">=</span> <span class="w">FSCR_DSCR_LG</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">get_user</span><span class="c">(</span><span class="w">instword,</span><span class="pc"> (</span><span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">_</span><span class="c">_user</span> <span class="pc">*)(</span><span class="w">reg</span><span class="pc">s-&gt;</span><span class="w">nip))</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">p</span><span class="pc">r_e</span><span class="c">rr("</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">fetch</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">u</span><span class="pc">ser</span> <span class="w">instruction</span><span class="pc">\</span><span class="c">n");</span>
			<span class="c">return</span><span class="pc">;</span>
		<span class="c">}</span>

		
		<span class="c">if</span> <span class="pc">((</span><span class="c">instword</span> <span class="pc">&amp;</span> <span class="w">PPC_INST_MTSPR_DSCR_USER_MASK)</span>
				<span class="w">=</span><span class="c">=</span> <span class="w">PPC_INST_MTSPR_DSCR_USER)</span><span class="pc"> {</span>
			<span class="w">rd</span> <span class="pc">= </span><span class="c">(instword</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">21</span><span class="c">) &amp;</span> <span class="w">0x1</span><span class="c">f;</span>
			<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">dscr</span> <span class="c">=</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">gpr</span><span class="pc">[</span><span class="w">rd</span><span class="c">];</span>
			<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">dscr_inherit</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
			<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_FSCR</span><span class="c">,</span> <span class="w">va</span><span class="pc">lu</span><span class="c">e</span> <span class="pc">|</span> <span class="w">FSCR_DSCR</span><span class="c">);</span>
		<span class="c">}</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">((i</span><span class="c">nstword</span> <span class="pc">&amp;</span> <span class="w">PPC_INST_MFSPR_DSCR_USER_MASK)</span>
				<span class="w">=</span><span class="c">=</span> <span class="w">PPC_INST_MFSPR_DSCR_USER) </span><span class="pc">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">emulate_instruction</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">)</span><span class="c">) {</span>
				<span class="w">p</span><span class="pc">r_e</span><span class="c">rr("</span><span class="w">DSCR</span> <span class="w">based</span> <span class="w">mfspr</span> <span class="w">emulation</span> <span class="w">f</span><span class="pc">a</span><span class="c">iled\n");</span>
				<span class="c">return;</span>
			<span class="c">}</span>
			<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">nip</span> <span class="w">+</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>
			<span class="w">emulate_single_step</span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s);</span>
		<span class="c">}</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="w">&lt;</span> <span class="w">A</span><span class="c">RRAY_SIZE(</span><span class="w">facility_strings)) &amp;&amp;</span>
	    <span class="w">f</span><span class="pc">a</span><span class="c">cility_strings</span><span class="w">[sta</span><span class="pc">tu</span><span class="c">s</span><span class="w">])</span>
		<span class="w">facility</span> <span class="pc">=</span> <span class="c">facility_strings</span><span class="pc">[</span><span class="w">sta</span><span class="pc">tu</span><span class="c">s];</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">arch_irq_disabled_regs</span><span class="c">(</span><span class="w">re</span><span class="pc">g</span><span class="c">s</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">local_irq_enable(</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">pr_err_ratelimited</span><span class="c">(</span>
		<span class="w">"%sFacility</span> <span class="w">'%s'</span> <span class="w">unavailable,</span> <span class="w">exception</span> <span class="w">a</span><span class="pc">t</span> <span class="pc">0</span><span class="c">x%</span><span class="w">l</span><span class="c">x</span><span class="w">,</span> <span class="w">MSR</span><span class="c">=%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span>
		<span class="w">hv</span> <span class="pc">?</span><span class="c"> "</span><span class="w">Hypervisor</span> <span class="w">" : "",</span> <span class="w">f</span><span class="c">acility</span><span class="w">,</span> <span class="w">re</span><span class="pc">gs</span><span class="c">-&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">user_mode</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGILL</span><span class="c">,</span> <span class="c">regs</span><span class="pc">,</span> <span class="w">ILL_ILLOPC</span><span class="pc">,</span> <span class="pc">r</span><span class="c">egs-&gt;</span><span class="pc">n</span><span class="c">ip);</span>
		<span class="w">r</span><span class="pc">et</span><span class="c">urn</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">die("Unexpected</span> <span class="w">f</span><span class="pc">a</span><span class="c">cility</span> <span class="w">unavailable</span> <span class="w">exception</span><span class="pc">",</span> <span class="w">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">SIGABRT</span><span class="c">);</span>
<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>

<span class="pc">#</span><span class="c">ifdef</span> <span class="w">CONFIG_PPC_TRANSACTIONAL_MEM</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">fp_unavailable_tm</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	

	<span class="w">TM_DEBUG</span><span class="pc">("</span><span class="w">FP</span> <span class="w">Unavailable</span> <span class="w">trap</span> <span class="w">whilst</span> <span class="w">transactional</span> <span class="w">a</span><span class="c">t</span> <span class="pc">0</span><span class="c">x%</span><span class="pc">l</span><span class="c">x</span><span class="pc">,</span> <span class="w">MSR</span><span class="pc">=</span><span class="c">%</span><span class="w">l</span><span class="c">x</span><span class="pc">\</span><span class="c">n",</span>
		 <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span><span class="c">);</span>

        
	<span class="w">tm_reclaim_current</span><span class="c">(</span><span class="w">TM_CAUSE_FAC_UNAV</span><span class="pc">)</span><span class="c">;</span>
	

	
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">MSR_FP</span> <span class="c">|</span> <span class="w">cu</span><span class="pc">rre</span><span class="c">nt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">fpexc_mode</span><span class="c">);</span>

	
	<span class="w">tm_recheckpoint</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read,</span> <span class="w">M</span><span class="c">SR_FP);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">reg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">&amp;</span> <span class="w">MSR_VEC</span><span class="c">) {</span>
		<span class="w">do_load_up_transact_altivec</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read);</span>
		
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">MSR_VSX</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">altivec_unavailable_tm</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	

	<span class="w">TM_DEBUG</span><span class="pc">("</span><span class="w">Vector</span> <span class="w">Unavailable</span> <span class="w">trap</span> <span class="w">whilst</span> <span class="w">transactional</span> <span class="w">a</span><span class="c">t</span> <span class="pc">0</span><span class="c">x%</span><span class="w">l</span><span class="c">x</span><span class="w">,</span><span class="pc">"</span>
		 <span class="c">"</span><span class="w">MSR</span><span class="pc">=</span><span class="c">%</span><span class="w">l</span><span class="pc">x\</span><span class="c">n",</span>
		 <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r</span><span class="c">);</span>
	<span class="w">tm_reclaim_current</span><span class="c">(</span><span class="w">TM_CAUSE_FAC_UNAV</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">MSR_VEC</span><span class="c">;</span>
	<span class="w">tm_recheckpoint</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read,</span> <span class="w">M</span><span class="pc">SR_</span><span class="c">VEC);</span>
	<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">used_vr</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">&amp;</span> <span class="w">MSR_FP</span><span class="c">) {</span>
		<span class="w">do_load_up_transact_fpu</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">MSR_VSX</span><span class="c">;</span>
	<span class="c">}</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">vsx_unavailable_tm</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">orig_msr</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">egs-&gt;</span><span class="w">ms</span><span class="pc">r</span><span class="c">;</span>

	

	<span class="w">TM_DEBUG(</span><span class="pc">"</span><span class="w">VSX</span> <span class="w">Unavailable</span> <span class="w">trap</span> <span class="w">whilst</span> <span class="w">transactional</span> <span class="w">a</span><span class="c">t</span> <span class="c">0x%</span><span class="pc">l</span><span class="c">x</span><span class="w">,</span><span class="pc">"</span>
		 <span class="pc">"</span><span class="w">MSR</span><span class="pc">=</span><span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span>
		 <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">nip</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r</span><span class="c">);</span>

	<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">used_vsr</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">orig_msr</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">MSR_FP</span> <span class="c">|</span> <span class="w">MSR_VEC)) == (</span><span class="pc">M</span><span class="c">SR_FP</span> <span class="w">|</span> <span class="pc">M</span><span class="c">SR_VEC</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="c">|=</span> <span class="w">MSR_VSX</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn;</span>
	<span class="c">}</span>

	
	<span class="w">tm_reclaim_current</span><span class="c">(</span><span class="w">TM_CAUSE_FAC_UNAV</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">M</span><span class="pc">SR_VE</span><span class="c">C</span> <span class="pc">|</span> <span class="w">M</span><span class="pc">SR_F</span><span class="c">P</span> <span class="pc">|</span> <span class="w">cu</span><span class="pc">rre</span><span class="c">nt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">fpexc_mode</span> <span class="w">|</span>
		<span class="pc">M</span><span class="c">SR_VSX</span><span class="pc">;</span>

	
	<span class="w">tm_recheckpoint</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">,</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">~</span><span class="w">orig_msr</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">r</span><span class="c">ig_msr</span> <span class="w">&amp;</span> <span class="w">M</span><span class="pc">SR_F</span><span class="c">P</span><span class="pc">)</span>
		<span class="w">do_load_up_transact_fpu</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">o</span><span class="c">rig_msr</span> <span class="c">&amp;</span> <span class="w">M</span><span class="c">SR_VEC)</span>
		<span class="w">do_load_up_transact_altivec</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read);</span>
<span class="pc">}</span>
<span class="w">#</span><span class="c">endif</span> 

<span class="w">v</span><span class="c">oid</span> <span class="w">performance_monitor_exception</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">__this_cpu_inc</span><span class="c">(</span><span class="w">irq_stat.pmu_irqs</span><span class="c">);</span>

	<span class="w">perf_irq</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_8xx</span>
<span class="pc">v</span><span class="c">oid</span> <span class="w">SoftwareEmulation</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">CHECK_FULL_REGS</span><span class="c">(</span><span class="pc">r</span><span class="c">egs);</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">user_mode</span><span class="c">(regs</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">debugger</span><span class="c">(regs);</span>
		<span class="w">die(</span><span class="pc">"</span><span class="w">Kernel</span> <span class="w">Mode</span> <span class="w">Unimplemented</span> <span class="w">Instruction</span> <span class="w">o</span><span class="pc">r</span> <span class="w">SW</span> <span class="w">FPU</span> <span class="w">Emulation</span><span class="pc">",</span>
			<span class="pc">r</span><span class="c">egs</span><span class="pc">,</span> <span class="w">SIGFPE</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">emulate_math</span><span class="c">(</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return;</span>

	<span class="w">_exception</span><span class="c">(</span><span class="w">SIGILL</span><span class="c">,</span> <span class="c">regs</span><span class="pc">,</span> <span class="w">ILL_ILLOPC</span><span class="pc">,</span> <span class="c">regs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">);</span>
<span class="pc">}</span>
<span class="w">#</span><span class="c">endif</span> 

<span class="c">#ifdef</span> <span class="w">CONFIG_PPC_ADV_DEBUG_REGS</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">handle_debug</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs,</span> <span class="c">unsigned</span> <span class="c">long</span> <span class="w">debug_status</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">cha</span><span class="pc">nged</span> <span class="pc">=</span> <span class="c">0;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(debug_status</span> <span class="w">&amp;</span><span class="c"> (</span><span class="w">DBSR_DAC1R</span> <span class="c">|</span> <span class="w">DBSR_DAC1W)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">dbcr_dac</span><span class="c">(</span><span class="w">c</span><span class="pc">u</span><span class="c">rrent</span><span class="w">) &amp;= ~(DBCR_DAC1R</span> <span class="pc">|</span> <span class="w">DBCR_DAC1W</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_PPC_ADV_DEBUG_DAC_RANGE</span>
		<span class="w">cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">de</span><span class="pc">bug.</span><span class="w">dbcr2</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR2_DAC12MODE</span><span class="c">;</span>
<span class="c">#endif</span>
		<span class="w">do_send_trap</span><span class="c">(</span><span class="w">re</span><span class="pc">gs,</span> <span class="w">mfspr</span><span class="pc">(</span><span class="w">SPRN_DAC1</span><span class="pc">)</span><span class="c">,</span> <span class="w">d</span><span class="pc">e</span><span class="c">bug_status</span><span class="pc">,</span> <span class="w">TRAP_HWBKPT</span><span class="c">,</span>
			     <span class="w">5</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ch</span><span class="pc">anged</span> <span class="pc">|</span><span class="c">=</span> <span class="w">0x0</span><span class="pc">1</span><span class="c">;</span>
	<span class="pc">}</span>  <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">d</span><span class="c">ebug_status</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">DBSR_DAC2R</span> <span class="c">|</span> <span class="w">DBSR_DAC2W</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">dbcr_dac</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="w">) &amp;= ~(DBCR_DAC2R</span> <span class="pc">|</span> <span class="w">DBCR_DAC2W</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">d</span><span class="pc">o</span><span class="c">_send_trap(</span><span class="w">r</span><span class="pc">egs</span><span class="c">,</span> <span class="pc">m</span><span class="c">fspr</span><span class="pc">(</span><span class="w">SPRN_DAC2</span><span class="pc">),</span> <span class="pc">d</span><span class="c">ebug_status</span><span class="pc">,</span> <span class="pc">T</span><span class="c">RAP_HWBKPT</span><span class="pc">,</span>
			     <span class="w">6</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ch</span><span class="pc">anged</span> <span class="pc">|</span><span class="c">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">01;</span>
	<span class="c">}</span>  <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">e</span><span class="c">bug_status</span> <span class="c">&amp;</span> <span class="w">DBSR_IAC1</span><span class="c">) {</span>
		<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read</span><span class="pc">.</span><span class="w">de</span><span class="pc">bug.</span><span class="w">dbcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR0_IAC1</span><span class="c">;</span>
		<span class="w">dbcr_iac_range</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="w">) &amp;= ~DBCR_IAC12MODE;</span>
		<span class="w">do_send_trap</span><span class="c">(</span><span class="w">reg</span><span class="pc">s</span><span class="c">,</span> <span class="w">mfspr(SPRN_IAC1</span><span class="c">),</span> <span class="pc">d</span><span class="c">ebug_status</span><span class="pc">,</span> <span class="w">TRAP_HWBKPT</span><span class="pc">,</span>
			     <span class="pc">1)</span><span class="c">;</span>
		<span class="w">ch</span><span class="pc">anged</span> <span class="pc">|</span><span class="c">=</span> <span class="w">0x0</span><span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>  <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(debug_status</span> <span class="pc">&amp;</span> <span class="w">DBSR_IAC2</span><span class="c">) {</span>
		<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read</span><span class="pc">.</span><span class="w">de</span><span class="pc">bug.</span><span class="w">dbcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR0_IAC2</span><span class="c">;</span>
		<span class="pc">d</span><span class="c">o_send_trap(</span><span class="w">re</span><span class="pc">gs</span><span class="c">,</span> <span class="pc">m</span><span class="c">fspr</span><span class="w">(SPRN_IAC2</span><span class="c">),</span> <span class="pc">d</span><span class="c">ebug_status</span><span class="pc">,</span> <span class="pc">T</span><span class="c">RAP_HWBKPT</span><span class="pc">,</span>
			     <span class="w">2</span><span class="c">);</span>
		<span class="w">ch</span><span class="pc">anged</span> <span class="pc">|</span><span class="c">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">01;</span>
	<span class="c">}</span>  <span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="pc">d</span><span class="c">ebug_status</span> <span class="c">&amp;</span> <span class="w">DBSR_IAC3</span><span class="c">) {</span>
		<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read.</span><span class="w">d</span><span class="pc">ebug.db</span><span class="c">cr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR0_IAC3</span><span class="c">;</span>
		<span class="w">dbcr_iac_range</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="w">) &amp;= ~DBCR_IAC34MODE;</span>
		<span class="w">do_send_trap</span><span class="c">(</span><span class="w">reg</span><span class="pc">s</span><span class="c">,</span> <span class="w">mfspr(SPRN_IAC3</span><span class="c">),</span> <span class="pc">d</span><span class="c">ebug_status</span><span class="pc">,</span> <span class="w">TRAP_HWBKPT</span><span class="pc">,</span>
			     <span class="w">3</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ch</span><span class="pc">anged</span> <span class="pc">|</span><span class="c">=</span> <span class="w">0x0</span><span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>  <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(debug_status</span> <span class="pc">&amp;</span> <span class="w">DBSR_IAC4</span><span class="c">) {</span>
		<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read</span><span class="pc">.</span><span class="w">de</span><span class="pc">bug.</span><span class="w">dbcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR0_IAC4</span><span class="c">;</span>
		<span class="pc">d</span><span class="c">o_send_trap(</span><span class="w">re</span><span class="pc">gs</span><span class="c">,</span> <span class="pc">m</span><span class="c">fspr</span><span class="w">(SPRN_IAC4</span><span class="c">),</span> <span class="pc">d</span><span class="c">ebug_status</span><span class="pc">,</span> <span class="pc">T</span><span class="c">RAP_HWBKPT</span><span class="pc">,</span>
			     <span class="w">4</span><span class="c">);</span>
		<span class="w">ch</span><span class="pc">anged</span> <span class="pc">|</span><span class="c">=</span> <span class="w">0</span><span class="pc">x0</span><span class="c">1;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">DBCR_ACTIVE_EVENTS</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">deb</span><span class="pc">ug.</span><span class="w">d</span><span class="pc">b</span><span class="c">cr0</span><span class="pc">,</span>
			       <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read.</span><span class="w">d</span><span class="pc">ebug</span><span class="c">.</span><span class="w">dbcr1</span><span class="pc">))</span>
		<span class="w">regs</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">MSR_DE</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		
		<span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read.</span><span class="w">de</span><span class="pc">b</span><span class="c">ug</span><span class="pc">.d</span><span class="c">bcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR0_IDM</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">ch</span><span class="pc">a</span><span class="c">nged</span> <span class="pc">&amp;</span> <span class="w">0x0</span><span class="pc">1)</span>
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_DBCR0</span><span class="c">,</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">d</span><span class="pc">e</span><span class="c">bug</span><span class="pc">.</span><span class="c">dbcr0);</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">__kprobes</span> <span class="w">DebugException</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*</span><span class="w">r</span><span class="pc">e</span><span class="c">gs,</span> <span class="pc">un</span><span class="c">signed</span> <span class="c">long</span> <span class="w">debug_status</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">d</span><span class="pc">ebug.</span><span class="w">dbsr</span> <span class="c">=</span> <span class="pc">d</span><span class="c">ebug_status</span><span class="pc">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">d</span><span class="c">ebug_status</span> <span class="w">&amp;</span> <span class="w">DBSR_BT</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">regs</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">MSR_DE</span><span class="c">;</span>

		
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_DBCR0</span><span class="c">,</span> <span class="w">mfspr(</span><span class="c">SPRN_DBCR0</span><span class="w">) </span><span class="pc">&amp; </span><span class="c">~</span><span class="w">DBCR0_BT</span><span class="c">);</span>
		
		<span class="pc">m</span><span class="c">tspr(</span><span class="w">SPRN_DBSR</span><span class="c">,</span> <span class="w">D</span><span class="pc">BS</span><span class="c">R_BT</span><span class="pc">)</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">user_mode</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">de</span><span class="pc">bug.</span><span class="w">dbcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">D</span><span class="pc">BC</span><span class="c">R0_BT;</span>
			<span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read.</span><span class="w">d</span><span class="pc">eb</span><span class="c">ug.dbcr0</span> <span class="pc">|</span><span class="c">=</span> <span class="w">DBCR0_IDM</span> <span class="pc">|</span> <span class="w">DBCR0_IC</span><span class="c">;</span>
			<span class="w">reg</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">MSR_DE</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">notify_die</span><span class="c">(</span><span class="w">DIE_SSTEP</span><span class="pc">, "</span><span class="w">block_step"</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs</span><span class="w">,</span> <span class="w">5</span><span class="c">,</span>
			       <span class="w">5</span><span class="c">,</span> <span class="w">SIGTRAP) </span><span class="pc">=</span><span class="c">=</span> <span class="w">NOTIFY_STOP</span><span class="c">) {</span>
			<span class="w">r</span><span class="c">eturn</span><span class="pc">;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">debugger_sstep</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">)</span>
			<span class="c">return</span><span class="pc">;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">debug_status</span> <span class="pc">&amp;</span> <span class="w">DBSR_IC</span><span class="c">) {</span> 	
		<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">MSR_DE</span><span class="c">;</span>

		
		<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_DBCR0</span><span class="c">,</span> <span class="w">mfspr</span><span class="pc">(S</span><span class="c">PRN_DBCR0</span><span class="w">) &amp;</span><span class="pc"> </span><span class="c">~</span><span class="w">DBCR0_IC</span><span class="c">);</span>
		
		<span class="pc">m</span><span class="c">tspr(</span><span class="w">SPRN_DBSR</span><span class="c">,</span> <span class="w">D</span><span class="c">BSR_IC</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">notify_die</span><span class="c">(</span><span class="w">DIE_SSTEP,</span><span class="pc"> "</span><span class="w">single_step</span><span class="c">",</span> <span class="w">r</span><span class="pc">egs</span><span class="w">,</span> <span class="w">5</span><span class="c">,</span>
			       <span class="w">5</span><span class="pc">,</span> <span class="w">SIGTRAP) </span><span class="pc">=</span><span class="c">=</span> <span class="w">NOTIFY_STOP</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span><span class="w">;</span>
		<span class="c">}</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">debugger_sstep</span><span class="c">(</span><span class="w">re</span><span class="pc">gs))</span>
			<span class="c">return</span><span class="pc">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">user_mode</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">cu</span><span class="pc">rre</span><span class="c">nt-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">deb</span><span class="pc">ug.</span><span class="w">dbcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR0_IC</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">DBCR_ACTIVE_EVENTS</span><span class="c">(</span><span class="w">c</span><span class="pc">u</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read</span><span class="pc">.</span><span class="w">de</span><span class="pc">bug.</span><span class="c">dbcr0</span><span class="pc">,</span>
					       <span class="w">cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">th</span><span class="c">read.</span><span class="w">d</span><span class="pc">eb</span><span class="c">ug.</span><span class="w">dbcr1)</span><span class="pc">)</span>
				<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">MSR_DE</span><span class="c">;</span>
			<span class="pc">e</span><span class="c">lse</span>
				
				<span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read.</span><span class="w">de</span><span class="pc">b</span><span class="c">ug</span><span class="pc">.</span><span class="c">dbcr0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">DBCR0_IDM</span><span class="c">;</span>
		<span class="pc">}</span>

		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGTRAP</span><span class="pc">,</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">TRAP_TRACE</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs-&gt;</span><span class="w">nip</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
		<span class="w">handle_debug</span><span class="c">(</span><span class="w">r</span><span class="c">egs,</span> <span class="w">debug_status</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 

<span class="pc">#if</span> <span class="pc">!</span><span class="c">defined(</span><span class="w">CONFIG_TAU_INT</span><span class="c">)</span>
<span class="w">v</span><span class="c">oid</span> <span class="w">TAUException</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">TAU</span> <span class="w">trap</span> <span class="w">a</span><span class="c">t</span> <span class="w">PC:</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">x,</span> <span class="w">MSR:</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">x,</span> <span class="w">ve</span><span class="pc">c</span><span class="c">tor=%</span><span class="w">l</span><span class="pc">x</span>    <span class="w">%</span><span class="c">s</span><span class="pc">\</span><span class="c">n",</span>
	       <span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">ms</span><span class="pc">r,</span> <span class="w">r</span><span class="c">egs-&gt;</span><span class="w">t</span><span class="c">rap</span><span class="pc">,</span> <span class="w">print_tainted()</span><span class="c">);</span>
<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 

<span class="pc">#</span><span class="c">ifdef</span> <span class="w">CONFIG_ALTIVEC</span>
<span class="w">v</span><span class="c">oid</span> <span class="w">altivec_assist_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">user_mode</span><span class="c">(regs</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">p</span><span class="c">rintk(</span><span class="w">KERN_EMERG</span> <span class="c">"</span><span class="w">VMX/Altivec</span> <span class="w">assist</span> <span class="w">exception</span> <span class="w">i</span><span class="pc">n</span> <span class="w">k</span><span class="c">ernel</span> <span class="w">m</span><span class="c">ode</span><span class="w">"</span>
		       <span class="c">"</span> <span class="w">at</span> <span class="pc">%</span><span class="w">l</span><span class="c">x\n",</span> <span class="w">reg</span><span class="c">s-&gt;</span><span class="w">nip</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">die</span><span class="pc">("</span><span class="w">Kernel</span> <span class="w">V</span><span class="c">MX</span><span class="w">/</span><span class="pc">A</span><span class="c">ltivec</span> <span class="w">a</span><span class="c">ssist</span> <span class="pc">e</span><span class="c">xception</span><span class="pc">"</span><span class="c">,</span> <span class="w">reg</span><span class="pc">s,</span> <span class="w">SIGILL</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="w">flush_altivec_to_thread</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">PPC_WARN_EMULATED</span><span class="c">(</span><span class="w">altivec</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs)</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">emulate_altivec</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">==</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ip</span> <span class="w">+</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>		
		<span class="w">emulate_single_step</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="c">rr</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EF</span><span class="c">AULT</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGSEGV</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">SEGV_ACCERR</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ip);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		
		
		<span class="w">printk_ratelimited</span><span class="c">(</span><span class="w">K</span><span class="c">ERN_ERR</span> <span class="w">"Unrecognized</span> <span class="w">altivec</span> <span class="w">instruction</span> <span class="w">"</span>
				   <span class="c">"</span><span class="w">i</span><span class="pc">n</span> <span class="c">%</span><span class="pc">s</span> <span class="w">a</span><span class="c">t</span> <span class="pc">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">comm</span><span class="c">,</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;nip);</span>
		<span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">t</span><span class="pc">h</span><span class="c">read</span><span class="pc">.</span><span class="w">vr_state</span><span class="pc">.</span><span class="w">vscr.u</span><span class="pc">[</span><span class="w">3] </span><span class="pc">|</span><span class="c">=</span> <span class="w">0x10</span><span class="pc">00</span><span class="c">0;</span>
	<span class="c">}</span>
<span class="pc">}</span>
<span class="w">#</span><span class="c">endif</span> 

<span class="pc">#</span><span class="c">ifdef</span> <span class="w">CONFIG_FSL_BOOKE</span>
<span class="w">v</span><span class="c">oid</span> <span class="w">CacheLockingException</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss</span><span class="pc">,</span>
			   <span class="c">unsigned</span> <span class="c">long</span> <span class="w">error_code</span><span class="c">)</span>
<span class="c">{</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(error_code</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ESR_DLK</span><span class="c">|</span><span class="w">ESR_ILK</span><span class="c">))</span>
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGILL</span><span class="c">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">ILL_PRVOPC</span><span class="pc">,</span> <span class="pc">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nip</span><span class="c">);</span>
	<span class="w">r</span><span class="c">eturn</span><span class="pc">;</span>
<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span> 

<span class="c">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_SPE</span>
<span class="w">v</span><span class="c">oid</span> <span class="w">SPEFloatingPointException</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="pc">x</span><span class="c">tern</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">do_spe_mathemu</span><span class="pc">(</span><span class="c">struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">spefscr</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">fpexc_mode</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">cod</span><span class="c">e</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="c">rr;</span>

	<span class="w">flush_spe_to_thread</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent);</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">efscr</span> <span class="c">=</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.s</span><span class="c">pefscr;</span>
	<span class="w">f</span><span class="pc">p</span><span class="c">exc_mode</span> <span class="c">=</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">th</span><span class="c">read</span><span class="pc">.</span><span class="w">f</span><span class="pc">p</span><span class="c">exc_mode</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="c">spefscr</span> <span class="pc">&amp;</span> <span class="w">SPEFSCR_FOVF</span><span class="pc">) &amp;&amp; </span><span class="c">(</span><span class="pc">f</span><span class="c">pexc_mode</span> <span class="w">&amp;</span> <span class="w">PR_FP_EXC_OVF</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">FPE_FLTOVF</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="c">spefscr</span> <span class="c">&amp;</span> <span class="w">SPEFSCR_FUNF</span><span class="pc">) &amp;&amp; </span><span class="c">(fpexc_mode</span> <span class="pc">&amp;</span> <span class="w">PR_FP_EXC_UND</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">FPE_FLTUND</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="c">else</span> <span class="c">if</span> <span class="pc">((</span><span class="c">spefscr</span> <span class="c">&amp;</span> <span class="w">SPEFSCR_FDBZ</span><span class="pc">) &amp;&amp; </span><span class="c">(fpexc_mode</span> <span class="c">&amp;</span> <span class="w">PR_FP_EXC_DIV</span><span class="c">))</span>
		<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">FPE_FLTDIV</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">((</span><span class="w">s</span><span class="c">pefscr</span> <span class="c">&amp;</span> <span class="w">SPEFSCR_FINV</span><span class="pc">) &amp;&amp; </span><span class="c">(</span><span class="pc">f</span><span class="c">pexc_mode</span> <span class="c">&amp;</span> <span class="w">PR_FP_EXC_INV</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">FPE_FLTINV</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="c">else</span> <span class="c">if</span> <span class="pc">((s</span><span class="c">pefscr</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">SPEFSCR_FG</span> <span class="c">|</span> <span class="w">SPEFSCR_FX)) &amp;&amp; (</span><span class="pc">f</span><span class="c">pexc_mode</span> <span class="pc">&amp;</span> <span class="w">PR_FP_EXC_RES</span><span class="c">))</span>
		<span class="w">cod</span><span class="c">e</span> <span class="c">=</span> <span class="w">FPE_FLTRES</span><span class="c">;</span>

	<span class="w">er</span><span class="pc">r</span> <span class="c">=</span> <span class="w">do_spe_mathemu</span><span class="c">(</span><span class="w">re</span><span class="pc">gs)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="w">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">nip</span> <span class="w">+</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>		
		<span class="w">emulate_single_step</span><span class="c">(</span><span class="w">r</span><span class="pc">egs)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="c">rr</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EF</span><span class="c">AULT</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGSEGV</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">SEGV_ACCERR</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ip);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="pc">E</span><span class="c">INVAL) {</span>
		
		<span class="pc">p</span><span class="c">rintk(KERN_ERR</span> <span class="c">"</span><span class="w">unrecognized</span> <span class="w">spe</span> <span class="w">instruction</span> <span class="w">"</span>
		       <span class="c">"</span><span class="w">i</span><span class="pc">n</span> <span class="c">%</span><span class="pc">s</span> <span class="w">a</span><span class="c">t</span> <span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">comm</span><span class="c">,</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ip);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGFPE</span><span class="c">,</span> <span class="w">re</span><span class="pc">gs,</span> <span class="w">cod</span><span class="c">e</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="c">ip);</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">SPEFloatingPointRoundException</span><span class="c">(struct</span> <span class="w">pt</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">e</span><span class="pc">x</span><span class="c">tern</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">speround_handler</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">preempt_disable</span><span class="pc">()</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">egs-&gt;</span><span class="w">ms</span><span class="c">r</span> <span class="pc">&amp;</span> <span class="w">MSR_SPE</span><span class="c">)</span>
		<span class="w">giveup_spe</span><span class="c">(</span><span class="w">cu</span><span class="c">rrent);</span>
	<span class="w">preempt_enable</span><span class="pc">()</span><span class="c">;</span>

	<span class="w">re</span><span class="pc">g</span><span class="c">s-&gt;</span><span class="w">nip</span> <span class="w">-</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="pc">s</span><span class="c">peround_handler(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;nip</span> <span class="w">+</span><span class="pc">=</span> <span class="w">4</span><span class="c">;</span>		
		<span class="w">emulate_single_step</span><span class="c">(</span><span class="pc">r</span><span class="c">egs);</span>
		<span class="c">return</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EF</span><span class="c">AULT) {</span>
		
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGSEGV</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">SEGV_ACCERR</span><span class="c">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ip);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="pc">E</span><span class="c">INVAL) {</span>
		
		<span class="pc">p</span><span class="c">rintk(KERN_ERR</span> <span class="c">"</span><span class="w">unrecognized</span> <span class="w">spe</span> <span class="w">instruction</span> <span class="w">"</span>
		       <span class="c">"</span><span class="w">i</span><span class="pc">n</span> <span class="c">%</span><span class="pc">s</span> <span class="w">a</span><span class="c">t</span> <span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">comm</span><span class="c">,</span> <span class="w">reg</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ip);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">_exception</span><span class="c">(</span><span class="w">SIGFPE</span><span class="c">,</span> <span class="w">re</span><span class="pc">gs,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="c">ip);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>
<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>


<span class="w">v</span><span class="c">oid</span> <span class="w">unrecoverable_exception</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="c">rintk(</span><span class="w">KERN_EMERG</span> <span class="pc">"</span><span class="w">Unrecoverable</span> <span class="w">exception</span> <span class="w">%l</span><span class="pc">x</span> <span class="w">a</span><span class="c">t</span> <span class="c">%</span><span class="w">l</span><span class="c">x\n",</span>
	       <span class="w">r</span><span class="pc">egs</span><span class="c">-&gt;</span><span class="w">trap</span><span class="pc">,</span> <span class="w">r</span><span class="c">egs-&gt;</span><span class="pc">n</span><span class="c">ip);</span>
	<span class="w">die</span><span class="pc">("</span><span class="w">U</span><span class="c">nrecoverable</span> <span class="w">e</span><span class="c">xception</span><span class="w">"</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs,</span> <span class="w">SIGABRT</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">#i</span><span class="c">f</span> <span class="pc">d</span><span class="c">efined(</span><span class="w">CONFIG_BOOKE_WDT</span><span class="pc">) </span><span class="c">||</span> <span class="c">defined(</span><span class="w">CONFIG_40x</span><span class="c">)</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">__a</span><span class="pc">t</span><span class="c">tribute__</span> <span class="pc">((</span><span class="w">weak</span><span class="pc">)</span><span class="c">)</span> <span class="w">WatchdogHandler</span><span class="c">(</span><span class="w">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	
	<span class="w">mtspr</span><span class="c">(</span><span class="w">SPRN_TCR</span><span class="c">,</span> <span class="w">mfspr</span><span class="pc">(S</span><span class="c">PRN_TCR</span><span class="w">)&amp;(~TCR_WIE))</span><span class="pc">;</span>
	<span class="w">r</span><span class="c">eturn</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">WatchdogException</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*</span><span class="pc">r</span><span class="c">egs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="c">rintk</span> <span class="c">(</span><span class="w">KERN_EMERG</span> <span class="pc">"</span><span class="w">PowerPC</span> <span class="w">Book-E</span> <span class="w">Watchdog</span> <span class="w">Exception</span><span class="c">\n");</span>
	<span class="w">WatchdogHandler</span><span class="c">(</span><span class="w">r</span><span class="c">egs</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>


<span class="w">v</span><span class="c">oid</span> <span class="w">kernel_bad_stack</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">t</span><span class="c">_regs</span> <span class="c">*regs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="c">rintk(</span><span class="w">K</span><span class="pc">ERN_EM</span><span class="c">ERG</span> <span class="pc">"</span><span class="w">Bad</span> <span class="w">k</span><span class="pc">ernel</span> <span class="w">stack</span> <span class="w">poi</span><span class="c">nter</span> <span class="pc">%</span><span class="w">l</span><span class="pc">x</span> <span class="w">a</span><span class="pc">t</span> <span class="c">%</span><span class="w">l</span><span class="pc">x</span><span class="c">\n",</span>
	       <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">gpr[1</span><span class="pc">],</span> <span class="w">r</span><span class="pc">eg</span><span class="c">s-&gt;</span><span class="w">nip</span><span class="c">);</span>
	<span class="w">die</span><span class="pc">("</span><span class="c">Bad</span> <span class="w">ke</span><span class="pc">rnel</span> <span class="c">stack</span> <span class="w">poi</span><span class="c">nter</span><span class="w">"</span><span class="pc">,</span> <span class="w">r</span><span class="pc">egs</span><span class="w">,</span> <span class="w">SIGABRT</span><span class="c">);</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="pc">__i</span><span class="c">nit</span> <span class="w">trap_init</span><span class="c">(void)</span>
<span class="c">{</span>
<span class="w">}</span>


<span class="c">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_PPC_EMULATED_STATS</span>

<span class="w">#</span><span class="c">define</span> <span class="w">WARN_EMULATED_SETUP</span><span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="w">)	.t</span><span class="pc">y</span><span class="c">pe</span> <span class="w">= </span><span class="pc">{</span><span class="c"> .name</span> <span class="w">= #t</span><span class="pc">y</span><span class="c">pe</span> <span class="w">}</span>

<span class="pc">str</span><span class="c">uct</span> <span class="w">ppc_emulated</span> <span class="w">p</span><span class="c">pc_emulated</span> <span class="w">=</span><span class="c"> {</span>
<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_ALTIVEC</span>
	<span class="w">W</span><span class="c">ARN_EMULATED_SETUP</span><span class="pc">(</span><span class="w">altivec),</span>
<span class="pc">#</span><span class="c">endif</span>
	<span class="w">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">dcba),</span>
	<span class="w">W</span><span class="c">ARN_EMULATED_SETUP</span><span class="pc">(</span><span class="w">dcbz</span><span class="c">),</span>
	<span class="w">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">fp_pair</span><span class="c">),</span>
	<span class="pc">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">isel</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">WARN_EMULATED_SETUP(</span><span class="w">mcrxr</span><span class="c">),</span>
	<span class="w">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">mfpvr</span><span class="c">),</span>
	<span class="c">WARN_EMULATED_SETUP(</span><span class="w">multiple</span><span class="c">),</span>
	<span class="c">WARN_EMULATED_SETUP(</span><span class="w">popcntb</span><span class="c">),</span>
	<span class="c">WARN_EMULATED_SETUP(</span><span class="w">spe</span><span class="c">),</span>
	<span class="c">WARN_EMULATED_SETUP(</span><span class="w">str</span><span class="pc">i</span><span class="c">ng),</span>
	<span class="c">WARN_EMULATED_SETUP(</span><span class="w">sy</span><span class="pc">n</span><span class="c">c),</span>
	<span class="c">WARN_EMULATED_SETUP(</span><span class="w">unaligned</span><span class="c">),</span>
<span class="w">#i</span><span class="pc">fd</span><span class="c">ef</span> <span class="w">CONFIG_MATH_EMULATION</span>
	<span class="pc">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">math)</span><span class="pc">,</span>
<span class="pc">#e</span><span class="c">ndif</span>
<span class="c">#ifdef</span> <span class="w">CONFIG_VSX</span>
	<span class="pc">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">vsx</span><span class="pc">)</span><span class="c">,</span>
<span class="c">#endif</span>
<span class="c">#ifdef</span> <span class="w">CONFIG_PPC64</span>
	<span class="w">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">mfdscr)</span><span class="pc">,</span>
	<span class="pc">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">mtdscr</span><span class="pc">)</span><span class="c">,</span>
	<span class="pc">W</span><span class="c">ARN_EMULATED_SETUP(</span><span class="w">lq_stq</span><span class="c">),</span>
<span class="pc">#</span><span class="c">endif</span>
<span class="w">}</span><span class="pc">;</span>

<span class="w">u3</span><span class="c">2</span> <span class="w">ppc_warn_emulated</span><span class="pc">;</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">ppc_warn_emulated_print</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">pr_warn_ratelimited("</span><span class="pc">%</span><span class="c">s</span> <span class="w">us</span><span class="pc">ed</span> <span class="w">emulated</span> <span class="w">%</span><span class="c">s</span> <span class="w">instruction</span><span class="pc">\</span><span class="c">n",</span> <span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">comm</span><span class="c">,</span>
			    <span class="w">t</span><span class="c">ype</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">__init</span> <span class="w">ppc_warn_emulated_init</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">den</span><span class="c">try</span> <span class="c">*</span><span class="w">di</span><span class="c">r</span><span class="pc">,</span><span class="c"> *</span><span class="w">d</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">ppc_emulated_entry</span> <span class="c">*</span><span class="w">ent</span><span class="pc">ri</span><span class="c">es</span> <span class="pc">= </span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="w">*</span><span class="pc">)&amp;</span><span class="w">ppc_emulated</span><span class="c">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">powerpc_debugfs_root</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">-</span><span class="c">ENODEV;</span>

	<span class="w">di</span><span class="pc">r</span> <span class="c">=</span> <span class="w">debugfs_create_dir</span><span class="pc">("</span><span class="w">emulated_instructions</span><span class="pc">"</span><span class="c">,</span>
				 <span class="w">p</span><span class="pc">o</span><span class="c">werpc_debugfs_root);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">di</span><span class="c">r)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="w">d</span> <span class="c">=</span> <span class="w">debugfs_create_u32</span><span class="pc">("</span><span class="w">do_warn</span><span class="c">",</span> <span class="w">S</span><span class="c">_IRUGO</span> <span class="pc">|</span> <span class="pc">S</span><span class="c">_IWUSR,</span> <span class="w">d</span><span class="pc">i</span><span class="c">r,</span>
			       <span class="pc">&amp;</span><span class="w">ppc_warn_emulated</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">d</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">f</span><span class="c">ail;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">ppc_emulated)/s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*</span><span class="w">ent</span><span class="pc">ri</span><span class="c">es</span><span class="w">);</span> <span class="pc">i++) </span><span class="c">{</span>
		<span class="w">d</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">e</span><span class="c">bugfs_create_u32(</span><span class="w">ent</span><span class="pc">ri</span><span class="c">es</span><span class="pc">[</span><span class="c">i].</span><span class="pc">n</span><span class="c">ame,</span> <span class="w">S</span><span class="c">_IRUGO</span> <span class="w">|</span> <span class="w">S</span><span class="c">_IWUSR</span><span class="pc">,</span> <span class="w">di</span><span class="c">r</span><span class="pc">,</span>
				       <span class="w">(u</span><span class="pc">3</span><span class="c">2</span> <span class="pc">*</span><span class="c">)&amp;</span><span class="w">en</span><span class="pc">tri</span><span class="c">es</span><span class="pc">[i].</span><span class="w">v</span><span class="c">al</span><span class="pc">.</span><span class="w">cou</span><span class="pc">nte</span><span class="c">r);</span>
		<span class="c">if</span> <span class="pc">(!d</span><span class="c">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="pc">f</span><span class="c">ail;</span>
	<span class="pc">}</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

<span class="pc">f</span><span class="c">ail:</span>
	<span class="w">debugfs_remove_recursive</span><span class="c">(</span><span class="w">di</span><span class="pc">r</span><span class="c">);</span>
	<span class="c">return</span> <span class="w">-</span><span class="pc">ENOM</span><span class="c">EM;</span>
<span class="c">}</span>

<span class="w">device_initcall</span><span class="c">(</span><span class="w">ppc_warn_emulated_init</span><span class="c">);</span>

<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span> 

</pre>
</body>
</html>

