<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>

<span class="w">#ifndef</span> <span class="w">DEBUG_H</span>
<span class="w">#define</span> <span class="w">DEBUG_H</span>

<span class="w">#include</span> <span class="w">&lt;linux/string.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/spinlock.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/time.</span><span class="c">h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">uapi</span><span class="c">/</span><span class="w">as</span><span class="pc">m/</span><span class="w">d</span><span class="pc">eb</span><span class="c">ug.h&gt;</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">DEBUG_MAX_LEVEL</span>            <span class="w">6</span>  
<span class="c">#define</span> <span class="w">DEBUG_OFF_LEVEL</span>            <span class="pc">-</span><span class="c">1</span> 
<span class="c">#define</span> <span class="w">DEBUG_FLUSH_ALL</span>            <span class="pc">-</span><span class="c">1</span> 
<span class="c">#define</span> <span class="w">DEBUG_MAX_VIEWS</span>            <span class="w">1</span><span class="pc">0</span> 
<span class="c">#define</span> <span class="w">DEBUG_MAX_NAME_LEN</span>         <span class="w">6</span><span class="pc">4</span> 
<span class="c">#define</span> <span class="w">DEBUG_DEFAULT_LEVEL</span>        <span class="c">3</span>  

<span class="c">#define</span> <span class="w">DEBUG_DIR_ROOT</span> <span class="w">"s390dbf</span><span class="c">"</span> 

<span class="c">#define</span> <span class="w">DEBUG_DATA(ent</span><span class="pc">ry</span><span class="w">) </span><span class="pc">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span><span class="w">*</span><span class="pc">)(</span><span class="w">en</span><span class="pc">t</span><span class="c">ry</span> <span class="w">+</span> <span class="c">1</span><span class="pc">)</span> 
                                             

<span class="w">t</span><span class="c">ypedef</span> <span class="c">struct</span> <span class="w">__debug_entry</span> <span class="w">debug_entry_t</span><span class="c">;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">debug_view</span><span class="pc">;</span>

<span class="w">t</span><span class="c">ypedef</span> <span class="c">struct</span> <span class="w">debug_info</span> <span class="c">{</span>	
	<span class="pc">s</span><span class="c">truct</span> <span class="w">d</span><span class="c">ebug_info*</span> <span class="c">next;</span>
	<span class="c">struct</span> <span class="w">d</span><span class="pc">ebug_i</span><span class="c">nfo*</span> <span class="pc">pr</span><span class="c">ev;</span>
	<span class="w">a</span><span class="c">tomic_t</span> <span class="w">ref_count</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">inlock_t</span> <span class="c">lock;</span>			
	<span class="pc">i</span><span class="c">nt</span> <span class="w">le</span><span class="pc">v</span><span class="c">el;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">nr_areas</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">pages_per_area</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">b</span><span class="pc">uf_</span><span class="c">size;</span>
	<span class="c">int</span> <span class="w">entry_size</span><span class="c">;</span>	
	<span class="w">d</span><span class="pc">ebug_e</span><span class="c">ntry_t</span><span class="w">***</span> <span class="w">areas</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">active_area</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">*active_pages</span><span class="c">;</span>
	<span class="c">int</span> <span class="pc">*</span><span class="w">active_entries</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try*</span> <span class="w">debugfs_root_entry</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">den</span><span class="c">try*</span> <span class="w">debugfs_entries</span><span class="pc">[</span><span class="w">DEBUG_MAX_VIEWS</span><span class="c">];</span>
	<span class="c">struct</span> <span class="w">debug_view</span><span class="c">*</span> <span class="w">views</span><span class="pc">[D</span><span class="c">EBUG_MAX_VIEWS];</span>	
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="pc">n</span><span class="c">ame[</span><span class="w">DEBUG_MAX_NAME_LEN</span><span class="c">];</span>
	<span class="w">umode_t</span> <span class="w">m</span><span class="pc">o</span><span class="c">de;</span>
<span class="w">}</span> <span class="w">debug_info_t</span><span class="c">;</span>

<span class="pc">t</span><span class="c">ypedef</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">(debug_header_proc_t</span><span class="pc">) </span><span class="c">(</span><span class="w">d</span><span class="pc">ebug_i</span><span class="c">nfo_t</span><span class="pc">*</span> <span class="w">i</span><span class="c">d,</span>
				   <span class="pc">s</span><span class="c">truct</span> <span class="pc">deb</span><span class="c">ug_view*</span> <span class="w">view</span><span class="pc">,</span>
				   <span class="pc">i</span><span class="c">nt</span> <span class="w">ar</span><span class="pc">e</span><span class="c">a</span><span class="pc">,</span>
				   <span class="w">debug_entry_t</span><span class="c">*</span> <span class="w">e</span><span class="pc">n</span><span class="c">try</span><span class="pc">,</span>
				   <span class="w">c</span><span class="pc">h</span><span class="c">ar*</span> <span class="w">out_buf</span><span class="pc">);</span>

<span class="pc">t</span><span class="c">ypedef</span> <span class="c">int</span> <span class="w">(debug_format_proc_t</span><span class="pc">) </span><span class="c">(</span><span class="w">d</span><span class="c">ebug_info_t*</span> <span class="w">i</span><span class="c">d,</span>
				   <span class="pc">s</span><span class="c">truct</span> <span class="c">debug_view*</span> <span class="c">view</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar*</span> <span class="w">o</span><span class="c">ut_buf,</span>
				   <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">char*</span> <span class="w">in_buf</span><span class="pc">)</span><span class="c">;</span>
<span class="w">t</span><span class="c">ypedef</span> <span class="c">int</span> <span class="pc">(</span><span class="w">debug_prolog_proc_t</span><span class="pc">) </span><span class="c">(</span><span class="w">d</span><span class="c">ebug_info_t*</span> <span class="w">i</span><span class="pc">d</span><span class="c">,</span>
				   <span class="c">struct</span> <span class="pc">debug_v</span><span class="c">iew*</span> <span class="c">view</span><span class="pc">,</span>
				   <span class="w">c</span><span class="pc">h</span><span class="c">ar*</span> <span class="c">out_buf);</span>
<span class="pc">t</span><span class="c">ypedef</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">(debug_input_proc_t</span><span class="pc">) </span><span class="c">(</span><span class="w">d</span><span class="pc">ebug_i</span><span class="c">nfo_t*</span> <span class="w">i</span><span class="pc">d</span><span class="c">,</span>
				  <span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="c">debug_view*</span> <span class="c">view</span><span class="pc">,</span>
				  <span class="pc">s</span><span class="c">truct</span> <span class="w">f</span><span class="pc">i</span><span class="c">le*</span> <span class="c">file,</span>
				  <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">char</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*</span><span class="w">user_buf</span><span class="c">,</span>
				  <span class="pc">s</span><span class="c">ize_t</span> <span class="w">in_buf_size</span><span class="c">,</span> <span class="w">l</span><span class="c">off_t*</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset);</span>

<span class="c">int</span> <span class="w">debug_dflt_header_fn</span><span class="c">(</span><span class="w">d</span><span class="pc">ebug_inf</span><span class="c">o_t*</span> <span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="c">struct</span> <span class="c">debug_view*</span> <span class="c">view,</span>
		         <span class="pc">i</span><span class="c">nt</span> <span class="w">ar</span><span class="pc">e</span><span class="c">a,</span> <span class="w">debug_entry_t</span><span class="pc">*</span> <span class="w">e</span><span class="pc">n</span><span class="c">try,</span> <span class="w">c</span><span class="c">har*</span> <span class="w">out_buf</span><span class="pc">)</span><span class="c">;</span>						
				
<span class="pc">s</span><span class="c">truct</span> <span class="pc">deb</span><span class="c">ug_view</span> <span class="pc">{</span>
	<span class="pc">c</span><span class="c">har</span> <span class="w">n</span><span class="c">ame[</span><span class="w">DEBUG_MAX_NAME_LEN</span><span class="c">];</span>
	<span class="w">debug_prolog_proc_t</span><span class="pc">*</span> <span class="w">prolog_proc</span><span class="pc">;</span>
	<span class="w">debug_header_proc_t</span><span class="pc">*</span> <span class="w">header_proc</span><span class="c">;</span>
	<span class="w">debug_format_proc_t</span><span class="c">*</span> <span class="w">format_proc</span><span class="c">;</span>
	<span class="w">debug_input_proc_t</span><span class="c">*</span>  <span class="w">input_proc</span><span class="c">;</span>
	<span class="w">v</span><span class="c">oid*</span>                <span class="w">p</span><span class="pc">riva</span><span class="c">te_data;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">e</span><span class="c">xtern</span> <span class="pc">s</span><span class="c">truct</span> <span class="c">debug_view</span> <span class="w">debug_hex_ascii_view</span><span class="c">;</span>
<span class="c">extern</span> <span class="pc">s</span><span class="c">truct</span> <span class="c">debug_view</span> <span class="w">debug_raw_view</span><span class="c">;</span>
<span class="pc">e</span><span class="c">xtern</span> <span class="c">struct</span> <span class="c">debug_view</span> <span class="w">debug_sprintf_view</span><span class="c">;</span>



<span class="w">debug_entry_t</span><span class="pc">*</span> <span class="w">debug_event_common</span><span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="w">i</span><span class="pc">d,</span> <span class="w">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el,</span> 
                                  <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="pc">v</span><span class="c">oid*</span> <span class="c">data</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">leng</span><span class="c">th);</span>

<span class="w">d</span><span class="pc">ebug_en</span><span class="c">try_t*</span> <span class="w">debug_exception_common</span><span class="c">(</span><span class="w">debug_i</span><span class="c">nfo_t</span><span class="pc">*</span> <span class="w">i</span><span class="c">d,</span> <span class="c">int</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> 
                                      <span class="c">const</span> <span class="pc">v</span><span class="c">oid*</span> <span class="c">data,</span> <span class="c">int</span> <span class="pc">leng</span><span class="c">th</span><span class="pc">)</span><span class="c">;</span>



<span class="w">d</span><span class="pc">ebug_i</span><span class="c">nfo_t</span> <span class="pc">*</span><span class="w">debug_register</span><span class="c">(const</span> <span class="c">char</span> <span class="c">*name,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">pa</span><span class="pc">g</span><span class="c">es,</span> <span class="c">int</span> <span class="w">nr_areas</span><span class="c">,</span>
                             <span class="c">int</span> <span class="w">bu</span><span class="pc">f_</span><span class="c">size</span><span class="pc">)</span><span class="c">;</span>

<span class="w">d</span><span class="c">ebug_info_t</span> <span class="pc">*</span><span class="w">debug_register_mode</span><span class="c">(</span><span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*name,</span> <span class="c">int</span> <span class="w">pa</span><span class="pc">g</span><span class="c">es,</span> <span class="c">int</span> <span class="c">nr_areas</span><span class="pc">,</span>
				  <span class="c">int</span> <span class="w">b</span><span class="pc">uf_</span><span class="c">size,</span> <span class="w">umode_t</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">uid_t</span> <span class="w">u</span><span class="pc">i</span><span class="c">d,</span>
				  <span class="w">gid_t</span> <span class="w">gid</span><span class="pc">)</span><span class="c">;</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">debug_unregister</span><span class="c">(</span><span class="w">d</span><span class="pc">ebug_i</span><span class="c">nfo_t*</span> <span class="w">i</span><span class="pc">d)</span><span class="c">;</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">debug_set_level</span><span class="c">(</span><span class="w">d</span><span class="c">ebug_info_t*</span> <span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">new_level</span><span class="pc">)</span><span class="c">;</span>

<span class="c">void</span> <span class="w">debug_set_critical</span><span class="c">(</span><span class="pc">v</span><span class="c">oid);</span>
<span class="c">void</span> <span class="w">debug_stop_all</span><span class="c">(void);</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">inline</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">debug_level_enabled</span><span class="c">(</span><span class="w">d</span><span class="c">ebug_info_t*</span> <span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="c">int</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">le</span><span class="pc">v</span><span class="c">el</span> <span class="w">&lt;=</span> <span class="w">i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">le</span><span class="pc">v</span><span class="c">el;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="w">debug_entry_t*</span>
<span class="w">debug_event</span><span class="c">(</span><span class="w">d</span><span class="pc">ebug_i</span><span class="c">nfo_t*</span> <span class="w">i</span><span class="c">d</span><span class="pc">,</span> <span class="c">int</span> <span class="w">le</span><span class="pc">v</span><span class="c">el</span><span class="pc">,</span> <span class="pc">v</span><span class="c">oid*</span> <span class="c">data</span><span class="pc">,</span> <span class="c">int</span> <span class="pc">leng</span><span class="c">th)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="w">((!i</span><span class="pc">d</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="pc">&gt;</span> <span class="pc">id-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0</span><span class="w">)</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_event_common</span><span class="c">(</span><span class="pc">i</span><span class="c">d,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el,</span><span class="pc">d</span><span class="c">ata,</span><span class="w">l</span><span class="pc">eng</span><span class="c">th);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="w">debug_entry_t</span><span class="pc">*</span>
<span class="w">debug_int_event</span><span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="w">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ta</span><span class="pc">g</span><span class="c">)</span>
<span class="c">{</span>
        <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">t</span><span class="pc">=</span><span class="w">ta</span><span class="pc">g</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="w">((!i</span><span class="pc">d</span><span class="w">) |</span><span class="c">| (</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="c">&gt;</span> <span class="pc">i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0))</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_event_common</span><span class="c">(id,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">,&amp;t</span><span class="pc">,</span><span class="w">s</span><span class="pc">izeo</span><span class="c">f(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">))</span><span class="pc">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">inl</span><span class="c">ine</span> <span class="w">debug_entry_t</span> <span class="pc">*</span>
<span class="w">debug_long_event</span> <span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="pc">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">ta</span><span class="pc">g</span><span class="c">)</span>
<span class="c">{</span>
        <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">t</span><span class="pc">=</span><span class="w">tag</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="w">((!id) |</span><span class="c">| (</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="c">&gt;</span> <span class="w">i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="w">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_event_common</span><span class="c">(</span><span class="pc">i</span><span class="c">d,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">,&amp;t</span><span class="pc">,</span><span class="w">s</span><span class="pc">izeo</span><span class="c">f(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span><span class="w">))</span><span class="pc">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">inl</span><span class="c">ine</span> <span class="w">debug_entry_t</span><span class="pc">*</span>
<span class="w">debug_text_event</span><span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="w">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har*</span> <span class="w">txt</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">f</span> <span class="w">((!i</span><span class="pc">d</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="pc">&gt;</span> <span class="w">i</span><span class="pc">d-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="c">==</span> <span class="pc">0</span><span class="w">))</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_event_common</span><span class="c">(</span><span class="w">i</span><span class="c">d,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span><span class="c">txt,</span><span class="w">s</span><span class="pc">t</span><span class="c">rlen(</span><span class="pc">t</span><span class="c">xt));</span>
<span class="c">}</span>


<span class="w">e</span><span class="pc">x</span><span class="c">tern</span> <span class="w">debug_entry_t</span> <span class="pc">*</span>
<span class="w">__debug_sprintf_event</span><span class="c">(</span><span class="w">debug_info_t</span> <span class="c">*</span><span class="w">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="pc">ch</span><span class="c">ar</span> <span class="c">*</span><span class="w">s</span><span class="c">tring</span><span class="w">, ...)</span>
	<span class="w">__a</span><span class="c">ttribute__</span> <span class="c">((</span><span class="w">fo</span><span class="c">rmat</span><span class="w">(pri</span><span class="c">ntf,</span> <span class="w">3</span><span class="c">,</span> <span class="w">4))</span><span class="pc">);</span>

<span class="pc">#d</span><span class="c">efine</span> <span class="w">debug_sprintf_event</span><span class="c">(</span><span class="w">_id</span><span class="c">,</span> <span class="w">_level</span><span class="pc">,</span> <span class="w">_fmt, ...)			\</span>
<span class="w">({									\</span>
	<span class="w">d</span><span class="c">ebug_entry_t</span> <span class="w">*__ret;						\</span>
	<span class="w">d</span><span class="c">ebug_info_t</span> <span class="pc">*</span><span class="w">__id</span> <span class="pc">=</span> <span class="c">_id</span><span class="w">;					\</span>
	<span class="w">i</span><span class="c">nt</span> <span class="w">__level</span> <span class="c">=</span> <span class="w">_</span><span class="pc">l</span><span class="c">evel</span><span class="w">;</span><span class="pc">						</span><span class="c">\</span>
	<span class="w">i</span><span class="pc">f</span> <span class="w">((!</span><span class="pc">__i</span><span class="c">d</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">_</span><span class="pc">_l</span><span class="c">evel</span> <span class="pc">&gt;</span> <span class="pc">__</span><span class="c">id</span><span class="w">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">))				\</span>
		<span class="w">__</span><span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL</span><span class="w">;</span><span class="pc">	</span><span class="c">					\</span>
	<span class="w">e</span><span class="c">lse</span>								<span class="w">\</span>
		<span class="w">_</span><span class="pc">_r</span><span class="c">et</span> <span class="w">=</span> <span class="w">__debug_sprintf_event</span><span class="c">(__id,</span> <span class="pc">__</span><span class="c">level</span><span class="w">,	</span><span class="c">	\</span>
					      <span class="w">_fmt, #</span><span class="c">#</span> <span class="w">__VA_ARGS__</span><span class="pc">);	</span><span class="c">\</span>
	<span class="w">_</span><span class="pc">_r</span><span class="c">et</span><span class="w">;								\</span>
<span class="w">})</span>

<span class="w">s</span><span class="c">tatic</span> <span class="c">inline</span> <span class="w">debug_entry_t*</span>
<span class="w">debug_exception</span><span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="w">i</span><span class="pc">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="w">v</span><span class="c">oid*</span> <span class="c">data,</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">leng</span><span class="c">th</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">f</span> <span class="w">((!i</span><span class="pc">d</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="w">&gt;</span> <span class="w">i</span><span class="pc">d-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0</span><span class="w">)</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_exception_common</span><span class="c">(</span><span class="pc">i</span><span class="c">d,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el,</span><span class="pc">d</span><span class="c">ata,</span><span class="w">l</span><span class="pc">eng</span><span class="c">th);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="w">debug_entry_t</span><span class="pc">*</span>
<span class="w">debug_int_exception</span><span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="w">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ta</span><span class="pc">g</span><span class="c">)</span>
<span class="c">{</span>
        <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">t</span><span class="pc">=</span><span class="w">ta</span><span class="pc">g</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="w">((!i</span><span class="pc">d</span><span class="w">) |</span><span class="c">| (</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="c">&gt;</span> <span class="pc">i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0))</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_exception_common</span><span class="c">(id,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">,&amp;t</span><span class="pc">,</span><span class="w">s</span><span class="pc">izeo</span><span class="c">f(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">))</span><span class="pc">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">inl</span><span class="c">ine</span> <span class="w">debug_entry_t</span> <span class="pc">*</span>
<span class="w">debug_long_exception</span> <span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="pc">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">ta</span><span class="pc">g</span><span class="c">)</span>
<span class="c">{</span>
        <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">t</span><span class="pc">=</span><span class="w">tag</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="w">((!id) |</span><span class="c">| (</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="c">&gt;</span> <span class="w">i</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="w">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="w">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_exception_common</span><span class="c">(</span><span class="pc">i</span><span class="c">d,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">,&amp;t</span><span class="pc">,</span><span class="w">s</span><span class="pc">izeo</span><span class="c">f(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span><span class="w">))</span><span class="pc">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">inl</span><span class="c">ine</span> <span class="w">debug_entry_t</span><span class="pc">*</span>
<span class="w">debug_text_exception</span><span class="c">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="w">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har*</span> <span class="w">txt</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">f</span> <span class="w">((!i</span><span class="pc">d</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span> <span class="pc">&gt;</span> <span class="w">i</span><span class="pc">d-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">) |</span><span class="pc">| </span><span class="c">(id</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pages_per_area</span> <span class="c">==</span> <span class="pc">0</span><span class="w">))</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">debug_exception_common</span><span class="c">(</span><span class="w">i</span><span class="c">d,</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span><span class="c">txt,</span><span class="w">s</span><span class="pc">t</span><span class="c">rlen(</span><span class="pc">t</span><span class="c">xt));</span>
<span class="c">}</span>


<span class="w">e</span><span class="pc">x</span><span class="c">tern</span> <span class="w">debug_entry_t</span> <span class="pc">*</span>
<span class="w">__debug_sprintf_exception</span><span class="c">(</span><span class="w">debug_info_t</span> <span class="c">*</span><span class="w">i</span><span class="c">d,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="pc">,</span> <span class="pc">ch</span><span class="c">ar</span> <span class="c">*</span><span class="w">s</span><span class="c">tring</span><span class="w">, ...)</span>
	<span class="w">__a</span><span class="c">ttribute__</span> <span class="c">((</span><span class="w">fo</span><span class="c">rmat</span><span class="w">(pri</span><span class="c">ntf,</span> <span class="w">3</span><span class="c">,</span> <span class="w">4))</span><span class="pc">);</span>

<span class="pc">#d</span><span class="c">efine</span> <span class="w">debug_sprintf_exception</span><span class="c">(</span><span class="w">_id</span><span class="c">,</span> <span class="w">_level</span><span class="pc">,</span> <span class="w">_fmt, ...)			\</span>
<span class="w">({									\</span>
	<span class="w">d</span><span class="c">ebug_entry_t</span> <span class="w">*__ret;						\</span>
	<span class="w">d</span><span class="c">ebug_info_t</span> <span class="pc">*</span><span class="w">__id</span> <span class="pc">=</span> <span class="c">_id</span><span class="w">;					\</span>
	<span class="w">i</span><span class="c">nt</span> <span class="w">__level</span> <span class="c">=</span> <span class="w">_</span><span class="pc">l</span><span class="c">evel</span><span class="w">;</span><span class="pc">						</span><span class="c">\</span>
	<span class="w">i</span><span class="pc">f</span> <span class="w">((!</span><span class="pc">__i</span><span class="c">d</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">_</span><span class="pc">_l</span><span class="c">evel</span> <span class="pc">&gt;</span> <span class="pc">__</span><span class="c">id</span><span class="w">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">ev</span><span class="c">el</span><span class="w">))				\</span>
		<span class="w">__</span><span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL</span><span class="w">;</span><span class="pc">	</span><span class="c">					\</span>
	<span class="w">e</span><span class="c">lse</span>								<span class="w">\</span>
		<span class="w">_</span><span class="pc">_r</span><span class="c">et</span> <span class="w">=</span> <span class="w">__debug_sprintf_exception</span><span class="c">(__id,</span> <span class="pc">__</span><span class="c">level</span><span class="w">,	</span><span class="pc">\</span>
						  <span class="w">_fmt, #</span><span class="c">#</span> <span class="w">__VA_ARGS__);\</span>
	<span class="pc">__r</span><span class="c">et</span><span class="w">;								\</span>
<span class="w">})</span>

<span class="w">i</span><span class="c">nt</span> <span class="w">debug_register_view</span><span class="pc">(</span><span class="w">debug_info_t</span><span class="c">*</span> <span class="w">i</span><span class="pc">d</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">debug_view</span><span class="c">*</span> <span class="w">view</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">i</span><span class="c">nt</span> <span class="w">debug_unregister_view</span><span class="c">(</span><span class="w">d</span><span class="pc">ebug_i</span><span class="c">nfo_t*</span> <span class="w">i</span><span class="c">d,</span> <span class="pc">st</span><span class="c">ruct</span> <span class="c">debug_view*</span> <span class="c">view);</span>



<span class="c">#</span><span class="w">i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">DEBUG_LEVEL</span>
<span class="c">#define</span> <span class="c">DEBUG_LEVEL</span> <span class="w">4</span>
<span class="c">#</span><span class="pc">e</span><span class="c">ndif</span>

<span class="c">#define</span> <span class="w">INTERNAL_ERRMSG</span><span class="pc">(</span><span class="c">x,y</span><span class="w">...) "E"</span> <span class="w">__FILE__</span> <span class="w">"%</span><span class="pc">d</span><span class="w">:</span><span class="pc"> </span><span class="c">"</span> <span class="pc">x</span><span class="w">,</span> <span class="w">_</span><span class="pc">_L</span><span class="c">INE__,</span> <span class="c">y</span>
<span class="w">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">INTERNAL_WRNMSG</span><span class="c">(x</span><span class="pc">,</span><span class="c">y</span><span class="w">.</span><span class="c">..) "</span><span class="w">W"</span> <span class="w">_</span><span class="c">_FILE__</span> <span class="w">"%</span><span class="pc">d: </span><span class="c">"</span> <span class="w">x</span><span class="c">,</span> <span class="w">_</span><span class="pc">_L</span><span class="c">INE__,</span> <span class="c">y</span>
<span class="w">#</span><span class="c">define</span> <span class="w">INTERNAL_INFMSG</span><span class="c">(x,y</span><span class="w">.</span><span class="pc">..) </span><span class="c">"</span><span class="w">I"</span> <span class="pc">_</span><span class="c">_FILE__</span> <span class="w">"%</span><span class="pc">d: </span><span class="c">"</span> <span class="pc">x</span><span class="c">,</span> <span class="w">_</span><span class="pc">_L</span><span class="c">INE__,</span> <span class="c">y</span>
<span class="w">#</span><span class="c">define</span> <span class="w">INTERNAL_DEBMSG</span><span class="c">(x,y</span><span class="w">.</span><span class="pc">..) </span><span class="c">"</span><span class="w">D"</span> <span class="pc">_</span><span class="c">_FILE__</span> <span class="w">"%</span><span class="pc">d: </span><span class="c">"</span> <span class="pc">x</span><span class="c">,</span> <span class="w">_</span><span class="c">_LINE__,</span> <span class="c">y</span>

<span class="w">#i</span><span class="pc">f</span> <span class="w">DEBUG_LEVEL</span> <span class="w">&gt;</span> <span class="w">0</span>
<span class="c">#define</span> <span class="w">PRINT_DEBUG</span><span class="c">(x</span><span class="w">.</span><span class="pc">..)</span> <span class="pc">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="pc">KERN_D</span><span class="c">EBUG</span> <span class="w">PRINTK_HEADER</span> <span class="w">x</span> <span class="w">)</span>
<span class="c">#define</span> <span class="w">PRINT_INFO</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="pc">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="pc">KERN_I</span><span class="c">NFO</span> <span class="pc">P</span><span class="c">RINTK_HEADER</span> <span class="w">x</span> <span class="pc">)</span>
<span class="c">#define</span> <span class="w">PRINT_WARN</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="pc">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="c">KERN_WARNING</span> <span class="pc">P</span><span class="c">RINTK_HEADER</span> <span class="w">x</span> <span class="pc">)</span>
<span class="c">#define</span> <span class="w">PRINT_ERR</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="c">printk</span> <span class="c">(</span> <span class="pc">KERN_E</span><span class="c">RR</span> <span class="pc">P</span><span class="c">RINTK_HEADER</span> <span class="w">x</span> <span class="c">)</span>
<span class="c">#define</span> <span class="w">PRINT_FATAL</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="w">panic</span> <span class="c">(</span> <span class="w">P</span><span class="c">RINTK_HEADER</span> <span class="w">x</span> <span class="pc">)</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
<span class="c">#define</span> <span class="w">PRINT_DEBUG</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="w">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="pc">KERN_D</span><span class="c">EBUG</span> <span class="w">P</span><span class="pc">RINTK</span><span class="c">_HEADER</span> <span class="w">x</span> <span class="w">)</span>
<span class="c">#define</span> <span class="w">PRINT_INFO</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="pc">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="pc">K</span><span class="c">ERN_DEBUG</span> <span class="w">P</span><span class="pc">RINTK</span><span class="c">_HEADER</span> <span class="w">x</span> <span class="w">)</span>
<span class="c">#define</span> <span class="w">PRINT_WARN</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="pc">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="pc">K</span><span class="c">ERN_DEBUG</span> <span class="w">P</span><span class="pc">RINTK</span><span class="c">_HEADER</span> <span class="w">x</span> <span class="c">)</span>
<span class="c">#define</span> <span class="w">PRINT_ERR</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="pc">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="pc">K</span><span class="c">ERN_DEBUG</span> <span class="pc">P</span><span class="c">RINTK_HEADER</span> <span class="w">x</span> <span class="c">)</span>
<span class="c">#define</span> <span class="w">PRINT_FATAL</span><span class="c">(x</span><span class="w">.</span><span class="c">..)</span> <span class="pc">p</span><span class="c">rintk</span> <span class="c">(</span> <span class="pc">K</span><span class="c">ERN_DEBUG</span> <span class="pc">P</span><span class="c">RINTK_HEADER</span> <span class="w">x</span> <span class="c">)</span>
<span class="c">#</span><span class="pc">e</span><span class="c">ndif</span>				

<span class="c">#</span><span class="w">e</span><span class="c">ndif</span>				

</pre>
</body>
</html>

