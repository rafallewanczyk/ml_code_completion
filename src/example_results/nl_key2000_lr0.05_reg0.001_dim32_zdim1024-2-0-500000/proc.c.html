<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/irq.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/gfp.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/proc_fs.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/seq_file.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">i</span><span class="pc">nt</span><span class="c">errupt.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">kernel_stat</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">internals</span><span class="c">.h"</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">proc_dir_entry</span> <span class="c">*</span><span class="w">root_irq_dir</span><span class="c">;</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_SMP</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">show_irq_affinity</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="c">ype,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">s</span><span class="pc">e</span><span class="c">q_file</span> <span class="c">*</span><span class="pc">m</span><span class="c">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">de</span><span class="pc">s</span><span class="c">c</span> <span class="c">=</span> <span class="w">irq_to_desc(</span><span class="pc">(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span><span class="pc">)</span><span class="w">m</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">rivate);</span>
	<span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">cpumask</span> <span class="c">*</span><span class="w">ma</span><span class="pc">sk</span> <span class="c">=</span> <span class="w">de</span><span class="pc">sc</span><span class="c">-&gt;</span><span class="w">ir</span><span class="pc">q_da</span><span class="c">ta</span><span class="w">.affinity</span><span class="c">;</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_GENERIC_PENDING_IRQ</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">irqd_is_setaffinity_pending(</span><span class="pc">&amp;</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">ir</span><span class="pc">q_da</span><span class="c">ta))</span>
		<span class="w">m</span><span class="pc">a</span><span class="c">sk</span> <span class="c">=</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">pending_mask</span><span class="pc">;</span>
<span class="w">#</span><span class="c">endif</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="c">ype)</span>
		<span class="w">se</span><span class="pc">q</span><span class="c">_printf(</span><span class="pc">m</span><span class="w">, "%*pbl</span><span class="c">\n",</span> <span class="w">cpumask_pr_args</span><span class="pc">(</span><span class="w">mas</span><span class="pc">k</span><span class="c">));</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">%*</span><span class="w">pb</span><span class="pc">\</span><span class="c">n</span><span class="pc">",</span> <span class="w">c</span><span class="c">pumask_pr_args</span><span class="pc">(</span><span class="w">mas</span><span class="pc">k</span><span class="c">));</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">irq_affinity_hint_proc_show</span><span class="c">(struct</span> <span class="pc">se</span><span class="c">q_file</span> <span class="c">*m,</span> <span class="c">void</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">de</span><span class="pc">sc</span> <span class="c">=</span> <span class="w">irq_to_desc(</span><span class="pc">(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span><span class="pc">)</span><span class="w">m</span><span class="c">-&gt;private);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="w">cpumask_var_t</span> <span class="w">m</span><span class="pc">a</span><span class="c">sk;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">zalloc_cpumask_var</span><span class="pc">(&amp;</span><span class="w">ma</span><span class="pc">s</span><span class="c">k</span><span class="pc">,</span> <span class="w">G</span><span class="c">FP_KERNEL))</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>

	<span class="w">raw_spin_lock_irqsave</span><span class="pc">(&amp;</span><span class="w">des</span><span class="pc">c</span><span class="c">-&gt;lock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">des</span><span class="c">c-&gt;</span><span class="w">affinity_hint</span><span class="pc">)</span>
		<span class="w">cpumask_copy</span><span class="c">(</span><span class="w">ma</span><span class="pc">sk</span><span class="c">,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;affinity_hint);</span>
	<span class="w">raw_spin_unlock_irqrestore</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="pc">l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="w">se</span><span class="pc">q</span><span class="c">_printf(</span><span class="pc">m</span><span class="w">, "%*pb</span><span class="pc">\</span><span class="c">n</span><span class="pc">",</span> <span class="w">cpumask_pr_args</span><span class="pc">(</span><span class="w">mas</span><span class="pc">k</span><span class="c">));</span>
	<span class="w">free_cpumask_var</span><span class="c">(</span><span class="w">ma</span><span class="pc">s</span><span class="c">k);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">is_affinity_mask_valid</span>
<span class="pc">#</span><span class="c">define</span> <span class="c">is_affinity_mask_valid(</span><span class="w">v</span><span class="pc">a</span><span class="c">l)</span> <span class="w">1</span>
<span class="c">#endif</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">no_irq_affinity</span><span class="pc">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">irq_affinity_proc_show</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">e</span><span class="c">q_file</span> <span class="c">*</span><span class="pc">m</span><span class="c">,</span> <span class="c">void</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">show_irq_affinity</span><span class="c">(</span><span class="w">0</span><span class="c">,</span> <span class="w">m</span><span class="c">,</span> <span class="c">v);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">irq_affinity_list_proc_show</span><span class="c">(struct</span> <span class="c">seq_file</span> <span class="c">*m,</span> <span class="c">void</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">s</span><span class="pc">h</span><span class="c">ow_irq_affinity(</span><span class="w">1</span><span class="c">,</span> <span class="pc">m</span><span class="c">,</span> <span class="c">v);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">write_irq_affinity</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="c">ype,</span> <span class="c">struct</span> <span class="pc">fi</span><span class="c">le</span> <span class="c">*file,</span>
		<span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*</span><span class="pc">buff</span><span class="c">er,</span> <span class="c">size_t</span> <span class="c">count,</span> <span class="c">loff_t</span> <span class="c">*</span><span class="pc">po</span><span class="c">s)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="pc">r</span><span class="c">q</span> <span class="pc">= </span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span><span class="w">)</span><span class="pc">(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span><span class="pc">)</span><span class="w">PDE_DATA</span><span class="c">(</span><span class="w">file_inode</span><span class="pc">(</span><span class="c">file</span><span class="pc">)</span><span class="c">);</span>
	<span class="w">cpumask_var_t</span> <span class="w">new_value;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">e</span><span class="c">rr;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">irq_can_set_affinity</span><span class="c">(</span><span class="w">ir</span><span class="c">q</span><span class="w">)</span><span class="pc"> |</span><span class="c">|</span> <span class="w">no_irq_affinity</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">alloc_cpumask_var</span><span class="pc">(&amp;n</span><span class="c">ew_value</span><span class="pc">,</span> <span class="w">G</span><span class="c">FP_KERNEL))</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span><span class="pc">)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">cpumask_parselist_user</span><span class="c">(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">,</span> <span class="w">n</span><span class="c">ew_value</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">cpumask_parse_user</span><span class="c">(</span><span class="w">b</span><span class="pc">uff</span><span class="c">er,</span> <span class="pc">c</span><span class="c">ount</span><span class="pc">,</span> <span class="w">n</span><span class="c">ew_value);</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">free_cpumask</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">is_affinity_mask_valid</span><span class="c">(</span><span class="w">n</span><span class="c">ew_value</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EIN</span><span class="c">VAL;</span>
		<span class="c">goto</span> <span class="pc">f</span><span class="c">ree_cpumask;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">cpumask_intersects</span><span class="c">(new_value</span><span class="pc">,</span> <span class="w">cpu_online_mask</span><span class="pc">)) </span><span class="c">{</span>
		
		<span class="c">err</span> <span class="c">=</span> <span class="w">irq_select_affinity_usr</span><span class="c">(</span><span class="w">ir</span><span class="pc">q</span><span class="c">,</span> <span class="pc">n</span><span class="c">ew_value</span><span class="w">) ? -EI</span><span class="pc">N</span><span class="c">VAL</span> <span class="w">:</span> <span class="w">co</span><span class="pc">un</span><span class="c">t;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span>
		<span class="w">irq_set_affinity</span><span class="c">(</span><span class="w">i</span><span class="pc">r</span><span class="c">q,</span> <span class="pc">n</span><span class="c">ew_value</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">ou</span><span class="c">nt;</span>
	<span class="pc">}</span>

<span class="w">f</span><span class="c">ree_cpumask</span><span class="w">:</span>
	<span class="w">free_cpumask_var</span><span class="c">(</span><span class="pc">n</span><span class="c">ew_value);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">irq_affinity_proc_write</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*file,</span>
		<span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*</span><span class="pc">buff</span><span class="c">er,</span> <span class="c">size_t</span> <span class="c">count,</span> <span class="c">loff_t</span> <span class="c">*</span><span class="pc">po</span><span class="c">s)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">write_irq_affinity</span><span class="c">(</span><span class="w">0</span><span class="c">,</span> <span class="pc">f</span><span class="c">ile,</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er,</span> <span class="pc">c</span><span class="c">ount,</span> <span class="w">p</span><span class="pc">o</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">ssize_t</span> <span class="w">irq_affinity_list_proc_write</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file,</span>
		<span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="c">__user</span> <span class="c">*buffer,</span> <span class="c">size_t</span> <span class="c">count,</span> <span class="c">loff_t</span> <span class="c">*</span><span class="pc">po</span><span class="c">s)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">w</span><span class="c">rite_irq_affinity(</span><span class="w">1</span><span class="c">,</span> <span class="pc">f</span><span class="c">ile,</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er,</span> <span class="pc">c</span><span class="c">ount,</span> <span class="w">p</span><span class="pc">o</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">irq_affinity_proc_open</span><span class="c">(struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="c">file</span> <span class="c">*file</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">single_open</span><span class="c">(file,</span> <span class="w">irq_affinity_proc_show</span><span class="c">,</span> <span class="w">PDE_DATA</span><span class="c">(inode));</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">irq_affinity_list_proc_open</span><span class="c">(struct</span> <span class="c">inode</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="c">file</span> <span class="c">*file)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="pc">s</span><span class="c">ingle_open(</span><span class="pc">f</span><span class="c">ile,</span> <span class="w">irq_affinity_list_proc_show</span><span class="c">,</span> <span class="pc">P</span><span class="c">DE_DATA</span><span class="pc">(</span><span class="c">inode));</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">irq_affinity_hint_proc_open</span><span class="c">(struct</span> <span class="c">inode</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="c">file</span> <span class="c">*file)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="pc">s</span><span class="c">ingle_open(</span><span class="pc">f</span><span class="c">ile,</span> <span class="w">irq_affinity_hint_proc_show</span><span class="c">,</span> <span class="pc">P</span><span class="c">DE_DATA</span><span class="pc">(</span><span class="c">inode));</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">const</span> <span class="c">struct</span> <span class="c">file_operations</span> <span class="w">irq_affinity_proc_fops</span> <span class="c">= {</span>
	<span class="c">.open</span>		<span class="c">=</span> <span class="w">irq_affinity_proc_open</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">ead</span>		<span class="c">=</span> <span class="w">seq_read</span><span class="c">,</span>
	<span class="c">.llseek</span>		<span class="c">=</span> <span class="w">seq_lseek</span><span class="c">,</span>
	<span class="c">.release</span>	<span class="c">=</span> <span class="w">single_release</span><span class="c">,</span>
	<span class="pc">.w</span><span class="c">rite</span>		<span class="c">=</span> <span class="w">irq_affinity_proc_write</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="c">file_operations</span> <span class="w">irq_affinity_hint_proc_fops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">op</span><span class="c">en</span>		<span class="c">=</span> <span class="w">irq_affinity_hint_proc_open</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">ead</span>		<span class="c">=</span> <span class="pc">seq_r</span><span class="c">ead,</span>
	<span class="c">.llseek</span>		<span class="c">=</span> <span class="pc">se</span><span class="c">q_lseek,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">elease</span>	<span class="c">=</span> <span class="pc">s</span><span class="c">ingle_release,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="c">file_operations</span> <span class="w">irq_affinity_list_proc_fops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">op</span><span class="c">en</span>		<span class="c">=</span> <span class="w">irq_affinity_list_proc_open</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">ead</span>		<span class="c">=</span> <span class="c">seq_read,</span>
	<span class="c">.llseek</span>		<span class="c">=</span> <span class="c">seq_lseek,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">elease</span>	<span class="c">=</span> <span class="c">single_release,</span>
	<span class="c">.</span><span class="pc">w</span><span class="c">rite</span>		<span class="c">=</span> <span class="w">irq_affinity_list_proc_write</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">default_affinity_show</span><span class="c">(struct</span> <span class="pc">s</span><span class="c">eq_file</span> <span class="c">*</span><span class="pc">m</span><span class="c">,</span> <span class="c">void</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="w">se</span><span class="pc">q_p</span><span class="c">rintf(m</span><span class="w">, "%*pb</span><span class="pc">\</span><span class="c">n",</span> <span class="w">cpumask_pr_args</span><span class="pc">(</span><span class="w">irq_default_affinity</span><span class="pc">)</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">default_affinity_write</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file,</span>
		<span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="pc">_</span><span class="c">_user</span> <span class="c">*buffer,</span> <span class="c">size_t</span> <span class="c">count,</span> <span class="c">loff_t</span> <span class="c">*ppos)</span>
<span class="c">{</span>
	<span class="w">cpumask_var_t</span> <span class="w">new_value</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="c">rr;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">alloc_cpumask_var(</span><span class="pc">&amp;</span><span class="w">n</span><span class="c">ew_value</span><span class="pc">,</span> <span class="w">G</span><span class="c">FP_KERNEL))</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">cpumask_parse_user</span><span class="c">(</span><span class="w">b</span><span class="pc">uff</span><span class="c">er,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt,</span> <span class="w">n</span><span class="c">ew_value</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">o</span><span class="c">ut;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">is_affinity_mask_valid</span><span class="c">(new_value)) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">= -</span><span class="pc">EIN</span><span class="c">VAL;</span>
		<span class="c">goto</span> <span class="c">out;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">cpumask_intersects</span><span class="c">(</span><span class="pc">n</span><span class="c">ew_value</span><span class="pc">,</span> <span class="w">cpu_online_mask</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">err</span> <span class="c">= -EINVAL;</span>
		<span class="c">goto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="w">cpumask_copy</span><span class="pc">(</span><span class="w">irq_default_affinity</span><span class="c">,</span> <span class="c">new_value);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">co</span><span class="pc">u</span><span class="c">nt;</span>

<span class="w">o</span><span class="c">ut:</span>
	<span class="w">free_cpumask_var</span><span class="c">(new_value);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">default_affinity_open</span><span class="c">(struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="c">file</span> <span class="c">*file)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">single_open</span><span class="c">(file,</span> <span class="w">default_affinity_show</span><span class="c">,</span> <span class="w">PDE_DATA</span><span class="pc">(</span><span class="c">inode));</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">const</span> <span class="c">struct</span> <span class="c">file_operations</span> <span class="w">default_affinity_proc_fops</span> <span class="c">= {</span>
	<span class="c">.open</span>		<span class="c">=</span> <span class="c">default_affinity_open,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">ead</span>		<span class="c">=</span> <span class="w">seq_read</span><span class="c">,</span>
	<span class="c">.llseek</span>		<span class="c">=</span> <span class="w">seq_lseek</span><span class="c">,</span>
	<span class="c">.release</span>	<span class="c">=</span> <span class="w">single_release</span><span class="c">,</span>
	<span class="pc">.w</span><span class="c">rite</span>		<span class="c">=</span> <span class="w">default_affinity_write</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">irq_node_proc_show</span><span class="c">(struct</span> <span class="c">seq_file</span> <span class="c">*</span><span class="pc">m</span><span class="c">,</span> <span class="c">void</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">des</span><span class="pc">c</span> <span class="c">=</span> <span class="w">irq_to_desc(</span><span class="pc">(</span><span class="w">l</span><span class="c">ong</span><span class="pc">)</span> <span class="w">m</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">rivate);</span>

	<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(</span><span class="pc">m, "%d</span><span class="c">\n",</span> <span class="w">irq_desc_get_node</span><span class="c">(</span><span class="w">des</span><span class="pc">c)</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">irq_node_proc_open</span><span class="c">(struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*file)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">single_open</span><span class="c">(file,</span> <span class="w">irq_node_proc_show</span><span class="c">,</span> <span class="w">PDE_DATA</span><span class="c">(inode</span><span class="pc">)</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">const</span> <span class="c">struct</span> <span class="c">file_operations</span> <span class="w">irq_node_proc_fops</span> <span class="c">= {</span>
	<span class="c">.open</span>		<span class="c">=</span> <span class="c">irq_node_proc_open,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">ead</span>		<span class="c">=</span> <span class="w">seq_read</span><span class="c">,</span>
	<span class="c">.llseek</span>		<span class="c">=</span> <span class="w">seq_lseek</span><span class="c">,</span>
	<span class="c">.release</span>	<span class="c">=</span> <span class="w">single_release</span><span class="c">,</span>
<span class="c">};</span>
<span class="pc">#</span><span class="c">endif</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">irq_spurious_proc_show</span><span class="c">(struct</span> <span class="c">seq_file</span> <span class="c">*</span><span class="pc">m</span><span class="c">,</span> <span class="c">void</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">de</span><span class="pc">sc</span> <span class="c">=</span> <span class="w">irq_to_desc(</span><span class="pc">(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span><span class="pc">)</span> <span class="w">m</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">rivate</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(m, "</span><span class="w">c</span><span class="c">ount</span> <span class="pc">%</span><span class="w">u</span><span class="c">\n</span><span class="w">" "unhandled</span> <span class="pc">%u</span><span class="c">\n</span><span class="w">" </span><span class="pc">"</span><span class="w">last_unhandled</span> <span class="pc">%u</span> <span class="w">m</span><span class="pc">s\</span><span class="c">n",</span>
		   <span class="w">des</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">irq_count</span><span class="c">,</span> <span class="w">de</span><span class="pc">sc</span><span class="c">-&gt;</span><span class="w">irqs_unhandled</span><span class="c">,</span>
		   <span class="w">jiffies_to_msecs</span><span class="c">(</span><span class="w">d</span><span class="pc">esc</span><span class="c">-&gt;</span><span class="w">l</span><span class="pc">a</span><span class="c">st_unhandled</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">irq_spurious_proc_open</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="c">file</span> <span class="c">*file)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">single_open</span><span class="c">(file,</span> <span class="w">irq_spurious_proc_show</span><span class="c">,</span> <span class="w">PDE_DATA</span><span class="c">(inode</span><span class="pc">)</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">const</span> <span class="c">struct</span> <span class="c">file_operations</span> <span class="w">irq_spurious_proc_fops</span> <span class="c">= {</span>
	<span class="c">.open</span>		<span class="c">=</span> <span class="c">irq_spurious_proc_open,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">ead</span>		<span class="c">=</span> <span class="w">seq_read</span><span class="c">,</span>
	<span class="c">.llseek</span>		<span class="c">=</span> <span class="w">seq_lseek</span><span class="c">,</span>
	<span class="c">.release</span>	<span class="c">=</span> <span class="w">single_release</span><span class="c">,</span>
<span class="c">};</span>

<span class="pc">#d</span><span class="c">efine</span> <span class="w">MAX_NAMELEN</span> <span class="w">1</span><span class="pc">2</span><span class="c">8</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">name_unique</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">irq</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">irqaction</span> <span class="c">*</span><span class="w">new_action</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">de</span><span class="pc">s</span><span class="c">c</span> <span class="c">=</span> <span class="w">irq_to_desc</span><span class="c">(</span><span class="w">ir</span><span class="pc">q</span><span class="c">);</span>
	<span class="c">struct</span> <span class="pc">i</span><span class="c">rqaction</span> <span class="c">*</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="c">int</span> <span class="c">ret</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="w">raw_spin_lock_irqsave</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="pc">l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span> <span class="c">=</span> <span class="w">de</span><span class="pc">s</span><span class="c">c-&gt;</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span> <span class="c">;</span> <span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">;</span> <span class="w">ac</span><span class="pc">tio</span><span class="c">n</span> <span class="c">=</span> <span class="w">a</span><span class="pc">c</span><span class="c">tion</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="c">ext</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="pc">((</span><span class="w">a</span><span class="c">ction</span> <span class="w">!</span><span class="c">=</span> <span class="w">new_action</span><span class="pc">)</span><span class="c"> &amp;&amp;</span> <span class="w">a</span><span class="pc">ctio</span><span class="c">n</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
				<span class="pc">!</span><span class="w">s</span><span class="c">trcmp(</span><span class="w">n</span><span class="pc">e</span><span class="c">w_action-&gt;</span><span class="pc">na</span><span class="c">me,</span> <span class="w">a</span><span class="pc">c</span><span class="c">tion</span><span class="pc">-</span><span class="c">&gt;name</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">re</span><span class="c">t</span> <span class="pc">=</span> <span class="w">0</span><span class="c">;</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>
	<span class="c">}</span>
	<span class="w">raw_spin_unlock_irqrestore(</span><span class="pc">&amp;</span><span class="w">des</span><span class="pc">c</span><span class="c">-&gt;lock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">register_handler_proc</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">irq,</span> <span class="c">struct</span> <span class="w">irqaction</span> <span class="c">*</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="pc">n</span><span class="c">ame</span> <span class="pc">[</span><span class="w">MAX_NAMELEN</span><span class="c">];</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">de</span><span class="pc">s</span><span class="c">c</span> <span class="pc">=</span> <span class="w">irq_to_desc</span><span class="c">(</span><span class="w">ir</span><span class="pc">q</span><span class="c">);</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r</span> <span class="w">|</span><span class="c">|</span> <span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n-&gt;</span><span class="pc">n</span><span class="c">ame</span> <span class="pc">|</span><span class="c">|</span>
					<span class="w">!name_unique</span><span class="c">(</span><span class="w">ir</span><span class="pc">q,</span> <span class="w">ac</span><span class="c">tion</span><span class="pc">)</span><span class="c">)</span>
		<span class="pc">r</span><span class="c">eturn;</span>

	<span class="w">m</span><span class="pc">ems</span><span class="c">et(name,</span> <span class="c">0,</span> <span class="w">M</span><span class="c">AX_NAMELEN);</span>
	<span class="w">sn</span><span class="c">printf(name,</span> <span class="w">M</span><span class="c">AX_NAMELEN</span><span class="pc">, "%</span><span class="c">s",</span> <span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">-</span><span class="c">&gt;name</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">ac</span><span class="pc">t</span><span class="c">ion</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="c">r</span> <span class="c">=</span> <span class="w">proc_mkdir</span><span class="pc">(</span><span class="c">name,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">di</span><span class="c">r);</span>
<span class="pc">}</span>

<span class="pc">#</span><span class="w">u</span><span class="c">ndef</span> <span class="pc">M</span><span class="c">AX_NAMELEN</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">M</span><span class="c">AX_NAMELEN</span> <span class="w">10</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">register_irq_proc</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">rq</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">name</span> <span class="c">[</span><span class="pc">M</span><span class="c">AX_NAMELEN];</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">root_irq_dir</span> <span class="w">|</span><span class="pc">| (</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">ir</span><span class="pc">q_da</span><span class="c">ta</span><span class="w">.ch</span><span class="pc">i</span><span class="c">p</span> <span class="w">=</span><span class="pc">= </span><span class="c">&amp;</span><span class="w">no_irq_chip) </span><span class="pc">|</span><span class="c">|</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">di</span><span class="pc">r</span><span class="w">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">ems</span><span class="c">et(</span><span class="w">n</span><span class="c">ame,</span> <span class="c">0,</span> <span class="w">M</span><span class="c">AX_NAMELEN);</span>
	<span class="w">sp</span><span class="pc">r</span><span class="c">intf(</span><span class="pc">n</span><span class="c">ame</span><span class="pc">, "%</span><span class="c">d</span><span class="pc">"</span><span class="c">,</span> <span class="w">ir</span><span class="c">q);</span>

	
	<span class="w">d</span><span class="c">esc-&gt;</span><span class="w">di</span><span class="pc">r</span> <span class="c">=</span> <span class="w">proc_mkdir</span><span class="pc">(n</span><span class="c">ame,</span> <span class="w">r</span><span class="c">oot_irq_dir);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r)</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SMP</span>
	
	<span class="w">proc_create_data</span><span class="pc">("</span><span class="w">smp_affinity</span><span class="c">",</span> <span class="w">06</span><span class="c">44</span><span class="pc">,</span> <span class="w">des</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r,</span>
			 <span class="w">&amp;irq_affinity_proc_fops,</span><span class="pc"> (v</span><span class="c">oid</span> <span class="pc">*)(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng)</span><span class="w">ir</span><span class="pc">q)</span><span class="c">;</span>

	
	<span class="w">p</span><span class="c">roc_create_data</span><span class="w">(</span><span class="pc">"</span><span class="w">affinity_hint</span><span class="c">",</span> <span class="w">04</span><span class="c">44</span><span class="pc">,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r,</span>
			 <span class="w">&amp;irq_affinity_hint_proc_fops,</span><span class="pc"> (</span><span class="c">void</span> <span class="w">*</span><span class="pc">)(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng)</span><span class="w">ir</span><span class="pc">q)</span><span class="c">;</span>

	
	<span class="w">p</span><span class="c">roc_create_data</span><span class="w">(</span><span class="pc">"</span><span class="w">smp_affinity_list</span><span class="pc">",</span> <span class="w">06</span><span class="c">44</span><span class="pc">,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r,</span>
			 <span class="w">&amp;irq_affinity_list_proc_fops,</span><span class="pc"> (v</span><span class="c">oid</span> <span class="w">*</span><span class="pc">)(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng)</span><span class="w">ir</span><span class="pc">q)</span><span class="c">;</span>

	<span class="w">p</span><span class="c">roc_create_data</span><span class="w">(</span><span class="pc">"</span><span class="w">n</span><span class="pc">od</span><span class="c">e</span><span class="w">"</span><span class="pc">,</span> <span class="w">04</span><span class="c">44</span><span class="pc">,</span> <span class="w">de</span><span class="pc">s</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r,</span>
			 <span class="w">&amp;irq_node_proc_fops,</span><span class="pc"> (v</span><span class="c">oid</span> <span class="pc">*)(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng)</span><span class="w">ir</span><span class="pc">q)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span>

	<span class="w">p</span><span class="pc">ro</span><span class="c">c_create_data</span><span class="pc">("</span><span class="w">spurious</span><span class="pc">"</span><span class="c">,</span> <span class="w">04</span><span class="c">44</span><span class="pc">,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r,</span>
			 <span class="w">&amp;irq_spurious_proc_fops,</span><span class="pc"> (v</span><span class="c">oid</span> <span class="pc">*)(</span><span class="w">l</span><span class="c">ong)</span><span class="w">ir</span><span class="pc">q)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">unregister_irq_proc</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">irq,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">d</span><span class="c">esc</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="pc">n</span><span class="c">ame</span> <span class="c">[</span><span class="w">MAX_NAMELEN</span><span class="c">];</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">root_irq_dir</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="pc">des</span><span class="c">c-&gt;</span><span class="w">di</span><span class="pc">r</span><span class="c">)</span>
		<span class="c">return;</span>
<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_SMP</span>
	<span class="w">remove_proc_entry</span><span class="pc">("</span><span class="w">smp_affinity</span><span class="pc">",</span> <span class="w">de</span><span class="pc">s</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r</span><span class="c">);</span>
	<span class="pc">rem</span><span class="c">ove_proc_entry</span><span class="pc">("</span><span class="w">affinity_hint</span><span class="c">",</span> <span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="c">r);</span>
	<span class="w">r</span><span class="pc">em</span><span class="c">ove_proc_entry</span><span class="w">(</span><span class="pc">"</span><span class="w">smp_affinity_list</span><span class="c">",</span> <span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r</span><span class="c">);</span>
	<span class="w">r</span><span class="pc">em</span><span class="c">ove_proc_entry</span><span class="pc">("</span><span class="w">no</span><span class="pc">d</span><span class="c">e",</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">di</span><span class="pc">r</span><span class="c">);</span>
<span class="w">#</span><span class="c">endif</span>
	<span class="pc">r</span><span class="c">emove_proc_entry</span><span class="pc">(</span><span class="c">"</span><span class="w">spurious</span><span class="c">",</span> <span class="w">d</span><span class="c">esc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r</span><span class="c">);</span>

	<span class="w">m</span><span class="pc">ems</span><span class="c">et</span><span class="pc">(</span><span class="w">n</span><span class="c">ame,</span> <span class="c">0,</span> <span class="w">MAX_NAMELEN</span><span class="c">);</span>
	<span class="w">spr</span><span class="c">intf(</span><span class="pc">n</span><span class="c">ame</span><span class="pc">, "%u</span><span class="c">",</span> <span class="w">ir</span><span class="c">q);</span>
	<span class="w">r</span><span class="pc">em</span><span class="c">ove_proc_entry</span><span class="pc">(</span><span class="w">n</span><span class="c">ame,</span> <span class="w">root_irq_dir</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">#</span><span class="w">u</span><span class="c">ndef</span> <span class="w">M</span><span class="c">AX_NAMELEN</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">unregister_handler_proc</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="c">irq,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">irqaction</span> <span class="c">*</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">proc_remove</span><span class="c">(</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">di</span><span class="pc">r</span><span class="c">);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">register_default_affinity_proc</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_SMP</span>
	<span class="w">proc_create</span><span class="pc">("</span><span class="w">i</span><span class="pc">rq</span><span class="w">/default_smp_affinity</span><span class="c">",</span> <span class="w">06</span><span class="c">44</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL,</span>
		    <span class="w">&amp;default_affinity_proc_fops</span><span class="c">);</span>
<span class="pc">#</span><span class="c">endif</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">init_irq_proc</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">ir</span><span class="c">q;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">d</span><span class="pc">es</span><span class="c">c;</span>

	
	<span class="w">root_irq_dir</span> <span class="pc">=</span> <span class="w">proc_mkdir(</span><span class="pc">"</span><span class="w">i</span><span class="pc">rq</span><span class="c">",</span> <span class="pc">N</span><span class="c">ULL);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">root_irq_dir)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">register_default_affinity_proc</span><span class="pc">()</span><span class="c">;</span>

	
	<span class="w">for_each_irq_desc</span><span class="c">(</span><span class="w">i</span><span class="pc">r</span><span class="c">q</span><span class="pc">,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">de</span><span class="pc">s</span><span class="c">c)</span>
			<span class="w">c</span><span class="c">ontinue;</span>

		<span class="w">register_irq_proc</span><span class="c">(</span><span class="w">i</span><span class="c">rq,</span> <span class="pc">des</span><span class="c">c);</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_GENERIC_IRQ_SHOW</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">__weak</span> <span class="w">arch_show_interrupts</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">e</span><span class="c">q_file</span> <span class="c">*</span><span class="w">p</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">prec</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="pc">#</span><span class="w">i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">ACTUAL_NR_IRQS</span>
<span class="c">#</span> <span class="c">define</span> <span class="c">ACTUAL_NR_IRQS</span> <span class="w">nr_irqs</span>
<span class="c">#endif</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">show_interrupts</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">e</span><span class="c">q_file</span> <span class="c">*</span><span class="w">p</span><span class="c">,</span> <span class="c">void</span> <span class="c">*v)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">p</span><span class="c">rec</span><span class="pc">;</span>

	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags</span><span class="pc">,</span> <span class="w">any_count</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i</span> <span class="w">= *</span><span class="pc">(</span><span class="w">l</span><span class="c">off_t</span> <span class="pc">*)</span> <span class="w">v,</span> <span class="w">j</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">irqaction</span> <span class="c">*</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">irq_desc</span> <span class="c">*</span><span class="w">de</span><span class="pc">sc</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">i</span> <span class="pc">&gt;</span> <span class="w">ACTUAL_NR_IRQS</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">i</span> <span class="c">==</span> <span class="pc">A</span><span class="c">CTUAL_NR_IRQS</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">arch_show_interrupts</span><span class="pc">(p</span><span class="c">,</span> <span class="w">prec</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="c">==</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">p</span><span class="pc">r</span><span class="c">ec</span> <span class="c">=</span> <span class="w">3</span><span class="pc">,</span> <span class="pc">j</span> <span class="pc">=</span> <span class="w">1</span><span class="pc">000</span><span class="c">;</span> <span class="w">p</span><span class="pc">r</span><span class="c">ec</span> <span class="pc">&lt;</span> <span class="w">1</span><span class="pc">0</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="pc">j</span> <span class="pc">&lt;=</span> <span class="w">nr_irqs;</span><span class="pc"> </span><span class="c">++prec)</span>
			<span class="w">j</span> <span class="w">*</span><span class="pc">=</span> <span class="w">1</span><span class="pc">0</span><span class="c">;</span>

		<span class="w">se</span><span class="pc">q</span><span class="c">_printf(</span><span class="w">p, "%*s"</span><span class="c">,</span> <span class="c">prec</span> <span class="w">+</span> <span class="w">8, "");</span>
		<span class="w">for_each_online_cpu</span><span class="c">(</span><span class="w">j)</span>
			<span class="w">s</span><span class="c">eq_printf(</span><span class="w">p</span><span class="c">, "</span><span class="w">C</span><span class="pc">P</span><span class="c">U</span><span class="w">%-8d</span><span class="c">",</span> <span class="w">j</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">seq_putc</span><span class="c">(p</span><span class="w">, '\</span><span class="pc">n</span><span class="w">');</span>
	<span class="pc">}</span>

	<span class="w">irq_lock_sparse</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">des</span><span class="pc">c</span> <span class="c">=</span> <span class="w">irq_to_desc</span><span class="c">(</span><span class="w">i</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">de</span><span class="pc">sc</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">outsparse</span><span class="c">;</span>

	<span class="w">raw_spin_lock_irqsave</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="w">for_each_online_cpu</span><span class="c">(</span><span class="w">j</span><span class="pc">)</span>
		<span class="w">any_count</span> <span class="w">|</span><span class="pc">=</span> <span class="w">kstat_irqs_cpu</span><span class="pc">(</span><span class="w">i</span><span class="pc">,</span> <span class="w">j</span><span class="c">);</span>
	<span class="w">ac</span><span class="pc">tio</span><span class="c">n</span> <span class="c">=</span> <span class="w">des</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!any_count</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="c">out;</span>

	<span class="w">se</span><span class="pc">q</span><span class="c">_printf(</span><span class="w">p, "%*</span><span class="pc">d</span><span class="w">: ",</span> <span class="w">prec,</span> <span class="pc">i)</span><span class="c">;</span>
	<span class="w">f</span><span class="pc">or_</span><span class="c">each_online_cpu</span><span class="pc">(</span><span class="w">j</span><span class="pc">)</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(</span><span class="pc">p, "%</span><span class="w">10u</span> <span class="c">",</span> <span class="w">kstat_irqs_cpu</span><span class="pc">(</span><span class="c">i</span><span class="pc">,</span> <span class="w">j</span><span class="c">));</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">des</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">ir</span><span class="pc">q_</span><span class="c">data</span><span class="w">.chi</span><span class="pc">p) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">ir</span><span class="pc">q_</span><span class="c">data</span><span class="pc">.</span><span class="w">ch</span><span class="pc">i</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">irq_print_chip</span><span class="pc">)</span>
			<span class="c">desc-&gt;</span><span class="w">ir</span><span class="pc">q_d</span><span class="c">ata.</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">rq_print_chip</span><span class="w">(</span><span class="pc">&amp;</span><span class="c">desc-&gt;</span><span class="w">i</span><span class="pc">rq_d</span><span class="c">ata</span><span class="pc">,</span> <span class="w">p</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">ir</span><span class="pc">q_d</span><span class="c">ata</span><span class="w">.c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span><span class="pc">)</span>
			<span class="w">se</span><span class="pc">q</span><span class="c">_printf(</span><span class="w">p, " %8s"</span><span class="c">,</span> <span class="w">d</span><span class="c">esc-&gt;</span><span class="w">ir</span><span class="pc">q_d</span><span class="c">ata</span><span class="pc">.</span><span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="pc">n</span><span class="c">ame);</span>
		<span class="w">e</span><span class="pc">l</span><span class="c">se</span>
			<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(</span><span class="w">p, </span><span class="pc">" </span><span class="c">%</span><span class="w">8</span><span class="c">s</span><span class="w">", "-");</span>
	<span class="w">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(</span><span class="w">p, "</span><span class="pc"> </span><span class="c">%</span><span class="pc">8</span><span class="c">s</span><span class="w">"</span><span class="pc">, "</span><span class="w">None"</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">de</span><span class="pc">s</span><span class="c">c-&gt;</span><span class="w">ir</span><span class="pc">q_</span><span class="c">data</span><span class="w">.do</span><span class="c">main</span><span class="pc">)</span>
		<span class="w">s</span><span class="c">eq_printf(</span><span class="w">p, " %*</span><span class="pc">d"</span><span class="c">,</span> <span class="w">prec,</span><span class="pc"> (i</span><span class="c">nt)</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">ir</span><span class="pc">q_</span><span class="c">data</span><span class="pc">.</span><span class="w">hwirq</span><span class="c">);</span>
<span class="pc">#ifd</span><span class="c">ef</span> <span class="w">CONFIG_GENERIC_IRQ_SHOW_LEVEL</span>
	<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(</span><span class="pc">p</span><span class="w">, " %-8</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span> <span class="w">irqd_is_level_type(</span><span class="pc">&amp;</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">ir</span><span class="pc">q_</span><span class="c">data</span><span class="w">) ?</span><span class="c"> "</span><span class="w">Level</span><span class="pc">"</span><span class="c"> : "</span><span class="w">Edge</span><span class="c">");</span>
<span class="pc">#</span><span class="c">endif</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="pc">n</span><span class="c">ame)</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">q_printf(</span><span class="w">p, "-%-8</span><span class="c">s</span><span class="w">"</span><span class="c">,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;name);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="c">eq_printf(</span><span class="w">p, "  %</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span> <span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">-</span><span class="c">&gt;name);</span>
		<span class="w">w</span><span class="c">hile</span> <span class="pc">((</span><span class="w">ac</span><span class="pc">tio</span><span class="c">n</span> <span class="c">=</span> <span class="w">ac</span><span class="pc">tio</span><span class="c">n-&gt;</span><span class="w">n</span><span class="pc">e</span><span class="c">xt</span><span class="w">) !</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL)</span>
			<span class="w">s</span><span class="c">eq_printf(</span><span class="w">p, ", %</span><span class="c">s</span><span class="w">"</span><span class="c">,</span> <span class="w">ac</span><span class="pc">tio</span><span class="c">n</span><span class="pc">-</span><span class="c">&gt;name);</span>
	<span class="pc">}</span>

	<span class="w">seq_putc</span><span class="c">(</span><span class="w">p, '\n');</span>
<span class="w">ou</span><span class="pc">t</span><span class="c">:</span>
	<span class="w">raw_spin_unlock_irqrestore</span><span class="pc">(&amp;</span><span class="w">des</span><span class="pc">c</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>
<span class="w">outsparse</span><span class="pc">:</span>
	<span class="w">irq_unlock_sparse</span><span class="pc">()</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span>

</pre>
</body>
</html>

