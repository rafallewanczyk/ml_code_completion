<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>

<span class="w">#define</span> <span class="w">pr_fmt(fmt)</span> <span class="w">KBUILD_MODNAME</span> <span class="w">": "</span> <span class="w">fmt</span>

<span class="w">#include</span> <span class="w">&lt;linux/stddef.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/init.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">s</span><span class="pc">t</span><span class="c">ring.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">p</span><span class="c">inlock.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">blkdev</span><span class="c">.h&gt;</span>	
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">backing</span><span class="pc">-</span><span class="w">d</span><span class="pc">ev</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er_head</span><span class="pc">.</span><span class="c">h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">vfs</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">moduleparam</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">bi</span><span class="pc">t</span><span class="c">map.h&gt;</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">sysctl</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">logfile</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">quota</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">usnjrnl</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">di</span><span class="pc">r</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"debug.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">ind</span><span class="pc">e</span><span class="c">x.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">ino</span><span class="pc">d</span><span class="c">e.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">aops</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">layout</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">malloc</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">ntfs</span><span class="c">.h"</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">ntfs_nr_compression_users</span><span class="c">;</span>


<span class="c">static</span> <span class="w">ntfschar</span> <span class="pc">*</span><span class="w">default_upcase</span><span class="pc">;</span>
<span class="c">static</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">ntfs_nr_upcase_users</span><span class="c">;</span>


<span class="w">t</span><span class="c">ypedef</span> <span class="w">e</span><span class="c">num</span> <span class="c">{</span>
	
	<span class="w">ON_ERRORS_PANIC</span>			<span class="c">=</span> <span class="pc">0x01</span><span class="c">,</span>
	<span class="w">ON_ERRORS_REMOUNT_RO</span>		<span class="c">=</span> <span class="c">0x02,</span>
	<span class="w">ON_ERRORS_CONTINUE</span>		<span class="c">=</span> <span class="c">0x04,</span>
	
	<span class="w">ON_ERRORS_RECOVER</span>		<span class="c">=</span> <span class="w">0</span><span class="pc">x1</span><span class="c">0,</span>
<span class="pc">}</span> <span class="w">ON_ERRORS_ACTIONS</span><span class="pc">;</span>

<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="w">option_t</span> <span class="w">on_errors_arr</span><span class="c">[] = {</span>
	<span class="pc">{</span> <span class="pc">ON_ERRORS_P</span><span class="c">ANIC</span><span class="w">,	</span><span class="c">"</span><span class="w">panic"</span><span class="pc"> </span><span class="c">},</span>
	<span class="c">{</span> <span class="w">O</span><span class="pc">N_ERRORS_REM</span><span class="c">OUNT_RO</span><span class="w">,	</span><span class="c">"</span><span class="w">remount</span><span class="pc">-</span><span class="w">ro", },</span>
	<span class="pc">{</span> <span class="pc">ON_ERRORS_C</span><span class="c">ONTINUE</span><span class="w">,</span><span class="pc">	</span><span class="c">"</span><span class="w">cont</span><span class="pc">i</span><span class="c">nue</span><span class="w">",</span><span class="pc"> }</span><span class="c">,</span>
	<span class="w">{</span> <span class="w">O</span><span class="pc">N_ERRORS_REC</span><span class="c">OVER</span><span class="w">,</span><span class="pc">	</span><span class="c">"</span><span class="w">recover</span><span class="pc">"</span><span class="c"> },</span>
	<span class="c">{</span> <span class="pc">0</span><span class="c">,</span>			<span class="w">N</span><span class="c">ULL</span> <span class="pc">}</span>
<span class="c">};</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">simple_getbool</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">s</span><span class="c">,</span> <span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="c">*</span><span class="w">setval</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">s</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="pc">(!s</span><span class="c">trcmp(s</span><span class="pc">, </span><span class="c">"</span><span class="w">1") || !str</span><span class="pc">c</span><span class="c">mp(s, "</span><span class="w">yes") </span><span class="c">|| !</span><span class="w">s</span><span class="pc">t</span><span class="c">rcmp(s</span><span class="pc">,</span><span class="c"> "</span><span class="w">tr</span><span class="pc">u</span><span class="c">e</span><span class="w">"</span><span class="pc">)</span><span class="c">)</span>
			<span class="w">*s</span><span class="pc">e</span><span class="c">tval</span> <span class="c">=</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">strcmp(</span><span class="pc">s</span><span class="c">, "</span><span class="w">0"</span><span class="pc">) </span><span class="c">|| !</span><span class="w">s</span><span class="pc">t</span><span class="c">rcmp(s, "</span><span class="w">n</span><span class="c">o</span><span class="w">") ||</span>
							<span class="w">!</span><span class="c">strcmp(s, "</span><span class="w">fa</span><span class="pc">l</span><span class="c">se</span><span class="pc">"</span><span class="c">))</span>
			<span class="w">*</span><span class="pc">se</span><span class="c">tval</span> <span class="c">=</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse;</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span>
		<span class="w">*</span><span class="c">setval</span> <span class="c">=</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">parse_options</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="pc">l,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">o</span><span class="pc">pt</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="pc">p,</span><span class="c"> *</span><span class="w">v</span><span class="pc">,</span><span class="c"> *</span><span class="w">ov</span><span class="c">;</span>
	<span class="w">st</span><span class="pc">a</span><span class="c">tic</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">utf8</span> <span class="w">=</span><span class="pc"> "u</span><span class="c">tf8";</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">errors</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">sloppy</span> <span class="c">=</span> <span class="c">0</span><span class="pc">;</span>
	<span class="w">kuid_t</span> <span class="w">u</span><span class="pc">i</span><span class="c">d</span> <span class="c">=</span> <span class="w">INVALID_UID</span><span class="pc">;</span>
	<span class="w">kgid_t</span> <span class="w">gid</span> <span class="pc">=</span> <span class="w">INVALID_GID</span><span class="pc">;</span>
	<span class="w">umode_t</span> <span class="w">fmask</span> <span class="w">= </span><span class="pc">(</span><span class="w">um</span><span class="c">ode_t</span><span class="w">)-</span><span class="c">1</span><span class="w">,</span> <span class="w">dmask</span> <span class="pc">= </span><span class="c">(</span><span class="w">u</span><span class="pc">m</span><span class="c">ode_t</span><span class="w">)-</span><span class="c">1</span><span class="w">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">mft_zone_multiplier</span> <span class="pc">= -</span><span class="c">1</span><span class="pc">,</span> <span class="w">on_errors</span> <span class="pc">= </span><span class="c">-1;</span>
	<span class="c">int</span> <span class="w">show_sys_files</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1</span><span class="pc">,</span> <span class="w">case_sensitive</span> <span class="pc">= </span><span class="c">-1,</span> <span class="w">disable_sparse</span> <span class="pc">= </span><span class="c">-1</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">nls_table</span> <span class="c">*</span><span class="w">nls_map</span> <span class="pc">=</span> <span class="c">NULL</span><span class="w">,</span><span class="pc"> </span><span class="c">*</span><span class="w">old_nls</span><span class="pc">;</span>

	
<span class="w">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">NTFS_GETOPT_WITH_DEFAULT</span><span class="pc">(</span><span class="w">op</span><span class="pc">ti</span><span class="c">on,</span> <span class="w">variable</span><span class="c">,</span> <span class="w">default_value)	</span><span class="pc">\</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="c">trcmp(</span><span class="w">p</span><span class="c">,</span> <span class="w">opt</span><span class="pc">ion</span><span class="w">)) {					\</span>
		<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v)						\</span>
			<span class="w">v</span><span class="c">ariable</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efault_value</span><span class="w">;			\</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="w">{							\</span>
			<span class="w">v</span><span class="c">ariable</span> <span class="c">=</span> <span class="w">simple_strtoul</span><span class="c">(</span><span class="w">ov</span> <span class="w">=</span> <span class="w">v, &amp;v</span><span class="pc">,</span> <span class="w">0)</span><span class="pc">;	</span><span class="c">\</span>
			<span class="c">if</span> <span class="pc">(*</span><span class="w">v)</span><span class="pc">	</span><span class="c">					\</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">needs_val;				\</span>
		<span class="w">}							\</span>
	<span class="w">}</span>
<span class="w">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">NTFS_GETOPT</span><span class="c">(</span><span class="w">op</span><span class="pc">t</span><span class="c">ion,</span> <span class="w">v</span><span class="pc">ar</span><span class="c">iable</span><span class="w">)</span><span class="pc">				</span><span class="c">	\</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">t</span><span class="c">rcmp(</span><span class="w">p</span><span class="pc">,</span> <span class="w">op</span><span class="pc">ti</span><span class="c">on</span><span class="w">)) {					\</span>
		<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v)	</span><span class="c">					\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_arg;					\</span>
		<span class="w">v</span><span class="c">ariable</span> <span class="c">=</span> <span class="w">simple_strtoul</span><span class="c">(</span><span class="w">ov</span> <span class="w">=</span> <span class="w">v, </span><span class="pc">&amp;</span><span class="w">v</span><span class="pc">,</span> <span class="pc">0</span><span class="w">);		\</span>
		<span class="c">if</span> <span class="w">(*</span><span class="pc">v</span><span class="w">)							\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_val;</span><span class="pc">	</span><span class="c">				\</span>
	<span class="pc">}</span>
<span class="w">#</span><span class="c">define</span> <span class="w">NTFS_GETOPT_UID</span><span class="c">(</span><span class="w">o</span><span class="pc">p</span><span class="c">tion,</span> <span class="w">v</span><span class="pc">ar</span><span class="c">iable</span><span class="w">)		</span><span class="pc">		\</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="c">trcmp(</span><span class="w">p</span><span class="pc">,</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span><span class="w">)) {					\</span>
		<span class="w">uid_t</span> <span class="w">uid_value;</span><span class="c">					\</span>
		<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v)						\</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">needs_arg;</span><span class="pc">	</span><span class="c">				\</span>
		<span class="w">u</span><span class="pc">id_v</span><span class="c">alue</span> <span class="pc">=</span> <span class="w">simple_strtoul</span><span class="c">(</span><span class="w">ov</span> <span class="w">=</span> <span class="w">v, </span><span class="pc">&amp;</span><span class="w">v</span><span class="pc">,</span> <span class="pc">0</span><span class="w">);		\</span>
		<span class="c">if</span> <span class="w">(*v)							\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_val;</span><span class="pc">	</span><span class="c">				\</span>
		<span class="w">variable</span> <span class="pc">=</span> <span class="w">make_kuid</span><span class="c">(</span><span class="w">current_user_ns()</span><span class="pc">,</span> <span class="w">u</span><span class="c">id_value</span><span class="w">);</span><span class="pc">	</span><span class="c">\</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">uid_valid</span><span class="c">(variable</span><span class="w">))				\</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">n</span><span class="pc">eeds_v</span><span class="c">al</span><span class="w">;</span><span class="pc">	</span><span class="c">				\</span>
	<span class="w">}</span>
<span class="w">#</span><span class="c">define</span> <span class="w">NTFS_GETOPT_GID</span><span class="c">(</span><span class="w">op</span><span class="pc">t</span><span class="c">ion,</span> <span class="c">variable</span><span class="w">)</span><span class="pc">				\</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="c">trcmp(</span><span class="w">p</span><span class="c">,</span> <span class="w">o</span><span class="pc">p</span><span class="c">tion</span><span class="w">)) {					\</span>
		<span class="w">gid_t</span> <span class="w">gid_value;</span><span class="c">					\</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v)						\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_arg;</span><span class="pc">	</span><span class="c">				\</span>
		<span class="w">g</span><span class="pc">id_v</span><span class="c">alue</span> <span class="pc">=</span> <span class="w">simple_strtoul</span><span class="c">(</span><span class="w">ov</span> <span class="w">=</span> <span class="w">v, </span><span class="pc">&amp;</span><span class="w">v</span><span class="pc">,</span> <span class="pc">0</span><span class="w">);		\</span>
		<span class="c">if</span> <span class="w">(*v)							\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_val;</span><span class="pc">	</span><span class="c">				\</span>
		<span class="w">variable</span> <span class="pc">=</span> <span class="w">make_kgid</span><span class="c">(</span><span class="w">current_user_ns()</span><span class="pc">,</span> <span class="w">g</span><span class="c">id_value</span><span class="w">);</span><span class="pc">	</span><span class="c">\</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">gid_valid</span><span class="c">(variable</span><span class="w">))				\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">n</span><span class="pc">eeds_v</span><span class="c">al</span><span class="w">;</span><span class="pc">	</span><span class="c">				\</span>
	<span class="w">}</span>
<span class="w">#</span><span class="c">define</span> <span class="w">NTFS_GETOPT_OCTAL</span><span class="c">(</span><span class="w">op</span><span class="pc">t</span><span class="c">ion,</span> <span class="c">variable</span><span class="w">)</span><span class="pc">				\</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="c">trcmp(</span><span class="w">p</span><span class="c">,</span> <span class="w">o</span><span class="pc">p</span><span class="c">tion</span><span class="w">)) {					\</span>
		<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v)						\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_arg;</span><span class="pc">	</span><span class="c">				\</span>
		<span class="w">v</span><span class="c">ariable</span> <span class="c">=</span> <span class="w">simple_strtoul</span><span class="c">(</span><span class="w">ov</span> <span class="w">=</span> <span class="w">v, </span><span class="pc">&amp;</span><span class="w">v</span><span class="pc">,</span> <span class="w">8);		\</span>
		<span class="c">if</span> <span class="w">(*v)							\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_val;</span><span class="pc">	</span><span class="c">				\</span>
	<span class="pc">}</span>
<span class="w">#</span><span class="c">define</span> <span class="w">NTFS_GETOPT_BOOL</span><span class="c">(</span><span class="w">o</span><span class="pc">pt</span><span class="c">ion,</span> <span class="w">v</span><span class="pc">ar</span><span class="c">iable</span><span class="w">)		</span><span class="pc">		\</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">t</span><span class="c">rcmp(</span><span class="w">p</span><span class="pc">,</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span><span class="w">)) {					\</span>
		<span class="w">bo</span><span class="pc">o</span><span class="c">l</span> <span class="w">v</span><span class="pc">al</span><span class="w">;						\</span>
		<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">simple_getbool</span><span class="pc">(</span><span class="w">v,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">v</span><span class="c">al</span><span class="w">))				\</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">needs_bool;				\</span>
		<span class="w">v</span><span class="c">ariable</span> <span class="pc">=</span> <span class="w">v</span><span class="pc">al</span><span class="w">;</span><span class="pc">	</span><span class="c">					\</span>
	<span class="w">}</span>
<span class="w">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">NTFS_GETOPT_OPTIONS_ARRAY</span><span class="c">(</span><span class="w">o</span><span class="pc">p</span><span class="c">tion,</span> <span class="pc">var</span><span class="c">iable,</span> <span class="w">opt_array)</span><span class="pc">		\</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">t</span><span class="c">rcmp(</span><span class="w">p</span><span class="pc">,</span> <span class="w">op</span><span class="pc">ti</span><span class="c">on</span><span class="w">)) {</span><span class="pc">	</span><span class="c">				\</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">_</span><span class="pc">i</span><span class="w">;							\</span>
		<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v)						\</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">needs_arg;					\</span>
		<span class="w">ov</span> <span class="pc">=</span> <span class="w">v;</span><span class="pc">	</span><span class="c">						\</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">riable</span> <span class="w">=</span><span class="pc">= </span><span class="c">-1</span><span class="w">)	</span><span class="pc">				\</span>
			<span class="pc">v</span><span class="c">ariable</span> <span class="pc">=</span> <span class="w">0;</span><span class="pc">	</span><span class="c">				\</span>
		<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(</span><span class="w">_</span><span class="c">i</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">opt_array[_</span><span class="c">i].</span><span class="w">st</span><span class="pc">r</span> <span class="w">&amp;&amp; *o</span><span class="pc">p</span><span class="c">t_array</span><span class="pc">[</span><span class="w">_</span><span class="c">i].</span><span class="w">st</span><span class="pc">r</span><span class="w">;</span> <span class="w">_</span><span class="c">i</span><span class="w">++) \</span>
			<span class="w">i</span><span class="pc">f</span> <span class="pc">(!s</span><span class="c">trcmp(</span><span class="w">o</span><span class="c">pt_array</span><span class="pc">[_</span><span class="c">i].</span><span class="w">s</span><span class="pc">tr,</span> <span class="w">v)) {		\</span>
				<span class="w">v</span><span class="pc">a</span><span class="c">riable</span> <span class="w">|</span><span class="pc">=</span> <span class="c">opt_array[</span><span class="pc">_</span><span class="c">i].</span><span class="w">va</span><span class="pc">l</span><span class="w">;		\</span>
				<span class="w">b</span><span class="pc">r</span><span class="c">eak</span><span class="w">;					\</span>
			<span class="w">}						\</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">opt_array[</span><span class="pc">_</span><span class="c">i].</span><span class="w">s</span><span class="pc">tr</span> <span class="w">|| !*</span><span class="pc">o</span><span class="c">pt_array[</span><span class="w">_</span><span class="c">i].</span><span class="w">st</span><span class="pc">r</span><span class="w">)	</span><span class="pc">	\</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">needs_val;	</span><span class="pc">		</span><span class="c">		\</span>
	<span class="w">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">o</span><span class="pc">pt</span> <span class="w">|</span><span class="pc">| !*</span><span class="w">o</span><span class="pc">pt)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">no_mount_options</span><span class="c">;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering</span> <span class="w">w</span><span class="c">ith</span> <span class="w">mount</span> <span class="w">op</span><span class="pc">ti</span><span class="c">ons</span> <span class="w">str</span><span class="pc">i</span><span class="c">ng</span><span class="w">:</span><span class="c"> %</span><span class="pc">s"</span><span class="c">,</span> <span class="w">o</span><span class="pc">pt)</span><span class="c">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="pc">((p</span> <span class="c">=</span> <span class="w">strsep</span><span class="pc">(&amp;</span><span class="w">o</span><span class="c">pt</span><span class="w">, ","))) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">v</span> <span class="w">=</span> <span class="w">strchr</span><span class="c">(</span><span class="pc">p</span><span class="w">, '=')))</span>
			<span class="w">*v</span><span class="pc">+</span><span class="c">+ =</span> <span class="w">0</span><span class="c">;</span>
		<span class="w">NTFS_GETOPT_UID(</span><span class="pc">"</span><span class="w">ui</span><span class="c">d</span><span class="pc">"</span><span class="c">,</span> <span class="w">u</span><span class="pc">i</span><span class="c">d</span><span class="w">)</span>
		<span class="w">el</span><span class="c">se</span> <span class="w">NTFS_GETOPT_GID</span><span class="pc">("</span><span class="w">gid</span><span class="pc">"</span><span class="c">,</span> <span class="w">g</span><span class="c">id</span><span class="w">)</span>
		<span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="w">NTFS_GETOPT_OCTAL</span><span class="pc">("</span><span class="w">umask"</span><span class="c">,</span> <span class="w">fmask</span> <span class="w">=</span> <span class="w">dmask)</span>
		<span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="pc">N</span><span class="c">TFS_GETOPT_OCTAL</span><span class="pc">("f</span><span class="c">mask",</span> <span class="c">fmask</span><span class="w">)</span>
		<span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="pc">N</span><span class="c">TFS_GETOPT_OCTAL</span><span class="pc">("d</span><span class="c">mask</span><span class="pc">"</span><span class="c">,</span> <span class="w">d</span><span class="c">mask</span><span class="w">)</span>
		<span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="w">NTFS_GETOPT</span><span class="pc">("</span><span class="w">mft_zone_multiplier</span><span class="c">",</span> <span class="w">m</span><span class="c">ft_zone_multiplier</span><span class="pc">)</span>
		<span class="w">el</span><span class="c">se</span> <span class="w">NTFS_GETOPT_WITH_DEFAULT</span><span class="pc">("</span><span class="w">sloppy</span><span class="c">",</span> <span class="w">s</span><span class="c">loppy,</span> <span class="w">tr</span><span class="c">ue</span><span class="pc">)</span>
		<span class="w">el</span><span class="c">se</span> <span class="w">NTFS_GETOPT_BOOL</span><span class="pc">("</span><span class="w">show_sys_files</span><span class="pc">"</span><span class="c">,</span> <span class="w">s</span><span class="pc">h</span><span class="c">ow_sys_files</span><span class="pc">)</span>
		<span class="w">el</span><span class="c">se</span> <span class="c">NTFS_GETOPT_BOOL</span><span class="pc">("</span><span class="w">case_sensitive</span><span class="c">",</span> <span class="w">c</span><span class="c">ase_sensitive</span><span class="pc">)</span>
		<span class="w">el</span><span class="c">se</span> <span class="w">N</span><span class="pc">TFS_GETOPT_</span><span class="c">BOOL</span><span class="pc">("</span><span class="w">disable_sparse</span><span class="c">",</span> <span class="w">d</span><span class="pc">i</span><span class="c">sable_sparse</span><span class="pc">)</span>
		<span class="w">el</span><span class="c">se</span> <span class="w">NTFS_GETOPT_OPTIONS_ARRAY</span><span class="pc">("</span><span class="w">errors</span><span class="c">",</span> <span class="w">on_errors</span><span class="c">,</span>
				<span class="w">on_errors_arr)</span>
		<span class="w">el</span><span class="c">se</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!s</span><span class="c">trcmp(</span><span class="w">p</span><span class="c">, "</span><span class="w">posix") || !s</span><span class="pc">tr</span><span class="c">cmp(</span><span class="pc">p</span><span class="c">, "</span><span class="w">show_inodes</span><span class="pc">")</span><span class="c">)</span>
			<span class="w">ntfs_warning</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="w">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Ignoring</span> <span class="w">obsolete</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">%</span><span class="pc">s</span><span class="w">.",</span>
					<span class="pc">p</span><span class="w">);</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(!</span><span class="c">strcmp(</span><span class="pc">p</span><span class="c">, "</span><span class="w">nls</span><span class="pc">") </span><span class="c">|| !</span><span class="w">s</span><span class="pc">t</span><span class="c">rcmp(p</span><span class="pc">,</span><span class="c"> "</span><span class="w">iocharset")</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="c">strcmp(p, "</span><span class="w">i</span><span class="pc">och</span><span class="c">arset</span><span class="pc">"</span><span class="c">))</span>
				<span class="w">n</span><span class="pc">t</span><span class="c">fs_warning</span><span class="pc">(</span><span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Option</span> <span class="w">i</span><span class="c">ocharset</span> <span class="w">i</span><span class="c">s</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">deprecated.</span> <span class="w">Please</span> <span class="w">u</span><span class="pc">s</span><span class="c">e</span> <span class="w">"</span>
						<span class="pc">"</span><span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">nl</span><span class="c">s</span><span class="w">=&lt;charsetname&gt;</span> <span class="w">i</span><span class="pc">n</span> <span class="pc">"</span>
						<span class="c">"</span><span class="w">t</span><span class="c">he</span> <span class="w">future.</span><span class="pc">"</span><span class="c">);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v)</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">needs_arg</span><span class="c">;</span>
<span class="w">use_utf8:</span>
			<span class="w">old_nls</span> <span class="pc">=</span> <span class="w">nls_map</span><span class="c">;</span>
			<span class="w">n</span><span class="pc">ls_</span><span class="c">map</span> <span class="c">=</span> <span class="w">load_nls</span><span class="c">(</span><span class="w">v</span><span class="c">);</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="c">nls_map) {</span>
				<span class="pc">i</span><span class="c">f</span> <span class="pc">(!o</span><span class="c">ld_nls</span><span class="pc">) </span><span class="c">{</span>
					<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, "</span><span class="w">NLS</span> <span class="w">character</span> <span class="w">s</span><span class="pc">e</span><span class="c">t</span> <span class="w">"</span>
							<span class="w">"</span><span class="pc">%</span><span class="c">s</span> <span class="w">n</span><span class="c">ot</span> <span class="w">f</span><span class="c">ound</span><span class="w">.",</span> <span class="w">v);</span>
					<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
				<span class="c">}</span>
				<span class="w">n</span><span class="pc">t</span><span class="c">fs_error</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "N</span><span class="c">LS</span> <span class="w">c</span><span class="c">haracter</span> <span class="w">s</span><span class="pc">e</span><span class="c">t</span> <span class="pc">%s</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">f</span><span class="pc">ou</span><span class="c">nd</span><span class="w">.</span> <span class="w">Using</span> <span class="w">previous</span> <span class="w">one</span> <span class="w">%</span><span class="pc">s</span><span class="w">.</span><span class="pc">"</span><span class="c">,</span>
						<span class="w">v,</span> <span class="w">old_nls-</span><span class="pc">&gt;</span><span class="w">charset</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">nls_map</span> <span class="pc">=</span> <span class="c">old_nls</span><span class="pc">;</span>
			<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span>  <span class="c">{</span>
				<span class="w">unload_nls</span><span class="c">(</span><span class="pc">o</span><span class="c">ld_nls</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">trc</span><span class="c">mp(</span><span class="w">p</span><span class="pc">,</span><span class="c"> "</span><span class="w">utf8"</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">bo</span><span class="pc">o</span><span class="c">l</span> <span class="w">va</span><span class="pc">l</span> <span class="c">=</span> <span class="pc">f</span><span class="c">alse;</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Option</span> <span class="w">u</span><span class="c">tf8</span> <span class="w">i</span><span class="c">s</span> <span class="w">n</span><span class="pc">o</span> <span class="w">longer</span> <span class="w">"</span>
				   <span class="c">"</span><span class="w">s</span><span class="pc">u</span><span class="c">pported</span><span class="w">,</span> <span class="w">using</span> <span class="w">opt</span><span class="pc">ion</span> <span class="w">nls=u</span><span class="pc">t</span><span class="c">f8</span><span class="w">.</span> <span class="w">Please</span> <span class="w">"</span>
				   <span class="pc">"</span><span class="w">us</span><span class="pc">e</span> <span class="w">op</span><span class="pc">ti</span><span class="c">on</span> <span class="w">n</span><span class="pc">l</span><span class="c">s</span><span class="w">=</span><span class="pc">u</span><span class="c">tf8</span> <span class="w">i</span><span class="c">n</span> <span class="w">t</span><span class="c">he</span> <span class="w">future</span> <span class="w">a</span><span class="c">nd</span> <span class="w">"</span>
				   <span class="pc">"</span><span class="w">make</span> <span class="w">sure</span> <span class="w">u</span><span class="pc">t</span><span class="c">f8</span> <span class="w">i</span><span class="c">s</span> <span class="w">compiled</span> <span class="w">either</span> <span class="w">a</span><span class="pc">s</span> <span class="w">a</span> <span class="w">"</span>
				   <span class="c">"</span><span class="w">m</span><span class="pc">o</span><span class="c">dule</span> <span class="w">o</span><span class="pc">r</span> <span class="w">into</span> <span class="c">the</span> <span class="w">k</span><span class="c">ernel</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">v</span> <span class="w">|| !*v</span><span class="pc">)</span>
				<span class="w">va</span><span class="pc">l</span> <span class="c">=</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
			<span class="c">else</span> <span class="c">if</span> <span class="pc">(!</span><span class="w">simple_getbool</span><span class="c">(</span><span class="w">v</span><span class="pc">, &amp;v</span><span class="c">al</span><span class="pc">)</span><span class="c">)</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">needs_bool</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">v</span><span class="c">al</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">v</span> <span class="c">=</span> <span class="w">utf8</span><span class="c">;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">use_utf8</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Unrecognized</span> <span class="w">mount</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="pc">%s</span><span class="w">.",</span> <span class="w">p)</span><span class="pc">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">errors</span> <span class="pc">&lt;</span> <span class="w">INT_MAX</span><span class="c">)</span>
				<span class="pc">e</span><span class="c">rrors</span><span class="pc">+</span><span class="c">+;</span>
		<span class="pc">}</span>
<span class="pc">#</span><span class="w">u</span><span class="c">ndef</span> <span class="w">NTFS_GETOPT_OPTIONS_ARRAY</span>
<span class="c">#</span><span class="pc">u</span><span class="c">ndef</span> <span class="w">NTFS_GETOPT_BOOL</span>
<span class="c">#undef</span> <span class="w">NTFS_GETOPT</span>
<span class="c">#</span><span class="pc">u</span><span class="c">ndef</span> <span class="w">NTFS_GETOPT_WITH_DEFAULT</span>
	<span class="w">}</span>
<span class="w">no_mount_options:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="pc">r</span><span class="c">rors</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">sloppy</span><span class="c">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">f</span><span class="c">alse;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">s</span><span class="c">loppy</span><span class="pc">)</span>
		<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Sloppy</span> <span class="w">opt</span><span class="pc">ion</span> <span class="w">given.</span> <span class="w">Ignoring</span> <span class="c">"</span>
				<span class="w">"unrecognized</span> <span class="w">mount</span> <span class="w">op</span><span class="pc">tion</span><span class="w">(s)</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">continuing.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">on_errors</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!o</span><span class="c">n_errors</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">I</span><span class="pc">n</span><span class="c">valid</span> <span class="w">errors</span> <span class="w">opt</span><span class="pc">ion</span> <span class="w">argument</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">o</span><span class="pc">r</span> <span class="w">bug</span> <span class="w">i</span><span class="pc">n</span> <span class="w">op</span><span class="pc">tions</span> <span class="w">parser.</span><span class="pc">"</span><span class="c">);</span>
			<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">nls_map)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ls_map</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;nls_map</span> <span class="w">!</span><span class="c">=</span> <span class="pc">n</span><span class="c">ls_map</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">n</span><span class="pc">t</span><span class="c">fs_error</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">C</span><span class="pc">ann</span><span class="c">ot</span> <span class="w">c</span><span class="pc">h</span><span class="c">ange</span> <span class="w">NLS</span> <span class="w">character</span> <span class="w">se</span><span class="pc">t</span> <span class="w">"</span>
					<span class="pc">"</span><span class="w">on</span> <span class="w">remount.</span><span class="pc">"</span><span class="c">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
		<span class="c">}</span> 
		<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Using</span> <span class="w">N</span><span class="c">LS</span> <span class="w">ch</span><span class="c">aracter</span> <span class="w">se</span><span class="c">t</span> <span class="pc">%</span><span class="c">s</span><span class="w">.",</span> <span class="w">n</span><span class="pc">l</span><span class="c">s_map</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">charset</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ls_map</span> <span class="c">=</span> <span class="w">n</span><span class="pc">l</span><span class="c">s_map;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span>  <span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">n</span><span class="c">ls_map</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;nls_map</span> <span class="c">=</span> <span class="w">load_nls_default(</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">v</span><span class="c">ol-&gt;nls_map) {</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">def</span><span class="c">ault</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">NLS</span> <span class="w">character</span> <span class="w">se</span><span class="pc">t</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
				<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
			<span class="c">}</span>
			<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Using</span> <span class="w">de</span><span class="pc">f</span><span class="c">ault</span> <span class="w">N</span><span class="c">LS</span> <span class="w">c</span><span class="c">haracter</span> <span class="w">se</span><span class="c">t</span> <span class="w">(</span><span class="pc">%s</span><span class="w">).",</span>
					<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="pc">nl</span><span class="c">s_map</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">charset</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">mft_zone_multiplier</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">m</span><span class="pc">f</span><span class="c">t_zone_multiplier</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">v</span><span class="c">ol-&gt;mft_zone_multiplier</span> <span class="w">!</span><span class="c">=</span>
				<span class="pc">m</span><span class="c">ft_zone_multiplier</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> </span><span class="c">"</span><span class="w">C</span><span class="pc">ann</span><span class="c">ot</span> <span class="w">c</span><span class="pc">han</span><span class="c">ge</span> <span class="c">mft_zone_multiplier</span> <span class="w">"</span>
					<span class="w">"o</span><span class="pc">n</span> <span class="w">remount.</span><span class="pc">"</span><span class="c">);</span>
			<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(mft_zone_multiplier</span> <span class="w">&lt;</span> <span class="w">1</span> <span class="pc">|</span><span class="c">|</span> <span class="c">mft_zone_multiplier</span> <span class="c">&gt;</span> <span class="w">4</span><span class="c">) {</span>
			<span class="w">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="c">mft_zone_multiplier</span><span class="w">. "</span>
					<span class="pc">"</span><span class="w">Using</span> <span class="w">de</span><span class="pc">f</span><span class="c">ault</span> <span class="w">va</span><span class="pc">lu</span><span class="c">e</span><span class="w">,</span> <span class="w">i.e</span><span class="c">.</span> <span class="w">1.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">m</span><span class="c">ft_zone_multiplier</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mft_zone_multiplier</span> <span class="pc">=</span> <span class="w">m</span><span class="c">ft_zone_multiplier</span><span class="pc">;</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="pc">m</span><span class="c">ft_zone_multiplier</span><span class="pc">)</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">m</span><span class="c">ft_zone_multiplier</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">on_errors</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1)</span>
		<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">o</span><span class="c">n_errors</span> <span class="c">=</span> <span class="w">o</span><span class="c">n_errors;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">v</span><span class="c">ol-&gt;on_errors</span> <span class="w">|</span><span class="c">|</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">o</span><span class="c">n_errors</span> <span class="pc">=</span><span class="c">=</span> <span class="w">ON_ERRORS_RECOVER</span><span class="c">)</span>
		<span class="w">v</span><span class="c">ol-&gt;on_errors</span> <span class="pc">|</span><span class="c">=</span> <span class="w">ON_ERRORS_CONTINUE</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uid_valid</span><span class="c">(</span><span class="w">ui</span><span class="pc">d</span><span class="c">))</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">ui</span><span class="pc">d</span> <span class="c">=</span> <span class="w">ui</span><span class="pc">d</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">gid_valid</span><span class="c">(</span><span class="w">gid</span><span class="c">))</span>
		<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;gid</span> <span class="c">=</span> <span class="c">gid;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">fmask</span> <span class="w">!= (umode_t)-</span><span class="c">1)</span>
		<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">fm</span><span class="c">ask</span> <span class="c">=</span> <span class="w">f</span><span class="c">mask;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dmask</span> <span class="w">!</span><span class="pc">= (</span><span class="c">umode_t</span><span class="w">)-</span><span class="c">1)</span>
		<span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;dmask</span> <span class="c">=</span> <span class="w">d</span><span class="c">mask;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">show_sys_files</span> <span class="w">!</span><span class="pc">= -</span><span class="c">1</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">how_sys_files</span><span class="w">)</span>
			<span class="w">NVolSetShowSystemFiles</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">NVolClearShowSystemFiles</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">case_sensitive</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(case_sensitive</span><span class="pc">)</span>
			<span class="w">NVolSetCaseSensitive</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">NVolClearCaseSensitive</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">);</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">disable_sparse</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(disable_sparse</span><span class="w">)</span>
			<span class="w">NVolClearSparseEnabled</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="w">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">NVolSparseEnabled</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="w">)</span><span class="pc"> </span><span class="c">&amp;&amp;</span>
					<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">major_ver</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="pc">v</span><span class="c">ol-&gt;major_ver</span> <span class="w">&lt;</span> <span class="w">3</span><span class="pc">)</span>
				<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Not</span> <span class="w">enabling</span> <span class="w">sparse</span> <span class="w">"</span>
						<span class="w">"su</span><span class="pc">pport</span> <span class="w">due</span> <span class="w">t</span><span class="c">o</span> <span class="w">NTFS</span> <span class="w">volume</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="c">%</span><span class="w">i.</span><span class="pc">%</span><span class="w">i</span> <span class="w">(need</span> <span class="w">a</span><span class="c">t</span> <span class="w">least</span> <span class="w">"</span>
						<span class="pc">"</span><span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="w">3.0).",</span> <span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">ajor_ver</span><span class="pc">,</span>
						<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">minor_ver</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">e</span><span class="c">lse</span>
				<span class="w">NVolSetSparseEnabled</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="w">needs_arg</span><span class="c">:</span>
	<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">The</span> <span class="w">%</span><span class="pc">s</span> <span class="w">opt</span><span class="pc">ion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument.",</span> <span class="w">p)</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
<span class="w">needs_bool</span><span class="c">:</span>
	<span class="pc">n</span><span class="c">tfs_error(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">T</span><span class="c">he</span> <span class="w">%</span><span class="pc">s</span> <span class="w">opt</span><span class="pc">ion</span> <span class="pc">r</span><span class="c">equires</span> <span class="w">a</span> <span class="w">boolean</span> <span class="w">a</span><span class="c">rgument</span><span class="w">.</span><span class="c">",</span> <span class="w">p)</span><span class="pc">;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
<span class="w">needs_val</span><span class="c">:</span>
	<span class="w">n</span><span class="c">tfs_error(</span><span class="w">vo</span><span class="pc">l</span><span class="w">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">I</span><span class="c">nvalid</span> <span class="w">%</span><span class="pc">s</span> <span class="w">opt</span><span class="pc">ion</span> <span class="w">a</span><span class="c">rgument</span><span class="pc">:</span><span class="c"> %</span><span class="pc">s"</span><span class="c">,</span> <span class="w">p,</span> <span class="w">ov</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
<span class="c">}</span>

<span class="pc">#ifd</span><span class="c">ef</span> <span class="w">NTFS_RW</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">ntfs_write_volume_flags</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="w">VOLUME_FLAGS</span> <span class="w">fl</span><span class="c">ags)</span>
<span class="c">{</span>
	<span class="w">ntfs_inode</span> <span class="w">*ni</span> <span class="c">=</span> <span class="w">NTFS_I</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">vol_ino</span><span class="c">);</span>
	<span class="w">MFT_RECORD</span> <span class="w">*m</span><span class="pc">;</span>
	<span class="w">VOLUME_INFORMATION</span> <span class="pc">*</span><span class="w">vi</span><span class="pc">;</span>
	<span class="w">ntfs_attr_search_ctx</span> <span class="c">*</span><span class="pc">ct</span><span class="c">x</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">err;</span>

	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Entering,</span> <span class="w">o</span><span class="pc">l</span><span class="c">d</span> <span class="w">fl</span><span class="c">ags</span> <span class="w">=</span> <span class="pc">0x</span><span class="c">%x,</span> <span class="w">ne</span><span class="c">w</span> <span class="w">f</span><span class="c">lags</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">x%x</span><span class="w">.",</span>
			<span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">vol_flags</span><span class="pc">)</span><span class="c">,</span> <span class="w">l</span><span class="pc">e1</span><span class="c">6_to_cpu(</span><span class="w">f</span><span class="c">lags</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">v</span><span class="c">ol_flags</span> <span class="c">==</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">d</span><span class="c">one;</span>
	<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">ni</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">m</span> <span class="c">=</span> <span class="w">map_mft_record</span><span class="c">(</span><span class="w">ni</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">m</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="c">PTR_ERR(</span><span class="pc">m</span><span class="c">);</span>
		<span class="c">goto</span> <span class="pc">err_</span><span class="c">out;</span>
	<span class="c">}</span>
	<span class="w">ct</span><span class="pc">x</span> <span class="pc">=</span> <span class="w">ntfs_attr_get_search_ctx</span><span class="c">(</span><span class="w">ni</span><span class="c">,</span> <span class="w">m</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">c</span><span class="c">tx</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">put_unm_err_out</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ntfs_attr_lookup</span><span class="c">(</span><span class="w">AT_VOLUME_INFORMATION</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">0,</span> <span class="c">0,</span> <span class="c">0,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">,</span>
			<span class="w">ct</span><span class="c">x);</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">goto</span> <span class="pc">p</span><span class="c">ut_unm_err_out;</span>
	<span class="w">vi</span> <span class="w">=</span><span class="pc"> (</span><span class="w">VOLUME_INFORMATION*)((u</span><span class="pc">8</span><span class="c">*)</span><span class="w">ct</span><span class="c">x-&gt;</span><span class="w">a</span><span class="pc">t</span><span class="c">tr</span> <span class="w">+</span>
			<span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">c</span><span class="c">tx-&gt;</span><span class="w">a</span><span class="pc">t</span><span class="c">tr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="pc">.</span><span class="w">resident</span><span class="pc">.</span><span class="w">value_offset))</span><span class="pc">;</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">vol_flags</span> <span class="c">=</span> <span class="w">v</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="w">=</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags;</span>
	<span class="w">flush_dcache_mft_record_page</span><span class="c">(</span><span class="pc">c</span><span class="c">tx</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ntfs_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">mark_mft_record_dirty</span><span class="c">(ctx-&gt;</span><span class="pc">n</span><span class="c">tfs_ino);</span>
	<span class="w">ntfs_attr_put_search_ctx</span><span class="c">(ctx</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">unmap_mft_record</span><span class="c">(</span><span class="w">ni</span><span class="c">);</span>
<span class="w">do</span><span class="pc">n</span><span class="c">e:</span>
	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Done.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="w">put_unm_err_out</span><span class="c">:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ctx</span><span class="pc">)</span>
		<span class="w">n</span><span class="pc">tfs_a</span><span class="c">ttr_put_search_ctx(ctx);</span>
	<span class="w">u</span><span class="c">nmap_mft_record(</span><span class="w">ni</span><span class="c">);</span>
<span class="w">er</span><span class="pc">r_</span><span class="c">out:</span>
	<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="w">w</span><span class="c">ith</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="w">cod</span><span class="pc">e</span> <span class="c">%</span><span class="w">i.", -e</span><span class="c">rr</span><span class="w">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ntfs_set_volume_flags</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l,</span> <span class="w">VOLUME_FLAGS</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags)</span>
<span class="c">{</span>
	<span class="w">fl</span><span class="pc">ag</span><span class="c">s</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">VOLUME_FLAGS_MASK</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">ntfs_write_volume_flags</span><span class="pc">(</span><span class="w">vo</span><span class="c">l,</span> <span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">vol_flags</span> <span class="w">|</span> <span class="w">f</span><span class="c">lags);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">inline</span> <span class="c">int</span> <span class="w">ntfs_clear_volume_flags</span><span class="c">(</span><span class="w">n</span><span class="c">tfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="pc">l,</span> <span class="pc">V</span><span class="c">OLUME_FLAGS</span> <span class="w">f</span><span class="c">lags)</span>
<span class="c">{</span>
	<span class="w">fl</span><span class="pc">ags</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="c">VOLUME_FLAGS_MASK;</span>
	<span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="pc">=</span> <span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">v</span><span class="c">ol_flags</span> <span class="w">&amp;</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">(~le</span><span class="pc">1</span><span class="c">6_to_cpu(</span><span class="w">f</span><span class="c">lags</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">ntfs_write_volume_flags</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">,</span> <span class="w">f</span><span class="c">lags);</span>
<span class="c">}</span>

<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span> 


<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">ntfs_remount</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="pc">s</span><span class="c">b,</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">*</span><span class="w">f</span><span class="c">lags</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">o</span><span class="pc">pt</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">ntfs_volume</span> <span class="pc">*</span><span class="w">vo</span><span class="pc">l</span> <span class="c">=</span> <span class="w">NTFS_SB</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering</span> <span class="w">w</span><span class="c">ith</span> <span class="w">remount</span> <span class="w">op</span><span class="pc">t</span><span class="c">ions</span> <span class="w">st</span><span class="pc">ri</span><span class="c">ng</span><span class="w">:</span><span class="c"> %</span><span class="pc">s"</span><span class="c">,</span> <span class="w">o</span><span class="pc">p</span><span class="c">t);</span>

	<span class="w">sync_filesystem</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>

<span class="w">#</span><span class="pc">ifn</span><span class="c">def</span> <span class="w">NTFS_RW</span>
	
	<span class="w">*fl</span><span class="pc">a</span><span class="c">gs</span> <span class="pc">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
<span class="pc">#el</span><span class="c">se</span> 
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="pc">&amp;</span> <span class="w">M</span><span class="c">S_RDONLY</span><span class="w">) &amp;&amp; !(*f</span><span class="c">lags</span> <span class="pc">&amp;</span> <span class="w">M</span><span class="c">S_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">st</span><span class="pc">ati</span><span class="c">c</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es</span> <span class="w">= ".</span>  <span class="w">Ca</span><span class="pc">n</span><span class="c">not</span> <span class="w">remount</span> <span class="w">rea</span><span class="pc">d-</span><span class="w">w</span><span class="c">rite</span><span class="w">.";</span>

		
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">NVolErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">V</span><span class="c">olume</span> <span class="w">h</span><span class="c">as</span> <span class="w">errors</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">i</span><span class="pc">s</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="pc">%s",</span>
					<span class="w">es)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">EROFS</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">vol_flags</span> <span class="w">&amp;</span> <span class="w">VOLUME_IS_DIRTY</span><span class="c">) {</span>
			<span class="w">n</span><span class="c">tfs_error(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">V</span><span class="pc">o</span><span class="c">lume</span> <span class="w">i</span><span class="c">s</span> <span class="w">di</span><span class="pc">rt</span><span class="c">y</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">rea</span><span class="pc">d-</span><span class="w">on</span><span class="pc">l</span><span class="c">y</span><span class="w">%</span><span class="pc">s"</span><span class="c">,</span> <span class="w">es</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">ER</span><span class="c">OFS;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;vol_flags</span> <span class="w">&amp;</span> <span class="w">VOLUME_MODIFIED_BY_CHKDSK</span><span class="c">) {</span>
			<span class="pc">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">V</span><span class="pc">o</span><span class="c">lume</span> <span class="w">h</span><span class="pc">a</span><span class="c">s</span> <span class="w">been</span> <span class="w">modified</span> <span class="w">b</span><span class="pc">y</span> <span class="w">chkdsk</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">a</span><span class="c">nd</span> <span class="w">i</span><span class="pc">s</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span><span class="w">-o</span><span class="pc">nl</span><span class="c">y</span><span class="pc">%s</span><span class="w">"</span><span class="pc">,</span> <span class="w">es)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">ER</span><span class="c">OFS;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;vol_flags</span> <span class="w">&amp;</span> <span class="w">VOLUME_MUST_MOUNT_RO_MASK</span><span class="c">) {</span>
			<span class="pc">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">V</span><span class="pc">o</span><span class="c">lume</span> <span class="w">h</span><span class="pc">a</span><span class="c">s</span> <span class="w">unsupported</span> <span class="w">fl</span><span class="pc">ags</span> <span class="w">se</span><span class="pc">t</span> <span class="w">"</span>
					<span class="w">"</span><span class="pc">(</span><span class="w">0</span><span class="pc">x</span><span class="c">%x</span><span class="w">)</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">i</span><span class="c">s</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="pc">%s</span><span class="w">"</span><span class="c">,</span>
					<span class="w">(</span><span class="c">unsigned</span><span class="w">)le1</span><span class="c">6_to_cpu(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;vol_flags</span><span class="w">)</span><span class="c">,</span>
					<span class="w">es)</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">EROFS</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">ntfs_set_volume_flags</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">,</span> <span class="w">VOLUME_IS_DIRTY)</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">s</span><span class="c">et</span> <span class="w">dir</span><span class="pc">t</span><span class="c">y</span> <span class="w">bi</span><span class="c">t</span> <span class="pc">i</span><span class="c">n</span> <span class="w">volume</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">information</span> <span class="w">fl</span><span class="pc">ags%s"</span><span class="c">,</span> <span class="w">es</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">ER</span><span class="c">OFS;</span>
		<span class="c">}</span>
<span class="w">#</span><span class="c">if</span> <span class="w">0</span>
		<span class="w">/</span><span class="c">/</span> <span class="w">TODO</span><span class="pc">:</span> <span class="w">Enable</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">co</span><span class="pc">d</span><span class="c">e</span> <span class="w">once</span> <span class="w">we</span> <span class="w">sta</span><span class="pc">r</span><span class="c">t</span> <span class="w">modifying</span> <span class="w">anything</span> <span class="w">that</span>
		<span class="w">/</span><span class="pc">/</span>	 <span class="w">is</span> <span class="w">different</span> <span class="w">between</span> <span class="w">NTFS</span> <span class="w">1.2</span> <span class="w">a</span><span class="pc">nd</span> <span class="w">3</span><span class="pc">.</span><span class="w">x...</span>
		
		<span class="w">i</span><span class="pc">f</span> <span class="pc">((</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">major_ver</span> <span class="w">&gt;</span> <span class="c">1</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">i</span><span class="c">f</span> <span class="pc">(</span><span class="w">ntfs_set_volume_flags</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">,</span> <span class="w">VOLUME_MOUNTED_ON_NT4)</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">s</span><span class="c">et</span> <span class="w">NT4</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">compatibility</span> <span class="w">fl</span><span class="pc">ag</span><span class="w">%</span><span class="pc">s</span><span class="w">"</span><span class="pc">,</span> <span class="w">es</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">);</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">EROFS</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">ntfs_empty_logfile</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">logfile_ino</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">n</span><span class="c">tfs_error(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">e</span><span class="pc">m</span><span class="c">pty</span> <span class="w">j</span><span class="pc">o</span><span class="c">urnal</span> <span class="w">$LogFile</span><span class="pc">%s"</span><span class="c">,</span>
					<span class="w">es</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">N</span><span class="c">VolSetErrors</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">ER</span><span class="c">OFS;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">ntfs_mark_quotas_out_of_date</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">) {</span>
			<span class="pc">n</span><span class="c">tfs_error(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">mark</span> <span class="w">quotas</span> <span class="w">o</span><span class="pc">u</span><span class="c">t</span> <span class="w">o</span><span class="c">f</span> <span class="w">date%</span><span class="pc">s"</span><span class="c">,</span>
					<span class="w">es</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">N</span><span class="c">VolSetErrors(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">ER</span><span class="c">OFS;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">ntfs_stamp_usnjrnl</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">) {</span>
			<span class="w">n</span><span class="pc">tfs_e</span><span class="c">rror(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">stamp</span> <span class="w">transation</span> <span class="w">lo</span><span class="pc">g</span> <span class="w">"</span>
					<span class="w">"($UsnJrnl)%s</span><span class="pc">",</span> <span class="w">es</span><span class="c">);</span>
			<span class="w">N</span><span class="c">VolSetErrors(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">ER</span><span class="c">OFS;</span>
		<span class="c">}</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY) &amp;&amp; (*f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">M</span><span class="c">S_RDONLY)) {</span>
		
		<span class="c">if</span> <span class="pc">(!</span><span class="w">NVolErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">) {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ntfs_clear_volume_flags</span><span class="c">(</span><span class="w">vo</span><span class="c">l,</span> <span class="w">VOLUME_IS_DIRTY</span><span class="c">))</span>
				<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">cl</span><span class="pc">e</span><span class="c">ar</span> <span class="w">di</span><span class="pc">r</span><span class="c">ty</span> <span class="w">bi</span><span class="c">t</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">i</span><span class="pc">n</span> <span class="w">volume</span> <span class="w">information</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">fl</span><span class="pc">ags</span><span class="w">.</span>  <span class="w">Run</span> <span class="w">chkdsk.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span> 

	<span class="pc">/</span><span class="c">/</span> <span class="w">TODO</span><span class="pc">:</span> <span class="w">Deal</span> <span class="w">w</span><span class="pc">i</span><span class="c">th</span> <span class="w">*fl</span><span class="c">ags</span><span class="w">.</span>

	<span class="w">if</span> <span class="pc">(!</span><span class="w">parse_options</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">,</span> <span class="w">op</span><span class="pc">t))</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Done.</span><span class="pc">"</span><span class="c">);</span>
	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">is_boot_sector_ntfs</span><span class="c">(const</span> <span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="c">b,</span>
		<span class="pc">c</span><span class="c">onst</span> <span class="w">NTFS_BOOT_SECTOR</span> <span class="c">*</span><span class="w">b</span><span class="pc">,</span> <span class="c">const</span> <span class="w">b</span><span class="c">ool</span> <span class="w">silent</span><span class="c">)</span>
<span class="c">{</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">v</span><span class="pc">o</span><span class="c">id*)</span><span class="w">b</span> <span class="w">&lt;</span><span class="pc"> </span><span class="c">(</span><span class="w">v</span><span class="c">oid</span><span class="w">*</span><span class="pc">)&amp;</span><span class="w">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">checksum</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="pc">b</span><span class="c">-&gt;checksum</span> <span class="w">&amp;&amp;</span><span class="pc"> !</span><span class="c">silent</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">le32</span> <span class="w">*u</span><span class="pc">;</span>
		<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="pc">i</span><span class="c">;</span>

		<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">u</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">l</span><span class="pc">e3</span><span class="c">2</span><span class="w">*</span><span class="pc">)</span><span class="w">b</span><span class="c">;</span> <span class="w">u</span> <span class="w">&lt;</span><span class="pc"> </span><span class="c">(</span><span class="pc">l</span><span class="c">e32</span><span class="w">*)(&amp;</span><span class="pc">b</span><span class="w">-</span><span class="pc">&gt;</span><span class="c">checksum</span><span class="w">); ++u)</span>
			<span class="w">i</span> <span class="w">+</span><span class="pc">=</span> <span class="w">le32_to_cpup</span><span class="pc">(</span><span class="w">u)</span><span class="pc">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">le3</span><span class="pc">2_to_cpu</span><span class="c">(</span><span class="pc">b</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">hecksum</span><span class="w">) </span><span class="pc">!</span><span class="c">=</span> <span class="pc">i)</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">I</span><span class="c">nvalid</span> <span class="w">boot</span> <span class="w">sector</span> <span class="w">c</span><span class="pc">h</span><span class="c">ecksum</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">b</span><span class="c">-&gt;</span><span class="w">oem_id</span> <span class="w">!</span><span class="c">=</span> <span class="w">magicNTFS</span><span class="c">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">not_ntfs</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">b</span><span class="c">-&gt;</span><span class="w">bpb</span><span class="c">.</span><span class="w">bytes_per_sector) </span><span class="pc">&lt;</span> <span class="w">0x1</span><span class="pc">00</span> <span class="pc">|</span><span class="c">|</span>
			<span class="w">l</span><span class="pc">e1</span><span class="c">6_to_cpu(</span><span class="w">b</span><span class="c">-&gt;bpb.bytes_per_sector</span><span class="w">) &gt;</span> <span class="w">0x10</span><span class="pc">00</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">n</span><span class="pc">o</span><span class="c">t_ntfs;</span>
	
	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="w">b</span><span class="c">-&gt;</span><span class="pc">bp</span><span class="c">b</span><span class="pc">.</span><span class="w">sectors_per_cluster</span><span class="c">) {</span>
	<span class="c">case</span> <span class="c">1:</span> <span class="c">case</span> <span class="c">2:</span> <span class="c">case</span> <span class="w">4</span><span class="c">:</span> <span class="c">case</span> <span class="w">8</span><span class="c">:</span> <span class="c">case</span> <span class="w">1</span><span class="pc">6</span><span class="c">:</span> <span class="c">case</span> <span class="w">3</span><span class="pc">2</span><span class="c">:</span> <span class="c">case</span> <span class="w">6</span><span class="pc">4</span><span class="c">:</span> <span class="c">case</span> <span class="w">12</span><span class="pc">8</span><span class="c">:</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">default:</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">n</span><span class="c">ot_ntfs;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">u</span><span class="pc">3</span><span class="c">2)</span><span class="w">le</span><span class="pc">1</span><span class="c">6_to_cpu(</span><span class="w">b</span><span class="c">-&gt;</span><span class="w">bpb</span><span class="pc">.</span><span class="w">bytes_per_sector) *</span>
			<span class="w">b</span><span class="c">-&gt;bpb</span><span class="pc">.</span><span class="w">sectors_per_cluster</span> <span class="w">&gt;</span> <span class="w">NTFS_MAX_CLUSTER_SIZE</span><span class="pc">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="pc">n</span><span class="c">ot_ntfs;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">le</span><span class="pc">1</span><span class="c">6_to_cpu(</span><span class="w">b</span><span class="c">-&gt;bpb.</span><span class="w">reserved_sectors) </span><span class="pc">|</span><span class="c">|</span>
			<span class="w">l</span><span class="c">e16_to_cpu(</span><span class="w">b</span><span class="c">-&gt;bpb.</span><span class="w">root_entries) </span><span class="pc">|</span><span class="c">|</span>
			<span class="w">l</span><span class="c">e16_to_cpu(</span><span class="w">b</span><span class="c">-&gt;</span><span class="pc">b</span><span class="c">pb.</span><span class="w">sectors) </span><span class="pc">|</span><span class="c">|</span>
			<span class="w">l</span><span class="pc">e1</span><span class="c">6_to_cpu(</span><span class="w">b</span><span class="c">-&gt;bpb.</span><span class="w">sectors_per_fat) </span><span class="pc">|</span><span class="c">|</span>
			<span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(</span><span class="w">b</span><span class="c">-&gt;bpb.</span><span class="w">large_sectors</span><span class="pc">) </span><span class="c">||</span> <span class="w">b</span><span class="c">-&gt;</span><span class="pc">b</span><span class="c">pb.</span><span class="w">fats</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">not_ntfs</span><span class="c">;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">u</span><span class="pc">8)</span><span class="w">b</span><span class="c">-&gt;</span><span class="w">clusters_per_mft_record</span> <span class="w">&lt;</span> <span class="w">0xe1</span> <span class="w">|</span><span class="c">|</span>
			<span class="c">(</span><span class="w">u</span><span class="c">8)</span><span class="pc">b</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">lusters_per_mft_record</span> <span class="w">&gt;</span> <span class="w">0xf7</span><span class="pc">)</span>
		<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">b</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">lusters_per_mft_record</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">case</span> <span class="pc">1</span><span class="c">:</span> <span class="c">case</span> <span class="c">2:</span> <span class="c">case</span> <span class="pc">4</span><span class="c">:</span> <span class="c">case</span> <span class="w">8</span><span class="c">:</span> <span class="c">case</span> <span class="w">1</span><span class="pc">6</span><span class="c">:</span> <span class="c">case</span> <span class="w">3</span><span class="pc">2</span><span class="c">:</span> <span class="c">case</span> <span class="w">6</span><span class="pc">4</span><span class="c">:</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="c">default:</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">not_ntfs</span><span class="c">;</span>
		<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">u</span><span class="c">8)</span><span class="w">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">clusters_per_index_record</span> <span class="w">&lt;</span> <span class="w">0xe1</span> <span class="w">|</span><span class="c">|</span>
			<span class="pc">(</span><span class="c">u8)</span><span class="w">b</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">lusters_per_index_record</span> <span class="w">&gt;</span> <span class="w">0xf7</span><span class="pc">)</span>
		<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">b</span><span class="c">-&gt;clusters_per_index_record) {</span>
		<span class="c">case</span> <span class="pc">1</span><span class="c">:</span> <span class="c">case</span> <span class="c">2:</span> <span class="c">case</span> <span class="pc">4</span><span class="c">:</span> <span class="c">case</span> <span class="w">8</span><span class="c">:</span> <span class="c">case</span> <span class="w">1</span><span class="pc">6</span><span class="c">:</span> <span class="c">case</span> <span class="w">3</span><span class="pc">2</span><span class="c">:</span> <span class="c">case</span> <span class="w">6</span><span class="pc">4</span><span class="c">:</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="c">default:</span>
			<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">not_ntfs</span><span class="c">;</span>
		<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">silent</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">b</span><span class="c">-&gt;</span><span class="w">end_of_sector_marker</span> <span class="w">!</span><span class="c">=</span> <span class="w">cp</span><span class="c">u_to_le16(</span><span class="w">0xaa55</span><span class="c">))</span>
		<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">I</span><span class="c">nvalid</span> <span class="w">en</span><span class="pc">d</span> <span class="w">o</span><span class="c">f</span> <span class="w">sector</span> <span class="w">marker.</span><span class="pc">"</span><span class="c">);</span>
	<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
<span class="w">n</span><span class="pc">o</span><span class="c">t_ntfs:</span>
	<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">read_ntfs_boot_sector</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="pc">s</span><span class="c">b,</span>
		<span class="pc">c</span><span class="c">onst</span> <span class="w">i</span><span class="c">nt</span> <span class="w">silent</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">read_err_str</span> <span class="w">=</span><span class="pc"> "</span><span class="w">U</span><span class="c">nable</span> <span class="pc">t</span><span class="c">o</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span> <span class="w">%</span><span class="c">s</span> <span class="w">boot</span> <span class="w">s</span><span class="pc">e</span><span class="c">ctor</span><span class="w">.";</span>
	<span class="w">st</span><span class="pc">r</span><span class="c">uct</span> <span class="w">b</span><span class="pc">uffer_</span><span class="c">head</span> <span class="c">*</span><span class="w">bh_primary,</span><span class="pc"> </span><span class="c">*</span><span class="w">bh_backup</span><span class="c">;</span>
	<span class="w">se</span><span class="pc">c</span><span class="c">tor_t</span> <span class="w">nr_blocks</span> <span class="c">=</span> <span class="w">NTFS_SB</span><span class="c">(</span><span class="w">sb</span><span class="pc">)-</span><span class="c">&gt;nr_blocks;</span>

	
	<span class="c">if</span> <span class="pc">((b</span><span class="c">h_primary</span> <span class="w">=</span> <span class="w">sb_bread</span><span class="c">(</span><span class="w">sb</span><span class="pc">,</span> <span class="w">0</span><span class="pc">))) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">is_boot_sector_ntfs</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> (</span><span class="w">NTFS_BOOT_SECTOR*</span><span class="pc">)</span>
				<span class="pc">b</span><span class="c">h_primary</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="pc">,</span> <span class="w">silent</span><span class="c">))</span>
			<span class="c">return</span> <span class="w">b</span><span class="c">h_primary;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">i</span><span class="c">lent)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">Primary</span> <span class="w">boot</span> <span class="w">sector</span> <span class="w">i</span><span class="pc">s</span> <span class="w">i</span><span class="pc">nv</span><span class="c">alid</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">i</span><span class="c">lent</span><span class="pc">)</span>
		<span class="w">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb</span><span class="pc">,</span> <span class="w">read_err_str,</span><span class="pc"> "</span><span class="w">primary</span><span class="pc">")</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">NTFS_SB</span><span class="pc">(</span><span class="w">sb)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span> <span class="w">ON_ERRORS_RECOVER</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">bh_primary</span><span class="pc">)</span>
			<span class="w">brelse</span><span class="c">(</span><span class="pc">b</span><span class="c">h_primary</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!s</span><span class="c">ilent)</span>
			<span class="pc">n</span><span class="c">tfs_error(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">Mount</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">errors=recover</span> <span class="w">n</span><span class="c">ot</span> <span class="w">u</span><span class="pc">sed</span><span class="w">. "</span>
					<span class="w">"Aborting</span> <span class="w">without</span> <span class="w">trying</span> <span class="w">t</span><span class="c">o</span> <span class="w">rec</span><span class="c">over</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bh_backup</span> <span class="pc">=</span> <span class="w">sb_bread</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">nr_blocks</span> <span class="w">-</span> <span class="pc">1</span><span class="w">))</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">is_boot_sector_ntfs</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> (</span><span class="w">NTFS_BOOT_SECTOR*</span><span class="c">)</span>
				<span class="c">bh_backup</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">b_data</span><span class="c">,</span> <span class="w">silent</span><span class="pc">))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">hotfix_primary_boot_sector</span><span class="c">;</span>
		<span class="w">brelse</span><span class="c">(bh_backup</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">i</span><span class="c">lent)</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">read_err_str,</span><span class="pc"> "</span><span class="w">backup</span><span class="pc">")</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="pc">((b</span><span class="c">h_backup</span> <span class="pc">=</span> <span class="w">sb_bread</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">nr_blocks</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="pc">1</span><span class="w">))</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">is_boot_sector_ntfs</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> (</span><span class="w">NTFS_BOOT_SECTOR*</span><span class="c">)</span>
				<span class="w">b</span><span class="c">h_backup</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="pc">,</span> <span class="w">s</span><span class="pc">il</span><span class="c">ent</span><span class="pc">))</span>
			<span class="c">goto</span> <span class="w">hotfix_primary_boot_sector</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">i</span><span class="c">lent</span><span class="pc">)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">C</span><span class="c">ould</span> <span class="c">not</span> <span class="pc">f</span><span class="c">ind</span> <span class="w">a</span> <span class="w">v</span><span class="pc">a</span><span class="c">lid</span> <span class="w">backup</span> <span class="w">boot</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">sector.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">brelse</span><span class="c">(bh_backup);</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!si</span><span class="c">lent</span><span class="pc">)</span>
		<span class="w">n</span><span class="c">tfs_error(</span><span class="w">sb</span><span class="pc">,</span> <span class="w">read_err_str,</span><span class="pc"> "</span><span class="w">b</span><span class="pc">a</span><span class="c">ckup</span><span class="pc">")</span><span class="c">;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bh_primary</span><span class="pc">)</span>
		<span class="w">b</span><span class="pc">rel</span><span class="c">se(</span><span class="pc">bh_p</span><span class="c">rimary);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">N</span><span class="c">ULL;</span>
<span class="w">hotfix_primary_boot_sector</span><span class="c">:</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">bh</span><span class="c">_primary</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="c">if</span> <span class="pc">(!(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Hot</span><span class="c">-</span><span class="w">fix:</span> <span class="w">Recovering</span> <span class="w">in</span><span class="pc">v</span><span class="c">alid</span> <span class="w">primary</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">boot</span> <span class="w">sector</span> <span class="w">f</span><span class="c">rom</span> <span class="w">backup</span> <span class="w">cop</span><span class="c">y</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">b</span><span class="pc">h</span><span class="c">_primary</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">,</span> <span class="w">bh_backup</span><span class="pc">-</span><span class="c">&gt;b_data,</span>
					<span class="w">NTFS_BLOCK_SIZE</span><span class="c">);</span>
			<span class="w">mark_buffer_dirty</span><span class="c">(</span><span class="w">b</span><span class="pc">h_p</span><span class="c">rimary</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">sync_dirty_buffer</span><span class="c">(</span><span class="pc">bh_p</span><span class="c">rimary);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">buffer_uptodate</span><span class="c">(bh_primary</span><span class="pc">)</span><span class="c">) {</span>
				<span class="w">brelse</span><span class="c">(</span><span class="pc">bh_b</span><span class="c">ackup</span><span class="pc">)</span><span class="c">;</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="pc">b</span><span class="c">h_primary;</span>
			<span class="c">}</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">Hot</span><span class="pc">-</span><span class="w">fix:</span> <span class="w">Device</span> <span class="w">w</span><span class="pc">r</span><span class="c">ite</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="w">wh</span><span class="pc">il</span><span class="c">e</span> <span class="w">"</span>
					<span class="pc">"</span><span class="w">recovering</span> <span class="w">primary</span> <span class="w">boot</span> <span class="w">sector.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"Hot-</span><span class="w">fix:</span> <span class="w">Recovery</span> <span class="w">o</span><span class="c">f</span> <span class="w">p</span><span class="c">rimary</span> <span class="w">b</span><span class="pc">oo</span><span class="c">t</span> <span class="pc">"</span>
					<span class="c">"</span><span class="pc">s</span><span class="c">ector</span> <span class="w">f</span><span class="pc">a</span><span class="c">iled</span><span class="w">:</span> <span class="w">Read-on</span><span class="pc">l</span><span class="c">y</span> <span class="w">mount.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">}</span>
		<span class="w">brelse</span><span class="c">(</span><span class="w">bh_primary</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">n</span><span class="c">tfs_warning(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Using</span> <span class="w">backup</span> <span class="w">b</span><span class="pc">o</span><span class="c">ot</span> <span class="w">s</span><span class="c">ector</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">bh_backup</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">parse_ntfs_boot_sector</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="w">NTFS_BOOT_SECTOR</span> <span class="c">*</span><span class="w">b</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">sectors_per_cluster_bits</span><span class="pc">,</span> <span class="w">nr_hidden_sects</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">clusters_per_mft_record</span><span class="c">,</span> <span class="w">clusters_per_index_record</span><span class="c">;</span>
	<span class="w">s6</span><span class="c">4</span> <span class="w">ll</span><span class="pc">;</span>

	<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sector_size</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e1</span><span class="c">6_to_cpu(</span><span class="w">b</span><span class="c">-&gt;</span><span class="w">bpb</span><span class="pc">.</span><span class="w">bytes_per_sector</span><span class="c">);</span>
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">sector_size_bits</span> <span class="c">=</span> <span class="w">ffs</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">sector_size</span><span class="w">) </span><span class="pc">-</span> <span class="c">1;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="w">-</span><span class="pc">&gt;sector_size</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0x</span><span class="c">%</span><span class="pc">x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;sector_size,</span>
			<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">sector_size</span><span class="c">);</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="pc">("</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">ector_size_</span><span class="c">bits</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0</span><span class="pc">x</span><span class="c">%x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">sector_size_</span><span class="c">bits,</span>
			<span class="w">v</span><span class="c">ol-&gt;sector_size_bits);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">sector_size</span> <span class="pc">&lt;</span> <span class="pc">v</span><span class="c">ol-&gt;</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_blocksize</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Sector</span> <span class="w">si</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i</span><span class="pc">)</span> <span class="w">is</span> <span class="w">smaller</span> <span class="w">than</span> <span class="w">t</span><span class="pc">he</span> <span class="pc">"</span>
				<span class="c">"</span><span class="w">d</span><span class="c">evice</span> <span class="w">b</span><span class="pc">l</span><span class="c">ock</span> <span class="w">s</span><span class="c">ize</span> <span class="w">(</span><span class="c">%</span><span class="pc">l</span><span class="c">u</span><span class="w">).</span>  <span class="w">This</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">"</span>
				<span class="c">"</span><span class="w">s</span><span class="pc">u</span><span class="c">pported</span><span class="w">.</span>  <span class="w">Sorry.",</span> <span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sector_size,</span>
				<span class="w">vo</span><span class="c">l-&gt;</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_blocksize</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">sectors_per_cluster</span> <span class="w">=</span> <span class="pc">0x</span><span class="c">%x",</span> <span class="w">b</span><span class="c">-&gt;</span><span class="w">bpb</span><span class="pc">.s</span><span class="c">ectors_per_cluster);</span>
	<span class="w">sectors_per_cluster_bits</span> <span class="pc">=</span> <span class="w">ffs</span><span class="c">(</span><span class="w">b</span><span class="pc">-</span><span class="c">&gt;bpb.</span><span class="pc">sectors_per_cluster</span><span class="w">) </span><span class="pc">-</span> <span class="c">1;</span>
	<span class="pc">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"sectors_per_cluster_</span><span class="c">bits</span> <span class="w">=</span> <span class="pc">0x</span><span class="c">%x</span><span class="pc">"</span><span class="c">,</span>
			<span class="c">sectors_per_cluster_bits);</span>
	<span class="w">nr_hidden_sects</span> <span class="pc">=</span> <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(</span><span class="w">b</span><span class="c">-&gt;</span><span class="pc">b</span><span class="c">pb.</span><span class="w">hidden_sectors</span><span class="c">);</span>
	<span class="pc">nt</span><span class="c">fs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">nu</span><span class="pc">mb</span><span class="c">er</span> <span class="w">o</span><span class="c">f</span> <span class="w">hidden</span> <span class="w">sectors</span> <span class="w">=</span> <span class="c">0x%x</span><span class="pc">"</span><span class="c">,</span> <span class="pc">n</span><span class="c">r_hidden_sects);</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">cluster_size</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sector_size</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="pc">s</span><span class="c">ectors_per_cluster_bits</span><span class="pc">;</span>
	<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">cluster_size_mask</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;cluster_size</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">cluster_size_bits</span> <span class="c">=</span> <span class="w">ffs</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">cluster_size</span><span class="w">) -</span> <span class="c">1;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="w">-</span><span class="pc">&gt;cluster_size</span> <span class="pc">= </span><span class="c">%</span><span class="w">i</span> <span class="w">(0x</span><span class="c">%</span><span class="w">x)</span><span class="pc">"</span><span class="c">,</span> <span class="w">v</span><span class="c">ol-&gt;cluster_size,</span>
			<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">cluster_size)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cluster_size_mask</span> <span class="pc">=</span> <span class="pc">0x</span><span class="c">%x</span><span class="pc">"</span><span class="c">,</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">cluster_size_</span><span class="c">mask);</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="pc">("</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">cluster_size_bits</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span><span class="pc">"</span><span class="c">,</span> <span class="w">v</span><span class="c">ol-&gt;cluster_size_bits);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">cluster_size</span> <span class="w">&lt;</span> <span class="pc">v</span><span class="c">ol-&gt;</span><span class="w">sector_size</span><span class="c">) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Cluster</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i</span><span class="c">)</span> <span class="w">is</span> <span class="w">smaller</span> <span class="w">than</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="pc">"</span>
				<span class="c">"</span><span class="w">sector</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i).</span>  <span class="w">This</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">s</span><span class="c">upported</span><span class="w">.  "</span>
				<span class="pc">"</span><span class="w">Sorry.",</span> <span class="w">vo</span><span class="c">l</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">luster_size</span><span class="w">,</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">s</span><span class="c">ector_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">clusters_per_mft_record</span> <span class="pc">=</span> <span class="w">b</span><span class="c">-&gt;</span><span class="w">c</span><span class="pc">lusters</span><span class="c">_per_mft_record;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="c">clusters_per_mft_record</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0</span><span class="c">x%</span><span class="pc">x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span>
			<span class="c">clusters_per_mft_record</span><span class="pc">,</span> <span class="pc">clusters</span><span class="c">_per_mft_record</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(clusters_per_mft_record</span> <span class="w">&gt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mft_record_size</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">cluster_size</span> <span class="w">&lt;</span><span class="c">&lt;</span>
				<span class="w">(ffs</span><span class="c">(clusters_per_mft_record</span><span class="w">) -</span> <span class="c">1</span><span class="w">);</span>
	<span class="pc">e</span><span class="c">lse</span>
		
		<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mft_record_size</span> <span class="c">=</span> <span class="pc">1</span> <span class="w">&lt;&lt; -</span><span class="pc">c</span><span class="c">lusters_per_mft_record</span><span class="pc">;</span>
	<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mft_record_size_mask</span> <span class="c">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_record_size</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="pc">v</span><span class="c">ol-&gt;</span><span class="w">mft_record_size_bits</span> <span class="c">=</span> <span class="w">f</span><span class="c">fs</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_record_size</span><span class="w">) </span><span class="pc">-</span> <span class="c">1;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="w">-</span><span class="pc">&gt;mft_record_size</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0</span><span class="pc">x</span><span class="c">%</span><span class="pc">x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span> <span class="w">v</span><span class="c">ol-&gt;mft_record_size,</span>
			<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_record_size)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mft_record_size_mask</span> <span class="pc">=</span> <span class="pc">0x</span><span class="c">%x</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_record_size_</span><span class="c">mask);</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="pc">("</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">mft_record_size_bits</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0</span><span class="c">x%</span><span class="pc">x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">v</span><span class="c">ol-&gt;mft_record_size_bits,</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_record_size_b</span><span class="c">its</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_record_size</span> <span class="pc">&gt;</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> </span><span class="c">"</span><span class="w">Mft</span> <span class="w">record</span> <span class="w">si</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i</span><span class="pc">)</span> <span class="w">exceeds</span> <span class="w">t</span><span class="pc">he</span> <span class="pc">"</span>
				<span class="c">"</span><span class="w">P</span><span class="pc">A</span><span class="c">GE_CACHE_SIZE</span> <span class="w">o</span><span class="pc">n</span> <span class="w">your</span> <span class="w">system</span> <span class="w">(</span><span class="pc">%l</span><span class="c">u</span><span class="w">).  "</span>
				<span class="pc">"</span><span class="w">This</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="pc">s</span><span class="c">upported</span><span class="pc">.</span>  <span class="w">Sorry.",</span>
				<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">ft_record_size</span><span class="pc">,</span> <span class="pc">P</span><span class="c">AGE_CACHE_SIZE</span><span class="w">)</span><span class="pc">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;mft_record_size</span> <span class="w">&lt;</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">sector_size</span><span class="c">) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Mft</span> <span class="w">record</span> <span class="w">si</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i</span><span class="pc">)</span> <span class="w">is</span> <span class="w">smaller</span> <span class="w">than</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="c">"</span>
				<span class="c">"</span><span class="w">sector</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i).</span>  <span class="w">This</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">s</span><span class="c">upported</span><span class="w">.  "</span>
				<span class="pc">"</span><span class="w">Sorry.",</span> <span class="w">vo</span><span class="pc">l</span><span class="w">-</span><span class="c">&gt;</span><span class="w">m</span><span class="c">ft_record_size</span><span class="w">,</span>
				<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">s</span><span class="pc">e</span><span class="c">ctor_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">clusters_per_index_record</span> <span class="pc">=</span> <span class="w">b</span><span class="c">-&gt;</span><span class="w">c</span><span class="c">lusters_per_index_record;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="c">clusters_per_index_record</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0</span><span class="c">x%</span><span class="pc">x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span>
			<span class="c">clusters_per_index_record</span><span class="pc">,</span> <span class="pc">c</span><span class="c">lusters_per_index_record</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(clusters_per_index_record</span> <span class="w">&gt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">index_record_size</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">cluster_size</span> <span class="w">&lt;</span><span class="c">&lt;</span>
				<span class="w">(ffs</span><span class="c">(clusters_per_index_record</span><span class="w">) -</span> <span class="c">1</span><span class="w">);</span>
	<span class="pc">e</span><span class="c">lse</span>
		
		<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;index_record_size</span> <span class="c">=</span> <span class="pc">1</span> <span class="w">&lt;&lt; -</span><span class="pc">c</span><span class="c">lusters_per_index_record</span><span class="pc">;</span>
	<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">index_record_size_mask</span> <span class="c">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">index_record_size</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="pc">v</span><span class="c">ol-&gt;</span><span class="w">index_record_size_bits</span> <span class="c">=</span> <span class="w">f</span><span class="c">fs</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">index_record_size</span><span class="w">) </span><span class="pc">-</span> <span class="c">1;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="w">-</span><span class="pc">&gt;index_record_size</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0</span><span class="pc">x</span><span class="c">%</span><span class="pc">x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">v</span><span class="c">ol-&gt;index_record_size,</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">index_record_size)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">index_record_size_mask</span> <span class="pc">=</span> <span class="pc">0x</span><span class="c">%x</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">index_record_size_</span><span class="c">mask);</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="pc">("</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">index_record_size_bits</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span> <span class="w">(0</span><span class="c">x%</span><span class="pc">x</span><span class="w">)</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">v</span><span class="c">ol-&gt;index_record_size_bits,</span>
			<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">index_record_size_b</span><span class="c">its</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">index_record_size</span> <span class="w">&lt;</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="w">sector_size</span><span class="c">) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Index</span> <span class="w">record</span> <span class="w">si</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i</span><span class="pc">)</span> <span class="w">is</span> <span class="w">smaller</span> <span class="w">than</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">t</span><span class="c">he</span> <span class="w">sector</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i).</span>  <span class="w">This</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="c">"</span>
				<span class="c">"</span><span class="w">su</span><span class="c">pported</span><span class="w">.</span>  <span class="w">Sorry.",</span> <span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex_record_size</span><span class="pc">,</span>
				<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">s</span><span class="c">ector_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	<span class="w">ll</span> <span class="pc">=</span> <span class="w">sle64_to_cpu</span><span class="c">(</span><span class="w">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">number_of_sectors)</span><span class="pc"> &gt;</span><span class="c">&gt;</span> <span class="w">sectors_per_cluster_bits</span><span class="pc">;</span>
	<span class="c">if</span> <span class="pc">((</span><span class="w">u6</span><span class="c">4)ll</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">1U</span><span class="c">LL</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">3</span><span class="pc">2) </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">C</span><span class="pc">a</span><span class="c">nnot</span> <span class="w">ha</span><span class="pc">ndle</span> <span class="w">6</span><span class="pc">4</span><span class="w">-b</span><span class="c">it</span> <span class="w">clusters.</span>  <span class="w">Sorry.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">nr_clusters</span> <span class="pc">=</span> <span class="c">ll;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">vo</span><span class="c">l</span><span class="w">-</span><span class="pc">&gt;nr</span><span class="c">_clusters</span> <span class="pc">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">"</span><span class="pc">, (</span><span class="w">l</span><span class="c">ong</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;nr_clusters</span><span class="w">)</span><span class="c">;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">si</span><span class="pc">zeo</span><span class="c">f(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span><span class="w">) &lt;</span> <span class="w">8) </span><span class="pc">{</span>
		<span class="c">if</span> <span class="pc">((l</span><span class="c">l</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">cluster_size_bits) &gt;= (1U</span><span class="pc">LL</span> <span class="c">&lt;&lt;</span> <span class="w">41</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">V</span><span class="c">olume</span> <span class="w">s</span><span class="c">ize</span> <span class="w">(</span><span class="c">%</span><span class="w">lluTiB</span><span class="pc">)</span> <span class="w">is</span> <span class="w">t</span><span class="c">oo</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">large</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="pc">thi</span><span class="c">s</span> <span class="w">architecture.  "</span>
					<span class="w">"Maximum</span> <span class="w">s</span><span class="pc">upporte</span><span class="c">d</span> <span class="w">i</span><span class="pc">s</span> <span class="w">2TiB.</span>  <span class="w">Sorry.",</span>
					<span class="w">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">ll</span> <span class="w">&gt;</span><span class="pc">&gt; </span><span class="c">(</span><span class="w">4</span><span class="pc">0</span> <span class="pc">-</span>
					<span class="w">vo</span><span class="c">l-&gt;</span><span class="w">cluster_size_bits)</span><span class="pc">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
		<span class="c">}</span>
	<span class="w">}</span>
	<span class="w">l</span><span class="pc">l</span> <span class="c">=</span> <span class="w">sle64_to_cpu</span><span class="c">(</span><span class="w">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mft_lcn</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">l</span><span class="c">l</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">nr_clusters</span><span class="c">) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">MFT</span> <span class="w">LCN</span> <span class="w">(</span><span class="pc">%</span><span class="w">lli</span><span class="pc">,</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">)</span> <span class="w">i</span><span class="pc">s</span> <span class="w">beyond</span> <span class="w">en</span><span class="pc">d</span> <span class="w">o</span><span class="c">f</span> <span class="pc">"</span>
				<span class="c">"</span><span class="w">volume.</span>  <span class="w">Weird.", (u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="pc">l</span><span class="c">l</span><span class="w">,</span>
				<span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">l</span><span class="pc">l</span><span class="w">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mft_lcn</span> <span class="c">=</span> <span class="w">l</span><span class="c">l;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">vo</span><span class="pc">l</span><span class="w">-</span><span class="pc">&gt;</span><span class="c">mft_lcn</span> <span class="pc">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">",</span><span class="pc"> (</span><span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mft_lcn</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">l</span><span class="c">l</span> <span class="c">=</span> <span class="w">sle64_to_cpu</span><span class="c">(</span><span class="w">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mftmirr_lcn</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ll</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="w">nr_clusters</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">MFTMirr</span> <span class="w">LCN</span> <span class="w">(</span><span class="pc">%</span><span class="w">lli</span><span class="pc">,</span> <span class="w">0</span><span class="c">x%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">)</span> <span class="w">is</span> <span class="w">beyond</span> <span class="w">en</span><span class="pc">d</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">o</span><span class="c">f</span> <span class="w">volume.</span>  <span class="w">Weird.", (u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">long)</span><span class="pc">l</span><span class="c">l</span><span class="w">,</span>
				<span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">l</span><span class="pc">l</span><span class="w">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mftmirr_lcn</span> <span class="c">=</span> <span class="w">l</span><span class="c">l;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">vo</span><span class="pc">l</span><span class="w">-</span><span class="pc">&gt;m</span><span class="c">ftmirr_lcn</span> <span class="pc">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">",</span><span class="pc"> (</span><span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mftmirr_lcn</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">cluster_size</span> <span class="w">&lt;= (4</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="w">mft_record_size_bits</span><span class="c">))</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">mftmirr_size</span> <span class="c">=</span> <span class="w">4</span><span class="c">;</span>
	<span class="c">else</span>
		<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;mftmirr_size</span> <span class="c">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">c</span><span class="c">luster_size</span> <span class="w">&gt;</span><span class="pc">&gt;</span>
				<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">m</span><span class="pc">ft_</span><span class="c">record_size_bits;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;mftmirr_size</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">i</span><span class="pc">"</span><span class="c">,</span> <span class="w">v</span><span class="c">ol-&gt;mftmirr_size);</span>
<span class="w">#</span><span class="c">endif</span> 
	<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">serial_no</span> <span class="c">=</span> <span class="w">le64_to_cpu</span><span class="pc">(</span><span class="w">b</span><span class="c">-&gt;</span><span class="w">volume_serial_number</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">v</span><span class="pc">ol-&gt;</span><span class="c">serial_no</span> <span class="pc">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">"</span><span class="c">,</span>
			<span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;serial_no</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">ntfs_setup_allocators</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="pc">l</span><span class="c">)</span>
<span class="c">{</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
	<span class="w">LCN</span> <span class="w">mft_zone_size</span><span class="pc">,</span> <span class="w">mft_lcn</span><span class="c">;</span>
<span class="pc">#en</span><span class="c">dif</span> 

	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">vo</span><span class="pc">l</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">mft_zone_multiplier</span> <span class="pc">=</span> <span class="w">0</span><span class="pc">x%</span><span class="c">x",</span>
			<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">ft_zone_multiplier);</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">N</span><span class="c">TFS_RW</span>
	
	<span class="w">m</span><span class="pc">ft_zone_s</span><span class="c">ize</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">nr_clusters</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mft_zone_multiplier) {</span>  
	<span class="c">case</span> <span class="w">4</span><span class="c">:</span>
		<span class="pc">m</span><span class="c">ft_zone_size</span> <span class="w">&gt;</span><span class="pc">&gt;</span><span class="c">=</span> <span class="c">1;</span>			
		<span class="c">break;</span>
	<span class="c">case</span> <span class="pc">3</span><span class="c">:</span>
		<span class="pc">m</span><span class="c">ft_zone_size</span> <span class="pc">= </span><span class="c">(</span><span class="pc">m</span><span class="c">ft_zone_size</span> <span class="w">+</span>
				<span class="w">(m</span><span class="pc">ft_zone_s</span><span class="c">ize</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="pc">1</span><span class="w">)) &gt;&gt;</span> <span class="w">2</span><span class="pc">;</span>	
		<span class="c">break;</span>
	<span class="c">case</span> <span class="pc">2</span><span class="c">:</span>
		<span class="c">mft_zone_size</span> <span class="w">&gt;</span><span class="pc">&gt;=</span> <span class="pc">2</span><span class="c">;</span>			
		<span class="c">break;</span>
	
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="c">mft_zone_size</span> <span class="w">&gt;</span><span class="pc">&gt;</span><span class="c">=</span> <span class="pc">3</span><span class="c">;</span>			
		<span class="c">break;</span>
	<span class="pc">}</span>
	
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">mft_zone_start</span> <span class="c">=</span> <span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mft_zone_pos</span> <span class="w">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mft_lcn</span><span class="c">;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="w">-</span><span class="pc">&gt;mft_zone_p</span><span class="c">os</span> <span class="c">=</span> <span class="pc">0x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">"</span><span class="c">,</span>
			<span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mft_zone_pos</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">m</span><span class="pc">ft_l</span><span class="c">cn</span> <span class="pc">= </span><span class="c">(</span><span class="w">8192</span> <span class="pc">+</span> <span class="w">2</span> <span class="c">*</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">cluster_size</span> <span class="w">-</span> <span class="c">1</span><span class="w">)</span><span class="pc"> </span><span class="c">/</span> <span class="w">v</span><span class="c">ol-&gt;cluster_size;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">ft_l</span><span class="c">cn</span> <span class="w">*</span> <span class="w">v</span><span class="c">ol-&gt;cluster_size</span> <span class="w">&lt;</span> <span class="w">1</span><span class="pc">6</span> <span class="w">*</span> <span class="pc">1</span><span class="c">024)</span>
		<span class="w">m</span><span class="c">ft_lcn</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">16</span> <span class="c">*</span> <span class="c">1024</span> <span class="pc">+</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;cluster_size</span> <span class="pc">-</span> <span class="pc">1</span><span class="w">)</span><span class="pc"> /</span>
				<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">c</span><span class="c">luster_size</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">mft_zone_start</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="pc">m</span><span class="c">ft_lcn</span><span class="pc">)</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">m</span><span class="c">ft_zone_start</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"v</span><span class="c">ol</span><span class="pc">-&gt;m</span><span class="c">ft_zone_start</span> <span class="c">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">"</span><span class="c">,</span>
			<span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">mft_z</span><span class="c">one_start</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">v</span><span class="pc">ol-</span><span class="c">&gt;</span><span class="w">mft_zone_end</span> <span class="c">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="w">m</span><span class="pc">ft_l</span><span class="c">cn</span> <span class="pc">+</span> <span class="w">mft_zone_size</span><span class="c">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_zone_e</span><span class="c">nd</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="w">nr_clusters</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">m</span><span class="pc">f</span><span class="c">t_zone_size</span> <span class="w">&gt;</span><span class="pc">&gt;</span><span class="c">=</span> <span class="c">1;</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">m</span><span class="c">ft_zone_end</span> <span class="c">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_l</span><span class="c">cn</span> <span class="pc">+</span> <span class="c">mft_zone_size</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">m</span><span class="c">ft_zone_end</span> <span class="pc">=</span> <span class="pc">0x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">"</span><span class="c">,</span>
			<span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">mft_zone_e</span><span class="c">nd</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">v</span><span class="pc">ol-</span><span class="c">&gt;</span><span class="w">data1_zone_pos</span> <span class="c">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mf</span><span class="c">t_zone_end;</span>
	<span class="w">n</span><span class="pc">t</span><span class="c">fs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="pc">-&gt;d</span><span class="c">ata1_zone_pos</span> <span class="c">=</span> <span class="pc">0x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">"</span><span class="c">,</span>
			<span class="c">(unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;data1_zone_pos</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">v</span><span class="pc">ol-</span><span class="c">&gt;</span><span class="w">data2_zone_pos</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="w">-</span><span class="pc">&gt;data2</span><span class="c">_zone_pos</span> <span class="pc">=</span> <span class="pc">0x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">"</span><span class="c">,</span>
			<span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">data2</span><span class="c">_zone_pos</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mft_data_pos</span> <span class="c">=</span> <span class="w">24</span><span class="c">;</span>
	<span class="w">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">v</span><span class="c">ol</span><span class="w">-</span><span class="pc">&gt;m</span><span class="c">ft_data_pos</span> <span class="c">=</span> <span class="pc">0x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">"</span><span class="c">,</span>
			<span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mft_data_pos</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span> 
<span class="pc">}</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="w">b</span><span class="c">ool</span> <span class="w">load_and_init_mft_mirror</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="w">tmp_ino</span><span class="c">;</span>
	<span class="w">ntfs_inode</span> <span class="pc">*</span><span class="w">tmp_ni</span><span class="pc">;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="c">tmp_ino</span> <span class="c">=</span> <span class="w">ntfs_iget</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">,</span> <span class="w">FILE_MFTMirr</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(tmp_ino</span><span class="w">)</span><span class="pc"> |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(tmp_ino)) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(tmp_ino))</span>
			<span class="w">iput</span><span class="c">(tmp_ino);</span>
		
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	
	<span class="w">t</span><span class="pc">mp_i</span><span class="c">no-&gt;</span><span class="w">i_uid</span> <span class="c">=</span> <span class="w">GLOBAL_ROOT_UID</span><span class="c">;</span>
	<span class="pc">t</span><span class="c">mp_ino-&gt;</span><span class="w">i_gid</span> <span class="c">=</span> <span class="w">GLOBAL_ROOT_GID</span><span class="c">;</span>
	
	<span class="pc">t</span><span class="c">mp_ino-&gt;</span><span class="w">i_</span><span class="pc">m</span><span class="c">ode</span> <span class="c">=</span> <span class="w">S_IFREG</span><span class="c">;</span>
	
	<span class="c">tmp_ino-&gt;</span><span class="w">i_op</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">ntfs_empty_inode_ops</span><span class="c">;</span>
	<span class="c">tmp_ino-&gt;</span><span class="w">i_fop</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">ntfs_empty_file_ops</span><span class="c">;</span>
	
	<span class="c">tmp_ino-&gt;</span><span class="w">i_mapping-</span><span class="c">&gt;</span><span class="w">a_ops</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">ntfs_mst_aops</span><span class="c">;</span>
	<span class="w">tmp_ni</span> <span class="pc">=</span> <span class="w">NTFS_I</span><span class="c">(tmp_ino</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">NInoSetMstProtected</span><span class="c">(</span><span class="pc">tmp_n</span><span class="c">i);</span>
	<span class="w">NInoSetSparseDisabled</span><span class="c">(</span><span class="pc">tmp_n</span><span class="c">i);</span>
	
	<span class="w">t</span><span class="pc">mp_n</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">itype</span><span class="pc">.</span><span class="w">in</span><span class="pc">d</span><span class="c">ex</span><span class="w">.block_size</span> <span class="c">=</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">mft_record_size</span><span class="c">;</span>
	<span class="pc">tmp_n</span><span class="c">i-&gt;itype.</span><span class="w">ind</span><span class="c">ex</span><span class="pc">.</span><span class="w">block_size_bits</span> <span class="c">=</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">mft_record_size_bits</span><span class="c">;</span>
	<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">mftmirr_ino</span> <span class="pc">=</span> <span class="pc">tmp_i</span><span class="c">no</span><span class="pc">;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Done.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">check_mft_mirror</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b</span> <span class="pc">=</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">sb</span><span class="c">;</span>
	<span class="w">ntfs_inode</span> <span class="pc">*</span><span class="w">mirr_ni</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="w">mft_page</span><span class="pc">,</span><span class="c"> *</span><span class="w">mirr_page</span><span class="c">;</span>
	<span class="w">u8</span> <span class="c">*</span><span class="w">kmft</span><span class="pc">,</span><span class="c"> *</span><span class="w">kmirr</span><span class="c">;</span>
	<span class="w">runlist_element</span> <span class="pc">*</span><span class="w">rl</span><span class="pc">,</span> <span class="w">rl2[2</span><span class="c">];</span>
	<span class="w">pgoff_t</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex;</span>
	<span class="c">int</span> <span class="w">mrecs_per_page</span><span class="pc">,</span> <span class="w">i</span><span class="c">;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">m</span><span class="pc">r</span><span class="c">ecs_per_page</span> <span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="w">/</span> <span class="w">vo</span><span class="c">l</span><span class="pc">-&gt;</span><span class="w">mft_record_size</span><span class="pc">;</span>
	<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!m</span><span class="c">recs_per_page</span><span class="pc">);</span>
	<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">mftmirr_size</span><span class="c">);</span>
	<span class="w">mft_page</span> <span class="pc">=</span> <span class="w">mirr_page</span> <span class="w">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">kmft</span> <span class="pc">=</span> <span class="w">kmirr</span> <span class="w">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">ind</span><span class="c">ex</span> <span class="c">=</span> <span class="w">i</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">do</span> <span class="c">{</span>
		<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">b</span><span class="pc">y</span><span class="c">tes</span><span class="pc">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">i</span> <span class="w">%</span> <span class="w">m</span><span class="c">recs_per_page</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="pc">m</span><span class="c">ft_page);</span>
				<span class="w">n</span><span class="pc">t</span><span class="c">fs_unmap_page</span><span class="pc">(</span><span class="w">m</span><span class="pc">i</span><span class="c">rr_page);</span>
			<span class="c">}</span>
			
			<span class="w">m</span><span class="pc">f</span><span class="c">t_page</span> <span class="c">=</span> <span class="w">ntfs_map_page</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mft_ino-</span><span class="pc">&gt;</span><span class="w">i_mapping</span><span class="pc">,</span>
					<span class="w">i</span><span class="pc">n</span><span class="c">dex);</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">mft_p</span><span class="c">age</span><span class="pc">)</span><span class="c">) {</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span> <span class="w">$MFT.</span><span class="pc">"</span><span class="c">);</span>
				<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
			<span class="c">}</span>
			<span class="w">kmft</span> <span class="pc">=</span> <span class="w">page_address</span><span class="c">(</span><span class="pc">mf</span><span class="c">t_page);</span>
			
			<span class="w">mirr_page</span> <span class="pc">=</span> <span class="pc">n</span><span class="c">tfs_map_page(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mftmirr_ino-</span><span class="pc">&gt;i</span><span class="c">_mapping</span><span class="pc">,</span>
					<span class="w">i</span><span class="pc">nd</span><span class="c">ex</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="pc">mi</span><span class="c">rr_page</span><span class="pc">)</span><span class="c">) {</span>
				<span class="w">n</span><span class="pc">tfs_e</span><span class="c">rror</span><span class="pc">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span> <span class="w">$MFTMirr.</span><span class="pc">"</span><span class="c">);</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">mft_unmap_out</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">kmirr</span> <span class="pc">=</span> <span class="pc">p</span><span class="c">age_address(</span><span class="pc">mi</span><span class="c">rr_page);</span>
			<span class="w">+</span><span class="c">+</span><span class="w">in</span><span class="pc">d</span><span class="c">ex;</span>
		<span class="c">}</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="w">((</span><span class="pc">(</span><span class="w">MFT_RECORD*</span><span class="pc">)</span><span class="w">kmft)-</span><span class="c">&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">MFT_RECORD_IN_USE</span><span class="c">) {</span>
			
			<span class="c">if</span> <span class="c">(</span><span class="w">ntfs_is_baad_recordp(</span><span class="pc">(</span><span class="w">le32*</span><span class="pc">)k</span><span class="c">mft</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Incomplete</span> <span class="w">multi</span> <span class="w">sector</span> <span class="pc">"</span>
						<span class="pc">"</span><span class="w">transfer</span> <span class="w">d</span><span class="pc">et</span><span class="c">ected</span> <span class="w">i</span><span class="c">n</span> <span class="w">mft</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">record</span> <span class="c">%</span><span class="w">i.",</span> <span class="w">i)</span><span class="pc">;</span>
<span class="w">mm_unmap_out</span><span class="pc">:</span>
				<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="w">mirr_page</span><span class="pc">)</span><span class="c">;</span>
<span class="w">mft_unmap_out</span><span class="pc">:</span>
				<span class="w">n</span><span class="pc">tfs_u</span><span class="c">nmap_page(</span><span class="w">mft_page</span><span class="c">);</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
			<span class="c">}</span>
		<span class="pc">}</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="w">((</span><span class="pc">(</span><span class="w">MFT_RECORD*</span><span class="pc">)</span><span class="w">kmirr)-</span><span class="c">&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">MFT_RECORD_IN_USE</span><span class="c">) {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">ntfs_is_baad_recordp</span><span class="pc">((</span><span class="w">le32*</span><span class="pc">)</span><span class="c">kmirr</span><span class="w">)) </span><span class="pc">{</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Incomplete</span> <span class="w">multi</span> <span class="w">sector</span> <span class="pc">"</span>
						<span class="c">"</span><span class="w">transfer</span> <span class="w">d</span><span class="pc">et</span><span class="c">ected</span> <span class="w">i</span><span class="pc">n</span> <span class="w">mft</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">mirror</span> <span class="w">record</span> <span class="w">%i.",</span> <span class="w">i)</span><span class="pc">;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">mm_unmap_out</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="c">}</span>
		
		<span class="w">by</span><span class="pc">tes</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e32_</span><span class="c">to_cpu</span><span class="pc">(((</span><span class="w">MFT_RECORD*</span><span class="pc">)</span><span class="w">kmft)-</span><span class="c">&gt;</span><span class="w">bytes_in_use)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">by</span><span class="pc">tes</span> <span class="w">&lt;</span> <span class="w">s</span><span class="c">izeof(</span><span class="w">MFT_RECORD_OLD) </span><span class="pc">|</span><span class="c">|</span>
				<span class="w">by</span><span class="pc">tes</span> <span class="c">&gt;</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mft_record_size</span> <span class="w">|</span><span class="c">|</span>
				<span class="w">ntfs_is_baad_recordp(</span><span class="pc">(</span><span class="w">le32*</span><span class="c">)</span><span class="pc">k</span><span class="c">mft</span><span class="w">))</span><span class="pc"> {</span>
			<span class="w">b</span><span class="pc">ytes</span> <span class="c">=</span> <span class="w">l</span><span class="c">e32_to_cpu</span><span class="pc">(((</span><span class="w">M</span><span class="c">FT_RECORD</span><span class="w">*</span><span class="pc">)</span><span class="w">kmirr)-</span><span class="c">&gt;</span><span class="pc">b</span><span class="c">ytes_in_use</span><span class="w">)</span><span class="pc">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">b</span><span class="pc">y</span><span class="c">tes</span> <span class="pc">&lt;</span> <span class="pc">s</span><span class="c">izeof(</span><span class="w">M</span><span class="pc">FT_RECORD_</span><span class="c">OLD</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span>
					<span class="w">by</span><span class="pc">tes</span> <span class="c">&gt;</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;mft_record_size</span> <span class="w">|</span><span class="c">|</span>
					<span class="c">ntfs_is_baad_recordp</span><span class="w">(</span><span class="pc">(</span><span class="c">le32</span><span class="w">*</span><span class="c">)</span><span class="pc">kmi</span><span class="c">rr</span><span class="w">))</span>
				<span class="w">b</span><span class="pc">ytes</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">m</span><span class="c">ft_record_size;</span>
		<span class="pc">}</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">e</span><span class="c">mcmp(</span><span class="w">kmft</span><span class="c">,</span> <span class="c">kmirr</span><span class="pc">,</span> <span class="w">by</span><span class="pc">tes</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb, "$MFT</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">$MFTMirr</span> <span class="w">(record</span> <span class="pc">%</span><span class="w">i)</span> <span class="w">d</span><span class="c">o</span> <span class="w">no</span><span class="pc">t</span> <span class="w">"</span>
					<span class="pc">"</span><span class="w">ma</span><span class="pc">t</span><span class="c">ch</span><span class="w">.</span>  <span class="w">Run</span> <span class="w">ntfsfix</span> <span class="w">o</span><span class="pc">r</span> <span class="w">chkdsk.",</span> <span class="w">i)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">mm_unmap_out</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="pc">k</span><span class="c">mft</span> <span class="pc">+=</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">mft_record_size</span><span class="c">;</span>
		<span class="w">k</span><span class="pc">mi</span><span class="c">rr</span> <span class="w">+</span><span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">m</span><span class="c">ft_record_size;</span>
	<span class="pc">}</span> <span class="w">w</span><span class="c">hile</span> <span class="w">(++i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mftmirr_size)</span><span class="pc">;</span>
	
	<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="w">mft_page</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">n</span><span class="c">tfs_unmap_page</span><span class="pc">(</span><span class="w">mirr_page</span><span class="c">);</span>

	
	<span class="w">rl2[</span><span class="c">0</span><span class="pc">].</span><span class="w">vcn</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">rl2</span><span class="pc">[0</span><span class="c">].</span><span class="w">lcn</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mftmirr_lcn</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">l2[</span><span class="pc">0</span><span class="c">].</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="w">=</span><span class="pc"> (</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">mftmirr_s</span><span class="c">ize</span> <span class="w">*</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mft_record_size</span> <span class="pc">+</span>
			<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">cluster_size</span> <span class="w">-</span> <span class="c">1</span><span class="w">)</span><span class="pc"> /</span> <span class="w">v</span><span class="c">ol-&gt;cluster_size</span><span class="pc">;</span>
	<span class="pc">rl</span><span class="c">2</span><span class="pc">[1</span><span class="c">].</span><span class="w">vcn</span> <span class="c">=</span> <span class="pc">r</span><span class="c">l2</span><span class="pc">[</span><span class="c">0].</span><span class="w">l</span><span class="pc">eng</span><span class="c">th;</span>
	<span class="pc">r</span><span class="c">l2[</span><span class="pc">1</span><span class="c">].</span><span class="w">lcn</span> <span class="c">=</span> <span class="w">LCN_ENOENT</span><span class="c">;</span>
	<span class="c">rl2</span><span class="pc">[1</span><span class="c">].</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="c">=</span> <span class="c">0;</span>
	
	<span class="w">mirr_ni</span> <span class="pc">=</span> <span class="w">NTFS_I</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mftmirr_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">down_read</span><span class="pc">(&amp;m</span><span class="c">irr_ni-&gt;</span><span class="w">runlist.</span><span class="pc">lo</span><span class="c">ck);</span>
	<span class="w">rl</span> <span class="pc">=</span> <span class="pc">m</span><span class="c">irr_ni-&gt;runlist.</span><span class="w">r</span><span class="pc">l</span><span class="c">;</span>
	
	<span class="w">i</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">do</span> <span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">l2</span><span class="w">[</span><span class="c">i].</span><span class="w">vcn</span> <span class="w">!</span><span class="c">=</span> <span class="pc">rl[</span><span class="c">i].vcn</span> <span class="w">|</span><span class="c">|</span> <span class="c">rl2[i].</span><span class="w">lcn</span> <span class="w">!</span><span class="c">=</span> <span class="pc">r</span><span class="c">l</span><span class="pc">[</span><span class="c">i].</span><span class="pc">l</span><span class="c">cn</span> <span class="w">|</span><span class="c">|</span>
				<span class="c">rl2[i].</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="w">!</span><span class="c">=</span> <span class="pc">rl</span><span class="c">[i].</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="pc">(</span><span class="w">sb, "$MFTMirr</span> <span class="w">location</span> <span class="w">mismatch.  "</span>
					<span class="w">"Run</span> <span class="w">chkdsk.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">up_read</span><span class="pc">(&amp;</span><span class="w">mirr_ni</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">runlist</span><span class="pc">.l</span><span class="c">ock);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
		<span class="c">}</span>
	<span class="pc">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">r</span><span class="pc">l</span><span class="c">2</span><span class="w">[</span><span class="c">i</span><span class="w">++].l</span><span class="pc">eng</span><span class="c">th</span><span class="w">)</span><span class="pc">;</span>
	<span class="w">u</span><span class="c">p_read</span><span class="pc">(&amp;</span><span class="c">mirr_ni-&gt;runlist</span><span class="pc">.</span><span class="c">lock);</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Done.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">load_and_check_logfile</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">,</span>
		<span class="w">RESTART_PAGE_HEADER</span> <span class="w">*</span><span class="pc">*</span><span class="w">rp</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*</span><span class="w">tmp_ino</span><span class="c">;</span>

	<span class="w">n</span><span class="pc">tfs_d</span><span class="c">ebug</span><span class="w">(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	<span class="w">t</span><span class="c">mp_ino</span> <span class="pc">=</span> <span class="w">ntfs_iget</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_LogFile</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="pc">t</span><span class="c">mp_ino</span><span class="pc">) |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="pc">t</span><span class="c">mp_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(tmp_ino))</span>
			<span class="w">iput</span><span class="c">(tmp_ino);</span>
		
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">ntfs_check_logfile</span><span class="c">(tmp_ino,</span> <span class="w">rp</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">p</span><span class="c">ut(tmp_ino</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">NInoSetSparseDisabled</span><span class="pc">(</span><span class="w">NTFS_I</span><span class="pc">(</span><span class="c">tmp_ino</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">logfile_ino</span> <span class="c">=</span> <span class="pc">tm</span><span class="c">p_ino</span><span class="pc">;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Done.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
<span class="c">}</span>

<span class="pc">#d</span><span class="c">efine</span> <span class="w">NTFS_HIBERFIL_HEADER_SIZE</span>	<span class="w">4</span><span class="pc">0</span><span class="c">96</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">check_windows_hibernation_status</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l)</span>
<span class="c">{</span>
	<span class="w">MFT_REF</span> <span class="w">mref</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="w">vi</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*page;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="c">*</span><span class="w">kaddr</span><span class="pc">,</span><span class="c"> *</span><span class="w">kend</span><span class="c">;</span>
	<span class="w">ntfs_name</span> <span class="pc">*</span><span class="w">na</span><span class="c">me</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="w">st</span><span class="pc">ati</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="w">ntfschar</span> <span class="w">hiberfil</span><span class="pc">[</span><span class="w">13</span><span class="pc">] = </span><span class="c">{</span> <span class="w">cpu</span><span class="pc">_to_le1</span><span class="c">6</span><span class="w">('h'),</span>
			<span class="w">cpu</span><span class="pc">_to_le1</span><span class="c">6</span><span class="w">('</span><span class="pc">i</span><span class="c">'),</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">(</span><span class="pc">'</span><span class="w">b'</span><span class="pc">)</span><span class="c">,</span>
			<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="w">(</span><span class="pc">'</span><span class="w">e'</span><span class="pc">)</span><span class="c">,</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">(</span><span class="pc">'</span><span class="w">r</span><span class="pc">')</span><span class="c">,</span>
			<span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="pc">('</span><span class="w">f</span><span class="pc">')</span><span class="c">,</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="pc">('</span><span class="w">i</span><span class="c">'),</span>
			<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="pc">('</span><span class="w">l'</span><span class="pc">)</span><span class="c">,</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('.'),</span>
			<span class="w">cp</span><span class="pc">u_to_l</span><span class="c">e16</span><span class="pc">('</span><span class="w">s</span><span class="pc">')</span><span class="c">,</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="pc">(</span><span class="c">'</span><span class="w">y</span><span class="pc">')</span><span class="c">,</span>
			<span class="w">cp</span><span class="pc">u_to_l</span><span class="c">e16</span><span class="pc">(</span><span class="c">'</span><span class="w">s'</span><span class="pc">)</span><span class="c">,</span> <span class="w">0</span> <span class="w">};</span>

	<span class="w">ntfs_debug("Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">mu</span><span class="c">tex_lock</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">root_ino-</span><span class="c">&gt;</span><span class="w">i_mutex</span><span class="pc">);</span>
	<span class="w">mref</span> <span class="pc">=</span> <span class="w">ntfs_lookup_inode_by_name</span><span class="pc">(</span><span class="w">NTFS_I</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;root_ino</span><span class="pc">),</span> <span class="w">hiberfil</span><span class="c">,</span> <span class="w">12</span><span class="c">,</span>
			<span class="w">&amp;n</span><span class="pc">a</span><span class="c">me);</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;root_ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mutex);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">IS_ERR_MREF</span><span class="c">(</span><span class="w">m</span><span class="c">ref</span><span class="pc">)</span><span class="c">) {</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">MREF_ERR</span><span class="c">(mref</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">== </span><span class="c">-</span><span class="w">EN</span><span class="pc">OE</span><span class="c">NT</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">h</span><span class="c">iberfil</span><span class="w">.sy</span><span class="pc">s</span> <span class="w">n</span><span class="c">ot</span> <span class="w">p</span><span class="pc">r</span><span class="c">esent</span><span class="w">.</span>  <span class="w">Windows</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">hibernated</span> <span class="w">o</span><span class="pc">n</span> <span class="w">t</span><span class="c">he</span> <span class="w">volume.</span><span class="pc">"</span><span class="c">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
		<span class="c">}</span>
		
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">f</span><span class="c">ind</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="w">nu</span><span class="c">mber</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">"</span>
				<span class="pc">"</span><span class="w">h</span><span class="c">iberfil</span><span class="w">.sy</span><span class="pc">s</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">r</span><span class="pc">e</span><span class="c">t;</span>
	<span class="c">}</span>
	
	<span class="w">k</span><span class="c">free(</span><span class="w">n</span><span class="pc">a</span><span class="c">me);</span>
	
	<span class="w">vi</span> <span class="pc">=</span> <span class="w">ntfs_iget</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="w">MREF</span><span class="pc">(</span><span class="w">mref</span><span class="c">));</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(vi</span><span class="w">)</span><span class="pc"> |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(vi)) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(vi))</span>
			<span class="w">iput</span><span class="c">(</span><span class="pc">v</span><span class="c">i</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">hiberfil.sy</span><span class="pc">s</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">I</span><span class="pc">S</span><span class="c">_ERR(</span><span class="pc">v</span><span class="c">i</span><span class="w">) ?</span> <span class="w">P</span><span class="c">TR_ERR(</span><span class="w">v</span><span class="c">i</span><span class="w">) : -E</span><span class="pc">I</span><span class="c">O</span><span class="w">;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely(</span><span class="w">i_size_read</span><span class="c">(vi</span><span class="pc">) &lt;</span> <span class="w">NTFS_HIBERFIL_HEADER_SIZE</span><span class="pc">))</span><span class="c"> {</span>
		<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">h</span><span class="c">iberfil</span><span class="w">.sy</span><span class="pc">s</span> <span class="w">i</span><span class="pc">s</span> <span class="w">smaller</span> <span class="w">than</span> <span class="w">4kiB</span> <span class="w">(0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">).  "</span>
				<span class="w">"Windows</span> <span class="w">i</span><span class="pc">s</span> <span class="w">hibernated</span> <span class="w">o</span><span class="pc">n</span> <span class="w">t</span><span class="c">he</span> <span class="w">volume.</span>  <span class="w">This</span> <span class="c">"</span>
				<span class="w">"is</span> <span class="pc">n</span><span class="c">ot</span> <span class="pc">t</span><span class="c">he</span> <span class="w">system</span> <span class="w">v</span><span class="pc">o</span><span class="c">lume</span><span class="w">.",</span> <span class="w">i</span><span class="pc">_</span><span class="c">size_read</span><span class="w">(</span><span class="c">vi</span><span class="w">))</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">iput_out</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">pag</span><span class="pc">e</span> <span class="c">=</span> <span class="w">ntfs_map_page</span><span class="c">(</span><span class="w">v</span><span class="pc">i-</span><span class="c">&gt;</span><span class="w">i_mapping</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">pag</span><span class="c">e)) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span> <span class="pc">f</span><span class="c">rom</span> <span class="w">hiberfil.sy</span><span class="pc">s</span><span class="w">."</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">PTR_ERR(</span><span class="w">p</span><span class="pc">ag</span><span class="c">e);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">i</span><span class="c">put_out;</span>
	<span class="c">}</span>
	<span class="w">kaddr</span> <span class="w">=</span><span class="pc"> (</span><span class="w">u</span><span class="pc">3</span><span class="c">2</span><span class="pc">*)</span><span class="w">page_address</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>
	<span class="c">if</span> <span class="w">(*</span><span class="pc">(</span><span class="w">le32*</span><span class="pc">)</span><span class="c">kaddr</span> <span class="w">=</span><span class="c">=</span> <span class="w">cp</span><span class="pc">u_to_l</span><span class="c">e32(</span><span class="w">0x72626968</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Magic</span> <span class="w">\"hibr\</span><span class="pc">"</span> <span class="w">f</span><span class="pc">ou</span><span class="c">nd</span> <span class="w">i</span><span class="c">n</span> <span class="w">h</span><span class="pc">ibe</span><span class="c">rfil</span><span class="w">.sy</span><span class="pc">s</span><span class="w">.</span>  <span class="w">Windows</span> <span class="w">i</span><span class="pc">s</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">hibernated</span> <span class="w">o</span><span class="pc">n</span> <span class="pc">t</span><span class="c">he</span> <span class="w">volume</span><span class="pc">.</span>  <span class="w">This</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">t</span><span class="c">he</span> <span class="pc">"</span>
				<span class="c">"</span><span class="w">system</span> <span class="w">v</span><span class="pc">o</span><span class="c">lume</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">unm_iput_out</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">kend</span> <span class="pc">=</span> <span class="w">kaddr</span> <span class="w">+</span> <span class="w">NTFS_HIBERFIL_HEADER_SIZE</span><span class="pc">/</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*ka</span><span class="c">ddr);</span>
	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely</span><span class="w">(*</span><span class="c">kaddr</span><span class="w">)</span><span class="c">) {</span>
			<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">hiberfil.sy</span><span class="pc">s</span> <span class="w">i</span><span class="c">s</span> <span class="w">larger</span> <span class="w">than</span> <span class="w">4kiB</span> <span class="pc">"</span>
					<span class="w">"</span><span class="pc">(</span><span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">),</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">contain</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">"</span>
					<span class="w">"\"hibr\"</span> <span class="w">mag</span><span class="c">ic</span><span class="w">,</span> <span class="w">a</span><span class="c">nd</span> <span class="w">do</span><span class="c">es</span> <span class="w">n</span><span class="pc">ot</span> <span class="w">have</span> <span class="w">a</span> <span class="w">"</span>
					<span class="pc">"</span><span class="w">zero</span> <span class="w">he</span><span class="c">ader</span><span class="pc">.</span>  <span class="w">Windows</span> <span class="w">i</span><span class="pc">s</span> <span class="w">hibernated</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">o</span><span class="pc">n</span> <span class="c">the</span> <span class="w">volume</span><span class="pc">.</span>  <span class="w">This</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="pc">t</span><span class="c">he</span> <span class="pc">"</span>
					<span class="pc">"</span><span class="w">system</span> <span class="w">v</span><span class="c">olume</span><span class="w">.",</span> <span class="w">i_size_read(vi));</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">unm_iput_out</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span> <span class="w">w</span><span class="c">hile</span> <span class="w">(++kaddr</span> <span class="pc">&lt;</span> <span class="w">kend)</span><span class="pc">;</span>
	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">hiberfil</span><span class="pc">.</span><span class="w">sy</span><span class="pc">s</span> <span class="w">contains</span> <span class="w">a</span> <span class="w">zero</span> <span class="w">he</span><span class="c">ader.</span>  <span class="w">Windows</span> <span class="w">i</span><span class="pc">s</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="pc">"</span>
			<span class="pc">"</span><span class="w">hibernated</span> <span class="w">o</span><span class="pc">n</span> <span class="c">the</span> <span class="pc">v</span><span class="c">olume</span><span class="pc">.</span>  <span class="w">This</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">t</span><span class="c">he</span> <span class="w">system</span> <span class="w">"</span>
			<span class="c">"</span><span class="w">v</span><span class="pc">o</span><span class="c">lume</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">0;</span>
<span class="w">unm_iput_out</span><span class="pc">:</span>
	<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="w">pag</span><span class="c">e);</span>
<span class="w">iput_out</span><span class="pc">:</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">vi</span><span class="c">);</span>
	<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">load_and_init_quota</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="pc">l)</span>
<span class="c">{</span>
	<span class="w">MFT_REF</span> <span class="w">mref</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span> <span class="c">*</span><span class="w">tmp_ino</span><span class="c">;</span>
	<span class="w">ntfs_name</span> <span class="pc">*</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="w">ntfschar</span> <span class="w">Quota[7</span><span class="c">] = {</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('$'),</span>
			<span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('Q'),</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('u</span><span class="c">'),</span>
			<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="w">('o'</span><span class="pc">)</span><span class="c">,</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="w">(</span><span class="pc">'</span><span class="w">t'</span><span class="pc">)</span><span class="c">,</span>
			<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="w">(</span><span class="pc">'</span><span class="w">a'</span><span class="pc">)</span><span class="c">,</span> <span class="w">0</span> <span class="w">}</span><span class="pc">;</span>
	<span class="pc">sta</span><span class="c">tic</span> <span class="w">n</span><span class="pc">tfsc</span><span class="c">har</span> <span class="w">Q</span><span class="pc">[3</span><span class="w">] </span><span class="pc">= {</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16</span><span class="pc">('</span><span class="c">$'),</span>
			<span class="w">c</span><span class="c">pu_to_le16</span><span class="w">(</span><span class="pc">'Q</span><span class="c">'),</span> <span class="w">0</span> <span class="w">}</span><span class="c">;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">mu</span><span class="c">tex_lock</span><span class="pc">(&amp;</span><span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">extend_ino-</span><span class="c">&gt;</span><span class="w">i_mutex</span><span class="pc">);</span>
	<span class="w">mref</span> <span class="pc">=</span> <span class="w">ntfs_lookup_inode_by_name</span><span class="c">(</span><span class="w">NTFS_I(v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;extend_ino</span><span class="w">)</span><span class="pc">,</span> <span class="w">Quota</span><span class="c">,</span> <span class="w">6</span><span class="pc">,</span>
			<span class="w">&amp;na</span><span class="c">me);</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">vo</span><span class="c">l-&gt;extend_ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mutex);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">IS_ERR_MREF</span><span class="c">(</span><span class="pc">m</span><span class="c">ref</span><span class="pc">)</span><span class="c">) {</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">MREF_ERR</span><span class="c">(mref</span><span class="w">) == -E</span><span class="pc">N</span><span class="c">OENT</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_debug("$Q</span><span class="c">uota</span> <span class="w">n</span><span class="c">ot</span> <span class="w">p</span><span class="pc">r</span><span class="c">esent</span><span class="w">.</span>  <span class="w">V</span><span class="c">olume</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">have</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">quotas</span> <span class="w">e</span><span class="pc">n</span><span class="c">abled</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			
			<span class="w">NVolSetQuotaOutOfDate</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="c">}</span>
		
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">f</span><span class="c">ind</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="w">nu</span><span class="c">mber</span> <span class="w">f</span><span class="c">or</span> <span class="w">$</span><span class="c">Quota</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	<span class="w">k</span><span class="c">free(</span><span class="w">n</span><span class="pc">a</span><span class="c">me);</span>
	
	<span class="w">tmp_ino</span> <span class="pc">=</span> <span class="w">ntfs_iget</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">,</span> <span class="w">MREF</span><span class="pc">(</span><span class="w">mref</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(tmp_ino</span><span class="pc">) |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(tmp_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(tmp_ino))</span>
			<span class="w">iput</span><span class="c">(tmp_ino</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$Quota.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">quota_ino</span> <span class="c">=</span> <span class="w">t</span><span class="pc">m</span><span class="c">p_ino;</span>
	
	<span class="pc">t</span><span class="c">mp_ino</span> <span class="pc">=</span> <span class="w">ntfs_index_iget</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;quota_ino,</span> <span class="w">Q</span><span class="c">,</span> <span class="w">2</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">t</span><span class="c">mp_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">n</span><span class="c">tfs_error(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">l</span><span class="c">oad</span> <span class="w">$Q</span><span class="pc">u</span><span class="c">ota</span><span class="w">/$Q</span> <span class="w">ind</span><span class="c">ex</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">quota_q_ino</span> <span class="c">=</span> <span class="pc">t</span><span class="c">mp_ino;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Done.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">load_and_init_usnjrnl</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">MFT_REF</span> <span class="w">mref</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="w">t</span><span class="c">mp_ino;</span>
	<span class="w">ntfs_inode</span> <span class="pc">*</span><span class="w">tmp_ni</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*page;</span>
	<span class="w">ntfs_name</span> <span class="c">*</span><span class="w">na</span><span class="c">me</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">USN_HEADER</span> <span class="w">*uh</span><span class="pc">;</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="w">c</span><span class="c">onst</span> <span class="w">ntfschar</span> <span class="w">UsnJrnl</span><span class="pc">[</span><span class="w">9</span><span class="pc">] </span><span class="c">= {</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('$'),</span>
			<span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('U'),</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('s</span><span class="pc">')</span><span class="c">,</span>
			<span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16</span><span class="w">('n'</span><span class="pc">)</span><span class="c">,</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">('J'</span><span class="pc">)</span><span class="c">,</span>
			<span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">(</span><span class="pc">'</span><span class="w">r'</span><span class="pc">)</span><span class="c">,</span> <span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="pc">('</span><span class="w">n</span><span class="c">'),</span>
			<span class="w">c</span><span class="pc">pu_to_le1</span><span class="c">6</span><span class="pc">('</span><span class="w">l</span><span class="c">'),</span> <span class="w">0</span> <span class="w">}</span><span class="pc">;</span>
	<span class="pc">sta</span><span class="c">tic</span> <span class="w">n</span><span class="c">tfschar</span> <span class="w">Max</span><span class="pc">[</span><span class="c">5</span><span class="w">] </span><span class="pc">= {</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16</span><span class="w">(</span><span class="pc">'$</span><span class="c">'),</span>
			<span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16</span><span class="w">(</span><span class="pc">'</span><span class="w">M</span><span class="pc">')</span><span class="c">,</span> <span class="w">cp</span><span class="pc">u_to_le1</span><span class="c">6</span><span class="w">(</span><span class="pc">'</span><span class="w">a</span><span class="pc">')</span><span class="c">,</span>
			<span class="w">cp</span><span class="pc">u_to_l</span><span class="c">e16</span><span class="pc">(</span><span class="c">'</span><span class="w">x</span><span class="pc">')</span><span class="c">,</span> <span class="w">0</span> <span class="w">}</span><span class="pc">;</span>
	<span class="pc">sta</span><span class="c">tic</span> <span class="w">n</span><span class="c">tfschar</span> <span class="pc">J[</span><span class="c">3</span><span class="w">]</span><span class="pc"> = {</span> <span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16</span><span class="w">('</span><span class="pc">$</span><span class="c">'),</span>
			<span class="w">c</span><span class="pc">p</span><span class="c">u_to_le16</span><span class="w">(</span><span class="pc">'</span><span class="w">J</span><span class="pc">')</span><span class="c">,</span> <span class="w">0</span> <span class="w">}</span><span class="pc">;</span>

	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">mu</span><span class="c">tex_lock</span><span class="pc">(&amp;</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">extend_ino-</span><span class="c">&gt;</span><span class="w">i_mutex</span><span class="c">);</span>
	<span class="w">mref</span> <span class="pc">=</span> <span class="w">ntfs_lookup_inode_by_name</span><span class="c">(</span><span class="w">NTFS_I(v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;extend_ino</span><span class="pc">),</span> <span class="w">UsnJrnl</span><span class="c">,</span> <span class="w">8</span><span class="pc">,</span>
			<span class="w">&amp;na</span><span class="c">me);</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;extend_ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mutex);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">IS_ERR_MREF</span><span class="c">(</span><span class="w">m</span><span class="c">ref</span><span class="pc">)</span><span class="c">) {</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">MREF_ERR</span><span class="c">(mref</span><span class="w">) == -E</span><span class="pc">N</span><span class="c">OENT</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">ntfs_debug("$U</span><span class="c">snJrnl</span> <span class="w">n</span><span class="c">ot</span> <span class="w">p</span><span class="pc">r</span><span class="c">esent</span><span class="w">.</span>  <span class="w">V</span><span class="c">olume</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">have</span> <span class="w">transaction</span> <span class="w">logging</span> <span class="w">e</span><span class="pc">n</span><span class="c">abled</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
<span class="w">not_enabled</span><span class="pc">:</span>
			
			<span class="w">NVolSetUsnJrnlStamped</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="c">}</span>
		
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">f</span><span class="c">ind</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="w">nu</span><span class="c">mber</span> <span class="w">f</span><span class="c">or</span> <span class="w">"</span>
				<span class="w">"$U</span><span class="c">snJrnl</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	<span class="w">k</span><span class="c">free(</span><span class="w">n</span><span class="pc">a</span><span class="c">me);</span>
	
	<span class="w">tmp_ino</span> <span class="pc">=</span> <span class="w">ntfs_iget</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="w">MREF</span><span class="pc">(</span><span class="w">mref</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely(</span><span class="w">I</span><span class="c">S_ERR(tmp_ino</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="pc">t</span><span class="c">mp_ino</span><span class="pc">)))</span><span class="c"> {</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="pc">S_ER</span><span class="c">R(tmp_ino))</span>
			<span class="w">iput</span><span class="c">(tmp_ino</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$UsnJrnl.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">usnjrnl_ino</span> <span class="c">=</span> <span class="w">t</span><span class="pc">m</span><span class="c">p_ino;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(unlikely(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">vol_flags</span> <span class="w">&amp;</span> <span class="w">VOLUME_DELETE_USN_UNDERWAY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ntfs_debug("$U</span><span class="c">snJrnl</span> <span class="w">i</span><span class="pc">n</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">process</span> <span class="w">o</span><span class="c">f</span> <span class="w">being</span> <span class="w">di</span><span class="c">sabled</span><span class="w">.  "</span>
				<span class="pc">"</span><span class="w">V</span><span class="pc">o</span><span class="c">lume</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">have</span> <span class="w">transaction</span> <span class="w">logging</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">e</span><span class="pc">n</span><span class="c">abled</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">not_enabled</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">t</span><span class="c">mp_ino</span> <span class="pc">=</span> <span class="w">ntfs_attr_iget</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">usnjrnl_ino</span><span class="c">,</span> <span class="w">AT_DATA</span><span class="c">,</span> <span class="w">Max</span><span class="c">,</span> <span class="w">4</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(tmp_ino)) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$UsnJrnl/$DATA/</span><span class="pc">$</span><span class="w">M</span><span class="c">ax</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">at</span><span class="pc">t</span><span class="c">ribute</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">usnjrnl_max_ino</span> <span class="c">=</span> <span class="pc">t</span><span class="c">mp_ino</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">n</span><span class="c">likely(</span><span class="w">i_size_read</span><span class="c">(</span><span class="pc">t</span><span class="c">mp_ino</span><span class="pc">) </span><span class="c">&lt;</span> <span class="pc">s</span><span class="c">izeof(</span><span class="w">USN_HEADER</span><span class="pc">))) </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Found</span> <span class="w">corrupt</span> <span class="w">$U</span><span class="c">snJrnl</span><span class="w">/</span><span class="pc">$</span><span class="w">D</span><span class="c">ATA</span><span class="w">/</span><span class="pc">$</span><span class="w">M</span><span class="c">ax</span> <span class="pc">"</span>
				<span class="c">"</span><span class="w">at</span><span class="pc">t</span><span class="c">ribute</span> <span class="w">(si</span><span class="c">ze</span> <span class="w">i</span><span class="pc">s</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span> <span class="w">but</span> <span class="w">should</span> <span class="w">b</span><span class="pc">e</span> <span class="w">a</span><span class="pc">t</span> <span class="pc">"</span>
				<span class="pc">"</span><span class="w">least</span> <span class="w">0</span><span class="c">x%</span><span class="w">zx</span> <span class="w">b</span><span class="c">ytes</span><span class="w">).",</span> <span class="w">i_size_read(tmp_ino),</span>
				<span class="w">si</span><span class="pc">zeo</span><span class="c">f(</span><span class="w">USN_HEADER</span><span class="pc">))</span><span class="c">;</span>
		<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	<span class="w">t</span><span class="pc">m</span><span class="c">p_ino</span> <span class="c">=</span> <span class="w">ntfs_attr_iget</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">usnjrnl_ino</span><span class="c">,</span> <span class="w">AT_DATA</span><span class="c">,</span> <span class="w">J</span><span class="c">,</span> <span class="w">2</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="pc">t</span><span class="c">mp_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$UsnJrnl/$DATA/</span><span class="pc">$</span><span class="w">J</span> <span class="w">"</span>
				<span class="pc">"</span><span class="w">at</span><span class="pc">t</span><span class="c">ribute</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">usnjrnl_j_ino</span> <span class="c">=</span> <span class="pc">t</span><span class="c">mp_ino</span><span class="pc">;</span>
	
	<span class="w">tmp_ni</span> <span class="pc">=</span> <span class="w">NTFS_I</span><span class="c">(</span><span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;usnjrnl_j_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">un</span><span class="c">likely</span><span class="pc">(!</span><span class="w">NInoNonResident</span><span class="c">(tmp_ni</span><span class="w">) || !NInoSparse</span><span class="pc">(</span><span class="c">tmp_ni</span><span class="pc">))) </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb, "$UsnJrnl/$DATA/</span><span class="pc">$</span><span class="w">J</span> <span class="w">at</span><span class="pc">t</span><span class="c">ribute</span> <span class="w">i</span><span class="pc">s</span> <span class="w">resident</span> <span class="pc">"</span>
				<span class="pc">"</span><span class="w">a</span><span class="c">nd</span><span class="w">/or</span> <span class="w">n</span><span class="c">ot</span> <span class="w">sparse.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	<span class="w">pa</span><span class="pc">g</span><span class="c">e</span> <span class="c">=</span> <span class="w">ntfs_map_page</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">usnjrnl_max_ino-</span><span class="pc">&gt;</span><span class="w">i_mapping</span><span class="c">,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">p</span><span class="c">age)) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb,</span><span class="pc"> "F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">r</span><span class="pc">ea</span><span class="c">d</span> <span class="pc">f</span><span class="c">rom</span> <span class="w">$UsnJrnl/$DATA/</span><span class="pc">$</span><span class="w">Max</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">at</span><span class="pc">t</span><span class="c">ribute</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">uh</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">USN_HEADER*</span><span class="pc">)</span><span class="w">page_address</span><span class="c">(</span><span class="w">p</span><span class="c">age);</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="pc">un</span><span class="c">likely(</span><span class="w">sle64_to_cpu</span><span class="c">(</span><span class="w">u</span><span class="c">h</span><span class="w">-</span><span class="c">&gt;</span><span class="w">allocation_delta) &gt;</span>
			<span class="w">s</span><span class="pc">l</span><span class="c">e64_to_cpu</span><span class="w">(</span><span class="pc">u</span><span class="c">h</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">maximum_size)))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Allocation</span> <span class="w">del</span><span class="pc">t</span><span class="c">a</span> <span class="w">(0</span><span class="c">x%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">)</span> <span class="w">exceeds</span> <span class="w">"</span>
				<span class="pc">"</span><span class="w">maximum</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">(</span><span class="c">0x%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">).  $UsnJrnl</span> <span class="w">i</span><span class="c">s</span> <span class="w">corrupt.",</span>
				<span class="pc">(</span><span class="w">l</span><span class="pc">o</span><span class="c">ng</span> <span class="pc">l</span><span class="c">ong)</span><span class="pc">s</span><span class="c">le64_to_cpu</span><span class="pc">(</span><span class="c">uh-&gt;</span><span class="w">allocation_delta),</span>
				<span class="c">(</span><span class="pc">l</span><span class="c">ong</span> <span class="pc">l</span><span class="c">ong)</span><span class="pc">s</span><span class="c">le64_to_cpu</span><span class="pc">(u</span><span class="c">h</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">maximum_size)</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="pc">un</span><span class="c">likely(</span><span class="pc">s</span><span class="c">le64_to_cpu</span><span class="pc">(</span><span class="c">uh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">lowest_valid_usn) &gt;</span><span class="pc">=</span>
			<span class="w">i_size_read</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">usnjrnl_j_ino))</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">l</span><span class="c">ikely(</span><span class="pc">s</span><span class="c">le64_to_cpu</span><span class="pc">(</span><span class="c">uh</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">owest_valid_usn</span><span class="pc">) </span><span class="c">==</span>
				<span class="w">i</span><span class="c">_size_read</span><span class="w">(vo</span><span class="c">l-&gt;usnjrnl_j_ino</span><span class="w">)))</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">n</span><span class="pc">t</span><span class="c">fs_unmap_page(</span><span class="w">pa</span><span class="c">ge);</span>
			<span class="w">ntfs_debug("$UsnJrnl</span> <span class="w">i</span><span class="pc">s</span> <span class="w">e</span><span class="pc">n</span><span class="c">abled</span> <span class="w">but</span> <span class="w">nothing</span> <span class="w">h</span><span class="c">as</span> <span class="w">been</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">logged</span> <span class="w">since</span> <span class="w">i</span><span class="pc">t</span> <span class="w">was</span> <span class="w">la</span><span class="pc">s</span><span class="c">t</span> <span class="w">stamped.  "</span>
					<span class="w">"Treating</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">a</span><span class="pc">s</span> <span class="w">if</span> <span class="pc">t</span><span class="c">he</span> <span class="w">volume</span> <span class="w">does</span> <span class="pc">"</span>
					<span class="pc">"n</span><span class="c">ot</span> <span class="w">have</span> <span class="w">transaction</span> <span class="w">logging</span> <span class="c">"</span>
					<span class="c">"</span><span class="w">e</span><span class="pc">n</span><span class="c">abled</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">not_enabled</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">ntfs_error</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">sb, "$UsnJrnl</span> <span class="w">ha</span><span class="pc">s</span> <span class="w">lowest</span> <span class="w">v</span><span class="pc">a</span><span class="c">lid</span> <span class="w">usn</span> <span class="c">(</span><span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">) "</span>
				<span class="w">"wh</span><span class="pc">ic</span><span class="c">h</span> <span class="w">i</span><span class="c">s</span> <span class="w">ou</span><span class="pc">t</span> <span class="pc">o</span><span class="c">f</span> <span class="w">bounds</span> <span class="w">(</span><span class="pc">0</span><span class="c">x%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="w">).  $U</span><span class="c">snJrnl</span> <span class="pc">"</span>
				<span class="c">"</span><span class="w">i</span><span class="pc">s</span> <span class="w">corrupt.",</span>
				<span class="w">(lo</span><span class="pc">n</span><span class="c">g</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">sle64_to_cpu</span><span class="c">(</span><span class="w">uh-</span><span class="c">&gt;</span><span class="w">lowest_valid_usn)</span><span class="pc">,</span>
				<span class="w">i_size_read</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">usnjrnl_j_ino</span><span class="pc">))</span><span class="c">;</span>
		<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">}</span>
	<span class="w">n</span><span class="c">tfs_unmap_page(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Done.</span><span class="pc">")</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">load_and_init_attrdef</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l)</span>
<span class="c">{</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">i_size</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="c">b</span> <span class="pc">=</span> <span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sb</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*</span><span class="w">in</span><span class="pc">o;</span>
	<span class="c">struct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*page;</span>
	<span class="w">pgoff_t</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span><span class="pc">,</span> <span class="w">max_index</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">s</span><span class="c">ize;</span>

	<span class="w">ntfs_debug("Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">ino</span> <span class="c">=</span> <span class="w">ntfs_iget</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_AttrDef</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">ino) </span><span class="pc">|</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="w">ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">ino</span><span class="c">))</span>
			<span class="w">iput</span><span class="c">(</span><span class="w">ino</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">aile</span><span class="c">d;</span>
	<span class="c">}</span>
	<span class="w">NInoSetSparseDisabled</span><span class="c">(</span><span class="w">NTFS_I</span><span class="pc">(</span><span class="w">ino)</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">i_size</span> <span class="pc">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="c">_size</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0</span> <span class="pc">|</span><span class="c">|</span> <span class="pc">i</span><span class="c">_size</span> <span class="pc">&gt;</span> <span class="w">0x7fffffff</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">iput_failed</span><span class="c">;</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">attrdef</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">ATTR_DEF*</span><span class="pc">)</span><span class="w">ntfs_malloc_nofs</span><span class="c">(i_size);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;attrdef)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">i</span><span class="c">put_failed;</span>
	<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">max_index</span> <span class="pc">=</span> <span class="c">i_size</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="w">si</span><span class="c">ze</span> <span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">&lt;</span> <span class="pc">m</span><span class="c">ax_index) {</span>
		
<span class="w">read_partial_attrdef_page:</span>
		<span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">=</span> <span class="w">ntfs_map_page</span><span class="c">(</span><span class="w">ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mapping</span><span class="c">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">p</span><span class="c">age))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">free_iput_failed</span><span class="c">;</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy</span><span class="pc">((</span><span class="w">u</span><span class="pc">8</span><span class="c">*)</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">attrdef</span> <span class="w">+</span><span class="pc"> </span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">++ &lt;&lt;</span> <span class="w">PAGE_CACHE_SHIFT),</span>
				<span class="w">page_address</span><span class="c">(</span><span class="w">p</span><span class="c">age),</span> <span class="pc">s</span><span class="c">ize</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="pc">p</span><span class="c">age);</span>
	<span class="w">}</span><span class="pc">;</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">s</span><span class="c">ize</span> <span class="pc">=</span><span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">) {</span>
		<span class="pc">s</span><span class="c">ize</span> <span class="c">=</span> <span class="w">i_size</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">PAGE_CACHE_MASK</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(size</span><span class="pc">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">read_partial_attrdef_page</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">attrdef_size</span> <span class="c">=</span> <span class="pc">i</span><span class="c">_size;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Read</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span> <span class="w">b</span><span class="c">ytes</span> <span class="w">f</span><span class="c">rom</span> <span class="w">$AttrDef.",</span> <span class="w">i</span><span class="c">_size</span><span class="w">)</span><span class="c">;</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="w">free_iput_failed</span><span class="c">:</span>
	<span class="w">ntfs_free</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">attrdef</span><span class="c">);</span>
	<span class="w">v</span><span class="pc">ol-</span><span class="c">&gt;attrdef</span> <span class="c">=</span> <span class="c">NULL;</span>
<span class="w">iput_failed</span><span class="pc">:</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">ut(</span><span class="w">ino</span><span class="c">);</span>
<span class="w">fa</span><span class="pc">ile</span><span class="c">d:</span>
	<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">initialize</span> <span class="w">at</span><span class="pc">tri</span><span class="c">bute</span> <span class="w">definition</span> <span class="w">t</span><span class="pc">a</span><span class="c">ble</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
<span class="c">}</span>

<span class="w">#</span><span class="c">endif</span> 


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">load_and_init_upcase</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">i_size</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">s</span><span class="pc">u</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="c">b</span> <span class="pc">=</span> <span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sb</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span> <span class="c">*</span><span class="w">ino</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*page;</span>
	<span class="w">pgoff_t</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span><span class="pc">,</span> <span class="w">max_index</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">s</span><span class="c">ize;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i,</span> <span class="w">m</span><span class="c">ax;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">ino</span> <span class="pc">=</span> <span class="w">ntfs_iget</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_UpCase</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">ino)</span><span class="pc"> |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="w">ino</span><span class="c">)) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">ino</span><span class="c">))</span>
			<span class="w">iput</span><span class="c">(</span><span class="w">ino</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">upcase_failed</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">i_size</span> <span class="pc">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">i_size</span> <span class="w">|</span><span class="pc">|</span> <span class="c">i_size</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">ntfschar) </span><span class="pc">-</span> <span class="c">1</span><span class="pc">) </span><span class="c">||</span>
			<span class="pc">i</span><span class="c">_size</span> <span class="w">&gt;</span> <span class="w">64ULL</span> <span class="w">*</span> <span class="w">1</span><span class="pc">02</span><span class="c">4</span> <span class="pc">*</span> <span class="pc">s</span><span class="c">izeof(</span><span class="w">n</span><span class="c">tfschar))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">iput_upcase_failed</span><span class="c">;</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">upcase</span> <span class="pc">= </span><span class="c">(</span><span class="w">n</span><span class="c">tfschar</span><span class="w">*</span><span class="c">)</span><span class="w">ntfs_malloc_nofs</span><span class="c">(</span><span class="pc">i</span><span class="c">_size);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;upcase)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">i</span><span class="c">put_upcase_failed;</span>
	<span class="w">ind</span><span class="c">ex</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
	<span class="w">max_index</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">_size</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">&lt;</span> <span class="pc">m</span><span class="c">ax_index) {</span>
		
<span class="w">read_partial_upcase_page:</span>
		<span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">=</span> <span class="w">ntfs_map_page</span><span class="c">(</span><span class="w">ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mapping</span><span class="c">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">p</span><span class="c">age))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">iput_upcase_failed</span><span class="c">;</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy</span><span class="pc">((</span><span class="w">c</span><span class="pc">ha</span><span class="c">r*)</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">upcase</span> <span class="w">+</span><span class="pc"> </span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">++ &lt;&lt;</span> <span class="w">PAGE_CACHE_SHIFT),</span>
				<span class="w">page_address</span><span class="c">(</span><span class="pc">p</span><span class="c">age),</span> <span class="pc">s</span><span class="c">ize</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ntfs_unmap_page</span><span class="c">(</span><span class="pc">p</span><span class="c">age);</span>
	<span class="w">}</span><span class="pc">;</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">s</span><span class="c">ize</span> <span class="pc">=</span><span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">) {</span>
		<span class="pc">si</span><span class="c">ze</span> <span class="c">=</span> <span class="w">i_size</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">PAGE_CACHE_MASK</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(size</span><span class="pc">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">read_partial_upcase_page</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">upcase_len</span> <span class="c">=</span> <span class="pc">i</span><span class="c">_size</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">UCHAR_T_SIZE_BITS</span><span class="c">;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Read</span> <span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span> <span class="w">b</span><span class="c">ytes</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">$UpCase</span> <span class="w">(expected</span> <span class="w">%zu</span> <span class="w">b</span><span class="c">ytes</span><span class="w">).",</span>
			<span class="w">i</span><span class="c">_size</span><span class="w">,</span> <span class="w">6</span><span class="c">4</span> <span class="c">*</span> <span class="c">1024</span> <span class="pc">*</span> <span class="w">s</span><span class="c">izeof(</span><span class="w">ntfschar)</span><span class="pc">);</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">utex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">default_upcase</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">n</span><span class="c">tfs_debug</span><span class="pc">("</span><span class="w">Using</span> <span class="w">volume</span> <span class="w">specified</span> <span class="w">$U</span><span class="pc">p</span><span class="c">Case</span> <span class="w">since</span> <span class="w">def</span><span class="pc">ault</span> <span class="w">i</span><span class="pc">s</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">n</span><span class="pc">ot</span> <span class="w">pr</span><span class="pc">e</span><span class="c">sent</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">m</span><span class="c">utex_unlock(&amp;ntfs_lock</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="c">}</span>
	<span class="w">ma</span><span class="pc">x</span> <span class="c">=</span> <span class="w">default_upcase_len</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ma</span><span class="pc">x</span> <span class="c">&gt;</span> <span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">upcase_len</span><span class="pc">)</span>
		<span class="w">m</span><span class="pc">a</span><span class="c">x</span> <span class="c">=</span> <span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;upcase_len;</span>
	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">m</span><span class="pc">a</span><span class="c">x;</span> <span class="c">i</span><span class="pc">++)</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">upcase</span><span class="c">[i</span><span class="pc">] !</span><span class="c">=</span> <span class="w">default_upcase</span><span class="pc">[</span><span class="c">i</span><span class="w">])</span>
			<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">if</span> <span class="c">(i</span> <span class="pc">=</span><span class="c">=</span> <span class="w">m</span><span class="pc">a</span><span class="c">x</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;upcase</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">u</span><span class="c">pcase</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">efault_upcase</span><span class="pc">;</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">upcase_len</span> <span class="c">=</span> <span class="w">m</span><span class="pc">a</span><span class="c">x;</span>
		<span class="w">ntfs_nr_upcase_users+</span><span class="c">+;</span>
		<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
		<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">V</span><span class="c">olume</span> <span class="w">specified</span> <span class="w">$UpCase</span> <span class="w">matches</span> <span class="w">de</span><span class="pc">fault</span><span class="w">.</span> <span class="w">Using</span> <span class="w">"</span>
				<span class="pc">"</span><span class="w">def</span><span class="pc">ault</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="c">}</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;ntfs_lock);</span>
	<span class="w">n</span><span class="pc">tfs_d</span><span class="c">ebug</span><span class="pc">(</span><span class="c">"</span><span class="w">U</span><span class="pc">s</span><span class="c">ing</span> <span class="w">volume</span> <span class="w">s</span><span class="pc">p</span><span class="c">ecified</span> <span class="w">$U</span><span class="c">pCase</span> <span class="w">since</span> <span class="w">it</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">ma</span><span class="pc">tch</span> <span class="pc">"</span>
			<span class="w">"t</span><span class="c">he</span> <span class="w">def</span><span class="c">ault</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="w">iput_upcase_failed</span><span class="c">:</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">ino</span><span class="c">);</span>
	<span class="w">ntfs_free</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">upcase</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;upcase</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
<span class="w">upcase_failed:</span>
	<span class="w">mu</span><span class="pc">tex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">default_upcase</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">u</span><span class="c">pcase</span> <span class="pc">=</span> <span class="c">default_upcase;</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">upcase_len</span> <span class="c">=</span> <span class="w">default_upcase_len</span><span class="c">;</span>
		<span class="w">ntfs_nr_upcase_users+</span><span class="pc">+</span><span class="c">;</span>
		<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="pc">ntfs_l</span><span class="c">ock</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$UpCase</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">volume.</span> <span class="w">Using</span> <span class="pc">"</span>
				<span class="pc">"</span><span class="w">def</span><span class="pc">ault</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="c">}</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;ntfs_lock);</span>
	<span class="w">n</span><span class="pc">tfs_e</span><span class="c">rror</span><span class="pc">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">initialize</span> <span class="w">upcase</span> <span class="w">t</span><span class="pc">a</span><span class="c">ble</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">lock_class_key</span>
	<span class="w">lcnbmp_runlist_lock_key,</span> <span class="w">lcnbmp_mrec_lock_key</span><span class="pc">,</span>
	<span class="w">mftbmp_runlist_lock_key</span><span class="c">,</span> <span class="w">mftbmp_mrec_lock_key;</span>


<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">load_system_files</span><span class="pc">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="w">s</span><span class="pc">b</span> <span class="pc">=</span> <span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sb</span><span class="c">;</span>
	<span class="w">MFT_RECORD</span> <span class="w">*m</span><span class="pc">;</span>
	<span class="w">VOLUME_INFORMATION</span> <span class="pc">*</span><span class="w">vi</span><span class="pc">;</span>
	<span class="w">ntfs_attr_search_ctx</span> <span class="pc">*</span><span class="w">c</span><span class="pc">t</span><span class="c">x</span><span class="pc">;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
	<span class="w">RESTART_PAGE_HEADER</span> <span class="pc">*</span><span class="w">rp</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span> 

	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
<span class="pc">#i</span><span class="c">fdef</span> <span class="w">N</span><span class="c">TFS_RW</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">load_and_init_mft_mirror</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="w">) || !check_mft_mirror</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">st</span><span class="pc">ati</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="pc">t</span><span class="c">o</span> <span class="w">load</span> <span class="w">$MFTMirr"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*</span><span class="w">es2</span> <span class="w">= "$M</span><span class="c">FTMirr</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">ma</span><span class="pc">t</span><span class="c">ch</span> <span class="w">$MFT"</span><span class="pc">;</span>
		<span class="w">s</span><span class="c">tatic</span> <span class="c">const</span> <span class="c">char</span> <span class="c">*</span><span class="w">es3</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">ntfsfix</span> <span class="w">an</span><span class="c">d</span><span class="w">/or</span> <span class="w">chkdsk.";</span>

		
		<span class="w">i</span><span class="pc">f</span> <span class="w">(</span><span class="pc">!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="pc">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
					<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">)))</span><span class="c"> {</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n_</span><span class="c">errors</span><span class="w">="</span>
						<span class="pc">"</span><span class="w">con</span><span class="pc">ti</span><span class="c">nue</span> <span class="w">nor</span> <span class="w">on</span><span class="pc">_</span><span class="c">errors</span><span class="w">=</span><span class="pc">"</span>
						<span class="pc">"</span><span class="w">remount-ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="pc">s"</span><span class="c">,</span>
						<span class="w">!vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">mftmirr_ino</span> <span class="w">?</span> <span class="w">es1</span> <span class="c">:</span> <span class="w">es2</span><span class="pc">,</span>
						<span class="w">es3</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">iput_mirr_err_out</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y%</span><span class="pc">s"</span><span class="c">,</span>
					<span class="w">!vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">ftmirr_ino</span> <span class="w">?</span> <span class="pc">e</span><span class="c">s1</span> <span class="c">:</span> <span class="c">es2</span><span class="w">,</span> <span class="c">es3</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="c">else</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Will</span> <span class="w">n</span><span class="c">ot</span> <span class="w">b</span><span class="c">e</span> <span class="w">able</span> <span class="w">t</span><span class="c">o</span> <span class="w">remount</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">r</span><span class="pc">ea</span><span class="c">d</span><span class="w">-w</span><span class="c">rite</span><span class="pc">%s"</span><span class="c">,</span>
					<span class="w">!vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">ftmirr_ino</span> <span class="w">?</span> <span class="c">es1</span> <span class="c">:</span> <span class="c">es2</span><span class="pc">,</span> <span class="c">es3</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span> 
	
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">mftbmp_ino</span> <span class="c">=</span> <span class="w">ntfs_attr_iget</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mft_ino</span><span class="c">,</span> <span class="w">AT_BITMAP</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;mftbmp_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"Failed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$MFT/$BITMAP</span> <span class="w">at</span><span class="pc">t</span><span class="c">ribute</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">iput_mirr_err_out</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">lockdep_set_class</span><span class="pc">(&amp;</span><span class="w">NTFS_I(vo</span><span class="pc">l-</span><span class="c">&gt;mftbmp_ino</span><span class="w">)-</span><span class="c">&gt;</span><span class="w">runlist</span><span class="pc">.</span><span class="w">l</span><span class="pc">o</span><span class="c">ck</span><span class="pc">,</span>
			   <span class="pc">&amp;</span><span class="w">mftbmp_runlist_lock_key</span><span class="c">);</span>
	<span class="w">l</span><span class="c">ockdep_set_class</span><span class="pc">(&amp;N</span><span class="c">TFS_I</span><span class="w">(vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">m</span><span class="c">ftbmp_ino</span><span class="w">)-</span><span class="c">&gt;</span><span class="w">mrec_lock</span><span class="c">,</span>
			   <span class="pc">&amp;</span><span class="w">mftbmp_mrec_lock_key</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">load_and_init_upcase</span><span class="c">(</span><span class="w">vo</span><span class="pc">l))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">iput_mftbmp_err_out</span><span class="c">;</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">load_and_init_attrdef</span><span class="c">(</span><span class="w">vo</span><span class="c">l</span><span class="pc">)</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">iput_upcase_err_out</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span> 
	
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">lcnbmp_ino</span> <span class="c">=</span> <span class="w">ntfs_iget</span><span class="pc">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_Bitmap</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">cnbmp_ino</span><span class="w">)</span><span class="pc"> |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">l</span><span class="c">cnbmp_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">v</span><span class="c">ol-&gt;lcnbmp_ino))</span>
			<span class="w">iput</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">l</span><span class="c">cnbmp_ino);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">bitmap_failed</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">lockdep_set_class</span><span class="pc">(&amp;</span><span class="w">NTFS_I</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;lcnbmp_ino</span><span class="w">)-</span><span class="c">&gt;</span><span class="w">runlist.l</span><span class="pc">ock</span><span class="c">,</span>
			   <span class="c">&amp;</span><span class="w">lcnbmp_runlist_lock_key</span><span class="c">);</span>
	<span class="w">l</span><span class="pc">o</span><span class="c">ckdep_set_class</span><span class="pc">(&amp;</span><span class="w">N</span><span class="c">TFS_I</span><span class="w">(vo</span><span class="pc">l</span><span class="c">-&gt;lcnbmp_ino</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mrec_lock</span><span class="c">,</span>
			   <span class="pc">&amp;</span><span class="w">lcnbmp_mrec_lock_key</span><span class="c">);</span>

	<span class="w">NInoSetSparseDisabled</span><span class="c">(</span><span class="w">N</span><span class="c">TFS_I</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">lcnbmp_i</span><span class="c">no</span><span class="pc">)</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">nr_clusters</span> <span class="w">+</span> <span class="w">7) &gt;</span><span class="pc">&gt;</span> <span class="w">3</span> <span class="w">&gt;</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">l</span><span class="c">cnbmp_ino</span><span class="w">))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">iput</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">l</span><span class="c">cnbmp_ino</span><span class="pc">)</span><span class="c">;</span>
<span class="w">bitmap_failed</span><span class="pc">:</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$Bitmap.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">iput_attrdef_err_out</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">vol_ino</span> <span class="c">=</span> <span class="w">ntfs_iget</span><span class="pc">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_Volume</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;vol_ino</span><span class="w">) |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="w">v</span><span class="pc">ol-</span><span class="c">&gt;</span><span class="pc">v</span><span class="c">ol_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;vol_ino))</span>
			<span class="w">iput</span><span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">v</span><span class="c">ol_ino);</span>
<span class="w">volume_failed</span><span class="pc">:</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$V</span><span class="c">olume</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">iput_lcnbmp_err_out</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">m</span> <span class="pc">=</span> <span class="w">map_mft_record</span><span class="c">(</span><span class="w">NTFS_I</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="pc">v</span><span class="c">ol_ino</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="w">m</span><span class="pc">)) </span><span class="c">{</span>
<span class="w">iput_volume_failed:</span>
		<span class="w">i</span><span class="pc">p</span><span class="c">ut(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">v</span><span class="c">ol_ino);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">volume_failed</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="pc">(!(</span><span class="w">c</span><span class="pc">t</span><span class="c">x</span> <span class="pc">=</span> <span class="w">ntfs_attr_get_search_ctx</span><span class="c">(</span><span class="w">N</span><span class="c">TFS_I</span><span class="w">(vo</span><span class="pc">l-</span><span class="c">&gt;vol_ino</span><span class="pc">),</span> <span class="w">m))</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">g</span><span class="c">et</span> <span class="w">at</span><span class="pc">t</span><span class="c">ribute</span> <span class="w">search</span> <span class="w">con</span><span class="pc">te</span><span class="c">xt</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">get_ctx_vol_failed</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">ntfs_attr_lookup</span><span class="c">(</span><span class="w">AT_VOLUME_INFORMATION</span><span class="c">,</span> <span class="w">N</span><span class="pc">U</span><span class="c">LL,</span> <span class="c">0</span><span class="pc">,</span> <span class="c">0,</span> <span class="c">0,</span> <span class="pc">N</span><span class="c">ULL,</span> <span class="pc">0</span><span class="c">,</span>
			<span class="w">ct</span><span class="pc">x</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span> <span class="w">ct</span><span class="c">x-&gt;</span><span class="w">a</span><span class="pc">ttr-</span><span class="c">&gt;</span><span class="w">non_resident</span> <span class="w">|</span><span class="c">|</span> <span class="pc">c</span><span class="c">tx-&gt;</span><span class="w">a</span><span class="pc">t</span><span class="c">tr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="c">lags</span><span class="pc">) </span><span class="c">{</span>
<span class="w">err_put_vol:</span>
		<span class="w">ntfs_attr_put_search_ctx</span><span class="c">(ctx</span><span class="pc">)</span><span class="c">;</span>
<span class="w">get_ctx_vol_failed</span><span class="pc">:</span>
		<span class="w">unmap_mft_record</span><span class="c">(</span><span class="w">NTFS_I</span><span class="pc">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">vol_ino</span><span class="pc">))</span><span class="c">;</span>
		<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">iput_volume_failed</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">vi</span> <span class="w">=</span><span class="pc"> (</span><span class="w">VOLUME_INFORMATION*)((c</span><span class="pc">h</span><span class="c">ar*)</span><span class="pc">c</span><span class="c">tx-&gt;</span><span class="w">a</span><span class="c">ttr</span> <span class="w">+</span>
			<span class="w">le</span><span class="pc">1</span><span class="c">6_to_cpu(</span><span class="pc">c</span><span class="c">tx-&gt;</span><span class="w">a</span><span class="c">ttr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="pc">.</span><span class="w">resident.value_offset))</span><span class="pc">;</span>
	
	<span class="c">if</span> <span class="pc">((</span><span class="w">u8</span><span class="c">*)</span><span class="w">v</span><span class="pc">i</span> <span class="w">&lt; </span><span class="c">(</span><span class="w">u</span><span class="c">8*)</span><span class="w">c</span><span class="c">tx-&gt;</span><span class="w">at</span><span class="c">tr</span> <span class="w">|</span><span class="pc">| </span><span class="c">(</span><span class="w">u</span><span class="pc">8*</span><span class="c">)vi</span> <span class="pc">+</span>
			<span class="w">le</span><span class="pc">3</span><span class="c">2_to_cpu(</span><span class="pc">c</span><span class="c">tx-&gt;</span><span class="w">a</span><span class="pc">t</span><span class="c">tr</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">da</span><span class="c">ta.</span><span class="pc">r</span><span class="c">esident</span><span class="w">.value_length) &gt;</span>
			<span class="pc">(</span><span class="w">u</span><span class="pc">8*</span><span class="c">)</span><span class="w">c</span><span class="c">tx-&gt;</span><span class="w">at</span><span class="c">tr</span> <span class="pc">+</span> <span class="w">l</span><span class="pc">e3</span><span class="c">2_to_cpu(ctx-&gt;</span><span class="w">a</span><span class="pc">ttr-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">eng</span><span class="c">th</span><span class="w">)</span><span class="pc">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">err_put_vol</span><span class="c">;</span>
	
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">vol_flags</span> <span class="c">=</span> <span class="pc">v</span><span class="c">i-&gt;</span><span class="w">f</span><span class="c">lags;</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">major_ver</span> <span class="c">=</span> <span class="pc">v</span><span class="c">i-&gt;major_ver;</span>
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">minor_ver</span> <span class="c">=</span> <span class="c">vi-&gt;minor_ver;</span>
	<span class="w">ntfs_attr_put_search_ctx</span><span class="c">(</span><span class="w">c</span><span class="c">tx</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">unmap_mft_record</span><span class="c">(</span><span class="w">NTFS_I</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">vol_ino</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">p</span><span class="pc">r_i</span><span class="c">nfo("</span><span class="w">volume</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="c">%</span><span class="w">i.</span><span class="pc">%</span><span class="w">i.</span><span class="c">\n",</span> <span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">ma</span><span class="c">jor_ver</span><span class="pc">,</span>
			<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;minor_ver);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">ajor_ver</span> <span class="w">&lt;</span> <span class="w">3</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">NVolSparseEnabled</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">sb,</span><span class="pc"> "</span><span class="w">Disabling</span> <span class="w">sparse</span> <span class="w">s</span><span class="pc">u</span><span class="c">pport</span> <span class="w">due</span> <span class="w">t</span><span class="c">o</span> <span class="w">NTFS</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">volume</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="c">%</span><span class="w">i.</span><span class="pc">%</span><span class="w">i</span> <span class="w">(need</span> <span class="w">a</span><span class="pc">t</span> <span class="w">least</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">3.0).",</span> <span class="w">vo</span><span class="pc">l</span><span class="w">-</span><span class="c">&gt;</span><span class="w">major_ver,</span> <span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">minor_ver</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">NVolClearSparseEnabled</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">NTFS_RW</span>
	
	<span class="pc">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">vol_flags</span> <span class="w">&amp;</span> <span class="w">VOLUME_MUST_MOUNT_RO_MASK</span><span class="c">) {</span>
		<span class="w">sta</span><span class="pc">ti</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1a</span> <span class="w">=</span><span class="pc"> "</span><span class="w">V</span><span class="pc">o</span><span class="c">lume</span> <span class="w">i</span><span class="pc">s</span> <span class="w">dir</span><span class="pc">t</span><span class="c">y</span><span class="w">"</span><span class="pc">;</span>
		<span class="w">s</span><span class="c">tatic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1b</span> <span class="w">=</span><span class="pc"> "</span><span class="w">V</span><span class="pc">o</span><span class="c">lume</span> <span class="w">h</span><span class="pc">a</span><span class="c">s</span> <span class="w">been</span> <span class="w">modified</span> <span class="w">b</span><span class="pc">y</span> <span class="w">chkdsk</span><span class="pc">";</span>
		<span class="pc">s</span><span class="c">tatic</span> <span class="c">const</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1c</span> <span class="w">=</span><span class="pc"> </span><span class="c">"</span><span class="w">V</span><span class="pc">o</span><span class="c">lume</span> <span class="w">h</span><span class="pc">a</span><span class="c">s</span> <span class="w">unsupported</span> <span class="w">fl</span><span class="pc">ag</span><span class="c">s</span> <span class="w">se</span><span class="pc">t</span><span class="w">"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">const</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es2a</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">c</span><span class="pc">hk</span><span class="c">dsk</span> <span class="w">an</span><span class="c">d</span> <span class="w">mount</span> <span class="w">i</span><span class="c">n</span> <span class="w">Windows.";</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">atic</span> <span class="c">const</span> <span class="c">char</span> <span class="c">*</span><span class="w">es2b</span> <span class="w">= "</span><span class="pc">.</span>  <span class="w">Mount</span> <span class="w">i</span><span class="pc">n</span> <span class="w">W</span><span class="c">indows</span><span class="w">.</span><span class="pc">"</span><span class="c">;</span>
		<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*</span><span class="w">es1</span><span class="pc">, </span><span class="c">*</span><span class="w">es2</span><span class="c">;</span>

		<span class="w">e</span><span class="pc">s2</span> <span class="c">=</span> <span class="pc">es2a</span><span class="w">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">vol_flags</span> <span class="w">&amp;</span> <span class="w">VOLUME_IS_DIRTY</span><span class="c">)</span>
			<span class="pc">es1</span> <span class="c">=</span> <span class="w">es1a</span><span class="c">;</span>
		<span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;vol_flags</span> <span class="w">&amp;</span> <span class="w">VOLUME_MODIFIED_BY_CHKDSK</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">e</span><span class="c">s1</span> <span class="c">=</span> <span class="w">es1b</span><span class="pc">;</span>
			<span class="w">e</span><span class="pc">s2</span> <span class="pc">=</span> <span class="w">es2b</span><span class="pc">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">es1</span> <span class="c">=</span> <span class="w">es1c</span><span class="c">;</span>
			<span class="w">ntfs_warning</span><span class="pc">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">Unsupported</span> <span class="w">volume</span> <span class="w">fl</span><span class="c">ags</span> <span class="w">0</span><span class="c">x%x</span> <span class="w">"</span>
					<span class="pc">"</span><span class="w">encountered.",</span>
					<span class="w">(u</span><span class="pc">n</span><span class="c">signed</span><span class="pc">)</span><span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">v</span><span class="c">ol_flags</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
					<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">)))</span><span class="c"> {</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n_</span><span class="c">errors</span><span class="w">="</span>
						<span class="pc">"</span><span class="w">cont</span><span class="pc">i</span><span class="c">nue</span> <span class="w">nor</span> <span class="w">on</span><span class="pc">_</span><span class="c">errors</span><span class="w">=</span><span class="pc">"</span>
						<span class="pc">"</span><span class="w">remount-ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="pc">s"</span><span class="c">,</span>
						<span class="w">es1</span><span class="pc">,</span> <span class="w">es2</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">iput_vol_err_out</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
			<span class="w">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y%</span><span class="pc">s"</span><span class="c">,</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb, "</span><span class="pc">%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Will</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">b</span><span class="c">e</span> <span class="w">able</span> <span class="w">t</span><span class="c">o</span> <span class="w">remount</span> <span class="pc">"</span>
					<span class="w">"rea</span><span class="pc">d</span><span class="w">-w</span><span class="c">rite</span><span class="pc">%s",</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		
	<span class="pc">}</span>
	
	<span class="w">rp</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">load_and_check_logfile</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">rp) |</span><span class="c">|</span>
			<span class="pc">!</span><span class="w">ntfs_is_logfile_clean</span><span class="c">(</span><span class="w">vo</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">logfile_ino</span><span class="c">,</span> <span class="w">rp</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">sta</span><span class="pc">ti</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1a</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="pc">t</span><span class="c">o</span> <span class="w">load</span> <span class="w">$LogFile</span><span class="pc">";</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1b</span> <span class="w">= "$L</span><span class="c">ogFile</span> <span class="w">is</span> <span class="w">n</span><span class="c">ot</span> <span class="w">clean</span><span class="pc">";</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*</span><span class="w">es2</span> <span class="w">= ".</span>  <span class="w">Mount</span> <span class="w">i</span><span class="pc">n</span> <span class="w">Windows.";</span>
		<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*</span><span class="w">es1</span><span class="pc">;</span>

		<span class="w">e</span><span class="c">s1</span> <span class="w">= !vo</span><span class="pc">l</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">logfile_ino</span> <span class="w">?</span> <span class="w">es</span><span class="pc">1a</span> <span class="c">:</span> <span class="w">e</span><span class="pc">s1b</span><span class="w">;</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="pc">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
					<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">))) </span><span class="c">{</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n_</span><span class="c">errors</span><span class="w">="</span>
						<span class="pc">"</span><span class="w">con</span><span class="pc">ti</span><span class="c">nue</span> <span class="w">nor</span> <span class="w">on</span><span class="pc">_</span><span class="c">errors</span><span class="w">=</span><span class="pc">"</span>
						<span class="pc">"</span><span class="w">remount-ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span>
						<span class="w">es1</span><span class="pc">,</span> <span class="w">es2</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">logfile_ino</span><span class="pc">) </span><span class="c">{</span>
					<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">rp</span><span class="pc">)</span><span class="c">;</span>
					<span class="w">ntfs_free</span><span class="c">(</span><span class="w">rp</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">}</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">iput_logfile_err_out</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y%</span><span class="pc">s"</span><span class="c">,</span> <span class="w">es1</span><span class="c">,</span> <span class="w">es2</span><span class="c">);</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb, "</span><span class="pc">%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Will</span> <span class="w">n</span><span class="c">ot</span> <span class="w">b</span><span class="c">e</span> <span class="w">able</span> <span class="w">t</span><span class="c">o</span> <span class="w">remount</span> <span class="pc">"</span>
					<span class="w">"rea</span><span class="pc">d</span><span class="w">-w</span><span class="c">rite</span><span class="pc">%s",</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">ntfs_free</span><span class="c">(</span><span class="w">rp</span><span class="c">);</span>
<span class="w">#</span><span class="c">endif</span> 
	
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">root_ino</span> <span class="c">=</span> <span class="w">ntfs_iget</span><span class="pc">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_root</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;root_ino</span><span class="w">) |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">oot_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="pc">S_ER</span><span class="c">R(</span><span class="w">v</span><span class="c">ol-&gt;root_ino))</span>
			<span class="w">iput</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">r</span><span class="c">oot_ino);</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "Fa</span><span class="c">iled</span> <span class="c">to</span> <span class="w">load</span> <span class="w">ro</span><span class="pc">ot</span> <span class="w">directory.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">iput_logfile_err_out</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
	
	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">check_windows_hibernation_status</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="c">nlikely(err</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">sta</span><span class="pc">ti</span><span class="c">c</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1a</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">determine</span> <span class="w">if</span> <span class="w">Windows</span> <span class="w">is</span> <span class="c">"</span>
				<span class="c">"</span><span class="w">hibernated"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1b</span> <span class="w">=</span><span class="pc"> </span><span class="c">"</span><span class="w">W</span><span class="c">indows</span> <span class="w">is</span> <span class="w">h</span><span class="pc">i</span><span class="c">bernated</span><span class="w">"</span><span class="pc">;</span>
		<span class="pc">s</span><span class="c">tatic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es2</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">chkdsk.";</span>
		<span class="w">co</span><span class="pc">ns</span><span class="c">t</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1</span><span class="pc">;</span>

		<span class="w">e</span><span class="pc">s1</span> <span class="c">=</span> <span class="w">er</span><span class="pc">r</span> <span class="w">&lt;</span> <span class="c">0</span> <span class="pc">?</span> <span class="w">es1a</span> <span class="c">:</span> <span class="pc">es1b</span><span class="c">;</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
					<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">))) </span><span class="c">{</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n_</span><span class="c">errors</span><span class="w">="</span>
						<span class="pc">"</span><span class="w">con</span><span class="pc">ti</span><span class="c">nue</span> <span class="w">nor</span> <span class="w">on</span><span class="pc">_</span><span class="c">errors</span><span class="w">=</span><span class="pc">"</span>
						<span class="pc">"</span><span class="w">remount-ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span>
						<span class="w">es1</span><span class="pc">,</span> <span class="w">es2</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">iput_root_err_out</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
			<span class="w">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y%</span><span class="pc">s"</span><span class="c">,</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb, "</span><span class="pc">%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Will</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">b</span><span class="c">e</span> <span class="w">able</span> <span class="w">t</span><span class="c">o</span> <span class="w">remount</span> <span class="pc">"</span>
					<span class="w">"rea</span><span class="pc">d</span><span class="w">-w</span><span class="c">rite</span><span class="pc">%s",</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">) </span><span class="c">&amp;&amp;</span>
			<span class="w">ntfs_set_volume_flags</span><span class="c">(</span><span class="w">v</span><span class="c">ol,</span> <span class="w">VOLUME_IS_DIRTY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">sta</span><span class="pc">ti</span><span class="c">c</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="pc">e</span><span class="c">s1</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="w">t</span><span class="c">o</span> <span class="w">s</span><span class="pc">e</span><span class="c">t</span> <span class="w">dir</span><span class="pc">t</span><span class="c">y</span> <span class="w">bi</span><span class="c">t</span> <span class="w">i</span><span class="c">n</span> <span class="w">volume</span> <span class="w">"</span>
				<span class="c">"</span><span class="w">information</span> <span class="w">fl</span><span class="pc">ags</span><span class="w">"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es2</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">chkdsk.";</span>

		
		<span class="w">i</span><span class="pc">f</span> <span class="w">(!</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
				<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">))) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=cont</span><span class="pc">i</span><span class="c">nue</span> <span class="w">nor</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=remount</span><span class="pc">-</span><span class="w">ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="c">s",</span>
					<span class="w">es1</span><span class="pc">,</span> <span class="w">e</span><span class="c">s2</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">iput_root_err_out</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">n</span><span class="pc">t</span><span class="c">fs_error</span><span class="w">(sb, </span><span class="pc">"%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="pc">%s"</span><span class="c">,</span> <span class="w">e</span><span class="c">s1,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
		
	<span class="pc">}</span>
<span class="w">#</span><span class="pc">if</span> <span class="w">0</span>
	<span class="w">/</span><span class="c">/</span> <span class="w">TODO:</span> <span class="w">Enable</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">cod</span><span class="c">e</span> <span class="w">once</span> <span class="w">we</span> <span class="w">sta</span><span class="pc">r</span><span class="c">t</span> <span class="w">modifying</span> <span class="w">anything</span> <span class="w">that</span> <span class="w">i</span><span class="c">s</span>
	<span class="w">/</span><span class="pc">/</span>	 <span class="w">different</span> <span class="w">between</span> <span class="w">NTFS</span> <span class="w">1.2</span> <span class="w">a</span><span class="pc">nd</span> <span class="w">3</span><span class="pc">.</span><span class="w">x...</span>
	
	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">_flags</span> <span class="pc">&amp;</span> <span class="pc">M</span><span class="c">S_RDONLY</span><span class="w">) </span><span class="pc">&amp;&amp; </span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">major_ver</span> <span class="pc">&gt;</span> <span class="pc">1) </span><span class="c">&amp;&amp;</span>
			<span class="w">ntfs_set_volume_flags</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">,</span> <span class="w">VOLUME_MOUNTED_ON_NT4)</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">stat</span><span class="pc">i</span><span class="c">c</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">s</span><span class="c">et</span> <span class="w">NT4</span> <span class="w">compatibility</span> <span class="w">fl</span><span class="pc">ag</span><span class="w">"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es2</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">chkdsk.";</span>

		
		<span class="w">i</span><span class="pc">f</span> <span class="w">(!</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
				<span class="w">ON_ERRORS_CONTINUE))</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=cont</span><span class="pc">i</span><span class="c">nue</span> <span class="w">nor</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=remount</span><span class="pc">-</span><span class="w">ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="c">s",</span>
					<span class="w">es1</span><span class="pc">,</span> <span class="w">e</span><span class="c">s2</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">iput_root_err_out</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">n</span><span class="pc">t</span><span class="c">fs_error</span><span class="w">(sb, </span><span class="pc">"%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="pc">%s"</span><span class="c">,</span> <span class="w">e</span><span class="c">s1,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">_flags</span> <span class="c">&amp;</span> <span class="pc">M</span><span class="c">S_RDONLY</span><span class="pc">) </span><span class="c">&amp;&amp;</span>
			<span class="pc">!</span><span class="w">ntfs_empty_logfile</span><span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">logfile_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">sta</span><span class="pc">ti</span><span class="c">c</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">e</span><span class="pc">s1</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="pc">t</span><span class="c">o</span> <span class="w">em</span><span class="c">pty</span> <span class="w">$LogFile"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es2</span> <span class="w">= ".</span>  <span class="w">Mount</span> <span class="w">i</span><span class="c">n</span> <span class="w">Windows.";</span>

		
		<span class="w">i</span><span class="c">f</span> <span class="w">(</span><span class="pc">!(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
				<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">))) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n_</span><span class="c">errors</span><span class="w">=cont</span><span class="pc">i</span><span class="c">nue</span> <span class="w">nor</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=remount</span><span class="pc">-</span><span class="w">ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="pc">s</span><span class="c">",</span>
					<span class="w">es1</span><span class="pc">,</span> <span class="w">es2</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">iput_root_err_out</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">n</span><span class="pc">t</span><span class="c">fs_error</span><span class="w">(sb, </span><span class="pc">"%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="pc">%s"</span><span class="c">,</span> <span class="w">e</span><span class="c">s1,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="c">nlikely(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">major_ver</span> <span class="w">&lt;</span> <span class="w">3</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
	
	
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">secure_ino</span> <span class="c">=</span> <span class="w">ntfs_iget</span><span class="pc">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_Secure</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;secure_ino</span><span class="w">) |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;secure_ino</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">v</span><span class="c">ol-&gt;secure_ino))</span>
			<span class="w">iput</span><span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">s</span><span class="c">ecure_ino);</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "Fa</span><span class="c">iled</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$Secure.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">iput_root_err_out</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">/</span><span class="c">/</span> <span class="w">TODO</span><span class="c">:</span> <span class="w">Initialize</span> <span class="w">security.</span>
	
	<span class="w">vo</span><span class="c">l</span><span class="w">-</span><span class="c">&gt;</span><span class="w">extend_ino</span> <span class="pc">=</span> <span class="w">ntfs_iget</span><span class="pc">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">FILE_Extend</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;extend_ino</span><span class="w">) |</span><span class="c">|</span> <span class="w">is_bad_inode</span><span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="pc">e</span><span class="c">xtend_ino</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="pc">S</span><span class="c">_ERR(</span><span class="w">v</span><span class="c">ol-&gt;extend_ino))</span>
			<span class="w">iput</span><span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">e</span><span class="c">xtend_ino);</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "Fa</span><span class="c">iled</span> <span class="c">to</span> <span class="w">load</span> <span class="w">$Extend.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">iput_sec_err_out</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">load_and_init_quota</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">) {</span>
		<span class="w">st</span><span class="pc">ati</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es1</span> <span class="w">=</span><span class="pc"> </span><span class="c">"</span><span class="w">F</span><span class="c">ailed</span> <span class="pc">t</span><span class="c">o</span> <span class="pc">l</span><span class="c">oad</span> <span class="w">$Quota"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">es2</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">chkdsk.";</span>

		
		<span class="w">i</span><span class="pc">f</span> <span class="w">(</span><span class="pc">!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="pc">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
					<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">))) </span><span class="c">{</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n_</span><span class="c">errors</span><span class="w">="</span>
						<span class="w">"con</span><span class="pc">ti</span><span class="c">nue</span> <span class="w">nor</span> <span class="w">on</span><span class="pc">_</span><span class="c">errors</span><span class="w">="</span>
						<span class="pc">"</span><span class="w">remount-ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="pc">s"</span><span class="c">,</span>
						<span class="w">es1</span><span class="pc">,</span> <span class="w">es2</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">iput_quota_err_out</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
			<span class="w">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y%</span><span class="pc">s"</span><span class="c">,</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb, "</span><span class="pc">%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Will</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">b</span><span class="c">e</span> <span class="w">able</span> <span class="w">t</span><span class="c">o</span> <span class="w">remount</span> <span class="pc">"</span>
					<span class="w">"rea</span><span class="pc">d</span><span class="w">-w</span><span class="c">rite</span><span class="pc">%s",</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">) </span><span class="c">&amp;&amp;</span>
			<span class="pc">!</span><span class="w">ntfs_mark_quotas_out_of_date</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">) {</span>
		<span class="w">sta</span><span class="pc">ti</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">e</span><span class="pc">s1</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="pc">t</span><span class="c">o</span> <span class="w">mark</span> <span class="w">quotas</span> <span class="w">o</span><span class="pc">u</span><span class="c">t</span> <span class="w">o</span><span class="c">f</span> <span class="w">date"</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">atic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="pc">e</span><span class="c">s2</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">chkdsk.";</span>

		
		<span class="w">i</span><span class="pc">f</span> <span class="w">(!</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
				<span class="w">ON_ERRORS_CONTINUE))</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=cont</span><span class="pc">i</span><span class="c">nue</span> <span class="w">nor</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=remount</span><span class="pc">-</span><span class="w">ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="c">s",</span>
					<span class="w">es1</span><span class="pc">,</span> <span class="w">e</span><span class="c">s2</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">iput_quota_err_out</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">n</span><span class="pc">t</span><span class="c">fs_error</span><span class="w">(sb, </span><span class="pc">"%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="pc">%s"</span><span class="c">,</span> <span class="w">e</span><span class="c">s1,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">load_and_init_usnjrnl</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">)) {</span>
		<span class="w">st</span><span class="pc">ati</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">e</span><span class="c">s1</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="pc">t</span><span class="c">o</span> <span class="w">load</span> <span class="w">$UsnJrnl"</span><span class="pc">;</span>
		<span class="w">s</span><span class="c">tatic</span> <span class="c">const</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">e</span><span class="pc">s2</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">chkdsk.";</span>

		
		<span class="w">i</span><span class="pc">f</span> <span class="w">(</span><span class="pc">!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">_flags</span> <span class="pc">&amp;</span> <span class="w">M</span><span class="c">S_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
					<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">))) </span><span class="c">{</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n_</span><span class="c">errors</span><span class="w">="</span>
						<span class="w">"con</span><span class="pc">ti</span><span class="c">nue</span> <span class="w">nor</span> <span class="w">on</span><span class="pc">_</span><span class="c">errors</span><span class="w">="</span>
						<span class="pc">"</span><span class="w">remount-ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="pc">s"</span><span class="c">,</span>
						<span class="w">es1</span><span class="pc">,</span> <span class="w">es2</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">iput_usnjrnl_err_out</span><span class="c">;</span>
			<span class="c">}</span>
			<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
			<span class="w">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y%</span><span class="pc">s"</span><span class="c">,</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb, "</span><span class="pc">%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Will</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">b</span><span class="c">e</span> <span class="w">able</span> <span class="w">t</span><span class="c">o</span> <span class="w">remount</span> <span class="pc">"</span>
					<span class="w">"rea</span><span class="pc">d</span><span class="w">-w</span><span class="c">rite</span><span class="pc">%s",</span> <span class="c">es1</span><span class="pc">,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY) &amp;</span><span class="pc">&amp; !</span><span class="w">ntfs_stamp_usnjrnl</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">st</span><span class="pc">a</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*</span><span class="pc">e</span><span class="c">s1</span> <span class="w">=</span><span class="pc"> "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">stamp</span> <span class="w">transaction</span> <span class="w">lo</span><span class="c">g</span> <span class="pc">"</span>
				<span class="w">"($UsnJrnl)";</span>
		<span class="w">s</span><span class="pc">tat</span><span class="c">ic</span> <span class="c">const</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="pc">e</span><span class="c">s2</span> <span class="w">= ".</span>  <span class="w">Run</span> <span class="w">chkdsk.";</span>

		
		<span class="w">i</span><span class="c">f</span> <span class="w">(!</span><span class="pc">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">on_errors</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">ON_ERRORS_REMOUNT_RO</span> <span class="c">|</span>
				<span class="w">ON_ERRORS_CONTINUE</span><span class="pc">))) </span><span class="c">{</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">neither</span> <span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=cont</span><span class="pc">i</span><span class="c">nue</span> <span class="w">nor</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">o</span><span class="pc">n</span><span class="c">_errors</span><span class="w">=remount</span><span class="pc">-</span><span class="w">ro</span> <span class="w">was</span> <span class="w">specified%</span><span class="c">s",</span>
					<span class="w">es1</span><span class="pc">,</span> <span class="w">e</span><span class="c">s2</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">iput_usnjrnl_err_out</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">n</span><span class="pc">t</span><span class="c">fs_error</span><span class="w">(sb, </span><span class="pc">"%</span><span class="c">s</span><span class="w">.</span>  <span class="w">Mounting</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="pc">%s"</span><span class="c">,</span> <span class="w">e</span><span class="c">s1,</span> <span class="c">es2</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
		<span class="w">NVolSetErrors</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">rue;</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
<span class="w">i</span><span class="pc">p</span><span class="c">ut_usnjrnl_err_out</span><span class="w">:</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">usnjrnl_j_ino</span><span class="c">)</span>
		<span class="w">iput</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;usnjrnl_j_ino);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">usnjrnl_max_ino</span><span class="c">)</span>
		<span class="c">iput(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;usnjrnl_max_ino);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">usnjrnl_ino</span><span class="c">)</span>
		<span class="pc">i</span><span class="c">put(</span><span class="w">v</span><span class="c">ol-&gt;usnjrnl_ino);</span>
<span class="w">iput_quota_err_out</span><span class="pc">:</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">quota_q_ino</span><span class="c">)</span>
		<span class="c">iput</span><span class="pc">(v</span><span class="c">ol-&gt;quota_q_ino);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">quota_ino</span><span class="c">)</span>
		<span class="c">iput</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;quota_ino);</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">extend_ino</span><span class="c">);</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span> 
<span class="w">iput_sec_err_out</span><span class="pc">:</span>
	<span class="w">i</span><span class="pc">put</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">secure_ino</span><span class="c">);</span>
<span class="w">iput_root_err_out</span><span class="pc">:</span>
	<span class="pc">ip</span><span class="c">ut(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">root_ino</span><span class="c">);</span>
<span class="w">iput_logfile_err_out</span><span class="pc">:</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">logfile_ino</span><span class="pc">)</span>
		<span class="w">i</span><span class="pc">put(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;logfile_ino);</span>
<span class="w">iput_vol_err_out:</span>
<span class="w">#</span><span class="c">endif</span> 
	<span class="w">i</span><span class="pc">put(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">vol_ino</span><span class="c">);</span>
<span class="w">iput_lcnbmp_err_out</span><span class="pc">:</span>
	<span class="pc">i</span><span class="c">put(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">lcnbmp_ino</span><span class="c">);</span>
<span class="w">iput_attrdef_err_out</span><span class="pc">:</span>
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">attrdef_size</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">attrdef</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;attrdef);</span>
		<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;attrdef</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
<span class="w">iput_upcase_err_out:</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span> 
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">upcase_len</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">mu</span><span class="pc">tex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">upcase</span> <span class="pc">=</span><span class="c">=</span> <span class="w">default_upcase</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_nr_upcase_users-</span><span class="pc">-</span><span class="c">;</span>
		<span class="w">v</span><span class="c">ol-&gt;upcase</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;ntfs_lock);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;upcase) {</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;upcase</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">u</span><span class="c">pcase</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>
<span class="w">iput_mftbmp_err_out:</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mftbmp_ino</span><span class="c">);</span>
<span class="w">iput_mirr_err_out</span><span class="pc">:</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">mftmirr_ino</span><span class="pc">)</span>
		<span class="w">i</span><span class="pc">put</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;mftmirr_ino);</span>
<span class="w">#</span><span class="c">endif</span> 
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">ntfs_put_super</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="pc">s</span><span class="c">b)</span>
<span class="c">{</span>
	<span class="w">ntfs_volume</span> <span class="pc">*</span><span class="w">vo</span><span class="c">l</span> <span class="c">=</span> <span class="w">NTFS_SB</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
	
	<span class="w">ntfs_commit_inode</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">vol_ino</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">major_ver</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">3</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">usnjrnl_j_ino</span><span class="pc">)</span>
			<span class="w">n</span><span class="pc">tfs_c</span><span class="c">ommit_inode(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">u</span><span class="c">snjrnl_j_ino);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">usnjrnl_max_ino</span><span class="c">)</span>
			<span class="w">n</span><span class="pc">tfs_c</span><span class="c">ommit_inode(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;usnjrnl_max_ino);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">usnjrnl_ino</span><span class="c">)</span>
			<span class="pc">n</span><span class="c">tfs_commit_inode(</span><span class="pc">v</span><span class="c">ol-&gt;usnjrnl_ino);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">quota_q_ino</span><span class="c">)</span>
			<span class="c">ntfs_commit_inode(</span><span class="pc">v</span><span class="c">ol-&gt;quota_q_ino);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">quota_ino</span><span class="c">)</span>
			<span class="c">ntfs_commit_inode(</span><span class="pc">v</span><span class="c">ol-&gt;quota_ino);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">extend_ino</span><span class="c">)</span>
			<span class="c">ntfs_commit_inode(</span><span class="pc">v</span><span class="c">ol-&gt;extend_ino);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">secure_ino</span><span class="c">)</span>
			<span class="c">ntfs_commit_inode(</span><span class="pc">v</span><span class="c">ol-&gt;secure_ino);</span>
	<span class="c">}</span>

	<span class="w">n</span><span class="c">tfs_commit_inode</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">root_ino</span><span class="c">);</span>

	<span class="w">down_write</span><span class="pc">(&amp;</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">lcnbmp_lock</span><span class="c">);</span>
	<span class="w">n</span><span class="c">tfs_commit_inode</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">lcnbmp_ino</span><span class="c">);</span>
	<span class="w">up_write</span><span class="pc">(&amp;</span><span class="w">v</span><span class="c">ol-&gt;lcnbmp_lock);</span>

	<span class="w">d</span><span class="pc">o</span><span class="c">wn_write</span><span class="pc">(&amp;</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mftbmp_lock</span><span class="c">);</span>
	<span class="w">n</span><span class="c">tfs_commit_inode</span><span class="pc">(v</span><span class="c">ol-&gt;</span><span class="w">mftbmp_ino</span><span class="c">);</span>
	<span class="w">u</span><span class="c">p_write</span><span class="pc">(&amp;</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mftbmp_l</span><span class="c">ock);</span>

	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">logfile_ino</span><span class="c">)</span>
		<span class="c">ntfs_commit_inode(</span><span class="pc">v</span><span class="c">ol-&gt;logfile_ino);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">v</span><span class="c">ol-&gt;</span><span class="w">mftmirr_ino</span><span class="c">)</span>
		<span class="w">n</span><span class="c">tfs_commit_inode(</span><span class="pc">v</span><span class="c">ol-&gt;mftmirr_ino);</span>
	<span class="pc">n</span><span class="c">tfs_commit_inode(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">mft_ino</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">NVolErrors</span><span class="c">(</span><span class="w">v</span><span class="c">ol</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">ntfs_clear_volume_flags</span><span class="c">(</span><span class="w">v</span><span class="c">ol,</span> <span class="w">VOLUME_IS_DIRTY</span><span class="c">))</span>
				<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">cl</span><span class="pc">e</span><span class="c">ar</span> <span class="w">di</span><span class="pc">rt</span><span class="c">y</span> <span class="w">bi</span><span class="c">t</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">i</span><span class="pc">n</span> <span class="w">volume</span> <span class="w">information</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">fl</span><span class="pc">ags</span><span class="w">.</span>  <span class="w">Run</span> <span class="w">chkdsk.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">ntfs_commit_inode</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">vol_ino</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">n</span><span class="c">tfs_commit_inode(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">root_ino</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">mftmirr_ino</span><span class="c">)</span>
				<span class="pc">n</span><span class="c">tfs_commit_inode(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;mftmirr_ino);</span>
			<span class="w">n</span><span class="c">tfs_commit_inode(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">mft_ino</span><span class="c">);</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
			<span class="w">ntfs_warning</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">V</span><span class="c">olume</span> <span class="w">h</span><span class="pc">a</span><span class="c">s</span> <span class="w">errors.</span>  <span class="w">Leaving</span> <span class="w">volume</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">marked</span> <span class="w">di</span><span class="pc">r</span><span class="c">ty</span><span class="w">.</span>  <span class="w">Run</span> <span class="w">chkdsk.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
<span class="pc">#e</span><span class="c">ndif</span> 

	<span class="w">iput</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">vol_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="pc">v</span><span class="c">ol_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	
	<span class="pc">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">major_ver</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">3</span><span class="pc">) </span><span class="c">{</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">usnjrnl_j_ino</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">ip</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;usnjrnl_j_ino</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;usnjrnl_j_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">usnjrnl_max_ino</span><span class="c">) {</span>
			<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;usnjrnl_max_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;usnjrnl_max_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">usnjrnl_ino</span><span class="c">) {</span>
			<span class="c">iput</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;usnjrnl_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;usnjrnl_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">quota_q_ino</span><span class="c">) {</span>
			<span class="c">iput</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;quota_q_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;quota_q_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">quota_ino</span><span class="c">) {</span>
			<span class="c">iput</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;quota_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;quota_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">extend_ino</span><span class="c">) {</span>
			<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;extend_ino</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">v</span><span class="c">ol-&gt;extend_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">secure_ino</span><span class="c">) {</span>
			<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;secure_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;secure_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">root_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">v</span><span class="c">ol-&gt;root_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">down_write</span><span class="pc">(&amp;</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">lcnbmp_lock</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">lcnbmp_ino</span><span class="c">);</span>
	<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">lcnbmp_i</span><span class="c">no</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">up_write</span><span class="pc">(&amp;v</span><span class="c">ol-&gt;lcnbmp_lock);</span>

	<span class="w">d</span><span class="pc">o</span><span class="c">wn_write(&amp;</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">mftbmp_lock</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(v</span><span class="c">ol-&gt;</span><span class="w">mftbmp_ino</span><span class="c">);</span>
	<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mftbmp_i</span><span class="c">no</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="w">u</span><span class="pc">p</span><span class="c">_write</span><span class="pc">(&amp;</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mftbmp_l</span><span class="c">ock);</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">logfile_ino</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">p</span><span class="c">ut(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;logfile_ino);</span>
		<span class="w">v</span><span class="c">ol-&gt;logfile_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mftmirr_ino</span><span class="c">) {</span>
		
		<span class="w">ntfs_commit_inode</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;mftmirr_ino);</span>
		<span class="w">n</span><span class="c">tfs_commit_inode</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mft_ino</span><span class="c">);</span>
		<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mftm</span><span class="c">irr_ino);</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mftm</span><span class="c">irr_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>
	
	<span class="w">n</span><span class="c">tfs_commit_inode</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">mft_</span><span class="c">ino);</span>
	<span class="w">write_inode_now</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;mft_ino</span><span class="pc">,</span> <span class="pc">1</span><span class="c">);</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span> 

	<span class="w">i</span><span class="pc">p</span><span class="c">ut(</span><span class="w">v</span><span class="c">ol-&gt;mft_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;mft_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	
	<span class="w">v</span><span class="c">ol-&gt;</span><span class="w">attrdef_size</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">v</span><span class="c">ol-&gt;</span><span class="w">attrdef</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;attrdef);</span>
		<span class="w">v</span><span class="c">ol-&gt;attrdef</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">upcase_len</span> <span class="c">=</span> <span class="c">0;</span>
	
	<span class="w">mu</span><span class="pc">tex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">upcase</span> <span class="pc">=</span><span class="c">=</span> <span class="w">default_upcase</span><span class="c">) {</span>
		<span class="w">ntfs_nr_upcase_users-</span><span class="pc">-</span><span class="c">;</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">u</span><span class="c">pcase</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">n</span><span class="pc">tfs_n</span><span class="c">r_upcase_users</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="pc">d</span><span class="c">efault_upcase</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="pc">d</span><span class="c">efault_upcase</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">d</span><span class="c">efault_upcase</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">cluster_size</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">4</span><span class="pc">0</span><span class="c">96</span> <span class="w">&amp;&amp; !--ntfs_nr_compression_users</span><span class="pc">)</span>
		<span class="w">free_compression_buffers</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">u</span><span class="c">pcase) {</span>
		<span class="w">n</span><span class="pc">tfs_f</span><span class="c">ree</span><span class="pc">(</span><span class="w">v</span><span class="pc">ol-</span><span class="c">&gt;upcase</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">v</span><span class="c">ol-&gt;upcase</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">}</span>

	<span class="w">unload_nls</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">nls_map</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_fs_info</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">v</span><span class="c">ol);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">s6</span><span class="c">4</span> <span class="w">get_nr_free_clusters</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">s6</span><span class="c">4</span> <span class="w">nr_free</span> <span class="pc">=</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="w">nr_clusters</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing</span> <span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">lcnbmp_ino-</span><span class="c">&gt;</span><span class="w">i_mapping</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="c">age</span> <span class="c">*page</span><span class="pc">;</span>
	<span class="w">pgoff_t</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">,</span> <span class="w">max_index</span><span class="c">;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">down_read</span><span class="pc">(&amp;</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">lcnbmp_lock</span><span class="c">);</span>
	
	<span class="w">m</span><span class="c">ax_index</span> <span class="w">= (((v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">n</span><span class="pc">r</span><span class="c">_clusters</span> <span class="w">+</span> <span class="w">7) &gt;</span><span class="c">&gt;</span> <span class="w">3) </span><span class="pc">+</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="pc">-</span> <span class="c">1</span><span class="w">) &gt;</span><span class="c">&gt;</span>
			<span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	
	<span class="pc">n</span><span class="c">tfs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">Reading</span> <span class="w">$Bitmap</span><span class="pc">,</span> <span class="c">max_index</span> <span class="w">=</span> <span class="pc">0x</span><span class="c">%</span><span class="w">l</span><span class="c">x,</span> <span class="w">max_size</span> <span class="c">=</span> <span class="c">0x%</span><span class="w">l</span><span class="c">x</span><span class="w">.",</span>
			<span class="w">m</span><span class="pc">ax_i</span><span class="c">ndex</span><span class="pc">,</span> <span class="pc">P</span><span class="c">AGE_CACHE_SIZE</span> <span class="w">/</span> <span class="w">4</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">&lt;</span> <span class="c">max_index;</span> <span class="pc">in</span><span class="c">dex++) {</span>
		<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">*kaddr</span><span class="c">;</span>

		
		<span class="w">pa</span><span class="c">ge</span> <span class="pc">=</span> <span class="w">read_mapping_page</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex,</span> <span class="w">N</span><span class="c">ULL);</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">p</span><span class="c">age</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">r</span><span class="c">ead_mapping_page</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="w">.</span> <span class="w">Skipping</span> <span class="w">"</span>
					<span class="w">"p</span><span class="c">age</span> <span class="w">(in</span><span class="pc">d</span><span class="c">ex</span> <span class="w">0</span><span class="c">x%</span><span class="w">l</span><span class="pc">x</span><span class="w">).",</span> <span class="w">ind</span><span class="c">ex</span><span class="w">)</span><span class="pc">;</span>
			<span class="w">nr_free</span> <span class="w">-</span><span class="pc">=</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="w">*</span> <span class="w">8</span><span class="c">;</span>
			<span class="w">c</span><span class="pc">on</span><span class="c">tinue;</span>
		<span class="c">}</span>
		<span class="w">kaddr</span> <span class="pc">=</span> <span class="w">kmap_atomic</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">n</span><span class="pc">r</span><span class="c">_free</span> <span class="w">-</span><span class="pc">=</span> <span class="w">bitmap_weight</span><span class="pc">(</span><span class="c">kaddr</span><span class="pc">,</span>
					<span class="w">P</span><span class="pc">AGE_C</span><span class="c">ACHE_SIZE</span> <span class="w">*</span> <span class="w">BITS_PER_BYTE</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">kunmap_atomic</span><span class="c">(kaddr);</span>
		<span class="w">page_cache_release</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>
	<span class="c">}</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Finished</span> <span class="w">reading</span> <span class="w">$Bitmap,</span> <span class="w">la</span><span class="c">st</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="w">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="c">x</span><span class="w">.",</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="w">-</span> <span class="pc">1)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">nr_clusters</span> <span class="w">&amp;</span> <span class="w">6</span><span class="pc">3</span><span class="c">)</span>
		<span class="w">nr_free</span> <span class="w">+</span><span class="pc">=</span> <span class="w">6</span><span class="c">4</span> <span class="w">-</span><span class="pc"> </span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;nr_clusters</span> <span class="pc">&amp;</span> <span class="w">6</span><span class="pc">3</span><span class="c">);</span>
	<span class="w">up_read</span><span class="pc">(&amp;</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">lcnbmp_lock</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">n</span><span class="c">r_free</span> <span class="w">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">n</span><span class="c">r_free</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Exiting.</span><span class="pc">"</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">n</span><span class="c">r_free;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">__get_nr_free_mft_records</span><span class="c">(</span><span class="w">ntfs_volume</span> <span class="c">*</span><span class="w">vo</span><span class="c">l,</span>
		<span class="w">s6</span><span class="c">4</span> <span class="pc">n</span><span class="c">r_free</span><span class="pc">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="w">pgoff_t</span> <span class="w">max_index</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">map</span><span class="pc">p</span><span class="c">ing</span> <span class="c">=</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">mftbmp_ino-</span><span class="pc">&gt;</span><span class="w">i_mapping</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*page</span><span class="pc">;</span>
	<span class="w">pg</span><span class="pc">o</span><span class="c">ff_t</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">n</span><span class="pc">tfs_d</span><span class="c">ebug</span><span class="w">("Reading</span> <span class="w">$MFT/$BITMAP</span><span class="pc">,</span> <span class="w">m</span><span class="pc">ax</span><span class="c">_index</span> <span class="w">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="c">x,</span> <span class="w">max_size</span> <span class="w">= </span><span class="pc">"</span>
			<span class="w">"0</span><span class="c">x%</span><span class="pc">l</span><span class="c">x</span><span class="w">.",</span> <span class="w">m</span><span class="pc">ax_i</span><span class="c">ndex</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="w">/</span> <span class="w">4)</span><span class="c">;</span>
	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">&lt;</span> <span class="pc">max_i</span><span class="c">ndex;</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex++) {</span>
		<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">*kaddr</span><span class="c">;</span>

		
		<span class="w">pa</span><span class="c">ge</span> <span class="pc">=</span> <span class="w">read_mapping_page</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">p</span><span class="c">age</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">r</span><span class="c">ead_mapping_page</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="w">.</span> <span class="w">Skipping</span> <span class="w">"</span>
					<span class="w">"p</span><span class="c">age</span> <span class="w">(in</span><span class="pc">d</span><span class="c">ex</span> <span class="w">0</span><span class="c">x%</span><span class="w">l</span><span class="pc">x</span><span class="w">).",</span> <span class="w">ind</span><span class="c">ex</span><span class="w">)</span><span class="pc">;</span>
			<span class="w">nr_free</span> <span class="w">-</span><span class="pc">=</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="w">*</span> <span class="w">8</span><span class="c">;</span>
			<span class="w">c</span><span class="pc">on</span><span class="c">tinue;</span>
		<span class="c">}</span>
		<span class="w">kaddr</span> <span class="pc">=</span> <span class="w">kmap_atomic</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">n</span><span class="pc">r</span><span class="c">_free</span> <span class="w">-</span><span class="pc">=</span> <span class="w">bitmap_weight</span><span class="pc">(</span><span class="c">kaddr</span><span class="pc">,</span>
					<span class="w">P</span><span class="pc">AGE_C</span><span class="c">ACHE_SIZE</span> <span class="w">*</span> <span class="w">BITS_PER_BYTE</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">kunmap_atomic</span><span class="c">(kaddr);</span>
		<span class="w">page_cache_release</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>
	<span class="c">}</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Finished</span> <span class="w">reading</span> <span class="w">$MFT/$BITMAP,</span> <span class="w">la</span><span class="c">st</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="pc">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="c">x</span><span class="w">.",</span>
			<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="w">-</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">nr_free</span> <span class="w">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">n</span><span class="pc">r</span><span class="c">_free</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">n</span><span class="pc">t</span><span class="c">fs_debug</span><span class="w">(</span><span class="pc">"</span><span class="w">Exiting.</span><span class="pc">")</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">n</span><span class="c">r_free;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">ntfs_statfs</span><span class="c">(struct</span> <span class="w">de</span><span class="pc">n</span><span class="c">try</span> <span class="c">*</span><span class="w">d</span><span class="pc">en</span><span class="c">try,</span> <span class="c">struct</span> <span class="w">kstatfs</span> <span class="c">*</span><span class="w">sfs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="pc">s</span><span class="c">b</span> <span class="pc">=</span> <span class="w">de</span><span class="pc">n</span><span class="c">try-&gt;</span><span class="w">d_sb</span><span class="c">;</span>
	<span class="w">s6</span><span class="c">4</span> <span class="w">s</span><span class="c">ize;</span>
	<span class="w">ntfs_volume</span> <span class="pc">*</span><span class="w">vo</span><span class="c">l</span> <span class="c">=</span> <span class="w">NTFS_SB</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>
	<span class="w">ntfs_inode</span> <span class="w">*mft_ni</span> <span class="c">=</span> <span class="w">NTFS_I</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">mft_ino</span><span class="c">);</span>
	<span class="w">pgoff_t</span> <span class="w">max_index</span><span class="pc">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">sfs-</span><span class="c">&gt;</span><span class="w">f_type</span>   <span class="c">=</span> <span class="w">NTFS_SB_MAGIC</span><span class="pc">;</span>
	
	<span class="c">sfs-&gt;</span><span class="w">f_bsize</span>  <span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">;</span>
	
	<span class="c">sfs-&gt;</span><span class="w">f_blocks</span> <span class="c">=</span> <span class="w">vo</span><span class="c">l-&gt;</span><span class="w">nr_clusters</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">cluster_size_bits</span> <span class="w">&gt;</span><span class="pc">&gt;</span>
				<span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	
	<span class="w">si</span><span class="pc">ze</span>	      <span class="c">=</span> <span class="w">get_nr_free_clusters</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="w">) &lt;</span><span class="pc">&lt;</span> <span class="w">v</span><span class="c">ol-&gt;cluster_size_bits</span> <span class="w">&gt;</span><span class="c">&gt;</span>
				<span class="pc">P</span><span class="c">AGE_CACHE_SHIFT</span><span class="w">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">&lt;</span> <span class="w">0LL</span><span class="c">)</span>
		<span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="c">=</span> <span class="pc">0</span><span class="c">LL;</span>
	
	<span class="w">s</span><span class="c">fs-&gt;</span><span class="w">f_bavail</span> <span class="c">=</span> <span class="c">sfs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f_bfree</span> <span class="w">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze;</span>
	
	<span class="w">down_read</span><span class="pc">(&amp;</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mftbmp_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">read_lock_irqsave</span><span class="pc">(&amp;</span><span class="w">mft_ni</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">size_lock</span><span class="pc">,</span> <span class="pc">f</span><span class="c">lags);</span>
	<span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="c">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">mft_ino) &gt;</span><span class="c">&gt;</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mft_record_size_bits</span><span class="pc">;</span>
	
	<span class="w">max_index</span> <span class="w">= ((((m</span><span class="pc">ft_n</span><span class="c">i-&gt;</span><span class="w">initialized_size</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">mft_r</span><span class="c">ecord_size_bits</span><span class="w">)</span>
			<span class="w">+</span> <span class="w">7) &gt;</span><span class="c">&gt;</span> <span class="w">3) </span><span class="pc">+</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="w">-</span> <span class="pc">1</span><span class="w">) &gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="w">read_unlock_irqrestore(</span><span class="pc">&amp;</span><span class="w">m</span><span class="pc">ft_n</span><span class="c">i-&gt;</span><span class="w">size_lock</span><span class="c">,</span> <span class="w">f</span><span class="c">lags);</span>
	
	<span class="w">sfs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f_files</span> <span class="c">=</span> <span class="w">si</span><span class="pc">ze</span><span class="c">;</span>
	
	<span class="c">sfs-&gt;</span><span class="w">f_ffree</span> <span class="c">=</span> <span class="w">__get_nr_free_mft_records</span><span class="pc">(</span><span class="w">vo</span><span class="c">l</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize,</span> <span class="w">max_index</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">up_read</span><span class="pc">(&amp;</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">mftbmp_lock</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">s</span><span class="c">fs-&gt;</span><span class="w">f_fsid</span><span class="pc">.</span><span class="w">va</span><span class="pc">l</span><span class="w">[</span><span class="c">0] =</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">serial_no</span> <span class="w">&amp;</span> <span class="w">0xf</span><span class="pc">ffff</span><span class="c">fff;</span>
	<span class="c">sfs-&gt;</span><span class="pc">f_fs</span><span class="c">id</span><span class="pc">.</span><span class="w">v</span><span class="pc">al[1</span><span class="w">] =</span><span class="pc"> </span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;serial_no</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">3</span><span class="pc">2</span><span class="c">) &amp;</span> <span class="w">0xf</span><span class="pc">ffff</span><span class="c">fff;</span>
	
	<span class="c">sfs-&gt;</span><span class="w">f_namelen</span>	   <span class="pc">=</span> <span class="w">NTFS_MAX_NAME_LEN</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">ntfs_write_inode</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*</span><span class="w">vi</span><span class="c">,</span> <span class="c">struct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">wbc</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">__ntfs_write_inode</span><span class="c">(vi,</span> <span class="pc">w</span><span class="c">bc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sync_mode</span> <span class="w">=</span><span class="c">=</span> <span class="w">WB_SYNC_ALL</span><span class="c">);</span>
<span class="c">}</span>
<span class="pc">#en</span><span class="c">dif</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">super_operations</span> <span class="w">ntfs_sops</span> <span class="pc">=</span><span class="c"> {</span>
	<span class="c">.</span><span class="w">alloc_inode</span>	<span class="c">=</span> <span class="w">ntfs_alloc_big_inode</span><span class="c">,</span>	  
	<span class="c">.</span><span class="w">destroy_inode</span>	<span class="c">=</span> <span class="w">ntfs_destroy_big_inode</span><span class="c">,</span> 
<span class="pc">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
	<span class="c">.</span><span class="w">write_inode</span>	<span class="c">=</span> <span class="w">ntfs_write_inode</span><span class="c">,</span>	
<span class="pc">#</span><span class="c">endif</span> 
	<span class="c">.</span><span class="w">put_super</span>	<span class="c">=</span> <span class="w">ntfs_put_super</span><span class="c">,</span>	
	<span class="c">.</span><span class="w">statfs</span>		<span class="c">=</span> <span class="w">ntfs_statfs</span><span class="c">,</span>		
	<span class="c">.</span><span class="w">remount_fs</span>	<span class="c">=</span> <span class="w">ntfs_remount</span><span class="c">,</span>		
	<span class="c">.</span><span class="w">evict_inode</span>	<span class="c">=</span> <span class="w">ntfs_evict_big_inode</span><span class="c">,</span>	
	<span class="c">.</span><span class="w">show_options</span>	<span class="c">=</span> <span class="w">ntfs_show_options</span><span class="c">,</span>	
<span class="pc">}</span><span class="c">;</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">ntfs_fill_super</span><span class="c">(struct</span> <span class="w">su</span><span class="c">per_block</span> <span class="c">*</span><span class="pc">s</span><span class="c">b,</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">o</span><span class="pc">p</span><span class="c">t,</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">silent</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">ntfs_volume</span> <span class="pc">*</span><span class="w">vo</span><span class="c">l</span><span class="pc">;</span>
	<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">b</span><span class="pc">h</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*</span><span class="w">tmp_ino</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">blocksize</span><span class="c">,</span> <span class="w">re</span><span class="pc">s</span><span class="c">ult;</span>

	
	<span class="w">lockdep_off</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Entering.</span><span class="pc">"</span><span class="c">);</span>
<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">NTFS_RW</span>
	<span class="w">sb-</span><span class="c">&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="pc">=</span> <span class="w">MS_RDONLY</span><span class="c">;</span>
<span class="c">#endif</span> 
	
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_fs_info</span> <span class="c">=</span> <span class="w">k</span><span class="c">malloc(sizeof(</span><span class="w">ntfs_volume</span><span class="c">),</span> <span class="w">GFP_NOFS</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">vo</span><span class="pc">l</span> <span class="pc">=</span> <span class="w">NTFS_SB</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">ol</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">silent</span><span class="pc">)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Allocation</span> <span class="w">o</span><span class="c">f</span> <span class="w">NTFS</span> <span class="w">volume</span> <span class="w">structure</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">f</span><span class="c">ailed</span><span class="w">.</span> <span class="w">Aborting</span> <span class="w">mount...");</span>
		<span class="w">lockdep_on()</span><span class="c">;</span>
		<span class="c">return</span> <span class="pc">-ENOM</span><span class="c">EM;</span>
	<span class="c">}</span>
	
	<span class="w">*vo</span><span class="pc">l</span> <span class="pc">= </span><span class="c">(</span><span class="w">ntfs_volume) {</span>
		<span class="w">.sb</span> <span class="c">=</span> <span class="w">sb,</span>
		
		<span class="c">.</span><span class="w">fmask</span> <span class="c">=</span> <span class="w">0177</span><span class="c">,</span>
		<span class="c">.</span><span class="w">dmask</span> <span class="c">=</span> <span class="w">0077</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">;</span>
	<span class="w">init_rwsem</span><span class="pc">(&amp;</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">mftbmp_lock</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">ni</span><span class="c">t_rwsem</span><span class="pc">(&amp;</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">lcnbmp_lock</span><span class="c">);</span>

	
	<span class="w">NVolSetSparseEnabled</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">parse_options</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="w">,</span><span class="pc"> (c</span><span class="c">har*)</span><span class="w">o</span><span class="pc">pt</span><span class="c">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">err_out_now</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">bdev_logical_block_size</span><span class="c">(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev) &gt;</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">silent</span><span class="pc">)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Device</span> <span class="w">h</span><span class="c">as</span> <span class="w">unsupported</span> <span class="w">sector</span> <span class="w">si</span><span class="pc">z</span><span class="c">e</span> <span class="w">"</span>
					<span class="w">"(%i).</span>  <span class="w">The</span> <span class="w">maximum</span> <span class="w">su</span><span class="pc">pporte</span><span class="c">d</span> <span class="w">s</span><span class="c">ector</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">s</span><span class="pc">iz</span><span class="c">e</span> <span class="w">o</span><span class="pc">n</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">architecture</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">%</span><span class="w">l</span><span class="c">u</span> <span class="pc">"</span>
					<span class="c">"</span><span class="w">by</span><span class="pc">tes</span><span class="w">.",</span>
					<span class="w">bdev_logical_block_size(sb-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="pc">)</span><span class="c">,</span>
					<span class="w">PAGE_CACHE_SIZE)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">err_out_now</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">blocksize</span> <span class="c">=</span> <span class="w">sb_min_blocksize</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">NTFS_BLOCK_SIZE</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(blocksize</span> <span class="pc">&lt;</span> <span class="w">N</span><span class="pc">T</span><span class="c">FS_BLOCK_SIZE) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">silent</span><span class="pc">)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="pc">s</span><span class="c">et</span> <span class="w">d</span><span class="c">evice</span> <span class="w">bl</span><span class="pc">ock</span> <span class="w">s</span><span class="c">ize</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">er</span><span class="pc">r_out_</span><span class="c">now;</span>
	<span class="c">}</span>
	<span class="w">B</span><span class="pc">UG_</span><span class="c">ON(</span><span class="pc">b</span><span class="c">locksize</span> <span class="pc">!</span><span class="c">=</span> <span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_blocksize</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Set</span> <span class="w">d</span><span class="c">evice</span> <span class="w">bl</span><span class="pc">ock</span> <span class="w">s</span><span class="c">ize</span> <span class="pc">t</span><span class="c">o</span> <span class="c">%</span><span class="w">i</span> <span class="w">b</span><span class="c">ytes</span> <span class="w">(bl</span><span class="pc">ock</span> <span class="w">s</span><span class="c">ize</span> <span class="w">bi</span><span class="c">ts</span> <span class="pc">%</span><span class="w">i).",</span>
			<span class="w">b</span><span class="pc">locks</span><span class="c">ize</span><span class="pc">,</span> <span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_blocksize_bits</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">i_size_read</span><span class="c">(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev-</span><span class="c">&gt;</span><span class="w">bd_inode</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">silent</span><span class="pc">)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="w">determine</span> <span class="w">d</span><span class="c">evice</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">err_out_now</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">nr_blocks</span> <span class="c">=</span> <span class="w">i</span><span class="pc">_</span><span class="c">size_read</span><span class="pc">(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s_bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;bd_inode</span><span class="w">) &gt;</span><span class="pc">&gt;</span>
			<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_blocksize_bits</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="pc">(!(</span><span class="w">bh</span> <span class="w">=</span> <span class="w">read_ntfs_boot_sector</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="c">silent</span><span class="w">))</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">si</span><span class="pc">l</span><span class="c">ent</span><span class="pc">)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">Not</span> <span class="w">an</span> <span class="w">NTFS</span> <span class="w">volume.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">err_out_now</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">res</span><span class="pc">u</span><span class="c">lt</span> <span class="c">=</span> <span class="w">parse_ntfs_boot_sector</span><span class="c">(</span><span class="w">vo</span><span class="pc">l, (</span><span class="w">NTFS_BOOT_SECTOR*</span><span class="pc">)</span><span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_data</span><span class="c">);</span>
	<span class="w">brelse</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">r</span><span class="pc">e</span><span class="c">sult) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">silent</span><span class="pc">)</span>
			<span class="w">n</span><span class="c">tfs_error</span><span class="pc">(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="w">Unsupported</span> <span class="pc">N</span><span class="c">TFS</span> <span class="w">filesystem.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="pc">e</span><span class="c">rr_out_now;</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">sector_size</span> <span class="w">&gt;</span> <span class="w">blocksize</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">b</span><span class="pc">l</span><span class="c">ocksize</span> <span class="c">=</span> <span class="w">sb_set_blocksize</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;sector_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(blocksize</span> <span class="w">!</span><span class="c">=</span> <span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="pc">s</span><span class="c">ector_size</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">silent</span><span class="pc">)</span>
				<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">U</span><span class="c">nable</span> <span class="c">to</span> <span class="w">s</span><span class="c">et</span> <span class="w">d</span><span class="c">evice</span> <span class="w">b</span><span class="pc">lock</span> <span class="w">"</span>
						<span class="c">"</span><span class="w">si</span><span class="pc">z</span><span class="c">e</span> <span class="pc">t</span><span class="c">o</span> <span class="w">sector</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">(</span><span class="c">%</span><span class="w">i).",</span>
						<span class="w">vo</span><span class="c">l</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">s</span><span class="pc">e</span><span class="c">ctor_size</span><span class="w">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">err_out_now</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">B</span><span class="c">UG_ON(blocksize</span> <span class="w">!</span><span class="c">=</span> <span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_blocksize</span><span class="c">);</span>
		<span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">nr_blocks</span> <span class="c">=</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bd_inode) &gt;</span><span class="c">&gt;</span>
				<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_blocksize_bits</span><span class="pc">;</span>
		<span class="w">ntfs_debug(</span><span class="pc">"</span><span class="w">Changed</span> <span class="w">d</span><span class="c">evice</span> <span class="w">bl</span><span class="pc">ock</span> <span class="w">s</span><span class="pc">ize</span> <span class="w">t</span><span class="c">o</span> <span class="c">%</span><span class="w">i</span> <span class="w">b</span><span class="c">ytes</span> <span class="w">(b</span><span class="pc">lock</span> <span class="w">s</span><span class="c">ize</span> <span class="w">"</span>
				<span class="pc">"</span><span class="w">bi</span><span class="pc">ts</span> <span class="c">%</span><span class="w">i)</span> <span class="w">to</span> <span class="w">m</span><span class="pc">at</span><span class="c">ch</span> <span class="w">volume</span> <span class="w">sector</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="w">.",</span>
				<span class="w">blocksize,</span> <span class="w">sb</span><span class="c">-&gt;</span><span class="pc">s_bl</span><span class="c">ocksize_bits</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	
	<span class="w">ntfs_setup_allocators</span><span class="c">(</span><span class="w">vo</span><span class="pc">l)</span><span class="c">;</span>
	
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_magic</span> <span class="c">=</span> <span class="w">NTFS_SB_MAGIC</span><span class="c">;</span>
	
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_maxbytes</span> <span class="c">=</span> <span class="w">MAX_LFS_FILESIZE</span><span class="c">;</span>
	
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_time_gran</span> <span class="c">=</span> <span class="w">1</span><span class="pc">00</span><span class="c">;</span>
	
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_op</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">ntfs_sops</span><span class="c">;</span>
	<span class="w">tmp_ino</span> <span class="pc">=</span> <span class="w">new_inode</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">tmp_ino</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">silent</span><span class="pc">)</span>
			<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">essential</span> <span class="w">metadata.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">err_out_now</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">t</span><span class="c">mp_ino</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no</span> <span class="c">=</span> <span class="w">FILE_MFT</span><span class="c">;</span>
	<span class="w">insert_inode_hash</span><span class="c">(tmp_ino);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">ntfs_read_inode_mount</span><span class="c">(tmp_ino</span><span class="w">)</span><span class="pc"> </span><span class="c">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">if</span> <span class="pc">(!s</span><span class="c">ilent</span><span class="pc">)</span>
			<span class="w">n</span><span class="c">tfs_error(</span><span class="w">sb</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">l</span><span class="c">oad</span> <span class="w">e</span><span class="pc">s</span><span class="c">sential</span> <span class="w">m</span><span class="pc">e</span><span class="c">tadata</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">iput_tmp_ino_err_out_now</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">mu</span><span class="pc">tex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">cluster_size</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">4</span><span class="pc">0</span><span class="c">96</span> <span class="w">&amp;</span><span class="pc">&amp; !</span><span class="w">ntfs_nr_compression_users+</span><span class="pc">+)</span><span class="c"> {</span>
		<span class="w">res</span><span class="pc">u</span><span class="c">lt</span> <span class="c">=</span> <span class="w">allocate_compression_buffers</span><span class="pc">()</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">n</span><span class="c">tfs_error(</span><span class="w">N</span><span class="c">ULL, "</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">a</span><span class="c">llocate</span> <span class="w">buffers</span> <span class="w">"</span>
					<span class="c">"</span><span class="w">f</span><span class="c">or</span> <span class="w">compression</span> <span class="w">eng</span><span class="c">ine</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">n</span><span class="pc">tfs_n</span><span class="c">r_compression_users</span><span class="w">-</span><span class="pc">-</span><span class="c">;</span>
			<span class="w">m</span><span class="c">utex_unlock(&amp;ntfs_lock</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">iput_tmp_ino_err_out_now</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">default_upcase</span><span class="pc">)</span>
		<span class="w">d</span><span class="c">efault_upcase</span> <span class="c">=</span> <span class="w">generate_default_upcase</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">ntfs_nr_upcase_users+</span><span class="c">+;</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">n</span><span class="pc">tfs_l</span><span class="c">ock</span><span class="pc">)</span><span class="c">;</span>
	
	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">load_system_files</span><span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">)) {</span>
		<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">load</span> <span class="w">system</span> <span class="w">files.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">unl_upcase_iput_tmp_ino_err_out_now</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">ihold</span><span class="c">(</span><span class="w">vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">root_ino</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_root</span> <span class="w">=</span> <span class="w">d_make_root</span><span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">r</span><span class="c">oot_ino</span><span class="w">))</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Exiting,</span> <span class="w">st</span><span class="pc">a</span><span class="c">tus</span> <span class="w">successful.</span><span class="pc">"</span><span class="c">);</span>
		
		<span class="w">m</span><span class="pc">utex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
		<span class="c">if</span> <span class="w">(!--ntfs_nr_upcase_users</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">default_upcase)</span><span class="c"> {</span>
			<span class="w">ntfs_free</span><span class="c">(</span><span class="w">d</span><span class="pc">ef</span><span class="c">ault_upcase);</span>
			<span class="pc">d</span><span class="c">efault_upcase</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
		<span class="c">}</span>
		<span class="w">m</span><span class="c">utex_unlock(&amp;ntfs_lock);</span>
		<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_export_op</span> <span class="w">=</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">ntfs_export_ops</span><span class="c">;</span>
		<span class="w">lockdep_on</span><span class="pc">()</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>
	<span class="w">ntfs_error</span><span class="c">(</span><span class="w">sb</span><span class="pc">, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">a</span><span class="c">llocate</span> <span class="w">ro</span><span class="c">ot</span> <span class="w">directory.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">/</span><span class="c">/</span> <span class="w">TODO</span><span class="c">:</span> <span class="w">Use</span> <span class="w">ntfs_put_super()</span> <span class="w">instead</span> <span class="w">o</span><span class="c">f</span> <span class="w">repeating</span> <span class="w">al</span><span class="pc">l</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">cod</span><span class="c">e</span><span class="w">...</span>
	<span class="w">/</span><span class="c">/</span> <span class="w">FIXME</span><span class="pc">:</span> <span class="w">Should</span> <span class="w">mark</span> <span class="w">t</span><span class="c">he</span> <span class="w">volume</span> <span class="w">clean</span> <span class="w">a</span><span class="pc">s</span> <span class="pc">t</span><span class="c">he</span> <span class="w">e</span><span class="c">rror</span> <span class="w">i</span><span class="c">s</span> <span class="w">most</span> <span class="w">lik</span><span class="c">ely</span>
	<span class="w">// 	  -EN</span><span class="pc">OM</span><span class="c">EM.</span>
	<span class="w">iput(vo</span><span class="pc">l-</span><span class="c">&gt;</span><span class="w">vol_ino</span><span class="pc">);</span>
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="pc">v</span><span class="c">ol_ino</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">major_ver</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">3</span><span class="c">) {</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">usnjrnl_j_ino</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;usnjrnl_j_ino</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;usnjrnl_j_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">usnjrnl_max_ino</span><span class="c">) {</span>
			<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;usnjrnl_max_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;usnjrnl_max_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">usnjrnl_ino</span><span class="c">) {</span>
			<span class="c">iput</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;usnjrnl_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;usnjrnl_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">quota_q_ino</span><span class="c">) {</span>
			<span class="c">iput</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;quota_q_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;quota_q_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">quota_ino</span><span class="c">) {</span>
			<span class="c">iput</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;quota_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;quota_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 
		<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">extend_ino</span><span class="c">) {</span>
			<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;extend_ino</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">v</span><span class="c">ol-&gt;extend_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">secure_ino</span><span class="c">) {</span>
			<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;secure_ino);</span>
			<span class="w">v</span><span class="c">ol-&gt;secure_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">root_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">v</span><span class="c">ol-&gt;root_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">lcnbmp_ino</span><span class="c">);</span>
	<span class="w">v</span><span class="c">ol-&gt;lcnbmp_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">ip</span><span class="c">ut</span><span class="pc">(v</span><span class="c">ol-&gt;</span><span class="w">mftbmp_ino</span><span class="c">);</span>
	<span class="w">v</span><span class="c">ol-&gt;mftbmp_ino</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">NTFS_RW</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">logfile_ino</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;logfile_ino);</span>
		<span class="w">v</span><span class="c">ol-&gt;logfile_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">mftmirr_ino</span><span class="c">) {</span>
		<span class="w">i</span><span class="pc">p</span><span class="c">ut</span><span class="pc">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;mftmirr_ino);</span>
		<span class="w">v</span><span class="c">ol-&gt;mftmirr_ino</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 
	
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">attrdef_size</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">attrdef</span><span class="c">) {</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;attrdef);</span>
		<span class="w">v</span><span class="c">ol-&gt;attrdef</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>
	<span class="w">v</span><span class="pc">ol</span><span class="c">-&gt;</span><span class="w">upcase_len</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">mu</span><span class="pc">tex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;</span><span class="w">upcase</span> <span class="pc">=</span><span class="c">=</span> <span class="w">default_upcase</span><span class="c">) {</span>
		<span class="w">ntfs_nr_upcase_users-</span><span class="pc">-</span><span class="c">;</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">u</span><span class="c">pcase</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;ntfs_lock</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;upcase) {</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;upcase</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">v</span><span class="c">ol-&gt;</span><span class="pc">u</span><span class="c">pcase</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="c">ol-&gt;</span><span class="w">nls_map</span><span class="c">) {</span>
		<span class="w">unload_nls</span><span class="c">(</span><span class="w">v</span><span class="pc">o</span><span class="c">l-&gt;nls_map);</span>
		<span class="w">v</span><span class="c">ol-&gt;nls_map</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	
<span class="w">unl_upcase_iput_tmp_ino_err_out_now:</span>
	
	<span class="w">m</span><span class="pc">utex_l</span><span class="c">ock(&amp;</span><span class="w">ntfs_lock</span><span class="c">);</span>
	<span class="c">if</span> <span class="w">(!--ntfs_nr_upcase_users</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">default_upcase</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">ntfs_free</span><span class="c">(</span><span class="w">de</span><span class="pc">f</span><span class="c">ault_upcase);</span>
		<span class="w">d</span><span class="c">efault_upcase</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">vo</span><span class="c">l-&gt;</span><span class="w">cluster_size</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">4</span><span class="pc">0</span><span class="c">96</span> <span class="w">&amp;&amp; !--ntfs_nr_compression_users</span><span class="pc">)</span>
		<span class="w">free_compression_buffers</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="pc">ntfs_l</span><span class="c">ock);</span>
<span class="w">iput_tmp_ino_err_out_now</span><span class="pc">:</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">tmp_ino</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">vo</span><span class="pc">l</span><span class="c">-&gt;</span><span class="w">mft_ino</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">v</span><span class="c">ol-&gt;mft_ino</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">t</span><span class="c">mp_ino</span><span class="pc">)</span>
		<span class="w">i</span><span class="pc">put(</span><span class="w">v</span><span class="pc">o</span><span class="c">l</span><span class="pc">-</span><span class="c">&gt;mft_ino</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">v</span><span class="c">ol-&gt;mft_ino</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	
<span class="w">err_out_now:</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_fs_info</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">v</span><span class="c">ol);</span>
	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">F</span><span class="c">ailed</span><span class="w">,</span> <span class="w">returning</span> <span class="pc">-</span><span class="w">E</span><span class="pc">IN</span><span class="c">VAL</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
	<span class="w">lockdep_on</span><span class="pc">()</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
<span class="c">}</span>


<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">kmem_cache</span> <span class="c">*</span><span class="w">ntfs_name_cache</span><span class="pc">;</span>


<span class="pc">s</span><span class="c">truct</span> <span class="c">kmem_cache</span> <span class="c">*</span><span class="w">ntfs_inode_cache</span><span class="c">;</span>
<span class="c">struct</span> <span class="c">kmem_cache</span> <span class="c">*</span><span class="w">ntfs_big_inode_cache</span><span class="c">;</span>


<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">ntfs_big_inode_init_once</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="pc">*</span><span class="w">foo</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">ntfs_inode</span> <span class="pc">*</span><span class="w">ni</span> <span class="pc">= </span><span class="c">(</span><span class="pc">n</span><span class="c">tfs_inode</span> <span class="c">*)foo</span><span class="pc">;</span>

	<span class="w">inode_init_once</span><span class="c">(</span><span class="w">VFS_I</span><span class="pc">(</span><span class="w">ni</span><span class="pc">))</span><span class="c">;</span>
<span class="pc">}</span>


<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="c">kmem_cache</span> <span class="c">*</span><span class="w">ntfs_attr_ctx_cache</span><span class="pc">;</span>
<span class="c">struct</span> <span class="c">kmem_cache</span> <span class="c">*</span><span class="w">ntfs_index_ctx_cache</span><span class="c">;</span>


<span class="w">DEFINE_MUTEX</span><span class="c">(</span><span class="w">ntfs_lock</span><span class="pc">)</span><span class="c">;</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span> <span class="c">*</span><span class="w">ntfs_mount</span><span class="pc">(</span><span class="c">struct</span> <span class="w">file_system_type</span> <span class="c">*</span><span class="w">fs_type</span><span class="c">,</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">f</span><span class="c">lags</span><span class="pc">,</span> <span class="c">const</span> <span class="c">char</span> <span class="c">*</span><span class="pc">d</span><span class="c">ev_name,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*data</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">mount_bdev</span><span class="c">(</span><span class="w">f</span><span class="c">s_type,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags</span><span class="pc">,</span> <span class="w">dev</span><span class="pc">_</span><span class="c">name</span><span class="pc">,</span> <span class="pc">d</span><span class="c">ata</span><span class="pc">,</span> <span class="w">ntfs_fill_super</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="c">file_system_type</span> <span class="w">ntfs_fs_type</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">o</span><span class="c">wner</span>		<span class="c">=</span> <span class="c">THIS_MODULE,</span>
	<span class="c">.name</span>		<span class="c">= "</span><span class="w">ntfs</span><span class="c">",</span>
	<span class="c">.</span><span class="w">mount</span>		<span class="c">=</span> <span class="w">ntfs_mount</span><span class="c">,</span>
	<span class="c">.</span><span class="w">kill_sb</span>	<span class="c">=</span> <span class="w">kill_block_super</span><span class="c">,</span>
	<span class="c">.</span><span class="w">fs_flags</span>	<span class="c">=</span> <span class="w">FS_REQUIRES_DEV</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>
<span class="w">MODULE_ALIAS_FS</span><span class="pc">("</span><span class="w">n</span><span class="pc">tfs</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="w">ntfs_index_ctx_cache_name[] = "ntfs_index_ctx_cache"</span><span class="pc">;</span>
<span class="c">static</span> <span class="c">const</span> <span class="c">char</span> <span class="w">ntfs_attr_ctx_cache_name[</span><span class="pc">] = "</span><span class="w">ntfs_attr_ctx_cache"</span><span class="pc">;</span>
<span class="c">static</span> <span class="c">const</span> <span class="c">char</span> <span class="w">ntfs_name_cache_name[</span><span class="pc">] = "</span><span class="w">ntfs_name_cache"</span><span class="c">;</span>
<span class="c">static</span> <span class="c">const</span> <span class="c">char</span> <span class="w">ntfs_inode_cache_name[</span><span class="pc">] = "</span><span class="w">ntfs_inode_cache</span><span class="pc">";</span>
<span class="c">static</span> <span class="c">const</span> <span class="c">char</span> <span class="w">ntfs_big_inode_cache_name</span><span class="pc">[] = "</span><span class="w">ntfs_big_inode_cache</span><span class="pc">";</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">__init</span> <span class="w">init_ntfs_fs</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="w">p</span><span class="pc">r_</span><span class="c">info("</span><span class="w">d</span><span class="pc">r</span><span class="c">iver</span> <span class="w">"</span> <span class="w">NTFS_VERSION</span> <span class="w">" [Flags:</span> <span class="w">R/"</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">NTFS_RW</span>
			<span class="w">"W</span><span class="pc">"</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
			<span class="w">"O</span><span class="c">"</span>
<span class="c">#endif</span>
<span class="c">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="pc">D</span><span class="c">EBUG</span>
			<span class="w">"</span> <span class="w">D</span><span class="pc">E</span><span class="c">BUG"</span>
<span class="c">#endif</span>
<span class="c">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">MODULE</span>
			<span class="w">"</span> <span class="w">M</span><span class="c">ODULE</span><span class="pc">"</span>
<span class="c">#endif</span>
			<span class="w">"].\n</span><span class="c">");</span>

	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Debug</span> <span class="w">messages</span> <span class="w">ar</span><span class="pc">e</span> <span class="w">e</span><span class="pc">na</span><span class="c">bled</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>

	<span class="w">ntfs_index_ctx_cache</span> <span class="w">=</span> <span class="w">kmem_cache_create</span><span class="pc">(</span><span class="w">ntfs_index_ctx_cache_name</span><span class="pc">,</span>
			<span class="pc">s</span><span class="c">izeof(</span><span class="w">ntfs_index_context</span><span class="pc">),</span> <span class="pc">0</span> <span class="pc">,</span>
			<span class="w">SLAB_HWCACHE_ALIGN</span><span class="pc">,</span> <span class="c">NULL</span> <span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!ntfs_index_ctx_cache</span><span class="c">) {</span>
		<span class="w">pr_crit</span><span class="c">("</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">c</span><span class="c">reate</span> <span class="w">%</span><span class="c">s</span><span class="w">!</span><span class="c">\n",</span> <span class="pc">ntfs_index_ctx_cache_</span><span class="c">name);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">ictx_err_out</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">ntfs_attr_ctx_cache</span> <span class="pc">=</span> <span class="pc">km</span><span class="c">em_cache_create(</span><span class="w">ntfs_attr_ctx_cache_name</span><span class="c">,</span>
			<span class="pc">s</span><span class="c">izeof(</span><span class="w">ntfs_attr_search_ctx</span><span class="pc">),</span> <span class="pc">0</span> <span class="pc">,</span>
			<span class="w">S</span><span class="c">LAB_HWCACHE_ALIGN,</span> <span class="c">NULL</span> <span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!ntfs_attr_ctx_cache</span><span class="c">) {</span>
		<span class="w">pr_</span><span class="pc">c</span><span class="c">rit</span><span class="pc">("</span><span class="w">NTFS</span><span class="pc">:</span> <span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">c</span><span class="c">reate</span> <span class="w">%</span><span class="c">s</span><span class="w">!</span><span class="c">\n",</span>
			<span class="w">n</span><span class="pc">tfs_attr_ctx_cache_</span><span class="c">name);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">actx_err_out</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">ntfs_name_cache</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">m</span><span class="c">em_cache_create(</span><span class="w">ntfs_name_cache_name</span><span class="c">,</span>
			<span class="w">(NTFS_MAX_NAME_LEN+</span><span class="c">1</span><span class="w">) </span><span class="pc">*</span> <span class="c">sizeof(</span><span class="w">ntfschar</span><span class="pc">),</span> <span class="pc">0,</span>
			<span class="w">SLAB_HWCACHE_ALIGN</span><span class="pc">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!ntfs_</span><span class="c">name_cache</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">pr_crit</span><span class="pc">("</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">c</span><span class="c">reate</span> <span class="c">%s</span><span class="w">!</span><span class="c">\n",</span> <span class="w">n</span><span class="pc">tfs_name_cache_</span><span class="c">name);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">name_err_out</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">ntfs_inode_cache</span> <span class="pc">=</span> <span class="w">kmem_cache_create</span><span class="c">(</span><span class="w">ntfs_inode_cache_name</span><span class="c">,</span>
			<span class="pc">s</span><span class="c">izeof(</span><span class="w">ntfs_inode</span><span class="pc">),</span> <span class="pc">0,</span>
			<span class="w">SLAB_RECLAIM_ACCOUNT</span><span class="pc">|</span><span class="w">SLAB_MEM_SPREAD</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">ntfs_inode_cache) {</span>
		<span class="w">p</span><span class="pc">r_c</span><span class="c">rit("</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">c</span><span class="c">reate</span> <span class="w">%</span><span class="c">s</span><span class="w">!</span><span class="c">\n",</span> <span class="pc">ntfs_inode_cache_</span><span class="c">name);</span>
		<span class="c">goto</span> <span class="w">inode_err_out</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">ntfs_big_inode_cache</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">m</span><span class="c">em_cache_create(</span><span class="w">ntfs_big_inode_cache_name</span><span class="c">,</span>
			<span class="pc">s</span><span class="c">izeof(</span><span class="w">big_ntfs_inode</span><span class="pc">),</span> <span class="c">0</span><span class="pc">,</span>
			<span class="w">SLAB_HWCACHE_ALIGN</span><span class="pc">|</span><span class="w">S</span><span class="c">LAB_RECLAIM_ACCOUNT|</span><span class="w">S</span><span class="pc">LAB_M</span><span class="c">EM_SPREAD</span><span class="pc">,</span>
			<span class="w">ntfs_big_inode_init_once</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">n</span><span class="pc">tfs_b</span><span class="c">ig_inode_cache) {</span>
		<span class="w">p</span><span class="pc">r_c</span><span class="c">rit</span><span class="pc">("</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">c</span><span class="c">reate</span> <span class="w">%</span><span class="c">s</span><span class="w">!</span><span class="c">\n",</span> <span class="pc">ntfs_big_inode_cache_</span><span class="c">name</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">big_inode_err_out</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ntfs_sysctl</span><span class="c">(</span><span class="w">1</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">p</span><span class="pc">r_c</span><span class="c">rit</span><span class="pc">("</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="c">register</span> <span class="w">NTFS</span> <span class="w">sysctls!</span><span class="c">\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">sysctl_err_out</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">register_filesystem</span><span class="pc">(&amp;</span><span class="w">ntfs_fs_type</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">err</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">N</span><span class="c">TFS</span> <span class="w">d</span><span class="pc">r</span><span class="c">iver</span> <span class="w">registered</span> <span class="w">successfully.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span> 
	<span class="c">}</span>
	<span class="w">p</span><span class="c">r_crit</span><span class="pc">("</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="c">register</span> <span class="pc">N</span><span class="c">TFS</span> <span class="w">filesystem</span> <span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="w">!</span><span class="c">\n");</span>

	
	<span class="w">ntfs_sysctl</span><span class="c">(</span><span class="w">0</span><span class="c">);</span>
<span class="w">s</span><span class="c">ysctl_err_out</span><span class="pc">:</span>
	<span class="w">kmem_cache_destroy</span><span class="c">(</span><span class="w">ntfs_big_inode_cache</span><span class="c">);</span>
<span class="w">big_inode_err_out</span><span class="pc">:</span>
	<span class="w">k</span><span class="pc">m</span><span class="c">em_cache_destroy(</span><span class="w">ntfs_inode_cache</span><span class="c">);</span>
<span class="w">inode_err_out</span><span class="c">:</span>
	<span class="c">kmem_cache_destroy(</span><span class="w">ntfs_name_cache</span><span class="c">);</span>
<span class="w">name_err_out</span><span class="c">:</span>
	<span class="pc">k</span><span class="c">mem_cache_destroy(</span><span class="w">ntfs_attr_ctx_cache</span><span class="c">);</span>
<span class="w">actx_err_out</span><span class="c">:</span>
	<span class="c">kmem_cache_destroy(</span><span class="w">ntfs_index_ctx_cache</span><span class="c">);</span>
<span class="w">ictx_err_out</span><span class="c">:</span>
	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">e</span><span class="pc">r</span><span class="c">r</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">pr_crit</span><span class="pc">("</span><span class="w">Aborting</span> <span class="w">NTFS</span> <span class="w">filesystem</span> <span class="w">d</span><span class="pc">r</span><span class="c">iver</span> <span class="w">registration...\n</span><span class="c">");</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">= -</span><span class="pc">ENOM</span><span class="c">EM;</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">__exit</span> <span class="w">exit_ntfs_fs</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="w">ntfs_debug</span><span class="pc">("</span><span class="w">Unregistering</span> <span class="w">N</span><span class="c">TFS</span> <span class="w">d</span><span class="c">river</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>

	<span class="w">unregister_filesystem</span><span class="pc">(&amp;</span><span class="w">ntfs_fs_type</span><span class="c">);</span>

	
	<span class="w">rcu_barrier</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">kmem_cache_destroy</span><span class="pc">(</span><span class="w">ntfs_big_inode_cache</span><span class="c">);</span>
	<span class="w">k</span><span class="pc">m</span><span class="c">em_cache_destroy(</span><span class="w">ntfs_inode_cache</span><span class="c">);</span>
	<span class="pc">k</span><span class="c">mem_cache_destroy(</span><span class="w">ntfs_name_cache</span><span class="c">);</span>
	<span class="pc">k</span><span class="c">mem_cache_destroy(</span><span class="w">ntfs_attr_ctx_cache</span><span class="c">);</span>
	<span class="c">kmem_cache_destroy(</span><span class="w">ntfs_index_ctx_cache</span><span class="c">);</span>
	
	<span class="w">ntfs_sysctl</span><span class="c">(</span><span class="pc">0</span><span class="c">);</span>
<span class="pc">}</span>

<span class="w">M</span><span class="c">ODULE_AUTHOR("</span><span class="w">Anton</span> <span class="w">Altaparmakov</span> <span class="c">&lt;</span><span class="w">anton</span><span class="c">@</span><span class="w">tuxera</span><span class="c">.com&gt;");</span>
<span class="c">MODULE_DESCRIPTION("</span><span class="w">NTFS</span> <span class="w">1.2/</span><span class="pc">3</span><span class="c">.</span><span class="w">x</span> <span class="w">d</span><span class="pc">r</span><span class="c">iver</span> <span class="w">-</span> <span class="w">Copyright</span> <span class="w">(c</span><span class="pc">)</span> <span class="w">2001-2014</span> <span class="w">A</span><span class="c">nton</span> <span class="w">A</span><span class="pc">l</span><span class="c">taparmakov</span> <span class="w">a</span><span class="pc">nd</span> <span class="w">Tuxera</span> <span class="w">Inc.</span><span class="pc">"</span><span class="c">);</span>
<span class="w">MODULE_VERSION</span><span class="c">(</span><span class="w">NTFS_VERSION</span><span class="pc">)</span><span class="c">;</span>
<span class="w">M</span><span class="pc">ODULE_L</span><span class="c">ICENSE("GPL");</span>
<span class="pc">#i</span><span class="c">fdef</span> <span class="w">D</span><span class="c">EBUG</span>
<span class="w">m</span><span class="pc">odule_p</span><span class="c">aram(</span><span class="w">debug_msgs</span><span class="c">,</span> <span class="w">bint</span><span class="c">,</span> <span class="c">0);</span>
<span class="pc">M</span><span class="c">ODULE_PARM_DESC(debug_msgs, "</span><span class="w">Enable</span> <span class="w">d</span><span class="pc">e</span><span class="c">bug</span> <span class="w">messages.</span><span class="pc">"</span><span class="c">);</span>
<span class="pc">#e</span><span class="c">ndif</span>

<span class="w">m</span><span class="pc">odule_i</span><span class="c">nit(</span><span class="w">init_ntfs_fs</span><span class="c">)</span>
<span class="pc">m</span><span class="c">odule_exit(</span><span class="w">exit_ntfs_fs</span><span class="pc">)</span>

</pre>
</body>
</html>

