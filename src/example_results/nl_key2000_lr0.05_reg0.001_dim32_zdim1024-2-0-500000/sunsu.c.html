<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/spinlock.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/errno.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">t</span><span class="pc">t</span><span class="c">y.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">tty_flip</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ma</span><span class="pc">j</span><span class="c">or.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">t</span><span class="c">ring.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ptrace</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ioport</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">circ_buf</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">se</span><span class="pc">ria</span><span class="c">l.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">sysrq</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">console</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/slab.h&gt;</span>
<span class="c">#</span><span class="pc">if</span><span class="c">def</span> <span class="w">CONFIG_SERIO</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">l</span><span class="c">inux/</span><span class="w">se</span><span class="pc">rio</span><span class="c">.h&gt;</span>
<span class="c">#endif</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">serial_reg</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">n</span><span class="c">it.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">of_device</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/io.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="pc">ir</span><span class="c">q.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">prom</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">se</span><span class="pc">t</span><span class="c">up.h&gt;</span>

<span class="c">#</span><span class="w">i</span><span class="pc">f</span> <span class="c">defined(</span><span class="w">CONFIG_SERIAL_SUNSU_CONSOLE</span><span class="pc">) &amp;&amp;</span> <span class="c">defined(</span><span class="w">CONFIG_MAGIC_SYSRQ</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">SUPPORT_SYSRQ</span>
<span class="pc">#</span><span class="c">endif</span>

<span class="c">#</span><span class="w">i</span><span class="pc">n</span><span class="c">clude</span> <span class="c">&lt;</span><span class="pc">l</span><span class="c">inux/</span><span class="w">serial_core</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">sunserialcore</span><span class="c">.h&gt;</span>


<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">SU_BASE_BAUD</span>	<span class="c">(</span><span class="w">1846200</span> <span class="w">/</span> <span class="w">1</span><span class="pc">6</span><span class="c">)</span>

<span class="pc">e</span><span class="c">num</span> <span class="w">su_type</span> <span class="c">{</span> <span class="w">SU_PORT_NONE</span><span class="pc">,</span> <span class="w">SU_PORT_MS</span><span class="c">,</span> <span class="w">SU_PORT_KBD</span><span class="c">,</span> <span class="w">SU_PORT_PORT</span> <span class="pc">}</span><span class="c">;</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">su_typev[] = { "su(???)", "s</span><span class="pc">u</span><span class="w">(mouse)", "s</span><span class="pc">u(</span><span class="w">kbd)"</span><span class="pc">,</span><span class="c"> "su</span><span class="pc">(</span><span class="w">se</span><span class="c">rial</span><span class="w">)" };</span>

<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">serial_uart_config</span> <span class="c">{</span>
	<span class="pc">c</span><span class="c">har</span>	<span class="pc">*</span><span class="c">name;</span>
	<span class="pc">i</span><span class="c">nt</span>	<span class="w">dfl_xmit_fifo_size</span><span class="c">;</span>
	<span class="c">int</span>	<span class="w">f</span><span class="pc">l</span><span class="c">ags;</span>
<span class="w">}</span><span class="c">;</span>


<span class="pc">sta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="pc">s</span><span class="c">erial_uart_config</span> <span class="w">uart_config</span><span class="c">[] = {</span>
	<span class="pc">{ "</span><span class="w">u</span><span class="pc">nk</span><span class="c">nown</span><span class="w">"</span><span class="pc">,</span>	<span class="w">1</span><span class="pc">,</span>	<span class="pc">0</span> <span class="pc">}</span><span class="c">,</span>
	<span class="pc">{ </span><span class="c">"</span><span class="w">8250</span><span class="c">",</span>	<span class="pc">1</span><span class="c">,</span>	<span class="pc">0</span> <span class="c">},</span>
	<span class="c">{ "</span><span class="w">16450</span><span class="c">",</span>	<span class="pc">1</span><span class="c">,</span>	<span class="c">0</span> <span class="c">},</span>
	<span class="c">{ "</span><span class="w">16550</span><span class="c">",</span>	<span class="pc">1</span><span class="c">,</span>	<span class="c">0</span> <span class="c">},</span>
	<span class="c">{ "</span><span class="w">16550A</span><span class="c">",</span>	<span class="w">1</span><span class="pc">6</span><span class="c">,</span>	<span class="w">UART_CLEAR_FIFO</span> <span class="w">|</span> <span class="w">UART_USE_FIFO</span> <span class="c">},</span>
	<span class="c">{ "</span><span class="w">Cirrus</span><span class="c">",</span>	<span class="pc">1,</span> 	<span class="c">0</span> <span class="pc">}</span><span class="c">,</span>
	<span class="c">{ "</span><span class="w">ST16650</span><span class="c">",</span>	<span class="c">1</span><span class="pc">,</span>	<span class="w">U</span><span class="pc">ART_C</span><span class="c">LEAR_FIFO</span> <span class="w">|</span> <span class="w">UART_STARTECH</span> <span class="pc">}</span><span class="c">,</span>
	<span class="c">{ "</span><span class="w">ST16650V2</span><span class="c">",</span>	<span class="w">3</span><span class="pc">2,</span>	<span class="w">U</span><span class="c">ART_CLEAR_FIFO</span> <span class="pc">|</span> <span class="w">U</span><span class="pc">ART_U</span><span class="c">SE_FIFO</span> <span class="pc">|</span> <span class="pc">UART_S</span><span class="c">TARTECH</span> <span class="pc">}</span><span class="c">,</span>
	<span class="c">{ "</span><span class="w">TI16750</span><span class="c">",</span>	<span class="w">6</span><span class="pc">4</span><span class="c">,</span>	<span class="c">UART_CLEAR_FIFO</span> <span class="pc">|</span> <span class="pc">UART_U</span><span class="c">SE_FIFO</span> <span class="c">},</span>
	<span class="pc">{ </span><span class="c">"</span><span class="w">Startech</span><span class="c">",</span>	<span class="pc">1</span><span class="c">,</span>	<span class="c">0</span> <span class="pc">}</span><span class="c">,</span>
	<span class="c">{ "</span><span class="w">16C950/954</span><span class="c">",</span>	<span class="w">12</span><span class="pc">8,</span>	<span class="pc">U</span><span class="c">ART_CLEAR_FIFO</span> <span class="w">|</span> <span class="w">U</span><span class="pc">ART_U</span><span class="c">SE_FIFO</span> <span class="c">},</span>
	<span class="c">{ "</span><span class="w">ST16654</span><span class="c">",</span>	<span class="w">6</span><span class="pc">4</span><span class="c">,</span>	<span class="w">U</span><span class="pc">ART_C</span><span class="c">LEAR_FIFO</span> <span class="pc">|</span> <span class="c">UART_USE_FIFO</span> <span class="pc">|</span> <span class="c">UART_STARTECH</span> <span class="pc">}</span><span class="c">,</span>
	<span class="c">{ "</span><span class="w">XR16850</span><span class="c">",</span>	<span class="w">12</span><span class="pc">8</span><span class="c">,</span>	<span class="w">U</span><span class="pc">ART_C</span><span class="c">LEAR_FIFO</span> <span class="pc">|</span> <span class="c">UART_USE_FIFO</span> <span class="pc">|</span> <span class="pc">U</span><span class="c">ART_STARTECH</span> <span class="c">},</span>
	<span class="c">{ "</span><span class="w">RSA</span><span class="c">",</span>	<span class="w">2</span><span class="pc">0</span><span class="c">48,</span>	<span class="w">U</span><span class="pc">ART_C</span><span class="c">LEAR_FIFO</span> <span class="pc">|</span> <span class="c">UART_USE_FIFO</span> <span class="w">}</span>
<span class="c">};</span>

<span class="pc">str</span><span class="c">uct</span> <span class="w">uart_sunsu_port</span> <span class="c">{</span>
	<span class="c">struct</span> <span class="w">u</span><span class="pc">art_p</span><span class="c">ort</span>	<span class="w">p</span><span class="c">ort;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span>		<span class="w">acr</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="c">char</span>		<span class="w">ier</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">s</span><span class="c">hort</span>		<span class="w">rev</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="c">char</span>		<span class="w">lcr</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span>		<span class="w">lsr_break_flag</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="c">int</span>		<span class="w">cflag</span><span class="c">;</span>

	
	<span class="pc">e</span><span class="c">num</span> <span class="w">su_type</span>		<span class="c">su_type;</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span>		<span class="w">type_probed</span><span class="c">;</span>	
	<span class="c">unsigned</span> <span class="pc">l</span><span class="c">ong</span>		<span class="w">reg_size</span><span class="c">;</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIO</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">se</span><span class="c">rio</span>		<span class="w">ser</span><span class="pc">io;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">serio_open</span><span class="c">;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>
<span class="c">};</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">serial_in</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset)</span>
<span class="c">{</span>
	<span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">&lt;&lt;</span><span class="c">=</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">po</span><span class="pc">rt</span><span class="w">.regshift</span><span class="pc">;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">iotype</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">UPIO_HUB6</span><span class="c">:</span>
		<span class="w">o</span><span class="pc">utb</span><span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">hub6</span> <span class="w">-</span> <span class="c">1</span> <span class="w">+</span> <span class="w">o</span><span class="pc">ffs</span><span class="c">et</span><span class="w">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">io</span><span class="pc">b</span><span class="c">ase);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">i</span><span class="pc">n</span><span class="c">b(</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">i</span><span class="pc">ob</span><span class="c">ase</span> <span class="c">+</span> <span class="pc">1</span><span class="c">);</span>

	<span class="w">c</span><span class="c">ase</span> <span class="w">UPIO_MEM</span><span class="c">:</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">ea</span><span class="c">db(</span><span class="w">up</span><span class="c">-&gt;port</span><span class="pc">.</span><span class="w">me</span><span class="pc">mb</span><span class="c">ase</span> <span class="c">+</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">d</span><span class="pc">ef</span><span class="c">ault:</span>
		<span class="c">return</span> <span class="w">i</span><span class="pc">nb</span><span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">i</span><span class="c">obase</span> <span class="c">+</span> <span class="w">o</span><span class="pc">ffse</span><span class="c">t);</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">serial_out</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">offset,</span> <span class="c">int</span> <span class="c">value)</span>
<span class="c">{</span>
<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">CONFIG_SPARC64</span>
	
	<span class="pc">if</span> <span class="c">(</span><span class="pc">o</span><span class="c">ffset</span> <span class="pc">=</span><span class="c">=</span> <span class="w">UART_MCR</span><span class="c">)</span>
		<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_MCR_OUT2</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>
	<span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">&lt;</span><span class="c">&lt;=</span> <span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="w">.regshift;</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="w">.iotype</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">UPIO_HUB6</span><span class="c">:</span>
		<span class="w">o</span><span class="pc">utb</span><span class="c">(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">hub6</span> <span class="w">-</span> <span class="c">1</span> <span class="w">+</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">io</span><span class="pc">b</span><span class="c">ase</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">o</span><span class="c">utb(</span><span class="w">v</span><span class="pc">alu</span><span class="c">e,</span> <span class="w">up</span><span class="c">-&gt;port.</span><span class="w">i</span><span class="c">obase</span> <span class="pc">+</span> <span class="pc">1</span><span class="c">);</span>
		<span class="pc">b</span><span class="c">reak;</span>

	<span class="c">case</span> <span class="w">UPIO_MEM</span><span class="c">:</span>
		<span class="w">w</span><span class="pc">riteb</span><span class="c">(</span><span class="pc">valu</span><span class="c">e,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">m</span><span class="pc">emb</span><span class="c">ase</span> <span class="c">+</span> <span class="w">o</span><span class="c">ffset);</span>
		<span class="c">break;</span>

	<span class="pc">d</span><span class="c">efault:</span>
		<span class="pc">o</span><span class="c">utb(</span><span class="w">v</span><span class="c">alue,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">i</span><span class="c">obase</span> <span class="c">+</span> <span class="pc">o</span><span class="c">ffset);</span>
	<span class="pc">}</span>
<span class="pc">}</span>


<span class="pc">#d</span><span class="c">efine</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="pc">o</span><span class="c">ffset</span><span class="pc">)</span>		<span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="c">offset</span><span class="w">)</span>
<span class="w">#</span><span class="c">define</span> <span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="c">offset,</span> <span class="pc">v</span><span class="c">alue</span><span class="pc">)</span>	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="c">offset,</span> <span class="c">value)</span>



<span class="pc">st</span><span class="c">atic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">serial_icr_write</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">offset,</span> <span class="c">int</span> <span class="c">value)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">erial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_SCR</span><span class="c">,</span> <span class="pc">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">erial_out(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_ICR</span><span class="c">,</span> <span class="c">value);</span>
<span class="c">}</span>

<span class="w">#i</span><span class="pc">f</span> <span class="w">0</span> 
<span class="w">s</span><span class="pc">t</span><span class="c">atic</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">serial_icr_read</span><span class="c">(struct</span> <span class="c">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">valu</span><span class="c">e</span><span class="pc">;</span>

	<span class="w">serial_icr_write</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_ACR</span><span class="c">,</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">acr</span> <span class="w">|</span> <span class="w">UART_ACR_ICRRD</span><span class="c">);</span>
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_SCR</span><span class="c">,</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_ICR</span><span class="c">);</span>
	<span class="w">s</span><span class="c">erial_icr_write(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_ACR,</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;acr</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>
<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>

<span class="c">#ifdef</span> <span class="w">CONFIG_SERIAL_8250_RSA</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">__enable_rsa</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">esu</span><span class="c">lt;</span>

	<span class="w">mo</span><span class="pc">de</span> <span class="c">=</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_RSA_MSR</span><span class="c">);</span>
	<span class="w">r</span><span class="pc">es</span><span class="c">ult</span> <span class="c">=</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span> <span class="pc">&amp;</span> <span class="w">UART_RSA_MSR_FIFO</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">r</span><span class="pc">e</span><span class="c">sult</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_RSA_MSR,</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span> <span class="w">|</span> <span class="pc">UART_RSA_MSR_</span><span class="c">FIFO);</span>
		<span class="w">mo</span><span class="c">de</span> <span class="c">=</span> <span class="w">s</span><span class="pc">erial_i</span><span class="c">np</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_RSA_MSR);</span>
		<span class="w">r</span><span class="pc">es</span><span class="c">ult</span> <span class="c">=</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span> <span class="pc">&amp;</span> <span class="pc">UART_RSA_MSR_</span><span class="c">FIFO</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult</span><span class="pc">)</span>
		<span class="w">u</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">or</span><span class="c">t</span><span class="pc">.</span><span class="w">uartclk</span> <span class="c">=</span> <span class="w">SERIAL_RSA_BAUD_BASE</span> <span class="w">*</span> <span class="w">16</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">re</span><span class="c">sult;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">enable_rsa</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="w">.t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">==</span> <span class="w">PORT_RSA</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;port.</span><span class="w">u</span><span class="c">artclk</span> <span class="w">!</span><span class="c">=</span> <span class="pc">S</span><span class="c">ERIAL_RSA_BAUD_BASE</span> <span class="w">*</span> <span class="w">16</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">spin_l</span><span class="pc">ock_irq</span><span class="c">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock);</span>
			<span class="w">__enable_rsa</span><span class="c">(</span><span class="w">up</span><span class="c">);</span>
			<span class="w">sp</span><span class="pc">in_unlock_irq</span><span class="c">(&amp;</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock);</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.uartclk</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">S</span><span class="c">ERIAL_RSA_BAUD_BASE</span> <span class="w">*</span> <span class="w">16</span><span class="c">)</span>
			<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_RSA_FRR</span><span class="pc">,</span> <span class="c">0);</span>
	<span class="pc">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">disable_rsa</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult;</span>

	<span class="c">if</span> <span class="pc">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="c">type</span> <span class="c">==</span> <span class="w">PORT_RSA</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">uartclk</span> <span class="c">==</span> <span class="w">SERIAL_RSA_BAUD_BASE</span> <span class="w">*</span> <span class="w">1</span><span class="pc">6) </span><span class="c">{</span>
		<span class="w">spin_l</span><span class="pc">ock_irq</span><span class="c">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock);</span>

		<span class="w">mode</span> <span class="c">=</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_RSA_MSR</span><span class="c">);</span>
		<span class="w">r</span><span class="pc">es</span><span class="c">ult</span> <span class="w">= !(mo</span><span class="c">de</span> <span class="w">&amp;</span> <span class="w">UART_RSA_MSR_FIFO</span><span class="c">);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!r</span><span class="c">esult) {</span>
			<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_RSA_MSR,</span> <span class="w">m</span><span class="pc">o</span><span class="c">de</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">~</span><span class="pc">UART_RSA_MSR_</span><span class="c">FIFO);</span>
			<span class="w">mo</span><span class="c">de</span> <span class="c">=</span> <span class="pc">serial_i</span><span class="c">np(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_RSA_MSR);</span>
			<span class="w">r</span><span class="pc">es</span><span class="c">ult</span> <span class="w">=</span><span class="pc"> !</span><span class="c">(</span><span class="w">m</span><span class="c">ode</span> <span class="pc">&amp;</span> <span class="c">UART_RSA_MSR_FIFO);</span>
		<span class="pc">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">es</span><span class="c">ult)</span>
			<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">po</span><span class="pc">r</span><span class="c">t.</span><span class="w">uartclk</span> <span class="c">=</span> <span class="w">SERIAL_RSA_BAUD_BASE_LO</span> <span class="w">*</span> <span class="w">16</span><span class="c">;</span>
		<span class="w">spin_u</span><span class="pc">nlock_irq</span><span class="c">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock);</span>
	<span class="pc">}</span>
<span class="w">}</span>
<span class="pc">#</span><span class="c">endif</span> 

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">__stop_tx</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">p</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ier</span> <span class="w">&amp;</span> <span class="w">UART_IER_THRI</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">p</span><span class="c">-&gt;ier</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">U</span><span class="c">ART_IER_THRI;</span>
		<span class="w">serial_out</span><span class="c">(p,</span> <span class="w">UART_IER</span><span class="pc">,</span> <span class="c">p-&gt;ier);</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">sunsu_stop_tx</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">art_p</span><span class="c">ort</span> <span class="c">*</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="pc">c</span><span class="c">ontainer_of(</span><span class="w">p</span><span class="pc">o</span><span class="c">rt,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="pc">p</span><span class="c">ort);</span>

	<span class="w">__stop_tx</span><span class="c">(</span><span class="w">up</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;port</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="pc">=</span><span class="c">=</span> <span class="w">PORT_16C950</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">up</span><span class="c">-&gt;</span><span class="w">acr</span> <span class="w">|</span><span class="c">=</span> <span class="w">UART_ACR_TXDIS</span><span class="c">;</span>
		<span class="w">serial_icr_write</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_ACR</span><span class="pc">,</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;acr</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">sunsu_start_tx</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="w">p</span><span class="c">ort)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="c">container_of(</span><span class="w">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="w">p</span><span class="c">ort);</span>

	<span class="pc">if</span> <span class="pc">(!(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">ier</span> <span class="pc">&amp;</span> <span class="w">UART_IER_THRI))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">up</span><span class="c">-&gt;ier</span> <span class="pc">|</span><span class="c">=</span> <span class="c">UART_IER_THRI;</span>
		<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;ier</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_16C950</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">acr</span> <span class="w">&amp;</span> <span class="w">UART_ACR_TXDIS</span><span class="c">) {</span>
		<span class="w">u</span><span class="c">p-&gt;</span><span class="pc">a</span><span class="c">cr</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">U</span><span class="c">ART_ACR_TXDIS;</span>
		<span class="w">serial_icr_write</span><span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">,</span> <span class="w">UART_ACR</span><span class="c">,</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">a</span><span class="c">cr);</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">sunsu_stop_rx</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="w">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="c">container_of(</span><span class="pc">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="w">p</span><span class="c">ort);</span>

	<span class="w">up</span><span class="c">-&gt;</span><span class="w">ier</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">UART_IER_RLSI</span><span class="c">;</span>
	<span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">read_status_mask</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">UART_LSR_DR</span><span class="c">;</span>
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">i</span><span class="c">er</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">sunsu_enable_ms</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">art_p</span><span class="c">ort</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">u</span><span class="c">art_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="c">container_of(</span><span class="pc">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="c">port);</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="c">spin_lock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ier</span> <span class="w">|</span><span class="c">=</span> <span class="w">UART_IER_MSI</span><span class="c">;</span>
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;ier</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">sp</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">receive_chars</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="pc">*</span><span class="w">s</span><span class="pc">t</span><span class="c">atus)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">tty_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">s</span><span class="pc">tate-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">ort;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">c</span><span class="pc">h</span><span class="w">,</span> <span class="w">fl</span><span class="pc">ag;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">max_count</span> <span class="c">=</span> <span class="w">2</span><span class="pc">5</span><span class="c">6;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">saw_console_brk</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="w">c</span><span class="pc">h</span> <span class="c">=</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_RX</span><span class="c">);</span>
		<span class="w">fl</span><span class="c">ag</span> <span class="c">=</span> <span class="w">TTY_NORMAL</span><span class="pc">;</span>
		<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">icount.r</span><span class="pc">x</span><span class="w">+</span><span class="c">+;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="c">nlikely</span><span class="w">(</span><span class="pc">*</span><span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">UART_LSR_BI</span> <span class="pc">|</span> <span class="w">UART_LSR_PE</span> <span class="w">|</span>
				       <span class="w">UART_LSR_FE</span> <span class="pc">|</span> <span class="w">UART_LSR_OE)</span><span class="pc">))</span><span class="c"> {</span>
			
			<span class="c">if</span> <span class="pc">(*s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">U</span><span class="pc">ART_L</span><span class="c">SR_BI</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">*s</span><span class="c">tatus</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">U</span><span class="pc">ART_LSR_F</span><span class="c">E</span> <span class="pc">|</span> <span class="pc">UART_LSR_P</span><span class="c">E);</span>
				<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">i</span><span class="c">count</span><span class="pc">.</span><span class="w">brk</span><span class="pc">+</span><span class="c">+;</span>
				<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">cons</span> <span class="w">!</span><span class="c">=</span> <span class="w">N</span><span class="c">ULL</span> <span class="w">&amp;</span><span class="c">&amp;</span>
				    <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span> <span class="pc">=</span><span class="c">=</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;port.</span><span class="pc">c</span><span class="c">ons</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">nd</span><span class="c">ex</span><span class="w">)</span>
					<span class="w">saw_console_brk</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
				
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_handle_break</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;port</span><span class="pc">)</span><span class="c">)</span>
					<span class="c">goto</span> <span class="w">ignore_char</span><span class="c">;</span>
			<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(*</span><span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_PE</span><span class="pc">)</span>
				<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">icount</span><span class="pc">.</span><span class="w">parity+</span><span class="c">+;</span>
			<span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(*st</span><span class="c">atus</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_FE</span><span class="pc">)</span>
				<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">i</span><span class="c">count.</span><span class="w">fr</span><span class="pc">a</span><span class="c">me</span><span class="w">+</span><span class="c">+;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(*</span><span class="c">status</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_OE</span><span class="pc">)</span>
				<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="pc">i</span><span class="c">count.</span><span class="w">overrun</span><span class="pc">+</span><span class="c">+;</span>

			
			<span class="w">*</span><span class="c">status</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">read_status_mask</span><span class="pc">;</span>

			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">cons</span> <span class="w">!</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL</span> <span class="w">&amp;</span><span class="c">&amp;</span>
			    <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span> <span class="pc">=</span><span class="c">=</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;port.cons</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">nd</span><span class="c">ex</span><span class="pc">)</span><span class="c"> {</span>
				
				<span class="w">*s</span><span class="c">tatus</span> <span class="w">|</span><span class="c">=</span> <span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">lsr_break_flag</span><span class="c">;</span>
				<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">sr_break_flag</span> <span class="pc">=</span> <span class="c">0;</span>
			<span class="c">}</span>

			<span class="pc">i</span><span class="c">f</span> <span class="w">(*s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_BI</span><span class="c">) {</span>
				<span class="w">fl</span><span class="pc">ag</span> <span class="c">=</span> <span class="w">TTY_BREAK</span><span class="pc">;</span>
			<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(*s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_PE</span><span class="pc">)</span>
				<span class="w">f</span><span class="pc">lag</span> <span class="pc">=</span> <span class="w">TTY_PARITY</span><span class="c">;</span>
			<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(*s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_FE</span><span class="pc">)</span>
				<span class="w">f</span><span class="pc">lag</span> <span class="c">=</span> <span class="w">TTY_FRAME</span><span class="c">;</span>
		<span class="pc">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_handle_sysrq_char(</span><span class="pc">&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">,</span> <span class="w">ch</span><span class="pc">))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">ignore_char</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="w">((*</span><span class="pc">s</span><span class="c">tatus</span> <span class="c">&amp;</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">ignore_status_mask) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
			<span class="w">tty_insert_flip_char</span><span class="c">(port</span><span class="pc">,</span> <span class="w">ch</span><span class="c">,</span> <span class="w">fl</span><span class="pc">ag</span><span class="c">);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="w">(*</span><span class="pc">s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_OE</span><span class="pc">)</span>
			
			 <span class="w">t</span><span class="c">ty_insert_flip_char(port,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">TTY_OVERRUN</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">gnore_c</span><span class="c">har</span><span class="w">:</span>
		<span class="w">*</span><span class="c">status</span> <span class="pc">=</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="pc">w</span><span class="c">hile</span> <span class="w">((*s</span><span class="pc">tatu</span><span class="c">s</span> <span class="pc">&amp;</span> <span class="w">UART_LSR_DR) &amp;</span><span class="pc">&amp; </span><span class="c">(</span><span class="w">max_count-- &gt;</span> <span class="w">0))</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">saw_console_brk</span><span class="pc">)</span>
		<span class="w">sun_do_break</span><span class="pc">()</span><span class="c">;</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">transmit_chars</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">circ_buf</span> <span class="c">*</span><span class="w">xmit</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">po</span><span class="c">rt</span><span class="pc">.</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">x</span><span class="c">mit;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">x_char</span><span class="c">) {</span>
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_TX</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">x_char);</span>
		<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">icount</span><span class="pc">.</span><span class="w">t</span><span class="pc">x</span><span class="w">+</span><span class="c">+;</span>
		<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="pc">x</span><span class="c">_char</span> <span class="pc">=</span> <span class="c">0;</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_tx_stopped</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">sunsu_stop_tx</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_circ_empty</span><span class="c">(</span><span class="w">xmit</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">__stop_tx</span><span class="c">(</span><span class="w">up</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="c">=</span> <span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">fifosize</span><span class="c">;</span>
	<span class="w">d</span><span class="c">o</span> <span class="c">{</span>
		<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_TX</span><span class="pc">,</span> <span class="c">xmit</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b</span><span class="c">uf</span><span class="pc">[</span><span class="w">x</span><span class="c">mit</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="pc">a</span><span class="c">il]);</span>
		<span class="pc">x</span><span class="c">mit</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="pc">a</span><span class="c">il</span> <span class="w">=</span><span class="pc"> </span><span class="c">(xmit-&gt;</span><span class="w">t</span><span class="c">ail</span> <span class="c">+</span> <span class="c">1</span><span class="w">) &amp;</span><span class="pc"> (</span><span class="w">UART_XMIT_SIZE</span> <span class="pc">-</span> <span class="c">1</span><span class="pc">);</span>
		<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">icount.tx+</span><span class="pc">+</span><span class="c">;</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_circ_empty</span><span class="c">(xmit</span><span class="w">)</span><span class="pc">)</span>
			<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">(-</span><span class="c">-</span><span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="c">&gt;</span> <span class="c">0</span><span class="pc">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_circ_chars_pending</span><span class="c">(xmit</span><span class="w">)</span><span class="pc"> </span><span class="c">&lt;</span> <span class="w">WAKEUP_CHARS</span><span class="pc">)</span>
		<span class="w">uart_write_wakeup</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">art_circ_e</span><span class="c">mpty</span><span class="pc">(</span><span class="c">xmit</span><span class="pc">))</span>
		<span class="w">__stop_tx</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">check_modem_status</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">s</span><span class="c">tatus;</span>

	<span class="w">s</span><span class="pc">ta</span><span class="c">tus</span> <span class="c">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_MSR</span><span class="c">);</span>

	<span class="c">if</span> <span class="pc">((</span><span class="c">status</span> <span class="c">&amp;</span> <span class="w">UART_MSR_ANY_DELTA</span><span class="c">) ==</span> <span class="c">0</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(status</span> <span class="c">&amp;</span> <span class="w">UART_MSR_TERI</span><span class="c">)</span>
		<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">icount</span><span class="c">.</span><span class="w">rng+</span><span class="c">+;</span>
	<span class="c">if</span> <span class="c">(status</span> <span class="c">&amp;</span> <span class="w">UART_MSR_DDSR</span><span class="c">)</span>
		<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.icount.</span><span class="w">dsr</span><span class="pc">+</span><span class="c">+;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span> <span class="c">&amp;</span> <span class="w">UART_MSR_DDCD</span><span class="c">)</span>
		<span class="w">uart_handle_dcd_change</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">,</span> <span class="c">status</span> <span class="pc">&amp;</span> <span class="w">UART_MSR_DCD</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(status</span> <span class="c">&amp;</span> <span class="w">UART_MSR_DCTS</span><span class="pc">)</span>
		<span class="w">uart_handle_cts_change</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort,</span> <span class="c">status</span> <span class="pc">&amp;</span> <span class="w">UART_MSR_CTS</span><span class="c">);</span>

	<span class="w">wake_up_interruptible</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">s</span><span class="pc">tate-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">delta_msr_wait</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="w">i</span><span class="pc">r</span><span class="c">qreturn_t</span> <span class="w">sunsu_serial_interrupt</span><span class="c">(int</span> <span class="c">irq,</span> <span class="c">void</span> <span class="c">*dev_id)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span> <span class="c">dev_id;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">c</span><span class="c">har</span> <span class="w">s</span><span class="c">tatus;</span>

	<span class="c">spin_lock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">atus</span> <span class="c">=</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR</span><span class="c">);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(status</span> <span class="c">&amp;</span> <span class="w">UART_LSR_DR</span><span class="pc">)</span>
			<span class="w">receive_chars</span><span class="c">(</span><span class="w">up</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">s</span><span class="c">tatus);</span>
		<span class="w">check_modem_status</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(status</span> <span class="c">&amp;</span> <span class="w">UART_LSR_THRE</span><span class="pc">)</span>
			<span class="w">transmit_chars</span><span class="c">(</span><span class="w">up</span><span class="c">);</span>

		<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>

		<span class="w">tty_flip_buffer_push</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">s</span><span class="pc">tate</span><span class="w">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort);</span>

		<span class="w">s</span><span class="pc">pin_l</span><span class="c">ock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="pc">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">(!(</span><span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IIR) </span><span class="pc">&amp;</span> <span class="w">UART_IIR_NO_INT</span><span class="pc">))</span><span class="c">;</span>

	<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock,</span> <span class="c">flags);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">I</span><span class="c">RQ_HANDLED;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="c">void</span>
<span class="w">sunsu_change_speed</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*port,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">cflag</span><span class="c">,</span>
		   <span class="c">unsigned</span> <span class="c">int</span> <span class="w">iflag</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="c">int</span> <span class="w">quot</span><span class="pc">);</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">sunsu_change_mouse_baud</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cur_cflag</span> <span class="c">=</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">cf</span><span class="c">lag;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">q</span><span class="c">uot</span><span class="pc">,</span> <span class="w">new_baud</span><span class="c">;</span>

	<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">flag</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">CBAUD</span><span class="c">;</span>
	<span class="w">up</span><span class="c">-&gt;</span><span class="pc">cf</span><span class="c">lag</span> <span class="pc">|</span><span class="c">=</span> <span class="w">suncore_mouse_baud_cflag_next</span><span class="pc">(</span><span class="c">cur_cflag</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">n</span><span class="c">ew_baud);</span>

	<span class="pc">q</span><span class="c">uot</span> <span class="pc">=</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">uartclk</span> <span class="w">/ (1</span><span class="pc">6</span> <span class="pc">*</span> <span class="w">n</span><span class="c">ew_baud</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">sunsu_change_speed</span><span class="pc">(&amp;</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">,</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">c</span><span class="c">flag</span><span class="pc">,</span> <span class="pc">0,</span> <span class="w">q</span><span class="c">uot</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">receive_kbd_ms_chars</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">is_break</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="pc">u</span><span class="c">nsigned</span> <span class="c">char</span> <span class="w">c</span><span class="pc">h</span> <span class="pc">=</span> <span class="w">serial_inp</span><span class="pc">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_RX</span><span class="pc">)</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">su_type</span> <span class="c">==</span> <span class="w">SU_PORT_KBD</span><span class="c">) {</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIO</span>
			<span class="w">serio_interrupt</span><span class="pc">(&amp;</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">ser</span><span class="pc">io</span><span class="c">,</span> <span class="w">ch</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
<span class="pc">#</span><span class="c">endif</span>
		<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;su_type</span> <span class="c">==</span> <span class="w">SU_PORT_MS</span><span class="c">) {</span>
			<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">r</span><span class="pc">e</span><span class="c">t</span> <span class="c">=</span> <span class="w">suncore_mouse_baud_detection</span><span class="c">(</span><span class="w">c</span><span class="pc">h,</span> <span class="w">is_break</span><span class="c">);</span>

			<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">) {</span>
			<span class="c">case</span> <span class="w">2</span><span class="c">:</span>
				<span class="w">sunsu_change_mouse_baud</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>
				
			<span class="pc">c</span><span class="c">ase</span> <span class="c">1:</span>
				<span class="w">b</span><span class="c">reak;</span>

			<span class="c">case</span> <span class="pc">0</span><span class="c">:</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_SERIO</span>
				<span class="w">serio_interrupt(</span><span class="pc">&amp;</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">ser</span><span class="pc">io</span><span class="c">,</span> <span class="w">ch</span><span class="c">,</span> <span class="c">0);</span>
<span class="pc">#</span><span class="c">endif</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="pc">}</span>
		<span class="pc">}</span>
	<span class="w">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR) </span><span class="pc">&amp;</span> <span class="w">UART_LSR_DR</span><span class="pc">);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">ir</span><span class="c">qreturn_t</span> <span class="w">sunsu_kbd_ms_interrupt</span><span class="c">(int</span> <span class="c">irq,</span> <span class="c">void</span> <span class="c">*dev_id)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span> <span class="c">dev_id;</span>

	<span class="pc">if</span> <span class="pc">(!(</span><span class="w">s</span><span class="c">erial_in</span><span class="w">(up</span><span class="c">,</span> <span class="w">UART_IIR</span><span class="pc">) &amp;</span> <span class="w">UART_IIR_NO_INT</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">c</span><span class="c">har</span> <span class="w">s</span><span class="c">tatus</span> <span class="pc">=</span> <span class="w">serial_inp</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR</span><span class="c">);</span>

		<span class="c">if</span> <span class="pc">((</span><span class="c">status</span> <span class="c">&amp;</span> <span class="w">UART_LSR_DR) |</span><span class="pc">| </span><span class="c">(status</span> <span class="c">&amp;</span> <span class="w">UART_LSR_BI</span><span class="c">))</span>
			<span class="w">receive_kbd_ms_chars</span><span class="c">(</span><span class="w">up,</span><span class="pc"> (</span><span class="c">status</span> <span class="c">&amp;</span> <span class="w">U</span><span class="pc">ART_LSR_B</span><span class="c">I</span><span class="w">) </span><span class="pc">!</span><span class="c">=</span> <span class="c">0);</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">I</span><span class="c">RQ_HANDLED;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">sunsu_tx_empty</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="pc">c</span><span class="c">ontainer_of(</span><span class="w">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="pc">p</span><span class="c">ort);</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">et</span><span class="c">;</span>

	<span class="c">spin_lock_irqsave(&amp;</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.l</span><span class="c">ock,</span> <span class="c">flags);</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR)</span><span class="pc"> &amp;</span> <span class="w">UART_LSR_TEMT</span> <span class="w">?</span> <span class="w">TIOCSER_TEMT</span> <span class="c">:</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock,</span> <span class="c">flags);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">sunsu_get_mctrl</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="w">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="pc">c</span><span class="c">ontainer_of(</span><span class="pc">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="pc">p</span><span class="c">ort);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">s</span><span class="pc">tat</span><span class="c">us;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">et</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">ta</span><span class="c">tus</span> <span class="c">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_MSR</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">UART_MSR_DCD</span><span class="pc">)</span>
		<span class="pc">ret</span> <span class="pc">|</span><span class="c">=</span> <span class="w">TIOCM_CAR</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span> <span class="c">&amp;</span> <span class="w">UART_MSR_RI</span><span class="pc">)</span>
		<span class="pc">ret</span> <span class="c">|=</span> <span class="w">TIOCM_RNG</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span> <span class="c">&amp;</span> <span class="w">UART_MSR_DSR</span><span class="c">)</span>
		<span class="c">ret</span> <span class="c">|=</span> <span class="w">TIOCM_DSR</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span> <span class="c">&amp;</span> <span class="w">UART_MSR_CTS</span><span class="c">)</span>
		<span class="c">ret</span> <span class="c">|=</span> <span class="w">TIOCM_CTS</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">sunsu_set_mctrl</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="w">p</span><span class="pc">o</span><span class="c">rt,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">mctrl</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="pc">c</span><span class="c">ontainer_of(</span><span class="w">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="w">p</span><span class="c">ort);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">mcr</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">m</span><span class="c">ctrl</span> <span class="w">&amp;</span> <span class="w">TIOCM_RTS</span><span class="c">)</span>
		<span class="w">m</span><span class="pc">cr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_MCR_RTS</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">mct</span><span class="c">rl</span> <span class="pc">&amp;</span> <span class="w">TIOCM_DTR</span><span class="c">)</span>
		<span class="pc">mcr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_MCR_DTR</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(mctrl</span> <span class="c">&amp;</span> <span class="w">TIOCM_OUT1</span><span class="c">)</span>
		<span class="c">mcr</span> <span class="c">|=</span> <span class="w">UART_MCR_OUT1</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(mctrl</span> <span class="c">&amp;</span> <span class="w">TIOCM_OUT2</span><span class="c">)</span>
		<span class="c">mcr</span> <span class="c">|=</span> <span class="w">UART_MCR_OUT2</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(mctrl</span> <span class="c">&amp;</span> <span class="w">TIOCM_LOOP</span><span class="c">)</span>
		<span class="c">mcr</span> <span class="c">|=</span> <span class="w">UART_MCR_LOOP</span><span class="c">;</span>

	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_MCR</span><span class="pc">,</span> <span class="c">mcr);</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">sunsu_break_ctl</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="w">p</span><span class="pc">o</span><span class="c">rt,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">break_state</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="pc">c</span><span class="c">ontainer_of(</span><span class="w">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="w">p</span><span class="c">ort);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="c">spin_lock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">b</span><span class="c">reak_state</span> <span class="w">=</span><span class="pc">= </span><span class="c">-1</span><span class="pc">)</span>
		<span class="w">up</span><span class="c">-&gt;</span><span class="w">lcr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_LCR_SBC</span><span class="c">;</span>
	<span class="c">else</span>
		<span class="w">up</span><span class="c">-&gt;lcr</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="pc">U</span><span class="c">ART_LCR_SBC;</span>
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="c">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">cr);</span>
	<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span> <span class="w">sunsu_startup</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="c">container_of(</span><span class="w">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="pc">p</span><span class="c">ort);</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="w">.t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_16C950</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">up</span><span class="c">-&gt;</span><span class="w">acr</span> <span class="c">=</span> <span class="c">0;</span>
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="pc">,</span> <span class="w">0xBF</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_EFR</span><span class="c">,</span> <span class="w">UART_EFR_ECB</span><span class="c">);</span>
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="c">,</span> <span class="c">0);</span>
		<span class="c">serial_outp(</span><span class="w">u</span><span class="pc">p</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_LCR,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="w">serial_icr_write</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_CSR</span><span class="c">,</span> <span class="c">0);</span> 
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">UART_L</span><span class="c">CR,</span> <span class="w">0</span><span class="pc">x</span><span class="c">BF);</span>
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_EFR</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_EFR_</span><span class="c">ECB);</span>
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_LCR,</span> <span class="c">0);</span>
	<span class="pc">}</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIAL_8250_RSA</span>
	
	<span class="w">enable_rsa</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span>

	
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_config[up-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="w">]</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UART_CLEAR_FIFO</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">rial_outp</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_FCR</span><span class="c">,</span> <span class="w">UART_FCR_ENABLE_FIFO</span><span class="c">);</span>
		<span class="w">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_FCR,</span> <span class="c">UART_FCR_ENABLE_FIFO</span> <span class="w">|</span>
				<span class="w">UART_FCR_CLEAR_RCVR</span> <span class="pc">|</span> <span class="w">UART_FCR_CLEAR_XMIT</span><span class="c">);</span>
		<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_FCR,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="c">}</span>

	
	<span class="w">(</span><span class="pc">v</span><span class="c">oid)</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR</span><span class="c">);</span>
	<span class="w">(</span><span class="c">void)</span> <span class="w">s</span><span class="c">erial_inp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_RX</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">(</span><span class="c">void)</span> <span class="pc">s</span><span class="c">erial_inp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IIR</span><span class="c">);</span>
	<span class="w">(</span><span class="c">void)</span> <span class="pc">s</span><span class="c">erial_inp(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_MSR</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="w">.</span><span class="c">flags</span> <span class="c">&amp;</span> <span class="w">UPF_BUGGY_UART</span><span class="pc">) &amp;</span><span class="c">&amp;</span>
	    <span class="c">(</span><span class="pc">s</span><span class="c">erial_inp</span><span class="pc">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_LSR)</span><span class="pc"> =</span><span class="c">=</span> <span class="w">0x</span><span class="pc">f</span><span class="c">f</span><span class="pc">))</span><span class="c"> {</span>
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">ttyS</span><span class="pc">%d:</span> <span class="w">LSR</span> <span class="w">safety</span> <span class="w">ch</span><span class="pc">e</span><span class="c">ck</span> <span class="w">engaged!</span><span class="c">\n</span><span class="pc">",</span> <span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">li</span><span class="pc">n</span><span class="c">e);</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">su_type</span> <span class="pc">!</span><span class="c">=</span> <span class="w">SU_PORT_PORT</span><span class="c">) {</span>
		<span class="w">r</span><span class="pc">etv</span><span class="c">al</span> <span class="c">=</span> <span class="pc">r</span><span class="c">equest_irq(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">i</span><span class="pc">r</span><span class="c">q,</span> <span class="w">sunsu_kbd_ms_interrupt</span><span class="c">,</span>
				     <span class="w">IRQF_SHARED</span><span class="c">,</span> <span class="w">su_typev[up</span><span class="pc">-</span><span class="c">&gt;su_type</span><span class="w">]</span><span class="pc">,</span> <span class="w">up</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="pc">r</span><span class="c">etval</span> <span class="c">=</span> <span class="w">r</span><span class="c">equest_irq(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">i</span><span class="pc">r</span><span class="c">q,</span> <span class="w">sunsu_serial_interrupt</span><span class="c">,</span>
				     <span class="w">I</span><span class="c">RQF_SHARED,</span> <span class="w">s</span><span class="pc">u_typev</span><span class="w">[up</span><span class="pc">-</span><span class="c">&gt;su_type</span><span class="w">]</span><span class="pc">,</span> <span class="w">up</span><span class="c">);</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">etval) {</span>
		<span class="pc">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">su</span><span class="c">:</span> <span class="pc">C</span><span class="c">annot</span> <span class="pc">r</span><span class="c">egister</span> <span class="w">I</span><span class="pc">R</span><span class="c">Q</span> <span class="pc">%</span><span class="c">d\n",</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">i</span><span class="pc">r</span><span class="c">q);</span>
		<span class="c">return</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al;</span>
	<span class="c">}</span>

	
	<span class="w">serial_outp</span><span class="pc">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_LCR</span><span class="pc">,</span> <span class="w">UART_LCR_WLEN8</span><span class="c">);</span>

	<span class="w">sp</span><span class="pc">in_lock_ir</span><span class="c">qsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;port.</span><span class="w">mctrl</span> <span class="w">|</span><span class="c">=</span> <span class="w">TIOCM_OUT2</span><span class="c">;</span>

	<span class="w">sunsu_set_mctrl</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">,</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;port</span><span class="pc">.m</span><span class="c">ctrl);</span>
	<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>

	
	<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">ier</span> <span class="pc">=</span> <span class="w">UART_IER_RLSI</span> <span class="pc">|</span> <span class="w">UART_IER_RDI</span><span class="pc">;</span>
	<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="c">,</span> <span class="w">up</span><span class="c">-&gt;ier);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UPF_FOURPORT</span><span class="c">) {</span>
		<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">icp</span><span class="c">;</span>
		
		<span class="w">i</span><span class="pc">c</span><span class="c">p</span> <span class="pc">= </span><span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">io</span><span class="pc">b</span><span class="c">ase</span> <span class="w">&amp;</span> <span class="w">0xfe0) |</span> <span class="w">0x01f</span><span class="c">;</span>
		<span class="w">outb_p</span><span class="c">(</span><span class="w">0x8</span><span class="c">0,</span> <span class="c">icp</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">(v</span><span class="c">oid)</span> <span class="w">inb_p</span><span class="c">(</span><span class="pc">i</span><span class="c">cp);</span>
	<span class="c">}</span>

	
	<span class="w">(</span><span class="pc">v</span><span class="c">oid)</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_LSR</span><span class="c">);</span>
	<span class="w">(</span><span class="pc">v</span><span class="c">oid)</span> <span class="pc">s</span><span class="c">erial_inp(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_RX</span><span class="c">);</span>
	<span class="w">(</span><span class="c">void)</span> <span class="pc">s</span><span class="c">erial_inp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IIR</span><span class="c">);</span>
	<span class="w">(</span><span class="c">void)</span> <span class="pc">s</span><span class="c">erial_inp(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_MSR</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">sunsu_shutdown</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="c">container_of(</span><span class="w">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="w">p</span><span class="c">ort);</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	
	<span class="w">up</span><span class="c">-&gt;</span><span class="w">ier</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="c">,</span> <span class="c">0);</span>

	<span class="w">s</span><span class="pc">pin_l</span><span class="c">ock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock,</span> <span class="c">flags);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UPF_FOURPORT</span><span class="c">) {</span>
		
		<span class="w">inb</span><span class="pc">((</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">io</span><span class="pc">b</span><span class="c">ase</span> <span class="w">&amp;</span> <span class="w">0xfe0) </span><span class="pc">|</span> <span class="w">0x1</span><span class="pc">f)</span><span class="c">;</span>
		<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;port.</span><span class="w">mctrl</span> <span class="pc">|</span><span class="c">=</span> <span class="w">TIOCM_OUT1</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span>
		<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="pc">m</span><span class="c">ctrl</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">TIOCM_OUT2</span><span class="c">;</span>

	<span class="w">sunsu_set_mctrl</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;port</span><span class="pc">.</span><span class="w">m</span><span class="c">ctrl</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>

	
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="pc">,</span> <span class="w">serial_inp</span><span class="pc">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">U</span><span class="c">ART_LCR</span><span class="w">) &amp;</span><span class="c"> ~</span><span class="w">UART_LCR_SBC</span><span class="c">);</span>
	<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_FCR</span><span class="c">,</span> <span class="w">UART_FCR_ENABLE_FIFO</span> <span class="pc">|</span>
				  <span class="w">UART_FCR_CLEAR_RCVR</span> <span class="c">|</span>
				  <span class="w">UART_FCR_CLEAR_XMIT</span><span class="c">);</span>
	<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">UART_F</span><span class="c">CR,</span> <span class="w">0</span><span class="c">);</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_SERIAL_8250_RSA</span>
	
	<span class="w">disable_rsa</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>
<span class="c">#endif</span>

	
	<span class="w">(</span><span class="pc">v</span><span class="c">oid)</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_RX</span><span class="c">);</span>

	<span class="w">f</span><span class="pc">r</span><span class="c">ee_irq(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">i</span><span class="c">rq,</span> <span class="w">up</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">sunsu_change_speed</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cflag</span><span class="pc">,</span>
		   <span class="c">unsigned</span> <span class="c">int</span> <span class="w">iflag</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="c">int</span> <span class="w">quot</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="pc">c</span><span class="c">ontainer_of(</span><span class="pc">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="w">p</span><span class="c">ort);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">cval</span><span class="pc">,</span> <span class="w">fcr</span> <span class="w">=</span> <span class="c">0;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">c</span><span class="pc">f</span><span class="c">lag</span> <span class="pc">&amp;</span> <span class="w">CSIZE</span><span class="c">) {</span>
	<span class="c">case</span> <span class="w">CS5</span><span class="c">:</span>
		<span class="pc">cv</span><span class="c">al</span> <span class="c">=</span> <span class="w">0</span><span class="pc">x0</span><span class="c">0;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">CS6</span><span class="c">:</span>
		<span class="c">cval</span> <span class="c">=</span> <span class="w">0</span><span class="pc">x</span><span class="c">01;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">CS7</span><span class="c">:</span>
		<span class="pc">cv</span><span class="c">al</span> <span class="c">=</span> <span class="w">0x0</span><span class="pc">2</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
	<span class="w">c</span><span class="pc">a</span><span class="c">se</span> <span class="w">CS8</span><span class="c">:</span>
		<span class="c">cval</span> <span class="c">=</span> <span class="w">0x0</span><span class="pc">3</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cflag</span> <span class="w">&amp;</span> <span class="w">CSTOPB</span><span class="pc">)</span>
		<span class="pc">cv</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="w">0x</span><span class="pc">04</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(cflag</span> <span class="pc">&amp;</span> <span class="w">PARENB</span><span class="c">)</span>
		<span class="c">cval</span> <span class="c">|=</span> <span class="w">UART_LCR_PARITY</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!(</span><span class="c">cflag</span> <span class="c">&amp;</span> <span class="w">PARODD</span><span class="c">))</span>
		<span class="w">c</span><span class="pc">v</span><span class="c">al</span> <span class="c">|=</span> <span class="w">UART_LCR_EPAR</span><span class="c">;</span>
<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CMSPAR</span>
	<span class="c">if</span> <span class="c">(cflag</span> <span class="c">&amp;</span> <span class="w">C</span><span class="pc">M</span><span class="c">SPAR)</span>
		<span class="pc">c</span><span class="c">val</span> <span class="c">|=</span> <span class="w">UART_LCR_SPAR</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">quot</span> <span class="c">&amp;</span> <span class="w">0xf</span><span class="pc">f</span><span class="c">) ==</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_16C950</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">up</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">ev</span> <span class="pc">=</span><span class="c">=</span> <span class="w">0x5201</span><span class="pc">)</span>
		<span class="c">quot</span> <span class="pc">+</span><span class="c">+;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">uart_config[u</span><span class="pc">p</span><span class="w">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span><span class="w">]</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UART_USE_FIFO</span><span class="c">) {</span>
		<span class="c">if</span> <span class="pc">((</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">uartclk</span> <span class="w">/</span> <span class="pc">q</span><span class="c">uot</span><span class="w">) &lt; (2400</span> <span class="w">*</span> <span class="w">1</span><span class="pc">6</span><span class="c">))</span>
			<span class="w">fcr</span> <span class="pc">=</span> <span class="w">UART_FCR_ENABLE_FIFO</span> <span class="pc">|</span> <span class="w">UART_FCR_TRIGGER_1</span><span class="c">;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIAL_8250_RSA</span>
		<span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="c">if</span> <span class="c">(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_RSA</span><span class="c">)</span>
			<span class="c">fcr</span> <span class="c">=</span> <span class="pc">U</span><span class="c">ART_FCR_ENABLE_FIFO</span> <span class="w">|</span> <span class="w">UART_FCR_TRIGGER_14</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="pc">f</span><span class="c">cr</span> <span class="c">=</span> <span class="pc">U</span><span class="c">ART_FCR_ENABLE_FIFO</span> <span class="w">|</span> <span class="w">UART_FCR_TRIGGER_8</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_16750</span><span class="c">)</span>
		<span class="pc">f</span><span class="c">cr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_FCR7_64BYTE</span><span class="c">;</span>

	
	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>

	
	<span class="w">uart_update_timeout</span><span class="c">(port</span><span class="pc">,</span> <span class="w">cflag,</span><span class="pc"> (</span><span class="w">p</span><span class="c">ort-&gt;</span><span class="w">uartclk</span> <span class="w">/ (1</span><span class="pc">6</span> <span class="w">*</span> <span class="w">quot))</span><span class="pc">);</span>

	<span class="w">up</span><span class="pc">-</span><span class="c">&gt;port</span><span class="pc">.</span><span class="w">read_status_mask</span> <span class="c">=</span> <span class="w">UART_LSR_OE</span> <span class="pc">|</span> <span class="w">UART_LSR_THRE</span> <span class="pc">|</span> <span class="w">UART_LSR_DR</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">iflag</span> <span class="w">&amp;</span> <span class="w">INPCK</span><span class="c">)</span>
		<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="pc">r</span><span class="c">ead_status_mask</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_LSR_FE</span> <span class="pc">|</span> <span class="w">UART_LSR_PE</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="c">flag</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">IGNBRK</span> <span class="c">|</span> <span class="w">BRKINT</span> <span class="c">|</span> <span class="w">PARMRK</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="pc">r</span><span class="c">ead_status_mask</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_LSR_BI</span><span class="c">;</span>

	
	<span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">ignore_status_mask</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="c">flag</span> <span class="pc">&amp;</span> <span class="w">IGNPAR</span><span class="c">)</span>
		<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="pc">i</span><span class="c">gnore_status_mask</span> <span class="pc">|</span><span class="c">=</span> <span class="w">U</span><span class="pc">ART_LSR_P</span><span class="c">E</span> <span class="pc">|</span> <span class="w">UART_LSR_FE</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="pc">f</span><span class="c">lag</span> <span class="pc">&amp;</span> <span class="w">IGNBRK</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="pc">i</span><span class="c">gnore_status_mask</span> <span class="pc">|</span><span class="c">=</span> <span class="w">U</span><span class="pc">ART_LSR_B</span><span class="c">I;</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(iflag</span> <span class="pc">&amp;</span> <span class="pc">I</span><span class="c">GNPAR</span><span class="pc">)</span>
			<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="pc">i</span><span class="c">gnore_status_mask</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_LSR_OE</span><span class="c">;</span>
	<span class="pc">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">cflag</span> <span class="c">&amp;</span> <span class="w">CREAD</span><span class="c">) ==</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="pc">i</span><span class="c">gnore_status_mask</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UART_LSR_DR</span><span class="c">;</span>

	
	<span class="w">up</span><span class="c">-&gt;</span><span class="w">ier</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">UART_IER_MSI</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">UART_ENABLE_MS(</span><span class="pc">&amp;</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort,</span> <span class="pc">c</span><span class="c">flag</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;ier</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">U</span><span class="c">ART_IER_MSI;</span>

	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="pc">,</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;ier);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uart_config[u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span><span class="w">]</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UART_STARTECH</span><span class="c">) {</span>
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="c">,</span> <span class="w">0xBF</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_EFR</span><span class="c">,</span> <span class="w">cflag</span> <span class="w">&amp;</span> <span class="w">CRTSCTS</span> <span class="w">?</span> <span class="w">UART_EFR_CTS</span> <span class="c">:0);</span>
	<span class="c">}</span>
	<span class="w">se</span><span class="c">rial_outp</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_L</span><span class="c">CR,</span> <span class="w">cval</span> <span class="w">|</span> <span class="w">UART_LCR_DLAB</span><span class="c">);</span>
	<span class="w">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_DLL</span><span class="c">,</span> <span class="w">quot</span> <span class="w">&amp;</span> <span class="pc">0xf</span><span class="c">f);</span>		
	<span class="w">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_DLM</span><span class="c">,</span> <span class="w">q</span><span class="c">uot</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="pc">8</span><span class="c">);</span>		
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">or</span><span class="c">t</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_16750</span><span class="c">)</span>
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_FCR</span><span class="c">,</span> <span class="w">fcr</span><span class="pc">)</span><span class="c">;</span>		
	<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="c">,</span> <span class="w">cval</span><span class="c">);</span>		
	<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">lcr</span> <span class="c">=</span> <span class="pc">c</span><span class="c">val</span><span class="pc">;</span>					
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">P</span><span class="c">ORT_16750</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">f</span><span class="c">cr</span> <span class="w">&amp;</span> <span class="w">UART_FCR_ENABLE_FIFO</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="pc">s</span><span class="c">erial_outp</span><span class="pc">(</span><span class="w">u</span><span class="pc">p</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_F</span><span class="c">CR</span><span class="pc">,</span> <span class="w">U</span><span class="pc">ART_F</span><span class="c">CR_ENABLE_FIFO);</span>
		<span class="c">}</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">rial_outp</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_FCR</span><span class="pc">,</span> <span class="pc">f</span><span class="c">cr);</span>		
	<span class="c">}</span>

	<span class="w">up</span><span class="c">-&gt;</span><span class="w">cflag</span> <span class="c">=</span> <span class="w">c</span><span class="pc">f</span><span class="c">lag;</span>

	<span class="w">s</span><span class="pc">pin_unlock_</span><span class="c">irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">sunsu_set_termios</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="w">ktermios</span> <span class="c">*</span><span class="w">te</span><span class="pc">r</span><span class="c">mios,</span>
		  <span class="c">struct</span> <span class="c">ktermios</span> <span class="c">*</span><span class="w">o</span><span class="pc">l</span><span class="c">d)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ba</span><span class="pc">u</span><span class="c">d</span><span class="pc">,</span> <span class="w">quot</span><span class="c">;</span>

	
	<span class="w">ba</span><span class="pc">u</span><span class="c">d</span> <span class="c">=</span> <span class="w">uart_get_baud_rate</span><span class="c">(port</span><span class="pc">,</span> <span class="w">te</span><span class="pc">r</span><span class="c">mios</span><span class="pc">,</span> <span class="w">o</span><span class="pc">l</span><span class="c">d</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="pc">p</span><span class="c">ort</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">uartclk/1</span><span class="pc">6</span><span class="c">);</span> 
	<span class="pc">q</span><span class="c">uot</span> <span class="pc">=</span> <span class="w">uart_get_divisor</span><span class="c">(</span><span class="pc">p</span><span class="c">ort,</span> <span class="w">ba</span><span class="pc">u</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">sunsu_change_speed</span><span class="c">(port,</span> <span class="w">te</span><span class="pc">r</span><span class="c">mios</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">c_cflag</span><span class="pc">,</span> <span class="w">t</span><span class="pc">er</span><span class="c">mios-&gt;</span><span class="w">c_iflag</span><span class="c">,</span> <span class="pc">q</span><span class="c">uot</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">sunsu_release_port</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">art_p</span><span class="c">ort</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
<span class="w">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">sunsu_request_port</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">art_p</span><span class="c">ort</span> <span class="c">*port</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">sunsu_config_port</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*port,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">f</span><span class="c">lags)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="c">container_of(</span><span class="pc">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="w">p</span><span class="c">ort);</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UART_CONFIG_TYPE</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">type_probed</span><span class="c">;</span>	
	<span class="pc">}</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">int</span>
<span class="w">sunsu_verify_port</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">art_p</span><span class="c">ort</span> <span class="c">*port,</span> <span class="c">struct</span> <span class="w">serial_struct</span> <span class="c">*</span><span class="w">ser</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span>
<span class="w">sunsu_type</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">p</span><span class="c">ort-&gt;</span><span class="w">t</span><span class="pc">y</span><span class="c">pe;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">A</span><span class="c">RRAY_SIZE(</span><span class="w">uart_config</span><span class="c">))</span>
		<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">u</span><span class="c">art_config</span><span class="pc">[</span><span class="w">t</span><span class="c">ype</span><span class="pc">].n</span><span class="c">ame;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">uart_ops</span> <span class="w">sunsu_pops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">tx_empty</span>	<span class="c">=</span> <span class="w">sunsu_tx_empty</span><span class="c">,</span>
	<span class="c">.</span><span class="w">set_mctrl</span>	<span class="c">=</span> <span class="w">sunsu_set_mctrl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">get_mctrl</span>	<span class="c">=</span> <span class="w">sunsu_get_mctrl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">stop_tx</span>	<span class="c">=</span> <span class="w">sunsu_stop_tx</span><span class="c">,</span>
	<span class="c">.</span><span class="w">start_tx</span>	<span class="c">=</span> <span class="w">sunsu_start_tx</span><span class="c">,</span>
	<span class="c">.</span><span class="w">stop_rx</span>	<span class="c">=</span> <span class="w">sunsu_stop_rx</span><span class="c">,</span>
	<span class="c">.</span><span class="w">enable_ms</span>	<span class="c">=</span> <span class="w">sunsu_enable_ms</span><span class="c">,</span>
	<span class="c">.</span><span class="w">break_ctl</span>	<span class="c">=</span> <span class="w">sunsu_break_ctl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">startup</span>	<span class="c">=</span> <span class="w">sunsu_startup</span><span class="c">,</span>
	<span class="c">.</span><span class="w">shutdown</span>	<span class="c">=</span> <span class="w">sunsu_shutdown</span><span class="c">,</span>
	<span class="c">.</span><span class="w">set_termios</span>	<span class="c">=</span> <span class="w">sunsu_set_termios</span><span class="c">,</span>
	<span class="c">.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span>		<span class="c">=</span> <span class="w">sunsu_type</span><span class="c">,</span>
	<span class="c">.</span><span class="w">release_port</span>	<span class="c">=</span> <span class="w">sunsu_release_port</span><span class="c">,</span>
	<span class="c">.</span><span class="w">request_port</span>	<span class="c">=</span> <span class="w">sunsu_request_port</span><span class="c">,</span>
	<span class="c">.</span><span class="w">config_port</span>	<span class="c">=</span> <span class="w">sunsu_config_port</span><span class="c">,</span>
	<span class="c">.</span><span class="w">verify_port</span>	<span class="c">=</span> <span class="w">sunsu_verify_port</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">UART_NR</span>	<span class="w">4</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">uart_sunsu_port</span> <span class="w">sunsu_ports</span><span class="pc">[U</span><span class="c">ART_NR</span><span class="pc">];</span>
<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">nr_inst</span><span class="pc">;</span> 

<span class="pc">#ifd</span><span class="c">ef</span> <span class="w">CONFIG_SERIO</span>

<span class="c">static</span> <span class="w">DEFINE_SPINLOCK</span><span class="c">(</span><span class="w">sunsu_serio_lock</span><span class="c">);</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">sunsu_serio_write</span><span class="c">(struct</span> <span class="w">se</span><span class="pc">r</span><span class="c">io</span> <span class="c">*</span><span class="w">s</span><span class="pc">e</span><span class="c">rio,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">c</span><span class="pc">h)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">u</span><span class="c">art_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span> <span class="w">se</span><span class="pc">rio-</span><span class="c">&gt;</span><span class="w">port_data</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">lsr</span><span class="pc">;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;sunsu_serio_lock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="w">do</span> <span class="c">{</span>
		<span class="w">l</span><span class="c">sr</span> <span class="c">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR</span><span class="c">);</span>
	<span class="pc">}</span> <span class="w">w</span><span class="c">hile</span> <span class="w">(!</span><span class="pc">(</span><span class="w">l</span><span class="c">sr</span> <span class="c">&amp;</span> <span class="w">UART_LSR_THRE))</span><span class="pc">;</span>

	
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_TX</span><span class="pc">,</span> <span class="w">ch</span><span class="c">);</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="pc">s</span><span class="c">unsu_serio_lock,</span> <span class="c">flags);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">sunsu_serio_open</span><span class="c">(struct</span> <span class="w">se</span><span class="pc">r</span><span class="c">io</span> <span class="c">*</span><span class="pc">se</span><span class="c">rio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span> <span class="w">s</span><span class="pc">e</span><span class="c">rio-&gt;</span><span class="w">port_data</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="c">int</span> <span class="pc">r</span><span class="c">et;</span>

	<span class="pc">s</span><span class="c">pin_lock_irqsave(&amp;</span><span class="pc">s</span><span class="c">unsu_serio_lock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">serio_open</span><span class="c">) {</span>
		<span class="w">up</span><span class="pc">-</span><span class="c">&gt;serio_open</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-</span><span class="w">EB</span><span class="c">USY;</span>
	<span class="w">s</span><span class="pc">pin_u</span><span class="c">nlock_irqrestore(&amp;sunsu_serio_lock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">sunsu_serio_close</span><span class="c">(struct</span> <span class="w">se</span><span class="pc">rio</span> <span class="c">*</span><span class="w">s</span><span class="pc">erio)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span> <span class="w">s</span><span class="pc">erio</span><span class="c">-&gt;</span><span class="w">port_data</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	<span class="pc">s</span><span class="c">pin_lock_irqsave(&amp;sunsu_serio_lock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">serio_open</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;sunsu_serio_lock</span><span class="pc">,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span> 

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">sunsu_autoconfig</span><span class="c">(struct</span> <span class="c">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">status1</span><span class="pc">,</span> <span class="w">status2</span><span class="c">,</span> <span class="w">scratch</span><span class="c">,</span> <span class="w">scratch2</span><span class="pc">,</span> <span class="w">scratch3</span><span class="pc">;</span>
	<span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">save_lcr</span><span class="c">,</span> <span class="w">save_mcr</span><span class="pc">;</span>
	<span class="c">unsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">su_type</span> <span class="c">==</span> <span class="w">SU_PORT_NONE</span><span class="pc">)</span>
		<span class="c">return;</span>

	<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">type_probed</span> <span class="c">=</span> <span class="w">PORT_UNKNOWN</span><span class="c">;</span>
	<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">iotype</span> <span class="c">=</span> <span class="w">UPIO_MEM</span><span class="c">;</span>

	<span class="w">sp</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>

	<span class="c">if</span> <span class="pc">(!(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.flags</span> <span class="c">&amp;</span> <span class="w">UPF_BUGGY_UART</span><span class="pc">)) </span><span class="c">{</span>
		
		<span class="w">scratch</span> <span class="pc">=</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="c">);</span>
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_IER</span><span class="pc">,</span> <span class="c">0);</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">__i386__</span>
		<span class="w">ou</span><span class="pc">tb</span><span class="c">(</span><span class="w">0xf</span><span class="pc">f</span><span class="c">,</span> <span class="w">0x080</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span>
		<span class="w">scratch2</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">erial_i</span><span class="c">np(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_IER);</span>
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_IER,</span> <span class="w">0x0</span><span class="pc">f</span><span class="c">);</span>
<span class="c">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="c">__i386__</span>
		<span class="w">o</span><span class="c">utb(</span><span class="pc">0</span><span class="c">,</span> <span class="pc">0x</span><span class="c">080);</span>
<span class="c">#endif</span>
		<span class="w">scratch3</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">erial_inp(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_IER);</span>
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_IER,</span> <span class="w">scratch</span><span class="c">);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">scratch2</span> <span class="w">!</span><span class="c">=</span> <span class="c">0</span> <span class="pc">|</span><span class="c">|</span> <span class="w">s</span><span class="pc">cratch3</span> <span class="pc">!</span><span class="c">=</span> <span class="w">0x0F</span><span class="c">)</span>
			<span class="w">g</span><span class="c">oto</span> <span class="c">out;</span>	
	<span class="c">}</span>

	<span class="w">save_mcr</span> <span class="pc">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_MCR</span><span class="c">);</span>
	<span class="w">save_lcr</span> <span class="pc">=</span> <span class="pc">se</span><span class="c">rial_in(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="c">);</span>

	
	<span class="c">if</span> <span class="pc">(!(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">po</span><span class="pc">rt</span><span class="w">.</span><span class="pc">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UPF_SKIP_TEST</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_MCR,</span> <span class="w">UART_MCR_LOOP</span> <span class="pc">|</span> <span class="w">0x0A</span><span class="c">);</span>
		<span class="w">status1</span> <span class="pc">=</span> <span class="w">serial_inp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_MSR)</span><span class="pc"> </span><span class="c">&amp;</span> <span class="w">0xF0</span><span class="c">;</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">rial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_MCR,</span> <span class="w">save_mcr</span><span class="c">);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(status1</span> <span class="w">!</span><span class="c">=</span> <span class="w">0x9</span><span class="c">0</span><span class="pc">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="pc">o</span><span class="c">ut;</span>	
	<span class="c">}</span>
	<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="pc">,</span> <span class="w">0xBF</span><span class="c">);</span>	
	<span class="w">s</span><span class="pc">e</span><span class="c">rial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_EFR</span><span class="c">,</span> <span class="c">0);</span>		
	<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">UART_L</span><span class="c">CR,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_FCR</span><span class="c">,</span> <span class="w">UART_FCR_ENABLE_FIFO</span><span class="c">);</span>
	<span class="w">scratch</span> <span class="pc">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IIR) &gt;</span><span class="c">&gt;</span> <span class="w">6</span><span class="pc">;</span>
	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(scratch) {</span>
		<span class="c">case</span> <span class="c">0:</span>
			<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">PORT_16450</span><span class="c">;</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="pc">1</span><span class="c">:</span>
			<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">PORT_UNKNOWN</span><span class="c">;</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="c">2:</span>
			<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">PORT_16550</span><span class="c">;</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="pc">3</span><span class="c">:</span>
			<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">PORT_16550A</span><span class="c">;</span>
			<span class="c">break;</span>
	<span class="pc">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">P</span><span class="pc">ORT_16550A) </span><span class="c">{</span>
		
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="pc">,</span> <span class="w">UART_LCR_DLAB</span><span class="c">);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_EFR</span><span class="pc">) =</span><span class="c">=</span> <span class="c">0) {</span>
			<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">PORT_16650</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="pc">s</span><span class="c">erial_outp</span><span class="pc">(</span><span class="w">u</span><span class="pc">p</span><span class="c">,</span> <span class="pc">UART_LCR</span><span class="c">,</span> <span class="w">0xBF</span><span class="c">);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(serial_in</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_EFR</span><span class="w">)</span><span class="pc"> =</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
				<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">PORT_16650V2</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_16550A</span><span class="c">) {</span>
		
		<span class="w">s</span><span class="pc">erial_o</span><span class="c">utp</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_L</span><span class="c">CR,</span> <span class="w">save_lcr</span> <span class="w">|</span> <span class="w">UART_LCR_DLAB</span><span class="c">);</span>
		<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_FCR</span><span class="c">,</span>
			    <span class="w">UART_FCR_ENABLE_FIFO</span> <span class="pc">|</span> <span class="w">UART_FCR7_64BYTE</span><span class="c">);</span>
		<span class="w">scratch</span> <span class="pc">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IIR) &gt;</span><span class="c">&gt;</span> <span class="w">5</span><span class="pc">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(scratch</span> <span class="pc">=</span><span class="c">=</span> <span class="w">7</span><span class="pc">) </span><span class="c">{</span>
			
 			<span class="c">serial_outp(</span><span class="w">u</span><span class="pc">p</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_FCR</span><span class="c">,</span> <span class="c">UART_FCR_ENABLE_FIFO);</span>
			<span class="pc">se</span><span class="c">rial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
			<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">UART_F</span><span class="c">CR,</span>
				    <span class="c">UART_FCR_ENABLE_FIFO</span> <span class="pc">|</span> <span class="w">UART_FCR7_64BYTE</span><span class="c">);</span>
			<span class="w">s</span><span class="pc">c</span><span class="c">ratch</span> <span class="pc">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_IIR) &gt;</span><span class="c">&gt;</span> <span class="w">5</span><span class="pc">;</span>
			<span class="c">if</span> <span class="c">(scratch</span> <span class="pc">=</span><span class="c">=</span> <span class="w">6</span><span class="c">)</span>
				<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">ort.</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">PORT_16750</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">se</span><span class="pc">rial_o</span><span class="c">utp</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_FCR</span><span class="pc">,</span> <span class="c">UART_FCR_ENABLE_FIFO);</span>
	<span class="c">}</span>
	<span class="w">s</span><span class="pc">erial_o</span><span class="c">utp</span><span class="pc">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LCR</span><span class="c">,</span> <span class="w">save_lcr</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">po</span><span class="pc">rt</span><span class="w">.t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_16450</span><span class="c">) {</span>
		<span class="w">s</span><span class="pc">c</span><span class="c">ratch</span> <span class="pc">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_SCR</span><span class="c">);</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">rial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">UART_S</span><span class="c">CR,</span> <span class="w">0xa5</span><span class="c">);</span>
		<span class="w">status1</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">erial_i</span><span class="c">n(</span><span class="w">u</span><span class="pc">p</span><span class="c">,</span> <span class="w">U</span><span class="pc">ART_S</span><span class="c">CR);</span>
		<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_SCR,</span> <span class="w">0x5a</span><span class="c">);</span>
		<span class="w">status2</span> <span class="pc">=</span> <span class="c">serial_in(</span><span class="w">up</span><span class="c">,</span> <span class="c">UART_SCR);</span>
		<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_SCR,</span> <span class="w">scratch</span><span class="c">);</span>

		<span class="w">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">s</span><span class="pc">tatus1</span> <span class="w">!</span><span class="c">=</span> <span class="w">0</span><span class="pc">xa</span><span class="c">5</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="pc">status2</span> <span class="pc">!</span><span class="c">=</span> <span class="w">0</span><span class="pc">x5</span><span class="c">a))</span>
			<span class="w">u</span><span class="pc">p</span><span class="w">-</span><span class="c">&gt;</span><span class="w">po</span><span class="pc">rt.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">PORT_8250</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt.</span><span class="w">fifosize</span> <span class="c">=</span> <span class="w">uart_config[u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span><span class="w">]</span><span class="pc">.</span><span class="w">dfl_xmit_fifo_size</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;port.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_UNKNOWN</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="c">out;</span>
	<span class="w">up</span><span class="c">-&gt;</span><span class="w">type_probed</span> <span class="pc">=</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="pc">ype</span><span class="c">;</span>	

	
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIAL_8250_RSA</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">t</span><span class="pc">ype</span> <span class="c">==</span> <span class="w">PORT_RSA</span><span class="c">)</span>
		<span class="w">serial_outp</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_RSA_FRR</span><span class="c">,</span> <span class="pc">0)</span><span class="c">;</span>
<span class="pc">#</span><span class="c">endif</span>
	<span class="w">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_MCR</span><span class="c">,</span> <span class="w">save_mcr</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_FCR</span><span class="pc">, (</span><span class="w">UART_FCR_ENABLE_FIFO</span> <span class="pc">|</span>
				     <span class="w">UART_FCR_CLEAR_RCVR</span> <span class="c">|</span>
				     <span class="w">UART_FCR_CLEAR_XMIT</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">serial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="pc">UART_FCR</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="w">(v</span><span class="c">oid)</span><span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_RX</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="c">erial_outp(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="c">,</span> <span class="pc">0)</span><span class="c">;</span>

<span class="w">o</span><span class="pc">ut</span><span class="c">:</span>
	<span class="w">s</span><span class="pc">pin_unlock_</span><span class="c">irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">uart_driver</span> <span class="w">sunsu_reg</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">o</span><span class="c">wner</span>			<span class="c">=</span> <span class="c">THIS_MODULE,</span>
	<span class="c">.</span><span class="w">driver_name</span>		<span class="pc">= "</span><span class="w">sunsu</span><span class="c">",</span>
	<span class="c">.</span><span class="w">dev_</span><span class="pc">n</span><span class="c">ame</span>		<span class="pc">= </span><span class="c">"</span><span class="w">ttyS</span><span class="c">",</span>
	<span class="c">.</span><span class="w">ma</span><span class="pc">j</span><span class="c">or</span>			<span class="c">=</span> <span class="w">TTY_MAJOR</span><span class="c">,</span>
<span class="pc">};</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">sunsu_kbd_ms_init</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">quot</span><span class="c">,</span> <span class="w">bau</span><span class="c">d;</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_SERIO</span>
	<span class="c">struct</span> <span class="w">se</span><span class="pc">r</span><span class="c">io</span> <span class="c">*</span><span class="pc">s</span><span class="c">erio;</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">su_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SU_PORT_KBD</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">up</span><span class="c">-&gt;</span><span class="w">cflag</span> <span class="c">=</span> <span class="w">B1200</span> <span class="pc">|</span> <span class="w">CS8</span> <span class="pc">|</span> <span class="w">CLOCAL</span> <span class="pc">|</span> <span class="w">CREAD</span><span class="c">;</span>
		<span class="w">ba</span><span class="pc">u</span><span class="c">d</span> <span class="pc">=</span> <span class="w">1200</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">up</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">flag</span> <span class="c">=</span> <span class="w">B4800</span> <span class="pc">|</span> <span class="c">CS8</span> <span class="pc">|</span> <span class="pc">CL</span><span class="c">OCAL</span> <span class="pc">|</span> <span class="pc">C</span><span class="c">READ;</span>
		<span class="w">ba</span><span class="pc">u</span><span class="c">d</span> <span class="pc">=</span> <span class="w">4800</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="w">quot</span> <span class="c">=</span> <span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">uartclk</span> <span class="w">/ (1</span><span class="pc">6</span> <span class="pc">*</span> <span class="w">ba</span><span class="pc">u</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">sunsu_autoconfig</span><span class="c">(</span><span class="w">up</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_UNKNOWN</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-ENODEV;</span>

	<span class="w">p</span><span class="c">rintk</span><span class="pc">("%</span><span class="c">s</span><span class="pc">: </span><span class="c">%s</span> <span class="w">p</span><span class="c">ort</span> <span class="w">a</span><span class="pc">t</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">x</span><span class="pc">,</span> <span class="w">i</span><span class="pc">r</span><span class="c">q</span> <span class="c">%</span><span class="pc">u</span><span class="c">\n",</span>
	       <span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">o</span><span class="c">f_node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">full_name</span><span class="c">,</span>
	       <span class="w">(up</span><span class="c">-&gt;</span><span class="w">su_type</span> <span class="w">=</span><span class="c">=</span> <span class="w">SU_PORT_KBD)</span><span class="pc"> ? </span><span class="c">"</span><span class="w">Keyboard</span><span class="c">" : "</span><span class="w">Mouse</span><span class="c">",</span>
	       <span class="c">(unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">mapbase</span><span class="pc">,</span>
	       <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">ir</span><span class="pc">q</span><span class="c">);</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIO</span>
	<span class="w">ser</span><span class="pc">io</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">se</span><span class="pc">rio</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">er</span><span class="c">io-&gt;</span><span class="w">port_data</span> <span class="c">=</span> <span class="w">up</span><span class="pc">;</span>

	<span class="w">s</span><span class="c">erio-&gt;</span><span class="w">i</span><span class="pc">d</span><span class="c">.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">SERIO_RS232</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">su_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SU_PORT_KBD</span><span class="c">) {</span>
		<span class="w">se</span><span class="pc">r</span><span class="c">io-&gt;</span><span class="w">i</span><span class="c">d.</span><span class="w">pr</span><span class="pc">ot</span><span class="c">o</span> <span class="c">=</span> <span class="w">SERIO_SUNKBD</span><span class="c">;</span>
		<span class="w">st</span><span class="pc">rl</span><span class="c">cpy(</span><span class="pc">s</span><span class="c">erio-&gt;name</span><span class="pc">, </span><span class="c">"</span><span class="w">sukbd</span><span class="c">",</span> <span class="c">sizeof(</span><span class="pc">se</span><span class="c">rio-&gt;</span><span class="pc">n</span><span class="c">ame));</span>
	<span class="w">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">se</span><span class="c">rio-&gt;</span><span class="pc">i</span><span class="c">d</span><span class="pc">.</span><span class="w">p</span><span class="pc">r</span><span class="c">oto</span> <span class="c">=</span> <span class="w">SERIO_SUN</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">erio-&gt;id.</span><span class="w">ex</span><span class="pc">tr</span><span class="c">a</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">rlcpy(serio-&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="pc">, "</span><span class="w">sums</span><span class="c">",</span> <span class="c">sizeof(serio-&gt;</span><span class="pc">n</span><span class="c">ame));</span>
	<span class="w">}</span>
	<span class="w">s</span><span class="pc">tr</span><span class="c">lcpy(serio-&gt;phys,</span>
		<span class="w">(!</span><span class="pc">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">po</span><span class="c">rt</span><span class="w">.li</span><span class="pc">ne</span> <span class="w">&amp;</span> <span class="w">1) ?</span><span class="pc"> </span><span class="c">"</span><span class="w">su/serio0" </span><span class="c">: "</span><span class="pc">s</span><span class="c">u</span><span class="w">/serio1"),</span>
		<span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="pc">serio</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">hys));</span>

	<span class="w">se</span><span class="pc">rio</span><span class="c">-&gt;</span><span class="w">w</span><span class="pc">r</span><span class="c">ite</span> <span class="c">=</span> <span class="w">sunsu_serio_write</span><span class="pc">;</span>
	<span class="w">s</span><span class="c">erio-&gt;</span><span class="w">o</span><span class="c">pen</span> <span class="c">=</span> <span class="w">sunsu_serio_open</span><span class="c">;</span>
	<span class="c">serio-&gt;</span><span class="w">c</span><span class="c">lose</span> <span class="c">=</span> <span class="w">sunsu_serio_close</span><span class="c">;</span>
	<span class="c">serio-&gt;</span><span class="pc">d</span><span class="c">ev.parent</span> <span class="c">=</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">d</span><span class="c">ev;</span>

	<span class="w">serio_register_port</span><span class="c">(</span><span class="pc">s</span><span class="c">erio);</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

	<span class="w">sunsu_change_speed</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="w">cflag</span><span class="c">,</span> <span class="c">0</span><span class="pc">,</span> <span class="w">quot</span><span class="c">);</span>

	<span class="w">sunsu_startup</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>



<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIAL_SUNSU_CONSOLE</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">BOTH_EMPTY</span> <span class="c">(</span><span class="w">UART_LSR_TEMT</span> <span class="pc">|</span> <span class="w">UART_LSR_THRE</span><span class="pc">)</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="w">__inline__</span> <span class="w">v</span><span class="c">oid</span> <span class="w">wait_for_xmitr</span><span class="c">(struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">s</span><span class="c">tatus</span><span class="pc">,</span> <span class="w">tmout</span> <span class="pc">=</span> <span class="w">10000</span><span class="pc">;</span>

	
	<span class="w">d</span><span class="c">o</span> <span class="c">{</span>
		<span class="w">st</span><span class="pc">a</span><span class="c">tus</span> <span class="c">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_LSR</span><span class="c">);</span>

		<span class="c">if</span> <span class="c">(status</span> <span class="c">&amp;</span> <span class="w">UART_LSR_BI</span><span class="pc">)</span>
			<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">lsr_break_flag</span> <span class="pc">=</span> <span class="c">UART_LSR_BI;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="w">(-</span><span class="c">-</span><span class="w">t</span><span class="c">mout</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0)</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="w">u</span><span class="c">delay(1);</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">((</span><span class="w">s</span><span class="c">tatus</span> <span class="c">&amp;</span> <span class="w">BOTH_EMPTY</span><span class="pc">) !</span><span class="c">=</span> <span class="pc">B</span><span class="c">OTH_EMPTY</span><span class="pc">);</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="w">.</span><span class="pc">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">UPF_CONS_FLOW</span><span class="c">) {</span>
		<span class="pc">t</span><span class="c">mout</span> <span class="pc">=</span> <span class="w">1000000</span><span class="pc">;</span>
		<span class="w">w</span><span class="c">hile</span> <span class="pc">(-</span><span class="c">-</span><span class="pc">t</span><span class="c">mout</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
		       <span class="w">(</span><span class="pc">(</span><span class="w">serial_in</span><span class="pc">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_MSR</span><span class="pc">)</span><span class="c"> &amp;</span> <span class="w">UART_MSR_CTS) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">))</span>
			<span class="w">u</span><span class="c">delay(1);</span>
	<span class="pc">}</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">sunsu_console_putchar</span><span class="c">(struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">h)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span>
		<span class="pc">c</span><span class="c">ontainer_of(</span><span class="w">p</span><span class="c">ort,</span> <span class="c">struct</span> <span class="c">uart_sunsu_port,</span> <span class="pc">p</span><span class="c">ort);</span>

	<span class="w">wait_for_xmitr</span><span class="c">(</span><span class="w">up</span><span class="c">);</span>
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="pc">,</span> <span class="w">UART_TX</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">sunsu_console_write</span><span class="c">(struct</span> <span class="w">console</span> <span class="c">*</span><span class="w">co</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">s</span><span class="c">,</span>
				<span class="pc">un</span><span class="c">signed</span> <span class="c">int</span> <span class="pc">c</span><span class="c">ount</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="pc">= &amp;</span><span class="w">sunsu_ports</span><span class="pc">[</span><span class="c">co</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">in</span><span class="c">dex];</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ier</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">locked</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="w">.sysrq</span> <span class="w">|</span><span class="c">|</span> <span class="w">oops_in_progress</span><span class="pc">)</span>
		<span class="pc">l</span><span class="c">ocked</span> <span class="pc">=</span> <span class="w">spin_trylock_irqsave</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.lock,</span> <span class="c">flags);</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">sp</span><span class="pc">in_l</span><span class="c">ock_irqsave(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>

	
	<span class="w">i</span><span class="pc">e</span><span class="c">r</span> <span class="pc">=</span> <span class="w">serial_in</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="w">UART_IER</span><span class="c">);</span>
	<span class="w">serial_out</span><span class="c">(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_IER,</span> <span class="pc">0</span><span class="c">);</span>

	<span class="w">uart_console_write</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">,</span> <span class="w">s</span><span class="pc">,</span> <span class="w">c</span><span class="c">ount</span><span class="pc">,</span> <span class="w">sunsu_console_putchar</span><span class="c">);</span>

	
	<span class="w">wait_for_xmitr</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">erial_out(</span><span class="w">up</span><span class="c">,</span> <span class="pc">U</span><span class="c">ART_IER,</span> <span class="pc">i</span><span class="c">er);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">locked</span><span class="pc">)</span>
		<span class="w">sp</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock</span><span class="pc">,</span> <span class="c">flags);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">int</span> <span class="c">__init</span> <span class="w">sunsu_console_setup</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">console</span> <span class="c">*</span><span class="w">co</span><span class="c">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">o</span><span class="pc">pt</span><span class="c">ions)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">struct</span> <span class="w">ktermios</span> <span class="w">du</span><span class="c">mmy</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">ktermios</span> <span class="w">te</span><span class="pc">r</span><span class="c">mios;</span>
	<span class="c">struct</span> <span class="w">u</span><span class="pc">a</span><span class="c">rt_port</span> <span class="c">*</span><span class="pc">p</span><span class="c">ort;</span>

	<span class="w">p</span><span class="c">rintk</span><span class="pc">("</span><span class="w">Console</span><span class="pc">:</span> <span class="w">ttyS</span><span class="pc">%d</span> <span class="w">(SU)</span><span class="pc">\</span><span class="c">n",</span>
	       <span class="w">(sunsu_reg.m</span><span class="pc">i</span><span class="c">nor</span> <span class="w">-</span> <span class="w">6</span><span class="pc">4</span><span class="w">) +</span> <span class="w">c</span><span class="pc">o</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">o-&gt;</span><span class="w">i</span><span class="c">ndex</span> <span class="w">&gt;</span> <span class="w">nr_inst</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>
	<span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="pc">= &amp;</span><span class="w">sunsu_ports</span><span class="pc">[</span><span class="w">c</span><span class="c">o-&gt;index</span><span class="pc">].</span><span class="w">p</span><span class="c">ort;</span>

	
	<span class="w">sp</span><span class="pc">in_lock_in</span><span class="c">it(&amp;</span><span class="pc">p</span><span class="c">ort-&gt;lock);</span>

	
	<span class="w">sunserial_console_termios</span><span class="pc">(c</span><span class="c">o</span><span class="pc">,</span> <span class="c">port</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">d</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;of_node</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">me</span><span class="pc">ms</span><span class="c">et(&amp;</span><span class="w">te</span><span class="pc">r</span><span class="c">mios</span><span class="pc">,</span> <span class="c">0,</span> <span class="c">sizeof(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">ktermios</span><span class="c">));</span>
	<span class="w">te</span><span class="pc">r</span><span class="c">mios</span><span class="pc">.</span><span class="w">c_cflag</span> <span class="c">=</span> <span class="c">co-&gt;</span><span class="w">cflag</span><span class="pc">;</span>
	<span class="pc">p</span><span class="c">ort-&gt;</span><span class="w">mctrl</span> <span class="w">|</span><span class="c">=</span> <span class="w">TIOCM_DTR</span><span class="c">;</span>
	<span class="pc">p</span><span class="c">ort-&gt;</span><span class="w">o</span><span class="c">ps</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">set_termios</span><span class="c">(port</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">te</span><span class="pc">r</span><span class="c">mios</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">du</span><span class="pc">m</span><span class="c">my);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">console</span> <span class="w">sunsu_console</span> <span class="c">= {</span>
	<span class="c">.name</span>	<span class="w">=	"ttyS</span><span class="c">",</span>
	<span class="c">.</span><span class="w">w</span><span class="c">rite</span>	<span class="c">=</span>	<span class="w">sunsu_console_write</span><span class="c">,</span>
	<span class="c">.</span><span class="w">de</span><span class="pc">vi</span><span class="c">ce</span>	<span class="c">=</span>	<span class="w">uart_console_device</span><span class="c">,</span>
	<span class="c">.</span><span class="w">se</span><span class="pc">tu</span><span class="c">p</span>	<span class="c">=</span>	<span class="w">sunsu_console_setup</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">f</span><span class="c">lags</span>	<span class="c">=</span>	<span class="w">CON_PRINTBUFFER</span><span class="c">,</span>
	<span class="c">.</span><span class="w">ind</span><span class="c">ex</span>	<span class="w">=	-</span><span class="pc">1</span><span class="c">,</span>
	<span class="c">.</span><span class="w">d</span><span class="c">ata</span>	<span class="w">=	&amp;sunsu_reg</span><span class="pc">,</span>
<span class="pc">}</span><span class="c">;</span>



<span class="c">static</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">console</span> <span class="c">*</span><span class="w">SUNSU_CONSOLE</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">&amp;sunsu_console</span><span class="c">;</span>
<span class="c">}</span>
<span class="pc">#el</span><span class="c">se</span>
<span class="pc">#</span><span class="c">define</span> <span class="pc">S</span><span class="c">UNSU_CONSOLE</span><span class="w">()			(N</span><span class="pc">U</span><span class="c">LL)</span>
<span class="c">#define</span> <span class="w">sunsu_serial_console_init(</span><span class="pc">)</span>	<span class="pc">d</span><span class="c">o</span> <span class="pc">{ </span><span class="c">}</span> <span class="c">while</span> <span class="c">(0)</span>
<span class="c">#</span><span class="pc">e</span><span class="c">ndif</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="w">e</span><span class="c">num</span> <span class="w">su_type</span> <span class="w">su_get_type</span><span class="c">(struct</span> <span class="pc">d</span><span class="c">evice_node</span> <span class="c">*</span><span class="w">d</span><span class="pc">p)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">device_node</span> <span class="c">*</span><span class="w">ap</span> <span class="pc">=</span> <span class="w">of_find_node_by_path("/aliases"</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">ap</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*</span><span class="w">keyb</span> <span class="c">=</span> <span class="w">of_get_property</span><span class="c">(</span><span class="w">a</span><span class="pc">p, </span><span class="c">"</span><span class="w">keyboard</span><span class="c">",</span> <span class="w">N</span><span class="c">ULL);</span>
		<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*</span><span class="w">ms</span> <span class="pc">=</span> <span class="pc">o</span><span class="c">f_get_property</span><span class="pc">(</span><span class="w">a</span><span class="c">p</span><span class="pc">, </span><span class="c">"</span><span class="w">mouse</span><span class="pc">",</span> <span class="pc">N</span><span class="c">ULL);</span>

		<span class="c">if</span> <span class="c">(</span><span class="pc">k</span><span class="c">eyb</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">p</span> <span class="pc">=</span><span class="c">=</span> <span class="w">of_find_node_by_path(</span><span class="c">keyb</span><span class="pc">)</span><span class="c">)</span>
				<span class="c">return</span> <span class="w">SU_PORT_KBD</span><span class="c">;</span>
		<span class="pc">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ms)</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="c">p</span> <span class="pc">=</span><span class="c">=</span> <span class="w">o</span><span class="pc">f_f</span><span class="c">ind_node_by_path</span><span class="w">(ms</span><span class="c">))</span>
				<span class="c">return</span> <span class="w">SU_PORT_MS</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">SU_PORT_PORT</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">su_probe</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">l</span><span class="c">atform_device</span> <span class="c">*</span><span class="pc">o</span><span class="c">p)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">device_node</span> <span class="c">*</span><span class="w">d</span><span class="pc">p</span> <span class="c">=</span> <span class="w">o</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">d</span><span class="c">ev</span><span class="pc">.</span><span class="c">of_node;</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">r</span><span class="c">esource</span> <span class="c">*</span><span class="w">rp</span><span class="c">;</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">su_type</span> <span class="c">type;</span>
	<span class="w">b</span><span class="c">ool</span> <span class="w">ignore_line</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">su_get_type</span><span class="c">(</span><span class="w">dp</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">SU_PORT_PORT</span><span class="c">) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">nr_inst</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">UART_NR</span><span class="pc">)</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="w">up</span> <span class="pc">= &amp;</span><span class="w">sunsu_ports</span><span class="pc">[n</span><span class="c">r_inst];</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">up</span> <span class="c">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(sizeof</span><span class="pc">(*</span><span class="w">up</span><span class="c">),</span> <span class="c">GFP_KERNEL);</span>
		<span class="c">if</span> <span class="c">(!</span><span class="w">u</span><span class="pc">p</span><span class="c">)</span>
			<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="pc">}</span>

	<span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">po</span><span class="pc">rt.</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span> <span class="c">=</span> <span class="c">nr_inst;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_init(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="c">lock);</span>

	<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">su_type</span> <span class="c">=</span> <span class="w">ty</span><span class="c">pe;</span>

	<span class="w">rp</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">o</span><span class="c">p-&gt;</span><span class="w">r</span><span class="c">esource</span><span class="pc">[</span><span class="c">0];</span>
	<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">mapbase</span> <span class="c">=</span> <span class="w">rp</span><span class="c">-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">art;</span>
	<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">reg_size</span> <span class="c">=</span> <span class="w">resource_size</span><span class="pc">(</span><span class="w">rp</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">me</span><span class="pc">mb</span><span class="c">ase</span> <span class="c">=</span> <span class="w">of_ioremap</span><span class="pc">(</span><span class="w">rp</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;reg_size</span><span class="w">,</span><span class="pc"> "</span><span class="w">su</span><span class="c">");</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">me</span><span class="pc">mb</span><span class="c">ase) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">ty</span><span class="c">pe</span> <span class="pc">!</span><span class="c">=</span> <span class="w">SU_PORT_PORT</span><span class="pc">)</span>
			<span class="w">k</span><span class="c">free(</span><span class="w">up</span><span class="c">);</span>
		<span class="c">return</span> <span class="pc">-ENOM</span><span class="c">EM;</span>
	<span class="c">}</span>

	<span class="w">u</span><span class="c">p-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">ir</span><span class="c">q</span> <span class="c">=</span> <span class="w">o</span><span class="c">p-&gt;</span><span class="w">archdata</span><span class="c">.</span><span class="w">irqs[</span><span class="c">0</span><span class="pc">];</span>

	<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">d</span><span class="pc">e</span><span class="c">v</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">o</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">d</span><span class="c">ev</span><span class="pc">;</span>

	<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">PORT_UNKNOWN</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort.</span><span class="w">uartclk</span> <span class="w">=</span><span class="pc"> (</span><span class="w">SU_BASE_BAUD</span> <span class="w">*</span> <span class="w">1</span><span class="pc">6</span><span class="c">);</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">su_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SU_PORT_KBD</span> <span class="pc">|</span><span class="c">|</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;su_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SU_PORT_MS</span><span class="c">) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">sunsu_kbd_ms_init</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">of_iounmap</span><span class="pc">(&amp;</span><span class="w">o</span><span class="c">p-&gt;</span><span class="w">res</span><span class="pc">o</span><span class="c">urce[0</span><span class="pc">],</span>
				   <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">ort</span><span class="w">.me</span><span class="pc">mb</span><span class="c">ase</span><span class="pc">,</span> <span class="w">u</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">reg_size</span><span class="c">);</span>
			<span class="w">k</span><span class="c">free(</span><span class="w">u</span><span class="pc">p)</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
		<span class="c">}</span>
		<span class="w">p</span><span class="pc">l</span><span class="c">atform_set_drvdata(</span><span class="pc">o</span><span class="c">p,</span> <span class="w">up</span><span class="c">);</span>

		<span class="w">nr_inst+</span><span class="c">+;</span>

		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">po</span><span class="pc">rt</span><span class="c">.</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UPF_BOOT_AUTOCONF</span><span class="c">;</span>

	<span class="w">sunsu_autoconfig</span><span class="c">(</span><span class="w">up</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="pc">ENOD</span><span class="c">EV;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">PORT_UNKNOWN</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_unmap</span><span class="c">;</span>

	<span class="w">up</span><span class="c">-&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">o</span><span class="pc">p</span><span class="c">s</span> <span class="pc">=</span><span class="c"> &amp;</span><span class="w">sunsu_pops</span><span class="c">;</span>

	<span class="w">ignore_line</span> <span class="pc">=</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">st</span><span class="pc">rc</span><span class="c">mp(</span><span class="w">d</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="pc">, </span><span class="c">"</span><span class="w">rsc</span><span class="c">-</span><span class="w">console") ||</span>
	    <span class="w">!</span><span class="c">strcmp(</span><span class="w">dp</span><span class="c">-&gt;name</span><span class="pc">, </span><span class="c">"</span><span class="w">lom</span><span class="pc">-c</span><span class="c">onsole</span><span class="pc">")</span><span class="c">)</span>
		<span class="w">i</span><span class="pc">g</span><span class="c">nore_line</span> <span class="pc">=</span> <span class="w">t</span><span class="c">rue;</span>

	<span class="w">sunserial_console_match</span><span class="c">(</span><span class="w">SUNSU_CONSOLE(</span><span class="pc">)</span><span class="c">,</span> <span class="w">dp</span><span class="c">,</span>
				<span class="w">&amp;sunsu_reg</span><span class="pc">,</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span><span class="pc">.</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span><span class="pc">,</span>
				<span class="w">i</span><span class="c">gnore_line);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">uart_add_one_port</span><span class="pc">(&amp;</span><span class="w">s</span><span class="pc">unsu</span><span class="c">_reg</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">goto</span> <span class="w">out_unmap</span><span class="c">;</span>

	<span class="w">pl</span><span class="c">atform_set_drvdata(</span><span class="w">o</span><span class="c">p,</span> <span class="w">up</span><span class="c">);</span>

	<span class="w">nr_inst+</span><span class="c">+;</span>

	<span class="c">return</span> <span class="c">0;</span>

<span class="pc">o</span><span class="c">ut_unmap:</span>
	<span class="w">of_iounmap</span><span class="pc">(&amp;</span><span class="w">o</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">r</span><span class="c">esource</span><span class="pc">[</span><span class="c">0</span><span class="pc">],</span> <span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">me</span><span class="pc">mb</span><span class="c">ase</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="w">reg_size</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">su_remove</span><span class="c">(struct</span> <span class="c">platform_device</span> <span class="c">*</span><span class="pc">o</span><span class="c">p)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">uart_sunsu_port</span> <span class="c">*</span><span class="w">up</span> <span class="c">=</span> <span class="c">platform_get_drvdata(</span><span class="pc">o</span><span class="c">p);</span>
	<span class="w">b</span><span class="pc">o</span><span class="c">ol</span> <span class="w">kbdms</span> <span class="c">=</span> <span class="w">f</span><span class="c">alse;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">su_type</span> <span class="c">==</span> <span class="w">SU_PORT_MS</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="w">up</span><span class="c">-&gt;su_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SU_PORT_KBD</span><span class="pc">)</span>
		<span class="w">k</span><span class="c">bdms</span> <span class="pc">=</span> <span class="w">t</span><span class="c">rue;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(kbdms</span><span class="pc">)</span><span class="c"> {</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_SERIO</span>
		<span class="w">serio_unregister_port</span><span class="pc">(&amp;</span><span class="w">up</span><span class="c">-&gt;</span><span class="w">ser</span><span class="pc">io)</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort</span><span class="w">.t</span><span class="c">ype</span> <span class="pc">!</span><span class="c">=</span> <span class="w">PORT_UNKNOWN</span><span class="pc">)</span>
		<span class="w">uart_remove_one_port</span><span class="pc">(&amp;</span><span class="w">sunsu_reg,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">up</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">ort);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">u</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">p</span><span class="c">ort.</span><span class="w">me</span><span class="pc">mb</span><span class="c">ase</span><span class="pc">)</span>
		<span class="w">of_iounmap</span><span class="pc">(&amp;</span><span class="w">o</span><span class="c">p-&gt;</span><span class="w">re</span><span class="pc">so</span><span class="c">urce</span><span class="pc">[</span><span class="c">0</span><span class="pc">],</span> <span class="w">up</span><span class="c">-&gt;</span><span class="pc">p</span><span class="c">ort</span><span class="pc">.</span><span class="w">me</span><span class="pc">mb</span><span class="c">ase</span><span class="pc">,</span> <span class="w">up</span><span class="c">-&gt;</span><span class="w">reg_size</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">kbdms)</span>
		<span class="w">k</span><span class="c">free(</span><span class="w">up</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="c">of_device_id</span> <span class="w">su_match</span><span class="c">[] = {</span>
	<span class="pc">{</span>
		<span class="c">.name</span> <span class="c">= "</span><span class="w">su</span><span class="c">",</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="pc">{</span>
		<span class="c">.name</span> <span class="c">= "</span><span class="w">su_pnp</span><span class="c">",</span>
	<span class="c">},</span>
	<span class="c">{</span>
		<span class="c">.name</span> <span class="c">= "</span><span class="w">se</span><span class="pc">ria</span><span class="c">l",</span>
		<span class="pc">.</span><span class="w">c</span><span class="c">ompatible</span> <span class="c">= "</span><span class="pc">s</span><span class="c">u</span><span class="pc">"</span><span class="c">,</span>
	<span class="c">},</span>
	<span class="pc">{</span>
		<span class="c">.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="pc">= </span><span class="c">"</span><span class="w">se</span><span class="pc">ria</span><span class="c">l",</span>
		<span class="pc">.</span><span class="w">c</span><span class="c">ompatible</span> <span class="c">= "</span><span class="w">s</span><span class="pc">u"</span><span class="c">,</span>
	<span class="c">},</span>
	<span class="w">{},</span>
<span class="pc">};</span>
<span class="c">MODULE_DEVICE_TABLE(of,</span> <span class="w">su_match</span><span class="c">);</span>

<span class="c">static</span> <span class="c">struct</span> <span class="c">platform_driver</span> <span class="w">su_driver</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">d</span><span class="c">river</span> <span class="c">= {</span>
		<span class="c">.name</span> <span class="c">= "</span><span class="w">s</span><span class="pc">u"</span><span class="c">,</span>
		<span class="c">.</span><span class="w">of_match_table</span> <span class="c">=</span> <span class="w">s</span><span class="pc">u_m</span><span class="c">atch,</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="c">.probe</span>		<span class="c">=</span> <span class="w">su_probe</span><span class="c">,</span>
	<span class="c">.remove</span>		<span class="c">=</span> <span class="w">su_remove</span><span class="c">,</span>
<span class="c">};</span>

<span class="c">static</span> <span class="c">int</span> <span class="c">__init</span> <span class="w">sunsu_init</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">d</span><span class="c">evice_node</span> <span class="c">*</span><span class="w">dp</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>
	<span class="c">int</span> <span class="w">num_uart</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">for_each_node_by_name</span><span class="pc">(</span><span class="w">dp</span><span class="pc">, "</span><span class="w">su") {</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">su_get_type</span><span class="pc">(</span><span class="w">d</span><span class="c">p</span><span class="pc">)</span><span class="c"> ==</span> <span class="w">SU_PORT_PORT</span><span class="pc">)</span>
			<span class="pc">n</span><span class="c">um_uart</span><span class="w">+</span><span class="c">+;</span>
	<span class="w">}</span>
	<span class="w">f</span><span class="pc">or_</span><span class="c">each_node_by_name</span><span class="pc">(</span><span class="w">dp</span><span class="c">, "</span><span class="w">su_pnp</span><span class="pc">") </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="pc">su_</span><span class="c">get_type</span><span class="pc">(</span><span class="w">d</span><span class="c">p</span><span class="pc">)</span><span class="c"> ==</span> <span class="w">S</span><span class="c">U_PORT_PORT)</span>
			<span class="pc">n</span><span class="c">um_uart</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">f</span><span class="c">or_each_node_by_name(</span><span class="w">d</span><span class="pc">p, </span><span class="c">"</span><span class="w">ser</span><span class="pc">i</span><span class="c">al") {</span>
		<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">of_device_is_compatible</span><span class="c">(</span><span class="w">d</span><span class="pc">p</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="w">su</span><span class="pc">")) </span><span class="c">{</span>
			<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">su</span><span class="c">_get_type(dp</span><span class="pc">) </span><span class="c">==</span> <span class="pc">S</span><span class="c">U_PORT_PORT)</span>
				<span class="pc">n</span><span class="c">um_uart</span><span class="w">+</span><span class="c">+;</span>
		<span class="pc">}</span>
	<span class="w">}</span>
	<span class="w">for_each_node_by_type</span><span class="c">(</span><span class="w">d</span><span class="pc">p, </span><span class="c">"</span><span class="w">ser</span><span class="pc">i</span><span class="c">al</span><span class="pc">"</span><span class="c">) {</span>
		<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">o</span><span class="c">f_device_is_compatible</span><span class="pc">(</span><span class="w">d</span><span class="c">p</span><span class="pc">, </span><span class="c">"su</span><span class="w">"</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">s</span><span class="c">u_get_type</span><span class="pc">(d</span><span class="c">p</span><span class="pc">) </span><span class="c">==</span> <span class="pc">S</span><span class="c">U_PORT_PORT)</span>
				<span class="c">num_uart</span><span class="w">+</span><span class="c">+;</span>
		<span class="pc">}</span>
	<span class="w">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">n</span><span class="c">um_uart</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">sunserial_register_minors</span><span class="pc">(&amp;</span><span class="w">sunsu_reg</span><span class="pc">,</span> <span class="c">num_uart);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr)</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
	<span class="pc">}</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">platform_driver_register</span><span class="pc">(&amp;</span><span class="w">su_driver</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">n</span><span class="c">um_uart</span><span class="w">)</span>
		<span class="w">sunserial_unregister_minors</span><span class="pc">(&amp;</span><span class="c">sunsu_reg</span><span class="pc">,</span> <span class="pc">n</span><span class="c">um_uart);</span>

	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">__exit</span> <span class="w">sunsu_exit</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="w">platform_driver_unregister</span><span class="c">(&amp;</span><span class="pc">su_</span><span class="c">driver);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">sun</span><span class="c">su_reg</span><span class="w">.n</span><span class="pc">r)</span>
		<span class="c">sunserial_unregister_minors</span><span class="pc">(&amp;</span><span class="c">sunsu_reg</span><span class="pc">,</span> <span class="pc">s</span><span class="c">unsu_reg</span><span class="pc">.</span><span class="w">n</span><span class="pc">r</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">m</span><span class="c">odule_init(</span><span class="w">sunsu_init</span><span class="c">);</span>
<span class="c">module_exit(</span><span class="pc">sunsu_e</span><span class="c">xit);</span>

<span class="pc">MODULE_A</span><span class="c">UTHOR("</span><span class="w">Eddie</span> <span class="w">C</span><span class="pc">.</span> <span class="w">Dost,</span> <span class="w">Peter</span> <span class="w">Zaitcev</span><span class="pc">,</span> <span class="w">a</span><span class="c">nd</span> <span class="w">David</span> <span class="w">S</span><span class="c">.</span> <span class="w">Miller</span><span class="pc">")</span><span class="c">;</span>
<span class="pc">MODULE_D</span><span class="c">ESCRIPTION("</span><span class="w">Sun</span> <span class="w">SU</span> <span class="w">se</span><span class="c">rial</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="pc">d</span><span class="c">river");</span>
<span class="w">MODULE_VERSION</span><span class="pc">("</span><span class="w">2</span><span class="pc">.</span><span class="w">0</span><span class="c">");</span>
<span class="c">MODULE_LICENSE("GPL");</span>

</pre>
</body>
</html>

