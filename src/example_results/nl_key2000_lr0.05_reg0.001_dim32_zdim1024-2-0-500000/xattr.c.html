<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>




<span class="w">#include</span> <span class="w">"ubifs.h"</span>
<span class="w">#include</span> <span class="w">&lt;linux/fs.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/xattr.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/posix_acl_xattr</span><span class="c">.h&gt;</span>


<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">MAX_XATTRS_PER_INODE</span> <span class="w">65535</span>


<span class="w">e</span><span class="c">num</span> <span class="c">{</span>
	<span class="w">USER_XATTR</span><span class="pc">,</span>
	<span class="w">TRUSTED_XATTR</span><span class="c">,</span>
	<span class="w">SECURITY_XATTR</span><span class="c">,</span>
<span class="c">};</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">inode_operations</span> <span class="w">empty_iops</span><span class="pc">;</span>
<span class="c">static</span> <span class="c">const</span> <span class="c">struct</span> <span class="pc">f</span><span class="c">ile_operations</span> <span class="w">empty_fops</span><span class="pc">;</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">create_xattr</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">node</span> <span class="c">*</span><span class="w">ho</span><span class="c">st,</span>
			<span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">qstr</span> <span class="c">*</span><span class="w">nm</span><span class="pc">,</span> <span class="c">const</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">names_len</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*inode;</span>
	<span class="c">struct</span> <span class="w">ubifs_inode</span> <span class="c">*</span><span class="w">ui,</span><span class="pc"> </span><span class="c">*</span><span class="w">host_ui</span> <span class="pc">=</span> <span class="w">u</span><span class="pc">b</span><span class="c">ifs_inode</span><span class="pc">(</span><span class="w">h</span><span class="pc">ost</span><span class="c">);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_budget_req</span> <span class="w">r</span><span class="c">eq</span> <span class="pc">= { </span><span class="c">.</span><span class="w">new_ino</span> <span class="c">=</span> <span class="c">1</span><span class="w">,</span><span class="pc"> </span><span class="c">.</span><span class="w">new_dent</span> <span class="c">=</span> <span class="pc">1</span><span class="c">,</span>
				<span class="c">.</span><span class="w">new_ino_d</span> <span class="c">=</span> <span class="w">ALIGN</span><span class="pc">(</span><span class="w">si</span><span class="pc">ze</span><span class="c">,</span> <span class="w">8), .dirtied_ino</span> <span class="w">=</span> <span class="pc">1</span><span class="c">,</span>
				<span class="c">.</span><span class="w">dirtied_ino_d</span> <span class="c">=</span> <span class="w">A</span><span class="c">LIGN</span><span class="pc">(</span><span class="w">h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len,</span> <span class="w">8) };</span>

	<span class="w">i</span><span class="c">f</span> <span class="c">(host_ui-&gt;</span><span class="w">xattr_cnt</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">MAX_XATTRS_PER_INODE</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ubifs_err</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">"</span><span class="w">ino</span><span class="c">de</span> <span class="pc">%</span><span class="w">l</span><span class="c">u</span> <span class="w">a</span><span class="pc">l</span><span class="c">ready</span> <span class="w">h</span><span class="pc">a</span><span class="c">s</span> <span class="w">t</span><span class="pc">oo</span> <span class="w">many</span> <span class="w">xattrs</span> <span class="w">(</span><span class="pc">%</span><span class="c">d</span><span class="w">),</span> <span class="w">ca</span><span class="pc">n</span><span class="c">not</span> <span class="w">c</span><span class="c">reate</span> <span class="w">more"</span><span class="c">,</span>
			  <span class="w">h</span><span class="pc">ost</span><span class="c">-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no</span><span class="pc">,</span> <span class="c">host_ui-&gt;xattr_cnt);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">ENOSPC</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">names_len</span> <span class="pc">=</span> <span class="pc">h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr_names</span> <span class="pc">+</span> <span class="w">h</span><span class="c">ost_ui-&gt;</span><span class="pc">xattr_c</span><span class="c">nt</span> <span class="w">+</span> <span class="w">nm</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">en</span> <span class="pc">+</span> <span class="pc">1;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">n</span><span class="c">ames_len</span> <span class="pc">&gt;</span> <span class="w">XATTR_LIST_MAX</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ubifs_err</span><span class="pc">(</span><span class="w">c</span><span class="pc">, </span><span class="c">"</span><span class="w">c</span><span class="pc">ann</span><span class="c">ot</span> <span class="w">a</span><span class="pc">d</span><span class="c">d</span> <span class="w">one</span> <span class="w">more</span> <span class="w">xattr</span> <span class="w">na</span><span class="pc">me</span> <span class="w">t</span><span class="pc">o</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="w">%</span><span class="pc">l</span><span class="c">u</span><span class="w">,</span> <span class="w">to</span><span class="pc">t</span><span class="c">al</span> <span class="w">names</span> <span class="w">l</span><span class="pc">eng</span><span class="c">th</span> <span class="w">would</span> <span class="w">become</span> <span class="pc">%</span><span class="c">d</span><span class="pc">,</span> <span class="w">m</span><span class="c">ax</span><span class="w">.</span> <span class="w">is</span> <span class="pc">%d"</span><span class="c">,</span>
			  <span class="w">h</span><span class="pc">o</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no,</span> <span class="pc">n</span><span class="c">ames_len</span><span class="pc">,</span> <span class="c">XATTR_LIST_MAX</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">ENOSPC</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_budget_space</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="pc">eq)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="pc">=</span> <span class="w">ubifs_new_inode</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">h</span><span class="c">ost</span><span class="pc">,</span> <span class="w">S_IFREG</span> <span class="pc">|</span> <span class="w">S_IRWXUGO</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">err</span> <span class="c">=</span> <span class="c">PTR_ERR(</span><span class="w">i</span><span class="pc">no</span><span class="c">de);</span>
		<span class="c">goto</span> <span class="w">out_budg</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">ino</span><span class="c">de-&gt;</span><span class="w">i_mapping</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">a_ops</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">empty_aops</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">ode-&gt;</span><span class="w">i_op</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">empty_iops</span><span class="c">;</span>
	<span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_fop</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">empty_fops</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">n</span><span class="c">ode-&gt;</span><span class="w">i_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">S_SYNC</span> <span class="pc">|</span> <span class="w">S_NOATIME</span> <span class="pc">|</span> <span class="w">S_NOCMTIME</span> <span class="pc">|</span> <span class="w">S_NOQUOTA</span><span class="c">;</span>
	<span class="w">ui</span> <span class="pc">=</span> <span class="w">ubifs_inode</span><span class="c">(</span><span class="pc">in</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="c">i-&gt;</span><span class="w">xattr</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">ui-&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">UBIFS_XATTR_FL</span><span class="c">;</span>
	<span class="c">ui-&gt;</span><span class="w">da</span><span class="pc">t</span><span class="c">a</span> <span class="pc">=</span> <span class="w">kmemdup</span><span class="pc">(</span><span class="w">va</span><span class="pc">lu</span><span class="c">e</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize,</span> <span class="w">GFP_NOFS</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">free;</span>
	<span class="c">}</span>
	<span class="w">ino</span><span class="pc">d</span><span class="c">e-&gt;</span><span class="w">i_size</span> <span class="c">=</span> <span class="pc">u</span><span class="c">i-&gt;</span><span class="w">ui_size</span> <span class="w">=</span> <span class="w">s</span><span class="pc">ize</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">i-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span> <span class="c">=</span> <span class="w">s</span><span class="c">ize;</span>

	<span class="w">mu</span><span class="pc">tex_l</span><span class="c">ock(&amp;</span><span class="w">host_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>
	<span class="w">ho</span><span class="pc">st</span><span class="c">-&gt;</span><span class="w">i_ctime</span> <span class="c">=</span> <span class="w">ubifs_current_time</span><span class="c">(</span><span class="w">ho</span><span class="pc">st)</span><span class="c">;</span>
	<span class="w">h</span><span class="c">ost_ui-&gt;</span><span class="w">xattr_cnt</span> <span class="w">+</span><span class="pc">=</span> <span class="c">1;</span>
	<span class="pc">h</span><span class="c">ost_ui-&gt;</span><span class="w">xattr_size</span> <span class="w">+</span><span class="pc">=</span> <span class="w">CALC_DENT_SIZE</span><span class="pc">(</span><span class="w">nm</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="c">en</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">h</span><span class="c">ost_ui-&gt;</span><span class="pc">x</span><span class="c">attr_size</span> <span class="pc">+</span><span class="c">=</span> <span class="w">CALC_XATTR_BYTES</span><span class="pc">(</span><span class="w">s</span><span class="pc">ize</span><span class="c">);</span>
	<span class="pc">h</span><span class="c">ost_ui-&gt;</span><span class="w">xattr_names</span> <span class="w">+</span><span class="pc">=</span> <span class="w">n</span><span class="c">m-&gt;</span><span class="w">l</span><span class="c">en;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_jnl_update</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ho</span><span class="pc">st,</span> <span class="w">n</span><span class="c">m,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="w">0</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_cancel</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">utex_u</span><span class="c">nlock(&amp;</span><span class="pc">h</span><span class="c">ost_ui-&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>

	<span class="w">ubifs_release_budget</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">req</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">insert_inode_hash</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">return</span> <span class="c">0;</span>

<span class="w">o</span><span class="c">ut_cancel:</span>
	<span class="pc">h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr_cnt</span> <span class="w">-</span><span class="pc">=</span> <span class="c">1;</span>
	<span class="pc">h</span><span class="c">ost_ui-&gt;</span><span class="w">xattr_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">CALC_DENT_SIZE</span><span class="pc">(</span><span class="w">nm</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">e</span><span class="c">n);</span>
	<span class="w">h</span><span class="c">ost_ui-&gt;xattr_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">CALC_XATTR_BYTES</span><span class="pc">(</span><span class="w">s</span><span class="pc">ize</span><span class="c">);</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;host_ui-&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>
<span class="w">ou</span><span class="pc">t_f</span><span class="c">ree:</span>
	<span class="w">make_bad_inode</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
<span class="w">out_budg</span><span class="pc">:</span>
	<span class="w">ubifs_release_budget</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="c">eq);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">change_xattr</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*</span><span class="w">ho</span><span class="pc">st,</span>
			<span class="c">struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode</span><span class="pc">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">s</span><span class="c">ize)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ubifs_inode</span> <span class="c">*</span><span class="w">host_ui</span> <span class="pc">=</span> <span class="c">ubifs_inode(</span><span class="w">h</span><span class="pc">ost</span><span class="c">);</span>
	<span class="c">struct</span> <span class="pc">ubifs_ino</span><span class="c">de</span> <span class="c">*</span><span class="w">ui</span> <span class="c">=</span> <span class="pc">u</span><span class="c">bifs_inode</span><span class="pc">(i</span><span class="c">node);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_budget_req</span> <span class="w">re</span><span class="pc">q</span> <span class="w">=</span><span class="pc"> { </span><span class="c">.</span><span class="w">dirtied_ino</span> <span class="c">=</span> <span class="w">2</span><span class="pc">,</span>
		<span class="c">.</span><span class="w">dirtied_ino_d</span> <span class="c">=</span> <span class="w">ALIGN</span><span class="pc">(</span><span class="w">si</span><span class="pc">ze</span><span class="c">,</span> <span class="w">8) +</span> <span class="w">A</span><span class="pc">L</span><span class="c">IGN</span><span class="pc">(h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len,</span> <span class="w">8) };</span>

	<span class="w">ubifs_assert</span><span class="c">(</span><span class="pc">u</span><span class="c">i-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span> <span class="w">=</span><span class="c">=</span> <span class="w">ino</span><span class="c">de-&gt;</span><span class="w">i_size</span><span class="c">);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_budget_space</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="c">eq</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">k</span><span class="c">free(</span><span class="pc">u</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="c">ata);</span>
	<span class="w">u</span><span class="c">i-&gt;</span><span class="pc">d</span><span class="c">ata</span> <span class="pc">=</span> <span class="w">kmemdup</span><span class="pc">(</span><span class="w">v</span><span class="c">alue</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize,</span> <span class="w">GFP_NOFS</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!u</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="c">ata</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">free;</span>
	<span class="c">}</span>
	<span class="w">ino</span><span class="pc">d</span><span class="c">e-&gt;</span><span class="w">i_size</span> <span class="c">=</span> <span class="c">ui-&gt;</span><span class="w">ui_size</span> <span class="w">=</span> <span class="w">s</span><span class="pc">ize</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">i-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span> <span class="c">=</span> <span class="w">s</span><span class="c">ize;</span>

	<span class="w">mu</span><span class="pc">tex_l</span><span class="c">ock(&amp;</span><span class="w">host_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>
	<span class="w">ho</span><span class="pc">st</span><span class="c">-&gt;</span><span class="w">i_ctime</span> <span class="c">=</span> <span class="w">ubifs_current_time</span><span class="c">(</span><span class="w">ho</span><span class="pc">st)</span><span class="c">;</span>
	<span class="w">h</span><span class="c">ost_ui-&gt;</span><span class="w">xattr_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">CALC_XATTR_BYTES</span><span class="pc">(u</span><span class="c">i-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len);</span>
	<span class="w">h</span><span class="c">ost_ui-&gt;xattr_size</span> <span class="w">+</span><span class="c">=</span> <span class="pc">C</span><span class="c">ALC_XATTR_BYTES</span><span class="pc">(</span><span class="w">s</span><span class="c">ize);</span>

	
	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ubifs_jnl_change_xattr</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="w">h</span><span class="pc">ost)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_cancel</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">utex_u</span><span class="c">nlock(&amp;host_ui-&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>

	<span class="w">ubifs_release_budget</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">req</span><span class="c">);</span>
	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">o</span><span class="pc">ut_</span><span class="c">cancel:</span>
	<span class="w">h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">CALC_XATTR_BYTES</span><span class="pc">(</span><span class="w">si</span><span class="pc">ze</span><span class="c">);</span>
	<span class="w">h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;xattr_size</span> <span class="w">+</span><span class="pc">=</span> <span class="w">C</span><span class="c">ALC_XATTR_BYTES</span><span class="pc">(</span><span class="w">ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;host_ui-&gt;</span><span class="pc">u</span><span class="c">i_mutex);</span>
	<span class="w">make_bad_inode</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de);</span>
<span class="w">o</span><span class="pc">ut_f</span><span class="c">ree:</span>
	<span class="w">ubifs_release_budget</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="pc">eq</span><span class="c">);</span>
	<span class="c">return</span> <span class="w">e</span><span class="c">rr;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">check_namespace</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">qstr</span> <span class="c">*</span><span class="w">nm</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(nm-&gt;</span><span class="w">l</span><span class="c">en</span> <span class="pc">&gt;</span> <span class="w">UBIFS_MAX_NLEN</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">ENAMETOOLONG</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">s</span><span class="c">trncmp(</span><span class="pc">nm</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">ame,</span> <span class="w">XATTR_TRUSTED_PREFIX</span><span class="pc">,</span>
		     <span class="w">XATTR_TRUSTED_PREFIX_LEN</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(nm-&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="w">[si</span><span class="pc">zeo</span><span class="c">f(</span><span class="pc">X</span><span class="c">ATTR_TRUSTED_PREFIX</span><span class="w">) </span><span class="pc">-</span> <span class="c">1</span><span class="w">] == '\0')</span>
			<span class="w">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
		<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">TRUSTED_XATTR</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!s</span><span class="c">trncmp(nm-&gt;name,</span> <span class="w">XATTR_USER_PREFIX</span><span class="c">,</span>
				      <span class="w">XATTR_USER_PREFIX_LEN</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(nm-&gt;</span><span class="w">n</span><span class="c">ame</span><span class="w">[X</span><span class="pc">ATTR_USER_PREFIX_</span><span class="c">LEN</span><span class="w">] =</span><span class="pc">= </span><span class="c">'\0</span><span class="pc">'</span><span class="c">)</span>
			<span class="w">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
		<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">USER_XATTR</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strn</span><span class="c">cmp(nm</span><span class="pc">-</span><span class="c">&gt;name,</span> <span class="w">XATTR_SECURITY_PREFIX</span><span class="c">,</span>
				     <span class="w">XATTR_SECURITY_PREFIX_LEN</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(nm-&gt;</span><span class="w">n</span><span class="c">ame</span><span class="w">[si</span><span class="pc">zeo</span><span class="c">f(</span><span class="pc">XATTR_SECURITY_PREFIX</span><span class="w">)</span><span class="pc"> </span><span class="c">-</span> <span class="c">1</span><span class="w">]</span><span class="pc"> =</span><span class="c">= '\</span><span class="w">0'</span><span class="pc">)</span>
			<span class="w">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
		<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">SECURITY_XATTR</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">EO</span><span class="c">PNOTSUPP;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="w">iget_xattr</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span><span class="c">,</span> <span class="w">ino_t</span> <span class="w">inum</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">nod</span><span class="c">e</span> <span class="c">*inode</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="pc">=</span> <span class="w">ubifs_iget</span><span class="c">(</span><span class="w">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">vfs_sb</span><span class="pc">,</span> <span class="w">i</span><span class="pc">nu</span><span class="c">m</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(IS_ERR(inode</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ubifs_err</span><span class="c">(</span><span class="w">c</span><span class="pc">, "</span><span class="w">dead</span> <span class="w">extended</span> <span class="w">at</span><span class="pc">tri</span><span class="c">bute</span> <span class="w">e</span><span class="pc">n</span><span class="c">try</span><span class="w">,</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="pc">%</span><span class="c">d</span><span class="pc">"</span><span class="c">,</span>
			  <span class="w">(i</span><span class="pc">nt</span><span class="w">)P</span><span class="pc">T</span><span class="c">R_ERR(</span><span class="pc">ino</span><span class="c">de</span><span class="pc">))</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">in</span><span class="pc">o</span><span class="c">de;</span>
	<span class="c">}</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">ubifs_inode</span><span class="c">(</span><span class="pc">ino</span><span class="c">de</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">i</span><span class="c">node;</span>
	<span class="c">ubifs_err</span><span class="pc">(</span><span class="w">c,</span><span class="pc"> "</span><span class="w">corrupt</span> <span class="w">e</span><span class="c">xtended</span> <span class="w">at</span><span class="pc">tri</span><span class="c">bute</span> <span class="w">e</span><span class="pc">nt</span><span class="c">ry");</span>
	<span class="w">iput</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">return</span> <span class="w">E</span><span class="c">RR_PTR(-EINVAL);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">setxattr</span><span class="c">(struct</span> <span class="c">inode</span> <span class="c">*</span><span class="w">ho</span><span class="c">st,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*name</span><span class="pc">,</span> <span class="c">const</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">v</span><span class="pc">alu</span><span class="c">e,</span>
		    <span class="pc">s</span><span class="c">ize_t</span> <span class="c">size</span><span class="pc">,</span> <span class="c">int</span> <span class="pc">f</span><span class="c">lags)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*inode</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span> <span class="pc">=</span> <span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="c">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_fs_info</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">qstr</span> <span class="w">nm</span> <span class="pc">=</span> <span class="w">QSTR_INIT</span><span class="c">(name</span><span class="pc">,</span> <span class="w">str</span><span class="pc">l</span><span class="c">en(</span><span class="pc">na</span><span class="c">me));</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_dent_node</span> <span class="c">*</span><span class="w">xent</span><span class="c">;</span>
	<span class="w">un</span><span class="pc">i</span><span class="c">on</span> <span class="w">ubifs_key</span> <span class="w">k</span><span class="c">ey;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">t</span><span class="c">ype;</span>

	<span class="w">ubifs_assert</span><span class="c">(</span><span class="w">mutex_is_locked(</span><span class="pc">&amp;</span><span class="w">h</span><span class="pc">o</span><span class="c">st-&gt;</span><span class="w">i_mutex</span><span class="pc">)</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">&gt;</span> <span class="w">UBIFS_MAX_INO_DATA</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">ERANGE</span><span class="c">;</span>

	<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">check_namespace</span><span class="pc">(&amp;</span><span class="w">nm</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe;</span>

	<span class="w">xent</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">m</span><span class="c">alloc(</span><span class="w">UBIFS_MAX_XENT_NODE_SZ</span><span class="c">,</span> <span class="w">GFP_NOFS</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xent</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	
	<span class="w">xent_key_init</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">n</span><span class="c">m);</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_tnc_lookup_nm</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">e</span><span class="c">y,</span> <span class="w">x</span><span class="pc">ent, </span><span class="c">&amp;nm);</span>
	<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(err</span> <span class="pc">!</span><span class="c">= -</span><span class="pc">EN</span><span class="c">OENT)</span>
			<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_f</span><span class="c">ree;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">&amp;</span> <span class="w">XATTR_REPLACE</span><span class="c">)</span>
			
			<span class="pc">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">ENODATA</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="c">err</span> <span class="c">=</span> <span class="w">create_xattr</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">n</span><span class="c">m</span><span class="pc">,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">,</span> <span class="w">si</span><span class="pc">ze</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">free;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">XATTR_CREATE</span><span class="c">) {</span>
		
		<span class="c">err</span> <span class="pc">= </span><span class="c">-</span><span class="w">EEXIST</span><span class="c">;</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">free;</span>
	<span class="c">}</span>

	<span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="pc">=</span> <span class="w">iget_xattr</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">le64_to_cpu</span><span class="pc">(</span><span class="w">xent-</span><span class="pc">&gt;</span><span class="w">inum</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">PTR_ERR(</span><span class="w">i</span><span class="pc">no</span><span class="c">de);</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">free;</span>
	<span class="c">}</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">change_xattr</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ho</span><span class="c">st</span><span class="pc">,</span> <span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">va</span><span class="pc">lu</span><span class="c">e</span><span class="pc">,</span> <span class="w">si</span><span class="pc">ze</span><span class="c">);</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de);</span>

<span class="w">o</span><span class="pc">ut_</span><span class="c">free:</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">xent</span><span class="c">);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="w">i</span><span class="c">nt</span> <span class="w">ubifs_setxattr</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span> <span class="c">*</span><span class="w">d</span><span class="pc">en</span><span class="c">try,</span> <span class="c">const</span> <span class="c">char</span> <span class="c">*name,</span>
		   <span class="c">const</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">v</span><span class="c">alue</span><span class="pc">,</span> <span class="c">size_t</span> <span class="c">size</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">f</span><span class="c">lags)</span>
<span class="c">{</span>
	<span class="w">dbg_gen("xattr</span> <span class="w">'%s'</span><span class="c">,</span> <span class="w">ho</span><span class="c">st</span> <span class="w">in</span><span class="pc">o</span> <span class="pc">%</span><span class="w">l</span><span class="c">u</span> <span class="w">('%pd'),</span> <span class="pc">s</span><span class="c">ize</span> <span class="c">%</span><span class="w">zd</span><span class="pc">"</span><span class="c">,</span>
		<span class="c">name,</span> <span class="w">d_</span><span class="c">inode(</span><span class="pc">d</span><span class="c">entry</span><span class="w">)-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no,</span> <span class="w">d</span><span class="pc">e</span><span class="c">ntry,</span> <span class="pc">s</span><span class="c">ize</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">setxattr</span><span class="c">(</span><span class="w">d_</span><span class="c">inode(</span><span class="pc">d</span><span class="c">entry</span><span class="pc">)</span><span class="c">,</span> <span class="w">n</span><span class="pc">a</span><span class="c">me,</span> <span class="w">v</span><span class="pc">al</span><span class="c">ue,</span> <span class="pc">s</span><span class="c">ize,</span> <span class="w">f</span><span class="c">lags);</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">ubifs_getxattr</span><span class="c">(struct</span> <span class="pc">den</span><span class="c">try</span> <span class="c">*dentry,</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*name,</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">buf</span><span class="c">,</span>
		       <span class="c">size_t</span> <span class="c">size)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*</span><span class="pc">i</span><span class="c">node</span><span class="pc">,</span><span class="c"> *</span><span class="w">ho</span><span class="pc">st</span> <span class="w">=</span> <span class="w">d_</span><span class="c">inode(</span><span class="pc">d</span><span class="c">entry);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span> <span class="c">=</span> <span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="c">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_fs_info</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">qstr</span> <span class="w">nm</span> <span class="pc">=</span> <span class="w">QSTR_INIT</span><span class="c">(</span><span class="pc">n</span><span class="c">ame</span><span class="pc">,</span> <span class="w">str</span><span class="pc">l</span><span class="c">en(</span><span class="pc">na</span><span class="c">me));</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ubifs_inode</span> <span class="c">*</span><span class="w">ui</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ubifs_dent_node</span> <span class="c">*</span><span class="w">xent</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="w">ubifs_key</span> <span class="w">k</span><span class="c">ey;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">dbg_gen(</span><span class="pc">"</span><span class="w">xattr</span> <span class="w">'%s'</span><span class="c">,</span> <span class="w">ino</span> <span class="w">%l</span><span class="c">u</span> <span class="w">('%pd'),</span> <span class="w">bu</span><span class="pc">f</span> <span class="w">s</span><span class="c">ize</span> <span class="c">%</span><span class="w">zd</span><span class="pc">"</span><span class="c">,</span> <span class="w">n</span><span class="c">ame,</span>
		<span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no,</span> <span class="w">de</span><span class="pc">n</span><span class="c">try,</span> <span class="pc">s</span><span class="c">ize);</span>

	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">check_namespace</span><span class="pc">(&amp;</span><span class="w">nm</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>

	<span class="w">xent</span> <span class="pc">=</span> <span class="pc">km</span><span class="c">alloc(</span><span class="w">UBIFS_MAX_XENT_NODE_SZ</span><span class="c">,</span> <span class="w">GFP_NOFS</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xent)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-ENOMEM;</span>

	<span class="w">xent_key_init</span><span class="pc">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">n</span><span class="c">m);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ubifs_tnc_lookup_nm</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">e</span><span class="c">y,</span> <span class="w">x</span><span class="pc">ent, </span><span class="c">&amp;nm);</span>
	<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(err</span> <span class="c">== -</span><span class="pc">EN</span><span class="c">OENT)</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">ENODATA</span><span class="c">;</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_u</span><span class="c">nlock;</span>
	<span class="c">}</span>

	<span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="pc">=</span> <span class="w">iget_xattr</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">le64_to_cpu</span><span class="pc">(x</span><span class="c">ent</span><span class="w">-</span><span class="c">&gt;</span><span class="w">inum</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">err</span> <span class="c">=</span> <span class="c">PTR_ERR(</span><span class="w">i</span><span class="pc">no</span><span class="c">de);</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_u</span><span class="c">nlock;</span>
	<span class="c">}</span>

	<span class="w">ui</span> <span class="pc">=</span> <span class="w">ubifs_inode</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ubifs_assert</span><span class="c">(inode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_size</span> <span class="w">=</span><span class="pc">=</span> <span class="pc">u</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len);</span>
	<span class="w">u</span><span class="pc">b</span><span class="c">ifs_assert</span><span class="pc">(</span><span class="w">u</span><span class="pc">bifs_i</span><span class="c">node</span><span class="pc">(</span><span class="w">ho</span><span class="c">st</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">xattr_size</span> <span class="w">&gt;</span> <span class="pc">u</span><span class="c">i-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span><span class="pc">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">b</span><span class="pc">u</span><span class="c">f</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(ui-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span> <span class="pc">&gt;</span> <span class="w">s</span><span class="pc">ize</span><span class="c">) {</span>
			<span class="w">ubifs_err</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">"</span><span class="w">b</span><span class="pc">uff</span><span class="c">er</span> <span class="w">s</span><span class="c">ize</span> <span class="c">%</span><span class="w">zd,</span> <span class="w">xattr</span> <span class="w">l</span><span class="c">en</span> <span class="pc">%</span><span class="c">d</span><span class="pc">"</span><span class="c">,</span>
				  <span class="pc">s</span><span class="c">ize</span><span class="pc">,</span> <span class="pc">u</span><span class="c">i-&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len);</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">= -</span><span class="w">ERANGE</span><span class="c">;</span>
			<span class="c">goto</span> <span class="w">out_iput</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="w">m</span><span class="c">emcpy(</span><span class="pc">b</span><span class="c">uf,</span> <span class="c">ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="c">ata,</span> <span class="pc">u</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">ata_</span><span class="c">len);</span>
	<span class="w">}</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="c">ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len;</span>

<span class="w">o</span><span class="pc">ut_</span><span class="c">iput</span><span class="w">:</span>
	<span class="w">iput</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
<span class="w">ou</span><span class="pc">t_u</span><span class="c">nlock:</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">xent</span><span class="c">);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">ubifs_listxattr</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span> <span class="c">*</span><span class="pc">den</span><span class="c">try,</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="pc">buff</span><span class="c">er,</span> <span class="c">size_t</span> <span class="c">size</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="w">ubifs_key</span> <span class="w">k</span><span class="c">ey;</span>
	<span class="c">struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*</span><span class="w">ho</span><span class="c">st</span> <span class="pc">=</span> <span class="w">d_</span><span class="c">inode(</span><span class="pc">d</span><span class="c">entry);</span>
	<span class="c">struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span> <span class="c">=</span> <span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="c">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_fs_info</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_inode</span> <span class="c">*</span><span class="w">host_ui</span> <span class="c">=</span> <span class="w">u</span><span class="c">bifs_inode</span><span class="pc">(</span><span class="w">h</span><span class="pc">ost</span><span class="c">);</span>
	<span class="c">struct</span> <span class="w">ubifs_dent_node</span> <span class="c">*</span><span class="w">xent,</span><span class="c"> *</span><span class="w">pxent</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="w">written</span> <span class="w">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">qstr</span> <span class="w">nm</span> <span class="w">=</span><span class="pc"> { </span><span class="c">.</span><span class="w">n</span><span class="c">ame</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL</span> <span class="pc">}</span><span class="c">;</span>

	<span class="w">dbg_gen(</span><span class="pc">"</span><span class="w">ino</span> <span class="pc">%</span><span class="w">l</span><span class="c">u</span> <span class="w">('%pd'),</span> <span class="w">bu</span><span class="pc">ff</span><span class="c">er</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">%</span><span class="w">zd</span><span class="pc">"</span><span class="c">,</span> <span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no,</span>
		<span class="w">de</span><span class="pc">n</span><span class="c">try</span><span class="pc">,</span> <span class="pc">s</span><span class="c">ize);</span>

	<span class="w">l</span><span class="c">en</span> <span class="c">=</span> <span class="w">host_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr_names</span> <span class="w">+</span> <span class="c">host_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr_cnt</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">b</span><span class="c">uffer</span><span class="pc">)</span>
		
		<span class="c">return</span> <span class="w">l</span><span class="c">en;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">l</span><span class="c">en</span> <span class="c">&gt;</span> <span class="pc">s</span><span class="c">ize</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">ERANGE</span><span class="c">;</span>

	<span class="w">lowest_xent_key</span><span class="pc">(</span><span class="w">c</span><span class="pc">, &amp;</span><span class="w">k</span><span class="c">ey</span><span class="pc">,</span> <span class="w">ho</span><span class="pc">st</span><span class="c">-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no);</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">1</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">;</span>

		<span class="w">xent</span> <span class="pc">=</span> <span class="w">ubifs_tnc_next_ent</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="c">ey</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">nm</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(xent</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="c">PTR_ERR(xent);</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="c">}</span>

		<span class="w">n</span><span class="c">m</span><span class="w">.n</span><span class="pc">a</span><span class="c">me</span> <span class="pc">=</span> <span class="c">xent</span><span class="pc">-</span><span class="c">&gt;name;</span>
		<span class="pc">n</span><span class="c">m.</span><span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="c">=</span> <span class="w">l</span><span class="pc">e1</span><span class="c">6_to_cpu(xent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nlen</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">check_namespace</span><span class="pc">(&amp;</span><span class="c">nm</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely(</span><span class="w">t</span><span class="c">ype</span> <span class="w">&lt;</span> <span class="c">0</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe;</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="pc">!</span><span class="c">=</span> <span class="w">TRUSTED_XATTR</span> <span class="pc">|</span><span class="c">|</span> <span class="w">capable</span><span class="c">(</span><span class="w">CAP_SYS_ADMIN</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">m</span><span class="c">emcpy(</span><span class="w">b</span><span class="c">uffer</span> <span class="pc">+</span> <span class="w">written</span><span class="c">,</span> <span class="w">n</span><span class="c">m</span><span class="pc">.</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span><span class="pc">,</span> <span class="pc">n</span><span class="c">m</span><span class="pc">.</span><span class="c">len</span> <span class="w">+</span> <span class="pc">1</span><span class="c">);</span>
			<span class="w">w</span><span class="c">ritten</span> <span class="pc">+</span><span class="c">=</span> <span class="c">nm</span><span class="pc">.l</span><span class="c">en</span> <span class="pc">+</span> <span class="c">1;</span>
		<span class="c">}</span>

		<span class="w">k</span><span class="c">free(</span><span class="w">pxent</span><span class="c">);</span>
		<span class="w">p</span><span class="c">xent</span> <span class="c">=</span> <span class="w">xent</span><span class="pc">;</span>
		<span class="w">key_read</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">x</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">k</span><span class="pc">ey, </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">ey)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">k</span><span class="c">free(pxent);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err</span> <span class="w">!</span><span class="pc">= </span><span class="c">-</span><span class="w">E</span><span class="pc">NOE</span><span class="c">NT) {</span>
		<span class="w">ubifs_err</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">"</span><span class="w">c</span><span class="pc">a</span><span class="c">nnot</span> <span class="w">f</span><span class="pc">i</span><span class="c">nd</span> <span class="w">n</span><span class="pc">ex</span><span class="c">t</span> <span class="w">direntry,</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="pc">%</span><span class="c">d</span><span class="pc">"</span><span class="c">,</span> <span class="w">e</span><span class="c">rr);</span>
		<span class="c">return</span> <span class="c">err;</span>
	<span class="c">}</span>

	<span class="w">ubifs_assert</span><span class="c">(</span><span class="w">written</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">s</span><span class="pc">ize</span><span class="c">);</span>
	<span class="c">return</span> <span class="w">w</span><span class="c">ritten;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">remove_xattr</span><span class="c">(struct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span><span class="c">,</span> <span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="w">ho</span><span class="c">st</span><span class="pc">,</span>
			<span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*inode,</span> <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">qstr</span> <span class="c">*</span><span class="w">nm</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="c">struct</span> <span class="w">ubifs_inode</span> <span class="c">*</span><span class="w">host_ui</span> <span class="pc">=</span> <span class="w">u</span><span class="c">bifs_inode(</span><span class="w">h</span><span class="pc">ost</span><span class="c">);</span>
	<span class="c">struct</span> <span class="pc">ubifs_ino</span><span class="c">de</span> <span class="c">*</span><span class="w">ui</span> <span class="c">=</span> <span class="pc">u</span><span class="c">bifs_inode</span><span class="pc">(i</span><span class="c">node);</span>
	<span class="c">struct</span> <span class="w">ubifs_budget_req</span> <span class="w">re</span><span class="pc">q</span> <span class="w">=</span><span class="pc"> { </span><span class="c">.</span><span class="w">dirtied_ino</span> <span class="c">=</span> <span class="w">2,</span><span class="pc"> </span><span class="c">.</span><span class="w">mod_dent</span> <span class="c">=</span> <span class="w">1</span><span class="c">,</span>
				<span class="c">.</span><span class="w">dirtied_ino_d</span> <span class="c">=</span> <span class="w">ALIGN</span><span class="pc">(h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len,</span> <span class="w">8) };</span>

	<span class="w">ubifs_assert</span><span class="c">(ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len</span> <span class="w">=</span><span class="c">=</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e-&gt;</span><span class="w">i_size</span><span class="c">);</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_budget_space</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="c">eq</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;host_ui-&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>
	<span class="w">h</span><span class="pc">ost</span><span class="c">-&gt;</span><span class="w">i_ctime</span> <span class="pc">=</span> <span class="w">ubifs_current_time</span><span class="pc">(</span><span class="w">h</span><span class="pc">ost</span><span class="c">);</span>
	<span class="w">h</span><span class="c">ost_ui-&gt;</span><span class="w">xattr_cnt</span> <span class="w">-</span><span class="pc">=</span> <span class="c">1;</span>
	<span class="pc">h</span><span class="c">ost_ui-&gt;</span><span class="w">xattr_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">CALC_DENT_SIZE</span><span class="pc">(</span><span class="w">nm</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="c">en);</span>
	<span class="pc">h</span><span class="c">ost_ui-&gt;xattr_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">CALC_XATTR_BYTES</span><span class="pc">(</span><span class="w">ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len);</span>
	<span class="c">host_ui-&gt;</span><span class="w">xattr_names</span> <span class="w">-</span><span class="pc">=</span> <span class="w">n</span><span class="c">m-&gt;</span><span class="w">l</span><span class="c">en;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ubifs_jnl_delete_xattr</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">ho</span><span class="pc">st,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">,</span> <span class="c">nm</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">goto</span> <span class="w">out_cancel</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">utex_u</span><span class="c">nlock(&amp;</span><span class="pc">h</span><span class="c">ost_ui-&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>

	<span class="w">ubifs_release_budget</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">re</span><span class="pc">q)</span><span class="c">;</span>
	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">o</span><span class="pc">ut_</span><span class="c">cancel:</span>
	<span class="w">h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr_cnt</span> <span class="w">+</span><span class="pc">=</span> <span class="c">1;</span>
	<span class="pc">h</span><span class="c">ost_ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">xattr_size</span> <span class="w">+</span><span class="pc">=</span> <span class="w">CALC_DENT_SIZE</span><span class="pc">(n</span><span class="c">m</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="c">en);</span>
	<span class="w">h</span><span class="c">ost_ui-&gt;xattr_size</span> <span class="w">+</span><span class="c">=</span> <span class="w">CALC_XATTR_BYTES</span><span class="pc">(</span><span class="w">ui</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">da</span><span class="pc">ta_</span><span class="c">len);</span>
	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;host_ui-&gt;</span><span class="w">ui_mutex</span><span class="c">);</span>
	<span class="w">ubifs_release_budget</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">r</span><span class="pc">eq)</span><span class="c">;</span>
	<span class="w">make_bad_inode</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ubifs_removexattr</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span> <span class="c">*</span><span class="w">d</span><span class="pc">en</span><span class="c">try,</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*name</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="pc">i</span><span class="c">node</span><span class="pc">,</span><span class="c"> *</span><span class="w">ho</span><span class="pc">st</span> <span class="pc">=</span> <span class="w">d_</span><span class="c">inode(</span><span class="w">d</span><span class="pc">en</span><span class="c">try);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span> <span class="c">=</span> <span class="w">h</span><span class="pc">o</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="c">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_fs_info</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">qstr</span> <span class="w">nm</span> <span class="pc">=</span> <span class="w">QSTR_INIT</span><span class="c">(name</span><span class="pc">,</span> <span class="w">st</span><span class="pc">rl</span><span class="c">en(name));</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ubifs_dent_node</span> <span class="c">*</span><span class="w">xent</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="w">ubifs_key</span> <span class="w">k</span><span class="c">ey;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">dbg_gen</span><span class="pc">("</span><span class="w">xattr</span> <span class="w">'%s'</span><span class="c">,</span> <span class="w">ino</span> <span class="pc">%</span><span class="w">l</span><span class="c">u</span> <span class="w">('%pd')",</span> <span class="w">n</span><span class="pc">a</span><span class="c">me</span><span class="pc">,</span>
		<span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no,</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ubifs_assert</span><span class="c">(</span><span class="w">mutex_is_locked(</span><span class="pc">&amp;</span><span class="w">h</span><span class="pc">o</span><span class="c">st-&gt;</span><span class="w">i_mutex</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">check_namespace</span><span class="pc">(&amp;</span><span class="w">nm</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">xent</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">m</span><span class="c">alloc(</span><span class="w">UBIFS_MAX_XENT_NODE_SZ</span><span class="c">,</span> <span class="w">GFP_NOFS</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xent)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-ENOMEM;</span>

	<span class="w">xent_key_init</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">e</span><span class="c">y</span><span class="pc">,</span> <span class="w">ho</span><span class="c">st-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">n</span><span class="c">m);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ubifs_tnc_lookup_nm</span><span class="c">(</span><span class="w">c</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">k</span><span class="pc">e</span><span class="c">y,</span> <span class="w">x</span><span class="pc">ent, </span><span class="c">&amp;nm);</span>
	<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(err</span> <span class="c">== -</span><span class="pc">EN</span><span class="c">OENT)</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">ENODATA</span><span class="c">;</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">free;</span>
	<span class="c">}</span>

	<span class="w">ino</span><span class="pc">d</span><span class="c">e</span> <span class="pc">=</span> <span class="w">iget_xattr</span><span class="c">(</span><span class="w">c</span><span class="c">,</span> <span class="w">le64_to_cpu</span><span class="pc">(x</span><span class="c">ent</span><span class="w">-</span><span class="c">&gt;</span><span class="w">inum</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">err</span> <span class="c">=</span> <span class="c">PTR_ERR(</span><span class="w">i</span><span class="pc">no</span><span class="c">de);</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">free;</span>
	<span class="c">}</span>

	<span class="w">ubifs_assert</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_nlink</span> <span class="w">=</span><span class="pc">=</span> <span class="pc">1</span><span class="c">);</span>
	<span class="w">clear_nlink</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">remove_xattr</span><span class="c">(</span><span class="w">c</span><span class="pc">,</span> <span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">nm</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err)</span>
		<span class="w">set_nlink</span><span class="c">(</span><span class="pc">i</span><span class="c">node,</span> <span class="w">1</span><span class="c">);</span>

	
	<span class="w">iput</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>

<span class="w">o</span><span class="pc">ut_</span><span class="c">free:</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">xent</span><span class="c">);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span> <span class="w">security_listxattr</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span> <span class="c">*</span><span class="w">d</span><span class="c">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">l</span><span class="c">ist</span><span class="pc">,</span> <span class="pc">si</span><span class="c">ze_t</span> <span class="w">list_size</span><span class="pc">,</span>
				 <span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*</span><span class="pc">n</span><span class="c">ame</span><span class="pc">,</span> <span class="c">size_t</span> <span class="w">name_len</span><span class="pc">,</span> <span class="c">int</span> <span class="w">f</span><span class="c">lags)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="w">i</span><span class="c">nt</span> <span class="w">prefix_len</span> <span class="c">=</span> <span class="w">XATTR_SECURITY_PREFIX_LEN</span><span class="pc">;</span>
	<span class="pc">c</span><span class="c">onst</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span> <span class="w">total_len</span> <span class="pc">=</span> <span class="w">p</span><span class="c">refix_len</span> <span class="pc">+</span> <span class="w">n</span><span class="c">ame_len</span> <span class="pc">+</span> <span class="c">1;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">li</span><span class="pc">st</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="c">total_len</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="pc">l</span><span class="c">ist_size) {</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">li</span><span class="pc">st</span><span class="c">,</span> <span class="w">XATTR_SECURITY_PREFIX</span><span class="c">,</span> <span class="c">prefix_len</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">m</span><span class="c">emcpy(</span><span class="w">li</span><span class="pc">st</span> <span class="w">+</span> <span class="c">prefix_len,</span> <span class="w">n</span><span class="pc">ame</span><span class="c">,</span> <span class="w">n</span><span class="c">ame_len);</span>
		<span class="w">list[p</span><span class="pc">r</span><span class="c">efix_len</span> <span class="pc">+</span> <span class="w">n</span><span class="c">ame_len</span><span class="w">] = '\0</span><span class="pc">'</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">t</span><span class="c">otal_len;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">security_getxattr</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span> <span class="c">*</span><span class="w">d</span><span class="c">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="pc">n</span><span class="c">ame,</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">b</span><span class="pc">uff</span><span class="c">er,</span>
		      <span class="c">size_t</span> <span class="c">size</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">f</span><span class="c">lags)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">ubifs_getxattr</span><span class="c">(</span><span class="w">d</span><span class="c">,</span> <span class="w">n</span><span class="pc">ame</span><span class="c">,</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er,</span> <span class="c">size</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">security_setxattr</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span> <span class="c">*</span><span class="w">d</span><span class="c">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*name,</span>
			     <span class="pc">c</span><span class="c">onst</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">v</span><span class="c">alue,</span> <span class="c">size_t</span> <span class="c">size</span><span class="pc">,</span> <span class="c">int</span> <span class="pc">f</span><span class="c">lags</span><span class="pc">,</span>
			     <span class="pc">i</span><span class="c">nt</span> <span class="w">handler_flags</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">ubifs_setxattr</span><span class="c">(</span><span class="w">d</span><span class="c">,</span> <span class="pc">n</span><span class="c">ame,</span> <span class="w">v</span><span class="c">alue,</span> <span class="pc">s</span><span class="c">ize,</span> <span class="w">f</span><span class="c">lags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">xattr_handler</span> <span class="w">ubifs_xattr_security_handler</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">prefix</span> <span class="c">=</span> <span class="w">XATTR_SECURITY_PREFIX</span><span class="c">,</span>
	<span class="c">.</span><span class="w">li</span><span class="pc">s</span><span class="c">t</span>   <span class="c">=</span> <span class="w">security_listxattr</span><span class="c">,</span>
	<span class="c">.</span><span class="w">g</span><span class="c">et</span>    <span class="c">=</span> <span class="w">security_getxattr</span><span class="c">,</span>
	<span class="c">.</span><span class="w">s</span><span class="pc">e</span><span class="c">t</span>    <span class="c">=</span> <span class="w">security_setxattr</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="c">xattr_handler</span> <span class="c">*</span><span class="w">ubifs_xattr_handlers[</span><span class="pc">]</span><span class="c"> = {</span>
	<span class="c">&amp;</span><span class="w">u</span><span class="c">bifs_xattr_security_handler,</span>
	<span class="pc">N</span><span class="c">ULL,</span>
<span class="c">};</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">init_xattrs</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode,</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">xattr</span> <span class="c">*</span><span class="w">xattr_array</span><span class="pc">,</span>
		      <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="c">xattr</span> <span class="c">*</span><span class="w">x</span><span class="pc">attr;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="pc">n</span><span class="c">ame;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="pc">x</span><span class="c">attr</span> <span class="c">=</span> <span class="pc">x</span><span class="c">attr_array;</span> <span class="w">x</span><span class="pc">attr-</span><span class="c">&gt;</span><span class="w">n</span><span class="c">ame</span> <span class="w">!</span><span class="c">=</span> <span class="c">NULL;</span> <span class="w">x</span><span class="pc">attr</span><span class="w">+</span><span class="c">+) {</span>
		<span class="w">n</span><span class="pc">a</span><span class="c">me</span> <span class="c">=</span> <span class="w">k</span><span class="c">malloc(</span><span class="w">XATTR_SECURITY_PREFIX_LEN</span> <span class="w">+</span>
			       <span class="w">s</span><span class="pc">tr</span><span class="c">len(xattr</span><span class="pc">-</span><span class="c">&gt;name</span><span class="w">)</span><span class="pc"> </span><span class="c">+</span> <span class="pc">1,</span> <span class="w">GFP_NOFS</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">n</span><span class="c">ame) {</span>
			<span class="w">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>
		<span class="w">st</span><span class="pc">r</span><span class="c">cpy(</span><span class="pc">n</span><span class="c">ame</span><span class="pc">,</span> <span class="w">XATTR_SECURITY_PREFIX</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">st</span><span class="pc">r</span><span class="c">cpy(name</span> <span class="w">+</span> <span class="pc">X</span><span class="c">ATTR_SECURITY_PREFIX_LEN</span><span class="pc">,</span> <span class="w">x</span><span class="c">attr</span><span class="pc">-</span><span class="c">&gt;name);</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">setxattr</span><span class="c">(</span><span class="w">ino</span><span class="c">de,</span> <span class="w">n</span><span class="pc">a</span><span class="c">me,</span> <span class="pc">x</span><span class="c">attr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">v</span><span class="pc">a</span><span class="c">lue</span><span class="pc">,</span> <span class="w">x</span><span class="c">attr</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">value_len</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="pc">k</span><span class="c">free(</span><span class="pc">n</span><span class="c">ame);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="pc">rr</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
			<span class="w">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ubifs_init_security</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*</span><span class="w">d</span><span class="pc">en</span><span class="c">try,</span> <span class="c">struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode</span><span class="pc">,</span>
			<span class="pc">co</span><span class="c">nst</span> <span class="c">struct</span> <span class="w">qstr</span> <span class="c">*</span><span class="w">q</span><span class="c">str)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="pc">i</span><span class="c">node-&gt;</span><span class="w">i_mutex</span><span class="c">);</span>
	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">security_inode_init_security</span><span class="c">(inode,</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span><span class="pc">,</span> <span class="w">q</span><span class="c">str,</span>
					   <span class="w">&amp;init_xattrs</span><span class="pc">,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">m</span><span class="c">utex_unlock(&amp;inode-&gt;i_mutex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">ubifs_info</span> <span class="c">*</span><span class="w">c</span> <span class="c">=</span> <span class="w">den</span><span class="c">try-&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_fs_info</span><span class="c">;</span>
		<span class="w">ubifs_err</span><span class="c">(</span><span class="w">c,</span><span class="pc"> "</span><span class="w">ca</span><span class="c">nnot</span> <span class="w">initialize</span> <span class="w">security</span> <span class="w">f</span><span class="c">or</span> <span class="w">ino</span><span class="c">de</span> <span class="pc">%l</span><span class="c">u</span><span class="w">,</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">%d</span><span class="pc">"</span><span class="c">,</span>
			  <span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no,</span> <span class="w">e</span><span class="pc">r</span><span class="c">r);</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

</pre>
</body>
</html>

