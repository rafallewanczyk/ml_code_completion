<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/delay.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/device.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/gpio.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/io.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ioport</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">r</span><span class="c">q.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">e</span><span class="c">rrno.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">nt</span><span class="c">errupt.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">p</span><span class="c">latform_device.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">pi</span><span class="c">/spi.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">workqueue</span><span class="pc">.</span><span class="c">h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="w">portmux</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">bfin5xx_spi</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">blackfin</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">bfin_sport</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">cacheflush</span><span class="c">.h&gt;</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="c">DRV_NAME</span>	<span class="c">"</span><span class="w">bfin</span><span class="pc">-</span><span class="w">spo</span><span class="c">rt</span><span class="pc">-</span><span class="w">sp</span><span class="pc">i"</span>
<span class="c">#define</span> <span class="w">DRV_DESC</span>	<span class="c">"</span><span class="w">SPI</span> <span class="w">b</span><span class="pc">u</span><span class="c">s</span> <span class="w">via</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">Blackfin</span> <span class="w">SPORT</span><span class="pc">"</span>

<span class="w">M</span><span class="c">ODULE_AUTHOR("</span><span class="w">Cliff</span> <span class="w">Cai</span><span class="pc">"</span><span class="c">);</span>
<span class="pc">MODULE_D</span><span class="c">ESCRIPTION</span><span class="pc">(</span><span class="w">D</span><span class="pc">RV_D</span><span class="c">ESC</span><span class="pc">)</span><span class="c">;</span>
<span class="c">MODULE_LICENSE("GPL");</span>
<span class="pc">M</span><span class="c">ODULE_ALIAS("platform:</span><span class="w">b</span><span class="c">fin-</span><span class="w">spo</span><span class="c">rt</span><span class="pc">-</span><span class="w">sp</span><span class="pc">i</span><span class="w">"</span><span class="c">);</span>

<span class="w">e</span><span class="c">num</span> <span class="w">bfin_sport_spi_state</span> <span class="c">{</span>
	<span class="w">START_STATE</span><span class="c">,</span>
	<span class="w">RUNNING_STATE</span><span class="c">,</span>
	<span class="w">DONE_STATE</span><span class="c">,</span>
	<span class="w">ERROR_STATE</span><span class="c">,</span>
<span class="c">};</span>

<span class="pc">str</span><span class="c">uct</span> <span class="w">bfin_sport_spi_master_data</span><span class="pc">;</span>

<span class="pc">str</span><span class="c">uct</span> <span class="w">bfin_sport_transfer_ops</span> <span class="pc">{</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">(*</span><span class="w">w</span><span class="pc">r</span><span class="c">ite</span><span class="pc">) </span><span class="c">(struct</span> <span class="pc">bfin_sport_spi_m</span><span class="c">aster_data</span> <span class="c">*);</span>
	<span class="c">void</span> <span class="c">(*</span><span class="w">rea</span><span class="c">d</span><span class="pc">) </span><span class="c">(struct</span> <span class="c">bfin_sport_spi_master_data</span> <span class="c">*);</span>
	<span class="pc">v</span><span class="c">oid</span> <span class="c">(*</span><span class="w">du</span><span class="pc">p</span><span class="c">lex) (struct</span> <span class="pc">bfin_sport_s</span><span class="c">pi_master_data</span> <span class="c">*);</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="pc">bfin_sport_s</span><span class="c">pi_master_data</span> <span class="c">{</span>
	
	<span class="c">struct</span> <span class="pc">d</span><span class="c">evice</span> <span class="c">*dev;</span>

	
	<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="pc">m</span><span class="c">aster;</span>

	
	<span class="c">struct</span> <span class="w">sport_register</span> <span class="w">_</span><span class="c">_iomem</span> <span class="c">*regs;</span>
	<span class="c">int</span> <span class="w">err_irq</span><span class="c">;</span>

	
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="pc">*</span><span class="w">pin_req</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="w">workqueue_struct</span> <span class="c">*</span><span class="w">workqueue</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">work_</span><span class="c">struct</span> <span class="w">pump_messages</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">inlock_t</span> <span class="c">lock;</span>
	<span class="c">struct</span> <span class="pc">l</span><span class="c">ist_head</span> <span class="w">q</span><span class="c">ueue;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">b</span><span class="pc">us</span><span class="c">y;</span>
	<span class="pc">b</span><span class="c">ool</span> <span class="w">run</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="w">tasklet_struct</span> <span class="w">pump_transfers</span><span class="c">;</span>

	
	<span class="w">e</span><span class="c">num</span> <span class="w">bfin_sport_spi_state</span> <span class="pc">s</span><span class="c">tate;</span>
	<span class="c">struct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">cur_msg</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">spi_transfer</span> <span class="c">*</span><span class="w">cur_transfer</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">*</span><span class="w">cur_chip</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">ion</span> <span class="c">{</span>
		<span class="w">v</span><span class="pc">oi</span><span class="c">d</span> <span class="pc">*</span><span class="w">t</span><span class="pc">x</span><span class="c">;</span>
		<span class="w">u8</span> <span class="c">*</span><span class="w">tx8</span><span class="c">;</span>
		<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="c">*</span><span class="w">tx16</span><span class="c">;</span>
	<span class="pc">}</span><span class="c">;</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">tx_end</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">ni</span><span class="c">on</span> <span class="c">{</span>
		<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">rx</span><span class="c">;</span>
		<span class="w">u8</span> <span class="c">*</span><span class="w">rx8</span><span class="c">;</span>
		<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="c">*</span><span class="w">rx16</span><span class="c">;</span>
	<span class="w">}</span><span class="c">;</span>
	<span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">rx_end</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">nt</span> <span class="w">cs_change</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bfin_sport_transfer_ops</span> <span class="c">*</span><span class="w">o</span><span class="c">ps;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">{</span>
	<span class="pc">u</span><span class="c">16</span> <span class="w">ctl_reg</span><span class="c">;</span>
	<span class="c">u16</span> <span class="w">ba</span><span class="pc">u</span><span class="c">d;</span>
	<span class="c">u16</span> <span class="w">cs_chg_udelay</span><span class="c">;</span>	
	<span class="pc">u3</span><span class="c">2</span> <span class="w">cs_gpio</span><span class="c">;</span>
	<span class="pc">u1</span><span class="c">6</span> <span class="w">idle_tx_val</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">fin_sport_t</span><span class="c">ransfer_ops</span> <span class="c">*</span><span class="pc">o</span><span class="c">ps;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">bfin_sport_spi_enable</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">bfin_write_or</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">tcr1</span><span class="pc">,</span> <span class="w">TSPEN</span><span class="c">);</span>
	<span class="pc">b</span><span class="c">fin_write_or</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">rcr1</span><span class="pc">,</span> <span class="pc">T</span><span class="c">SPEN);</span>
	<span class="w">SSYNC</span><span class="pc">()</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_disable</span><span class="c">(struct</span> <span class="c">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">bfin_write_and</span><span class="c">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">t</span><span class="c">cr1</span><span class="w">, ~</span><span class="pc">T</span><span class="c">SPEN);</span>
	<span class="w">b</span><span class="pc">fin_write_a</span><span class="c">nd</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">rv_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">c</span><span class="c">r1</span><span class="w">, ~</span><span class="pc">T</span><span class="c">SPEN);</span>
	<span class="pc">S</span><span class="c">SYNC</span><span class="w">(</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span>
<span class="w">bfin_sport_hz_to_spi_baud</span><span class="c">(</span><span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">speed_hz</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u_long</span> <span class="w">clk</span><span class="pc">,</span> <span class="w">sclk</span> <span class="pc">=</span> <span class="w">get_sclk(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">di</span><span class="pc">v</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">s</span><span class="pc">c</span><span class="c">lk</span> <span class="w">/ (2</span> <span class="pc">*</span> <span class="w">s</span><span class="pc">p</span><span class="c">eed_hz</span><span class="w">)) -</span> <span class="w">1</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">d</span><span class="pc">i</span><span class="c">v</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="w">d</span><span class="c">iv</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">c</span><span class="pc">l</span><span class="c">k</span> <span class="c">=</span> <span class="w">s</span><span class="pc">c</span><span class="c">lk</span> <span class="w">/</span><span class="pc"> </span><span class="c">(</span><span class="w">2</span> <span class="w">*</span><span class="pc"> </span><span class="c">(div</span> <span class="w">+</span> <span class="c">1</span><span class="w">))</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">lk</span> <span class="c">&gt;</span> <span class="pc">s</span><span class="c">peed_hz</span><span class="pc">)</span>
		<span class="pc">d</span><span class="c">iv</span><span class="pc">+</span><span class="c">+;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">d</span><span class="c">iv;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_cs_active</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">*</span><span class="w">ch</span><span class="c">ip)</span>
<span class="c">{</span>
	<span class="w">gpio_direction_output</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cs_gpio</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_cs_deactive</span><span class="c">(struct</span> <span class="c">bfin_sport_spi_slave_data</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip)</span>
<span class="c">{</span>
	<span class="pc">g</span><span class="c">pio_direction_output(chip-&gt;</span><span class="pc">c</span><span class="c">s_gpio</span><span class="pc">,</span> <span class="pc">1</span><span class="c">);</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(chip-&gt;</span><span class="w">cs_chg_udelay</span><span class="pc">)</span>
		<span class="w">u</span><span class="pc">d</span><span class="c">elay(</span><span class="pc">c</span><span class="c">hip-&gt;cs_chg_udelay);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_stat_poll_complete</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">t</span><span class="c">imeout</span> <span class="pc">=</span> <span class="w">j</span><span class="c">iffies</span> <span class="pc">+</span> <span class="pc">H</span><span class="c">Z;</span>
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="pc">(!(</span><span class="w">bfin_read(</span><span class="pc">&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">r</span><span class="c">egs</span><span class="w">-</span><span class="c">&gt;</span><span class="w">st</span><span class="pc">at</span><span class="w">) </span><span class="pc">&amp;</span> <span class="w">RXNE</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">time_before</span><span class="c">(</span><span class="w">j</span><span class="c">iffies,</span> <span class="c">timeout))</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_u8_writer</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">du</span><span class="c">mmy</span><span class="pc">;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">tx</span> <span class="w">&lt;</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">tx_end</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tx16, *dr</span><span class="c">v_data-&gt;</span><span class="w">tx8+</span><span class="pc">+)</span><span class="c">;</span>
		<span class="w">bfin_sport_spi_stat_poll_complete</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">du</span><span class="pc">m</span><span class="c">my</span> <span class="c">=</span> <span class="w">bfin_read</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rx16</span><span class="c">);</span>
	<span class="pc">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_u8_reader</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">u1</span><span class="c">6</span> <span class="w">tx_val</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">cur_chip-</span><span class="c">&gt;</span><span class="w">idle_tx_val</span><span class="c">;</span>

	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">rx</span> <span class="w">&lt;</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">rx_end</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">tx16</span><span class="c">,</span> <span class="pc">t</span><span class="c">x_val);</span>
		<span class="w">bfin_sport_spi_stat_poll_complete</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">*dr</span><span class="c">v_data</span><span class="w">-</span><span class="c">&gt;</span><span class="w">rx8++</span><span class="pc"> </span><span class="c">=</span> <span class="w">bfin_read</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rx16</span><span class="c">);</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_u8_duplex</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">rx</span> <span class="w">&lt;</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">rx_end</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tx16, *dr</span><span class="c">v_data-&gt;</span><span class="w">tx8+</span><span class="pc">+)</span><span class="c">;</span>
		<span class="w">bfin_sport_spi_stat_poll_complete</span><span class="c">(</span><span class="w">d</span><span class="pc">rv_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">*dr</span><span class="c">v_data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rx8++</span><span class="pc"> </span><span class="c">=</span> <span class="w">bfin_read</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">rv_</span><span class="c">data-&gt;</span><span class="pc">re</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rx16</span><span class="c">);</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">bfin_sport_transfer_ops</span> <span class="w">bfin_sport_transfer_ops_u8</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">w</span><span class="c">rite</span>  <span class="pc">=</span> <span class="w">bfin_sport_spi_u8_writer</span><span class="c">,</span>
	<span class="c">.</span><span class="w">r</span><span class="pc">ea</span><span class="c">d</span>   <span class="c">=</span> <span class="w">bfin_sport_spi_u8_reader</span><span class="c">,</span>
	<span class="c">.</span><span class="w">du</span><span class="c">plex</span> <span class="c">=</span> <span class="w">bfin_sport_spi_u8_duplex</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">bfin_sport_spi_u16_writer</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">du</span><span class="c">mmy;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">tx</span> <span class="w">&lt;</span> <span class="w">drv</span><span class="pc">_</span><span class="c">data-&gt;</span><span class="w">tx_end</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">tx16, *dr</span><span class="pc">v_</span><span class="c">data-&gt;tx16</span><span class="w">+</span><span class="pc">+)</span><span class="c">;</span>
		<span class="w">bfin_sport_spi_stat_poll_complete</span><span class="c">(</span><span class="w">d</span><span class="pc">rv_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">du</span><span class="c">mmy</span> <span class="c">=</span> <span class="w">bfin_read</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rx16</span><span class="c">);</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_u16_reader</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">u1</span><span class="c">6</span> <span class="w">tx_val</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_chip-</span><span class="c">&gt;</span><span class="w">idle_tx_val</span><span class="c">;</span>

	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">rx</span> <span class="w">&lt;</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">rx_end</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">tx16</span><span class="c">,</span> <span class="pc">t</span><span class="c">x_val);</span>
		<span class="w">bfin_sport_spi_stat_poll_complete</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">*dr</span><span class="c">v_data</span><span class="w">-</span><span class="c">&gt;</span><span class="w">rx16++</span><span class="pc"> </span><span class="c">=</span> <span class="w">bfin_read</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;rx16);</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_u16_duplex</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">rx</span> <span class="w">&lt;</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">rx_end</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tx16, *dr</span><span class="c">v_data-&gt;</span><span class="pc">t</span><span class="c">x16</span><span class="w">++</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">bfin_sport_spi_stat_poll_complete</span><span class="c">(</span><span class="w">d</span><span class="pc">rv_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">*dr</span><span class="c">v_data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rx16++</span><span class="pc"> </span><span class="c">=</span> <span class="w">bfin_read</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">rv_</span><span class="c">data-&gt;</span><span class="pc">re</span><span class="c">gs</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">rx</span><span class="c">16);</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">bfin_sport_transfer_ops</span> <span class="w">bfin_sport_transfer_ops_u16</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">w</span><span class="pc">r</span><span class="c">ite</span>  <span class="pc">=</span> <span class="w">bfin_sport_spi_u16_writer</span><span class="c">,</span>
	<span class="c">.</span><span class="w">r</span><span class="pc">ea</span><span class="c">d</span>   <span class="c">=</span> <span class="w">bfin_sport_spi_u16_reader</span><span class="c">,</span>
	<span class="c">.</span><span class="w">du</span><span class="c">plex</span> <span class="c">=</span> <span class="w">bfin_sport_spi_u16_duplex</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">bfin_sport_spi_restore_state</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">*</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_chip</span><span class="c">;</span>

	<span class="w">bfin_sport_spi_disable</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>
	<span class="w">d</span><span class="pc">e</span><span class="c">v_dbg(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">restoring</span> <span class="w">sp</span><span class="pc">i</span> <span class="w">ct</span><span class="pc">l</span> <span class="w">st</span><span class="pc">a</span><span class="c">te\n");</span>

	<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">tcr1</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">ctl_reg</span><span class="c">);</span>
	<span class="pc">b</span><span class="c">fin_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tclkdiv</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">ba</span><span class="pc">u</span><span class="c">d);</span>
	<span class="w">SSYNC()</span><span class="c">;</span>

	<span class="w">b</span><span class="c">fin_write(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rcr1</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;ctl_reg</span> <span class="w">&amp; ~(ITCLK</span> <span class="w">|</span> <span class="w">ITFS)</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">S</span><span class="c">SYNC</span><span class="w">()</span><span class="c">;</span>

	<span class="w">bfin_sport_spi_cs_active</span><span class="c">(chip</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="w">e</span><span class="c">num</span> <span class="w">bfin_sport_spi_state</span>
<span class="w">bfin_sport_spi_next_transfer</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">m</span><span class="pc">s</span><span class="c">g</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">cur_msg</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">spi_transfer</span> <span class="c">*</span><span class="w">tr</span><span class="c">ans</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_transfer</span><span class="c">;</span>

	
	<span class="pc">if</span> <span class="c">(</span><span class="w">t</span><span class="pc">r</span><span class="c">ans-&gt;</span><span class="w">transfer_list</span><span class="pc">.</span><span class="w">n</span><span class="pc">e</span><span class="c">xt</span> <span class="w">!= &amp;m</span><span class="c">sg-&gt;</span><span class="w">transfers)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">c</span><span class="pc">ur_t</span><span class="c">ransfer</span> <span class="pc">=</span>
		    <span class="w">l</span><span class="pc">i</span><span class="c">st_entry(</span><span class="w">t</span><span class="pc">r</span><span class="c">ans-&gt;</span><span class="pc">t</span><span class="c">ransfer_list.next,</span>
			       <span class="c">struct</span> <span class="pc">sp</span><span class="c">i_transfer,</span> <span class="w">t</span><span class="pc">r</span><span class="c">ansfer_list);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">RUNNING_STATE</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">DONE_STATE</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_giveback</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">*</span><span class="w">chi</span><span class="pc">p</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_chip</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="c">struct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">ms</span><span class="c">g;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>
	<span class="w">ms</span><span class="pc">g</span> <span class="c">=</span> <span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">cur_msg</span><span class="c">;</span>
	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">START_STATE</span><span class="c">;</span>
	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="pc">c</span><span class="c">ur_msg</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">cur_transfer</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">cur_chip</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">queue_work</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">workqueue</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">pump_messages</span><span class="c">);</span>
	<span class="w">s</span><span class="pc">pin_u</span><span class="c">nlock_irqrestore(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;lock,</span> <span class="c">flags);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">cs_change</span><span class="pc">)</span>
		<span class="w">bfin_sport_spi_cs_deactive</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ms</span><span class="c">g-&gt;</span><span class="w">com</span><span class="pc">p</span><span class="c">lete)</span>
		<span class="w">m</span><span class="pc">s</span><span class="c">g-&gt;</span><span class="w">co</span><span class="pc">mp</span><span class="c">lete(</span><span class="w">m</span><span class="c">sg-&gt;</span><span class="w">co</span><span class="pc">nt</span><span class="c">ext);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">i</span><span class="pc">r</span><span class="c">qreturn_t</span>
<span class="w">sport_err_handler</span><span class="c">(int</span> <span class="c">irq,</span> <span class="c">void</span> <span class="c">*dev_id)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span> <span class="c">=</span> <span class="c">dev_id;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="pc">s</span><span class="c">tatus</span><span class="pc">;</span>

	<span class="w">d</span><span class="c">ev_dbg(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span> <span class="w">enter</span><span class="pc">\</span><span class="c">n",</span> <span class="c">__func__);</span>
	<span class="w">s</span><span class="pc">t</span><span class="c">atus</span> <span class="c">=</span> <span class="w">bfin_read</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">reg</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">sta</span><span class="pc">t</span><span class="w">) &amp;</span><span class="pc"> (</span><span class="w">TOVF</span> <span class="pc">|</span> <span class="w">TUVF</span> <span class="pc">|</span> <span class="w">ROVF</span> <span class="c">|</span> <span class="w">RUVF</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="pc">egs-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tat,</span> <span class="w">s</span><span class="pc">tatu</span><span class="c">s);</span>
		<span class="w">SSYNC(</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">bfin_sport_spi_disable</span><span class="c">(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data);</span>
		<span class="w">d</span><span class="pc">ev_e</span><span class="c">rr</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">st</span><span class="pc">a</span><span class="c">tus</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="w">:</span><span class="pc">%s</span><span class="w">%</span><span class="pc">s%s%s</span><span class="c">\n",</span>
			<span class="w">s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">TOVF</span> <span class="c">? "</span> <span class="w">T</span><span class="c">OVF</span><span class="w">" : "",</span>
			<span class="w">st</span><span class="c">atus</span> <span class="pc">&amp;</span> <span class="w">TUVF</span> <span class="c">? "</span> <span class="w">T</span><span class="pc">U</span><span class="c">VF</span><span class="w">"</span><span class="pc"> : ""</span><span class="c">,</span>
			<span class="pc">s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">ROVF</span> <span class="c">? "</span> <span class="w">R</span><span class="c">OVF</span><span class="pc">" : ""</span><span class="c">,</span>
			<span class="pc">s</span><span class="c">tatus</span> <span class="pc">&amp;</span> <span class="w">RUVF</span> <span class="c">? "</span> <span class="w">R</span><span class="pc">U</span><span class="c">VF</span><span class="w">" : "");</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">I</span><span class="c">RQ_HANDLED;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">bfin_sport_spi_pump_transfers</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">data)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span> <span class="pc">= </span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*)data;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">mes</span><span class="c">sage</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">struct</span> <span class="w">spi_transfer</span> <span class="c">*</span><span class="w">transfer</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="c">struct</span> <span class="w">s</span><span class="pc">pi_t</span><span class="c">ransfer</span> <span class="c">*</span><span class="w">previous</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">*</span><span class="w">ch</span><span class="pc">ip</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">bits_per_word</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">tranf_success</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">u3</span><span class="c">2</span> <span class="w">transfer_speed</span><span class="pc">;</span>
	<span class="pc">u8</span> <span class="w">full_duplex</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="w">me</span><span class="pc">s</span><span class="c">sage</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_msg</span><span class="c">;</span>
	<span class="w">transfer</span> <span class="pc">=</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_transfer</span><span class="c">;</span>
	<span class="w">ch</span><span class="pc">i</span><span class="c">p</span> <span class="pc">=</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">cur_chip</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(transfer</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">speed_hz</span><span class="pc">)</span>
		<span class="w">t</span><span class="pc">ransfer_</span><span class="c">speed</span> <span class="pc">=</span> <span class="w">bfin_sport_hz_to_spi_baud</span><span class="pc">(transfer-</span><span class="c">&gt;speed_hz</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">t</span><span class="pc">ransfer_</span><span class="c">speed</span> <span class="c">=</span> <span class="w">ch</span><span class="c">ip-&gt;</span><span class="w">ba</span><span class="pc">u</span><span class="c">d;</span>
	<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tclkdiv</span><span class="pc">,</span> <span class="pc">transfer_</span><span class="c">speed);</span>
	<span class="w">SSYNC(</span><span class="pc">)</span><span class="c">;</span>

	

	 
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">==</span> <span class="w">ERROR_STATE</span><span class="c">) {</span>
		<span class="w">d</span><span class="pc">ev_d</span><span class="c">bg</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;dev, "</span><span class="w">t</span><span class="pc">ransfer</span><span class="c">:</span> <span class="w">we've</span> <span class="w">hit</span> <span class="w">an</span> <span class="w">e</span><span class="c">rror\n");</span>
		<span class="w">me</span><span class="pc">s</span><span class="c">sage-&gt;</span><span class="pc">statu</span><span class="c">s</span> <span class="pc">= </span><span class="c">-</span><span class="pc">E</span><span class="c">IO;</span>
		<span class="w">bfin_sport_spi_giveback</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;state</span> <span class="pc">=</span><span class="c">=</span> <span class="w">DONE_STATE</span><span class="c">) {</span>
		<span class="pc">dev_d</span><span class="c">bg</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">t</span><span class="c">ransfer:</span> <span class="w">al</span><span class="pc">l</span> <span class="w">d</span><span class="pc">o</span><span class="c">ne</span><span class="w">!</span><span class="c">\n");</span>
		<span class="w">mes</span><span class="c">sage-&gt;</span><span class="pc">statu</span><span class="c">s</span> <span class="c">=</span> <span class="c">0;</span>
		<span class="w">b</span><span class="pc">f</span><span class="c">in_sport_spi_giveback</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;state</span> <span class="c">==</span> <span class="w">RUNNING_STATE</span><span class="c">) {</span>
		<span class="pc">dev_d</span><span class="c">bg</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">t</span><span class="c">ransfer:</span> <span class="w">still</span> <span class="w">running</span> <span class="w">...\n</span><span class="c">");</span>
		<span class="w">previous</span> <span class="pc">=</span> <span class="w">li</span><span class="pc">s</span><span class="c">t_entry(</span><span class="w">t</span><span class="pc">r</span><span class="c">ansfer-&gt;</span><span class="w">transfer_list</span><span class="pc">.</span><span class="w">pr</span><span class="pc">ev,</span>
				      <span class="pc">s</span><span class="c">truct</span> <span class="w">spi_transfer</span><span class="c">,</span> <span class="w">t</span><span class="pc">ransfer_</span><span class="c">list);</span>
		<span class="c">if</span> <span class="c">(previous-&gt;</span><span class="w">delay_usecs</span><span class="pc">)</span>
			<span class="w">ud</span><span class="pc">e</span><span class="c">lay(</span><span class="w">p</span><span class="c">revious-&gt;delay_usecs);</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">t</span><span class="c">ransfer-&gt;</span><span class="w">l</span><span class="c">en</span> <span class="c">==</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ate</span> <span class="c">=</span> <span class="w">bfin_sport_spi_next_transfer</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">tasklet_schedule</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">pump_transfers</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">t</span><span class="c">ransfer-&gt;</span><span class="w">tx_buf</span> <span class="pc">!</span><span class="c">=</span> <span class="w">N</span><span class="c">ULL) {</span>
		<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">tx</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">v</span><span class="c">oid</span> <span class="c">*)</span><span class="pc">t</span><span class="c">ransfer-&gt;tx_buf;</span>
		<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">tx_end</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">tx</span> <span class="pc">+</span> <span class="pc">t</span><span class="c">ransfer-&gt;</span><span class="pc">l</span><span class="c">en;</span>
		<span class="w">d</span><span class="c">ev_dbg</span><span class="pc">(</span><span class="w">dr</span><span class="c">v_data-&gt;dev, "</span><span class="w">t</span><span class="pc">x</span><span class="c">_buf</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">%p</span><span class="w">,</span> <span class="pc">tx</span><span class="c">_end</span> <span class="w">i</span><span class="pc">s</span> <span class="c">%</span><span class="pc">p</span><span class="c">\n",</span>
			<span class="c">transfer-&gt;</span><span class="pc">t</span><span class="c">x_buf</span><span class="pc">,</span> <span class="w">drv</span><span class="pc">_</span><span class="c">data-&gt;</span><span class="pc">tx_e</span><span class="c">nd);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
		<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">tx</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(transfer-&gt;</span><span class="w">rx_buf</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL) {</span>
		<span class="w">full_duplex</span> <span class="pc">=</span> <span class="c">transfer-&gt;</span><span class="w">t</span><span class="pc">x_b</span><span class="c">uf</span> <span class="w">!</span><span class="c">=</span> <span class="c">NULL;</span>
		<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">rx</span> <span class="c">=</span> <span class="c">transfer</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">x_buf;</span>
		<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">rx_end</span> <span class="c">=</span> <span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="pc">x</span> <span class="w">+</span> <span class="c">transfer-&gt;</span><span class="pc">l</span><span class="c">en;</span>
		<span class="w">d</span><span class="c">ev_dbg</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">r</span><span class="pc">x_b</span><span class="c">uf</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">%p</span><span class="w">,</span> <span class="w">r</span><span class="pc">x_e</span><span class="c">nd</span> <span class="w">i</span><span class="pc">s</span> <span class="c">%</span><span class="pc">p</span><span class="c">\n",</span>
			<span class="c">transfer-&gt;</span><span class="pc">r</span><span class="c">x_buf</span><span class="pc">,</span> <span class="w">drv</span><span class="pc">_</span><span class="c">data-&gt;</span><span class="pc">rx_e</span><span class="c">nd);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
		<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">rx</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>

	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cs_change</span> <span class="c">=</span> <span class="pc">t</span><span class="c">ransfer</span><span class="pc">-</span><span class="c">&gt;cs_change;</span>

	
	<span class="w">bits_per_word</span> <span class="c">=</span> <span class="pc">t</span><span class="c">ransfer-&gt;</span><span class="pc">b</span><span class="c">its_per_word;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(bits_per_word</span> <span class="pc">=</span><span class="c">=</span> <span class="w">1</span><span class="pc">6</span><span class="c">)</span>
		<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">o</span><span class="c">ps</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">bfin_sport_transfer_ops_u16</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">o</span><span class="c">ps</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">bfin_sport_transfer_ops_u8</span><span class="c">;</span>
	<span class="w">bfin_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tcr2</span><span class="pc">,</span> <span class="pc">b</span><span class="c">its_per_word</span> <span class="w">-</span> <span class="c">1);</span>
	<span class="w">b</span><span class="pc">f</span><span class="c">in_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tfsdiv</span><span class="c">,</span> <span class="pc">b</span><span class="c">its_per_word</span> <span class="w">-</span> <span class="c">1);</span>
	<span class="pc">b</span><span class="c">fin_write</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">r</span><span class="c">egs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rcr2</span><span class="pc">,</span> <span class="c">bits_per_word</span> <span class="w">-</span> <span class="c">1);</span>

	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">RUNNING_STATE</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cs_change</span><span class="pc">)</span>
		<span class="w">bfin_sport_spi_cs_active</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">d</span><span class="c">ev_dbg</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;dev</span><span class="pc">,</span>
		<span class="c">"</span><span class="w">n</span><span class="pc">ow</span> <span class="w">pumping</span> <span class="w">a</span> <span class="w">transfer:</span> <span class="w">wi</span><span class="pc">d</span><span class="c">th</span> <span class="w">i</span><span class="pc">s</span> <span class="c">%d</span><span class="w">,</span> <span class="w">l</span><span class="pc">en</span> <span class="w">i</span><span class="pc">s</span> <span class="c">%</span><span class="pc">d</span><span class="c">\n",</span>
		<span class="w">bits_per_word</span><span class="c">,</span> <span class="w">tr</span><span class="pc">a</span><span class="c">nsfer</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">en)</span><span class="c">;</span>

	
	<span class="w">d</span><span class="c">ev_dbg(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">doing</span> <span class="w">IO</span> <span class="w">t</span><span class="pc">r</span><span class="c">ansfer\n");</span>

	<span class="w">bfin_sport_spi_enable</span><span class="c">(</span><span class="w">drv</span><span class="pc">_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">full_duplex</span><span class="pc">)</span><span class="c"> {</span>
		
		<span class="w">B</span><span class="c">UG_ON</span><span class="pc">((</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">tx_end</span> <span class="w">-</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">tx) </span><span class="pc">!</span><span class="c">=</span>
		       <span class="w">(dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">rx_end</span> <span class="w">-</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">rx)</span><span class="pc">);</span>
		<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">o</span><span class="c">ps</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">u</span><span class="c">plex</span><span class="pc">(</span><span class="w">dr</span><span class="c">v_data</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">tx</span> <span class="w">!</span><span class="c">=</span> <span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="pc">t</span><span class="c">x_end</span><span class="pc">)</span>
			<span class="w">tranf_success</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">tx</span> <span class="w">!</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL) {</span>
		

		<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">o</span><span class="c">ps-&gt;</span><span class="w">w</span><span class="pc">r</span><span class="c">ite(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">tx</span> <span class="w">!</span><span class="c">=</span> <span class="w">dr</span><span class="c">v_data-&gt;tx_end</span><span class="pc">)</span>
			<span class="pc">t</span><span class="c">ranf_success</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">rx</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL) {</span>
		

		<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="pc">o</span><span class="c">ps-&gt;</span><span class="w">r</span><span class="pc">ea</span><span class="c">d(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">rx</span> <span class="w">!</span><span class="c">=</span> <span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">rx_end</span><span class="pc">)</span>
			<span class="pc">t</span><span class="c">ranf_success</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">}</span>
	<span class="w">bfin_sport_spi_disable</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">tranf_success) {</span>
		<span class="pc">dev_d</span><span class="c">bg(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">IO</span> <span class="w">w</span><span class="c">rite</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="pc">!</span><span class="c">\n");</span>
		<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">ERROR_STATE</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		
		<span class="w">mes</span><span class="c">sage-&gt;</span><span class="w">actual_length</span> <span class="w">+</span><span class="pc">=</span> <span class="w">transfer</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="c">en;</span>
		
		<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">=</span> <span class="w">bfin_sport_spi_next_transfer</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">cs_change</span><span class="pc">)</span>
			<span class="w">bfin_sport_spi_cs_deactive</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip);</span>
	<span class="c">}</span>

	
	<span class="w">tasklet_schedule</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">pump_transfers</span><span class="c">);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">void</span>
<span class="w">bfin_sport_spi_pump_messages</span><span class="c">(struct</span> <span class="c">work_struct</span> <span class="c">*work)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">next_msg</span><span class="c">;</span>

	<span class="w">dr</span><span class="pc">v_</span><span class="c">data</span> <span class="c">=</span> <span class="c">container_of(work,</span> <span class="c">struct</span> <span class="pc">b</span><span class="c">fin_sport_spi_master_data,</span> <span class="w">pump_messages</span><span class="c">);</span>

	
	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">l</span><span class="pc">is</span><span class="c">t_empty(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">q</span><span class="c">ueue</span><span class="w">) || !drv</span><span class="pc">_</span><span class="c">data-&gt;</span><span class="w">run</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">b</span><span class="pc">u</span><span class="c">sy</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">d</span><span class="pc">rv_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_msg</span><span class="c">) {</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

	
	<span class="w">next_msg</span> <span class="pc">=</span> <span class="w">l</span><span class="pc">i</span><span class="c">st_entry(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">q</span><span class="c">ueue</span><span class="pc">.n</span><span class="c">ext,</span>
		<span class="c">struct</span> <span class="w">spi_message</span><span class="c">,</span> <span class="w">q</span><span class="c">ueue);</span>

	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">c</span><span class="c">ur_msg</span> <span class="pc">=</span> <span class="c">next_msg;</span>

	
	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_chip</span> <span class="c">=</span> <span class="w">spi_get_ctldata</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;cur_msg</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sp</span><span class="pc">i)</span><span class="c">;</span>

	<span class="w">l</span><span class="pc">ist_d</span><span class="c">el_init(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="pc">c</span><span class="c">ur_msg</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">q</span><span class="c">ueue);</span>

	
	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="pc">cur_m</span><span class="c">sg</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">START_STATE</span><span class="c">;</span>
	<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">cur_transfer</span> <span class="c">=</span> <span class="w">li</span><span class="pc">s</span><span class="c">t_entry(</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="pc">cur_m</span><span class="c">sg</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">transfers.n</span><span class="pc">e</span><span class="c">xt</span><span class="pc">,</span>
					    <span class="pc">s</span><span class="c">truct</span> <span class="w">spi_transfer</span><span class="pc">,</span> <span class="w">transfer_list</span><span class="c">);</span>
	<span class="w">bfin_sport_spi_restore_state</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>
	<span class="w">d</span><span class="c">ev_dbg</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">got</span> <span class="w">a</span> <span class="w">me</span><span class="pc">s</span><span class="c">sage</span> <span class="w">t</span><span class="c">o</span> <span class="w">pump,</span><span class="pc"> "</span>
		<span class="w">"sta</span><span class="c">te</span> <span class="w">i</span><span class="c">s</span> <span class="w">s</span><span class="pc">e</span><span class="c">t</span> <span class="w">t</span><span class="pc">o</span><span class="w">:</span> <span class="w">ba</span><span class="pc">u</span><span class="c">d</span> <span class="pc">%</span><span class="c">d</span><span class="pc">,</span> <span class="w">cs_gpio</span> <span class="w">%i</span><span class="c">,</span> <span class="w">ct</span><span class="pc">l</span> <span class="w">0</span><span class="c">x%x</span><span class="pc">\</span><span class="c">n",</span>
		<span class="w">drv</span><span class="pc">_</span><span class="c">data-&gt;</span><span class="w">cur_chip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ba</span><span class="pc">u</span><span class="c">d,</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;cur_chip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cs</span><span class="c">_gpio,</span>
		<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;cur_chip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ctl_reg</span><span class="c">);</span>

	<span class="w">d</span><span class="c">ev_dbg</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev</span><span class="pc">,</span>
		<span class="c">"</span><span class="w">th</span><span class="pc">e</span> <span class="w">fir</span><span class="pc">s</span><span class="c">t</span> <span class="w">transfer</span> <span class="w">l</span><span class="pc">en</span> <span class="w">i</span><span class="pc">s</span> <span class="c">%d\n",</span>
		<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_transfer</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="c">en);</span>

	
	<span class="w">tasklet_schedule</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">pump_transfers</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">b</span><span class="pc">us</span><span class="c">y</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span>
<span class="w">bfin_sport_spi_transfer</span><span class="c">(struct</span> <span class="w">spi_device</span> <span class="c">*</span><span class="w">s</span><span class="pc">p</span><span class="c">i,</span> <span class="c">struct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">m</span><span class="c">sg)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">s</span><span class="pc">p</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	<span class="pc">s</span><span class="c">pin_lock_irqsave(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">run</span><span class="c">) {</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;lock,</span> <span class="c">flags);</span>
		<span class="c">return</span> <span class="pc">-</span><span class="w">ESHUTDOWN</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">m</span><span class="pc">s</span><span class="c">g-&gt;</span><span class="w">actual_length</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">m</span><span class="c">sg-&gt;</span><span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="w">=</span><span class="pc"> -</span><span class="w">EINPROGRESS</span><span class="c">;</span>
	<span class="pc">m</span><span class="c">sg-&gt;</span><span class="w">s</span><span class="pc">tate</span> <span class="c">=</span> <span class="w">START_STATE</span><span class="c">;</span>

	<span class="w">d</span><span class="pc">ev_</span><span class="c">dbg(&amp;</span><span class="w">s</span><span class="pc">p</span><span class="c">i-&gt;dev, "</span><span class="w">adding</span> <span class="w">an</span> <span class="w">m</span><span class="c">sg</span> <span class="w">i</span><span class="c">n</span> <span class="w">transfer()\n</span><span class="c">");</span>
	<span class="w">l</span><span class="pc">i</span><span class="c">st_add_tail(&amp;msg-&gt;</span><span class="w">q</span><span class="c">ueue, &amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">q</span><span class="c">ueue</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">run</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">bu</span><span class="pc">s</span><span class="c">y</span><span class="pc">)</span>
		<span class="w">queue_work</span><span class="c">(</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">workqueue</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">pump_messages</span><span class="c">);</span>

	<span class="w">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">l</span><span class="c">ock,</span> <span class="c">flags);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span>
<span class="w">bfin_sport_spi_setup</span><span class="c">(struct</span> <span class="w">spi_device</span> <span class="c">*</span><span class="w">s</span><span class="pc">p</span><span class="c">i)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">*</span><span class="w">c</span><span class="c">hip</span><span class="w">,</span><span class="c"> *</span><span class="w">fi</span><span class="pc">r</span><span class="c">st</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	
	<span class="w">c</span><span class="c">hip</span> <span class="pc">=</span> <span class="w">spi_get_ctldata</span><span class="c">(</span><span class="w">s</span><span class="c">pi);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">hip</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">bfin5xx_spi_chip</span> <span class="c">*</span><span class="w">chip_info</span><span class="pc">;</span>

		<span class="w">c</span><span class="pc">hip</span> <span class="c">=</span> <span class="w">fir</span><span class="pc">s</span><span class="c">t</span> <span class="w">=</span> <span class="w">k</span><span class="c">zalloc(sizeof</span><span class="pc">(*</span><span class="c">chip),</span> <span class="c">GFP_KERNEL);</span>
		<span class="c">if</span> <span class="c">(!</span><span class="pc">chip</span><span class="c">)</span>
			<span class="c">return</span> <span class="c">-ENOMEM;</span>

		
		<span class="w">c</span><span class="pc">hip_</span><span class="c">info</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">pi</span><span class="c">-&gt;</span><span class="w">controller_data</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">chip_</span><span class="c">info</span><span class="pc">)</span><span class="c"> {</span>
			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(chip_info-&gt;</span><span class="w">ctl_reg</span> <span class="w">|</span><span class="c">|</span> <span class="c">chip_info-&gt;</span><span class="w">enable_dma</span><span class="c">) {</span>
				<span class="pc">r</span><span class="c">et</span> <span class="c">= -</span><span class="pc">EI</span><span class="c">NVAL;</span>
				<span class="w">d</span><span class="c">ev_err(&amp;</span><span class="w">s</span><span class="c">pi-&gt;dev, "</span><span class="w">don'</span><span class="pc">t</span> <span class="w">s</span><span class="c">et</span> <span class="w">ct</span><span class="c">l_reg</span><span class="w">/e</span><span class="pc">nable_</span><span class="c">dma</span> <span class="w">fields</span><span class="c">\n</span><span class="pc">")</span><span class="c">;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="pc">erro</span><span class="c">r;</span>
			<span class="c">}</span>
			<span class="w">ch</span><span class="pc">ip</span><span class="c">-&gt;</span><span class="w">cs_chg_udelay</span> <span class="c">=</span> <span class="pc">ch</span><span class="c">ip_info</span><span class="pc">-</span><span class="c">&gt;cs_chg_udelay;</span>
			<span class="w">c</span><span class="pc">hip</span><span class="c">-&gt;</span><span class="w">idle_tx_val</span> <span class="c">=</span> <span class="c">chip_info-&gt;</span><span class="pc">i</span><span class="c">dle_tx_val;</span>
		<span class="w">}</span>
	<span class="w">}</span>

	

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">sp</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">ode</span> <span class="pc">&amp;</span> <span class="w">SPI_CPHA</span><span class="pc">)</span>
		<span class="w">c</span><span class="pc">hip</span><span class="c">-&gt;</span><span class="w">c</span><span class="pc">t</span><span class="c">l_reg</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">TCKFE</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">c</span><span class="pc">hip</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">tl_reg</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">T</span><span class="c">CKFE;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">sp</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">ode</span> <span class="c">&amp;</span> <span class="w">SPI_LSB_FIRST</span><span class="c">)</span>
		<span class="pc">chip</span><span class="c">-&gt;ctl_reg</span> <span class="pc">|</span><span class="c">=</span> <span class="w">TLSBIT</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;ctl_reg</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="pc">T</span><span class="c">LSBIT;</span>

	
	<span class="pc">c</span><span class="c">hip-&gt;</span><span class="pc">ct</span><span class="c">l_reg</span> <span class="pc">|</span><span class="c">=</span> <span class="w">ITCLK</span> <span class="pc">|</span> <span class="w">ITFS</span> <span class="pc">|</span> <span class="w">TFSR</span> <span class="c">|</span> <span class="w">LATFS</span> <span class="c">|</span> <span class="w">LTFS</span><span class="pc">;</span>

	<span class="pc">ch</span><span class="c">ip-&gt;</span><span class="w">ba</span><span class="pc">u</span><span class="c">d</span> <span class="c">=</span> <span class="w">bfin_sport_hz_to_spi_baud</span><span class="pc">(</span><span class="w">s</span><span class="pc">p</span><span class="c">i</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">max_speed_hz</span><span class="c">);</span>

	<span class="pc">c</span><span class="c">hip-&gt;</span><span class="w">cs_gpio</span> <span class="c">=</span> <span class="w">s</span><span class="pc">p</span><span class="c">i-&gt;</span><span class="w">chip_select</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">gpio_request</span><span class="c">(chip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">cs</span><span class="c">_gpio,</span> <span class="w">s</span><span class="pc">p</span><span class="c">i-&gt;</span><span class="w">modalias</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">e</span><span class="c">rror;</span>

	<span class="pc">d</span><span class="c">ev_dbg(&amp;</span><span class="w">s</span><span class="c">pi-&gt;dev, "</span><span class="w">se</span><span class="pc">tu</span><span class="c">p</span> <span class="w">sp</span><span class="c">i</span> <span class="w">c</span><span class="c">hip</span> <span class="pc">%s</span><span class="w">,</span> <span class="w">wi</span><span class="pc">d</span><span class="c">th</span> <span class="w">is</span> <span class="c">%d\n",</span>
			<span class="w">s</span><span class="c">pi-&gt;</span><span class="pc">m</span><span class="c">odalias,</span> <span class="w">s</span><span class="pc">p</span><span class="c">i-&gt;</span><span class="w">bits_per_word</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">d</span><span class="c">ev_dbg(&amp;</span><span class="pc">s</span><span class="c">pi-&gt;dev, "</span><span class="w">ctl_reg</span> <span class="w">is</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="pc">x</span><span class="w">,</span> <span class="w">GPIO</span> <span class="w">i</span><span class="pc">s</span> <span class="c">%</span><span class="w">i</span><span class="pc">\</span><span class="c">n",</span>
			<span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">c</span><span class="pc">t</span><span class="c">l_reg,</span> <span class="w">sp</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">chip_select</span><span class="c">);</span>

	<span class="w">spi_set_ctldata</span><span class="c">(</span><span class="w">s</span><span class="pc">p</span><span class="c">i,</span> <span class="pc">c</span><span class="c">hip</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">bfin_sport_spi_cs_deactive</span><span class="c">(chip</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>

 <span class="w">e</span><span class="pc">rro</span><span class="c">r:</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">fir</span><span class="pc">s</span><span class="c">t);</span>
	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">bfin_sport_spi_cleanup</span><span class="c">(struct</span> <span class="w">spi_device</span> <span class="c">*</span><span class="pc">s</span><span class="c">pi)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_slave_data</span> <span class="c">*chip</span> <span class="c">=</span> <span class="w">spi_get_ctldata</span><span class="c">(spi);</span>

	<span class="pc">if</span> <span class="pc">(!c</span><span class="c">hip</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">gpio_free</span><span class="c">(chip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cs_gpio</span><span class="c">);</span>

	<span class="pc">k</span><span class="c">free(chip);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">bfin_sport_spi_init_queue</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">q</span><span class="c">ueue);</span>
	<span class="w">s</span><span class="c">pin_lock_init(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock);</span>

	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">run</span> <span class="c">=</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">b</span><span class="pc">u</span><span class="c">sy</span> <span class="c">=</span> <span class="c">0;</span>

	
	<span class="w">tasklet_init</span><span class="pc">(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">pump_transfers</span><span class="pc">,</span>
		     <span class="w">bfin_sport_spi_pump_transfers,</span><span class="pc"> (</span><span class="c">unsigned</span> <span class="c">long)</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>

	
	<span class="w">INIT_WORK</span><span class="pc">(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;</span><span class="w">pump_messages</span><span class="c">,</span> <span class="w">bfin_sport_spi_pump_messages</span><span class="c">);</span>
	<span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">workqueue</span> <span class="c">=</span>
	    <span class="w">create_singlethread_workqueue</span><span class="pc">(</span><span class="w">dev</span><span class="pc">_n</span><span class="c">ame</span><span class="pc">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">a</span><span class="c">ster</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="w">.</span><span class="pc">p</span><span class="c">arent</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;workqueue</span> <span class="pc">=</span><span class="c">=</span> <span class="c">NULL</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">E</span><span class="pc">B</span><span class="c">USY;</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">bfin_sport_spi_start_queue</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="pc">sp</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">run</span> <span class="w">|</span><span class="c">|</span> <span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">b</span><span class="pc">u</span><span class="c">sy</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">d</span><span class="pc">r</span><span class="c">v_data-&gt;lock,</span> <span class="c">flags);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-EB</span><span class="c">USY;</span>
	<span class="c">}</span>

	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;run</span> <span class="c">=</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue;</span>
	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">cur_msg</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">cur_transfer</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">cur_chip</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">sp</span><span class="pc">in_unlock_</span><span class="c">irqrestore(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>

	<span class="w">queue_work</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">workqueue</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">pump_messages</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="c">int</span>
<span class="w">bfin_sport_spi_stop_queue</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="w">l</span><span class="pc">i</span><span class="c">mit</span> <span class="pc">=</span> <span class="w">5</span><span class="c">00;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">s</span><span class="c">tatus</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;lock,</span> <span class="c">flags);</span>

	
	<span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">run</span> <span class="c">=</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="pc">(!l</span><span class="c">ist_empty(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;</span><span class="w">q</span><span class="c">ueue</span><span class="w">) </span><span class="pc">&amp;&amp;</span> <span class="w">dr</span><span class="pc">v</span><span class="c">_data-&gt;</span><span class="w">b</span><span class="pc">usy</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">li</span><span class="pc">m</span><span class="c">it</span><span class="w">-</span><span class="pc">-</span><span class="c">) {</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;lock,</span> <span class="c">flags);</span>
		<span class="w">m</span><span class="pc">s</span><span class="c">leep(</span><span class="pc">10</span><span class="c">);</span>
		<span class="w">s</span><span class="pc">pin_l</span><span class="c">ock_irqsave(&amp;</span><span class="w">dr</span><span class="c">v_data-&gt;lock,</span> <span class="c">flags);</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!l</span><span class="c">ist_empty(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">q</span><span class="c">ueue</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">b</span><span class="c">usy</span><span class="pc">)</span>
		<span class="w">st</span><span class="c">atus</span> <span class="pc">= </span><span class="c">-EBUSY;</span>

	<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;lock,</span> <span class="c">flags);</span>

	<span class="c">return</span> <span class="w">s</span><span class="c">tatus;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="c">int</span>
<span class="w">bfin_sport_spi_destroy_queue</span><span class="c">(struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">s</span><span class="c">tatus;</span>

	<span class="w">s</span><span class="pc">ta</span><span class="c">tus</span> <span class="c">=</span> <span class="w">bfin_sport_spi_stop_queue</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(status)</span>
		<span class="c">return</span> <span class="pc">s</span><span class="c">tatus;</span>

	<span class="w">destroy_workqueue</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">workqueue</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bfin_sport_spi_probe</span><span class="c">(struct</span> <span class="c">platform_device</span> <span class="c">*pdev)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">device</span> <span class="c">*dev</span> <span class="pc">= </span><span class="c">&amp;pdev-&gt;dev;</span>
	<span class="c">struct</span> <span class="w">bfin5xx_spi_master</span> <span class="c">*</span><span class="w">platform_info</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">m</span><span class="pc">a</span><span class="c">ster;</span>
	<span class="c">struct</span> <span class="pc">r</span><span class="c">esource</span> <span class="c">*res</span><span class="pc">,</span><span class="c"> *</span><span class="w">ires</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">s</span><span class="c">tatus;</span>

	<span class="w">pl</span><span class="c">atform_info</span> <span class="c">=</span> <span class="w">dev_get_platdata</span><span class="c">(dev);</span>

	
	<span class="w">ma</span><span class="pc">s</span><span class="c">ter</span> <span class="c">=</span> <span class="w">spi_alloc_master</span><span class="c">(dev,</span> <span class="c">sizeof</span><span class="pc">(*</span><span class="w">mas</span><span class="pc">t</span><span class="c">er</span><span class="pc">) </span><span class="c">+</span> <span class="w">1</span><span class="pc">6</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="pc">a</span><span class="c">ster</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">c</span><span class="pc">ann</span><span class="c">ot</span> <span class="w">a</span><span class="pc">lloc</span> <span class="w">spi_master\</span><span class="c">n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>
	<span class="c">}</span>

	<span class="w">dr</span><span class="pc">v_</span><span class="c">data</span> <span class="pc">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="c">aster</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">m</span><span class="pc">as</span><span class="c">ter</span> <span class="c">=</span> <span class="w">m</span><span class="pc">a</span><span class="c">ster;</span>
	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="pc">d</span><span class="c">ev;</span>
	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">pin_req</span> <span class="c">=</span> <span class="w">platform_info-</span><span class="c">&gt;</span><span class="pc">p</span><span class="c">in_req;</span>

	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">mode_bits</span> <span class="c">=</span> <span class="w">SPI_CPOL</span> <span class="pc">|</span> <span class="w">SPI_CPHA</span> <span class="pc">|</span> <span class="w">SPI_LSB_FIRST</span><span class="c">;</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">bits_per_word_mask</span> <span class="c">=</span> <span class="w">SPI_BPW_MASK</span><span class="pc">(</span><span class="w">8</span><span class="pc">) </span><span class="c">|</span> <span class="w">S</span><span class="pc">PI_B</span><span class="c">PW_MASK</span><span class="pc">(</span><span class="w">1</span><span class="pc">6</span><span class="c">);</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">bus_num</span> <span class="c">=</span> <span class="w">pd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">i</span><span class="c">d;</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">num_chipselect</span> <span class="c">=</span> <span class="c">platform_info-&gt;num_chipselect;</span>
	<span class="w">m</span><span class="pc">a</span><span class="c">ster-&gt;</span><span class="w">cle</span><span class="c">anup</span> <span class="c">=</span> <span class="w">bfin_sport_spi_cleanup</span><span class="c">;</span>
	<span class="w">ma</span><span class="pc">s</span><span class="c">ter-&gt;</span><span class="w">s</span><span class="pc">e</span><span class="c">tup</span> <span class="c">=</span> <span class="w">bfin_sport_spi_setup</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">a</span><span class="c">ster-&gt;</span><span class="w">transfer</span> <span class="c">=</span> <span class="w">bfin_sport_spi_transfer</span><span class="c">;</span>

	
	<span class="w">r</span><span class="pc">es</span> <span class="pc">=</span> <span class="c">platform_get_resource(pdev,</span> <span class="c">IORESOURCE_MEM,</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="pc">(</span><span class="c">res</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL) {</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">c</span><span class="pc">ann</span><span class="c">ot</span> <span class="pc">g</span><span class="c">et</span> <span class="w">IO</span><span class="c">RESOURCE_MEM</span><span class="w">\</span><span class="c">n");</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">atus</span> <span class="pc">= </span><span class="c">-</span><span class="w">EN</span><span class="pc">OE</span><span class="c">NT;</span>
		<span class="c">goto</span> <span class="w">out_error_get_res</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span> <span class="c">=</span> <span class="w">i</span><span class="pc">o</span><span class="c">remap(res-&gt;start,</span> <span class="w">resource_size</span><span class="pc">(</span><span class="c">res));</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">r</span><span class="pc">eg</span><span class="c">s</span> <span class="w">=</span><span class="c">=</span> <span class="c">NULL) {</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">c</span><span class="pc">ann</span><span class="c">ot</span> <span class="w">m</span><span class="c">ap</span> <span class="w">registers</span><span class="pc">\</span><span class="c">n");</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">atus</span> <span class="pc">= </span><span class="c">-</span><span class="pc">ENX</span><span class="c">IO;</span>
		<span class="c">goto</span> <span class="w">out_error_ioremap</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">ires</span> <span class="c">=</span> <span class="pc">p</span><span class="c">latform_get_resource(pdev,</span> <span class="w">I</span><span class="pc">ORESOURCE_I</span><span class="c">RQ,</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">ires</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">c</span><span class="pc">ann</span><span class="c">ot</span> <span class="pc">g</span><span class="c">et</span> <span class="w">IO</span><span class="c">RESOURCE_IRQ</span><span class="w">\</span><span class="c">n");</span>
		<span class="w">s</span><span class="pc">ta</span><span class="c">tus</span> <span class="pc">= </span><span class="c">-ENODEV;</span>
		<span class="c">goto</span> <span class="w">out_error_get_ires</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">err_irq</span> <span class="c">=</span> <span class="c">ires</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="c">tart;</span>

	
	<span class="w">st</span><span class="pc">at</span><span class="c">us</span> <span class="c">=</span> <span class="w">bfin_sport_spi_init_queue</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus) {</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">problem</span> <span class="w">initializing</span> <span class="w">q</span><span class="c">ueue\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_error_queue_alloc</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">status</span> <span class="c">=</span> <span class="w">bfin_sport_spi_start_queue</span><span class="c">(</span><span class="w">drv</span><span class="pc">_</span><span class="c">data);</span>
	<span class="c">if</span> <span class="c">(status) {</span>
		<span class="pc">d</span><span class="c">ev_err(dev, "</span><span class="w">pr</span><span class="pc">obl</span><span class="c">em</span> <span class="w">starting</span> <span class="w">q</span><span class="c">ueue\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">error_queue_alloc;</span>
	<span class="c">}</span>

	<span class="pc">s</span><span class="c">tatus</span> <span class="c">=</span> <span class="w">r</span><span class="c">equest_irq(</span><span class="w">drv</span><span class="pc">_</span><span class="c">data-&gt;</span><span class="w">err_irq</span><span class="c">,</span> <span class="w">sport_err_handler</span><span class="c">,</span>
		<span class="c">0</span><span class="pc">, "</span><span class="w">sport_spi_err</span><span class="pc">",</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus) {</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">u</span><span class="c">nable</span> <span class="c">to</span> <span class="pc">req</span><span class="c">uest</span> <span class="w">spo</span><span class="pc">rt</span> <span class="w">er</span><span class="pc">r</span> <span class="w">i</span><span class="pc">r</span><span class="c">q\n");</span>
		<span class="c">goto</span> <span class="w">out_error_irq</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="c">tatus</span> <span class="c">=</span> <span class="w">peripheral_request_list</span><span class="c">(</span><span class="w">drv</span><span class="pc">_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pin_req</span><span class="c">,</span> <span class="w">D</span><span class="c">RV_NAME</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="c">tatus</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">requesting</span> <span class="w">peripherals</span> <span class="c">failed\n");</span>
		<span class="c">goto</span> <span class="w">out_error_peripheral</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">p</span><span class="pc">l</span><span class="c">atform_set_drvdata(pdev,</span> <span class="w">drv</span><span class="pc">_</span><span class="c">data);</span>
	<span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="c">=</span> <span class="w">spi_register_master</span><span class="c">(</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="c">tatus) {</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="c">dev, "</span><span class="w">problem</span> <span class="w">registering</span> <span class="w">sp</span><span class="pc">i</span> <span class="w">mas</span><span class="pc">t</span><span class="c">er\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_error_master</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">d</span><span class="pc">ev_i</span><span class="c">nfo</span><span class="pc">(</span><span class="c">dev</span><span class="pc">, "%</span><span class="c">s</span><span class="pc">,</span> <span class="w">regs_base@%p</span><span class="c">\n",</span> <span class="w">DRV_DESC</span><span class="pc">,</span> <span class="w">drv</span><span class="pc">_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">egs</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>

 <span class="pc">o</span><span class="c">ut_error_master:</span>
	<span class="w">peripheral_free_list</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pin_req</span><span class="c">);</span>
 <span class="w">out_error_peripheral</span><span class="pc">:</span>
	<span class="pc">f</span><span class="c">ree_irq(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;</span><span class="w">err_irq</span><span class="c">,</span> <span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span><span class="c">;</span>
 <span class="w">out_error_irq</span><span class="c">:</span>
 <span class="w">out_error_queue_alloc</span><span class="pc">:</span>
	<span class="w">bfin_sport_spi_destroy_queue</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>
 <span class="w">out_error_get_ires</span><span class="c">:</span>
	<span class="pc">i</span><span class="c">ounmap(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">egs</span><span class="c">);</span>
 <span class="w">out_error_ioremap</span><span class="c">:</span>
 <span class="w">out_error_get_res</span><span class="pc">:</span>
	<span class="w">spi_master_put</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>

	<span class="c">return</span> <span class="w">s</span><span class="c">tatus;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">bfin_sport_spi_remove</span><span class="c">(struct</span> <span class="pc">p</span><span class="c">latform_device</span> <span class="c">*pdev)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span> <span class="c">=</span> <span class="c">platform_get_drvdata(pdev);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">s</span><span class="c">tatus</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	
	<span class="w">s</span><span class="pc">ta</span><span class="c">tus</span> <span class="c">=</span> <span class="w">bfin_sport_spi_destroy_queue</span><span class="c">(</span><span class="w">drv</span><span class="pc">_</span><span class="c">data);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="c">tatus</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">s</span><span class="c">tatus;</span>

	
	<span class="w">bfin_sport_spi_disable</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>

	
	<span class="w">spi_unregister_master</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">peripheral_free_list</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pin_req</span><span class="c">);</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="pc">#ifd</span><span class="c">ef</span> <span class="w">CONFIG_PM_SLEEP</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">bfin_sport_spi_suspend</span><span class="c">(struct</span> <span class="c">device</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">s</span><span class="c">tatus;</span>

	<span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="c">=</span> <span class="w">bfin_sport_spi_stop_queue</span><span class="c">(</span><span class="w">drv</span><span class="pc">_</span><span class="c">data);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">s</span><span class="c">tatus;</span>

	
	<span class="w">bfin_sport_spi_disable</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>

	<span class="c">return</span> <span class="pc">s</span><span class="c">tatus;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bfin_sport_spi_resume</span><span class="c">(struct</span> <span class="pc">d</span><span class="c">evice</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bfin_sport_spi_master_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="c">int</span> <span class="pc">s</span><span class="c">tatus;</span>

	
	<span class="w">bfin_sport_spi_enable</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>

	
	<span class="w">s</span><span class="pc">ta</span><span class="c">tus</span> <span class="c">=</span> <span class="w">bfin_sport_spi_start_queue</span><span class="c">(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span><span class="pc">)</span>
		<span class="pc">d</span><span class="c">ev_err(</span><span class="w">dr</span><span class="pc">v_</span><span class="c">data-&gt;dev, "</span><span class="w">problem</span> <span class="w">resuming</span> <span class="w">q</span><span class="c">ueue\n");</span>

	<span class="c">return</span> <span class="w">s</span><span class="c">tatus;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">SIMPLE_DEV_PM_OPS</span><span class="c">(</span><span class="w">bfin_sport_spi_pm_ops</span><span class="c">,</span> <span class="w">bfin_sport_spi_suspend</span><span class="c">,</span>
			<span class="w">bfin_sport_spi_resume</span><span class="c">);</span>

<span class="w">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">BFIN_SPORT_SPI_PM_OPS</span>		<span class="w">(</span><span class="pc">&amp;</span><span class="c">bfin_sport_spi_pm_ops</span><span class="w">)</span>
<span class="pc">#el</span><span class="c">se</span>
<span class="c">#define</span> <span class="pc">B</span><span class="c">FIN_SPORT_SPI_PM_OPS</span>		<span class="w">N</span><span class="c">ULL</span>
<span class="c">#endif</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="c">platform_driver</span> <span class="w">bfin_sport_spi_driver</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">d</span><span class="c">river</span>	<span class="c">= {</span>
		<span class="c">.name</span>	<span class="pc">=</span> <span class="pc">D</span><span class="c">RV_NAME,</span>
		<span class="c">.</span><span class="w">p</span><span class="pc">m</span>	<span class="pc">=</span> <span class="c">BFIN_SPORT_SPI_PM_OPS,</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="c">.probe</span>   <span class="c">=</span> <span class="w">bfin_sport_spi_probe</span><span class="c">,</span>
	<span class="c">.remove</span>  <span class="c">=</span> <span class="w">bfin_sport_spi_remove</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>
<span class="w">module_platform_driver</span><span class="c">(bfin_sport_spi_driver);</span>

</pre>
</body>
</html>

