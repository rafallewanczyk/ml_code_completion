<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/platform_device.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/gpio.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">of_gpio</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">c</span><span class="pc">o</span><span class="c">re.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">jack</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">pc</span><span class="pc">m</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">pcm_params</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">so</span><span class="pc">c</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="pc">".</span><span class="c">./</span><span class="w">codecs</span><span class="pc">/</span><span class="w">wm8903</span><span class="c">.h</span><span class="pc">"</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">tegra_asoc_utils</span><span class="c">.h"</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="c">DRV_NAME</span> <span class="c">"</span><span class="w">tegra</span><span class="pc">-</span><span class="w">snd</span><span class="pc">-</span><span class="w">w</span><span class="c">m8903"</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">tegra_wm8903</span> <span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">gpio_spkr_en</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">gpio_hp_det</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">gpio_hp_mute</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">gpio_int_mic_en</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">gpio_ext_mic_en</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">tegra_asoc_utils_data</span> <span class="w">util_data</span><span class="c">;</span>
<span class="c">};</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">tegra_wm8903_hw_params</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*substream,</span>
					<span class="c">struct</span> <span class="w">snd_pcm_hw_params</span> <span class="c">*</span><span class="w">p</span><span class="pc">a</span><span class="c">rams</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_soc_pcm_runtime</span> <span class="c">*</span><span class="w">rtd</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">u</span><span class="c">bstream-&gt;</span><span class="pc">p</span><span class="c">rivate_data;</span>
	<span class="c">struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">codec_dai</span> <span class="c">=</span> <span class="c">rtd-&gt;codec_dai;</span>
	<span class="c">struct</span> <span class="w">snd_soc_card</span> <span class="c">*</span><span class="w">ca</span><span class="pc">r</span><span class="c">d</span> <span class="c">=</span> <span class="pc">r</span><span class="c">td-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd;</span>
	<span class="c">struct</span> <span class="w">tegra_wm8903</span> <span class="c">*</span><span class="w">mac</span><span class="pc">hi</span><span class="c">ne</span> <span class="c">=</span> <span class="w">snd_soc_card_get_drvdata</span><span class="c">(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd);</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">srate</span><span class="pc">,</span> <span class="w">mclk</span><span class="c">;</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="w">s</span><span class="pc">r</span><span class="c">ate</span> <span class="c">=</span> <span class="w">params_rate</span><span class="c">(</span><span class="w">pa</span><span class="pc">rams)</span><span class="c">;</span>
	<span class="w">s</span><span class="c">witch</span> <span class="c">(</span><span class="pc">s</span><span class="c">rate) {</span>
	<span class="c">case</span> <span class="w">64000</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">88200</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">96000</span><span class="c">:</span>
		<span class="w">m</span><span class="c">clk</span> <span class="c">=</span> <span class="w">12</span><span class="pc">8</span> <span class="w">*</span> <span class="c">srate;</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">m</span><span class="c">clk</span> <span class="c">=</span> <span class="w">25</span><span class="pc">6</span> <span class="pc">*</span> <span class="c">srate;</span>
		<span class="c">break;</span>
	<span class="c">}</span>
	
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="pc">m</span><span class="c">clk</span> <span class="w">&lt;</span> <span class="w">6000000</span><span class="pc">)</span>
		<span class="c">mclk</span> <span class="w">*</span><span class="pc">=</span> <span class="pc">2</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">tegra_asoc_utils_set_rate</span><span class="pc">(&amp;</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">util_data</span><span class="c">,</span> <span class="pc">s</span><span class="c">rate,</span> <span class="c">mclk</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd-&gt;dev, "</span><span class="w">C</span><span class="pc">an</span><span class="c">'t</span> <span class="w">configure</span> <span class="w">clocks</span><span class="c">\n");</span>
		<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="c">}</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_soc_dai_set_sysclk</span><span class="c">(</span><span class="w">codec_dai</span><span class="c">,</span> <span class="c">0</span><span class="pc">,</span> <span class="pc">m</span><span class="c">clk,</span>
					<span class="w">SND_SOC_CLOCK_IN</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
		<span class="c">dev_err</span><span class="pc">(ca</span><span class="c">rd-&gt;dev, "</span><span class="w">co</span><span class="pc">d</span><span class="c">ec_dai</span> <span class="w">cl</span><span class="pc">ock</span> <span class="w">n</span><span class="c">ot</span> <span class="w">s</span><span class="pc">e</span><span class="c">t\n");</span>
		<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_ops</span> <span class="w">tegra_wm8903_ops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">hw_params</span> <span class="c">=</span> <span class="w">tegra_wm8903_hw_params</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_jack</span> <span class="w">tegra_wm8903_hp_jack</span><span class="pc">;</span>

<span class="c">static</span> <span class="c">struct</span> <span class="w">snd_soc_jack_pin</span> <span class="w">tegra_wm8903_hp_jack_pins</span><span class="c">[] = {</span>
	<span class="c">{</span>
		<span class="c">.</span><span class="w">pi</span><span class="pc">n</span> <span class="pc">= </span><span class="c">"</span><span class="w">Headphone</span> <span class="w">Jack</span><span class="pc">"</span><span class="c">,</span>
		<span class="c">.</span><span class="w">ma</span><span class="pc">s</span><span class="c">k</span> <span class="c">=</span> <span class="w">SND_JACK_HEADPHONE</span><span class="c">,</span>
	<span class="pc">},</span>
<span class="pc">};</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_jack_gpio</span> <span class="w">tegra_wm8903_hp_jack_gpio</span> <span class="c">= {</span>
	<span class="c">.name</span> <span class="c">= "</span><span class="w">headphone</span> <span class="w">detect</span><span class="c">",</span>
	<span class="c">.</span><span class="w">rep</span><span class="c">ort</span> <span class="pc">=</span> <span class="w">S</span><span class="c">ND_JACK_HEADPHONE,</span>
	<span class="c">.</span><span class="w">debounce_time</span> <span class="c">=</span> <span class="w">150</span><span class="c">,</span>
	<span class="c">.</span><span class="w">invert</span> <span class="c">=</span> <span class="pc">1</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_jack</span> <span class="w">tegra_wm8903_mic_jack</span><span class="pc">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_jack_pin</span> <span class="w">tegra_wm8903_mic_jack_pins</span><span class="c">[] = {</span>
	<span class="c">{</span>
		<span class="c">.</span><span class="w">pi</span><span class="pc">n</span> <span class="pc">= </span><span class="c">"</span><span class="w">Mic</span> <span class="w">Jack</span><span class="pc">"</span><span class="c">,</span>
		<span class="c">.</span><span class="w">m</span><span class="pc">as</span><span class="c">k</span> <span class="c">=</span> <span class="w">SND_JACK_MICROPHONE</span><span class="c">,</span>
	<span class="pc">},</span>
<span class="pc">};</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">tegra_wm8903_event_int_spk</span><span class="c">(struct</span> <span class="w">snd_soc_dapm_widget</span> <span class="c">*</span><span class="w">w</span><span class="c">,</span>
					<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_k</span><span class="c">control</span> <span class="c">*</span><span class="w">k</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="c">vent)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_soc_dapm_context</span> <span class="c">*</span><span class="w">dapm</span> <span class="pc">=</span> <span class="w">w</span><span class="c">-&gt;dapm;</span>
	<span class="c">struct</span> <span class="w">snd_soc_card</span> <span class="c">*</span><span class="w">ca</span><span class="pc">r</span><span class="c">d</span> <span class="c">=</span> <span class="c">dapm-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">tegra_wm8903</span> <span class="c">*</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span> <span class="c">=</span> <span class="w">snd_soc_card_get_drvdata</span><span class="c">(</span><span class="w">c</span><span class="c">ard);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="w">gpio_spkr_en</span><span class="c">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">gpio_set_value_cansleep</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_spkr_en</span><span class="pc">,</span>
				<span class="w">SND_SOC_DAPM_EVENT_ON</span><span class="pc">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">))</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">tegra_wm8903_event_hp</span><span class="c">(struct</span> <span class="w">snd_soc_dapm_widget</span> <span class="c">*</span><span class="w">w</span><span class="c">,</span>
					<span class="c">struct</span> <span class="w">sn</span><span class="pc">d_k</span><span class="c">control</span> <span class="c">*</span><span class="w">k</span><span class="c">,</span> <span class="c">int</span> <span class="w">e</span><span class="pc">v</span><span class="c">ent)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_soc_dapm_context</span> <span class="c">*</span><span class="w">dapm</span> <span class="c">=</span> <span class="w">w</span><span class="c">-&gt;dapm;</span>
	<span class="c">struct</span> <span class="w">snd_soc_card</span> <span class="c">*</span><span class="w">ca</span><span class="pc">r</span><span class="c">d</span> <span class="c">=</span> <span class="c">dapm-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd;</span>
	<span class="c">struct</span> <span class="w">tegra_wm8903</span> <span class="c">*</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span> <span class="c">=</span> <span class="w">snd_soc_card_get_drvdata</span><span class="c">(</span><span class="w">c</span><span class="c">ard);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="w">gpio_hp_mute</span><span class="c">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">gpio_set_value_cansleep</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_hp_mute</span><span class="pc">,</span>
				<span class="w">!SND_SOC_DAPM_EVENT_ON</span><span class="c">(</span><span class="w">e</span><span class="pc">v</span><span class="c">ent</span><span class="pc">))</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">snd_soc_dapm_widget</span> <span class="w">tegra_wm8903_dapm_widgets</span><span class="c">[] = {</span>
	<span class="w">SND_SOC_DAPM_SPK</span><span class="pc">("</span><span class="w">Int</span> <span class="w">Spk</span><span class="c">",</span> <span class="w">tegra_wm8903_event_int_spk)</span><span class="pc">,</span>
	<span class="w">SND_SOC_DAPM_HP(</span><span class="pc">"</span><span class="w">Headphone</span> <span class="w">Jack</span><span class="c">",</span> <span class="w">tegra_wm8903_event_hp)</span><span class="pc">,</span>
	<span class="w">SND_SOC_DAPM_MIC(</span><span class="pc">"</span><span class="w">Mic</span> <span class="w">J</span><span class="c">ack",</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">,</span>
<span class="c">};</span>

<span class="c">static</span> <span class="c">const</span> <span class="c">struct</span> <span class="w">snd_k</span><span class="pc">control_</span><span class="c">new</span> <span class="w">tegra_wm8903_controls</span><span class="c">[] = {</span>
	<span class="w">SOC_DAPM_PIN_SWITCH</span><span class="pc">("</span><span class="w">I</span><span class="c">nt</span> <span class="w">S</span><span class="c">pk</span><span class="w">")</span><span class="pc">,</span>
<span class="c">};</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">tegra_wm8903_init</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_pcm_runtime</span> <span class="c">*</span><span class="w">rtd</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">codec_dai</span> <span class="pc">=</span> <span class="c">rtd</span><span class="pc">-</span><span class="c">&gt;codec_dai;</span>
	<span class="c">struct</span> <span class="w">snd_s</span><span class="pc">oc_c</span><span class="c">odec</span> <span class="c">*</span><span class="w">cod</span><span class="pc">ec</span> <span class="c">=</span> <span class="c">codec_dai-&gt;</span><span class="w">cod</span><span class="pc">ec</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">snd_soc_card</span> <span class="c">*</span><span class="w">c</span><span class="pc">a</span><span class="c">rd</span> <span class="c">=</span> <span class="pc">r</span><span class="c">td-&gt;</span><span class="pc">c</span><span class="c">ard;</span>
	<span class="c">struct</span> <span class="w">tegra_wm8903</span> <span class="c">*</span><span class="w">mac</span><span class="pc">hi</span><span class="c">ne</span> <span class="c">=</span> <span class="w">snd_soc_card_get_drvdata</span><span class="c">(</span><span class="w">c</span><span class="c">ard);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="w">gpio_hp_det</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">tegra_wm8903_hp_jack_gpio.g</span><span class="pc">pio</span> <span class="c">=</span> <span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pio_hp_det;</span>
		<span class="w">snd_soc_card_jack_new</span><span class="c">(</span><span class="w">r</span><span class="c">td</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd</span><span class="pc">, </span><span class="c">"</span><span class="w">Headphone</span> <span class="w">Jack</span><span class="pc">"</span><span class="c">,</span>
				      <span class="w">SND_JACK_HEADPHONE,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">tegra_wm8903_hp_jack</span><span class="pc">,</span>
				      <span class="w">tegra_wm8903_hp_jack_pins</span><span class="pc">,</span>
				      <span class="w">A</span><span class="c">RRAY_SIZE(tegra_wm8903_hp_jack_pins));</span>
		<span class="w">snd_soc_jack_add_gpios</span><span class="pc">(&amp;</span><span class="w">t</span><span class="pc">egra_wm8903_hp_jack,</span>
					<span class="pc">1,</span>
					<span class="w">&amp;</span><span class="pc">tegra_wm8903_hp_jack_g</span><span class="c">pio);</span>
	<span class="pc">}</span>

	<span class="w">s</span><span class="pc">nd_soc_c</span><span class="c">ard_jack_new</span><span class="pc">(r</span><span class="c">td</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd</span><span class="pc">, </span><span class="c">"</span><span class="w">Mic</span> <span class="w">J</span><span class="c">ack</span><span class="w">"</span><span class="c">,</span> <span class="w">SND_JACK_MICROPHONE</span><span class="pc">,</span>
			      <span class="w">&amp;tegra_wm8903_mic_jack</span><span class="c">,</span>
			      <span class="w">tegra_wm8903_mic_jack_pins</span><span class="c">,</span>
			      <span class="w">A</span><span class="c">RRAY_SIZE(tegra_wm8903_mic_jack_pins</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">wm8903_mic_detect</span><span class="c">(</span><span class="w">cod</span><span class="pc">ec, &amp;tegra_wm8903_m</span><span class="c">ic_jack,</span> <span class="w">S</span><span class="c">ND_JACK_MICROPHONE,</span>
				<span class="c">0);</span>

	<span class="w">snd_soc_dapm_force_enable_pin</span><span class="pc">(&amp;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd-&gt;</span><span class="w">dapm,</span><span class="pc"> "</span><span class="w">MICBIAS</span><span class="c">");</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">tegra_wm8903_remove</span><span class="c">(struct</span> <span class="w">snd_soc_card</span> <span class="c">*</span><span class="pc">c</span><span class="c">ard)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_soc_pcm_runtime</span> <span class="c">*</span><span class="w">rtd</span> <span class="w">=</span><span class="pc"> &amp;(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd-&gt;rtd</span><span class="pc">[</span><span class="c">0]);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">codec_dai</span> <span class="pc">=</span> <span class="c">rtd</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">co</span><span class="c">dec_dai;</span>
	<span class="c">struct</span> <span class="w">snd_s</span><span class="pc">oc_co</span><span class="c">dec</span> <span class="c">*</span><span class="w">cod</span><span class="pc">ec</span> <span class="c">=</span> <span class="pc">c</span><span class="c">odec_dai-&gt;</span><span class="w">cod</span><span class="pc">ec</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">tegra_wm8903</span> <span class="c">*</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span> <span class="c">=</span> <span class="w">snd_soc_card_get_drvdata</span><span class="c">(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd);</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="w">gpio_hp_det</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">snd_soc_jack_free_gpios</span><span class="pc">(&amp;</span><span class="w">tegra_wm8903_hp_jack</span><span class="pc">,</span> <span class="pc">1,</span>
					<span class="w">&amp;tegra_wm8903_hp_jack_gpio</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="w">wm8903_mic_detect</span><span class="c">(</span><span class="w">cod</span><span class="pc">ec</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">,</span> <span class="c">0);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_dai_link</span> <span class="w">tegra_wm8903_dai</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">n</span><span class="c">ame</span> <span class="c">= "</span><span class="w">WM8903</span><span class="c">",</span>
	<span class="c">.</span><span class="w">stream_name</span> <span class="pc">= </span><span class="c">"</span><span class="w">W</span><span class="c">M8903</span> <span class="w">PCM</span><span class="c">",</span>
	<span class="c">.</span><span class="w">codec_dai_name</span> <span class="pc">= </span><span class="c">"</span><span class="w">wm8903</span><span class="pc">-</span><span class="w">hifi</span><span class="c">",</span>
	<span class="c">.</span><span class="w">i</span><span class="pc">ni</span><span class="c">t</span> <span class="c">=</span> <span class="w">tegra_wm8903_init</span><span class="c">,</span>
	<span class="c">.</span><span class="w">o</span><span class="pc">ps</span> <span class="c">= &amp;</span><span class="w">tegra_wm8903_ops</span><span class="c">,</span>
	<span class="pc">.</span><span class="w">dai_fmt</span> <span class="c">=</span> <span class="w">SND_SOC_DAIFMT_I2S</span> <span class="pc">|</span>
		   <span class="w">SND_SOC_DAIFMT_NB_NF</span> <span class="c">|</span>
		   <span class="w">SND_SOC_DAIFMT_CBS_CFS</span><span class="pc">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_card</span> <span class="w">snd_soc_tegra_wm8903</span> <span class="c">= {</span>
	<span class="c">.name</span> <span class="c">= "</span><span class="w">tegra</span><span class="pc">-</span><span class="w">w</span><span class="c">m8903",</span>
	<span class="c">.</span><span class="pc">o</span><span class="c">wner</span> <span class="c">=</span> <span class="c">THIS_MODULE,</span>
	<span class="c">.</span><span class="w">dai_link</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">tegra_wm8903_dai</span><span class="c">,</span>
	<span class="c">.</span><span class="w">num_links</span> <span class="c">=</span> <span class="c">1,</span>
	<span class="c">.</span><span class="w">r</span><span class="pc">em</span><span class="c">ove</span> <span class="c">=</span> <span class="w">tegra_wm8903_remove</span><span class="c">,</span>
	<span class="c">.</span><span class="w">controls</span> <span class="c">=</span> <span class="w">tegra_wm8903_controls</span><span class="c">,</span>
	<span class="c">.</span><span class="w">num_controls</span> <span class="c">=</span> <span class="w">A</span><span class="c">RRAY_SIZE(tegra_wm8903_controls),</span>
	<span class="pc">.</span><span class="w">dapm_widgets</span> <span class="c">=</span> <span class="w">tegra_wm8903_dapm_widgets</span><span class="c">,</span>
	<span class="c">.</span><span class="w">num_dapm_widgets</span> <span class="c">=</span> <span class="pc">A</span><span class="c">RRAY_SIZE(tegra_wm8903_dapm_widgets),</span>
	<span class="c">.</span><span class="w">fully_routed</span> <span class="c">=</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">tegra_wm8903_driver_probe</span><span class="c">(struct</span> <span class="c">platform_device</span> <span class="c">*pdev)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">device_node</span> <span class="c">*np</span> <span class="c">=</span> <span class="c">pdev-&gt;dev.of_node;</span>
	<span class="c">struct</span> <span class="w">snd_soc_card</span> <span class="c">*</span><span class="w">ca</span><span class="c">rd</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">snd_soc_tegra_wm8903</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">tegra_wm8903</span> <span class="c">*</span><span class="w">mac</span><span class="pc">hi</span><span class="c">ne</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	<span class="w">mac</span><span class="pc">h</span><span class="c">ine</span> <span class="c">=</span> <span class="c">devm_kzalloc(&amp;pdev-&gt;dev,</span> <span class="c">sizeof</span><span class="pc">(</span><span class="c">struct</span> <span class="c">tegra_wm8903),</span>
			       <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev, "</span><span class="w">C</span><span class="pc">an</span><span class="c">'t</span> <span class="pc">a</span><span class="c">llocate</span> <span class="w">t</span><span class="c">egra_wm8903</span> <span class="w">st</span><span class="pc">r</span><span class="c">uct</span><span class="w">\</span><span class="c">n");</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="c">}</span>

	<span class="w">ca</span><span class="c">rd-&gt;</span><span class="pc">d</span><span class="c">ev</span> <span class="pc">= </span><span class="c">&amp;pdev-&gt;dev;</span>
	<span class="w">p</span><span class="pc">l</span><span class="c">atform_set_drvdata(pdev,</span> <span class="w">c</span><span class="c">ard);</span>
	<span class="w">snd_soc_card_set_drvdata</span><span class="c">(</span><span class="w">c</span><span class="c">ard</span><span class="pc">,</span> <span class="w">mac</span><span class="pc">hi</span><span class="c">ne);</span>

	<span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="w">gpio_spkr_en</span> <span class="c">=</span> <span class="w">of_get_named_gpio</span><span class="pc">(</span><span class="w">n</span><span class="c">p</span><span class="pc">, </span><span class="c">"</span><span class="w">nvidia,spkr</span><span class="c">-</span><span class="w">en</span><span class="pc">-</span><span class="w">gpios</span><span class="c">",</span>
						  <span class="pc">0</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_spkr_en</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EPROBE_DEFER</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EP</span><span class="pc">R</span><span class="c">OBE_DEFER;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pio_spkr_en</span><span class="w">)</span><span class="c">) {</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">devm_gpio_request_one</span><span class="pc">(&amp;p</span><span class="c">dev-&gt;dev,</span> <span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pio_spkr_en,</span>
					    <span class="w">GPIOF_OUT_INIT_LOW,</span><span class="pc"> "</span><span class="w">spkr_en</span><span class="c">");</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">dev_err</span><span class="pc">(</span><span class="w">ca</span><span class="pc">r</span><span class="c">d-&gt;dev, "</span><span class="w">c</span><span class="pc">a</span><span class="c">nnot</span> <span class="pc">g</span><span class="c">et</span> <span class="w">s</span><span class="c">pkr_en</span> <span class="w">g</span><span class="pc">pio</span><span class="c">\n");</span>
			<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">gpio_hp_mute</span> <span class="c">=</span> <span class="w">of_get_named_gpio</span><span class="pc">(</span><span class="w">n</span><span class="c">p</span><span class="pc">, </span><span class="c">"</span><span class="w">nvidia</span><span class="pc">,</span><span class="w">hp</span><span class="pc">-</span><span class="w">mute</span><span class="pc">-</span><span class="w">gpios</span><span class="pc">"</span><span class="c">,</span>
						  <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_hp_mute</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EPROBE_DEFER</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EP</span><span class="pc">R</span><span class="c">OBE_DEFER;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pio_hp_mute</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">devm_gpio_request_one</span><span class="pc">(&amp;</span><span class="w">p</span><span class="c">dev-&gt;dev,</span> <span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="w">g</span><span class="c">pio_hp_mute,</span>
					    <span class="w">GPIOF_OUT_INIT_HIGH,</span><span class="pc"> "</span><span class="w">hp_mute</span><span class="c">");</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">dev_err</span><span class="pc">(</span><span class="w">ca</span><span class="pc">r</span><span class="c">d-&gt;dev, "</span><span class="w">c</span><span class="pc">a</span><span class="c">nnot</span> <span class="pc">g</span><span class="c">et</span> <span class="w">h</span><span class="c">p_mute</span> <span class="w">g</span><span class="pc">pio</span><span class="c">\n");</span>
			<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">gpio_hp_det</span> <span class="c">=</span> <span class="w">of_get_named_gpio</span><span class="pc">(</span><span class="w">n</span><span class="c">p</span><span class="pc">, </span><span class="c">"</span><span class="w">nvidia</span><span class="pc">,</span><span class="w">hp</span><span class="pc">-</span><span class="w">det</span><span class="pc">-</span><span class="w">gpios</span><span class="pc">"</span><span class="c">,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_hp_det</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EPROBE_DEFER</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EP</span><span class="pc">R</span><span class="c">OBE_DEFER;</span>

	<span class="w">mac</span><span class="pc">hi</span><span class="c">ne</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">gpio_int_mic_en</span> <span class="c">=</span> <span class="c">of_get_named_gpio</span><span class="pc">(n</span><span class="c">p</span><span class="pc">,</span>
						<span class="w">"</span><span class="pc">n</span><span class="c">vidia</span><span class="w">,i</span><span class="c">nt</span><span class="w">-mic</span><span class="pc">-</span><span class="w">en</span><span class="pc">-</span><span class="w">g</span><span class="pc">pios"</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_int_mic_en</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="pc">E</span><span class="c">PROBE_DEFER</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EP</span><span class="pc">R</span><span class="c">OBE_DEFER;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_int_mic_en</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">devm_gpio_request_one</span><span class="pc">(&amp;</span><span class="w">p</span><span class="c">dev-&gt;dev,</span>
					    <span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pio_int_mic_en,</span>
					    <span class="w">GPIOF_OUT_INIT_LOW,</span><span class="pc"> "</span><span class="w">int_mic_en</span><span class="c">");</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">dev_err</span><span class="pc">(</span><span class="w">ca</span><span class="pc">r</span><span class="c">d-&gt;dev, "</span><span class="w">c</span><span class="pc">a</span><span class="c">nnot</span> <span class="pc">g</span><span class="c">et</span> <span class="w">i</span><span class="pc">nt_</span><span class="c">mic_en</span> <span class="w">g</span><span class="pc">pio</span><span class="c">\n");</span>
			<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">gpio_ext_mic_en</span> <span class="c">=</span> <span class="w">of_get_named_gpio</span><span class="pc">(</span><span class="w">n</span><span class="c">p</span><span class="pc">,</span>
						<span class="w">"nvidia</span><span class="pc">,</span><span class="w">ex</span><span class="pc">t</span><span class="c">-</span><span class="w">mic</span><span class="pc">-</span><span class="w">en</span><span class="c">-</span><span class="w">gpios</span><span class="c">",</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">mac</span><span class="pc">hi</span><span class="c">ne</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pio_ext_mic_en</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EPROBE_DEFER</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EP</span><span class="pc">R</span><span class="c">OBE_DEFER;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">gpio_is_valid</span><span class="c">(</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;gpio_ext_mic_en</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">devm_gpio_request_one</span><span class="pc">(&amp;</span><span class="w">p</span><span class="c">dev-&gt;dev,</span>
					    <span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">g</span><span class="c">pio_ext_mic_en,</span>
					    <span class="w">GPIOF_OUT_INIT_LOW,</span><span class="pc"> "</span><span class="w">ext_mic_en</span><span class="c">");</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">dev_err</span><span class="pc">(</span><span class="w">ca</span><span class="pc">r</span><span class="c">d-&gt;dev, "</span><span class="w">c</span><span class="pc">a</span><span class="c">nnot</span> <span class="pc">g</span><span class="c">et</span> <span class="w">e</span><span class="pc">x</span><span class="c">t_mic_en</span> <span class="w">g</span><span class="pc">pio</span><span class="c">\n");</span>
			<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">snd_soc_of_parse_card_name</span><span class="c">(</span><span class="w">ca</span><span class="c">rd</span><span class="pc">, "</span><span class="w">nvidia,mo</span><span class="pc">del</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="c">goto</span> <span class="pc">err</span><span class="c">;</span>

	<span class="c">ret</span> <span class="c">=</span> <span class="w">snd_soc_of_parse_audio_routing</span><span class="c">(</span><span class="w">ca</span><span class="c">rd</span><span class="pc">, "</span><span class="w">n</span><span class="c">vidia</span><span class="pc">,</span><span class="w">au</span><span class="c">dio</span><span class="pc">-</span><span class="w">routing</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="c">goto</span> <span class="c">err;</span>

	<span class="w">tegra_wm8903_dai.codec_of_node</span> <span class="c">=</span> <span class="w">of_parse_phandle</span><span class="pc">(</span><span class="w">n</span><span class="pc">p</span><span class="c">,</span>
						<span class="w">"n</span><span class="c">vidia</span><span class="pc">,</span><span class="w">au</span><span class="c">dio</span><span class="pc">-</span><span class="w">cod</span><span class="pc">ec"</span><span class="c">,</span> <span class="w">0</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!t</span><span class="c">egra_wm8903_dai</span><span class="w">.</span><span class="c">codec_of_node) {</span>
		<span class="c">dev_err(&amp;</span><span class="pc">p</span><span class="c">dev-&gt;dev</span><span class="pc">,</span>
			<span class="c">"</span><span class="w">Property</span> <span class="pc">'n</span><span class="c">vidia</span><span class="w">,au</span><span class="c">dio</span><span class="w">-cod</span><span class="pc">ec</span><span class="w">'</span> <span class="w">missing</span> <span class="w">or</span> <span class="w">inv</span><span class="c">alid</span><span class="pc">\</span><span class="c">n");</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">= -EINVAL;</span>
		<span class="c">goto</span> <span class="w">e</span><span class="pc">rr</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">t</span><span class="c">egra_wm8903_dai</span><span class="w">.cpu_of_node</span> <span class="c">=</span> <span class="w">of_parse_phandle</span><span class="c">(</span><span class="w">n</span><span class="pc">p</span><span class="c">,</span>
			<span class="w">"</span><span class="pc">n</span><span class="c">vidia</span><span class="pc">,</span><span class="w">i2s</span><span class="c">-</span><span class="w">con</span><span class="pc">troll</span><span class="c">er</span><span class="pc">"</span><span class="c">,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!t</span><span class="c">egra_wm8903_dai</span><span class="w">.</span><span class="c">cpu_of_node) {</span>
		<span class="c">dev_err(&amp;</span><span class="pc">p</span><span class="c">dev-&gt;dev</span><span class="pc">,</span>
			<span class="c">"</span><span class="w">Property</span> <span class="w">'</span><span class="pc">n</span><span class="c">vidia</span><span class="w">,i</span><span class="pc">2</span><span class="c">s-</span><span class="w">co</span><span class="pc">nt</span><span class="c">roller</span><span class="w">'</span> <span class="w">missing</span> <span class="w">o</span><span class="pc">r</span> <span class="w">inv</span><span class="c">alid</span><span class="pc">\</span><span class="c">n");</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">= -</span><span class="pc">EI</span><span class="c">NVAL;</span>
		<span class="c">goto</span> <span class="w">e</span><span class="pc">rr</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">t</span><span class="c">egra_wm8903_dai</span><span class="w">.platform_of_node</span> <span class="c">=</span> <span class="pc">t</span><span class="c">egra_wm8903_dai</span><span class="pc">.c</span><span class="c">pu_of_node</span><span class="pc">;</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">tegra_asoc_utils_init</span><span class="pc">(&amp;</span><span class="w">mac</span><span class="pc">hi</span><span class="c">ne</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">util_data</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p</span><span class="pc">de</span><span class="c">v-&gt;dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">snd_soc_register_card</span><span class="c">(</span><span class="w">ca</span><span class="c">rd);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev, "</span><span class="w">s</span><span class="c">nd_soc_register_card</span> <span class="c">failed</span> <span class="w">(</span><span class="c">%d)\n",</span>
			<span class="c">ret);</span>
		<span class="c">goto</span> <span class="w">err_fini_utils</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">retu</span><span class="c">rn</span> <span class="c">0;</span>

<span class="c">err_fini_utils:</span>
	<span class="w">tegra_asoc_utils_fini</span><span class="pc">(&amp;</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">util_data</span><span class="c">);</span>
<span class="w">e</span><span class="pc">rr:</span>
	<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">tegra_wm8903_driver_remove</span><span class="c">(struct</span> <span class="c">platform_device</span> <span class="c">*pdev)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_soc_card</span> <span class="c">*</span><span class="w">c</span><span class="pc">a</span><span class="c">rd</span> <span class="c">=</span> <span class="c">platform_get_drvdata(pdev);</span>
	<span class="c">struct</span> <span class="w">tegra_wm8903</span> <span class="c">*</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span> <span class="c">=</span> <span class="w">snd_soc_card_get_drvdata</span><span class="c">(</span><span class="w">ca</span><span class="c">rd);</span>

	<span class="w">snd_soc_unregister_card</span><span class="c">(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd);</span>

	<span class="w">tegra_asoc_utils_fini</span><span class="pc">(&amp;</span><span class="w">mac</span><span class="pc">h</span><span class="c">ine</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">util_data</span><span class="c">);</span>

	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="c">of_device_id</span> <span class="w">tegra_wm8903_of_match</span><span class="c">[] = {</span>
	<span class="c">{ .compatible</span> <span class="c">= "</span><span class="w">nvidia</span><span class="c">,</span><span class="w">tegra</span><span class="c">-</span><span class="w">au</span><span class="c">dio</span><span class="pc">-</span><span class="w">wm8903", },</span>
	<span class="w">{},</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">struct</span> <span class="c">platform_driver</span> <span class="w">tegra_wm8903_driver</span> <span class="c">= {</span>
	<span class="c">.driver</span> <span class="c">= {</span>
		<span class="c">.name</span> <span class="pc">=</span> <span class="c">DRV_NAME,</span>
		<span class="c">.</span><span class="w">p</span><span class="pc">m</span> <span class="c">= &amp;</span><span class="w">snd_soc_pm_ops</span><span class="c">,</span>
		<span class="pc">.</span><span class="w">of_match_table</span> <span class="c">=</span> <span class="pc">tegra_</span><span class="c">wm8903_of_match,</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="pc">.</span><span class="c">probe</span> <span class="c">=</span> <span class="w">tegra_wm8903_driver_probe</span><span class="c">,</span>
	<span class="c">.remove</span> <span class="c">=</span> <span class="w">tegra_wm8903_driver_remove</span><span class="c">,</span>
<span class="c">};</span>
<span class="w">module_platform_driver</span><span class="c">(tegra_wm8903_driver);</span>

<span class="c">MODULE_AUTHOR("</span><span class="w">Stephen</span> <span class="w">Warren</span> <span class="c">&lt;</span><span class="w">swarren</span><span class="c">@</span><span class="w">nvidia</span><span class="c">.com&gt;");</span>
<span class="c">MODULE_DESCRIPTION("</span><span class="w">Tegra+WM8903</span> <span class="w">ma</span><span class="pc">c</span><span class="c">hine</span> <span class="w">ASoC</span> <span class="pc">d</span><span class="c">river");</span>
<span class="c">MODULE_LICENSE("GPL");</span>
<span class="c">MODULE_ALIAS("platform</span><span class="w">:"</span> <span class="w">D</span><span class="c">RV_NAME</span><span class="w">)</span><span class="c">;</span>
<span class="w">M</span><span class="pc">ODULE_DEV</span><span class="c">ICE_TABLE(</span><span class="pc">o</span><span class="c">f,</span> <span class="w">tegra_wm8903_of_match</span><span class="c">);</span>

</pre>
</body>
</html>

