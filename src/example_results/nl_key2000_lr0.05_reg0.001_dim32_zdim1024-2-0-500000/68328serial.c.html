<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/errno.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/serial.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/signal.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">s</span><span class="pc">c</span><span class="c">hed.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">t</span><span class="pc">i</span><span class="c">mer.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">nt</span><span class="c">errupt.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">t</span><span class="pc">t</span><span class="c">y.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">tty_flip</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ma</span><span class="pc">j</span><span class="c">or.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">t</span><span class="c">ring.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">fcntl</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">m</span><span class="pc">m</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">k</span><span class="c">ernel.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">console</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">reboot</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">keyboard</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">in</span><span class="c">it.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">p</span><span class="pc">m</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">bitops</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">g</span><span class="pc">f</span><span class="c">p.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/io.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="pc">ir</span><span class="c">q.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">d</span><span class="pc">e</span><span class="c">lay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="pc">u</span><span class="c">access.h&gt;</span>



<span class="c">#</span><span class="w">i</span><span class="pc">f</span> <span class="pc">d</span><span class="c">efined(</span><span class="w">CONFIG_M68EZ328</span><span class="c">)</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">&lt;asm/</span><span class="w">MC68EZ328</span><span class="c">.h&gt;</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
<span class="pc">#</span><span class="w">i</span><span class="pc">f</span> <span class="c">defined(</span><span class="w">CONFIG_M68VZ328</span><span class="c">)</span>
<span class="c">#</span><span class="pc">in</span><span class="c">clude</span> <span class="pc">&lt;</span><span class="c">asm/</span><span class="w">MC68VZ328</span><span class="c">.h&gt;</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">MC68328</span><span class="c">.h&gt;</span>
<span class="c">#endif</span> 
<span class="c">#</span><span class="w">e</span><span class="c">ndif</span> 


<span class="c">#</span><span class="w">i</span><span class="pc">fd</span><span class="c">ef</span> <span class="w">CONFIG_XCOPILOT_BUGS</span>
<span class="c">#</span><span class="pc">u</span><span class="c">ndef</span> <span class="w">USE_INTS</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
<span class="c">#define</span> <span class="w">U</span><span class="c">SE_INTS</span>
<span class="c">#endif</span>


<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">USTCNT_TX_INTR_MASK</span> <span class="w">(USTCNT_TXEE</span><span class="pc">)</span>




<span class="c">#</span><span class="w">i</span><span class="pc">f</span> <span class="pc">d</span><span class="c">efined(</span><span class="w">CONFIG_M68EZ328</span><span class="pc">) </span><span class="c">||</span> <span class="c">defined(</span><span class="w">CONFIG_M68VZ328</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">USTCNT_RX_INTR_MASK</span> <span class="pc">(</span><span class="w">USTCNT_RXHE</span> <span class="c">|</span> <span class="w">USTCNT_ODEN</span><span class="c">)</span>
<span class="c">#</span><span class="w">e</span><span class="pc">li</span><span class="c">f</span> <span class="c">defined(</span><span class="w">CONFIG_M68328</span><span class="c">)</span>
<span class="c">#define</span> <span class="pc">USTCNT_RX_</span><span class="c">INTR_MASK</span> <span class="c">(</span><span class="w">USTCNT_RXRE</span><span class="c">)</span>
<span class="c">#else</span>
<span class="c">#</span><span class="pc">er</span><span class="c">ror</span> <span class="w">Please,</span> <span class="w">de</span><span class="pc">fine</span> <span class="w">th</span><span class="c">e</span> <span class="w">Rx</span> <span class="w">int</span><span class="pc">e</span><span class="c">rrupt</span> <span class="w">ev</span><span class="pc">ents</span> <span class="w">f</span><span class="c">or</span> <span class="w">your</span> <span class="w">C</span><span class="pc">P</span><span class="c">U</span>
<span class="pc">#</span><span class="c">endif</span>



<span class="pc">str</span><span class="c">uct</span> <span class="w">m68k_serial</span> <span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">tty_port</span>		<span class="w">tport</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span>			<span class="w">is_cons</span><span class="pc">;</span>	
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">m</span><span class="pc">a</span><span class="c">gic;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">baud_base</span><span class="c">;</span>
	<span class="c">int</span>			<span class="w">p</span><span class="pc">o</span><span class="c">rt;</span>
	<span class="c">int</span>			<span class="c">irq;</span>
	<span class="c">int</span>			<span class="w">t</span><span class="pc">y</span><span class="c">pe;</span>		
	<span class="c">int</span>			<span class="w">custom_divisor</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">x_char</span><span class="c">;</span>		
	<span class="c">int</span>			<span class="w">l</span><span class="pc">ine</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span>		<span class="c">*</span><span class="w">xmit_buf</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">xmit_head</span><span class="c">;</span>
	<span class="c">int</span>			<span class="w">xmit_tail</span><span class="c">;</span>
	<span class="c">int</span>			<span class="w">xmit_cnt</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">#define</span> <span class="w">SERIAL_MAGIC</span> <span class="w">0x5301</span>


<span class="c">#define</span> <span class="w">NR_PORTS</span> <span class="w">1</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">m68k_serial</span> <span class="w">m68k_soft</span><span class="pc">[</span><span class="w">N</span><span class="c">R_PORTS];</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">uart_irqs</span><span class="pc">[N</span><span class="c">R_PORTS</span><span class="pc">] </span><span class="c">= {</span> <span class="w">UART_IRQ_NUM</span> <span class="pc">}</span><span class="c">;</span>


<span class="w">m68328_uart</span> <span class="pc">*</span><span class="w">uart_addr</span> <span class="w">=</span><span class="pc"> (</span><span class="w">m</span><span class="c">68328_uart</span> <span class="w">*</span><span class="pc">)</span><span class="w">USTCNT_ADDR</span><span class="c">;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">tty_driver</span> <span class="c">*</span><span class="w">serial_driver</span><span class="c">;</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">change_speed</span><span class="c">(struct</span> <span class="pc">m68k</span><span class="c">_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">t</span><span class="pc">ty_s</span><span class="c">truct</span> <span class="c">*</span><span class="pc">t</span><span class="c">ty);</span>




<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_M68VZ328</span>
<span class="w">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">CONSOLE_BAUD_RATE</span>	<span class="w">19200</span>
<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">DEFAULT_CBAUD</span>		<span class="w">B19200</span>
<span class="c">#</span><span class="pc">en</span><span class="c">dif</span>


<span class="c">#</span><span class="pc">ifn</span><span class="c">def</span> <span class="w">C</span><span class="pc">ONS</span><span class="c">OLE_BAUD_RATE</span>
<span class="c">#define</span>	<span class="w">C</span><span class="pc">ONS</span><span class="c">OLE_BAUD_RATE</span>	<span class="w">9600</span>
<span class="c">#</span><span class="pc">d</span><span class="c">efine</span>	<span class="w">D</span><span class="c">EFAULT_CBAUD</span>		<span class="w">B9600</span>
<span class="c">#endif</span>


<span class="pc">sta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">m68328_console_initted</span> <span class="w">=</span> <span class="pc">0</span><span class="c">;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">m68328_console_baud</span>    <span class="pc">=</span> <span class="w">C</span><span class="pc">ONS</span><span class="c">OLE_BAUD_RATE;</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">m68328_console_cbaud</span>   <span class="pc">=</span> <span class="w">D</span><span class="c">EFAULT_CBAUD;</span>


<span class="c">static</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="c">int</span> <span class="w">serial_paranoia_check</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">inf</span><span class="c">o,</span>
					<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="pc">n</span><span class="c">ame</span><span class="pc">,</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">char</span> <span class="c">*</span><span class="w">routine</span><span class="pc">)</span>
<span class="c">{</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">SERIAL_PARANOIA_CHECK</span>
	<span class="pc">sta</span><span class="c">tic</span> <span class="c">const</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">badmagic</span> <span class="pc">=</span>
		<span class="w">"Warning:</span> <span class="w">ba</span><span class="pc">d</span> <span class="w">mag</span><span class="c">ic</span> <span class="w">nu</span><span class="pc">mb</span><span class="c">er</span> <span class="w">f</span><span class="c">or</span> <span class="w">ser</span><span class="pc">ial</span> <span class="w">stru</span><span class="c">ct</span> <span class="w">%</span><span class="pc">s</span> <span class="w">i</span><span class="pc">n</span> <span class="w">%</span><span class="c">s\n</span><span class="w">"</span><span class="pc">;</span>
	<span class="w">st</span><span class="pc">ati</span><span class="c">c</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">badinfo</span> <span class="pc">=</span>
		<span class="w">"W</span><span class="c">arning</span><span class="w">:</span> <span class="w">null</span> <span class="w">m68k_serial</span> <span class="w">f</span><span class="c">or</span> <span class="pc">%</span><span class="c">s</span> <span class="w">i</span><span class="c">n</span> <span class="pc">%</span><span class="c">s\n</span><span class="w">"</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">printk(</span><span class="w">b</span><span class="pc">a</span><span class="c">dinfo</span><span class="pc">,</span> <span class="w">n</span><span class="pc">a</span><span class="c">me,</span> <span class="w">routine)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">ma</span><span class="pc">g</span><span class="c">ic</span> <span class="pc">!</span><span class="c">=</span> <span class="w">SERIAL_MAGIC</span><span class="c">) {</span>
		<span class="pc">p</span><span class="c">rintk(</span><span class="w">badmagic</span><span class="pc">,</span> <span class="w">n</span><span class="pc">a</span><span class="c">me,</span> <span class="w">r</span><span class="c">outine</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">baud_table</span><span class="pc">[</span><span class="c">] = {</span>
	<span class="w">0</span><span class="pc">,</span> <span class="w">5</span><span class="pc">0</span><span class="c">,</span> <span class="w">75</span><span class="c">,</span> <span class="w">110</span><span class="c">,</span> <span class="w">134</span><span class="c">,</span> <span class="w">150</span><span class="c">,</span> <span class="w">2</span><span class="pc">0</span><span class="c">0,</span> <span class="w">300</span><span class="c">,</span> <span class="w">600</span><span class="c">,</span> <span class="w">1200</span><span class="c">,</span> <span class="w">1800</span><span class="c">,</span> <span class="w">2400</span><span class="c">,</span> <span class="w">4800</span><span class="c">,</span>
	<span class="w">9600</span><span class="c">,</span> <span class="w">19200</span><span class="c">,</span> <span class="w">38400</span><span class="c">,</span> <span class="w">57600</span><span class="c">,</span> <span class="w">115200</span><span class="c">,</span> <span class="c">0</span> <span class="pc">}</span><span class="c">;</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">get_baud</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">r</span><span class="pc">esu</span><span class="c">lt</span> <span class="c">=</span> <span class="w">1</span><span class="pc">1</span><span class="c">5200</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">s</span><span class="c">hort</span> <span class="w">in</span><span class="pc">t</span> <span class="w">ba</span><span class="pc">u</span><span class="c">d</span> <span class="c">=</span> <span class="w">uart_addr[ss</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span><span class="w">]</span><span class="pc">.</span><span class="w">ubaud</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">GET_FIELD</span><span class="c">(</span><span class="w">bau</span><span class="c">d,</span> <span class="w">UBAUD_PRESCALER)</span><span class="pc"> </span><span class="c">==</span> <span class="w">0x38</span><span class="c">)</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult</span> <span class="c">=</span> <span class="w">38400</span><span class="pc">;</span>
	<span class="w">r</span><span class="pc">es</span><span class="c">ult</span> <span class="w">&gt;</span><span class="c">&gt;=</span> <span class="w">G</span><span class="c">ET_FIELD</span><span class="pc">(</span><span class="w">ba</span><span class="pc">u</span><span class="c">d</span><span class="pc">,</span> <span class="w">UBAUD_DIVIDE</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">es</span><span class="c">ult;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rs_stop</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">dr</span><span class="c">iver_data;</span>
	<span class="w">m68328_uart</span> <span class="w">*ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">inf</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">n</span><span class="c">e];</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="pc">i</span><span class="c">nfo,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;name</span><span class="w">,</span><span class="pc"> "</span><span class="w">rs_stop"</span><span class="pc">))</span>
		<span class="c">return</span><span class="w">;</span>
	
	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="w">ua</span><span class="pc">rt-</span><span class="c">&gt;</span><span class="w">ustcnt</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">USTCNT_TXEN</span><span class="c">;</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rs_put_char</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">ch</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">loops</span> <span class="pc">=</span> <span class="c">0;</span>

        <span class="w">l</span><span class="c">ocal_irq_save</span><span class="pc">(</span><span class="w">f</span><span class="c">lags</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="pc">(!(</span><span class="w">UTX</span> <span class="pc">&amp;</span> <span class="w">UTX_TX_AVAIL) &amp;</span><span class="pc">&amp; </span><span class="c">(loops</span> <span class="w">&lt;</span> <span class="w">10</span><span class="pc">0</span><span class="c">0</span><span class="pc">)) </span><span class="c">{</span>
        	<span class="w">l</span><span class="pc">oo</span><span class="c">ps</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
        	<span class="w">u</span><span class="c">delay(</span><span class="w">5</span><span class="c">);</span>
        <span class="c">}</span>

	<span class="w">UTX_TXDATA</span> <span class="pc">=</span> <span class="w">ch</span><span class="pc">;</span>
        <span class="w">ud</span><span class="c">elay(</span><span class="w">5</span><span class="c">);</span>
        <span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>
        <span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rs_start</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">dr</span><span class="c">iver_data;</span>
	<span class="w">m68328_uart</span> <span class="w">*ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">ne]</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="pc">i</span><span class="c">nfo,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;name</span><span class="w">,</span><span class="pc"> "</span><span class="w">rs_start"</span><span class="pc">))</span>
		<span class="c">return</span><span class="w">;</span>
	
	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_cnt</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="c">info-&gt;</span><span class="w">xmit_buf</span> <span class="w">&amp;&amp; !(ua</span><span class="pc">rt-</span><span class="c">&gt;</span><span class="w">ustcnt</span> <span class="w">&amp;</span> <span class="w">USTCNT_TXEN</span><span class="pc">)) </span><span class="c">{</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">USE_INTS</span>
		<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">u</span><span class="c">stcnt</span> <span class="pc">|</span><span class="c">=</span> <span class="w">U</span><span class="c">STCNT_TXEN</span> <span class="pc">|</span> <span class="w">USTCNT_TX_INTR_MASK</span><span class="c">;</span>
<span class="pc">#el</span><span class="c">se</span>
		<span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">u</span><span class="c">stcnt</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">U</span><span class="c">STCNT_TXEN;</span>
<span class="pc">#</span><span class="c">endif</span>
	<span class="pc">}</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">receive_chars</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">s</span><span class="c">hort</span> <span class="w">rx</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">m68328_uart</span> <span class="w">*ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">li</span><span class="pc">ne</span><span class="c">];</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">ch</span><span class="pc">,</span> <span class="w">fl</span><span class="pc">ag</span><span class="c">;</span>

	
<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">CONFIG_XCOPILOT_BUGS</span>
	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>	
		<span class="w">c</span><span class="pc">h</span> <span class="pc">=</span> <span class="w">GET_FIELD</span><span class="c">(</span><span class="w">rx</span><span class="pc">,</span> <span class="w">URX_RXDATA</span><span class="pc">)</span><span class="c">;</span>
	
		<span class="pc">i</span><span class="c">f(</span><span class="w">inf</span><span class="c">o-&gt;</span><span class="w">is_cons</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">i</span><span class="c">f(</span><span class="w">URX_BREAK</span> <span class="w">&amp;</span> <span class="w">rx</span><span class="pc">) </span><span class="c">{</span> 
				<span class="w">r</span><span class="c">eturn</span><span class="pc">;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_MAGIC_SYSRQ</span>
			<span class="w">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">h</span> <span class="c">==</span> <span class="w">0x1</span><span class="pc">0) </span><span class="c">{</span> 
				<span class="w">show_state(</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">show_free_areas</span><span class="c">(</span><span class="w">0</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">show_buffers(</span><span class="pc">)</span><span class="c">;</span>

				<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
			<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">h</span> <span class="pc">=</span><span class="c">=</span> <span class="w">0x12</span><span class="c">) {</span> 
				<span class="w">emergency_restart</span><span class="pc">()</span><span class="c">;</span>
				<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
<span class="w">#</span><span class="c">endif</span> 
			<span class="c">}</span>
		<span class="pc">}</span>

		<span class="w">fl</span><span class="pc">ag</span> <span class="c">=</span> <span class="w">TTY_NORMAL</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rx</span> <span class="pc">&amp;</span> <span class="w">URX_PARITY_ERROR</span><span class="pc">)</span>
			<span class="w">fl</span><span class="pc">ag</span> <span class="c">=</span> <span class="w">TTY_PARITY</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">rx</span> <span class="pc">&amp;</span> <span class="w">URX_OVRUN</span><span class="c">)</span>
			<span class="w">f</span><span class="pc">lag</span> <span class="c">=</span> <span class="w">TTY_OVERRUN</span><span class="c">;</span>
		<span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="w">rx</span> <span class="pc">&amp;</span> <span class="w">URX_FRAME_ERROR</span><span class="c">)</span>
			<span class="w">f</span><span class="pc">lag</span> <span class="c">=</span> <span class="w">TTY_FRAME</span><span class="c">;</span>

		<span class="w">tty_insert_flip_char</span><span class="pc">(&amp;</span><span class="w">in</span><span class="c">fo-&gt;</span><span class="w">tport</span><span class="c">,</span> <span class="w">ch</span><span class="pc">,</span> <span class="w">f</span><span class="pc">lag</span><span class="c">);</span>
<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">CONFIG_XCOPILOT_BUGS</span>
	<span class="w">}</span> <span class="w">w</span><span class="c">hile</span><span class="pc">((</span><span class="w">r</span><span class="pc">x</span> <span class="w">=</span> <span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">urx</span><span class="pc">.</span><span class="w">w)</span><span class="pc"> </span><span class="c">&amp;</span> <span class="w">URX_DATA_READY</span><span class="pc">);</span>
<span class="pc">#</span><span class="c">endif</span>

	<span class="w">tty_schedule_flip</span><span class="pc">(&amp;</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;tport</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">transmit_chars</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">t</span><span class="pc">t</span><span class="c">y_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="w">m68328_uart</span> <span class="pc">*</span><span class="w">ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">ne]</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(info-&gt;</span><span class="w">x_char</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">ua</span><span class="pc">rt</span><span class="c">-&gt;</span><span class="w">utx</span><span class="pc">.</span><span class="w">b</span><span class="c">.</span><span class="w">txdata</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="pc">x</span><span class="c">_char</span><span class="pc">;</span>
		<span class="pc">in</span><span class="c">fo-&gt;</span><span class="pc">x</span><span class="c">_char</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">clear_and_return</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">if</span> <span class="pc">((</span><span class="c">info-&gt;</span><span class="w">xmit_cnt</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0</span><span class="w">) || !tt</span><span class="c">y</span> <span class="w">|</span><span class="c">|</span> <span class="w">tt</span><span class="c">y-&gt;</span><span class="w">stopped)</span><span class="c"> {</span>
		
		<span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">ustcnt</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">USTCNT_TX_INTR_MASK</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">c</span><span class="c">lear_and_return;</span>
	<span class="c">}</span>

	
	<span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">utx</span><span class="pc">.</span><span class="w">b</span><span class="pc">.</span><span class="w">txdata</span> <span class="c">=</span> <span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_buf[i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">xmit_tail++];</span>
	<span class="c">info-&gt;</span><span class="pc">xmit_t</span><span class="c">ail</span> <span class="w">=</span> <span class="c">info-&gt;</span><span class="w">x</span><span class="pc">mit_t</span><span class="c">ail</span> <span class="w">&amp;</span><span class="pc"> (</span><span class="w">SERIAL_XMIT_SIZE</span><span class="pc">-1</span><span class="c">);</span>
	<span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">xmit_cnt-</span><span class="pc">-</span><span class="c">;</span>

	<span class="pc">if</span><span class="c">(info-&gt;</span><span class="pc">x</span><span class="c">mit_cnt</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="pc">0) </span><span class="c">{</span>
		
		<span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">ustcnt</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">USTCNT_TX_INTR_MASK</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">clear_and_return</span><span class="c">;</span>
	<span class="c">}</span>

<span class="w">cl</span><span class="pc">ear_a</span><span class="c">nd_return</span><span class="w">:</span>
	
	<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
<span class="c">}</span>


<span class="w">ir</span><span class="pc">qr</span><span class="c">eturn_t</span> <span class="w">rs_interrupt</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="c">irq,</span> <span class="c">void</span> <span class="c">*dev_id)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="pc">i</span><span class="c">nfo</span> <span class="c">=</span> <span class="c">dev_id;</span>
	<span class="c">struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty</span> <span class="pc">=</span> <span class="w">tty_port_tty_get</span><span class="pc">(&amp;</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">tport</span><span class="c">);</span>
	<span class="w">m68328_uart</span> <span class="w">*ua</span><span class="c">rt</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">s</span><span class="c">hort</span> <span class="w">rx</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">s</span><span class="c">hort</span> <span class="w">tx</span><span class="c">;</span>

	<span class="w">ua</span><span class="pc">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">li</span><span class="pc">ne</span><span class="c">];</span>
	<span class="w">rx</span> <span class="c">=</span> <span class="w">ua</span><span class="pc">rt-</span><span class="c">&gt;</span><span class="w">urx</span><span class="pc">.</span><span class="w">w</span><span class="c">;</span>

<span class="w">#</span><span class="c">ifdef</span> <span class="w">USE_INTS</span>
	<span class="w">tx</span> <span class="pc">=</span> <span class="w">ua</span><span class="pc">rt-</span><span class="c">&gt;</span><span class="w">utx</span><span class="c">.</span><span class="w">w</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rx</span> <span class="w">&amp;</span> <span class="w">URX_DATA_READY</span><span class="c">)</span>
		<span class="w">receive_chars</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span><span class="pc">,</span> <span class="w">rx</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">tx</span> <span class="c">&amp;</span> <span class="w">UTX_TX_AVAIL</span><span class="c">)</span>
		<span class="w">transmit_chars</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">fo,</span> <span class="w">tt</span><span class="c">y);</span>
<span class="w">#</span><span class="c">else</span>
	<span class="w">r</span><span class="pc">ec</span><span class="c">eive_chars(info,</span> <span class="w">rx</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span>
	<span class="w">tty_kref_put</span><span class="c">(</span><span class="w">tt</span><span class="c">y</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">ret</span><span class="c">urn</span> <span class="w">I</span><span class="c">RQ_HANDLED;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">startup</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">nf</span><span class="c">o,</span> <span class="c">struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="w">m68328_uart</span> <span class="pc">*</span><span class="w">ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">ne</span><span class="c">];</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	
	<span class="pc">if</span> <span class="c">(info-&gt;</span><span class="w">tport</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">ASYNC_INITIALIZED</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">info-&gt;</span><span class="w">xmit_buf</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;xmit_buf</span> <span class="w">=</span><span class="pc"> (</span><span class="w">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*)</span> <span class="w">__get_free_page</span><span class="pc">(</span><span class="w">G</span><span class="c">FP_KERNEL);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">info-&gt;</span><span class="pc">x</span><span class="c">mit_buf)</span>
			<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="c">}</span>

	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>

	

	<span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">ustcnt</span> <span class="c">=</span> <span class="w">USTCNT_UEN</span><span class="c">;</span>
	<span class="w">ua</span><span class="c">rt-&gt;ustcnt</span> <span class="c">=</span> <span class="pc">U</span><span class="c">STCNT_UEN</span> <span class="pc">|</span> <span class="w">USTCNT_RXEN</span> <span class="pc">|</span> <span class="w">USTCNT_TXEN</span><span class="c">;</span>
	<span class="w">(</span><span class="c">void)</span><span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">urx</span><span class="pc">.</span><span class="w">w</span><span class="pc">;</span>

	
<span class="pc">#</span><span class="c">ifdef</span> <span class="w">USE_INTS</span>
	<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">stcnt</span> <span class="pc">=</span> <span class="pc">U</span><span class="c">STCNT_UEN</span> <span class="pc">|</span> <span class="w">U</span><span class="pc">STCNT_R</span><span class="c">XEN</span> <span class="c">|</span> 
                 <span class="w">USTCNT_RX_INTR_MASK</span> <span class="c">|</span> <span class="w">USTCNT_TX_INTR_MASK</span><span class="pc">;</span>
<span class="pc">#el</span><span class="c">se</span>
	<span class="w">ua</span><span class="c">rt</span><span class="w">-</span><span class="c">&gt;ustcnt</span> <span class="c">=</span> <span class="c">USTCNT_UEN</span> <span class="pc">|</span> <span class="c">USTCNT_RXEN</span> <span class="c">|</span> <span class="pc">USTCNT_R</span><span class="c">X_INTR_MASK</span><span class="pc">;</span>
<span class="w">#</span><span class="c">endif</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">t</span><span class="c">y</span><span class="pc">)</span>
		<span class="w">cl</span><span class="pc">e</span><span class="c">ar_bit(</span><span class="w">TTY_IO_ERROR</span><span class="c">, &amp;</span><span class="w">t</span><span class="c">ty-&gt;</span><span class="pc">f</span><span class="c">lags);</span>
	<span class="w">inf</span><span class="c">o-&gt;</span><span class="w">xmit_cnt</span> <span class="c">=</span> <span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">xmit_head</span> <span class="w">=</span> <span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">xmit_tail</span> <span class="w">=</span> <span class="c">0;</span>

	

	<span class="w">change_speed</span><span class="c">(info</span><span class="pc">,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">tport</span><span class="pc">.</span><span class="w">f</span><span class="c">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">ASYNC_INITIALIZED</span><span class="c">;</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>
	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">shutdown</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="pc">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="w">m68328_uart</span> <span class="pc">*</span><span class="w">ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr[i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">ne]</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span>	<span class="c">flags;</span>

	<span class="w">ua</span><span class="pc">rt-</span><span class="c">&gt;</span><span class="w">ustcnt</span> <span class="c">=</span> <span class="c">0;</span> 
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="c">info-&gt;</span><span class="w">tport</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">ASYNC_INITIALIZED</span><span class="pc">))</span>
		<span class="c">return;</span>

	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="c">lags</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(info-&gt;</span><span class="w">xmit_buf</span><span class="c">) {</span>
		<span class="w">free_page</span><span class="pc">((</span><span class="c">unsigned</span> <span class="c">long)</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">x</span><span class="c">mit_buf</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="pc">x</span><span class="c">mit_buf</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">tt</span><span class="c">y</span><span class="pc">)</span>
		<span class="w">s</span><span class="pc">e</span><span class="c">t_bit(</span><span class="w">TTY_IO_ERROR</span><span class="c">, &amp;</span><span class="w">tt</span><span class="c">y-&gt;flags);</span>
	
	<span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">tport</span><span class="pc">.</span><span class="c">flags</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">ASYNC_INITIALIZED</span><span class="c">;</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="pc">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">divisor,</span> <span class="w">prescale</span><span class="pc">;</span>
<span class="w">}</span>
<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">CONFIG_M68VZ328</span>
 <span class="w">hw_baud_table[18] </span><span class="pc">= </span><span class="c">{</span>
	<span class="pc">{0</span><span class="c">,</span><span class="pc">0},</span> 
	<span class="c">{</span><span class="pc">0</span><span class="c">,</span><span class="pc">0</span><span class="c">},</span> 
	<span class="c">{0,0},</span> 
	<span class="c">{0,0},</span> 
	<span class="c">{0,0},</span> 
	<span class="c">{0,0},</span> 
	<span class="c">{0,0},</span> 
	<span class="c">{</span><span class="w">7</span><span class="c">,</span><span class="w">0x26</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">6</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">5</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
	<span class="c">{0,0},</span> 
	<span class="c">{</span><span class="w">4</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">3</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">2</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">1</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">0</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">1</span><span class="c">,</span><span class="w">0x3</span><span class="pc">8</span><span class="c">},</span> 
	<span class="c">{</span><span class="w">0</span><span class="c">,</span><span class="w">0x3</span><span class="pc">8</span><span class="c">},</span> 
<span class="pc">}</span><span class="c">;</span>
<span class="w">#e</span><span class="pc">l</span><span class="c">se</span>
 <span class="w">hw_baud_table[18</span><span class="pc">] = </span><span class="c">{</span>
                 <span class="pc">{</span><span class="c">0,0</span><span class="pc">}</span><span class="c">,</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{</span><span class="w">7</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{</span><span class="w">6</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{0,0},</span> 
                 <span class="c">{</span><span class="w">5</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{</span><span class="w">4</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{</span><span class="w">3</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{</span><span class="w">2</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{</span><span class="w">1</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{</span><span class="w">0</span><span class="c">,</span><span class="w">0x2</span><span class="pc">6</span><span class="c">},</span> 
                 <span class="c">{</span><span class="w">1</span><span class="c">,</span><span class="w">0x3</span><span class="pc">8</span><span class="c">},</span> 
<span class="pc">}</span><span class="c">;</span> 
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>



<span class="w">s</span><span class="c">tatic</span> <span class="w">v</span><span class="c">oid</span> <span class="w">change_speed</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">nf</span><span class="c">o,</span> <span class="c">struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="w">m68328_uart</span> <span class="pc">*</span><span class="w">ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">ne</span><span class="c">];</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">s</span><span class="c">hort</span> <span class="w">p</span><span class="pc">o</span><span class="c">rt;</span>
	<span class="c">unsigned</span> <span class="pc">s</span><span class="c">hort</span> <span class="w">ustcnt</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="w">cflag</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span>	<span class="pc">i</span><span class="c">;</span>

	<span class="w">c</span><span class="pc">f</span><span class="c">lag</span> <span class="c">=</span> <span class="w">t</span><span class="pc">t</span><span class="c">y-&gt;</span><span class="w">te</span><span class="c">rmios</span><span class="pc">.</span><span class="w">c_cflag</span><span class="c">;</span>
	<span class="w">p</span><span class="c">ort</span> <span class="c">=</span> <span class="w">inf</span><span class="c">o-&gt;</span><span class="w">p</span><span class="c">ort;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">p</span><span class="c">ort)</span>
		<span class="c">return;</span>

	<span class="w">u</span><span class="pc">s</span><span class="c">tcnt</span> <span class="c">=</span> <span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">stcnt</span><span class="pc">;</span>
	<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">u</span><span class="c">stcnt</span> <span class="c">=</span> <span class="w">u</span><span class="c">stcnt</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">USTCNT_TXEN</span><span class="c">;</span>

	<span class="w">i</span> <span class="c">=</span> <span class="pc">c</span><span class="c">flag</span> <span class="w">&amp;</span> <span class="w">CBAUD</span><span class="c">;</span>
        <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span> <span class="w">&amp;</span> <span class="w">CBAUDEX</span><span class="c">) {</span>
                <span class="pc">i</span> <span class="pc">= </span><span class="c">(</span><span class="w">i</span> <span class="pc">&amp; </span><span class="c">~</span><span class="pc">C</span><span class="c">BAUDEX</span><span class="w">) +</span> <span class="w">B38400</span><span class="c">;</span>
        <span class="w">}</span>

	<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ubaud</span> <span class="c">=</span> <span class="w">PUT_FIELD</span><span class="pc">(</span><span class="w">UBAUD_DIVIDE</span><span class="c">,</span>    <span class="w">hw_baud_table[</span><span class="c">i</span><span class="pc">].</span><span class="w">divisor) </span><span class="pc">|</span> 
		<span class="pc">P</span><span class="c">UT_FIELD</span><span class="pc">(</span><span class="w">UBAUD_PRESCALER</span><span class="c">,</span> <span class="pc">h</span><span class="c">w_baud_table[i].</span><span class="w">prescale</span><span class="c">);</span>

	<span class="w">ustcnt</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">USTCNT_PARITYEN</span> <span class="pc">|</span> <span class="w">USTCNT_ODD_EVEN</span> <span class="pc">|</span> <span class="w">USTCNT_STOP</span> <span class="c">|</span> <span class="w">USTCNT_8_7</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="pc">((</span><span class="w">cflag</span> <span class="pc">&amp;</span> <span class="w">CSIZE</span><span class="c">) ==</span> <span class="w">CS8</span><span class="pc">)</span>
		<span class="w">u</span><span class="pc">s</span><span class="c">tcnt</span> <span class="pc">|</span><span class="c">=</span> <span class="w">U</span><span class="pc">STCNT_8</span><span class="c">_7;</span>
		
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">flag</span> <span class="c">&amp;</span> <span class="w">CSTOPB</span><span class="c">)</span>
		<span class="c">ustcnt</span> <span class="c">|=</span> <span class="w">U</span><span class="pc">STCNT_S</span><span class="c">TOP;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">flag</span> <span class="c">&amp;</span> <span class="w">PARENB</span><span class="c">)</span>
		<span class="c">ustcnt</span> <span class="c">|=</span> <span class="pc">USTCNT_P</span><span class="c">ARITYEN;</span>
	<span class="c">if</span> <span class="c">(cflag</span> <span class="c">&amp;</span> <span class="w">PARODD</span><span class="c">)</span>
		<span class="c">ustcnt</span> <span class="c">|=</span> <span class="w">USTCNT_ODD_EVEN</span><span class="c">;</span>
	
<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="w">CONFIG_SERIAL_68328_RTS_CTS</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">c</span><span class="c">flag</span> <span class="c">&amp;</span> <span class="w">CRTSCTS</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">utx</span><span class="pc">.</span><span class="w">w</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span> <span class="w">UTX_NOCTS</span><span class="c">;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">{</span>
		<span class="w">ua</span><span class="c">rt-&gt;</span><span class="pc">u</span><span class="c">tx.</span><span class="w">w</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">U</span><span class="c">TX_NOCTS;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span>

	<span class="w">u</span><span class="pc">s</span><span class="c">tcnt</span> <span class="pc">|</span><span class="c">=</span> <span class="w">USTCNT_TXEN</span><span class="c">;</span>
	
	<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">us</span><span class="c">tcnt</span> <span class="pc">=</span> <span class="w">u</span><span class="c">stcnt;</span>
	<span class="w">r</span><span class="c">eturn</span><span class="pc">;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">rs_fair_output</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">le</span><span class="pc">f</span><span class="c">t;</span>		
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="c">nfo</span> <span class="pc">= &amp;</span><span class="w">m68k_soft</span><span class="pc">[0</span><span class="c">];</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">c</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">i</span><span class="c">nfo</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0)</span> <span class="c">return;</span>
	<span class="c">if</span> <span class="c">(info-&gt;</span><span class="w">xmit_buf</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0)</span> <span class="c">return</span><span class="pc">;</span>

	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="w">le</span><span class="pc">f</span><span class="c">t</span> <span class="c">=</span> <span class="c">info-&gt;</span><span class="w">xmit_cnt</span><span class="pc">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">le</span><span class="pc">f</span><span class="c">t</span> <span class="w">!</span><span class="c">=</span> <span class="c">0) {</span>
		<span class="w">c</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">nfo-&gt;xmit_buf</span><span class="pc">[</span><span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">xmit_tail</span><span class="pc">];</span>
		<span class="pc">in</span><span class="c">fo-&gt;</span><span class="pc">xmit_t</span><span class="c">ail</span> <span class="w">=</span><span class="pc"> (</span><span class="c">info-&gt;</span><span class="pc">x</span><span class="c">mit_tail</span><span class="pc">+</span><span class="c">1</span><span class="w">) &amp;</span><span class="pc"> (</span><span class="w">SERIAL_XMIT_SIZE</span><span class="pc">-</span><span class="c">1);</span>
		<span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">x</span><span class="pc">mit_c</span><span class="c">nt</span><span class="w">-</span><span class="pc">-</span><span class="c">;</span>
		<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>

		<span class="w">rs_put_char</span><span class="c">(</span><span class="w">c</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
		<span class="w">le</span><span class="pc">f</span><span class="c">t</span> <span class="c">=</span> <span class="w">m</span><span class="pc">in</span><span class="c">(info-&gt;xmit_cnt</span><span class="pc">,</span> <span class="w">l</span><span class="pc">ef</span><span class="c">t</span><span class="w">-</span><span class="c">1);</span>
	<span class="pc">}</span>

	
	<span class="w">ud</span><span class="c">elay(</span><span class="w">5</span><span class="c">);</span>

	<span class="w">l</span><span class="pc">ocal_irq_r</span><span class="c">estore</span><span class="pc">(</span><span class="w">f</span><span class="c">lags);</span>
	<span class="c">return</span><span class="w">;</span>
<span class="c">}</span>


<span class="pc">v</span><span class="c">oid</span> <span class="w">console_print_68328</span><span class="c">(</span><span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">p</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">c</span><span class="pc">;</span>
	
	<span class="w">w</span><span class="c">hile</span><span class="pc">((</span><span class="w">c=*(</span><span class="pc">p</span><span class="w">++)) !=</span> <span class="w">0)</span><span class="pc"> </span><span class="c">{</span>
		<span class="c">if(</span><span class="pc">c</span> <span class="w">== '\n')</span>
			<span class="w">rs_put_char('\r');</span>
		<span class="w">r</span><span class="c">s_put_char(</span><span class="pc">c);</span>
	<span class="c">}</span>

	
	<span class="w">rs_fair_output</span><span class="pc">()</span><span class="c">;</span>

	<span class="c">return</span><span class="w">;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rs_set_ldisc</span><span class="c">(struct</span> <span class="w">t</span><span class="pc">t</span><span class="c">y_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">,</span> <span class="w">tt</span><span class="c">y-&gt;name</span><span class="w">,</span><span class="pc"> "</span><span class="w">rs</span><span class="pc">_s</span><span class="c">et_ldisc</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">is_cons</span> <span class="w">=</span><span class="pc"> (</span><span class="w">t</span><span class="pc">t</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="pc">e</span><span class="c">rmios.</span><span class="w">c_line</span> <span class="pc">==</span> <span class="w">N_TTY</span><span class="c">);</span>
	
	<span class="w">p</span><span class="pc">rin</span><span class="c">tk</span><span class="pc">("</span><span class="w">ttyS</span><span class="pc">%d</span> <span class="w">console</span> <span class="w">mo</span><span class="pc">de</span> <span class="pc">%s</span><span class="c">\n",</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">li</span><span class="pc">ne</span><span class="c">,</span> <span class="c">info-&gt;</span><span class="w">i</span><span class="pc">s</span><span class="c">_cons</span> <span class="w">?</span><span class="c"> "</span><span class="w">o</span><span class="pc">n</span><span class="c">" : "</span><span class="w">of</span><span class="pc">f")</span><span class="c">;</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rs_flush_chars</span><span class="c">(struct</span> <span class="w">t</span><span class="pc">ty_</span><span class="c">struct</span> <span class="c">*tty</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="c">nfo</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="pc">t</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>
	<span class="w">m68328_uart</span> <span class="w">*ua</span><span class="c">rt</span> <span class="pc">= &amp;</span><span class="w">uart_addr[in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">ne]</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="pc">i</span><span class="c">nfo,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;name</span><span class="w">,</span><span class="pc"> "</span><span class="w">rs_flush_chars"</span><span class="pc">))</span>
		<span class="c">return</span><span class="w">;</span>
<span class="w">#</span><span class="pc">ifn</span><span class="c">def</span> <span class="w">USE_INTS</span>
	<span class="w">f</span><span class="c">or</span><span class="w">(;;) {</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

	
	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">xmit_cnt</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0</span> <span class="pc">|</span><span class="c">|</span> <span class="w">tt</span><span class="c">y-&gt;</span><span class="w">stopped</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_buf</span><span class="c">) {</span>
		<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>

<span class="w">#</span><span class="pc">ifd</span><span class="c">ef</span> <span class="c">USE_INTS</span>
	<span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">ustcnt</span> <span class="w">|</span><span class="c">=</span> <span class="w">USTCNT_TXEN</span> <span class="pc">|</span> <span class="w">USTCNT_TX_INTR_MASK</span><span class="pc">;</span>
<span class="pc">#el</span><span class="c">se</span>
	<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;ustcnt</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">USTCNT_TXE</span><span class="c">N;</span>
<span class="pc">#</span><span class="c">endif</span>

<span class="c">#ifdef</span> <span class="w">U</span><span class="pc">SE</span><span class="c">_INTS</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">utx</span><span class="pc">.</span><span class="w">w</span> <span class="w">&amp;</span> <span class="w">UTX_TX_AVAIL</span><span class="pc">) </span><span class="c">{</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">1</span><span class="pc">) </span><span class="c">{</span>
<span class="c">#endif</span>
		
		<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">ut</span><span class="c">x</span><span class="pc">.</span><span class="w">b</span><span class="c">.</span><span class="w">txdata</span> <span class="c">=</span> <span class="w">inf</span><span class="c">o-&gt;</span><span class="w">xmit_buf</span><span class="pc">[</span><span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">xmit_tail++];</span>
		<span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="pc">xmit_t</span><span class="c">ail</span> <span class="w">=</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">x</span><span class="pc">mit_t</span><span class="c">ail</span> <span class="w">&amp;</span><span class="pc"> (</span><span class="w">SERIAL_XMIT_SIZE</span><span class="pc">-</span><span class="c">1);</span>
		<span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">xmit_cnt-</span><span class="pc">-</span><span class="c">;</span>
	<span class="c">}</span>

<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">USE_INTS</span>
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="w">(!</span><span class="pc">(</span><span class="w">ua</span><span class="c">rt-&gt;</span><span class="pc">u</span><span class="c">tx</span><span class="pc">.</span><span class="w">w</span> <span class="pc">&amp;</span> <span class="w">UTX_TX_AVAIL</span><span class="c">))</span> <span class="w">u</span><span class="pc">d</span><span class="c">elay(</span><span class="w">5</span><span class="c">);</span>
	<span class="w">}</span>
<span class="pc">#en</span><span class="c">dif</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="pc">f</span><span class="c">lags);</span>
<span class="pc">}</span>

<span class="w">e</span><span class="pc">x</span><span class="c">tern</span> <span class="c">void</span> <span class="w">console_printn</span><span class="c">(</span><span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span> <span class="w">b</span><span class="c">,</span> <span class="c">int</span> <span class="c">count</span><span class="pc">);</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">rs_write</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*</span> <span class="c">tty,</span>
		    <span class="pc">c</span><span class="c">onst</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">char</span> <span class="c">*</span><span class="pc">b</span><span class="c">uf,</span> <span class="c">int</span> <span class="c">count</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">int</span>	<span class="w">c</span><span class="pc">,</span> <span class="w">to</span><span class="pc">t</span><span class="c">al</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty-&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>
	<span class="w">m68328_uart</span> <span class="w">*ua</span><span class="c">rt</span> <span class="pc">= &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span><span class="pc">]</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="pc">i</span><span class="c">nfo,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;name</span><span class="w">,</span><span class="pc"> "</span><span class="w">rs_write"</span><span class="pc">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">tt</span><span class="c">y</span> <span class="pc">|| </span><span class="c">!</span><span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_buf</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">local_save_flags</span><span class="c">(</span><span class="w">fl</span><span class="c">ags);</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="pc">1) </span><span class="c">{</span>
		<span class="w">local_irq_disable</span><span class="pc">()</span><span class="c">;</span>		
		<span class="w">c</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">i</span><span class="c">n_t(</span><span class="w">i</span><span class="c">nt,</span> <span class="w">c</span><span class="c">ount,</span> <span class="w">mi</span><span class="pc">n(</span><span class="w">SERIAL_XMIT_SIZE</span> <span class="w">-</span> <span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">xmit_cnt</span> <span class="w">-</span> <span class="c">1</span><span class="pc">,</span>
				   <span class="w">S</span><span class="c">ERIAL_XMIT_SIZE</span> <span class="w">-</span> <span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">xmit_head)</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0</span><span class="pc">)</span>
			<span class="pc">b</span><span class="c">reak;</span>

		<span class="w">m</span><span class="c">emcpy(</span><span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_buf</span> <span class="pc">+</span> <span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="pc">xmit_h</span><span class="c">ead,</span> <span class="w">b</span><span class="pc">uf</span><span class="c">,</span> <span class="w">c</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">local_irq_disable(</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">in</span><span class="c">fo-&gt;xmit_head</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">i</span><span class="c">nfo-&gt;xmit_head</span> <span class="pc">+</span> <span class="w">c) &amp;</span><span class="pc"> (</span><span class="w">SERIAL_XMIT_SIZE</span><span class="c">-1);</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">xmit_cnt</span> <span class="pc">+=</span> <span class="w">c</span><span class="pc">;</span>
		<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">fl</span><span class="c">ags);</span>
		<span class="w">b</span><span class="pc">u</span><span class="c">f</span> <span class="pc">+</span><span class="c">=</span> <span class="w">c</span><span class="pc">;</span>
		<span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="pc">-</span><span class="c">=</span> <span class="w">c</span><span class="c">;</span>
		<span class="w">to</span><span class="pc">t</span><span class="c">al</span> <span class="pc">+</span><span class="c">=</span> <span class="c">c;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="pc">xmit_c</span><span class="c">nt</span> <span class="w">&amp;</span><span class="pc">&amp; !</span><span class="w">tt</span><span class="c">y-&gt;</span><span class="w">stopped</span><span class="c">) {</span>
		
		<span class="w">local_irq_disable(</span><span class="pc">)</span><span class="c">;</span>		
<span class="w">#</span><span class="pc">ifn</span><span class="c">def</span> <span class="w">USE_INTS</span>
		<span class="w">w</span><span class="c">hile(</span><span class="w">inf</span><span class="c">o-&gt;</span><span class="w">x</span><span class="c">mit_cnt</span><span class="w">)</span><span class="c"> {</span>
<span class="pc">#</span><span class="c">endif</span>

		<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ustcnt</span> <span class="w">|</span><span class="c">=</span> <span class="w">USTCNT_TXEN</span><span class="c">;</span>
<span class="pc">#i</span><span class="c">fdef</span> <span class="w">U</span><span class="pc">SE</span><span class="c">_INTS</span>
		<span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">stcnt</span> <span class="w">|</span><span class="c">=</span> <span class="w">USTCNT_TX_INTR_MASK</span><span class="c">;</span>
<span class="c">#</span><span class="pc">el</span><span class="c">se</span>
		<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="w">(!</span><span class="pc">(</span><span class="w">ua</span><span class="c">rt-&gt;</span><span class="w">utx</span><span class="pc">.</span><span class="w">w</span> <span class="c">&amp;</span> <span class="w">UTX_TX_AVAIL</span><span class="c">))</span> <span class="w">u</span><span class="pc">d</span><span class="c">elay(</span><span class="w">5</span><span class="c">);</span>
<span class="pc">#</span><span class="c">endif</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ua</span><span class="c">rt</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">ut</span><span class="c">x.</span><span class="w">w</span> <span class="c">&amp;</span> <span class="w">U</span><span class="c">TX_TX_AVAIL</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ua</span><span class="c">rt-&gt;</span><span class="pc">ut</span><span class="c">x.</span><span class="w">b</span><span class="c">.</span><span class="w">txdata</span> <span class="c">=</span> <span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">xmit_buf</span><span class="pc">[</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">xmit_tail++];</span>
			<span class="w">i</span><span class="c">nfo-&gt;</span><span class="pc">xmit_t</span><span class="c">ail</span> <span class="pc">=</span> <span class="c">info-&gt;</span><span class="w">x</span><span class="pc">mit_t</span><span class="c">ail</span> <span class="w">&amp;</span><span class="pc"> (</span><span class="w">SERIAL_XMIT_SIZE</span><span class="pc">-</span><span class="c">1);</span>
			<span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">xmit_cnt-</span><span class="pc">-</span><span class="c">;</span>
		<span class="pc">}</span>

<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">USE_INTS</span>
		<span class="w">}</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>
		<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">to</span><span class="pc">t</span><span class="c">al;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">rs_write_room</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>
	<span class="pc">i</span><span class="c">nt</span>	<span class="pc">r</span><span class="c">et</span><span class="pc">;</span>
				
	<span class="c">if</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;name</span><span class="pc">,</span><span class="c"> "</span><span class="w">rs</span><span class="c">_write_room</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">ret</span> <span class="c">=</span> <span class="w">SERIAL_XMIT_SIZE</span> <span class="w">-</span> <span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">xmit_cnt</span> <span class="pc">-</span> <span class="c">1;</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="pc">ret</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">rs_chars_in_buffer</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>
				
	<span class="pc">if</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="w">tt</span><span class="c">y-&gt;name</span><span class="pc">, </span><span class="c">"</span><span class="w">rs</span><span class="c">_chars_in_buffer</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_cnt</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rs_flush_buffer</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="c">nfo</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">dr</span><span class="c">iver_data;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
				
	<span class="pc">if</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span><span class="pc">,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="w">,</span><span class="pc"> "</span><span class="w">r</span><span class="c">s_flush_buffer</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span><span class="pc">;</span>
	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">xmit_cnt</span> <span class="c">=</span> <span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_head</span> <span class="w">=</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">xmit_tail</span> <span class="w">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="w">tty_wakeup</span><span class="c">(</span><span class="w">tt</span><span class="pc">y)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rs_throttle</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*</span> <span class="c">tty)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="c">nfo</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">,</span> <span class="w">t</span><span class="pc">ty</span><span class="c">-&gt;name</span><span class="w">,</span><span class="pc"> "</span><span class="w">rs</span><span class="c">_throttle</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span><span class="pc">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">I_IXOFF</span><span class="c">(</span><span class="w">t</span><span class="pc">t</span><span class="c">y</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">x_char</span> <span class="c">=</span> <span class="w">STOP_CHAR</span><span class="c">(</span><span class="w">t</span><span class="c">ty);</span>

	
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">rs_unthrottle</span><span class="c">(struct</span> <span class="pc">t</span><span class="c">ty_struct</span> <span class="c">*</span> <span class="c">tty)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">dr</span><span class="c">iver_data;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">inf</span><span class="c">o</span><span class="pc">,</span> <span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;name</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="w">rs</span><span class="c">_unthrottle</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span><span class="pc">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">I_IXOFF</span><span class="c">(</span><span class="w">t</span><span class="pc">t</span><span class="c">y</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">x_char</span><span class="pc">)</span>
			<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;x_char</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="c">else</span>
			<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="pc">x</span><span class="c">_char</span> <span class="c">=</span> <span class="w">START_CHAR</span><span class="pc">(</span><span class="w">tt</span><span class="c">y);</span>
	<span class="pc">}</span>

	
<span class="pc">}</span>



<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">get_serial_info</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span> <span class="pc">i</span><span class="c">nfo,</span>
			   <span class="pc">s</span><span class="c">truct</span> <span class="w">serial_struct</span> <span class="c">*</span> <span class="w">retinfo</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">s</span><span class="c">erial_struct</span> <span class="w">t</span><span class="c">mp;</span>
  
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">r</span><span class="c">etinfo</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">-</span><span class="w">EF</span><span class="c">AULT;</span>
	<span class="w">m</span><span class="pc">e</span><span class="c">mset</span><span class="pc">(&amp;t</span><span class="c">mp,</span> <span class="c">0,</span> <span class="c">sizeof(</span><span class="pc">t</span><span class="c">mp));</span>
	<span class="w">t</span><span class="c">mp.</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">t</span><span class="c">ype;</span>
	<span class="pc">t</span><span class="c">mp.</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span> <span class="c">=</span> <span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">li</span><span class="pc">n</span><span class="c">e;</span>
	<span class="pc">t</span><span class="c">mp</span><span class="pc">.</span><span class="w">po</span><span class="pc">r</span><span class="c">t</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">po</span><span class="pc">rt</span><span class="c">;</span>
	<span class="w">t</span><span class="c">mp.</span><span class="w">ir</span><span class="c">q</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="pc">i</span><span class="c">rq;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p.</span><span class="w">f</span><span class="c">lags</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">tport</span><span class="pc">.</span><span class="w">f</span><span class="c">lags;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span><span class="pc">.</span><span class="w">baud_base</span> <span class="c">=</span> <span class="c">info-&gt;baud_base;</span>
	<span class="w">t</span><span class="c">mp.</span><span class="w">close_delay</span> <span class="c">=</span> <span class="c">info-&gt;</span><span class="pc">t</span><span class="c">port</span><span class="pc">.</span><span class="c">close_delay;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span><span class="pc">.</span><span class="w">closing_wait</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="pc">t</span><span class="c">port.</span><span class="pc">c</span><span class="c">losing_wait</span><span class="pc">;</span>
	<span class="w">t</span><span class="c">mp.</span><span class="w">custom_divisor</span> <span class="c">=</span> <span class="c">info-&gt;custom_divisor;</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">co</span><span class="pc">p</span><span class="c">y_to_user(</span><span class="w">retinfo</span><span class="c">, &amp;</span><span class="w">t</span><span class="pc">m</span><span class="c">p,</span> <span class="c">sizeof</span><span class="pc">(*r</span><span class="c">etinfo)))</span>
		<span class="c">return</span> <span class="c">-EFAULT;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">set_serial_info</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="pc">i</span><span class="c">nfo,</span> <span class="c">struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty,</span>
			   <span class="c">struct</span> <span class="w">serial_struct</span> <span class="c">*</span> <span class="w">new_info</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">tty_port</span> <span class="c">*</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">tport</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">s</span><span class="pc">e</span><span class="c">rial_struct</span> <span class="w">new_serial</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">m</span><span class="c">68k_serial</span> <span class="w">old_info</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> 			<span class="w">r</span><span class="pc">etv</span><span class="c">al</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">new_info</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EF</span><span class="c">AULT;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">opy_from_user(&amp;</span><span class="pc">new_s</span><span class="c">erial</span><span class="pc">,</span> <span class="w">n</span><span class="pc">ew_i</span><span class="c">nfo,</span> <span class="c">sizeof(</span><span class="pc">n</span><span class="c">ew_serial)))</span>
		<span class="c">return</span> <span class="c">-EFAULT;</span>
	<span class="w">o</span><span class="c">ld_info</span> <span class="w">= </span><span class="pc">*</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">capable</span><span class="c">(</span><span class="w">CAP_SYS_ADMIN)</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">((n</span><span class="c">ew_serial</span><span class="w">.baud_base</span> <span class="pc">!</span><span class="c">=</span> <span class="w">i</span><span class="c">nfo-&gt;baud_base</span><span class="pc">) |</span><span class="c">|</span>
		    <span class="pc">(</span><span class="c">new_serial.</span><span class="pc">t</span><span class="c">ype</span> <span class="pc">!</span><span class="c">=</span> <span class="w">i</span><span class="c">nfo-&gt;type</span><span class="w">)</span><span class="pc"> |</span><span class="c">|</span>
		    <span class="pc">(n</span><span class="c">ew_serial</span><span class="pc">.</span><span class="w">close_delay</span> <span class="pc">!</span><span class="c">=</span> <span class="w">po</span><span class="c">rt-&gt;close_delay</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span>
		    <span class="w">(</span><span class="pc">(</span><span class="c">new_serial</span><span class="pc">.</span><span class="w">f</span><span class="c">lags</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">ASYNC_USR_MASK) </span><span class="pc">!</span><span class="c">=</span>
		     <span class="pc">(</span><span class="w">po</span><span class="c">rt-&gt;</span><span class="pc">f</span><span class="c">lags</span> <span class="w">&amp;</span><span class="pc"> ~A</span><span class="c">SYNC_USR_MASK</span><span class="w">))</span><span class="pc">)</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">EP</span><span class="c">ERM;</span>
		<span class="w">po</span><span class="c">rt-&gt;</span><span class="pc">f</span><span class="c">lags</span> <span class="w">=</span><span class="pc"> ((</span><span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;flags</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">A</span><span class="c">SYNC_USR_MASK</span><span class="w">)</span><span class="pc"> |</span>
			       <span class="c">(new_serial</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="pc">A</span><span class="c">SYNC_USR_MASK</span><span class="pc">))</span><span class="c">;</span>
		<span class="w">inf</span><span class="c">o-&gt;</span><span class="w">custom_divisor</span> <span class="c">=</span> <span class="pc">n</span><span class="c">ew_serial</span><span class="pc">.c</span><span class="c">ustom_divisor;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">check_and_exit</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;</span><span class="w">co</span><span class="pc">u</span><span class="c">nt</span> <span class="pc">&gt;</span> <span class="pc">1</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EB</span><span class="c">USY;</span>

	

	<span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">baud_base</span> <span class="c">=</span> <span class="c">new_serial</span><span class="pc">.</span><span class="c">baud_base;</span>
	<span class="w">po</span><span class="c">rt-&gt;</span><span class="pc">f</span><span class="c">lags</span> <span class="w">= </span><span class="pc">((</span><span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;flags</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">ASYNC_FLAGS</span><span class="pc">) </span><span class="c">|</span>
			<span class="c">(new_serial</span><span class="pc">.f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="pc">A</span><span class="c">SYNC_FLAGS</span><span class="pc">));</span>
	<span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="pc">n</span><span class="c">ew_serial</span><span class="pc">.</span><span class="w">t</span><span class="c">ype;</span>
	<span class="w">po</span><span class="c">rt-&gt;</span><span class="w">close_delay</span> <span class="c">=</span> <span class="c">new_serial</span><span class="pc">.</span><span class="c">close_delay;</span>
	<span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;</span><span class="w">closing_wait</span> <span class="c">=</span> <span class="w">n</span><span class="c">ew_serial</span><span class="pc">.</span><span class="c">closing_wait;</span>

<span class="w">check_and_exit:</span>
	<span class="w">ret</span><span class="pc">v</span><span class="c">al</span> <span class="c">=</span> <span class="w">startup</span><span class="c">(</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="w">tt</span><span class="c">y</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">get_lsr_info</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span> <span class="w">i</span><span class="pc">nf</span><span class="c">o,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">*</span><span class="w">v</span><span class="c">alue</span><span class="pc">)</span>
<span class="c">{</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_SERIAL_68328_RTS_CTS</span>
	<span class="w">m68328_uart</span> <span class="w">*ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">n</span><span class="c">e];</span>
<span class="w">#</span><span class="c">endif</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">s</span><span class="pc">tatu</span><span class="c">s;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	<span class="w">local_irq_save</span><span class="c">(</span><span class="pc">f</span><span class="c">lags);</span>
<span class="pc">#i</span><span class="c">fdef</span> <span class="pc">C</span><span class="c">ONFIG_SERIAL_68328_RTS_CTS</span>
	<span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">ua</span><span class="pc">rt</span><span class="c">-&gt;</span><span class="w">utx</span><span class="c">.</span><span class="w">w</span> <span class="pc">&amp;</span> <span class="w">UTX_CTS_STAT</span><span class="pc">) ?</span> <span class="c">1</span> <span class="c">:</span> <span class="c">0;</span>
<span class="pc">#el</span><span class="c">se</span>
	<span class="w">s</span><span class="pc">tatu</span><span class="c">s</span> <span class="c">=</span> <span class="c">0;</span>
<span class="c">#endif</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="pc">f</span><span class="c">lags);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">p</span><span class="pc">u</span><span class="c">t_user(</span><span class="w">s</span><span class="pc">t</span><span class="c">atus</span><span class="pc">,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">send_break</span><span class="c">(struct</span> <span class="w">m68k_serial</span> <span class="c">*</span> <span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="c">int</span> <span class="w">duration</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">m68328_uart</span> <span class="pc">*</span><span class="w">ua</span><span class="c">rt</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">uart_addr</span><span class="pc">[</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">n</span><span class="c">e</span><span class="pc">]</span><span class="c">;</span>
        <span class="c">unsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
        <span class="pc">if</span> <span class="pc">(!i</span><span class="c">nfo-&gt;</span><span class="w">po</span><span class="pc">rt)</span>
                <span class="c">return;</span>
        <span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="c">lags</span><span class="pc">)</span><span class="c">;</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">USE_INTS</span>	
	<span class="w">ua</span><span class="pc">rt</span><span class="c">-&gt;</span><span class="w">utx</span><span class="c">.</span><span class="w">w</span> <span class="w">|</span><span class="c">=</span> <span class="w">UTX_SEND_BREAK</span><span class="c">;</span>
	<span class="w">msleep_interruptible</span><span class="c">(</span><span class="w">duration</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ua</span><span class="pc">rt-</span><span class="c">&gt;</span><span class="pc">u</span><span class="c">tx.</span><span class="w">w</span> <span class="w">&amp;</span><span class="c">= ~UTX_SEND_BREAK;</span>
<span class="c">#endif</span>		
        <span class="w">local_irq_restore</span><span class="c">(</span><span class="pc">f</span><span class="c">lags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rs_ioctl</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty,</span>
		    <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="pc">c</span><span class="c">md,</span> <span class="c">unsigned</span> <span class="c">long</span> <span class="c">arg)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span> <span class="w">i</span><span class="pc">n</span><span class="c">fo</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="w">t</span><span class="pc">t</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;name, "</span><span class="w">rs_ioctl"</span><span class="pc">))</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>

	<span class="c">if</span> <span class="pc">((</span><span class="w">c</span><span class="c">md</span> <span class="w">!</span><span class="c">=</span> <span class="w">TIOCGSERIAL</span><span class="pc">)</span><span class="c"> &amp;&amp; (</span><span class="w">c</span><span class="c">md</span> <span class="pc">!</span><span class="c">=</span> <span class="w">TIOCSSERIAL</span><span class="pc">) </span><span class="c">&amp;&amp;</span>
	    <span class="c">(</span><span class="pc">c</span><span class="c">md</span> <span class="pc">!</span><span class="c">=</span> <span class="w">TIOCSERCONFIG) &amp;</span><span class="pc">&amp; </span><span class="c">(cmd</span> <span class="pc">!</span><span class="c">=</span> <span class="w">TIOCSERGWILD)  &amp;&amp;</span>
	    <span class="pc">(</span><span class="c">cmd</span> <span class="w">!</span><span class="c">=</span> <span class="w">TIOCSERSWILD) &amp;</span><span class="pc">&amp; </span><span class="c">(cmd</span> <span class="pc">!</span><span class="c">=</span> <span class="w">TIOCSERGSTRUCT</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">tt</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="pc">&amp; </span><span class="c">(</span><span class="pc">1</span> <span class="c">&lt;&lt;</span> <span class="w">TTY_IO_ERROR</span><span class="c">))</span>
		    <span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="pc">E</span><span class="c">IO;</span>
	<span class="pc">}</span>
	
	<span class="w">s</span><span class="c">witch</span> <span class="c">(cmd) {</span>
		<span class="c">case</span> <span class="w">TCSBRK</span><span class="c">:</span>	
			<span class="w">re</span><span class="pc">tv</span><span class="c">al</span> <span class="c">=</span> <span class="w">tty_check_change</span><span class="c">(</span><span class="w">t</span><span class="c">ty</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">etval</span><span class="pc">)</span>
				<span class="c">return</span> <span class="c">retval;</span>
			<span class="w">tty_wait_until_sent</span><span class="c">(</span><span class="w">t</span><span class="pc">ty</span><span class="c">,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">a</span><span class="c">rg)</span>
				<span class="w">send_break</span><span class="c">(</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">,</span> <span class="w">250</span><span class="c">);</span>	
			<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">ase</span> <span class="w">TCSBRKP</span><span class="c">:</span>	
			<span class="w">r</span><span class="pc">etv</span><span class="c">al</span> <span class="c">=</span> <span class="w">t</span><span class="pc">ty_c</span><span class="c">heck_change(</span><span class="w">t</span><span class="pc">ty)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(retval)</span>
				<span class="c">return</span> <span class="c">retval;</span>
			<span class="w">t</span><span class="pc">ty_w</span><span class="c">ait_until_sent</span><span class="pc">(</span><span class="w">t</span><span class="pc">ty</span><span class="c">,</span> <span class="w">0</span><span class="c">);</span>
			<span class="w">s</span><span class="pc">e</span><span class="c">nd_break(</span><span class="w">inf</span><span class="c">o</span><span class="pc">,</span> <span class="w">a</span><span class="c">rg</span> <span class="w">?</span> <span class="w">a</span><span class="c">rg</span><span class="w">*(10</span><span class="pc">0</span><span class="w">) </span><span class="pc">:</span> <span class="w">25</span><span class="pc">0)</span><span class="c">;</span>
			<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">ase</span> <span class="w">TIOCGSERIAL</span><span class="c">:</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">get_serial_info</span><span class="pc">(</span><span class="w">inf</span><span class="c">o,</span>
				       <span class="w">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">serial_struct</span> <span class="pc">*)</span> <span class="w">a</span><span class="pc">r</span><span class="c">g);</span>
		<span class="w">c</span><span class="c">ase</span> <span class="w">TIOCSSERIAL</span><span class="c">:</span>
			<span class="c">return</span> <span class="w">set_serial_info</span><span class="c">(</span><span class="w">i</span><span class="c">nfo,</span> <span class="w">tt</span><span class="c">y,</span>
					       <span class="w">(s</span><span class="c">truct</span> <span class="c">serial_struct</span> <span class="pc">*)</span> <span class="w">a</span><span class="c">rg</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">c</span><span class="c">ase</span> <span class="w">TIOCSERGETLSR</span><span class="c">:</span> 
			<span class="c">return</span> <span class="w">get_lsr_info</span><span class="c">(</span><span class="pc">i</span><span class="c">nfo</span><span class="w">,</span><span class="pc"> (u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">*</span><span class="pc">)</span> <span class="c">arg);</span>
		<span class="w">c</span><span class="c">ase</span> <span class="w">TIOCSERGSTRUCT</span><span class="c">:</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">opy_to_user</span><span class="pc">((</span><span class="w">s</span><span class="c">truct</span> <span class="w">m68k_serial</span> <span class="c">*)</span> <span class="c">arg</span><span class="pc">,</span>
				    <span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">,</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="pc">m</span><span class="c">68k_serial</span><span class="pc">)))</span>
				<span class="c">return</span> <span class="c">-EFAULT;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">d</span><span class="c">efault:</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">ENOIOCTLCMD</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rs_set_termios</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty,</span> <span class="c">struct</span> <span class="w">ktermios</span> <span class="c">*</span><span class="w">old_termios</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>

	<span class="w">change_speed</span><span class="c">(</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">,</span> <span class="w">t</span><span class="pc">t</span><span class="c">y);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="c">old_termios-&gt;</span><span class="w">c_cflag</span> <span class="c">&amp;</span> <span class="w">CRTSCTS</span><span class="pc">) </span><span class="c">&amp;&amp;</span>
	    <span class="w">!</span><span class="pc">(</span><span class="w">t</span><span class="pc">t</span><span class="c">y-&gt;</span><span class="w">te</span><span class="c">rmios</span><span class="pc">.c</span><span class="c">_cflag</span> <span class="w">&amp;</span> <span class="pc">C</span><span class="c">RTSCTS))</span>
		<span class="w">rs_start</span><span class="c">(</span><span class="w">t</span><span class="c">ty);</span>
	
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">rs_close</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty</span><span class="pc">,</span> <span class="c">struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*</span> <span class="pc">filp</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span> <span class="w">i</span><span class="pc">nf</span><span class="c">o</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="w">t</span><span class="c">ty</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">dr</span><span class="c">iver_data;</span>
	<span class="c">struct</span> <span class="w">tty_port</span> <span class="c">*</span><span class="w">p</span><span class="pc">o</span><span class="c">rt</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">tport</span><span class="c">;</span>
	<span class="w">m68328_uart</span> <span class="pc">*</span><span class="w">ua</span><span class="c">rt</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">uart_addr[i</span><span class="pc">nf</span><span class="c">o-&gt;</span><span class="w">li</span><span class="pc">ne</span><span class="c">];</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(info</span><span class="pc">,</span> <span class="w">tt</span><span class="pc">y-</span><span class="c">&gt;name</span><span class="w">,</span><span class="pc"> "</span><span class="w">rs_close"</span><span class="pc">))</span>
		<span class="c">return</span><span class="pc">;</span>
	
	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">tty_hung_up_p</span><span class="c">(</span><span class="w">fil</span><span class="pc">p)) </span><span class="c">{</span>
		<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>
		<span class="c">return</span><span class="pc">;</span>
	<span class="c">}</span>
	
	<span class="c">if</span> <span class="pc">((</span><span class="w">tt</span><span class="pc">y</span><span class="c">-&gt;</span><span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">1</span><span class="w">)</span><span class="pc"> &amp;&amp; </span><span class="c">(</span><span class="w">p</span><span class="c">ort-&gt;</span><span class="w">c</span><span class="c">ount</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">1)) </span><span class="c">{</span>
		
		<span class="c">printk</span><span class="pc">("</span><span class="w">r</span><span class="c">s_close:</span> <span class="w">b</span><span class="c">ad</span> <span class="w">se</span><span class="pc">r</span><span class="c">ial</span> <span class="w">p</span><span class="c">ort</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="w">;</span> <span class="w">tt</span><span class="pc">y</span><span class="c">-&gt;</span><span class="w">c</span><span class="c">ount</span> <span class="w">i</span><span class="c">s</span> <span class="w">1</span><span class="pc">, </span><span class="c">"</span>
		       <span class="pc">"</span><span class="w">p</span><span class="c">ort</span><span class="w">-</span><span class="pc">&gt;c</span><span class="c">ount</span> <span class="w">i</span><span class="pc">s</span> <span class="pc">%</span><span class="c">d\n",</span> <span class="pc">p</span><span class="c">ort-&gt;</span><span class="w">c</span><span class="pc">o</span><span class="c">unt);</span>
		<span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;</span><span class="pc">c</span><span class="c">ount</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="w">(-</span><span class="c">-port-&gt;</span><span class="w">c</span><span class="c">ount</span> <span class="pc">&lt;</span> <span class="pc">0</span><span class="c">) {</span>
		<span class="c">printk</span><span class="pc">("</span><span class="w">rs_close</span><span class="c">:</span> <span class="w">b</span><span class="pc">a</span><span class="c">d</span> <span class="w">s</span><span class="pc">e</span><span class="c">rial</span> <span class="pc">p</span><span class="c">ort</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="w">f</span><span class="c">or</span> <span class="w">ttyS</span><span class="pc">%</span><span class="c">d</span><span class="w">:</span><span class="pc"> </span><span class="c">%d\n",</span>
		       <span class="w">inf</span><span class="c">o-&gt;</span><span class="w">l</span><span class="pc">i</span><span class="c">ne,</span> <span class="c">port-&gt;</span><span class="w">c</span><span class="c">ount</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;</span><span class="pc">c</span><span class="c">ount</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(port-&gt;</span><span class="w">c</span><span class="pc">o</span><span class="c">unt) {</span>
		<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="w">p</span><span class="c">ort-&gt;</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">ASYNC_CLOSING</span><span class="c">;</span>
	
	<span class="w">t</span><span class="pc">t</span><span class="c">y-&gt;</span><span class="w">closing</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(port-&gt;</span><span class="w">closing_wait</span> <span class="pc">!</span><span class="c">=</span> <span class="w">ASYNC_CLOSING_WAIT_NONE</span><span class="pc">)</span>
		<span class="w">tty_wait_until_sent</span><span class="c">(</span><span class="pc">t</span><span class="c">ty,</span> <span class="c">port</span><span class="pc">-</span><span class="c">&gt;closing_wait);</span>
	

	<span class="w">ua</span><span class="pc">rt</span><span class="c">-&gt;</span><span class="w">ustcnt</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">USTCNT_RXEN</span><span class="c">;</span>
	<span class="w">ua</span><span class="pc">rt</span><span class="c">-&gt;</span><span class="pc">u</span><span class="c">stcnt</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">U</span><span class="c">STCNT_RXEN</span> <span class="c">|</span> <span class="w">USTCNT_RX_INTR_MASK</span><span class="c">);</span>

	<span class="w">shutdown</span><span class="c">(</span><span class="w">inf</span><span class="c">o</span><span class="pc">,</span> <span class="w">t</span><span class="pc">ty</span><span class="c">);</span>
	<span class="w">rs_flush_buffer</span><span class="c">(</span><span class="w">t</span><span class="pc">ty)</span><span class="c">;</span>
		
	<span class="w">tty_ldisc_flush</span><span class="c">(tty);</span>
	<span class="w">t</span><span class="pc">ty</span><span class="c">-&gt;</span><span class="w">closing</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">tty_port_tty_set</span><span class="pc">(&amp;</span><span class="w">inf</span><span class="c">o-&gt;</span><span class="w">tport</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL);</span>
<span class="w">#warning</span> <span class="c">"</span><span class="w">This</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">h</span><span class="pc">as</span> <span class="w">never</span> <span class="w">been</span> <span class="w">va</span><span class="pc">li</span><span class="c">d</span> <span class="w">so</span> <span class="w">fi</span><span class="pc">x</span> <span class="w">it</span><span class="pc">"</span>	
<span class="w">#i</span><span class="pc">f</span> <span class="w">0</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">tt</span><span class="pc">y</span><span class="c">-&gt;</span><span class="w">ldisc.n</span><span class="pc">u</span><span class="c">m</span> <span class="w">!</span><span class="c">=</span> <span class="w">ldiscs[N_TTY</span><span class="pc">].</span><span class="w">n</span><span class="pc">u</span><span class="c">m) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">tt</span><span class="c">y-&gt;ldisc.</span><span class="w">cl</span><span class="pc">os</span><span class="c">e</span><span class="pc">)</span>
			<span class="w">(t</span><span class="pc">t</span><span class="c">y-&gt;ldisc</span><span class="pc">.</span><span class="w">clo</span><span class="pc">s</span><span class="c">e</span><span class="w">)(t</span><span class="pc">t</span><span class="c">y</span><span class="w">);</span>
		<span class="w">t</span><span class="pc">t</span><span class="c">y-&gt;</span><span class="pc">l</span><span class="c">disc</span> <span class="c">=</span> <span class="w">l</span><span class="pc">discs</span><span class="w">[</span><span class="pc">N</span><span class="c">_TTY</span><span class="pc">];</span>
		<span class="w">t</span><span class="pc">t</span><span class="c">y-&gt;</span><span class="w">te</span><span class="c">rmios.</span><span class="w">c_line</span> <span class="c">=</span> <span class="c">N_TTY;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">t</span><span class="c">y-&gt;ldisc.</span><span class="w">o</span><span class="pc">pe</span><span class="c">n</span><span class="pc">)</span>
			<span class="w">(t</span><span class="c">ty-&gt;</span><span class="pc">l</span><span class="c">disc.</span><span class="w">o</span><span class="pc">pe</span><span class="c">n</span><span class="w">)(t</span><span class="c">ty</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span>	
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="c">ort</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">blocked_open</span><span class="c">) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="c">ort-&gt;</span><span class="w">close_delay</span><span class="pc">)</span>
			<span class="w">msleep_interruptible</span><span class="c">(</span><span class="w">jiffies_to_msecs</span><span class="pc">(</span><span class="c">port</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">lose_delay</span><span class="w">)</span><span class="pc">);</span>
		<span class="w">wake_up_interruptible</span><span class="pc">(&amp;</span><span class="c">port-&gt;</span><span class="w">open_wait</span><span class="c">);</span>
	<span class="c">}</span>
	<span class="w">p</span><span class="pc">o</span><span class="c">rt-&gt;</span><span class="pc">f</span><span class="c">lags</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">ASYNC_NORMAL_ACTIVE</span><span class="c">|</span><span class="w">ASYNC_CLOSING</span><span class="c">);</span>
	<span class="w">w</span><span class="pc">a</span><span class="c">ke_up_interruptible</span><span class="pc">(&amp;</span><span class="c">port-&gt;</span><span class="w">close_wait</span><span class="c">);</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="pc">f</span><span class="c">lags);</span>
<span class="c">}</span>


<span class="w">v</span><span class="c">oid</span> <span class="w">rs_hangup</span><span class="c">(struct</span> <span class="w">t</span><span class="c">ty_struct</span> <span class="c">*tty)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span> <span class="c">*</span> <span class="w">inf</span><span class="c">o</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">m68k_serial</span> <span class="c">*)</span><span class="pc">t</span><span class="c">ty-&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">,</span> <span class="w">t</span><span class="pc">t</span><span class="c">y-&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="w">r</span><span class="pc">s</span><span class="c">_hangup</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span><span class="pc">;</span>
	
	<span class="w">rs_flush_buffer</span><span class="c">(</span><span class="w">t</span><span class="pc">t</span><span class="c">y);</span>
	<span class="w">shutdown</span><span class="c">(</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="w">t</span><span class="c">ty);</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">tport</span><span class="pc">.</span><span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;tport.</span><span class="w">fl</span><span class="c">ags</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">ASYNC_NORMAL_ACTIVE</span><span class="c">;</span>
	<span class="w">tty_port_tty_set</span><span class="pc">(&amp;</span><span class="c">info-&gt;tport</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL);</span>
	<span class="w">wake_up_interruptible</span><span class="pc">(&amp;</span><span class="c">info-&gt;tport</span><span class="pc">.</span><span class="w">open_wait</span><span class="c">);</span>
<span class="pc">}</span>


<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">rs_open</span><span class="c">(struct</span> <span class="w">t</span><span class="pc">t</span><span class="c">y_struct</span> <span class="c">*tty,</span> <span class="c">struct</span> <span class="c">file</span> <span class="c">*</span> <span class="pc">filp)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">m68k_serial</span>	<span class="c">*</span><span class="w">i</span><span class="c">nfo</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al;</span>

	<span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">m68k_soft[t</span><span class="pc">t</span><span class="c">y-&gt;</span><span class="w">i</span><span class="pc">nd</span><span class="c">ex</span><span class="pc">]</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">serial_paranoia_check</span><span class="c">(</span><span class="w">i</span><span class="c">nfo</span><span class="pc">,</span> <span class="w">t</span><span class="pc">t</span><span class="c">y</span><span class="pc">-</span><span class="c">&gt;name</span><span class="pc">, "</span><span class="w">r</span><span class="c">s_open</span><span class="w">"</span><span class="pc">))</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>

	<span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">tport</span><span class="pc">.</span><span class="w">co</span><span class="pc">u</span><span class="c">nt</span><span class="pc">+</span><span class="c">+;</span>
	<span class="w">tt</span><span class="c">y-&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver_data</span> <span class="c">=</span> <span class="pc">i</span><span class="c">nfo</span><span class="pc">;</span>
	<span class="w">tty_port_tty_set</span><span class="pc">(&amp;</span><span class="c">info-&gt;tport</span><span class="pc">,</span> <span class="w">tt</span><span class="pc">y)</span><span class="c">;</span>

	
	<span class="w">r</span><span class="pc">etv</span><span class="c">al</span> <span class="c">=</span> <span class="w">startup</span><span class="c">(info,</span> <span class="w">tt</span><span class="pc">y)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(retval</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">retval;</span>

	<span class="pc">retu</span><span class="c">rn</span> <span class="w">tty_port_block_til_ready</span><span class="pc">(&amp;i</span><span class="c">nfo-&gt;</span><span class="pc">t</span><span class="c">port</span><span class="pc">,</span> <span class="w">tt</span><span class="pc">y</span><span class="c">,</span> <span class="w">fi</span><span class="pc">lp)</span><span class="c">;</span>
<span class="c">}</span>



<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">show_serial_version</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="w">p</span><span class="pc">ri</span><span class="c">ntk</span><span class="pc">("</span><span class="w">MC68328</span> <span class="w">s</span><span class="pc">e</span><span class="c">rial</span> <span class="pc">d</span><span class="c">river</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion</span> <span class="w">1.00</span><span class="c">\n");</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">tty_operations</span> <span class="w">rs_ops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">ope</span><span class="c">n</span> <span class="c">=</span> <span class="w">rs_open</span><span class="c">,</span>
	<span class="c">.</span><span class="w">c</span><span class="c">lose</span> <span class="c">=</span> <span class="w">rs_close</span><span class="c">,</span>
	<span class="c">.</span><span class="w">w</span><span class="c">rite</span> <span class="c">=</span> <span class="w">rs_write</span><span class="c">,</span>
	<span class="c">.</span><span class="w">flush_chars</span> <span class="c">=</span> <span class="w">rs_flush_chars</span><span class="c">,</span>
	<span class="c">.</span><span class="w">write_room</span> <span class="c">=</span> <span class="w">rs_write_room</span><span class="c">,</span>
	<span class="c">.</span><span class="w">chars_in_buffer</span> <span class="c">=</span> <span class="w">rs_chars_in_buffer</span><span class="c">,</span>
	<span class="c">.</span><span class="w">flush_buffer</span> <span class="c">=</span> <span class="w">rs_flush_buffer</span><span class="c">,</span>
	<span class="c">.</span><span class="w">i</span><span class="c">octl</span> <span class="c">=</span> <span class="w">rs_ioctl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">throttle</span> <span class="c">=</span> <span class="w">rs_throttle</span><span class="c">,</span>
	<span class="c">.</span><span class="w">unthrottle</span> <span class="c">=</span> <span class="w">rs_unthrottle</span><span class="c">,</span>
	<span class="c">.</span><span class="w">set_termios</span> <span class="c">=</span> <span class="w">rs_set_termios</span><span class="c">,</span>
	<span class="c">.</span><span class="w">s</span><span class="pc">t</span><span class="c">op</span> <span class="c">=</span> <span class="w">rs_stop</span><span class="c">,</span>
	<span class="c">.</span><span class="w">s</span><span class="pc">ta</span><span class="c">rt</span> <span class="c">=</span> <span class="w">rs_start</span><span class="c">,</span>
	<span class="c">.</span><span class="w">hangup</span> <span class="c">=</span> <span class="w">rs_hangup</span><span class="c">,</span>
	<span class="c">.</span><span class="w">set_ldisc</span> <span class="c">=</span> <span class="w">rs_set_ldisc</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">tty_port_operations</span> <span class="w">rs_port_ops</span> <span class="c">= {</span>
<span class="pc">}</span><span class="c">;</span>


<span class="c">static</span> <span class="c">int</span> <span class="c">__init</span>
<span class="w">rs68328_init</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">i</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">m68k_serial</span> <span class="c">*</span><span class="w">i</span><span class="c">nfo;</span>

	<span class="w">serial_driver</span> <span class="pc">=</span> <span class="w">alloc_tty_driver</span><span class="c">(</span><span class="w">NR_PORTS</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">serial_driver)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>

	<span class="w">show_serial_version</span><span class="pc">()</span><span class="c">;</span>

	
	
	
	<span class="pc">s</span><span class="c">erial_driver</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span> <span class="pc">= </span><span class="c">"</span><span class="w">ttyS</span><span class="pc">"</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">erial_driver-&gt;</span><span class="w">maj</span><span class="c">or</span> <span class="c">=</span> <span class="w">TTY_MAJOR</span><span class="c">;</span>
	<span class="c">serial_driver-&gt;</span><span class="w">minor_start</span> <span class="c">=</span> <span class="w">6</span><span class="c">4;</span>
	<span class="c">serial_driver-&gt;</span><span class="pc">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">TTY_DRIVER_TYPE_SERIAL</span><span class="c">;</span>
	<span class="c">serial_driver-&gt;</span><span class="w">subtype</span> <span class="c">=</span> <span class="w">SERIAL_TYPE_NORMAL</span><span class="c">;</span>
	<span class="c">serial_driver-&gt;</span><span class="w">init_termios</span> <span class="c">=</span> <span class="w">tty_std_termios</span><span class="c">;</span>
	<span class="c">serial_driver-&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">it_termios</span><span class="pc">.</span><span class="w">c_cflag</span> <span class="c">=</span> 
			<span class="w">m68328_console_cbaud</span> <span class="pc">|</span> <span class="w">CS8</span> <span class="pc">|</span> <span class="w">CREAD</span> <span class="pc">|</span> <span class="w">HUPCL</span> <span class="c">|</span> <span class="w">CLOCAL</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">erial_driver-&gt;</span><span class="pc">f</span><span class="c">lags</span> <span class="pc">=</span> <span class="w">TTY_DRIVER_REAL_RAW</span><span class="c">;</span>
	<span class="w">tty_set_operations</span><span class="c">(serial_driver</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">rs_ops</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">local_irq_save</span><span class="c">(</span><span class="pc">f</span><span class="c">lags);</span>

	<span class="w">f</span><span class="c">or(i=0;i&lt;</span><span class="w">NR_PORTS</span><span class="c">;i++) {</span>

	    <span class="w">i</span><span class="pc">nf</span><span class="c">o</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">m68k_soft</span><span class="c">[i];</span>
	    <span class="w">tty_port_init</span><span class="pc">(&amp;i</span><span class="c">nfo-&gt;</span><span class="w">tport</span><span class="pc">)</span><span class="c">;</span>
	    <span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;tport</span><span class="pc">.</span><span class="w">o</span><span class="pc">p</span><span class="c">s</span> <span class="c">= &amp;</span><span class="w">rs_port_ops</span><span class="c">;</span>
	    <span class="c">info-&gt;</span><span class="w">ma</span><span class="pc">g</span><span class="c">ic</span> <span class="c">=</span> <span class="w">SERIAL_MAGIC</span><span class="c">;</span>
	    <span class="c">info-&gt;</span><span class="w">por</span><span class="pc">t</span> <span class="w">=</span><span class="pc"> (</span><span class="w">i</span><span class="pc">nt</span><span class="w">) &amp;uart_addr[</span><span class="pc">i</span><span class="c">];</span>
	    <span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">i</span><span class="pc">r</span><span class="c">q</span> <span class="c">=</span> <span class="w">uart_irqs</span><span class="pc">[i</span><span class="c">];</span>
	    <span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">custom_divisor</span> <span class="c">=</span> <span class="w">1</span><span class="pc">6</span><span class="c">;</span>
	    <span class="c">info-&gt;</span><span class="w">x_char</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	    <span class="c">info-&gt;</span><span class="w">li</span><span class="pc">ne</span> <span class="c">=</span> <span class="w">i</span><span class="c">;</span>
	    <span class="c">info-&gt;</span><span class="w">is_cons</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span> 
	    
	    <span class="w">pr</span><span class="pc">in</span><span class="c">tk</span><span class="pc">("%</span><span class="c">s</span><span class="pc">%d</span> <span class="w">a</span><span class="c">t</span> <span class="c">0x%</span><span class="pc">0</span><span class="c">8x</span> <span class="w">(i</span><span class="pc">r</span><span class="c">q</span> <span class="pc">= </span><span class="c">%d</span><span class="pc">)"</span><span class="c">,</span> <span class="w">serial_driver-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">ame,</span> <span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">l</span><span class="pc">i</span><span class="c">ne,</span> 
		   <span class="pc">in</span><span class="c">fo-&gt;</span><span class="w">po</span><span class="pc">rt</span><span class="c">,</span> <span class="c">info-&gt;</span><span class="w">i</span><span class="pc">r</span><span class="c">q</span><span class="pc">)</span><span class="c">;</span>
	    <span class="w">p</span><span class="pc">ri</span><span class="c">ntk</span><span class="pc">("</span> <span class="w">is</span> <span class="w">a</span> <span class="w">builtin</span> <span class="w">MC68328</span> <span class="w">UART</span><span class="c">\n");</span>
	    
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_M68VZ328</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span> <span class="w">&gt;</span> <span class="c">0</span> <span class="c">)</span>
			<span class="w">PJSEL</span> <span class="w">&amp;=</span> <span class="w">0xCF</span><span class="c">;</span>  
<span class="pc">#</span><span class="c">endif</span>

	    <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">req</span><span class="c">uest_irq(</span><span class="w">uart_irqs[</span><span class="c">i</span><span class="w">],</span>
			    <span class="w">rs_interrupt</span><span class="c">,</span>
			    <span class="c">0,</span>
			    <span class="pc">"</span><span class="w">M68328_UART</span><span class="c">",</span> <span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="w">)</span><span class="pc">)</span>
                <span class="w">panic</span><span class="pc">("</span><span class="w">U</span><span class="pc">n</span><span class="c">able</span> <span class="c">to</span> <span class="w">attach</span> <span class="w">68328</span> <span class="w">se</span><span class="pc">r</span><span class="c">ial</span> <span class="w">int</span><span class="pc">err</span><span class="c">upt</span><span class="pc">\</span><span class="c">n</span><span class="pc">")</span><span class="c">;</span>

	    <span class="w">tty_port_link_device(</span><span class="pc">&amp;</span><span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">tport</span><span class="c">,</span> <span class="w">serial_driver</span><span class="pc">,</span> <span class="w">i</span><span class="c">);</span>
	<span class="pc">}</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">tty_register_driver</span><span class="c">(</span><span class="pc">se</span><span class="c">rial_driver</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">put_tty_driver</span><span class="c">(serial_driver);</span>
		<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">NR_PORTS</span><span class="c">;</span> <span class="c">i</span><span class="pc">++)</span>
			<span class="w">tty_port_destroy</span><span class="pc">(&amp;</span><span class="w">m68k_soft</span><span class="c">[i</span><span class="pc">].</span><span class="w">t</span><span class="pc">p</span><span class="c">ort);</span>
		<span class="w">p</span><span class="pc">r</span><span class="c">intk(</span><span class="pc">KERN_E</span><span class="c">RR</span> <span class="c">"</span><span class="w">Couldn'</span><span class="c">t</span> <span class="pc">r</span><span class="c">egister</span> <span class="w">se</span><span class="pc">rial</span> <span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="pc">\</span><span class="c">n");</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">m</span><span class="c">odule_init(</span><span class="w">rs68328_init</span><span class="c">);</span>



<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">m68328_set_baud</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">s</span><span class="c">hort</span> <span class="w">ustcnt</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span>	<span class="c">i;</span>

	<span class="w">u</span><span class="pc">s</span><span class="c">tcnt</span> <span class="c">=</span> <span class="w">USTCNT</span><span class="pc">;</span>
	<span class="w">U</span><span class="c">STCNT</span> <span class="c">=</span> <span class="pc">u</span><span class="c">stcnt</span> <span class="w">&amp;</span><span class="pc"> ~</span><span class="w">USTCNT_TXEN</span><span class="c">;</span>

<span class="w">again:</span>
	<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">A</span><span class="c">RRAY_SIZE(</span><span class="w">baud_table</span><span class="c">);</span> <span class="c">i</span><span class="pc">++)</span>
		<span class="c">if</span> <span class="c">(baud_table[i</span><span class="pc">] =</span><span class="c">=</span> <span class="w">m68328_console_baud</span><span class="pc">)</span>
			<span class="pc">br</span><span class="c">eak;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="pc">&gt;</span><span class="c">=</span> <span class="pc">A</span><span class="c">RRAY_SIZE(</span><span class="pc">b</span><span class="c">aud_table</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">m</span><span class="c">68328_console_baud</span> <span class="pc">=</span> <span class="w">9600</span><span class="pc">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">a</span><span class="c">gain;</span>
	<span class="c">}</span>

	<span class="w">UBAUD</span> <span class="c">=</span> <span class="w">PUT_FIELD</span><span class="c">(</span><span class="w">UBAUD_DIVIDE</span><span class="c">,</span>    <span class="w">hw_baud_table</span><span class="pc">[</span><span class="c">i</span><span class="pc">].</span><span class="w">divisor) </span><span class="pc">|</span> 
		<span class="pc">P</span><span class="c">UT_FIELD</span><span class="pc">(</span><span class="w">UBAUD_PRESCALER</span><span class="c">,</span> <span class="c">hw_baud_table</span><span class="pc">[</span><span class="c">i].</span><span class="w">prescale</span><span class="c">);</span>
	<span class="w">ustcnt</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">USTCNT_PARITYEN</span> <span class="pc">|</span> <span class="w">USTCNT_ODD_EVEN</span> <span class="pc">|</span> <span class="w">USTCNT_STOP</span> <span class="pc">|</span> <span class="w">USTCNT_8_7</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="c">stcnt</span> <span class="pc">|</span><span class="c">=</span> <span class="w">U</span><span class="pc">STCNT_8</span><span class="c">_7;</span>
	<span class="pc">u</span><span class="c">stcnt</span> <span class="pc">|</span><span class="c">=</span> <span class="w">USTCNT_TXEN</span><span class="c">;</span>
	<span class="w">USTCNT</span> <span class="pc">=</span> <span class="c">ustcnt</span><span class="pc">;</span>
	<span class="w">m68328_console_initted</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="w">r</span><span class="c">eturn</span><span class="pc">;</span>
<span class="c">}</span>


<span class="w">i</span><span class="pc">nt</span> <span class="w">m68328_console_setup</span><span class="c">(struct</span> <span class="w">console</span> <span class="c">*</span><span class="w">cp</span><span class="c">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">a</span><span class="pc">r</span><span class="c">g</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span>		<span class="c">i</span><span class="pc">,</span> <span class="w">n</span> <span class="pc">=</span> <span class="w">CONSOLE_BAUD_RATE</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">cp</span><span class="c">)</span>
		<span class="c">return</span><span class="w">(</span><span class="pc">-1</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">a</span><span class="c">rg</span><span class="pc">)</span>
		<span class="w">n</span> <span class="c">=</span> <span class="w">simple_strtoul</span><span class="c">(</span><span class="w">a</span><span class="c">rg</span><span class="pc">,</span><span class="w">N</span><span class="c">ULL</span><span class="pc">,0)</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">A</span><span class="c">RRAY_SIZE(</span><span class="w">baud_table</span><span class="c">);</span> <span class="c">i</span><span class="pc">++)</span>
		<span class="c">if</span> <span class="c">(baud_table[i</span><span class="pc">] =</span><span class="c">=</span> <span class="w">n</span><span class="c">)</span>
			<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="pc">&lt;</span> <span class="pc">A</span><span class="c">RRAY_SIZE(</span><span class="pc">b</span><span class="c">aud_table</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">m68328_console_baud</span> <span class="pc">=</span> <span class="w">n</span><span class="c">;</span>
		<span class="w">m68328_console_cbaud</span> <span class="pc">=</span> <span class="c">0;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="pc">&gt;</span> <span class="w">15</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">m</span><span class="pc">68328_console_c</span><span class="c">baud</span> <span class="w">|</span><span class="c">=</span> <span class="w">CBAUDEX</span><span class="c">;</span>
			<span class="w">i</span> <span class="pc">-</span><span class="c">=</span> <span class="w">15</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">m</span><span class="pc">68328_console_c</span><span class="c">baud</span> <span class="pc">|</span><span class="c">=</span> <span class="w">i</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">m68328_set_baud(</span><span class="pc">)</span><span class="c">;</span> 
	<span class="pc">r</span><span class="c">eturn</span><span class="w">(</span><span class="pc">0</span><span class="c">);</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">tty_driver</span> <span class="c">*</span><span class="w">m68328_console_device</span><span class="c">(struct</span> <span class="w">console</span> <span class="c">*</span><span class="w">c</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">dex)</span>
<span class="c">{</span>
	<span class="w">*i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">=</span> <span class="w">c</span><span class="c">-&gt;</span><span class="pc">i</span><span class="c">ndex;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">serial_driver</span><span class="pc">;</span>
<span class="c">}</span>


<span class="pc">v</span><span class="c">oid</span> <span class="w">m68328_console_write</span> <span class="c">(struct</span> <span class="pc">c</span><span class="c">onsole</span> <span class="c">*</span><span class="w">co</span><span class="c">,</span> <span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">s</span><span class="c">tr,</span>
			   <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">c</span><span class="c">ount</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">m68328_console_initted</span><span class="pc">)</span>
		<span class="w">m68328_set_baud</span><span class="pc">()</span><span class="c">;</span>
    <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="pc">c</span><span class="c">ount</span><span class="w">-</span><span class="c">-) {</span>
        <span class="c">if</span> <span class="pc">(*</span><span class="w">str</span> <span class="w">== '\n')</span>
           <span class="w">rs_put_char('\r');</span>
        <span class="w">r</span><span class="c">s_put_char</span><span class="w">( *st</span><span class="pc">r</span><span class="w">++ );</span>
    <span class="pc">}</span>
<span class="pc">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">console</span> <span class="w">m68328_driver</span> <span class="c">= {</span>
	<span class="c">.name</span>		<span class="c">= "</span><span class="w">ttyS</span><span class="c">",</span>
	<span class="c">.</span><span class="w">w</span><span class="c">rite</span>		<span class="c">=</span> <span class="w">m68328_console_write</span><span class="c">,</span>
	<span class="c">.</span><span class="w">dev</span><span class="pc">i</span><span class="c">ce</span>		<span class="c">=</span> <span class="w">m68328_console_device</span><span class="c">,</span>
	<span class="c">.</span><span class="w">se</span><span class="pc">tu</span><span class="c">p</span>		<span class="c">=</span> <span class="w">m68328_console_setup</span><span class="c">,</span>
	<span class="c">.</span><span class="w">f</span><span class="c">lags</span>		<span class="c">=</span> <span class="w">CON_PRINTBUFFER</span><span class="c">,</span>
	<span class="c">.</span><span class="w">ind</span><span class="c">ex</span>		<span class="pc">= -</span><span class="c">1,</span>
<span class="pc">}</span><span class="c">;</span>


<span class="c">static</span> <span class="c">int</span> <span class="c">__init</span> <span class="w">m68328_console_init</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="w">register_console</span><span class="c">(&amp;</span><span class="w">m68328_driver</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">console_initcall</span><span class="c">(</span><span class="pc">m68328_c</span><span class="c">onsole_init</span><span class="pc">)</span><span class="c">;</span>

</pre>
</body>
</html>

