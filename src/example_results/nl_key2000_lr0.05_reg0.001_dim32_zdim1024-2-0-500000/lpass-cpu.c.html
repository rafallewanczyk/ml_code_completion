<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/clk.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/of.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">of_device</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">p</span><span class="c">latform_device.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">pc</span><span class="pc">m</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">pcm_params</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">l</span><span class="c">inux/</span><span class="w">r</span><span class="pc">egm</span><span class="c">ap.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">so</span><span class="pc">c</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">so</span><span class="c">und/</span><span class="w">so</span><span class="pc">c-</span><span class="w">da</span><span class="pc">i</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="pc">"</span><span class="w">lpass</span><span class="pc">-</span><span class="w">lpaif</span><span class="pc">-</span><span class="w">r</span><span class="c">eg.h</span><span class="pc">"</span>
<span class="c">#include</span> <span class="c">"</span><span class="pc">lpas</span><span class="c">s</span><span class="pc">.</span><span class="c">h"</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">lpass_cpu_daiops_set_sysclk</span><span class="c">(struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">clk_id</span><span class="c">,</span>
		<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">f</span><span class="c">req,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">d</span><span class="pc">ir)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">mi2s_osr_clk[da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver</span><span class="c">-&gt;</span><span class="w">i</span><span class="pc">d</span><span class="w">]))</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">clk_set_rate</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="pc">m</span><span class="c">i2s_osr_clk</span><span class="pc">[</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">d</span><span class="w">]</span><span class="c">,</span> <span class="w">fr</span><span class="pc">e</span><span class="c">q);</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="pc">e</span><span class="c">rror</span> <span class="w">s</span><span class="c">etting</span> <span class="w">mi2s</span> <span class="w">osrclk</span> <span class="w">t</span><span class="pc">o</span> <span class="c">%</span><span class="w">u:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="w">fr</span><span class="c">eq</span><span class="pc">,</span> <span class="c">ret);</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">lpass_cpu_daiops_startup</span><span class="c">(struct</span> <span class="w">sn</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="pc">su</span><span class="c">bstream,</span>
		<span class="c">struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">vd</span><span class="c">ata</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="w">mi2s_osr_clk[da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="c">iver-&gt;</span><span class="w">i</span><span class="pc">d</span><span class="w">])) {</span>
		<span class="pc">ret</span> <span class="pc">=</span> <span class="w">clk_prepare_enable</span><span class="c">(</span>
				<span class="w">d</span><span class="pc">r</span><span class="c">vdata</span><span class="pc">-</span><span class="c">&gt;mi2s_osr_clk</span><span class="pc">[</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">i</span><span class="c">ver</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">d</span><span class="w">]</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">dev_err</span><span class="pc">(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="pc">e</span><span class="c">rror</span> <span class="w">i</span><span class="c">n</span> <span class="w">enabling</span> <span class="w">mi2s</span> <span class="w">osr</span> <span class="w">clk</span><span class="pc">:</span><span class="c"> %d\n",</span>
					<span class="c">__func__</span><span class="pc">,</span> <span class="c">ret);</span>
			<span class="c">return</span> <span class="c">ret;</span>
		<span class="c">}</span>
	<span class="w">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">clk_prepare_enable</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">mi2s_bit_clk[da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="w">i</span><span class="c">d</span><span class="w">]</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(ret) {</span>
		<span class="c">dev_err(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="pc">(</span><span class="c">)</span> <span class="pc">e</span><span class="c">rror</span> <span class="w">i</span><span class="pc">n</span> <span class="w">enabling</span> <span class="w">mi2s</span> <span class="w">bi</span><span class="c">t</span> <span class="w">clk</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="c">ret);</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">I</span><span class="c">S_ERR(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">mi2s_osr_clk[da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="c">d</span><span class="w">]))</span>
			<span class="w">clk_disable_unprepare</span><span class="c">(</span>
				<span class="w">d</span><span class="c">rvdata-&gt;mi2s_osr_clk</span><span class="pc">[</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver</span><span class="c">-&gt;</span><span class="pc">i</span><span class="c">d</span><span class="w">]</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">lpass_cpu_daiops_shutdown</span><span class="c">(struct</span> <span class="w">sn</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="pc">subs</span><span class="c">tream</span><span class="pc">,</span>
		<span class="c">struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>

	<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="pc">d</span><span class="c">rvdata</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mi2s_bit_clk</span><span class="pc">[</span><span class="w">da</span><span class="pc">i-</span><span class="c">&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">d</span><span class="w">]</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!I</span><span class="c">S_ERR(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">mi2s_osr_clk[da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver-&gt;</span><span class="pc">i</span><span class="c">d</span><span class="w">]))</span>
		<span class="w">c</span><span class="pc">lk</span><span class="c">_disable_unprepare</span><span class="pc">(d</span><span class="c">rvdata-&gt;</span><span class="pc">mi2s_o</span><span class="c">sr_clk</span><span class="pc">[</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver</span><span class="c">-&gt;</span><span class="pc">id</span><span class="w">]</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">lpass_cpu_daiops_hw_params</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*substream</span><span class="pc">,</span>
		<span class="c">struct</span> <span class="w">snd_pcm_hw_params</span> <span class="c">*</span><span class="w">pa</span><span class="c">rams</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">vd</span><span class="c">ata</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>
	<span class="w">snd_pcm_format_t</span> <span class="w">fo</span><span class="pc">rm</span><span class="c">at</span> <span class="c">=</span> <span class="w">params_format</span><span class="c">(</span><span class="w">pa</span><span class="pc">rams)</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ch</span><span class="pc">annels</span> <span class="pc">=</span> <span class="w">params_channels</span><span class="c">(</span><span class="w">pa</span><span class="pc">rams</span><span class="c">);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ra</span><span class="c">te</span> <span class="pc">=</span> <span class="w">params_rate</span><span class="c">(</span><span class="w">p</span><span class="pc">arams</span><span class="c">);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">reg</span><span class="pc">v</span><span class="c">al;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">bitwidth</span><span class="pc">,</span> <span class="w">r</span><span class="c">et;</span>

	<span class="w">b</span><span class="pc">i</span><span class="c">twidth</span> <span class="c">=</span> <span class="w">snd_pcm_format_width</span><span class="c">(</span><span class="w">fo</span><span class="c">rmat</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">b</span><span class="c">itwidth</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="pc">i</span><span class="c">nvalid</span> <span class="w">b</span><span class="pc">it</span> <span class="w">w</span><span class="pc">id</span><span class="c">th</span> <span class="w">given</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="w">b</span><span class="c">itwidth);</span>
		<span class="c">return</span> <span class="w">b</span><span class="c">itwidth</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="c">=</span> <span class="w">LPAIF_I2SCTL_LOOPBACK_DISABLE</span> <span class="pc">|</span>
			<span class="w">LPAIF_I2SCTL_WSSRC_INTERNAL</span><span class="c">;</span>

	<span class="w">s</span><span class="c">witch</span> <span class="c">(bitwidth) {</span>
	<span class="c">case</span> <span class="w">1</span><span class="pc">6</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_BITWIDTH_16</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">2</span><span class="pc">4</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_BITWIDTH_24</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">3</span><span class="pc">2</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="c">|=</span> <span class="w">LPAIF_I2SCTL_BITWIDTH_32</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">d</span><span class="c">ev_err(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="pc">i</span><span class="c">nvalid</span> <span class="w">b</span><span class="c">itwidth</span> <span class="w">given</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="w">b</span><span class="pc">i</span><span class="c">twidth);</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">chan</span><span class="pc">nels</span><span class="c">) {</span>
	<span class="c">case</span> <span class="pc">1</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_SPKMODE_SD0</span><span class="c">;</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_SPKMONO_MONO</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">2</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">L</span><span class="c">PAIF_I2SCTL_SPKMODE_SD0;</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="c">|=</span> <span class="w">LPAIF_I2SCTL_SPKMONO_STEREO</span><span class="c">;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">4</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_SPKMODE_QUAD01</span><span class="c">;</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="c">|=</span> <span class="pc">L</span><span class="c">PAIF_I2SCTL_SPKMONO_STEREO;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">6</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="pc">|</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_SPKMODE_6CH</span><span class="c">;</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="c">|=</span> <span class="pc">L</span><span class="c">PAIF_I2SCTL_SPKMONO_STEREO;</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">8</span><span class="c">:</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="c">|=</span> <span class="w">LPAIF_I2SCTL_SPKMODE_8CH</span><span class="c">;</span>
		<span class="w">reg</span><span class="pc">v</span><span class="c">al</span> <span class="c">|=</span> <span class="pc">L</span><span class="c">PAIF_I2SCTL_SPKMONO_STEREO;</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="c">dev_err(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="pc">i</span><span class="c">nvalid</span> <span class="w">cha</span><span class="pc">nnels</span> <span class="w">given:</span><span class="c"> %</span><span class="pc">u</span><span class="c">\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="w">chan</span><span class="pc">nels</span><span class="c">);</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">regmap_write</span><span class="c">(</span><span class="w">d</span><span class="pc">rv</span><span class="c">data</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">lpaif_map</span><span class="c">,</span>
			   <span class="w">LPAIF_I2SCTL_REG</span><span class="pc">(dr</span><span class="c">vdata-&gt;</span><span class="w">variant</span><span class="c">,</span> <span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="w">i</span><span class="c">d</span><span class="pc">)</span><span class="c">,</span>
			   <span class="w">regv</span><span class="c">al);</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="pc">e</span><span class="c">rror</span> <span class="w">writing</span> <span class="w">t</span><span class="c">o</span> <span class="w">i2sctl</span> <span class="w">reg</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="c">ret);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">clk_set_rate</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">mi2s_bit_clk[da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">d</span><span class="w">]</span><span class="c">,</span>
			   <span class="w">ra</span><span class="pc">t</span><span class="c">e</span> <span class="w">*</span> <span class="w">bitwidth</span> <span class="w">*</span> <span class="pc">2);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="pc">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">s</span><span class="c">etting</span> <span class="w">mi2s</span> <span class="w">bitclk</span> <span class="w">t</span><span class="c">o</span> <span class="c">%</span><span class="w">u:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="w">ra</span><span class="c">te</span> <span class="pc">*</span> <span class="pc">b</span><span class="c">itwidth</span> <span class="w">*</span> <span class="w">2</span><span class="c">,</span> <span class="c">ret</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">lpass_cpu_daiops_hw_free</span><span class="c">(struct</span> <span class="w">sn</span><span class="c">d_pcm_substream</span> <span class="c">*substream,</span>
		<span class="c">struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">vd</span><span class="c">ata</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">regmap_write</span><span class="c">(</span><span class="w">d</span><span class="pc">rv</span><span class="c">data-&gt;</span><span class="w">lpaif_map</span><span class="pc">,</span>
			   <span class="w">LPAIF_I2SCTL_REG</span><span class="c">(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="w">variant</span><span class="c">,</span> <span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="w">i</span><span class="c">d</span><span class="pc">),</span>
			   <span class="pc">0</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="pc">e</span><span class="c">rror</span> <span class="w">writing</span> <span class="w">t</span><span class="c">o</span> <span class="w">i2sctl</span> <span class="w">reg</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="c">ret);</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">lpass_cpu_daiops_prepare</span><span class="c">(struct</span> <span class="w">sn</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="pc">su</span><span class="c">bstream</span><span class="pc">,</span>
		<span class="c">struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">vd</span><span class="c">ata</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">r</span><span class="pc">eg</span><span class="c">map_update_bits(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">lpaif_map</span><span class="c">,</span>
			<span class="w">LPAIF_I2SCTL_REG</span><span class="c">(drvdata-&gt;</span><span class="w">variant</span><span class="c">,</span> <span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">d</span><span class="pc">),</span>
			<span class="w">LPAIF_I2SCTL_SPKEN_MASK</span><span class="pc">,</span> <span class="w">LPAIF_I2SCTL_SPKEN_ENABLE</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et)</span>
		<span class="pc">d</span><span class="c">ev_err(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">writing</span> <span class="w">t</span><span class="c">o</span> <span class="w">i2sctl</span> <span class="w">reg</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="c">ret);</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">lpass_cpu_daiops_trigger</span><span class="c">(struct</span> <span class="w">sn</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="pc">su</span><span class="c">bstream</span><span class="pc">,</span>
		<span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">m</span><span class="c">d,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">vd</span><span class="c">ata</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">= </span><span class="c">-EINVAL;</span>

	<span class="pc">s</span><span class="c">witch</span> <span class="c">(cmd) {</span>
	<span class="c">case</span> <span class="w">SNDRV_PCM_TRIGGER_START</span><span class="c">:</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">SNDRV_PCM_TRIGGER_RESUME</span><span class="c">:</span>
	<span class="c">case</span> <span class="w">SNDRV_PCM_TRIGGER_PAUSE_RELEASE</span><span class="c">:</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">r</span><span class="pc">eg</span><span class="c">map_update_bits(</span><span class="w">dr</span><span class="pc">v</span><span class="c">data-&gt;</span><span class="w">lpaif_map</span><span class="c">,</span>
				<span class="w">LPAIF_I2SCTL_REG</span><span class="pc">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">variant</span><span class="c">,</span>
						<span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">d</span><span class="w">)</span><span class="pc">,</span>
				<span class="w">LPAIF_I2SCTL_SPKEN_MASK</span><span class="pc">,</span>
				<span class="w">LPAIF_I2SCTL_SPKEN_ENABLE</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span><span class="pc">)</span>
			<span class="pc">d</span><span class="c">ev_err(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">writing</span> <span class="w">t</span><span class="c">o</span> <span class="w">i2sctl</span> <span class="w">reg</span><span class="pc">:</span><span class="c"> %d\n",</span>
					<span class="c">__func__,</span> <span class="c">ret);</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">SNDRV_PCM_TRIGGER_STOP</span><span class="c">:</span>
	<span class="w">c</span><span class="c">ase</span> <span class="w">SNDRV_PCM_TRIGGER_SUSPEND</span><span class="c">:</span>
	<span class="pc">c</span><span class="c">ase</span> <span class="w">SNDRV_PCM_TRIGGER_PAUSE_PUSH</span><span class="c">:</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">r</span><span class="pc">egm</span><span class="c">ap_update_bits(</span><span class="w">dr</span><span class="pc">v</span><span class="c">data-&gt;</span><span class="w">lpaif_map</span><span class="c">,</span>
				<span class="w">LPAIF_I2SCTL_REG</span><span class="pc">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">variant</span><span class="c">,</span>
						<span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">d</span><span class="w">)</span><span class="pc">,</span>
				<span class="w">LPAIF_I2SCTL_SPKEN_MASK</span><span class="c">,</span>
				<span class="w">LPAIF_I2SCTL_SPKEN_DISABLE</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
			<span class="pc">d</span><span class="c">ev_err(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">writing</span> <span class="w">t</span><span class="c">o</span> <span class="w">i2sctl</span> <span class="w">reg</span><span class="pc">:</span><span class="c"> %d\n",</span>
					<span class="c">__func__,</span> <span class="c">ret);</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">snd_soc_dai_ops</span> <span class="w">asoc_qcom_lpass_cpu_dai_ops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">set_sysclk</span>	<span class="c">=</span> <span class="w">lpass_cpu_daiops_set_sysclk</span><span class="c">,</span>
	<span class="c">.</span><span class="w">startup</span>	<span class="c">=</span> <span class="w">lpass_cpu_daiops_startup</span><span class="c">,</span>
	<span class="c">.</span><span class="w">shutdown</span>	<span class="c">=</span> <span class="w">lpass_cpu_daiops_shutdown</span><span class="c">,</span>
	<span class="c">.</span><span class="w">hw_params</span>	<span class="c">=</span> <span class="w">lpass_cpu_daiops_hw_params</span><span class="c">,</span>
	<span class="c">.</span><span class="w">hw_free</span>	<span class="c">=</span> <span class="w">lpass_cpu_daiops_hw_free</span><span class="c">,</span>
	<span class="c">.</span><span class="w">prepare</span>	<span class="c">=</span> <span class="w">lpass_cpu_daiops_prepare</span><span class="c">,</span>
	<span class="c">.</span><span class="w">tr</span><span class="c">igger</span>	<span class="c">=</span> <span class="w">lpass_cpu_daiops_trigger</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL_GPL(</span><span class="pc">a</span><span class="c">soc_qcom_lpass_cpu_dai_ops);</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">asoc_qcom_lpass_cpu_dai_probe</span><span class="c">(struct</span> <span class="w">snd_soc_dai</span> <span class="c">*</span><span class="w">da</span><span class="pc">i)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="pc">v</span><span class="c">data</span> <span class="c">=</span> <span class="w">snd_soc_dai_get_drvdata</span><span class="c">(</span><span class="w">da</span><span class="pc">i</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">;</span>

	
	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">regmap_write</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">lpaif_map</span><span class="c">,</span>
			<span class="w">LPAIF_I2SCTL_REG</span><span class="pc">(</span><span class="w">d</span><span class="c">rvdata-&gt;</span><span class="w">variant</span><span class="c">,</span> <span class="w">da</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">dr</span><span class="pc">iver-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">d</span><span class="pc">),</span> <span class="pc">0</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(</span><span class="w">da</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="pc">e</span><span class="c">rror</span> <span class="w">writing</span> <span class="w">t</span><span class="c">o</span> <span class="w">i2sctl</span> <span class="w">reg</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__,</span> <span class="c">ret);</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>
<span class="w">E</span><span class="c">XPORT_SYMBOL_GPL(</span><span class="w">asoc_qcom_lpass_cpu_dai_probe</span><span class="c">);</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">snd_soc_component_driver</span> <span class="w">lpass_cpu_comp_driver</span> <span class="pc">=</span><span class="c"> {</span>
	<span class="c">.name</span> <span class="c">= "</span><span class="w">lpass</span><span class="pc">-</span><span class="w">cp</span><span class="c">u",</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">lpass_cpu_regmap_writeable</span><span class="c">(struct</span> <span class="pc">d</span><span class="c">evice</span> <span class="c">*dev</span><span class="pc">,</span> <span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">eg</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="c">vdata</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">lpass_variant</span> <span class="c">*</span><span class="w">v</span> <span class="pc">=</span> <span class="w">dr</span><span class="pc">v</span><span class="c">data-&gt;</span><span class="w">variant</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i</span><span class="c">;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="c">-&gt;</span><span class="w">i2s_ports</span><span class="pc">; </span><span class="c">++i</span><span class="pc">)</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">eg</span> <span class="w">=</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="c">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">irq_ports;</span><span class="pc"> </span><span class="c">++i) {</span>
		<span class="pc">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_IRQEN_REG</span><span class="pc">(v,</span> <span class="c">i</span><span class="pc">))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_IRQCLEAR_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="c">i</span><span class="pc">))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="c">}</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rdma_channels</span><span class="pc">; </span><span class="c">++i) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">==</span> <span class="w">LPAIF_RDMACTL_REG</span><span class="pc">(</span><span class="w">v</span><span class="c">,</span> <span class="c">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">g</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMABASE_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="pc">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMABUFF_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="pc">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMAPER_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="pc">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="c">}</span>

	<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">lpass_cpu_regmap_readable</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">e</span><span class="c">vice</span> <span class="c">*dev,</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">int</span> <span class="pc">r</span><span class="c">eg)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">lpass_variant</span> <span class="c">*</span><span class="w">v</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v</span><span class="c">data-&gt;</span><span class="w">variant</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i</span><span class="c">;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="c">-&gt;</span><span class="w">i2s_ports</span><span class="pc">; </span><span class="c">++i</span><span class="pc">)</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">eg</span> <span class="w">=</span><span class="c">=</span> <span class="w">LPAIF_I2SCTL_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="c">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">irq_ports;</span><span class="pc"> </span><span class="c">++i) {</span>
		<span class="pc">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_IRQEN_REG</span><span class="pc">(v,</span> <span class="c">i</span><span class="pc">))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_IRQSTAT_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="c">i</span><span class="pc">))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="c">}</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rdma_channels</span><span class="pc">; </span><span class="c">++i) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">==</span> <span class="w">LPAIF_RDMACTL_REG</span><span class="pc">(</span><span class="w">v</span><span class="c">,</span> <span class="c">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">g</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMABASE_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="pc">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMABUFF_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="pc">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMACURR_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="pc">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMAPER_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="pc">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="c">}</span>

	<span class="c">return</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">lpass_cpu_regmap_volatile</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">e</span><span class="c">vice</span> <span class="c">*dev,</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">int</span> <span class="pc">r</span><span class="c">eg)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">lpass_variant</span> <span class="c">*</span><span class="w">v</span> <span class="c">=</span> <span class="w">dr</span><span class="pc">v</span><span class="c">data-&gt;</span><span class="w">variant</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i</span><span class="c">;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="c">-&gt;</span><span class="w">irq_ports</span><span class="pc">; </span><span class="c">++i</span><span class="pc">)</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">eg</span> <span class="w">=</span><span class="c">=</span> <span class="w">LPAIF_IRQSTAT_REG</span><span class="pc">(</span><span class="w">v</span><span class="pc">,</span> <span class="c">i))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rdma_channels;</span><span class="pc"> </span><span class="c">++i</span><span class="pc">)</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span><span class="c">=</span> <span class="w">LPAIF_RDMACURR_REG</span><span class="pc">(v,</span> <span class="c">i</span><span class="pc">))</span>
			<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">f</span><span class="c">alse;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">regmap_config</span> <span class="w">lpass_cpu_regmap_config</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">reg_bits</span> <span class="c">=</span> <span class="w">3</span><span class="c">2,</span>
	<span class="c">.</span><span class="w">reg_stride</span> <span class="c">=</span> <span class="w">4</span><span class="c">,</span>
	<span class="c">.</span><span class="w">val_bits</span> <span class="c">=</span> <span class="w">3</span><span class="pc">2</span><span class="c">,</span>
	<span class="c">.</span><span class="w">writeable_reg</span> <span class="c">=</span> <span class="w">lpass_cpu_regmap_writeable</span><span class="c">,</span>
	<span class="c">.</span><span class="w">readable_reg</span> <span class="c">=</span> <span class="w">lpass_cpu_regmap_readable</span><span class="c">,</span>
	<span class="c">.</span><span class="w">volatile_reg</span> <span class="c">=</span> <span class="w">lpass_cpu_regmap_volatile</span><span class="c">,</span>
	<span class="c">.</span><span class="w">cache_type</span> <span class="c">=</span> <span class="w">REGCACHE_FLAT</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">asoc_qcom_lpass_cpu_platform_probe</span><span class="c">(struct</span> <span class="w">p</span><span class="c">latform_device</span> <span class="c">*pdev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">dr</span><span class="c">vdata</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="pc">d</span><span class="c">evice_node</span> <span class="c">*</span><span class="w">dsp_of_node</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">r</span><span class="c">esource</span> <span class="c">*res;</span>
	<span class="c">struct</span> <span class="w">lpass_variant</span> <span class="c">*</span><span class="w">variant</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">d</span><span class="pc">evice</span> <span class="c">*dev</span> <span class="pc">=</span><span class="c"> &amp;pdev-&gt;dev;</span>
	<span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="pc">o</span><span class="c">f_device_id</span> <span class="c">*</span><span class="pc">m</span><span class="c">atch;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">clk_name</span><span class="c">[</span><span class="pc">1</span><span class="c">6];</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">,</span> <span class="w">i</span><span class="pc">,</span> <span class="w">dai_id</span><span class="c">;</span>

	<span class="w">d</span><span class="pc">s</span><span class="c">p_of_node</span> <span class="c">=</span> <span class="w">of_parse_phandle</span><span class="c">(</span><span class="pc">p</span><span class="c">dev</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="pc">.</span><span class="c">of_node</span><span class="pc">, "</span><span class="w">qcom</span><span class="pc">,</span><span class="w">adsp</span><span class="pc">"</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">d</span><span class="c">sp_of_node</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">DSP</span> <span class="w">exists</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">holds</span> <span class="w">au</span><span class="c">dio</span> <span class="w">res</span><span class="pc">ources</span><span class="c">\n",</span>
				<span class="c">__func__);</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EB</span><span class="c">USY;</span>
	<span class="c">}</span>

	<span class="w">dr</span><span class="c">vdata</span> <span class="pc">=</span> <span class="c">devm_kzalloc(&amp;pdev-&gt;dev,</span> <span class="c">sizeof</span><span class="pc">(</span><span class="c">struct</span> <span class="w">lpass_data</span><span class="c">),</span>
			<span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="c">platform_set_drvdata(pdev,</span> <span class="c">drvdata);</span>

	<span class="w">ma</span><span class="pc">t</span><span class="c">ch</span> <span class="pc">=</span> <span class="w">of_match_device</span><span class="c">(</span><span class="w">d</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">dr</span><span class="c">iver</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">of_match_table</span><span class="pc">,</span> <span class="w">d</span><span class="pc">ev</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="pc">a</span><span class="c">tch</span> <span class="pc">|</span><span class="c">| !</span><span class="w">m</span><span class="c">atch</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">a</span><span class="c">ta)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>

	<span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">variant</span> <span class="w">=</span><span class="pc"> (s</span><span class="c">truct</span> <span class="w">lpass_variant</span> <span class="c">*)</span><span class="w">m</span><span class="pc">a</span><span class="c">tch</span><span class="pc">-</span><span class="c">&gt;data;</span>
	<span class="w">v</span><span class="c">ariant</span> <span class="pc">=</span> <span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="pc">v</span><span class="c">ariant;</span>

	<span class="pc">r</span><span class="c">es</span> <span class="c">=</span> <span class="w">platform_get_resource_byname</span><span class="c">(</span><span class="w">p</span><span class="c">dev,</span> <span class="w">I</span><span class="c">ORESOURCE_MEM</span><span class="pc">, </span><span class="c">"</span><span class="w">lpass</span><span class="pc">-</span><span class="w">lpaif</span><span class="pc">")</span><span class="c">;</span>

	<span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">l</span><span class="c">paif</span> <span class="c">=</span> <span class="w">devm_ioremap_resource</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev,</span> <span class="c">res);</span>
	<span class="c">if</span> <span class="c">(IS_ERR</span><span class="pc">((</span><span class="w">v</span><span class="pc">o</span><span class="c">id</span> <span class="w">cons</span><span class="c">t</span> <span class="w">__f</span><span class="c">orce</span> <span class="w">*</span><span class="pc">)</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="pc">l</span><span class="c">paif</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">m</span><span class="pc">app</span><span class="c">ing</span> <span class="w">reg</span> <span class="w">r</span><span class="pc">es</span><span class="c">ource</span><span class="pc">:</span><span class="c"> %</span><span class="pc">l</span><span class="c">d\n",</span>
				<span class="c">__func__</span><span class="pc">,</span>
				<span class="w">P</span><span class="c">TR_ERR</span><span class="w">(</span><span class="pc">(</span><span class="w">v</span><span class="c">oid</span> <span class="w">cons</span><span class="c">t</span> <span class="w">__f</span><span class="pc">o</span><span class="c">rce</span> <span class="w">*</span><span class="pc">)</span><span class="w">dr</span><span class="c">vdata-&gt;lpaif</span><span class="pc">)</span><span class="c">);</span>
		<span class="c">return</span> <span class="pc">P</span><span class="c">TR_ERR</span><span class="pc">((</span><span class="w">v</span><span class="pc">o</span><span class="c">id</span> <span class="w">cons</span><span class="c">t</span> <span class="w">__f</span><span class="c">orce</span> <span class="w">*</span><span class="pc">)</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="pc">l</span><span class="c">paif);</span>
	<span class="c">}</span>

	<span class="w">lpass_cpu_regmap_config.max_register</span> <span class="c">=</span> <span class="w">LPAIF_RDMAPER_REG</span><span class="pc">(</span><span class="w">variant</span><span class="c">,</span>
						<span class="w">v</span><span class="c">ariant</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rdma_channels</span><span class="c">);</span>

	<span class="w">dr</span><span class="c">vdata-&gt;</span><span class="w">lpaif_map</span> <span class="c">=</span> <span class="w">devm_regmap_init_mmio</span><span class="pc">(&amp;p</span><span class="c">dev-&gt;dev,</span> <span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="pc">l</span><span class="c">paif,</span>
			<span class="pc">&amp;l</span><span class="c">pass_cpu_regmap_config</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="pc">d</span><span class="c">rvdata-&gt;lpaif_map</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">initializing</span> <span class="w">regm</span><span class="pc">ap:</span><span class="c"> %</span><span class="pc">l</span><span class="c">d\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="pc">P</span><span class="c">TR_ERR(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="pc">lpaif_</span><span class="c">map));</span>
		<span class="c">return</span> <span class="c">PTR_ERR(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="pc">l</span><span class="c">paif_map);</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">variant</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ini</span><span class="c">t</span><span class="w">)</span>
		<span class="pc">v</span><span class="c">ariant</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">in</span><span class="pc">it</span><span class="c">(</span><span class="w">p</span><span class="pc">d</span><span class="c">ev);</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">v</span><span class="c">ariant-&gt;</span><span class="w">num_dai</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">dai_id</span> <span class="pc">=</span> <span class="w">v</span><span class="c">ariant-&gt;</span><span class="w">dai_driver</span><span class="c">[i</span><span class="pc">].</span><span class="w">i</span><span class="c">d;</span>
		<span class="c">if</span> <span class="c">(variant-&gt;</span><span class="pc">n</span><span class="c">um_dai</span> <span class="pc">&gt;</span> <span class="w">1</span><span class="c">)</span>
			<span class="w">sp</span><span class="pc">r</span><span class="c">intf(</span><span class="w">clk_name</span><span class="c">, "</span><span class="w">mi2s-osr</span><span class="pc">-</span><span class="w">cl</span><span class="pc">k%</span><span class="c">d",</span> <span class="pc">i</span><span class="c">);</span>
		<span class="w">e</span><span class="c">lse</span>
			<span class="w">sp</span><span class="c">rintf(</span><span class="w">c</span><span class="c">lk_name, "</span><span class="pc">m</span><span class="c">i2s</span><span class="pc">-</span><span class="w">o</span><span class="pc">s</span><span class="c">r-</span><span class="w">c</span><span class="pc">lk")</span><span class="c">;</span>

		<span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">mi2s_osr_clk</span><span class="c">[</span><span class="w">dai_id</span><span class="c">] =</span> <span class="w">devm_clk_get(</span><span class="pc">&amp;p</span><span class="c">dev-&gt;dev</span><span class="pc">,</span>
								<span class="pc">c</span><span class="c">lk_name</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(IS_ERR(</span><span class="w">d</span><span class="c">rvdata-&gt;</span><span class="pc">m</span><span class="c">i2s_osr_clk</span><span class="pc">[d</span><span class="c">ai_id</span><span class="w">])) {</span>
			<span class="w">dev_</span><span class="pc">w</span><span class="c">arn(&amp;pdev-&gt;dev</span><span class="pc">,</span>
				<span class="w">"</span><span class="pc">%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">getting</span> <span class="w">mi2s-osr-cl</span><span class="pc">k</span><span class="w">:</span><span class="c"> %</span><span class="pc">l</span><span class="c">d\n",</span>
				<span class="pc">_</span><span class="c">_func__,</span>
				<span class="w">P</span><span class="c">TR_ERR(</span><span class="w">dr</span><span class="pc">v</span><span class="c">data-&gt;</span><span class="pc">m</span><span class="c">i2s_osr_clk</span><span class="pc">[</span><span class="w">d</span><span class="c">ai_id</span><span class="pc">]))</span><span class="c">;</span>
		<span class="pc">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">variant</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">num_dai</span> <span class="w">&gt;</span> <span class="pc">1)</span>
			<span class="w">sp</span><span class="c">rintf(</span><span class="w">clk_name</span><span class="c">, "</span><span class="w">m</span><span class="pc">i2s</span><span class="w">-b</span><span class="c">it</span><span class="pc">-</span><span class="w">c</span><span class="pc">lk</span><span class="w">%</span><span class="pc">d</span><span class="c">",</span> <span class="w">i</span><span class="c">);</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">s</span><span class="pc">p</span><span class="c">rintf(</span><span class="w">c</span><span class="pc">l</span><span class="c">k_name, "mi2s</span><span class="pc">-</span><span class="w">b</span><span class="c">it</span><span class="pc">-</span><span class="w">c</span><span class="pc">lk")</span><span class="c">;</span>

		<span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">mi2s_bit_clk</span><span class="c">[</span><span class="w">d</span><span class="c">ai_id] =</span> <span class="w">devm_clk_get</span><span class="pc">(&amp;p</span><span class="c">dev-&gt;dev,</span>
							    <span class="pc">c</span><span class="c">lk_name</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(IS_ERR(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="pc">m</span><span class="c">i2s_bit_clk</span><span class="pc">[</span><span class="w">d</span><span class="c">ai_id</span><span class="w">])) {</span>
			<span class="w">de</span><span class="pc">v_</span><span class="c">err(&amp;pdev-&gt;dev</span><span class="pc">,</span>
				<span class="w">"</span><span class="pc">%</span><span class="c">s</span><span class="w">(</span><span class="pc">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">getting</span> <span class="w">mi2s-bi</span><span class="c">t</span><span class="w">-cl</span><span class="pc">k:</span><span class="c"> %</span><span class="pc">l</span><span class="c">d\n",</span>
				<span class="pc">_</span><span class="c">_func__,</span> <span class="w">P</span><span class="c">TR_ERR(</span><span class="w">dr</span><span class="c">vdata-&gt;</span><span class="pc">m</span><span class="c">i2s_bit_clk</span><span class="pc">[i]))</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">P</span><span class="c">TR_ERR(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;mi2s_bit_clk</span><span class="pc">[</span><span class="w">d</span><span class="c">ai_id</span><span class="pc">])</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">ahbix_clk</span> <span class="c">=</span> <span class="w">devm_clk_get</span><span class="pc">(&amp;p</span><span class="c">dev-&gt;dev</span><span class="pc">, </span><span class="c">"</span><span class="w">ahbix</span><span class="pc">-</span><span class="w">c</span><span class="pc">lk")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(</span><span class="c">IS_ERR(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="w">a</span><span class="c">hbix_clk)) {</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">getting</span> <span class="w">ah</span><span class="pc">bix</span><span class="w">-c</span><span class="pc">lk:</span><span class="c"> %</span><span class="pc">l</span><span class="c">d\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="pc">P</span><span class="c">TR_ERR(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="pc">a</span><span class="c">hbix_clk</span><span class="pc">))</span><span class="c">;</span>
		<span class="c">return</span> <span class="c">PTR_ERR(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="pc">a</span><span class="c">hbix_clk);</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">clk_set_rate</span><span class="c">(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="pc">a</span><span class="c">hbix_clk</span><span class="pc">,</span> <span class="w">LPASS_AHBIX_CLOCK_FREQUENCY</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et) {</span>
		<span class="c">dev_err</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">s</span><span class="c">etting</span> <span class="w">ra</span><span class="c">te</span> <span class="w">o</span><span class="c">n</span> <span class="w">a</span><span class="c">hbix_clk</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="c">ret);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>
	<span class="w">d</span><span class="c">ev_dbg(&amp;</span><span class="pc">p</span><span class="c">dev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">s</span><span class="pc">et</span> <span class="w">a</span><span class="c">hbix_clk</span> <span class="w">ra</span><span class="c">te</span> <span class="w">t</span><span class="c">o</span> <span class="pc">%l</span><span class="c">u\n",</span> <span class="c">__func__,</span>
			<span class="w">clk_get_rate</span><span class="c">(</span><span class="w">dr</span><span class="pc">v</span><span class="c">data-&gt;ahbix_clk</span><span class="pc">))</span><span class="c">;</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">clk_prepare_enable</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata-&gt;</span><span class="w">a</span><span class="pc">h</span><span class="c">bix_clk</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret) {</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">enabling</span> <span class="w">a</span><span class="pc">h</span><span class="c">bix_clk</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="c">ret);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">devm_snd_soc_register_component</span><span class="pc">(&amp;p</span><span class="c">dev-&gt;dev,</span>
					      <span class="pc">&amp;</span><span class="w">lpass_cpu_comp_driver</span><span class="c">,</span>
					      <span class="w">variant</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dai_driver</span><span class="pc">,</span>
					      <span class="w">v</span><span class="c">ariant</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">num_dai</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(ret) {</span>
		<span class="c">dev_err(&amp;</span><span class="pc">p</span><span class="c">dev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">registering</span> <span class="w">cp</span><span class="c">u</span> <span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="pc">:</span><span class="c"> %d\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="c">ret);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">err_clk</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">asoc_qcom_lpass_platform_register</span><span class="c">(</span><span class="w">p</span><span class="c">dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret) {</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev</span><span class="pc">, "%</span><span class="c">s</span><span class="w">(</span><span class="c">)</span> <span class="w">e</span><span class="c">rror</span> <span class="w">r</span><span class="pc">egisteri</span><span class="c">ng</span> <span class="w">p</span><span class="pc">l</span><span class="c">atform</span> <span class="w">dr</span><span class="pc">iver:</span><span class="c"> %</span><span class="pc">d</span><span class="c">\n",</span>
				<span class="c">__func__</span><span class="pc">,</span> <span class="c">ret);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">e</span><span class="c">rr_clk;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>

<span class="pc">e</span><span class="c">rr_clk:</span>
	<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ahbix_clk</span><span class="c">);</span>
	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL_GPL(</span><span class="w">asoc_qcom_lpass_cpu_platform_probe</span><span class="c">);</span>

<span class="c">int</span> <span class="w">asoc_qcom_lpass_cpu_platform_remove</span><span class="c">(struct</span> <span class="c">platform_device</span> <span class="c">*pdev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">lpass_data</span> <span class="c">*</span><span class="w">d</span><span class="pc">r</span><span class="c">vdata</span> <span class="c">=</span> <span class="c">platform_get_drvdata(pdev);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="w">variant-</span><span class="c">&gt;</span><span class="w">ex</span><span class="c">it)</span>
		<span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="pc">v</span><span class="c">ariant-&gt;</span><span class="w">ex</span><span class="c">it</span><span class="pc">(p</span><span class="c">dev</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="pc">d</span><span class="c">rvdata-&gt;</span><span class="w">ahbix_clk</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>
<span class="pc">E</span><span class="c">XPORT_SYMBOL_GPL(</span><span class="w">asoc_qcom_lpass_cpu_platform_remove</span><span class="c">);</span>

</pre>
</body>
</html>

