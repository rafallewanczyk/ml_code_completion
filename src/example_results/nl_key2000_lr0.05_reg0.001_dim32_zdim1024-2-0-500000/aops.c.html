<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/fs.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/highmem.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/pagemap.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;asm</span><span class="c">/</span><span class="w">byteorder</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">l</span><span class="c">inux/</span><span class="w">swap</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">pipe_fs_i</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">mpage</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">quotaops</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">blkdev</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">uio</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="w">cluster</span><span class="c">/</span><span class="w">masklog</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">ocfs2</span><span class="c">.h"</span>

<span class="c">#include</span> <span class="c">"</span><span class="w">al</span><span class="pc">loc</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">aops</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">dlmglue</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">extent_map</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">fil</span><span class="pc">e</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">ino</span><span class="pc">d</span><span class="c">e.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">suballoc</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">super</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">symlink</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">refcounttree</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">ocfs2_trace</span><span class="c">.h"</span>

<span class="c">#include</span> <span class="c">"</span><span class="w">buffer_head_io</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">di</span><span class="pc">r</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">namei</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">sysfile</span><span class="c">.h"</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_symlink_get_block</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode,</span> <span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span> <span class="w">iblock</span><span class="pc">,</span>
				   <span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">uffer_head</span> <span class="c">*</span><span class="w">bh_result</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cr</span><span class="pc">e</span><span class="c">ate</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span><span class="c"> -</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">s</span><span class="pc">t</span><span class="c">atus</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">fe</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">struct</span> <span class="w">bu</span><span class="pc">ffer_</span><span class="c">head</span> <span class="c">*</span><span class="w">bh</span> <span class="c">=</span> <span class="c">NULL;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">uffer_</span><span class="c">head</span> <span class="c">*</span><span class="w">buffer_cache_bh</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="c">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b);</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">kaddr</span><span class="pc">;</span>

	<span class="w">trace_ocfs2_symlink_get_block</span><span class="c">(</span>
			<span class="w">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong</span><span class="pc">)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
			<span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">iblock</span><span class="pc">,</span> <span class="w">bh_result</span><span class="c">,</span> <span class="w">cr</span><span class="pc">ea</span><span class="c">te);</span>

	<span class="w">B</span><span class="c">UG_ON(</span><span class="w">ocfs2_inode_is_fast_symlink</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="w">))</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">((</span><span class="c">iblock</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_blocksize_bits) &gt;</span> <span class="w">PATH_MAX</span> <span class="w">+</span> <span class="c">1</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="pc">, "</span><span class="w">b</span><span class="pc">l</span><span class="c">ock</span> <span class="w">o</span><span class="pc">ff</span><span class="c">set</span> <span class="w">&gt;</span> <span class="w">P</span><span class="c">ATH_MAX</span><span class="w">:</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span><span class="pc">"</span><span class="c">,</span>
		     <span class="pc">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">i</span><span class="c">block</span><span class="w">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

	<span class="w">st</span><span class="pc">atu</span><span class="c">s</span> <span class="c">=</span> <span class="w">ocfs2_read_inode_block</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">tatus</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="pc">s</span><span class="c">tatus);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>
	<span class="w">fe</span> <span class="pc">= </span><span class="c">(struct</span> <span class="w">ocfs2_dinode</span> <span class="c">*)</span> <span class="w">bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">((</span><span class="w">u</span><span class="pc">6</span><span class="c">4)</span><span class="w">iblock</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">ocfs2_clusters_to_blocks</span><span class="pc">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b,</span>
						    <span class="w">le</span><span class="pc">3</span><span class="c">2_to_cpu(</span><span class="w">fe</span><span class="c">-&gt;</span><span class="w">i_clusters)))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">= -</span><span class="pc">ENOM</span><span class="c">EM;</span>
		<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="pc">, "</span><span class="w">bl</span><span class="c">ock</span> <span class="w">of</span><span class="pc">fs</span><span class="c">et</span> <span class="w">i</span><span class="pc">s</span> <span class="w">outside</span> <span class="w">t</span><span class="pc">h</span><span class="c">e</span> <span class="w">allocated</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="w">:</span><span class="pc"> "</span>
		     <span class="w">"</span><span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u\n</span><span class="pc">", </span><span class="c">(unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">i</span><span class="pc">b</span><span class="c">lock</span><span class="w">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">buffer_uptodate</span><span class="c">(</span><span class="w">bh_result)</span><span class="pc"> </span><span class="c">&amp;&amp;</span> <span class="w">ocfs2_inode_is_new</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">u6</span><span class="c">4</span> <span class="w">blkno</span> <span class="c">=</span> <span class="w">le64_to_cpu</span><span class="c">(</span><span class="w">fe</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">id2</span><span class="pc">.</span><span class="w">i_list</span><span class="pc">.</span><span class="w">l_recs[</span><span class="c">0</span><span class="pc">].</span><span class="w">e_blkno) +</span>
			    <span class="w">i</span><span class="pc">b</span><span class="c">lock</span><span class="pc">;</span>
		<span class="w">buffer_cache_bh</span> <span class="pc">=</span> <span class="w">sb_getblk</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">,</span> <span class="c">blkno</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">buffer_cache_bh) {</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
			<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="pc">, </span><span class="c">"</span><span class="w">couldn'</span><span class="c">t</span> <span class="w">getblock</span> <span class="w">f</span><span class="c">or</span> <span class="w">symlink!</span><span class="c">\n");</span>
			<span class="c">goto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">buffer_jbd</span><span class="c">(buffer_cache_bh</span><span class="w">)</span>
		    <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">ocfs2_inode_is_new</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="w">)</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">kaddr</span> <span class="pc">=</span> <span class="w">kmap_atomic</span><span class="c">(</span><span class="w">bh_result-</span><span class="c">&gt;</span><span class="w">b_page</span><span class="c">);</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="c">kaddr</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">m</span><span class="c">log(</span><span class="w">M</span><span class="c">L_ERROR</span><span class="pc">,</span><span class="c"> "</span><span class="w">co</span><span class="pc">uldn</span><span class="w">'</span><span class="c">t</span> <span class="w">kmap</span><span class="pc">!</span><span class="c">\n");</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">ba</span><span class="pc">i</span><span class="c">l;</span>
			<span class="c">}</span>
			<span class="w">me</span><span class="pc">mc</span><span class="c">py(</span><span class="w">k</span><span class="c">addr</span> <span class="w">+</span><span class="pc"> (</span><span class="w">b</span><span class="pc">h</span><span class="c">_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span> <span class="w">*</span> <span class="w">iblock</span><span class="pc">),</span>
			       <span class="w">buffer_cache_bh-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="pc">,</span>
			       <span class="pc">b</span><span class="c">h_result-&gt;</span><span class="pc">b_s</span><span class="c">ize);</span>
			<span class="w">kunmap_atomic</span><span class="c">(</span><span class="w">k</span><span class="c">addr</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">set_buffer_uptodate</span><span class="c">(bh_result);</span>
		<span class="pc">}</span>
		<span class="w">brelse</span><span class="c">(</span><span class="pc">bu</span><span class="c">ffer_cache_bh);</span>
	<span class="c">}</span>

	<span class="w">map_bh</span><span class="c">(bh_result</span><span class="pc">,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">,</span>
	       <span class="w">le64_to_cpu</span><span class="pc">(</span><span class="w">fe</span><span class="c">-&gt;</span><span class="w">id2.i_list</span><span class="pc">.</span><span class="w">l_recs[</span><span class="c">0</span><span class="pc">].</span><span class="w">e_blkno) +</span> <span class="w">iblock)</span><span class="pc">;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="c">0;</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l:</span>
	<span class="w">b</span><span class="pc">r</span><span class="c">else(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_get_block</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode,</span> <span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span> <span class="pc">ib</span><span class="c">lock,</span>
		    <span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">bh_result</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cr</span><span class="pc">e</span><span class="c">ate)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ext_flags</span><span class="c">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">max_blocks</span> <span class="pc">=</span> <span class="pc">b</span><span class="c">h_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">p_blkno</span><span class="pc">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">,</span> <span class="w">past_eof</span><span class="pc">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="pc">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b);</span>

	<span class="w">trace_ocfs2_get_block(</span><span class="pc">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
			      <span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">iblock</span><span class="pc">,</span> <span class="w">bh_result</span><span class="c">,</span> <span class="w">cr</span><span class="pc">ea</span><span class="c">te);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">O</span><span class="c">CFS2_I(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_flags</span> <span class="w">&amp;</span> <span class="w">OCFS2_INODE_SYSTEM_FILE</span><span class="pc">)</span>
		<span class="w">mlog</span><span class="c">(</span><span class="w">ML_NOTICE,</span><span class="pc"> "</span><span class="w">get_block</span> <span class="w">o</span><span class="pc">n</span> <span class="w">system</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="pc">p</span> <span class="w">(</span><span class="c">%</span><span class="pc">l</span><span class="c">u)\n",</span>
		     <span class="w">in</span><span class="pc">od</span><span class="c">e</span><span class="pc">,</span> <span class="w">i</span><span class="pc">no</span><span class="c">de-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">S_ISLNK</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_</span><span class="c">mode</span><span class="pc">)) </span><span class="c">{</span>
		
		<span class="w">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">ocfs2_symlink_get_block</span><span class="c">(</span><span class="pc">i</span><span class="c">node,</span> <span class="w">iblock</span><span class="c">,</span> <span class="w">bh_result</span><span class="c">,</span> <span class="w">cr</span><span class="c">eate</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">ocfs2_extent_map_get_blocks</span><span class="c">(inode,</span> <span class="pc">ib</span><span class="c">lock</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_blkno</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">co</span><span class="c">unt</span><span class="pc">,</span>
					  <span class="w">&amp;ext_flags</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="pc">, "</span><span class="w">E</span><span class="c">rror</span> <span class="pc">%d</span> <span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="w">get_blocks(</span><span class="pc">0</span><span class="c">x%</span><span class="pc">p</span><span class="w">,</span><span class="pc"> %</span><span class="w">l</span><span class="pc">lu</span><span class="w">,</span> <span class="w">1,</span><span class="pc"> </span><span class="c">"</span>
		     <span class="w">"</span><span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span><span class="w">,</span> <span class="w">N</span><span class="c">ULL</span><span class="w">)</span><span class="c">\n",</span> <span class="w">e</span><span class="pc">r</span><span class="c">r,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="w">,</span><span class="pc"> </span><span class="c">(unsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">iblock</span><span class="pc">,</span>
		     <span class="c">(unsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">p_blkno)</span><span class="c">;</span>
		<span class="w">g</span><span class="pc">o</span><span class="c">to</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">max_blocks</span> <span class="w">&lt;</span> <span class="w">c</span><span class="pc">ou</span><span class="c">nt)</span>
		<span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="c">=</span> <span class="pc">m</span><span class="c">ax_blocks</span><span class="pc">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="c">eate</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="c">p_blkno</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">ocfs2_sparse_alloc</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">clear_buffer_dirty</span><span class="c">(</span><span class="w">bh_result</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">clear_buffer_uptodate</span><span class="c">(bh_result);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="c">_blkno</span> <span class="w">&amp;&amp; !(ext_flags</span> <span class="w">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN</span><span class="c">))</span>
		<span class="w">map_bh</span><span class="c">(bh_result</span><span class="pc">,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span> <span class="w">p</span><span class="c">_blkno);</span>

	<span class="w">b</span><span class="c">h_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span> <span class="c">=</span> <span class="w">co</span><span class="c">unt</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">ino</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">ocfs2_sparse_alloc</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">p</span><span class="c">_blkno</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0) {</span>
			<span class="w">e</span><span class="c">rr</span> <span class="c">= -</span><span class="pc">EIO</span><span class="c">;</span>
			<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="c">,</span>
			     <span class="pc">"</span><span class="w">iblock</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span> <span class="w">p</span><span class="pc">_</span><span class="c">blkno</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span> <span class="w">blkno=(%l</span><span class="pc">l</span><span class="c">u</span><span class="w">)</span><span class="c">\n",</span>
			     <span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">i</span><span class="pc">b</span><span class="c">lock</span><span class="pc">,</span>
			     <span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">p</span><span class="c">_blkno</span><span class="pc">,</span>
			     <span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">);</span>
			<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR,</span><span class="pc"> "</span><span class="w">Size</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span><span class="w">,</span> <span class="w">clusters</span> <span class="pc">%u\</span><span class="c">n</span><span class="pc">", </span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">i_size_read</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="w">)</span><span class="pc">,</span> <span class="pc">O</span><span class="c">CFS2_I(</span><span class="w">i</span><span class="c">node)-&gt;</span><span class="w">ip_clusters)</span><span class="pc">;</span>
			<span class="w">dump_stack</span><span class="pc">()</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">past_eof</span> <span class="pc">=</span> <span class="w">ocfs2_blocks_for_bytes</span><span class="c">(inode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_sb</span><span class="c">,</span> <span class="w">i</span><span class="pc">_</span><span class="c">size_read</span><span class="w">(</span><span class="c">inode</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">trace_ocfs2_get_block_end</span><span class="pc">((u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">l</span><span class="c">ong)</span><span class="w">O</span><span class="c">CFS2_I(</span><span class="pc">i</span><span class="c">node)-&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
				  <span class="pc">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="pc">p</span><span class="c">ast_eof);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="pc">ea</span><span class="c">te</span> <span class="w">&amp;</span><span class="pc">&amp; (</span><span class="w">iblock</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">p</span><span class="c">ast_eof</span><span class="pc">))</span>
		<span class="w">set_buffer_new</span><span class="c">(</span><span class="w">bh_result</span><span class="pc">)</span><span class="c">;</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l</span><span class="pc">:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">er</span><span class="pc">r</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="w">i</span><span class="c">nt</span> <span class="w">ocfs2_read_inline_data</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="w">p</span><span class="pc">ag</span><span class="c">e</span> <span class="c">*</span><span class="pc">p</span><span class="c">age,</span>
			   <span class="c">struct</span> <span class="w">bu</span><span class="pc">ff</span><span class="c">er_head</span> <span class="c">*</span><span class="w">di_bh</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">kaddr</span><span class="c">;</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="pc">s</span><span class="c">ize;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">di</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">ocfs2_dinode</span> <span class="c">*)</span><span class="pc">d</span><span class="c">i_bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">di</span><span class="c">-&gt;</span><span class="w">i_dyn_features</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ocfs2_error</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="w">,</span><span class="pc"> "</span><span class="w">Inode</span> <span class="w">%l</span><span class="pc">l</span><span class="c">u</span> <span class="w">lost</span> <span class="w">inl</span><span class="c">ine</span> <span class="w">da</span><span class="pc">ta</span> <span class="w">fl</span><span class="c">ag</span><span class="w">"</span><span class="c">,</span>
			    <span class="pc">(</span><span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">ip_blkno</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">EROFS</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">si</span><span class="pc">ze</span> <span class="c">=</span> <span class="w">i_size_read</span><span class="c">(inode</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="c">ize</span> <span class="pc">&gt;</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="w">s</span><span class="c">ize</span> <span class="c">&gt;</span> <span class="w">ocfs2_max_inline_data_with_xattr</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b,</span> <span class="w">di)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ocfs2_error</span><span class="c">(</span><span class="pc">in</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b,</span>
			    <span class="w">"Inode</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span> <span class="w">h</span><span class="pc">a</span><span class="c">s</span> <span class="w">w</span><span class="pc">i</span><span class="c">th</span> <span class="w">inl</span><span class="c">ine</span> <span class="w">da</span><span class="pc">ta</span> <span class="w">h</span><span class="pc">as</span> <span class="w">b</span><span class="pc">a</span><span class="c">d</span> <span class="pc">s</span><span class="c">ize</span><span class="pc">:</span><span class="c"> %</span><span class="w">Lu</span><span class="pc">",</span>
			    <span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">ip_blkno</span><span class="c">,</span>
			    <span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">EROFS</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">kaddr</span> <span class="pc">=</span> <span class="w">kmap_atomic</span><span class="c">(</span><span class="w">p</span><span class="pc">ag</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">s</span><span class="c">ize)</span>
		<span class="w">m</span><span class="pc">emc</span><span class="c">py(kaddr,</span> <span class="w">di</span><span class="c">-&gt;</span><span class="w">id2</span><span class="pc">.</span><span class="w">i_data</span><span class="pc">.</span><span class="w">id_data</span><span class="c">,</span> <span class="c">size);</span>
	
	<span class="w">m</span><span class="pc">ems</span><span class="c">et(kaddr</span> <span class="w">+</span> <span class="w">s</span><span class="pc">ize</span><span class="c">,</span> <span class="pc">0</span><span class="c">,</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="w">-</span> <span class="w">s</span><span class="pc">ize</span><span class="c">);</span>
	<span class="w">flush_dcache_page</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>
	<span class="w">kunmap_atomic</span><span class="c">(kaddr);</span>

	<span class="w">SetPageUptodate</span><span class="c">(</span><span class="w">p</span><span class="c">age);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_readpage_inline</span><span class="c">(struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*page</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er_head</span> <span class="c">*</span><span class="w">di_bh</span> <span class="pc">=</span> <span class="c">NULL;</span>

	<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">PageLocked</span><span class="c">(page</span><span class="w">))</span><span class="pc">;</span>
	<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!(</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL))</span><span class="pc">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_read_inode_block</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">, </span><span class="c">&amp;di_bh);</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="c">et);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_read_inline_data</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge,</span> <span class="w">d</span><span class="c">i_bh</span><span class="pc">)</span><span class="c">;</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="w">unlock_page</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>

	<span class="w">brelse</span><span class="c">(</span><span class="pc">di</span><span class="c">_bh);</span>
	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_readpage</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">s</span><span class="c">truct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*page</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode</span> <span class="c">=</span> <span class="pc">p</span><span class="c">age-&gt;</span><span class="w">m</span><span class="pc">ap</span><span class="c">ping</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ho</span><span class="c">st;</span>
	<span class="c">struct</span> <span class="w">ocfs2_inode_info</span> <span class="c">*</span><span class="w">oi</span> <span class="c">=</span> <span class="w">OCFS2_I</span><span class="c">(inode);</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">s</span><span class="pc">tar</span><span class="c">t</span> <span class="w">=</span><span class="pc"> (</span><span class="w">l</span><span class="pc">of</span><span class="c">f_t</span><span class="pc">)p</span><span class="c">age-&gt;</span><span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">ret</span><span class="pc">,</span> <span class="w">un</span><span class="pc">lo</span><span class="c">ck</span> <span class="w">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="w">trace_ocfs2_readpage((</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="pc">o</span><span class="c">i-&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
			     <span class="w">(p</span><span class="c">age</span> <span class="w">?</span> <span class="w">p</span><span class="c">age</span><span class="pc">-&gt;</span><span class="w">i</span><span class="c">ndex</span> <span class="w">:</span> <span class="c">0</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock_with_page</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="w">0</span><span class="c">,</span> <span class="w">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">!</span><span class="c">=</span> <span class="c">0) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span> <span class="pc">==</span> <span class="w">AOP_TRUNCATED_PAGE</span><span class="pc">)</span>
			<span class="w">u</span><span class="pc">n</span><span class="c">lock</span> <span class="pc">=</span> <span class="c">0;</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="pc">r</span><span class="c">et</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">down_read_trylock</span><span class="pc">(&amp;</span><span class="w">oi</span><span class="c">-&gt;</span><span class="w">ip_alloc_sem) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0) {</span>
		
		<span class="c">ret</span> <span class="c">=</span> <span class="w">A</span><span class="c">OP_TRUNCATED_PAGE</span><span class="pc">;</span>
		<span class="w">unlock_page</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">u</span><span class="pc">nlock</span> <span class="pc">=</span> <span class="c">0;</span>
		<span class="w">down_read</span><span class="pc">(&amp;</span><span class="c">oi</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">p_alloc_sem);</span>
		<span class="w">up_read</span><span class="pc">(&amp;</span><span class="c">oi-&gt;ip_alloc_sem);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">out_inode_unlock</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">st</span><span class="pc">ar</span><span class="c">t</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">zero_user</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">P</span><span class="c">AGE_SIZE);</span>
		<span class="w">SetPageUptodate</span><span class="c">(</span><span class="w">p</span><span class="c">age);</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">0;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_alloc</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(oi-&gt;</span><span class="w">ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="pc">)</span>
		<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_readpage_inline</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">block_read_full_page</span><span class="c">(</span><span class="w">p</span><span class="c">age,</span> <span class="w">ocfs2_get_block</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">lock</span> <span class="pc">=</span> <span class="c">0;</span>

<span class="w">o</span><span class="pc">ut_</span><span class="c">alloc</span><span class="w">:</span>
	<span class="w">up_read</span><span class="pc">(&amp;</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_alloc_sem</span><span class="pc">)</span><span class="c">;</span>
<span class="w">out_inode_unlock</span><span class="pc">:</span>
	<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>
<span class="w">o</span><span class="pc">ut</span><span class="c">:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">un</span><span class="pc">lo</span><span class="c">ck)</span>
		<span class="w">unlock_page</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>
	<span class="c">return</span> <span class="pc">re</span><span class="c">t;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_readpages</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*</span><span class="pc">filp</span><span class="c">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
			   <span class="c">struct</span> <span class="w">l</span><span class="c">ist_head</span> <span class="c">*</span><span class="w">p</span><span class="pc">ages,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">n</span><span class="pc">r_</span><span class="c">pages)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">,</span> <span class="w">e</span><span class="pc">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*inode</span> <span class="pc">=</span> <span class="w">map</span><span class="pc">p</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ocfs2_inode_info</span> <span class="c">*</span><span class="w">oi</span> <span class="c">=</span> <span class="w">OCFS2_I</span><span class="c">(</span><span class="pc">i</span><span class="c">node);</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">s</span><span class="pc">tar</span><span class="c">t</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*</span><span class="w">la</span><span class="pc">s</span><span class="c">t;</span>

	
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock_full</span><span class="c">(</span><span class="pc">i</span><span class="c">node,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">0,</span> <span class="w">OCFS2_LOCK_NONBLOCK</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="c">return</span> <span class="w">e</span><span class="c">rr;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">down_read_trylock</span><span class="pc">(&amp;</span><span class="c">oi-&gt;</span><span class="w">ip_alloc_sem) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0) {</span>
		<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">0</span><span class="c">);</span>
		<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(oi</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_u</span><span class="c">nlock;</span>

	
	<span class="w">la</span><span class="c">st</span> <span class="c">=</span> <span class="w">l</span><span class="c">ist_entry(</span><span class="w">pag</span><span class="pc">es-</span><span class="c">&gt;</span><span class="w">p</span><span class="pc">re</span><span class="c">v,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="c">age,</span> <span class="w">lru</span><span class="c">);</span>
	<span class="w">st</span><span class="pc">ar</span><span class="c">t</span> <span class="w">=</span><span class="pc"> (</span><span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span><span class="pc">)</span><span class="w">la</span><span class="c">st-&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="pc">t</span><span class="c">art</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">i_size_read(in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">unlock;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">mpage_readpages</span><span class="c">(</span><span class="w">m</span><span class="pc">ap</span><span class="c">ping,</span> <span class="w">pa</span><span class="pc">ges</span><span class="c">,</span> <span class="w">n</span><span class="pc">r</span><span class="c">_pages</span><span class="pc">,</span> <span class="w">ocfs2_get_block</span><span class="c">);</span>

<span class="w">ou</span><span class="pc">t_</span><span class="c">unlock:</span>
	<span class="w">up_read</span><span class="pc">(&amp;</span><span class="w">oi</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_alloc_sem</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ocfs2_inode_unlock</span><span class="pc">(i</span><span class="c">node</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_writepage</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="pc">p</span><span class="c">age,</span> <span class="c">struct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">wbc</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">trace_ocfs2_writepage</span><span class="c">(</span>
		<span class="w">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">app</span><span class="c">ing</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ho</span><span class="c">st</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
		<span class="pc">p</span><span class="c">age</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">ndex</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">block_write_full_page</span><span class="c">(page,</span> <span class="w">ocfs2_get_block</span><span class="c">,</span> <span class="w">w</span><span class="c">bc</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">walk_page_buffers</span><span class="c">(</span>	<span class="w">handle_t</span> <span class="c">*</span><span class="w">h</span><span class="c">andle,</span>
			<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">h</span><span class="c">ead,</span>
			<span class="pc">u</span><span class="c">nsigned</span> <span class="w">fr</span><span class="c">om</span><span class="pc">,</span>
			<span class="c">unsigned</span> <span class="w">to</span><span class="pc">,</span>
			<span class="pc">i</span><span class="c">nt</span> <span class="c">*</span><span class="w">partial</span><span class="pc">,</span>
			<span class="pc">i</span><span class="c">nt</span> <span class="pc">(</span><span class="c">*</span><span class="w">f</span><span class="pc">n</span><span class="c">)(</span>	<span class="w">h</span><span class="c">andle_t</span> <span class="c">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">,</span>
					<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="pc">*</span><span class="w">b</span><span class="c">h</span><span class="w">)</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">b</span><span class="c">h</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="w">block_start</span><span class="pc">,</span> <span class="w">block_end</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="w">blocksize</span> <span class="pc">=</span> <span class="w">he</span><span class="pc">a</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">r</span><span class="pc">e</span><span class="c">t</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bu</span><span class="pc">ff</span><span class="c">er_head</span> <span class="c">*</span><span class="w">n</span><span class="pc">e</span><span class="c">xt;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span>	<span class="w">bh</span> <span class="c">=</span> <span class="w">h</span><span class="c">ead</span><span class="pc">,</span> <span class="w">b</span><span class="pc">lock_s</span><span class="c">tart</span> <span class="w">=</span> <span class="c">0;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="w">==</span> <span class="c">0</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">(</span><span class="w">bh</span> <span class="w">!</span><span class="c">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="pc">block_s</span><span class="c">tart</span><span class="w">)</span><span class="pc">;</span>
	    	<span class="w">b</span><span class="c">lock_start</span> <span class="c">=</span> <span class="w">block_end,</span> <span class="w">bh</span> <span class="w">=</span> <span class="w">ne</span><span class="c">xt</span><span class="w">)</span>
	<span class="pc">{</span>
		<span class="w">ne</span><span class="pc">x</span><span class="c">t</span> <span class="c">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">lock_end</span> <span class="c">=</span> <span class="w">b</span><span class="pc">lock_s</span><span class="c">tart</span> <span class="pc">+</span> <span class="w">blocksize</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">block_e</span><span class="c">nd</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">f</span><span class="pc">ro</span><span class="c">m</span> <span class="pc">|</span><span class="c">|</span> <span class="c">block_start</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">to</span><span class="pc">)</span><span class="c"> {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">partial</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">)</span>
				<span class="w">*</span><span class="pc">p</span><span class="c">artial</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
			<span class="w">co</span><span class="pc">nt</span><span class="c">inue;</span>
		<span class="c">}</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">= (*f</span><span class="pc">n</span><span class="w">)</span><span class="pc">(</span><span class="w">h</span><span class="pc">a</span><span class="c">ndle,</span> <span class="w">bh</span><span class="c">);</span>
		<span class="c">if</span> <span class="pc">(!r</span><span class="c">et)</span>
			<span class="pc">ret</span> <span class="c">=</span> <span class="w">e</span><span class="pc">r</span><span class="c">r;</span>
	<span class="w">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">se</span><span class="pc">c</span><span class="c">tor_t</span> <span class="w">ocfs2_bmap</span><span class="c">(struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span> <span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span> <span class="w">b</span><span class="pc">l</span><span class="c">ock</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">se</span><span class="pc">c</span><span class="c">tor_t</span> <span class="w">s</span><span class="pc">t</span><span class="c">atus</span><span class="pc">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">p_blkno</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*inode</span> <span class="c">=</span> <span class="w">map</span><span class="pc">p</span><span class="c">ing-&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">;</span>

	<span class="w">trace_ocfs2_bmap((</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">l</span><span class="c">ong)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
			 <span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">bl</span><span class="c">ock</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">INODE_JOURNAL</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock</span><span class="c">(inode,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(err</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">!</span><span class="c">= -</span><span class="pc">E</span><span class="c">NOENT)</span>
				<span class="w">mlog_errno</span><span class="c">(</span><span class="w">e</span><span class="c">rr</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>
		<span class="w">down_read</span><span class="pc">(&amp;</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_alloc_sem</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="c">if</span> <span class="pc">(!(</span><span class="w">O</span><span class="c">CFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="c">))</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">ocfs2_extent_map_get_blocks</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">bl</span><span class="c">ock</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_blkno</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span>
						  <span class="pc">N</span><span class="c">ULL);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">INODE_JOURNAL</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">up_read</span><span class="pc">(&amp;</span><span class="w">O</span><span class="pc">CFS2_I</span><span class="w">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">i</span><span class="pc">p_a</span><span class="c">lloc_sem</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ocfs2_inode_unlock</span><span class="c">(inode,</span> <span class="w">0</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="pc">, "</span><span class="w">get_blocks(</span><span class="c">)</span> <span class="c">failed</span><span class="w">,</span> <span class="w">bl</span><span class="c">ock</span> <span class="w">=</span><span class="pc"> </span><span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u\n",</span>
		     <span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">b</span><span class="pc">l</span><span class="c">ock</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">e</span><span class="pc">rr</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

<span class="w">ba</span><span class="pc">i</span><span class="c">l</span><span class="pc">:</span>
	<span class="w">st</span><span class="c">atus</span> <span class="c">=</span> <span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="w">?</span> <span class="c">0</span> <span class="c">:</span> <span class="w">p_blkno</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">s</span><span class="c">tatus;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_direct_IO_get_blocks</span><span class="c">(struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*inode,</span> <span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span> <span class="w">iblock</span><span class="c">,</span>
				     <span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">bh_result</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cr</span><span class="pc">e</span><span class="c">ate)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">re</span><span class="c">t;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">cpos</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">alloc_locked</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">p_blkno</span><span class="pc">,</span> <span class="w">inode_blocks</span><span class="pc">,</span> <span class="w">contig_blocks</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ext_flags</span><span class="pc">;</span>
	<span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">blocksize_bits</span> <span class="pc">=</span> <span class="w">ino</span><span class="pc">de</span><span class="c">-&gt;</span><span class="w">i</span><span class="pc">_</span><span class="c">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_blocksize_bits</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">max_blocks</span> <span class="pc">=</span> <span class="w">bh_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">ino</span><span class="pc">de</span><span class="c">-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="pc">=</span> <span class="pc">b</span><span class="c">h_result-&gt;</span><span class="pc">b_</span><span class="c">size;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">clusters_to_alloc</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">contig_clusters</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">cpos</span> <span class="pc">=</span> <span class="w">ocfs2_blocks_to_clusters</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span> <span class="w">iblock</span><span class="pc">)</span><span class="c">;</span>

	

	<span class="w">inode_blocks</span> <span class="pc">=</span> <span class="w">ocfs2_blocks_for_bytes</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">i</span><span class="pc">node))</span><span class="c">;</span>

	
	<span class="w">re</span><span class="pc">t</span> <span class="c">=</span> <span class="w">ocfs2_extent_map_get_blocks</span><span class="c">(</span><span class="pc">i</span><span class="c">node,</span> <span class="pc">i</span><span class="c">block</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_blkno</span><span class="pc">,</span>
					  <span class="pc">&amp;</span><span class="w">contig_blocks</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ext_flags</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="pc">, </span><span class="c">"</span><span class="w">get_blocks(</span><span class="pc">)</span> <span class="c">failed</span> <span class="w">i</span><span class="pc">b</span><span class="c">lock</span><span class="w">=</span><span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u\n",</span>
		     <span class="w">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">i</span><span class="c">block</span><span class="w">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
	<span class="c">}</span>

	
	<span class="w">B</span><span class="c">UG_ON(</span><span class="w">cr</span><span class="pc">ea</span><span class="c">te</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">(ext_flags</span> <span class="w">&amp;</span> <span class="w">OCFS2_EXT_REFCOUNTED</span><span class="pc">));</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">p_blkno</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">cr</span><span class="pc">ea</span><span class="c">te</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="pc">1)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
			<span class="c">goto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>

		<span class="w">alloc_locked</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>

		
		<span class="w">clusters_to_alloc</span> <span class="pc">=</span> <span class="w">ocfs2_clusters_for_bytes</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">contig_clusters</span> <span class="pc">=</span> <span class="w">ocfs2_clusters_for_blocks</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span>
				<span class="w">contig_blocks</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">l</span><span class="c">usters_to_alloc</span> <span class="w">&gt;</span> <span class="pc">c</span><span class="c">ontig_clusters</span><span class="pc">)</span>
			<span class="pc">c</span><span class="c">lusters_to_alloc</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ontig_clusters;</span>

		
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_extend_allocation</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">cpos</span><span class="c">,</span>
				<span class="pc">cl</span><span class="c">usters_to_alloc,</span> <span class="pc">0)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>

		<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_extent_map_get_blocks</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">iblock</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_blkno</span><span class="pc">,</span>
				<span class="pc">&amp;</span><span class="w">contig_blocks</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ext_flags</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog</span><span class="c">(</span><span class="w">ML_ERROR</span><span class="pc">, "</span><span class="w">get_blocks(</span><span class="pc">)</span> <span class="c">failed</span> <span class="w">ib</span><span class="c">lock</span><span class="w">=%l</span><span class="pc">l</span><span class="c">u\n",</span>
					<span class="w">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="pc">i</span><span class="c">block</span><span class="w">)</span><span class="c">;</span>
			<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">b</span><span class="pc">ai</span><span class="c">l;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">p_blkno</span> <span class="w">&amp;&amp; !(ext_flags</span> <span class="w">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN</span><span class="c">))</span>
		<span class="w">map_bh</span><span class="c">(</span><span class="w">bh_result</span><span class="pc">,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span> <span class="c">p_blkno</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">clear_buffer_mapped</span><span class="c">(</span><span class="pc">b</span><span class="c">h_result);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">max_blocks</span> <span class="w">&lt;</span> <span class="w">contig_blocks</span><span class="pc">)</span>
		<span class="w">c</span><span class="pc">ontig</span><span class="c">_blocks</span> <span class="c">=</span> <span class="pc">m</span><span class="c">ax_blocks;</span>
	<span class="w">b</span><span class="c">h_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span> <span class="c">=</span> <span class="w">c</span><span class="c">ontig_blocks</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">blocksize_bits</span><span class="c">;</span>
<span class="w">bai</span><span class="c">l</span><span class="pc">:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">alloc_locked</span><span class="pc">)</span>
		<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">1</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">re</span><span class="c">t;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">ocfs2_dio_end_io</span><span class="c">(struct</span> <span class="w">kiocb</span> <span class="c">*</span><span class="w">iocb</span><span class="pc">,</span>
			     <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">o</span><span class="c">ffset,</span>
			     <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">b</span><span class="c">ytes</span><span class="pc">,</span>
			     <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">pr</span><span class="pc">iva</span><span class="c">te)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="pc">in</span><span class="c">ode</span> <span class="c">=</span> <span class="w">file_inode</span><span class="c">(iocb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ki_filp</span><span class="c">);</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">le</span><span class="pc">v</span><span class="c">el</span><span class="pc">;</span>

	
	<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">ocfs2_iocb_is_rw_locked</span><span class="c">(iocb</span><span class="pc">));</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">ocfs2_iocb_is_unaligned_aio</span><span class="c">(iocb</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">ocfs2_iocb_clear_unaligned_aio</span><span class="c">(iocb</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_unaligned_aio</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="w">ocfs2_iocb_clear_rw_locked</span><span class="c">(iocb);</span>

	<span class="w">le</span><span class="c">vel</span> <span class="c">=</span> <span class="w">ocfs2_iocb_rw_locked_level</span><span class="c">(iocb);</span>
	<span class="w">ocfs2_rw_unlock</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="w">l</span><span class="pc">ev</span><span class="c">el);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">ocfs2_releasepage</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="pc">p</span><span class="c">age,</span> <span class="w">g</span><span class="c">fp_t</span> <span class="w">w</span><span class="pc">a</span><span class="c">it)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">page_has_buffers</span><span class="c">(page))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">try_to_free_buffers</span><span class="c">(</span><span class="pc">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">ocfs2_is_overwrite</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b,</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*inode,</span> <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">v_cpos</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">p_cpos</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">num_clusters</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ext_flags</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">v</span><span class="pc">_</span><span class="c">cpos</span> <span class="c">=</span> <span class="w">ocfs2_bytes_to_clusters</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="pc">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_get_clusters</span><span class="c">(</span><span class="w">ino</span><span class="c">de,</span> <span class="pc">v</span><span class="c">_cpos</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">p</span><span class="c">_cpos</span><span class="pc">,</span>
			<span class="w">&amp;</span><span class="c">num_clusters</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">e</span><span class="c">xt_flags);</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="c">_cpos</span> <span class="w">&amp;&amp; !(e</span><span class="c">xt_flags</span> <span class="pc">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">1</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_direct_IO_zero_extend</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b,</span>
		<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode</span><span class="pc">,</span> <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">o</span><span class="c">ffset,</span>
		<span class="w">u6</span><span class="c">4</span> <span class="w">zero_len</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cluster_align</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">p</span><span class="c">_cpos</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">u3</span><span class="c">2</span> <span class="w">v_cpos</span> <span class="c">=</span> <span class="w">ocfs2_bytes_to_clusters</span><span class="pc">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)</span><span class="c">);</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">num_clusters</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ext_flags</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">i</span><span class="pc">_</span><span class="c">size_read</span><span class="w">(i</span><span class="pc">n</span><span class="c">ode</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span> <span class="w">cluster_align</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_get_clusters</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="w">v_cpos</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_cpos</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">n</span><span class="c">um_clusters</span><span class="pc">,</span>
			<span class="pc">&amp;</span><span class="c">ext_flags);</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="c">_cpos</span> <span class="w">&amp;&amp; !(e</span><span class="c">xt_flags</span> <span class="pc">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN</span><span class="pc">))</span><span class="c"> {</span>
		<span class="w">u6</span><span class="c">4</span> <span class="w">s</span> <span class="c">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">sec</span><span class="pc">t</span><span class="c">or_t</span> <span class="w">sector</span> <span class="w">= </span><span class="pc">((</span><span class="w">u</span><span class="pc">6</span><span class="c">4)</span><span class="w">p</span><span class="c">_cpos</span> <span class="w">&lt;&lt;</span><span class="pc"> </span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-&gt;</span><span class="w">s_clustersize_bits</span> <span class="c">-</span> <span class="w">9)) +</span>
			<span class="c">(</span><span class="w">do_div(</span><span class="pc">s,</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_clustersize) &gt;</span><span class="c">&gt;</span> <span class="w">9</span><span class="pc">);</span>

		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">blkdev_issue_zeroout</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="c">,</span> <span class="pc">s</span><span class="c">ector</span><span class="pc">,</span>
				<span class="w">zero_len</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">9</span><span class="pc">,</span> <span class="w">GFP_NOFS</span><span class="pc">,</span> <span class="w">f</span><span class="c">alse);</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="c">&lt;</span> <span class="c">0</span><span class="pc">)</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">retu</span><span class="c">rn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_direct_IO_extend_no_holes</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b,</span>
		<span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*inode,</span> <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">o</span><span class="pc">ff</span><span class="c">set</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">zero_start</span><span class="pc">,</span> <span class="w">zero_len</span><span class="pc">,</span> <span class="w">total_zero_len</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">p_cpos</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">clusters_to_add</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">v_cpos</span> <span class="c">=</span> <span class="w">ocfs2_bytes_to_clusters</span><span class="pc">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">,</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">);</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">num_clusters</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ext_flags</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">size_div</span><span class="pc">,</span> <span class="w">offset_div</span><span class="c">;</span>
	<span class="c">int</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">{</span>
		<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">o</span> <span class="pc">=</span> <span class="w">o</span><span class="pc">ffset</span><span class="c">;</span>
		<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">s</span> <span class="c">=</span> <span class="w">i</span><span class="c">_size_read(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">o</span><span class="c">ffset_div</span> <span class="pc">=</span> <span class="w">do_div</span><span class="c">(</span><span class="w">o</span><span class="c">,</span> <span class="w">os</span><span class="c">b</span><span class="w">-</span><span class="c">&gt;</span><span class="w">s_clustersize</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">s</span><span class="c">ize_div</span> <span class="c">=</span> <span class="w">d</span><span class="c">o_div(</span><span class="w">s</span><span class="c">,</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;s_clustersize);</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">o</span><span class="pc">ffset</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">i</span><span class="c">_size_read</span><span class="w">(in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">clusters_to_add</span> <span class="pc">=</span> <span class="w">ocfs2_bytes_to_clusters</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">sb</span><span class="c">,</span> <span class="w">o</span><span class="pc">ffset</span><span class="w">) -</span>
		<span class="w">o</span><span class="c">cfs2_bytes_to_clusters</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_</span><span class="c">sb</span><span class="pc">,</span> <span class="w">i</span><span class="c">_size_read</span><span class="w">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">total_zero_len</span> <span class="pc">=</span> <span class="w">of</span><span class="pc">fset</span> <span class="pc">-</span> <span class="w">i</span><span class="c">_size_read</span><span class="pc">(</span><span class="c">inode);</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">c</span><span class="c">lusters_to_add</span><span class="pc">)</span>
		<span class="pc">t</span><span class="c">otal_zero_len</span> <span class="w">-</span><span class="pc">=</span> <span class="w">offset_div</span><span class="pc">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">lusters_to_add</span> <span class="pc">&gt;</span> <span class="pc">1) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">e</span><span class="c">t</span> <span class="c">=</span> <span class="w">ocfs2_extend_allocation</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span>
				<span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_clusters</span><span class="c">,</span>
				<span class="pc">c</span><span class="c">lusters_to_add</span> <span class="w">-</span> <span class="c">1</span><span class="pc">,</span> <span class="c">0);</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">total_zero_len</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">ret</span> <span class="c">=</span> <span class="w">ocfs2_get_clusters</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">v_cpos</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_cpos</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">num_clusters</span><span class="c">,</span>
				<span class="pc">&amp;</span><span class="w">ext_flags</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="w">m</span><span class="c">log_errno(</span><span class="w">r</span><span class="c">et);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>

		<span class="w">zero_start</span> <span class="pc">=</span> <span class="w">ocfs2_clusters_to_bytes</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">,</span> <span class="pc">p</span><span class="c">_cpos</span><span class="w">) +</span>
			<span class="w">size_div</span><span class="pc">;</span>
		<span class="w">zero_len</span> <span class="pc">=</span> <span class="w">o</span><span class="c">cfs2_clusters_to_bytes(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="w">n</span><span class="c">um_clusters</span><span class="w">) -</span>
			<span class="pc">s</span><span class="c">ize_div;</span>
		<span class="pc">z</span><span class="c">ero_len</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">i</span><span class="c">n(</span><span class="w">total_zero_len</span><span class="c">,</span> <span class="pc">z</span><span class="c">ero_len);</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="c">_cpos</span> <span class="w">&amp;&amp; !(ext_flags</span> <span class="w">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">blkdev_issue_zeroout</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="c">,</span>
					<span class="w">zero_start</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">9</span><span class="pc">,</span> <span class="pc">z</span><span class="c">ero_len</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">9</span><span class="pc">,</span>
					<span class="w">GFP_NOFS</span><span class="c">,</span> <span class="pc">f</span><span class="c">alse);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span> <span class="c">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
			<span class="c">}</span>
		<span class="pc">}</span>

		<span class="w">total_zero_len</span> <span class="w">-</span><span class="pc">=</span> <span class="pc">zero_l</span><span class="c">en;</span>
		<span class="w">v_cpos</span> <span class="w">+</span><span class="pc">=</span> <span class="w">ocfs2_bytes_to_clusters</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="c">zero_len</span> <span class="w">+</span> <span class="w">size_div</span><span class="pc">)</span><span class="c">;</span>

		
		<span class="w">si</span><span class="c">ze_div</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
	<span class="pc">}</span>

<span class="w">o</span><span class="pc">u</span><span class="c">t:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">ocfs2_direct_IO_write</span><span class="c">(struct</span> <span class="w">kiocb</span> <span class="c">*</span><span class="w">iocb</span><span class="c">,</span>
		<span class="c">struct</span> <span class="w">iov_iter</span> <span class="c">*</span><span class="w">it</span><span class="pc">er</span><span class="c">,</span>
		<span class="w">l</span><span class="c">off_t</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">ss</span><span class="c">ize_t</span> <span class="w">written</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">bo</span><span class="c">ol</span> <span class="w">orphaned</span> <span class="c">=</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="c">int</span> <span class="w">is_overwrite</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*</span><span class="pc">file</span> <span class="c">=</span> <span class="w">i</span><span class="pc">oc</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ki_filp</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span> <span class="c">*inode</span> <span class="pc">=</span> <span class="w">file_inode</span><span class="c">(</span><span class="pc">f</span><span class="c">ile</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">i_mapping-</span><span class="pc">&gt;</span><span class="w">ho</span><span class="c">st</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="c">=</span> <span class="w">OCFS2_SB</span><span class="c">(inode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b);</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er_head</span> <span class="c">*</span><span class="w">di_bh</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="w">si</span><span class="c">ze_t</span> <span class="w">c</span><span class="c">ount</span> <span class="pc">=</span> <span class="w">i</span><span class="pc">t</span><span class="c">er-&gt;</span><span class="w">c</span><span class="c">ount;</span>
	<span class="w">journal_t</span> <span class="pc">*</span><span class="w">j</span><span class="pc">ournal</span> <span class="c">=</span> <span class="w">os</span><span class="c">b-&gt;</span><span class="w">j</span><span class="pc">ournal</span><span class="c">-&gt;</span><span class="w">j_journal</span><span class="c">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">zero_len_head</span><span class="pc">,</span> <span class="w">zero_len_tail</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">cluster_align_head</span><span class="pc">,</span> <span class="w">cluster_align_tail</span><span class="c">;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">final_size</span> <span class="pc">=</span> <span class="w">o</span><span class="c">ffset</span> <span class="pc">+</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">append_write</span> <span class="c">=</span> <span class="w">o</span><span class="c">ffset</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">) </span><span class="pc">?</span> <span class="w">1</span> <span class="c">:</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">num_clusters</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ext_flags</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">{</span>
		<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">o</span> <span class="c">=</span> <span class="w">o</span><span class="c">ffset;</span>
		<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">s</span> <span class="c">=</span> <span class="w">i</span><span class="pc">_</span><span class="c">size_read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">zero_len_head</span> <span class="pc">=</span> <span class="w">do_div</span><span class="c">(</span><span class="w">o</span><span class="c">,</span> <span class="w">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">os</span><span class="c">b</span><span class="w">-</span><span class="c">&gt;</span><span class="w">s_clustersize_bits</span><span class="c">);</span>
		<span class="w">cluster_align_head</span> <span class="w">= !z</span><span class="c">ero_len_head</span><span class="w">;</span>

		<span class="w">zero_len_tail</span> <span class="pc">=</span> <span class="w">os</span><span class="c">b-&gt;</span><span class="w">s_clustersize</span> <span class="pc">-</span>
			<span class="w">d</span><span class="c">o_div</span><span class="w">(s</span><span class="pc">,</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">_clustersize</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">((</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">-</span> <span class="w">i</span><span class="c">_size_read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">)) &lt;</span> <span class="pc">z</span><span class="c">ero_len_tail)</span>
			<span class="w">z</span><span class="pc">ero_len_t</span><span class="c">ail</span> <span class="pc">=</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="pc">-</span> <span class="w">i</span><span class="c">_size_read</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">cluster_align_tail</span> <span class="w">=</span><span class="pc"> !z</span><span class="c">ero_len_tail</span><span class="w">;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">final_size</span> <span class="pc">&gt;</span> <span class="w">i</span><span class="c">_size_read</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_add_inode_to_orphan</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
		<span class="w">orphaned</span> <span class="pc">=</span> <span class="pc">t</span><span class="c">rue;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">append_write</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">ret</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="pc">1)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">m</span><span class="c">log_errno(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>
			<span class="c">goto</span> <span class="w">clean_orphan</span><span class="c">;</span>
		<span class="c">}</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">ocfs2_sparse_alloc</span><span class="c">(</span><span class="w">OCFS2_SB</span><span class="pc">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="w">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="w">)</span><span class="pc">))</span>
			<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_direct_IO_zero_extend</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">of</span><span class="c">fset,</span>
					<span class="w">zero_len_tail</span><span class="pc">,</span> <span class="w">cluster_align_tail</span><span class="c">);</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_direct_IO_extend_no_holes</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">ino</span><span class="c">de,</span>
					<span class="w">o</span><span class="pc">f</span><span class="c">fset);</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>
			<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">clean_orphan</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="w">is_overwrite</span> <span class="pc">=</span> <span class="w">ocfs2_is_overwrite</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">of</span><span class="c">fset);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">i</span><span class="c">s_overwrite</span> <span class="w">&lt;</span> <span class="c">0) {</span>
			<span class="pc">m</span><span class="c">log_errno(is_overwrite</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">o</span><span class="c">cfs2_inode_unlock(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="pc">c</span><span class="c">lean_orphan;</span>
		<span class="c">}</span>

		<span class="w">o</span><span class="pc">cfs2_in</span><span class="c">ode_unlock(</span><span class="pc">in</span><span class="c">ode,</span> <span class="w">1</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="w">written</span> <span class="pc">=</span> <span class="w">__blockdev_direct_IO</span><span class="c">(</span><span class="w">iocb</span><span class="c">,</span> <span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="pc">,</span> <span class="w">it</span><span class="pc">er,</span>
				       <span class="w">of</span><span class="c">fset</span><span class="pc">,</span> <span class="w">ocfs2_direct_IO_get_blocks</span><span class="c">,</span>
				       <span class="w">ocfs2_dio_end_io</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely(written</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">lof</span><span class="c">f_t</span> <span class="w">i_size</span> <span class="c">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">of</span><span class="c">fset</span> <span class="w">+</span> <span class="w">c</span><span class="c">ount</span> <span class="pc">&gt;</span> <span class="pc">i</span><span class="c">_size) {</span>
			<span class="pc">ret</span> <span class="pc">=</span> <span class="w">ocfs2_inode_lock</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">di_bh</span><span class="c">,</span> <span class="pc">1)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">clean_orphan</span><span class="c">;</span>
			<span class="c">}</span>

			<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="c">_size</span> <span class="pc">=</span><span class="c">=</span> <span class="w">i</span><span class="pc">_size_</span><span class="c">read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)) </span><span class="c">{</span>
				<span class="c">ret</span> <span class="c">=</span> <span class="w">ocfs2_truncate_file</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="c">di_bh,</span>
						<span class="w">i</span><span class="c">_size</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
					<span class="w">i</span><span class="c">f</span> <span class="c">(ret</span> <span class="w">!</span><span class="pc">= </span><span class="c">-</span><span class="w">ENOSPC</span><span class="c">)</span>
						<span class="w">m</span><span class="c">log_errno(</span><span class="w">r</span><span class="c">et);</span>

					<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">1</span><span class="c">);</span>
					<span class="w">brelse</span><span class="c">(</span><span class="pc">di</span><span class="c">_bh);</span>
					<span class="pc">g</span><span class="c">oto</span> <span class="w">clean_orphan</span><span class="c">;</span>
				<span class="c">}</span>
			<span class="pc">}</span>

			<span class="w">o</span><span class="pc">cfs2_i</span><span class="c">node_unlock(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
			<span class="w">b</span><span class="c">relse(</span><span class="w">d</span><span class="pc">i</span><span class="c">_bh</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">jbd2_journal_force_commit</span><span class="c">(</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0)</span>
				<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>
		<span class="w">}</span>
	<span class="w">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">written</span> <span class="w">&gt;</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">append_write</span> <span class="w">&amp;</span><span class="pc">&amp; !</span><span class="w">is_overwrite</span> <span class="w">&amp;</span><span class="c">&amp;</span>
			<span class="pc">!</span><span class="w">cluster_align_head)</span><span class="pc"> </span><span class="c">{</span>
		
		<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">p_cpos</span> <span class="c">=</span> <span class="c">0;</span>
		<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">v_cpos</span> <span class="c">=</span> <span class="w">ocfs2_bytes_to_clusters</span><span class="pc">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="w">o</span><span class="c">ffset);</span>

		<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">clean_orphan</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_get_clusters</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="pc">v</span><span class="c">_cpos</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_cpos</span><span class="pc">,</span>
				<span class="pc">&amp;</span><span class="w">num_clusters</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ext_flags</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">m</span><span class="c">log_errno(</span><span class="w">r</span><span class="c">et);</span>
			<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">c</span><span class="c">lean_orphan;</span>
		<span class="c">}</span>

		<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!p</span><span class="c">_cpos</span> <span class="w">|</span><span class="pc">| (e</span><span class="c">xt_flags</span> <span class="pc">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN))</span><span class="pc">;</span>

		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">blkdev_issue_zeroout</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="pc">,</span>
				<span class="w">(u</span><span class="pc">6</span><span class="c">4)</span><span class="pc">p</span><span class="c">_cpos</span> <span class="w">&lt;&lt;</span><span class="pc"> </span><span class="c">(</span><span class="w">os</span><span class="c">b-&gt;</span><span class="w">s_clustersize_bits</span> <span class="pc">-</span> <span class="w">9</span><span class="pc">),</span>
				<span class="w">zero_len_head</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">9</span><span class="pc">,</span> <span class="w">GFP_NOFS</span><span class="c">,</span> <span class="w">f</span><span class="c">alse);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span> <span class="c">&lt;</span> <span class="c">0)</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>

		<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

<span class="w">clean_orphan</span><span class="pc">:</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">orphaned</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">tmp_ret</span><span class="pc">;</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">update_isize</span> <span class="pc">=</span> <span class="w">written</span> <span class="w">&gt;</span> <span class="c">0</span> <span class="pc">?</span> <span class="pc">1</span> <span class="c">:</span> <span class="c">0;</span>
		<span class="w">lof</span><span class="c">f_t</span> <span class="w">e</span><span class="pc">n</span><span class="c">d</span> <span class="c">=</span> <span class="c">update_isize</span> <span class="w">?</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">+</span> <span class="w">w</span><span class="c">ritten</span> <span class="w">:</span> <span class="c">0;</span>

		<span class="w">t</span><span class="pc">mp_</span><span class="c">ret</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">, &amp;</span><span class="w">di_bh</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="pc">m</span><span class="c">p_ret</span> <span class="w">&lt;</span> <span class="c">0) {</span>
			<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="c">tmp_ret;</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">ret</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">goto</span> <span class="c">out;</span>
		<span class="c">}</span>

		<span class="w">t</span><span class="c">mp_ret</span> <span class="c">=</span> <span class="w">ocfs2_del_inode_from_orphan</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">ino</span><span class="c">de</span><span class="pc">,</span> <span class="w">d</span><span class="c">i_bh</span><span class="pc">,</span>
				<span class="w">update_isize</span><span class="pc">,</span> <span class="w">e</span><span class="pc">n</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">t</span><span class="c">mp_ret</span> <span class="w">&lt;</span> <span class="c">0) {</span>
			<span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="w">t</span><span class="c">mp_ret</span><span class="pc">;</span>
			<span class="pc">m</span><span class="c">log_errno</span><span class="pc">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
			<span class="c">goto</span> <span class="c">out;</span>
		<span class="c">}</span>

		<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">1</span><span class="c">);</span>

		<span class="w">t</span><span class="c">mp_ret</span> <span class="pc">=</span> <span class="w">jbd2_journal_force_commit</span><span class="c">(</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">t</span><span class="c">mp_ret</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="c">tmp_ret</span><span class="pc">;</span>
			<span class="pc">m</span><span class="c">log_errno(tmp_ret</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">}</span>
	<span class="pc">}</span>

<span class="w">o</span><span class="c">ut:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span> <span class="w">&gt;</span><span class="c">=</span> <span class="c">0)</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">written</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">ocfs2_direct_IO</span><span class="c">(struct</span> <span class="w">kiocb</span> <span class="c">*</span><span class="w">iocb</span><span class="c">,</span> <span class="c">struct</span> <span class="w">iov_iter</span> <span class="c">*</span><span class="w">it</span><span class="pc">er</span><span class="c">,</span>
			       <span class="w">l</span><span class="c">off_t</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">f</span><span class="pc">i</span><span class="c">le</span> <span class="c">*</span><span class="pc">file</span> <span class="c">=</span> <span class="pc">i</span><span class="c">ocb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ki_filp</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode</span> <span class="pc">=</span> <span class="w">file_inode</span><span class="c">(</span><span class="pc">f</span><span class="c">ile</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">i_mapping-</span><span class="c">&gt;</span><span class="w">ho</span><span class="c">st</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="c">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b);</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">full_coherency</span> <span class="w">= !(os</span><span class="c">b-&gt;</span><span class="w">s_mount_opt</span> <span class="w">&amp;</span>
			<span class="w">OCFS2_MOUNT_COHERENCY_BUFFERED</span><span class="c">);</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">i_size_read</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="w">) &lt;=</span> <span class="w">of</span><span class="c">fset</span> <span class="w">&amp;&amp;</span><span class="pc"> !f</span><span class="c">ull_coherency</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">iov_iter_rw</span><span class="c">(</span><span class="w">it</span><span class="pc">er</span><span class="w">)</span><span class="pc"> </span><span class="c">==</span> <span class="w">READ</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">__blockdev_direct_IO</span><span class="c">(</span><span class="w">iocb</span><span class="c">,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode-&gt;</span><span class="w">i_</span><span class="c">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="c">,</span>
					    <span class="w">it</span><span class="pc">er,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset,</span>
					    <span class="w">ocfs2_direct_IO_get_blocks</span><span class="pc">,</span>
					    <span class="w">ocfs2_dio_end_io</span><span class="pc">,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">e</span><span class="c">lse</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">ocfs2_direct_IO_write</span><span class="c">(</span><span class="pc">io</span><span class="c">cb,</span> <span class="w">i</span><span class="pc">t</span><span class="c">er,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">ocfs2_figure_cluster_boundaries</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b,</span>
					    <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">cpos</span><span class="c">,</span>
					    <span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">*</span><span class="w">s</span><span class="pc">tar</span><span class="c">t</span><span class="pc">,</span>
					    <span class="pc">un</span><span class="c">signed</span> <span class="c">int</span> <span class="c">*</span><span class="w">e</span><span class="c">nd)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cluster_start</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">cluster_end</span> <span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely(</span><span class="w">PAGE_CACHE_SHIFT</span> <span class="pc">&gt;</span> <span class="w">os</span><span class="c">b-&gt;</span><span class="w">s_clustersize_bits</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">cpp</span><span class="pc">;</span>

		<span class="w">cp</span><span class="pc">p</span> <span class="c">=</span> <span class="w">1</span> <span class="pc">&lt;&lt; </span><span class="c">(</span><span class="pc">P</span><span class="c">AGE_CACHE_SHIFT</span> <span class="c">-</span> <span class="w">os</span><span class="c">b</span><span class="w">-</span><span class="pc">&gt;</span><span class="c">s_clustersize_bits</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">cl</span><span class="c">uster_start</span> <span class="c">=</span> <span class="w">cpos</span> <span class="w">%</span> <span class="w">c</span><span class="pc">p</span><span class="c">p;</span>
		<span class="w">c</span><span class="pc">l</span><span class="c">uster_start</span> <span class="c">=</span> <span class="w">c</span><span class="pc">luster_s</span><span class="c">tart</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;s_clustersize_bits;</span>

		<span class="w">cluster_end</span> <span class="c">=</span> <span class="pc">cl</span><span class="c">uster_start</span> <span class="pc">+</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_clustersize</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">B</span><span class="c">UG_ON(</span><span class="pc">cluster_s</span><span class="c">tart</span> <span class="pc">&gt;</span> <span class="w">P</span><span class="c">AGE_SIZE</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">B</span><span class="c">UG_ON(cluster_end</span> <span class="pc">&gt;</span> <span class="w">P</span><span class="pc">AGE_S</span><span class="c">IZE</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="pc">t</span><span class="c">art</span><span class="pc">)</span>
		<span class="w">*st</span><span class="pc">ar</span><span class="c">t</span> <span class="c">=</span> <span class="w">c</span><span class="pc">luster_s</span><span class="c">tart</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="c">nd</span><span class="pc">)</span>
		<span class="pc">*</span><span class="w">e</span><span class="c">nd</span> <span class="c">=</span> <span class="pc">cluster_e</span><span class="c">nd</span><span class="pc">;</span>
<span class="w">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">ocfs2_clear_page_regions</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="pc">p</span><span class="c">age,</span>
				     <span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">cpos</span><span class="c">,</span>
				     <span class="pc">un</span><span class="c">signed</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="w">t</span><span class="pc">o)</span>
<span class="c">{</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">kaddr</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">cluster_start</span><span class="pc">,</span> <span class="w">c</span><span class="pc">luster_e</span><span class="c">nd;</span>

	<span class="w">ocfs2_figure_cluster_boundaries</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="pc">cp</span><span class="c">os</span><span class="pc">, </span><span class="c">&amp;cluster_start</span><span class="pc">, </span><span class="c">&amp;cluster_end);</span>

	<span class="w">k</span><span class="c">addr</span> <span class="pc">=</span> <span class="w">kmap_atomic</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">fr</span><span class="c">om</span> <span class="w">|</span><span class="c">|</span> <span class="w">to)</span><span class="pc"> {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">fr</span><span class="c">om</span> <span class="c">&gt;</span> <span class="pc">cluster_s</span><span class="c">tart</span><span class="pc">)</span>
			<span class="w">me</span><span class="pc">ms</span><span class="c">et(</span><span class="pc">k</span><span class="c">addr</span> <span class="w">+</span> <span class="w">c</span><span class="pc">luster_s</span><span class="c">tart,</span> <span class="pc">0</span><span class="c">,</span> <span class="w">f</span><span class="pc">ro</span><span class="c">m</span> <span class="pc">-</span> <span class="pc">cluster_s</span><span class="c">tart);</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">to</span> <span class="pc">&lt;</span> <span class="w">c</span><span class="pc">luster_e</span><span class="c">nd)</span>
			<span class="w">m</span><span class="pc">ems</span><span class="c">et(kaddr</span> <span class="pc">+</span> <span class="w">to</span><span class="c">,</span> <span class="pc">0</span><span class="c">,</span> <span class="pc">c</span><span class="c">luster_end</span> <span class="w">-</span> <span class="w">t</span><span class="pc">o)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">{</span>
		<span class="w">m</span><span class="pc">ems</span><span class="c">et(kaddr</span> <span class="pc">+</span> <span class="w">c</span><span class="c">luster_start,</span> <span class="c">0,</span> <span class="pc">c</span><span class="c">luster_end</span> <span class="pc">-</span> <span class="pc">cluster_s</span><span class="c">tart);</span>
	<span class="c">}</span>

	<span class="w">kunmap_atomic</span><span class="c">(kaddr</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">ocfs2_should_read_blk</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="pc">p</span><span class="c">age</span><span class="pc">,</span>
				 <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">block_start</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">o</span><span class="c">ffset</span> <span class="pc">=</span> <span class="w">page_offset</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="w">)</span><span class="pc"> </span><span class="c">+</span> <span class="pc">b</span><span class="c">lock_start;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ocfs2_sparse_alloc</span><span class="c">(</span><span class="w">OCFS2_SB</span><span class="pc">(i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">)))</span>
		<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i_size_read</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="w">) &gt;</span> <span class="w">of</span><span class="pc">fs</span><span class="c">et)</span>
		<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_map_page_blocks</span><span class="c">(struct</span> <span class="w">p</span><span class="c">age</span> <span class="c">*page,</span> <span class="w">u6</span><span class="c">4</span> <span class="c">*</span><span class="w">p_blkno</span><span class="c">,</span>
			  <span class="pc">st</span><span class="c">ruct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">f</span><span class="pc">r</span><span class="c">om,</span>
			  <span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">t</span><span class="pc">o,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">n</span><span class="pc">e</span><span class="c">w</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bu</span><span class="pc">ff</span><span class="c">er_head</span> <span class="c">*</span><span class="w">h</span><span class="c">ead</span><span class="pc">,</span><span class="c"> *</span><span class="w">bh,</span><span class="pc"> </span><span class="c">*</span><span class="w">w</span><span class="pc">a</span><span class="c">it</span><span class="pc">[</span><span class="w">2], **wait_bh</span> <span class="pc">=</span> <span class="w">wa</span><span class="pc">it</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">block_end</span><span class="pc">,</span> <span class="w">block_start</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">bsize</span> <span class="pc">=</span> <span class="pc">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">ino</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">page_has_buffers</span><span class="c">(</span><span class="w">p</span><span class="c">age))</span>
		<span class="w">create_empty_buffers</span><span class="c">(</span><span class="w">p</span><span class="pc">age</span><span class="c">,</span> <span class="c">bsize,</span> <span class="w">0</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">h</span><span class="pc">ea</span><span class="c">d</span> <span class="c">=</span> <span class="w">page_buffers</span><span class="c">(</span><span class="w">p</span><span class="pc">age</span><span class="c">);</span>
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">bh</span> <span class="c">=</span> <span class="w">h</span><span class="c">ead</span><span class="pc">,</span> <span class="pc">bl</span><span class="c">ock_start</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span> <span class="w">bh</span> <span class="w">!</span><span class="c">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="w">b</span><span class="pc">l</span><span class="c">ock_start</span><span class="pc">;</span>
	     <span class="w">bh</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page,</span> <span class="c">block_start</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">bs</span><span class="c">ize</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">block_end</span> <span class="pc">=</span> <span class="pc">bl</span><span class="c">ock_start</span> <span class="pc">+</span> <span class="pc">bs</span><span class="c">ize;</span>

		<span class="w">clear_buffer_new</span><span class="pc">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(block_start</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">to</span> <span class="w">|</span><span class="c">|</span> <span class="pc">bl</span><span class="c">ock_end</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">f</span><span class="pc">ro</span><span class="c">m) {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e))</span>
				<span class="w">set_buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">c</span><span class="pc">o</span><span class="c">ntinue;</span>
		<span class="c">}</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">n</span><span class="pc">ew)</span>
			<span class="w">set_buffer_new</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">buffer_mapped</span><span class="c">(</span><span class="w">bh</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">map_bh</span><span class="c">(</span><span class="w">bh</span><span class="pc">,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b</span><span class="w">, *p_blkno</span><span class="c">);</span>
			<span class="w">unmap_underlying_metadata</span><span class="c">(</span><span class="w">bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_bdev</span><span class="pc">,</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_blocknr</span><span class="c">);</span>
		<span class="c">}</span>

		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e</span><span class="pc">)</span><span class="c">) {</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="c">))</span>
				<span class="w">set_buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">b</span><span class="c">uffer_uptodate(</span><span class="w">bh) </span><span class="pc">&amp;&amp; </span><span class="c">!</span><span class="w">buffer_delay</span><span class="c">(</span><span class="w">bh) </span><span class="c">&amp;&amp;</span>
			   <span class="pc">!</span><span class="w">buffer_new</span><span class="c">(</span><span class="w">bh</span><span class="pc">) </span><span class="c">&amp;&amp;</span>
			   <span class="w">ocfs2_should_read_blk</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">,</span> <span class="w">pa</span><span class="pc">g</span><span class="c">e,</span> <span class="w">block_start) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
			   <span class="c">(</span><span class="w">bl</span><span class="c">ock_start</span> <span class="w">&lt;</span> <span class="w">fr</span><span class="c">om</span> <span class="w">|</span><span class="c">|</span> <span class="w">block_end</span> <span class="pc">&gt;</span> <span class="w">to))</span><span class="pc"> {</span>
			<span class="w">ll_rw_block</span><span class="c">(</span><span class="w">READ</span><span class="c">,</span> <span class="w">1</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">*wait_bh++=bh</span><span class="pc">;</span>
		<span class="pc">}</span>

		<span class="w">*p_blkno</span> <span class="w">=</span><span class="pc"> *p</span><span class="c">_blkno</span> <span class="w">+</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">}</span>

	
	<span class="w">w</span><span class="pc">h</span><span class="c">ile(</span><span class="w">w</span><span class="c">ait_bh</span> <span class="w">&gt;</span> <span class="w">wa</span><span class="pc">it</span><span class="c">) {</span>
		<span class="w">wait_on_buffer(*--w</span><span class="pc">a</span><span class="c">it_bh</span><span class="w">)</span><span class="pc">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">buffer_uptodate(*</span><span class="pc">w</span><span class="c">ait_bh</span><span class="pc">))</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">= -</span><span class="w">E</span><span class="pc">IO</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">et</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="w">ne</span><span class="pc">w)</span>
		<span class="c">return</span> <span class="pc">r</span><span class="c">et;</span>

	
	<span class="w">bh</span> <span class="pc">=</span> <span class="w">he</span><span class="c">ad;</span>
	<span class="w">block_start</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">d</span><span class="c">o</span> <span class="c">{</span>
		<span class="w">block_end</span> <span class="c">=</span> <span class="pc">b</span><span class="c">lock_start</span> <span class="pc">+</span> <span class="w">bsize</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">block_e</span><span class="c">nd</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m</span><span class="pc">)</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">next_bh</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(block_start</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">to)</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>

		<span class="w">zero_user</span><span class="c">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e,</span> <span class="c">block_start</span><span class="pc">,</span> <span class="w">bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">set_buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">mark_buffer_dirty</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>

<span class="w">n</span><span class="c">ext_bh</span><span class="pc">:</span>
		<span class="pc">b</span><span class="c">lock_start</span> <span class="pc">=</span> <span class="w">b</span><span class="pc">lock_e</span><span class="c">nd</span><span class="pc">;</span>
		<span class="w">bh</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">bh</span> <span class="w">!</span><span class="c">=</span> <span class="w">h</span><span class="pc">ead);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="w">#</span><span class="pc">if</span> <span class="pc">(</span><span class="w">PAGE_CACHE_SIZE</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">OCFS2_MAX_CLUSTERSIZE</span><span class="c">)</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">OCFS2_MAX_CTXT_PAGES</span>	<span class="w">1</span>
<span class="c">#</span><span class="pc">e</span><span class="c">lse</span>
<span class="c">#define</span> <span class="c">OCFS2_MAX_CTXT_PAGES</span>	<span class="c">(</span><span class="w">O</span><span class="c">CFS2_MAX_CLUSTERSIZE</span> <span class="w">/</span> <span class="pc">P</span><span class="c">AGE_CACHE_SIZE)</span>
<span class="c">#endif</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">OCFS2_MAX_CLUSTERS_PER_PAGE</span>	<span class="c">(PAGE_CACHE_SIZE</span> <span class="w">/</span> <span class="w">OCFS2_MIN_CLUSTERSIZE</span><span class="c">)</span>


<span class="pc">str</span><span class="c">uct</span> <span class="w">ocfs2_write_cluster_desc</span> <span class="c">{</span>
	<span class="pc">u3</span><span class="c">2</span>		<span class="w">c_cpos</span><span class="c">;</span>
	<span class="c">u32</span>		<span class="w">c_phys</span><span class="c">;</span>
	
	<span class="pc">un</span><span class="c">signed</span>	<span class="w">c_new</span><span class="c">;</span>
	<span class="c">unsigned</span>	<span class="w">c_unwritten</span><span class="c">;</span>
	<span class="c">unsigned</span>	<span class="w">c_needs_zero</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">{</span>
	
	<span class="pc">u3</span><span class="c">2</span>				<span class="w">w_cpos</span><span class="c">;</span>
	<span class="c">u32</span>				<span class="w">w_clen</span><span class="c">;</span>

	
	<span class="c">u32</span>				<span class="w">w_first_new_cpos</span><span class="c">;</span>

	<span class="pc">s</span><span class="c">truct</span> <span class="c">ocfs2_write_cluster_desc</span>	<span class="w">w_desc</span><span class="pc">[</span><span class="w">OCFS2_MAX_CLUSTERS_PER_PAGE</span><span class="c">];</span>

	
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span>			<span class="w">w_large_pages</span><span class="c">;</span>

	
	<span class="c">unsigned</span> <span class="c">int</span>			<span class="w">w_num_pages</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span>			<span class="c">*</span><span class="w">w_pages</span><span class="pc">[</span><span class="w">OCFS2_MAX_CTXT_PAGES</span><span class="c">];</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span>			<span class="c">*</span><span class="w">w_target_page</span><span class="c">;</span>

	
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span>			<span class="w">w_target_locked</span><span class="pc">:</span><span class="c">1;</span>

	
	<span class="c">unsigned</span> <span class="c">int</span>			<span class="w">w_target_from</span><span class="pc">;</span>
	<span class="c">unsigned</span> <span class="c">int</span>			<span class="w">w_target_to</span><span class="c">;</span>

	
	<span class="w">handle_t</span>			<span class="c">*</span><span class="w">w_handle</span><span class="c">;</span>

	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span>		<span class="c">*</span><span class="w">w_di_bh</span><span class="c">;</span>

	<span class="c">struct</span> <span class="w">ocfs2_cached_dealloc_ctxt</span> <span class="w">w_dealloc</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">ocfs2_unlock_and_free_pages</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="pc">**</span><span class="w">p</span><span class="pc">ages,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">num_pages</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>

	<span class="pc">f</span><span class="c">or(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">n</span><span class="pc">u</span><span class="c">m_pages;</span> <span class="c">i++) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="c">ages[i</span><span class="pc">]) </span><span class="c">{</span>
			<span class="w">unlock_page</span><span class="c">(</span><span class="w">p</span><span class="c">ages[i]);</span>
			<span class="w">mark_page_accessed</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ges[i]);</span>
			<span class="w">page_cache_release</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ges[i]);</span>
		<span class="c">}</span>
	<span class="c">}</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">ocfs2_unlock_pages</span><span class="c">(struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_locked</span><span class="c">) {</span>
		<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_target_page</span><span class="c">);</span>
		<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_num_pages</span><span class="c">;</span> <span class="c">i++) {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w_target_p</span><span class="c">age</span> <span class="pc">=</span><span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_pages</span><span class="pc">[</span><span class="c">i</span><span class="pc">]) </span><span class="c">{</span>
				<span class="w">wc</span><span class="c">-&gt;w_pages</span><span class="pc">[</span><span class="c">i] =</span> <span class="w">N</span><span class="c">ULL;</span>
				<span class="pc">b</span><span class="c">reak;</span>
			<span class="c">}</span>
		<span class="c">}</span>
		<span class="w">mark_page_accessed</span><span class="c">(</span><span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">w_t</span><span class="c">arget_page</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">page_cache_release</span><span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w_</span><span class="c">target_page);</span>
	<span class="c">}</span>
	<span class="w">ocfs2_unlock_and_free_pages</span><span class="c">(</span><span class="w">wc</span><span class="c">-&gt;w_pages</span><span class="pc">,</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_num_pages</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">ocfs2_free_write_ctxt</span><span class="c">(struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">ocfs2_unlock_pages</span><span class="c">(</span><span class="w">wc</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">brelse</span><span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_di_bh</span><span class="c">);</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">wc</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_alloc_write_ctxt</span><span class="c">(struct</span> <span class="c">ocfs2_write_ctxt</span> <span class="pc">**</span><span class="w">wcp</span><span class="c">,</span>
				  <span class="c">struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b,</span> <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="pc">o</span><span class="c">s,</span>
				  <span class="c">unsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">di_bh</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">cend</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="c">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">;</span>

	<span class="w">wc</span> <span class="pc">=</span> <span class="c">kzalloc(sizeof</span><span class="pc">(</span><span class="c">struct</span> <span class="c">ocfs2_write_ctxt),</span> <span class="w">GFP_NOFS</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">w</span><span class="pc">c</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_cpos</span> <span class="c">=</span> <span class="w">po</span><span class="pc">s</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_clustersize_bits</span><span class="c">;</span>
	<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_first_new_cpos</span> <span class="c">=</span> <span class="w">UINT_MAX</span><span class="c">;</span>
	<span class="w">cend</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">p</span><span class="pc">o</span><span class="c">s</span> <span class="c">+</span> <span class="w">l</span><span class="c">en</span> <span class="c">-</span> <span class="c">1</span><span class="w">) &gt;</span><span class="c">&gt;</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s</span><span class="pc">_</span><span class="c">clustersize_bits;</span>
	<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_clen</span> <span class="c">=</span> <span class="pc">ce</span><span class="c">nd</span> <span class="w">-</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w</span><span class="pc">_cp</span><span class="c">os</span> <span class="w">+</span> <span class="c">1;</span>
	<span class="w">get_bh</span><span class="pc">(</span><span class="w">di_bh</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_di_bh</span> <span class="c">=</span> <span class="w">d</span><span class="c">i_bh</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely(</span><span class="w">PAGE_CACHE_SHIFT</span> <span class="pc">&gt;</span> <span class="w">os</span><span class="c">b-&gt;</span><span class="pc">s</span><span class="c">_clustersize_bits</span><span class="pc">))</span>
		<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_large_pages</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">else</span>
		<span class="w">wc</span><span class="c">-&gt;w_large_pages</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">ocfs2_init_dealloc_ctxt</span><span class="pc">(&amp;</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_dealloc</span><span class="c">);</span>

	<span class="w">*wcp</span> <span class="c">=</span> <span class="w">wc</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">ocfs2_zero_new_buffers</span><span class="c">(struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="w">p</span><span class="c">age,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">to</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">block_start</span><span class="pc">,</span> <span class="w">block_end</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">h</span><span class="pc">e</span><span class="c">ad</span><span class="pc">,</span><span class="c"> *</span><span class="w">bh</span><span class="c">;</span>

	<span class="w">B</span><span class="c">UG_ON(!</span><span class="w">PageLocked</span><span class="c">(</span><span class="pc">p</span><span class="c">age</span><span class="w">)</span><span class="pc">);</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">page_has_buffers</span><span class="c">(page))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">bh</span> <span class="pc">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span> <span class="pc">=</span> <span class="w">page_buffers</span><span class="c">(</span><span class="pc">p</span><span class="c">age);</span>
	<span class="w">b</span><span class="c">lock_start</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="w">b</span><span class="c">lock_end</span> <span class="c">=</span> <span class="c">block_start</span> <span class="pc">+</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_size</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">buffer_new</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">) {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(block_end</span> <span class="pc">&gt;</span> <span class="w">fr</span><span class="c">om</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="c">block_start</span> <span class="pc">&lt;</span> <span class="w">to</span><span class="pc">) </span><span class="c">{</span>
				<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">pa</span><span class="pc">ge)) </span><span class="c">{</span>
					<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="w">s</span><span class="pc">t</span><span class="c">art</span><span class="w">,</span> <span class="w">e</span><span class="c">nd;</span>

					<span class="w">s</span><span class="pc">tar</span><span class="c">t</span> <span class="c">=</span> <span class="w">m</span><span class="pc">ax(</span><span class="w">f</span><span class="pc">r</span><span class="c">om,</span> <span class="w">b</span><span class="pc">lock_s</span><span class="c">tart</span><span class="pc">)</span><span class="c">;</span>
					<span class="w">e</span><span class="pc">n</span><span class="c">d</span> <span class="c">=</span> <span class="w">m</span><span class="c">in(</span><span class="w">to</span><span class="c">,</span> <span class="w">b</span><span class="pc">lock_e</span><span class="c">nd</span><span class="pc">)</span><span class="c">;</span>

					<span class="w">zero_user_segment</span><span class="c">(</span><span class="w">p</span><span class="c">age,</span> <span class="pc">st</span><span class="c">art,</span> <span class="pc">e</span><span class="c">nd);</span>
					<span class="w">set_buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">}</span>

				<span class="w">clear_buffer_new</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
				<span class="w">mark_buffer_dirty</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
			<span class="pc">}</span>
		<span class="w">}</span>

		<span class="w">b</span><span class="pc">lock_s</span><span class="c">tart</span> <span class="pc">=</span> <span class="pc">b</span><span class="c">lock_end</span><span class="pc">;</span>
		<span class="w">bh</span> <span class="w">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">bh</span> <span class="w">!</span><span class="c">=</span> <span class="w">he</span><span class="pc">ad);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">ocfs2_write_failure</span><span class="c">(struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode,</span>
				<span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="pc">,</span>
				<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">user_pos</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">user_len</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m</span> <span class="c">=</span> <span class="w">u</span><span class="pc">ser_p</span><span class="c">os</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">PAGE_CACHE_SIZE</span> <span class="pc">-</span> <span class="c">1</span><span class="w">),</span>
		<span class="w">to</span> <span class="c">=</span> <span class="pc">u</span><span class="c">ser_pos</span> <span class="w">+</span> <span class="pc">u</span><span class="c">ser_len</span><span class="pc">;</span>
	<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="w">tmppage</span><span class="pc">;</span>

	<span class="w">ocfs2_zero_new_buffers</span><span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_page</span><span class="c">,</span> <span class="w">f</span><span class="pc">r</span><span class="c">om,</span> <span class="w">t</span><span class="pc">o</span><span class="w">)</span><span class="pc">;</span>

	<span class="pc">f</span><span class="c">or(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_num_pages</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="pc">t</span><span class="c">mppage</span> <span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_pages</span><span class="c">[i];</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">page_has_buffers</span><span class="c">(tmppage</span><span class="pc">)</span><span class="c">) {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ocfs2_should_order_data</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">)</span>
				<span class="w">ocfs2_jbd2_file_inode</span><span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_handle</span><span class="c">,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">block_commit_write</span><span class="c">(tmppage,</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m</span><span class="pc">,</span> <span class="w">to</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_prepare_page_for_write</span><span class="c">(struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode,</span> <span class="w">u6</span><span class="c">4</span> <span class="c">*</span><span class="w">p_blkno</span><span class="pc">,</span>
					<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="pc">,</span>
					<span class="c">struct</span> <span class="w">p</span><span class="c">age</span> <span class="c">*page,</span> <span class="w">u3</span><span class="c">2</span> <span class="w">cpos</span><span class="c">,</span>
					<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">user_pos</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">user_len</span><span class="pc">,</span>
					<span class="c">int</span> <span class="w">ne</span><span class="c">w</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">map_from</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">map_to</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">cluster_start</span><span class="pc">,</span> <span class="w">cluster_end</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">user_data_from</span> <span class="pc">=</span> <span class="pc">0,</span> <span class="w">user_data_to</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">;</span>

	<span class="w">ocfs2_figure_cluster_boundaries</span><span class="pc">(</span><span class="w">OCFS2_SB</span><span class="pc">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">),</span> <span class="w">cpos</span><span class="c">,</span>
					<span class="w">&amp;c</span><span class="c">luster_start</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;cluster_end);</span>

	
	<span class="w">ne</span><span class="pc">w</span> <span class="c">=</span> <span class="w">ne</span><span class="pc">w</span> <span class="w">| ((i_size_read</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="w">) &lt;=</span> <span class="w">page_offset</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="w">)) &amp;&amp;</span>
			<span class="w">(</span><span class="pc">p</span><span class="c">age_offset</span><span class="w">(</span><span class="pc">p</span><span class="c">age</span><span class="w">) &lt;</span><span class="pc">=</span> <span class="w">user_pos))</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="c">age</span> <span class="pc">=</span><span class="c">=</span> <span class="w">w</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_target_page)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">map_from</span> <span class="pc">=</span> <span class="w">u</span><span class="c">ser_pos</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">PAGE_CACHE_SIZE</span> <span class="pc">-</span> <span class="c">1);</span>
		<span class="w">map_to</span> <span class="pc">=</span> <span class="pc">m</span><span class="c">ap_from</span> <span class="w">+</span> <span class="w">user_len</span><span class="pc">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">n</span><span class="c">ew)</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_map_page_blocks</span><span class="c">(</span><span class="w">p</span><span class="c">age,</span> <span class="w">p_blkno</span><span class="c">,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span>
						    <span class="w">cluster_start</span><span class="c">,</span> <span class="w">cluster_end</span><span class="c">,</span>
						    <span class="w">n</span><span class="pc">e</span><span class="c">w</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">o</span><span class="c">cfs2_map_page_blocks(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge,</span> <span class="pc">p_</span><span class="c">blkno,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de,</span>
						    <span class="c">map_from,</span> <span class="pc">m</span><span class="c">ap_to</span><span class="pc">,</span> <span class="w">ne</span><span class="c">w</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>

		<span class="w">user_data_from</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">a</span><span class="c">p_from</span><span class="pc">;</span>
		<span class="w">user_data_to</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">a</span><span class="c">p_to</span><span class="pc">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">n</span><span class="pc">e</span><span class="c">w) {</span>
			<span class="pc">m</span><span class="c">ap_from</span> <span class="pc">=</span> <span class="w">cluster_start</span><span class="pc">;</span>
			<span class="pc">map_t</span><span class="c">o</span> <span class="c">=</span> <span class="w">cluster_end</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		
		<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">ne</span><span class="pc">w</span><span class="c">);</span>

		<span class="w">m</span><span class="pc">ap_f</span><span class="c">rom</span> <span class="c">=</span> <span class="pc">c</span><span class="c">luster_start;</span>
		<span class="w">m</span><span class="c">ap_to</span> <span class="c">=</span> <span class="pc">c</span><span class="c">luster_end;</span>

		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_map_page_blocks</span><span class="pc">(</span><span class="w">pag</span><span class="c">e,</span> <span class="w">p_blkno</span><span class="pc">,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e,</span>
					    <span class="c">cluster_start,</span> <span class="pc">c</span><span class="c">luster_end</span><span class="pc">,</span> <span class="w">n</span><span class="pc">ew)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ne</span><span class="pc">w</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">))</span>
		<span class="w">ocfs2_clear_page_regions</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">,</span> <span class="w">OCFS2_SB</span><span class="pc">(i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b),</span>
					 <span class="w">cpos</span><span class="pc">,</span> <span class="w">user_data_from</span><span class="c">,</span> <span class="w">user_data_to</span><span class="c">);</span>

	<span class="w">flush_dcache_page</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>

<span class="w">o</span><span class="c">ut:</span>
	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_grab_pages_for_write</span><span class="c">(struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
				      <span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">,</span>
				      <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">cp</span><span class="pc">o</span><span class="c">s,</span> <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">user_pos</span><span class="pc">,</span>
				      <span class="pc">u</span><span class="c">nsigned</span> <span class="w">user_len</span><span class="c">,</span> <span class="c">int</span> <span class="w">ne</span><span class="c">w</span><span class="pc">,</span>
				      <span class="c">struct</span> <span class="pc">p</span><span class="c">age</span> <span class="pc">*</span><span class="w">mmap_page</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">,</span> <span class="pc">i</span><span class="c">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">s</span><span class="pc">t</span><span class="c">art</span><span class="pc">,</span> <span class="w">target_index</span><span class="pc">,</span> <span class="w">end_index</span><span class="c">,</span> <span class="w">i</span><span class="pc">nd</span><span class="c">ex</span><span class="pc">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*inode</span> <span class="pc">=</span> <span class="w">map</span><span class="pc">p</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st</span><span class="pc">;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">last_byte</span><span class="pc">;</span>

	<span class="w">t</span><span class="c">arget_index</span> <span class="c">=</span> <span class="w">user_pos</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">ne</span><span class="c">w</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_num_pages</span> <span class="c">=</span> <span class="w">ocfs2_pages_per_cluster</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">st</span><span class="pc">ar</span><span class="c">t</span> <span class="c">=</span> <span class="w">ocfs2_align_clusters_to_page_index</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">,</span> <span class="w">cpos</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">l</span><span class="c">ast_byte</span> <span class="pc">=</span> <span class="w">ma</span><span class="pc">x</span><span class="c">(</span><span class="pc">u</span><span class="c">ser_pos</span> <span class="pc">+</span> <span class="w">user_len</span><span class="pc">,</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">))</span><span class="c">;</span>
		<span class="w">B</span><span class="c">UG_ON(last_byte</span> <span class="w">&lt;</span> <span class="pc">1</span><span class="c">);</span>
		<span class="w">end_index</span> <span class="w">=</span><span class="pc"> ((</span><span class="c">last_byte</span> <span class="w">-</span> <span class="c">1</span><span class="w">) &gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT)</span><span class="pc"> +</span> <span class="c">1;</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">st</span><span class="pc">a</span><span class="c">rt</span> <span class="w">+</span> <span class="w">w</span><span class="pc">c-</span><span class="c">&gt;</span><span class="w">w_num_pages) &gt;</span> <span class="pc">e</span><span class="c">nd_index)</span>
			<span class="w">wc</span><span class="c">-&gt;w_num_pages</span> <span class="c">=</span> <span class="pc">e</span><span class="c">nd_index</span> <span class="w">-</span> <span class="w">s</span><span class="pc">t</span><span class="c">art;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w</span><span class="c">_num_pages</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">st</span><span class="pc">ar</span><span class="c">t</span> <span class="c">=</span> <span class="w">target_index</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">f</span><span class="c">or(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">wc</span><span class="c">-&gt;w_num_pages;</span> <span class="c">i++) {</span>
		<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">=</span> <span class="w">st</span><span class="pc">a</span><span class="c">rt</span> <span class="c">+</span> <span class="pc">i</span><span class="c">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">==</span> <span class="w">t</span><span class="c">arget_index</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">mmap_page</span><span class="pc">)</span><span class="c"> {</span>
			
			<span class="w">lock_page</span><span class="c">(</span><span class="w">m</span><span class="pc">m</span><span class="c">ap_page</span><span class="pc">)</span><span class="c">;</span>

			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="c">map_page</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing</span> <span class="w">!</span><span class="c">=</span> <span class="w">ma</span><span class="pc">pp</span><span class="c">ing</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">W</span><span class="c">ARN_ON(mmap_page-&gt;</span><span class="w">m</span><span class="pc">app</span><span class="c">ing);</span>
				<span class="w">unlock_page</span><span class="c">(mmap_page</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-</span><span class="w">EA</span><span class="c">GAIN;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
			<span class="c">}</span>

			<span class="w">page_cache_get</span><span class="c">(mmap_page</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_pages</span><span class="pc">[i</span><span class="c">] =</span> <span class="c">mmap_page</span><span class="pc">;</span>
			<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_locked</span> <span class="c">=</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
			<span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w</span><span class="c">_pages</span><span class="pc">[i</span><span class="c">] =</span> <span class="w">find_or_create_page</span><span class="pc">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">i</span><span class="pc">nd</span><span class="c">ex</span><span class="pc">,</span>
							     <span class="w">GFP_NOFS</span><span class="c">);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">wc</span><span class="c">-&gt;w_pages[</span><span class="pc">i])</span><span class="c"> {</span>
				<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>
				<span class="w">mlog_errno</span><span class="c">(</span><span class="w">ret</span><span class="pc">)</span><span class="c">;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="pc">o</span><span class="c">ut;</span>
			<span class="c">}</span>
		<span class="pc">}</span>
		<span class="w">wait_for_stable_page</span><span class="c">(</span><span class="w">wc</span><span class="c">-&gt;w_pages</span><span class="pc">[i</span><span class="c">]);</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="pc">=</span><span class="c">=</span> <span class="w">target_index</span><span class="pc">)</span>
			<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_page</span> <span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w_p</span><span class="c">ages</span><span class="pc">[i</span><span class="c">];</span>
	<span class="pc">}</span>
<span class="w">o</span><span class="c">ut</span><span class="pc">:</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="c">et)</span>
		<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_locked</span> <span class="c">=</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_write_cluster</span><span class="c">(struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
			       <span class="pc">u3</span><span class="c">2</span> <span class="w">ph</span><span class="pc">ys</span><span class="c">,</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">int</span> <span class="w">unwritten</span><span class="c">,</span>
			       <span class="c">unsigned</span> <span class="c">int</span> <span class="w">should_zero</span><span class="c">,</span>
			       <span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_alloc_context</span> <span class="c">*</span><span class="w">data_ac</span><span class="c">,</span>
			       <span class="c">struct</span> <span class="pc">o</span><span class="c">cfs2_alloc_context</span> <span class="c">*</span><span class="w">meta_ac</span><span class="c">,</span>
			       <span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">cpos</span><span class="c">,</span>
			       <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">user_pos</span><span class="c">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">user_len</span><span class="pc">)</span>
<span class="pc">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span><span class="pc">,</span> <span class="c">i</span><span class="pc">,</span> <span class="w">ne</span><span class="pc">w;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">v_blkno</span><span class="pc">,</span> <span class="w">p_blkno</span><span class="c">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span><span class="pc">i</span><span class="c">node</span> <span class="pc">=</span> <span class="w">map</span><span class="pc">p</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st;</span>
	<span class="c">struct</span> <span class="w">ocfs2_extent_tree</span> <span class="w">et</span><span class="c">;</span>

	<span class="w">ne</span><span class="c">w</span> <span class="c">=</span> <span class="w">ph</span><span class="c">ys</span> <span class="w">=</span><span class="c">=</span> <span class="pc">0</span> <span class="pc">?</span> <span class="pc">1</span> <span class="c">:</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">n</span><span class="pc">e</span><span class="c">w</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">tmp_pos</span><span class="pc">;</span>

		
		<span class="w">t</span><span class="c">mp_pos</span> <span class="c">=</span> <span class="w">cpos</span><span class="pc">;</span>
		<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_add_inode_data</span><span class="c">(</span><span class="w">OCFS2_SB</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b</span><span class="pc">)</span><span class="c">,</span> <span class="w">ino</span><span class="c">de</span><span class="pc">,</span>
					   <span class="pc">&amp;t</span><span class="c">mp_pos</span><span class="pc">,</span> <span class="w">1</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="w">w</span><span class="pc">c-</span><span class="c">&gt;</span><span class="w">w_di_bh</span><span class="pc">,</span>
					   <span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_handle</span><span class="c">,</span> <span class="w">data_ac</span><span class="pc">,</span>
					   <span class="w">meta_ac</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="w">mlog_bug_on_msg</span><span class="c">(</span><span class="w">re</span><span class="pc">t</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">EA</span><span class="c">GAIN,</span>
				<span class="w">"Inode</span> <span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span><span class="pc">:</span> <span class="w">EA</span><span class="c">GAIN</span> <span class="w">ret</span><span class="pc">u</span><span class="c">rn</span> <span class="w">during</span> <span class="w">allocation.</span><span class="c">\n</span><span class="pc">",</span>
				<span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">et</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="w">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">unwritten)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">ocfs2_init_dinode_extent_tree</span><span class="pc">(&amp;</span><span class="w">et</span><span class="pc">,</span> <span class="w">INODE_CACHE</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de),</span>
					      <span class="w">w</span><span class="pc">c-</span><span class="c">&gt;</span><span class="w">w_di_bh</span><span class="c">);</span>
		<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_mark_extent_written</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">, </span><span class="c">&amp;et</span><span class="pc">,</span>
						<span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_handle</span><span class="c">,</span> <span class="w">cpos</span><span class="pc">,</span> <span class="pc">1,</span> <span class="w">ph</span><span class="pc">ys,</span>
						<span class="w">meta_ac</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_dealloc</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="w">mlog_errno</span><span class="pc">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">should_zero</span><span class="pc">)</span>
		<span class="w">v_blkno</span> <span class="pc">=</span> <span class="w">ocfs2_clusters_to_blocks</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span> <span class="w">c</span><span class="c">pos</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="pc">v</span><span class="c">_blkno</span> <span class="c">=</span> <span class="w">user_pos</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b-&gt;</span><span class="w">s_blocksize_bits</span><span class="c">;</span>

	
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_extent_map_get_blocks</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="pc">v</span><span class="c">_blkno</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">p_blkno</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span>
					  <span class="pc">N</span><span class="c">ULL);</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog</span><span class="pc">(</span><span class="w">ML_ERROR</span><span class="pc">, "</span><span class="w">Get</span> <span class="w">physical</span> <span class="w">blkno</span> <span class="w">f</span><span class="c">ailed</span> <span class="w">f</span><span class="c">or</span> <span class="w">ino</span><span class="c">de</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span><span class="w">,</span><span class="pc"> "</span>
			    <span class="pc">"</span><span class="w">a</span><span class="pc">t</span> <span class="w">logical</span> <span class="w">b</span><span class="pc">lo</span><span class="c">ck</span> <span class="pc">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span><span class="pc">"</span><span class="c">,</span>
			    <span class="w">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">ip_blkno</span><span class="c">,</span>
			    <span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="c">long)</span><span class="w">v_blkno)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="w">B</span><span class="c">UG_ON(</span><span class="w">p_blkno</span> <span class="w">=</span><span class="c">=</span> <span class="pc">0</span><span class="c">);</span>

	<span class="pc">f</span><span class="c">or(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_num_pages</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="pc">in</span><span class="c">t</span> <span class="w">tmpret</span><span class="pc">;</span>

		<span class="pc">t</span><span class="c">mpret</span> <span class="c">=</span> <span class="w">ocfs2_prepare_page_for_write</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">p</span><span class="c">_blkno</span><span class="pc">,</span> <span class="w">wc</span><span class="pc">,</span>
						      <span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_pages</span><span class="pc">[i],</span> <span class="w">cpos</span><span class="pc">,</span>
						      <span class="w">user_pos</span><span class="pc">,</span> <span class="w">user_len</span><span class="c">,</span>
						      <span class="w">should_zero</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="c">mpret</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="pc">t</span><span class="c">mpret</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">et</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
				<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">tmpret</span><span class="pc">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">ne</span><span class="pc">w)</span>
		<span class="w">ocfs2_write_failure</span><span class="c">(</span><span class="w">ino</span><span class="c">de,</span> <span class="w">wc</span><span class="pc">,</span> <span class="c">user_pos,</span> <span class="pc">u</span><span class="c">ser_len);</span>

<span class="w">o</span><span class="pc">u</span><span class="c">t:</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_write_cluster_by_desc</span><span class="c">(struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
				       <span class="c">struct</span> <span class="w">ocfs2_alloc_context</span> <span class="c">*</span><span class="w">data_ac</span><span class="c">,</span>
				       <span class="c">struct</span> <span class="c">ocfs2_alloc_context</span> <span class="c">*</span><span class="w">meta_ac</span><span class="c">,</span>
				       <span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="pc">,</span>
				       <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="c">os,</span> <span class="c">unsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span><span class="pc">,</span> <span class="c">i;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">cluster_off</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">local_len</span> <span class="pc">=</span> <span class="w">l</span><span class="c">en;</span>
	<span class="c">struct</span> <span class="w">ocfs2_write_cluster_desc</span> <span class="c">*</span><span class="w">d</span><span class="pc">e</span><span class="c">sc</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="pc">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="c">sb</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_clen</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">d</span><span class="pc">es</span><span class="c">c</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_desc</span><span class="c">[i];</span>

		
		<span class="w">local_len</span> <span class="pc">=</span> <span class="w">le</span><span class="pc">n</span><span class="c">;</span>
		<span class="w">cluster_off</span> <span class="pc">=</span> <span class="w">po</span><span class="pc">s</span> <span class="w">&amp;</span><span class="c"> (</span><span class="w">os</span><span class="c">b</span><span class="pc">-&gt;</span><span class="w">s_clustersize</span> <span class="pc">-</span> <span class="c">1);</span>
		<span class="c">if</span> <span class="pc">((</span><span class="c">cluster_off</span> <span class="w">+</span> <span class="pc">l</span><span class="c">ocal_len</span><span class="w">) &gt;</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">_clustersize)</span>
			<span class="pc">l</span><span class="c">ocal_len</span> <span class="pc">=</span> <span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;s_clustersize</span> <span class="pc">-</span> <span class="pc">c</span><span class="c">luster_off;</span>

		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_write_cluster</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">c_phys</span><span class="c">,</span>
					  <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">c_unwritten</span><span class="c">,</span>
					  <span class="w">d</span><span class="c">esc-&gt;</span><span class="w">c_needs_zero</span><span class="c">,</span>
					  <span class="w">data_ac</span><span class="c">,</span> <span class="w">meta_ac</span><span class="c">,</span>
					  <span class="w">wc</span><span class="pc">,</span> <span class="pc">d</span><span class="c">esc-&gt;</span><span class="w">c_cpos</span><span class="c">,</span> <span class="w">po</span><span class="c">s,</span> <span class="c">local_len</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">re</span><span class="pc">t)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>

		<span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="pc">-</span><span class="c">=</span> <span class="w">l</span><span class="pc">o</span><span class="c">cal_len;</span>
		<span class="w">po</span><span class="c">s</span> <span class="c">+=</span> <span class="w">l</span><span class="pc">o</span><span class="c">cal_len;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="c">0;</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">ocfs2_set_target_boundaries</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span>
					<span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="pc">,</span>
					<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="c">os</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">le</span><span class="c">n</span><span class="pc">,</span> <span class="c">int</span> <span class="w">al</span><span class="pc">lo</span><span class="c">c</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ocfs2_write_cluster_desc</span> <span class="c">*</span><span class="w">d</span><span class="pc">es</span><span class="c">c;</span>

	<span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_target_from</span> <span class="c">=</span> <span class="w">po</span><span class="pc">s</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">PAGE_CACHE_SIZE</span> <span class="pc">-</span> <span class="c">1);</span>
	<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_to</span> <span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w_target_f</span><span class="c">rom</span> <span class="pc">+</span> <span class="w">l</span><span class="c">en;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">al</span><span class="pc">lo</span><span class="c">c</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0</span><span class="c">)</span>
		<span class="c">return</span><span class="pc">;</span>

	

	<span class="c">if</span> <span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_large_pages</span><span class="c">) {</span>
		
		<span class="w">des</span><span class="c">c</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_desc</span><span class="pc">[</span><span class="c">0];</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">c_needs_zero</span><span class="c">)</span>
			<span class="w">ocfs2_figure_cluster_boundaries</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span>
							<span class="pc">d</span><span class="c">esc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">c_cpos</span><span class="pc">,</span>
							<span class="c">&amp;</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_from</span><span class="pc">,</span>
							<span class="w">N</span><span class="c">ULL);</span>

		<span class="w">de</span><span class="pc">s</span><span class="c">c</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w</span><span class="pc">_d</span><span class="c">esc[</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_clen</span> <span class="pc">-</span> <span class="c">1</span><span class="pc">]</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">de</span><span class="pc">s</span><span class="c">c-&gt;</span><span class="w">c</span><span class="pc">_n</span><span class="c">eeds_zero</span><span class="w">)</span>
			<span class="c">ocfs2_figure_cluster_boundaries</span><span class="pc">(</span><span class="w">os</span><span class="c">b,</span>
							<span class="w">d</span><span class="pc">es</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c_c</span><span class="c">pos,</span>
							<span class="w">N</span><span class="c">ULL,</span>
							<span class="c">&amp;</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_to</span><span class="c">);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_from</span> <span class="c">=</span> <span class="c">0;</span>
		<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w</span><span class="pc">_target_t</span><span class="c">o</span> <span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_populate_write_desc</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode,</span>
				     <span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="pc">,</span>
				     <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">*</span><span class="w">clusters_to_alloc</span><span class="pc">,</span>
				     <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="c">*</span><span class="w">extents_to_split</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">re</span><span class="c">t;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_write_cluster_desc</span> <span class="c">*</span><span class="w">de</span><span class="pc">s</span><span class="c">c</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">num_clusters</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ext_flags</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">ph</span><span class="pc">ys</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">int</span> <span class="c">i;</span>

	<span class="w">*c</span><span class="c">lusters_to_alloc</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">*e</span><span class="c">xtents_to_split</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_clen</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">de</span><span class="pc">s</span><span class="c">c</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_desc</span><span class="c">[i];</span>
		<span class="pc">d</span><span class="c">esc-&gt;</span><span class="w">c_cpos</span> <span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_cpos</span> <span class="pc">+</span> <span class="pc">i</span><span class="c">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">num_clusters</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_get_clusters</span><span class="c">(</span><span class="w">ino</span><span class="c">de,</span> <span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="pc">c</span><span class="c">_cpos</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">ph</span><span class="c">ys,</span>
						 <span class="pc">&amp;n</span><span class="c">um_clusters</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ext_flags</span><span class="c">);</span>
			<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
			<span class="c">}</span>

			
			<span class="w">B</span><span class="pc">UG_</span><span class="c">ON(</span><span class="pc">e</span><span class="c">xt_flags</span> <span class="pc">&amp;</span> <span class="w">OCFS2_EXT_REFCOUNTED</span><span class="c">);</span>

			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="pc">x</span><span class="c">t_flags</span> <span class="pc">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN</span><span class="pc">)</span>
				<span class="w">*extents_to_split</span> <span class="w">= </span><span class="pc">*</span><span class="w">e</span><span class="pc">xte</span><span class="c">nts_to_split</span> <span class="w">+</span> <span class="w">2</span><span class="c">;</span>
		<span class="w">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">phy</span><span class="pc">s</span><span class="w">)</span><span class="c"> {</span>
			
			<span class="w">phy</span><span class="pc">s</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
		<span class="c">}</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">de</span><span class="pc">s</span><span class="c">c-&gt;</span><span class="w">c_cpos</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_first_new_cpos</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">B</span><span class="c">UG_ON(</span><span class="w">ph</span><span class="pc">ys</span> <span class="w">=</span><span class="c">=</span> <span class="pc">0</span><span class="c">);</span>
			<span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">c_needs_zero</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="w">d</span><span class="c">esc-&gt;</span><span class="w">c_phys</span> <span class="c">=</span> <span class="w">p</span><span class="pc">h</span><span class="c">ys;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ph</span><span class="c">ys</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">c_new</span> <span class="c">=</span> <span class="c">1;</span>
			<span class="c">desc-&gt;</span><span class="pc">c_n</span><span class="c">eeds_zero</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
			<span class="w">*clusters_to_alloc</span> <span class="w">= *c</span><span class="pc">l</span><span class="c">usters_to_alloc</span> <span class="pc">+</span> <span class="c">1;</span>
		<span class="pc">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ext_flags</span> <span class="w">&amp;</span> <span class="w">OCFS2_EXT_UNWRITTEN</span><span class="c">) {</span>
			<span class="w">d</span><span class="pc">es</span><span class="c">c-&gt;</span><span class="w">c_unwritten</span> <span class="c">=</span> <span class="c">1;</span>
			<span class="pc">d</span><span class="c">esc-&gt;</span><span class="w">c</span><span class="pc">_nee</span><span class="c">ds_zero</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="w">num_clusters-</span><span class="pc">-</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">0;</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_write_begin_inline</span><span class="c">(struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span>
				    <span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*inode,</span>
				    <span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="c">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b);</span>
	<span class="c">struct</span> <span class="w">p</span><span class="c">age</span> <span class="c">*page</span><span class="pc">;</span>
	<span class="w">handle_t</span> <span class="pc">*</span><span class="w">h</span><span class="pc">andle</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">di</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">ocfs2_dinode</span> <span class="c">*)</span><span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_di_bh-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">;</span>

	<span class="w">h</span><span class="pc">andle</span> <span class="c">=</span> <span class="w">ocfs2_start_trans</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">OCFS2_INODE_UPDATE_CREDITS</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(handle</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="c">PTR_ERR(</span><span class="w">h</span><span class="pc">andle</span><span class="c">);</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="c">et</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="w">pag</span><span class="pc">e</span> <span class="c">=</span> <span class="w">find_or_create_page</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="pc">0,</span> <span class="w">GFP_NOFS</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">p</span><span class="c">age) {</span>
		<span class="w">ocfs2_commit_trans</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span> <span class="w">h</span><span class="pc">a</span><span class="c">ndle);</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-ENOMEM;</span>
		<span class="w">m</span><span class="c">log_errno(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
		<span class="c">goto</span> <span class="c">out;</span>
	<span class="c">}</span>
	
	<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_pages</span><span class="pc">[</span><span class="c">0] =</span> <span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_target_page</span> <span class="pc">=</span> <span class="w">pa</span><span class="pc">g</span><span class="c">e;</span>
	<span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_num_pages</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="c">ret</span> <span class="c">=</span> <span class="w">ocfs2_journal_access_di</span><span class="c">(</span><span class="w">h</span><span class="pc">a</span><span class="c">ndle</span><span class="pc">,</span> <span class="w">INODE_CACHE</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)</span><span class="c">,</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_di_bh</span><span class="pc">,</span>
				      <span class="w">OCFS2_JOURNAL_ACCESS_WRITE</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ocfs2_commit_trans</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">h</span><span class="pc">a</span><span class="c">ndle);</span>

		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="pc">(!(</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="c">))</span>
		<span class="w">ocfs2_set_inode_data_inline</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">,</span> <span class="w">di</span><span class="c">);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">p</span><span class="pc">ag</span><span class="c">e</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_read_inline_data</span><span class="c">(</span><span class="pc">i</span><span class="c">node,</span> <span class="w">p</span><span class="c">age</span><span class="pc">,</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_di_bh</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ocfs2_commit_trans</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span> <span class="w">h</span><span class="pc">a</span><span class="c">ndle);</span>

			<span class="w">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="c">}</span>

	<span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_handle</span> <span class="c">=</span> <span class="w">h</span><span class="c">andle;</span>
<span class="w">o</span><span class="pc">u</span><span class="c">t:</span>
	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_size_fits_inline_data</span><span class="c">(struct</span> <span class="w">b</span><span class="c">uffer_head</span> <span class="c">*</span><span class="w">di_bh</span><span class="c">,</span> <span class="w">u6</span><span class="c">4</span> <span class="w">new_size</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">di</span> <span class="pc">= </span><span class="c">(struct</span> <span class="c">ocfs2_dinode</span> <span class="c">*)di_bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">n</span><span class="c">ew_size</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">di</span><span class="c">-&gt;</span><span class="w">id2</span><span class="pc">.</span><span class="w">i_data</span><span class="pc">.</span><span class="w">id_count</span><span class="c">))</span>
		<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_try_to_write_inline_data</span><span class="c">(struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span>
					  <span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*inode</span><span class="pc">,</span> <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">po</span><span class="pc">s</span><span class="c">,</span>
					  <span class="pc">u</span><span class="c">nsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="pc">p</span><span class="c">age</span> <span class="pc">*</span><span class="w">mmap_page</span><span class="pc">,</span>
					  <span class="c">struct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">ret</span><span class="pc">,</span> <span class="w">written</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span> <span class="w">e</span><span class="c">nd</span> <span class="c">=</span> <span class="w">po</span><span class="c">s</span> <span class="pc">+</span> <span class="w">l</span><span class="c">en;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_inode_info</span> <span class="c">*</span><span class="w">oi</span> <span class="pc">=</span> <span class="w">OCFS2_I</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de);</span>
	<span class="c">struct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">di</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">trace_ocfs2_try_to_write_inline_data(</span><span class="pc">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)oi</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
					     <span class="w">l</span><span class="c">en</span><span class="w">,</span><span class="pc"> (</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">p</span><span class="pc">o</span><span class="c">s</span><span class="pc">,</span>
					     <span class="w">o</span><span class="c">i-&gt;</span><span class="w">ip_dyn_features</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">o</span><span class="c">i-&gt;ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">mmap_page</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL</span> <span class="w">&amp;</span><span class="c">&amp;</span>
		    <span class="w">ocfs2_size_fits_inline_data</span><span class="c">(</span><span class="w">w</span><span class="c">c-&gt;</span><span class="w">w_di_bh</span><span class="c">,</span> <span class="w">en</span><span class="pc">d</span><span class="c">))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">do_inline_write</span><span class="c">;</span>

		
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_convert_inline_data_to_extents</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="pc">w</span><span class="c">_di_bh);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et)</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">oi</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_clusters</span> <span class="pc">!</span><span class="c">=</span> <span class="c">0</span> <span class="pc">|</span><span class="c">|</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">) </span><span class="pc">!</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	
	<span class="w">di</span> <span class="w">=</span><span class="pc"> (</span><span class="c">struct</span> <span class="w">ocfs2_dinode</span> <span class="c">*)</span><span class="w">wc</span><span class="c">-&gt;w_di_bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">mmap_page</span> <span class="w">|</span><span class="c">|</span>
	    <span class="w">en</span><span class="pc">d</span> <span class="c">&gt;</span> <span class="w">ocfs2_max_inline_data_with_xattr</span><span class="pc">(</span><span class="w">in</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">sb,</span> <span class="w">di</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">do_inline_write</span><span class="pc">:</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_write_begin_inline</span><span class="c">(</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">wc</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	
	<span class="w">written</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
<span class="w">o</span><span class="pc">u</span><span class="c">t:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">w</span><span class="c">ritten</span> <span class="w">?</span> <span class="w">w</span><span class="c">ritten</span> <span class="c">:</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_expand_nonsparse_inode</span><span class="c">(struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*inode,</span>
					<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">di_bh</span><span class="pc">,</span>
					<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">po</span><span class="c">s</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span>
					<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="w">l</span><span class="pc">o</span><span class="c">ff_t</span> <span class="w">newsize</span> <span class="pc">=</span> <span class="w">po</span><span class="pc">s</span> <span class="pc">+</span> <span class="w">l</span><span class="c">en;</span>

	<span class="w">B</span><span class="c">UG_ON(</span><span class="w">ocfs2_sparse_alloc</span><span class="c">(</span><span class="w">OCFS2_SB</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="c">_sb</span><span class="w">)))</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">n</span><span class="c">ewsize</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_extend_no_holes</span><span class="c">(</span><span class="pc">i</span><span class="c">node,</span> <span class="w">di_bh</span><span class="c">,</span> <span class="w">n</span><span class="c">ewsize</span><span class="pc">,</span> <span class="w">p</span><span class="pc">o</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t)</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>

	<span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_first_new_cpos</span> <span class="c">=</span>
		<span class="w">ocfs2_clusters_for_bytes</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">sb</span><span class="c">,</span> <span class="w">i</span><span class="c">_size_read</span><span class="w">(i</span><span class="c">node</span><span class="pc">))</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">ocfs2_zero_tail</span><span class="c">(struct</span> <span class="c">inode</span> <span class="c">*inode,</span> <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">di_bh</span><span class="pc">,</span>
			   <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="c">os)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">ocfs2_sparse_alloc</span><span class="c">(</span><span class="w">OCFS2_SB</span><span class="c">(inode</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_s</span><span class="c">b</span><span class="w">)))</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">po</span><span class="pc">s</span> <span class="w">&gt;</span> <span class="w">i_size_read</span><span class="c">(inode</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_zero_extend</span><span class="c">(inode,</span> <span class="c">di_bh</span><span class="pc">,</span> <span class="w">po</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_try_to_free_truncate_log</span><span class="c">(struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b,</span>
					  <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">needed</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">tid_t</span> <span class="w">ta</span><span class="c">rget;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">truncated_clusters</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">osb_tl_inode-</span><span class="c">&gt;</span><span class="w">i_mutex</span><span class="c">);</span>
	<span class="w">t</span><span class="c">runcated_clusters</span> <span class="pc">=</span> <span class="w">os</span><span class="pc">b</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">r</span><span class="c">uncated_clusters;</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">os</span><span class="pc">b</span><span class="c">-&gt;</span><span class="pc">o</span><span class="c">sb_tl_inode</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mutex);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(truncated_clusters</span> <span class="w">&lt;</span> <span class="w">needed</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_flush_truncate_log</span><span class="c">(</span><span class="w">os</span><span class="pc">b)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">jbd2_journal_start_commit</span><span class="c">(</span><span class="w">os</span><span class="pc">b-</span><span class="c">&gt;</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j_journal,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">ta</span><span class="pc">r</span><span class="c">get</span><span class="pc">)</span><span class="c">) {</span>
		<span class="w">jbd2_log_wait_commit</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">j</span><span class="pc">o</span><span class="c">urnal</span><span class="pc">-</span><span class="c">&gt;j_journal</span><span class="pc">,</span> <span class="w">t</span><span class="pc">a</span><span class="c">rget</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_write_begin_nolock</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*</span><span class="pc">filp</span><span class="c">,</span>
			     <span class="c">struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
			     <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="pc">o</span><span class="c">s,</span> <span class="c">unsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">f</span><span class="c">lags,</span>
			     <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="c">age</span> <span class="pc">**</span><span class="w">pagep</span><span class="pc">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">**</span><span class="w">fsdata</span><span class="pc">,</span>
			     <span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">di_bh</span><span class="pc">,</span> <span class="c">struct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*</span><span class="w">mmap_page</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span><span class="pc">,</span> <span class="w">cluster_of_pages</span><span class="pc">,</span> <span class="w">credits</span> <span class="w">=</span> <span class="w">OCFS2_INODE_UPDATE_CREDITS</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">clusters_to_alloc</span><span class="pc">,</span> <span class="w">extents_to_split</span><span class="pc">,</span> <span class="w">clusters_need</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*inode</span> <span class="pc">=</span> <span class="w">map</span><span class="pc">p</span><span class="c">ing-&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="c">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_</span><span class="c">sb);</span>
	<span class="c">struct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">di</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">ocfs2_alloc_context</span> <span class="c">*</span><span class="w">data_ac</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="c">struct</span> <span class="pc">ocfs2_a</span><span class="c">lloc_context</span> <span class="c">*</span><span class="w">meta_ac</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="w">handle_t</span> <span class="w">*ha</span><span class="pc">ndle;</span>
	<span class="c">struct</span> <span class="w">ocfs2_extent_tree</span> <span class="w">et</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">try_free</span> <span class="pc">=</span> <span class="pc">1,</span> <span class="w">ret1</span><span class="pc">;</span>

<span class="w">try_again:</span>
	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_alloc_write_ctxt</span><span class="pc">(&amp;</span><span class="w">wc</span><span class="pc">,</span> <span class="w">os</span><span class="c">b,</span> <span class="w">po</span><span class="pc">s</span><span class="c">,</span> <span class="w">l</span><span class="c">en,</span> <span class="w">di_bh</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">re</span><span class="pc">t</span><span class="c">);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ocfs2_supports_inline_data</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">)</span><span class="c">) {</span>
		<span class="c">ret</span> <span class="c">=</span> <span class="w">ocfs2_try_to_write_inline_data</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">ino</span><span class="c">de</span><span class="pc">,</span> <span class="w">po</span><span class="pc">s</span><span class="c">,</span> <span class="w">l</span><span class="c">en,</span>
						     <span class="w">mmap_page</span><span class="pc">,</span> <span class="w">wc</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">1</span><span class="c">) {</span>
			<span class="c">ret</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="c">goto</span> <span class="w">success</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">ocfs2_sparse_alloc</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">))</span>
		<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_zero_tail</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">di_bh</span><span class="pc">,</span> <span class="w">po</span><span class="pc">s)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_expand_nonsparse_inode</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="c">di_bh,</span> <span class="w">po</span><span class="pc">s,</span> <span class="w">l</span><span class="c">en</span><span class="pc">,</span>
						   <span class="w">wc</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_check_range_for_refcount</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">po</span><span class="c">s,</span> <span class="w">l</span><span class="c">en</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">m</span><span class="pc">l</span><span class="c">og_errno</span><span class="pc">(r</span><span class="c">et</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">goto</span> <span class="c">out;</span>
	<span class="c">}</span> <span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="c">if</span> <span class="c">(ret</span> <span class="w">=</span><span class="pc">=</span> <span class="pc">1</span><span class="c">) {</span>
		<span class="w">clusters_need</span> <span class="pc">=</span> <span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_clen</span><span class="pc">;</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">ocfs2_refcount_cow</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">di_bh</span><span class="c">,</span>
					 <span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_cpos</span><span class="pc">,</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w_cl</span><span class="c">en,</span> <span class="w">UINT_MAX</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et</span><span class="c">);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_populate_write_desc</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">wc,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">clusters_to_alloc</span><span class="pc">,</span>
					<span class="pc">&amp;</span><span class="w">extents_to_split</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">m</span><span class="pc">l</span><span class="c">og_errno(</span><span class="pc">r</span><span class="c">et);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>
	<span class="w">clusters_need</span> <span class="w">+</span><span class="pc">=</span> <span class="w">c</span><span class="c">lusters_to_alloc;</span>

	<span class="w">di</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">s</span><span class="c">truct</span> <span class="w">ocfs2_dinode</span> <span class="c">*)</span><span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_di_bh-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">;</span>

	<span class="w">trace_ocfs2_write_begin_nolock</span><span class="c">(</span>
			<span class="w">(u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="pc">,</span>
			<span class="pc">(</span><span class="w">l</span><span class="c">ong</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">i_size_read</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="w">)</span><span class="pc">,</span>
			<span class="w">le</span><span class="pc">3</span><span class="c">2_to_cpu(</span><span class="w">di</span><span class="c">-&gt;</span><span class="w">i_clusters</span><span class="c">),</span>
			<span class="w">po</span><span class="c">s</span><span class="pc">,</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags</span><span class="pc">,</span> <span class="w">mmap_page</span><span class="pc">,</span>
			<span class="w">clusters_to_alloc</span><span class="pc">,</span> <span class="w">extents_to_split</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="c">lusters_to_alloc</span> <span class="w">|</span><span class="c">|</span> <span class="c">extents_to_split</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		
		<span class="w">ocfs2_init_dinode_extent_tree</span><span class="pc">(&amp;</span><span class="w">et</span><span class="c">,</span> <span class="w">INODE_CACHE</span><span class="pc">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)</span><span class="c">,</span>
					      <span class="w">w</span><span class="c">c</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_di_bh</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_lock_allocators</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">et</span><span class="c">,</span>
					    <span class="c">clusters_to_alloc,</span> <span class="c">extents_to_split,</span>
					    <span class="w">&amp;data_ac</span><span class="c">, &amp;</span><span class="w">meta_ac</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">d</span><span class="c">ata_ac</span><span class="pc">)</span>
			<span class="w">d</span><span class="pc">a</span><span class="c">ta_ac</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ac_resv</span> <span class="w">=</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_la_data_resv</span><span class="c">;</span>

		<span class="w">credits</span> <span class="pc">=</span> <span class="w">ocfs2_calc_extend_credits</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b,</span>
						    <span class="w">&amp;di</span><span class="c">-&gt;</span><span class="w">id2</span><span class="pc">.</span><span class="w">i_list</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">clusters_to_alloc</span> <span class="w">|</span><span class="c">|</span> <span class="w">extents_to_split</span> <span class="w">|</span><span class="c">|</span>
	    <span class="w">(wc</span><span class="c">-&gt;</span><span class="w">w_clen</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">(</span><span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_desc[</span><span class="c">0].</span><span class="w">c_needs_zero</span> <span class="w">|</span><span class="c">|</span>
			    <span class="w">w</span><span class="pc">c</span><span class="c">-&gt;w_desc[</span><span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="pc">w_c</span><span class="c">len</span> <span class="pc">-</span> <span class="c">1</span><span class="w">]</span><span class="c">.</span><span class="pc">c_</span><span class="c">needs_zero</span><span class="w">))</span><span class="pc">)</span>
		<span class="w">cluster_of_pages</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">c</span><span class="pc">luster_</span><span class="c">of_pages</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">ocfs2_set_target_boundaries</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">w</span><span class="pc">c,</span> <span class="w">po</span><span class="pc">s,</span> <span class="w">l</span><span class="c">en</span><span class="pc">,</span> <span class="pc">c</span><span class="c">luster_of_pages);</span>

	<span class="w">ha</span><span class="pc">n</span><span class="c">dle</span> <span class="c">=</span> <span class="w">ocfs2_start_trans</span><span class="c">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">credits</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">I</span><span class="c">S_ERR(</span><span class="w">h</span><span class="pc">a</span><span class="c">ndle</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="c">PTR_ERR(</span><span class="w">h</span><span class="c">andle);</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="c">et</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_handle</span> <span class="c">=</span> <span class="w">h</span><span class="c">andle;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">clusters_to_alloc</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">dquot_alloc_space_nodirty</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span>
			<span class="w">ocfs2_clusters_to_bytes</span><span class="pc">(</span><span class="w">os</span><span class="c">b</span><span class="w">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="c">,</span> <span class="pc">c</span><span class="c">lusters_to_alloc</span><span class="w">)</span><span class="pc">);</span>
		<span class="c">if</span> <span class="c">(ret)</span>
			<span class="c">goto</span> <span class="w">out_commit</span><span class="c">;</span>
	<span class="pc">}</span>
	
	<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_journal_access_di</span><span class="c">(</span><span class="w">h</span><span class="pc">a</span><span class="c">ndle,</span> <span class="w">INODE_CACHE</span><span class="pc">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">),</span> <span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_di_bh</span><span class="c">,</span>
				      <span class="w">OCFS2_JOURNAL_ACCESS_WRITE</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">t);</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_quota</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="c">ret</span> <span class="c">=</span> <span class="w">ocfs2_grab_pages_for_write</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">wc</span><span class="pc">,</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_cpos</span><span class="pc">,</span> <span class="w">po</span><span class="pc">s</span><span class="c">,</span> <span class="w">l</span><span class="c">en</span><span class="pc">,</span>
					 <span class="w">cluster_of_pages</span><span class="pc">,</span> <span class="w">mmap_page</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">r</span><span class="c">et</span> <span class="w">!</span><span class="pc">= </span><span class="c">-</span><span class="w">EA</span><span class="c">GAIN</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">m</span><span class="c">log_errno(</span><span class="w">r</span><span class="pc">e</span><span class="c">t</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">out_</span><span class="c">quota;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">=</span><span class="c">= -</span><span class="w">EA</span><span class="c">GAIN) {</span>
		<span class="w">B</span><span class="c">UG_ON(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_page</span><span class="c">);</span>
		<span class="c">ret</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="c">goto</span> <span class="pc">out_</span><span class="c">quota;</span>
	<span class="c">}</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_write_cluster_by_desc</span><span class="c">(</span><span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">data_ac</span><span class="c">,</span> <span class="w">meta_ac</span><span class="c">,</span> <span class="w">wc</span><span class="pc">,</span> <span class="w">po</span><span class="pc">s</span><span class="c">,</span>
					  <span class="w">l</span><span class="c">en</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret) {</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="c">et</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">out_</span><span class="c">quota;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">d</span><span class="c">ata_ac</span><span class="pc">)</span>
		<span class="w">ocfs2_free_alloc_context</span><span class="c">(</span><span class="pc">da</span><span class="c">ta_ac);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">e</span><span class="c">ta_ac</span><span class="pc">)</span>
		<span class="w">o</span><span class="pc">cfs2_f</span><span class="c">ree_alloc_context(</span><span class="pc">m</span><span class="c">eta_ac</span><span class="pc">)</span><span class="c">;</span>

<span class="w">success:</span>
	<span class="w">*pagep</span> <span class="c">=</span> <span class="w">w</span><span class="pc">c-</span><span class="c">&gt;</span><span class="w">w_target_page</span><span class="c">;</span>
	<span class="w">*fsdata</span> <span class="c">=</span> <span class="w">w</span><span class="pc">c;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="w">o</span><span class="pc">u</span><span class="c">t_quota:</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">clusters_to_alloc</span><span class="pc">)</span>
		<span class="w">dquot_free_space</span><span class="c">(</span><span class="w">ino</span><span class="c">de,</span>
			  <span class="w">ocfs2_clusters_to_bytes</span><span class="pc">(</span><span class="w">os</span><span class="c">b</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb</span><span class="pc">,</span> <span class="c">clusters_to_alloc</span><span class="pc">));</span>
<span class="w">out_commit</span><span class="pc">:</span>
	<span class="w">ocfs2_commit_trans</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span> <span class="w">h</span><span class="pc">andle</span><span class="c">);</span>

<span class="w">o</span><span class="pc">ut</span><span class="c">:</span>
	<span class="w">ocfs2_free_write_ctxt</span><span class="c">(</span><span class="w">wc</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">data_ac</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ocfs2_free_alloc_context</span><span class="c">(data_ac</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">d</span><span class="c">ata_ac</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">meta_ac</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">o</span><span class="pc">cfs2_f</span><span class="c">ree_alloc_context</span><span class="pc">(m</span><span class="c">eta_ac);</span>
		<span class="pc">m</span><span class="c">eta_ac</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="c">et</span> <span class="w">=</span><span class="pc">= </span><span class="c">-</span><span class="w">ENOSPC</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">try_free</span><span class="pc">)</span><span class="c"> {</span>
		
		<span class="w">t</span><span class="c">ry_free</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>

		<span class="w">ret1</span> <span class="c">=</span> <span class="w">ocfs2_try_to_free_truncate_log</span><span class="pc">(</span><span class="w">os</span><span class="c">b,</span> <span class="w">clusters_need</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(ret1</span> <span class="c">==</span> <span class="pc">1)</span>
			<span class="c">goto</span> <span class="w">try_again</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(ret1</span> <span class="w">&lt;</span> <span class="c">0)</span>
			<span class="w">mlog_errno</span><span class="c">(ret1);</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_write_begin</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
			     <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="c">os,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">f</span><span class="c">lags,</span>
			     <span class="c">struct</span> <span class="w">p</span><span class="c">age</span> <span class="pc">**</span><span class="w">pagep</span><span class="pc">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">**</span><span class="w">fsdata</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">uffer_</span><span class="c">head</span> <span class="c">*</span><span class="w">di_bh</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="c">struct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*</span><span class="pc">i</span><span class="c">node</span> <span class="pc">=</span> <span class="w">ma</span><span class="pc">pp</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_inode_lock</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">d</span><span class="c">i_bh</span><span class="pc">,</span> <span class="pc">1)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="c">et);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	
	<span class="w">down_write</span><span class="pc">(&amp;</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">ip_alloc_sem</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">ocfs2_write_begin_nolock</span><span class="c">(</span><span class="w">f</span><span class="c">ile</span><span class="pc">,</span> <span class="w">map</span><span class="pc">p</span><span class="c">ing,</span> <span class="w">po</span><span class="c">s</span><span class="pc">,</span> <span class="w">l</span><span class="c">en,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags</span><span class="pc">,</span> <span class="w">pagep</span><span class="pc">,</span>
				       <span class="w">fsdata</span><span class="c">,</span> <span class="w">di_bh</span><span class="c">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">mlog_errno</span><span class="c">(</span><span class="w">r</span><span class="pc">et)</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_fail</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">brelse</span><span class="c">(</span><span class="w">d</span><span class="pc">i</span><span class="c">_bh</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

<span class="pc">ou</span><span class="c">t_fail:</span>
	<span class="w">up_write</span><span class="pc">(&amp;</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_alloc_sem</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">b</span><span class="c">relse(di_bh);</span>
	<span class="w">ocfs2_inode_unlock</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">ocfs2_write_end_inline</span><span class="c">(struct</span> <span class="pc">i</span><span class="c">node</span> <span class="c">*inode</span><span class="pc">,</span> <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="pc">os</span><span class="c">,</span>
				   <span class="c">unsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="w">*copied</span><span class="pc">,</span>
				   <span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">di</span><span class="pc">,</span>
				   <span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">kaddr</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(unlikely</span><span class="pc">(*</span><span class="c">copied</span> <span class="w">&lt;</span> <span class="w">l</span><span class="pc">en</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">if</span> <span class="pc">(!</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_target_page</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">*</span><span class="pc">c</span><span class="c">opied</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="c">return</span><span class="w">;</span>
		<span class="c">}</span>
	<span class="c">}</span>

	<span class="w">k</span><span class="c">addr</span> <span class="c">=</span> <span class="w">kmap_atomic</span><span class="c">(</span><span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w</span><span class="c">_target_page);</span>
	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">di</span><span class="c">-&gt;</span><span class="w">id2</span><span class="pc">.</span><span class="w">i_data</span><span class="pc">.</span><span class="w">id_data</span> <span class="w">+</span> <span class="w">po</span><span class="pc">s</span><span class="w">,</span> <span class="pc">k</span><span class="c">addr</span> <span class="pc">+</span> <span class="w">p</span><span class="c">os</span><span class="w">,</span><span class="pc"> *</span><span class="w">c</span><span class="c">opied</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">kunmap_atomic</span><span class="c">(kaddr</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">trace_ocfs2_write_end_inline</span><span class="c">(</span>
	     <span class="w">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">l</span><span class="c">ong)</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">ip_blkno</span><span class="c">,</span>
	     <span class="pc">(</span><span class="c">unsigned</span> <span class="c">long</span> <span class="pc">l</span><span class="c">ong)</span><span class="w">po</span><span class="pc">s</span><span class="w">,</span><span class="pc"> *</span><span class="w">c</span><span class="c">opied</span><span class="pc">,</span>
	     <span class="w">le1</span><span class="c">6_to_cpu(</span><span class="w">di</span><span class="c">-&gt;</span><span class="w">id2</span><span class="pc">.</span><span class="w">i_data</span><span class="pc">.</span><span class="w">id_count</span><span class="pc">),</span>
	     <span class="w">l</span><span class="pc">e1</span><span class="c">6_to_cpu(</span><span class="w">di</span><span class="c">-&gt;</span><span class="w">i_dyn_features</span><span class="pc">)</span><span class="c">);</span>
<span class="c">}</span>

<span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_write_end_nolock</span><span class="c">(struct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
			   <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="c">os,</span> <span class="c">unsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="w">c</span><span class="pc">op</span><span class="c">ied,</span>
			   <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="pc">p</span><span class="c">age</span><span class="pc">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">fsdata</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m,</span> <span class="w">t</span><span class="pc">o</span><span class="w">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">art</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">o</span><span class="c">s</span> <span class="w">&amp;</span><span class="pc"> (</span><span class="w">PAGE_CACHE_SIZE</span> <span class="c">-</span> <span class="c">1);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span> <span class="c">*</span><span class="pc">i</span><span class="c">node</span> <span class="c">=</span> <span class="w">map</span><span class="pc">p</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_super</span> <span class="c">*</span><span class="w">os</span><span class="c">b</span> <span class="c">=</span> <span class="w">OCFS2_SB</span><span class="c">(</span><span class="pc">i</span><span class="c">node-&gt;</span><span class="w">i_</span><span class="c">sb);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_write_ctxt</span> <span class="c">*</span><span class="w">wc</span> <span class="c">=</span> <span class="w">fsdata</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">ocfs2_dinode</span> <span class="c">*</span><span class="w">di</span> <span class="pc">= (</span><span class="c">struct</span> <span class="c">ocfs2_dinode</span> <span class="c">*)</span><span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_di_bh-</span><span class="c">&gt;</span><span class="w">b_data</span><span class="c">;</span>
	<span class="w">handle_t</span> <span class="w">*ha</span><span class="pc">ndle</span> <span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_handle</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="w">tmppage</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">OCFS2_I</span><span class="c">(</span><span class="w">in</span><span class="c">ode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ip_dyn_features</span> <span class="w">&amp;</span> <span class="w">OCFS2_INLINE_DATA_FL</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ocfs2_write_end_inline</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">po</span><span class="pc">s</span><span class="c">,</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">copied</span><span class="pc">,</span> <span class="w">di</span><span class="pc">,</span> <span class="w">w</span><span class="pc">c)</span><span class="c">;</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">out_write_size</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(unlikely(copied</span> <span class="w">&lt;</span> <span class="w">l</span><span class="pc">en)) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">PageUptodate</span><span class="pc">(</span><span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_target_page</span><span class="c">))</span>
			<span class="pc">cop</span><span class="c">ied</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

		<span class="w">ocfs2_zero_new_buffers</span><span class="c">(</span><span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">w</span><span class="c">_target_page,</span> <span class="w">st</span><span class="pc">a</span><span class="c">rt</span><span class="pc">+c</span><span class="c">opied</span><span class="pc">,</span>
				       <span class="w">st</span><span class="pc">a</span><span class="c">rt</span><span class="pc">+l</span><span class="c">en);</span>
	<span class="c">}</span>
	<span class="w">flush_dcache_page</span><span class="c">(</span><span class="w">wc</span><span class="pc">-</span><span class="c">&gt;w_target_page</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">f</span><span class="pc">o</span><span class="c">r(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_num_pages</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">tmppage</span> <span class="pc">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_pages</span><span class="c">[i];</span>

		<span class="c">if</span> <span class="c">(tmppage</span> <span class="pc">=</span><span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="pc">w_t</span><span class="c">arget_page</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">fr</span><span class="pc">o</span><span class="c">m</span> <span class="pc">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_from</span><span class="c">;</span>
			<span class="w">to</span> <span class="c">=</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_target_to</span><span class="c">;</span>

			<span class="w">B</span><span class="c">UG_ON(</span><span class="w">f</span><span class="pc">ro</span><span class="c">m</span> <span class="c">&gt;</span> <span class="w">PAGE_CACHE_SIZE</span> <span class="w">|</span><span class="c">|</span>
			       <span class="w">to</span> <span class="c">&gt;</span> <span class="pc">P</span><span class="c">AGE_CACHE_SIZE</span> <span class="w">|</span><span class="c">|</span>
			       <span class="w">to</span> <span class="pc">&lt;</span> <span class="w">f</span><span class="pc">ro</span><span class="c">m</span><span class="w">);</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
			
			<span class="w">f</span><span class="pc">r</span><span class="c">om</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="w">to</span> <span class="c">=</span> <span class="w">P</span><span class="c">AGE_CACHE_SIZE</span><span class="pc">;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">page_has_buffers</span><span class="c">(</span><span class="w">tmppage</span><span class="pc">)</span><span class="c">) {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">ocfs2_should_order_data</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">)</span>
				<span class="w">ocfs2_jbd2_file_inode</span><span class="c">(</span><span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w_handle</span><span class="c">,</span> <span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">block_commit_write</span><span class="c">(tmppage</span><span class="pc">,</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m,</span> <span class="w">t</span><span class="pc">o</span><span class="c">);</span>
		<span class="c">}</span>
	<span class="pc">}</span>

<span class="w">out_write_size:</span>
	<span class="w">po</span><span class="pc">s</span> <span class="w">+</span><span class="pc">=</span> <span class="w">copied</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="pc">o</span><span class="c">s</span> <span class="pc">&gt;</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">i_size_write</span><span class="c">(</span><span class="w">i</span><span class="c">node,</span> <span class="w">po</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">mark_inode_dirty</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_blocks</span> <span class="c">=</span> <span class="w">ocfs2_inode_sector_count</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">di</span><span class="c">-&gt;</span><span class="w">i_size</span> <span class="c">=</span> <span class="w">cpu_to_le64(</span><span class="pc">(</span><span class="w">u</span><span class="pc">6</span><span class="c">4)</span><span class="w">i</span><span class="pc">_size_r</span><span class="c">ead</span><span class="pc">(i</span><span class="c">node</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">ode-&gt;</span><span class="w">i_mtime</span> <span class="c">=</span> <span class="c">inode-&gt;</span><span class="w">i_ctime</span> <span class="w">=</span> <span class="w">CURRENT_TIME</span><span class="pc">;</span>
	<span class="w">di</span><span class="c">-&gt;i_mtime</span> <span class="c">=</span> <span class="w">di</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i_c</span><span class="c">time</span> <span class="w">=</span> <span class="w">c</span><span class="pc">pu_to_le6</span><span class="c">4</span><span class="pc">(</span><span class="c">inode</span><span class="pc">-</span><span class="c">&gt;i_mtime</span><span class="pc">.</span><span class="w">tv</span><span class="c">_sec);</span>
	<span class="w">di</span><span class="c">-&gt;</span><span class="w">i_mtime_nsec</span> <span class="c">=</span> <span class="w">di</span><span class="c">-&gt;</span><span class="w">i_ctime_nsec</span> <span class="w">=</span> <span class="w">c</span><span class="pc">pu_to_l</span><span class="c">e32(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode-&gt;</span><span class="w">i</span><span class="pc">_mtime.</span><span class="w">tv_nsec</span><span class="c">);</span>
	<span class="w">ocfs2_update_inode_fsync_trans</span><span class="c">(</span><span class="w">ha</span><span class="pc">ndle,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="w">ocfs2_journal_dirty</span><span class="c">(</span><span class="w">h</span><span class="c">andle</span><span class="pc">,</span> <span class="w">wc</span><span class="c">-&gt;</span><span class="w">w_di_bh</span><span class="c">);</span>

	
	<span class="w">ocfs2_unlock_pages</span><span class="c">(</span><span class="w">wc</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">ocfs2_commit_trans</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">,</span> <span class="w">h</span><span class="pc">a</span><span class="c">ndle);</span>

	<span class="w">ocfs2_run_deallocs</span><span class="c">(</span><span class="w">os</span><span class="c">b</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">w</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">w_dealloc</span><span class="c">);</span>

	<span class="w">brelse</span><span class="c">(</span><span class="w">wc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w</span><span class="pc">_di</span><span class="c">_bh</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">k</span><span class="c">free(</span><span class="w">wc</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">copied</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">ocfs2_write_end</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">address_space</span> <span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
			   <span class="w">l</span><span class="pc">of</span><span class="c">f_t</span> <span class="w">p</span><span class="c">os,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="w">c</span><span class="pc">op</span><span class="c">ied,</span>
			   <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="c">age</span> <span class="c">*</span><span class="pc">p</span><span class="c">age</span><span class="pc">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">fsdata</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">re</span><span class="c">t;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="c">node</span> <span class="c">*inode</span> <span class="pc">=</span> <span class="w">ma</span><span class="pc">pp</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">ocfs2_write_end_nolock</span><span class="c">(</span><span class="w">m</span><span class="pc">app</span><span class="c">ing,</span> <span class="w">p</span><span class="pc">o</span><span class="c">s,</span> <span class="w">l</span><span class="c">en</span><span class="pc">,</span> <span class="w">c</span><span class="pc">op</span><span class="c">ied</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">,</span> <span class="pc">f</span><span class="c">sdata);</span>

	<span class="w">up_write</span><span class="pc">(&amp;</span><span class="w">OCFS2_I</span><span class="pc">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)</span><span class="c">-&gt;</span><span class="w">ip_alloc_sem</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ocfs2_inode_unlock</span><span class="c">(inode,</span> <span class="w">1</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">re</span><span class="c">t;</span>
<span class="c">}</span>

<span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">address_space_operations</span> <span class="w">ocfs2_aops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">readpage</span>		<span class="c">=</span> <span class="w">ocfs2_readpage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">readpages</span>		<span class="c">=</span> <span class="w">ocfs2_readpages</span><span class="c">,</span>
	<span class="c">.</span><span class="w">writepage</span>		<span class="c">=</span> <span class="w">ocfs2_writepage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">write_begin</span>		<span class="c">=</span> <span class="w">ocfs2_write_begin</span><span class="c">,</span>
	<span class="c">.</span><span class="w">write_end</span>		<span class="c">=</span> <span class="w">ocfs2_write_end</span><span class="c">,</span>
	<span class="c">.</span><span class="w">bmap</span>			<span class="c">=</span> <span class="w">ocfs2_bmap</span><span class="c">,</span>
	<span class="c">.</span><span class="w">direct_IO</span>		<span class="c">=</span> <span class="w">ocfs2_direct_IO</span><span class="c">,</span>
	<span class="c">.</span><span class="w">invalidatepage</span>		<span class="c">=</span> <span class="w">block_invalidatepage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">releasepage</span>		<span class="c">=</span> <span class="w">ocfs2_releasepage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">migratepage</span>		<span class="c">=</span> <span class="w">buffer_migrate_page</span><span class="c">,</span>
	<span class="c">.</span><span class="w">is_partially_uptodate</span>	<span class="c">=</span> <span class="w">block_is_partially_uptodate</span><span class="c">,</span>
	<span class="c">.</span><span class="w">error_remove_page</span>	<span class="c">=</span> <span class="w">generic_error_remove_page</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

</pre>
</body>
</html>

