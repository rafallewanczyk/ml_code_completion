<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/init.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/pci.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/dma-mapping.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">nterr</span><span class="c">upt.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">compiler</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">m</span><span class="c">odule.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">i</span><span class="c">o.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">c</span><span class="pc">o</span><span class="c">re.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">pc</span><span class="pc">m</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">initval</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="w">s</span><span class="pc">o</span><span class="c">und/</span><span class="w">ac97_codec</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">ad1889</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">ac9</span><span class="pc">7/</span><span class="w">ac97_id</span><span class="c">.h"</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span>	<span class="w">AD1889_DRVVER</span>	<span class="c">"</span><span class="w">Version</span><span class="pc">:</span> <span class="pc">1</span><span class="c">.</span><span class="w">7</span><span class="c">"</span>

<span class="w">M</span><span class="c">ODULE_AUTHOR("</span><span class="w">Kyle</span> <span class="w">McMartin</span> <span class="c">&lt;</span><span class="w">kyle</span><span class="pc">@</span><span class="w">parisc</span><span class="pc">-</span><span class="w">l</span><span class="c">inux.</span><span class="w">org&gt;,</span> <span class="w">Thibaut</span> <span class="w">Varene</span> <span class="w">&lt;t</span><span class="pc">-</span><span class="w">bone</span><span class="pc">@</span><span class="c">parisc</span><span class="pc">-</span><span class="w">l</span><span class="pc">inu</span><span class="c">x.</span><span class="pc">o</span><span class="c">rg</span><span class="w">&gt;</span><span class="pc">"</span><span class="c">);</span>
<span class="c">MODULE_DESCRIPTION("</span><span class="w">Analog</span> <span class="w">Devices</span> <span class="w">AD1889</span> <span class="w">ALSA</span> <span class="w">so</span><span class="pc">u</span><span class="c">nd</span> <span class="c">driver</span><span class="pc">")</span><span class="c">;</span>
<span class="c">MODULE_LICENSE("GPL");</span>
<span class="w">MODULE_SUPPORTED_DEVICE("{{A</span><span class="pc">n</span><span class="c">alog</span> <span class="w">D</span><span class="c">evices</span><span class="pc">,</span><span class="w">A</span><span class="pc">D</span><span class="c">1889</span><span class="w">}}");</span>

<span class="w">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span><span class="pc">[</span><span class="w">SNDRV_CARDS] </span><span class="pc">=</span> <span class="w">SNDRV_DEFAULT_IDX</span><span class="c">;</span>
<span class="w">module_param_array</span><span class="pc">(</span><span class="w">ind</span><span class="pc">e</span><span class="c">x,</span> <span class="w">in</span><span class="pc">t</span><span class="c">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">0</span><span class="pc">4</span><span class="c">44);</span>
<span class="c">MODULE_PARM_DESC(</span><span class="w">ind</span><span class="c">ex, "</span><span class="w">Index</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue</span> <span class="w">f</span><span class="c">or</span> <span class="w">t</span><span class="c">he</span> <span class="w">A</span><span class="pc">D</span><span class="c">1889</span> <span class="w">soundcard.</span><span class="pc">"</span><span class="c">);</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="w">c</span><span class="c">har</span> <span class="c">*</span><span class="w">i</span><span class="pc">d[</span><span class="w">S</span><span class="c">NDRV_CARDS</span><span class="pc">] =</span> <span class="w">SNDRV_DEFAULT_STR</span><span class="pc">;</span>
<span class="w">m</span><span class="c">odule_param_array</span><span class="pc">(</span><span class="w">i</span><span class="c">d,</span> <span class="w">charp</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">04</span><span class="c">44</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">M</span><span class="c">ODULE_PARM_DESC(</span><span class="pc">i</span><span class="c">d, "</span><span class="w">I</span><span class="pc">D</span> <span class="w">st</span><span class="pc">ri</span><span class="c">ng</span> <span class="pc">f</span><span class="c">or</span> <span class="c">the</span> <span class="w">A</span><span class="c">D1889</span> <span class="pc">s</span><span class="c">oundcard</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="w">b</span><span class="c">ool</span> <span class="w">e</span><span class="pc">nable</span><span class="w">[</span><span class="pc">SNDRV_C</span><span class="c">ARDS] =</span> <span class="w">SNDRV_DEFAULT_ENABLE_PNP</span><span class="pc">;</span>
<span class="pc">m</span><span class="c">odule_param_array</span><span class="pc">(</span><span class="w">ena</span><span class="c">ble,</span> <span class="w">bo</span><span class="pc">o</span><span class="c">l</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">0</span><span class="pc">4</span><span class="c">44);</span>
<span class="c">MODULE_PARM_DESC(</span><span class="w">e</span><span class="c">nable, "</span><span class="w">Enable</span> <span class="w">A</span><span class="c">D1889</span> <span class="pc">s</span><span class="c">oundcard</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>

<span class="c">static</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">ac97_quirk</span><span class="pc">[</span><span class="w">S</span><span class="pc">NDRV_C</span><span class="c">ARDS</span><span class="pc">];</span>
<span class="w">m</span><span class="pc">odule_param_</span><span class="c">array</span><span class="pc">(a</span><span class="c">c97_quirk,</span> <span class="w">charp</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">04</span><span class="c">44);</span>
<span class="c">MODULE_PARM_DESC(</span><span class="pc">a</span><span class="c">c97_quirk, "</span><span class="w">AC'97</span> <span class="w">workaround</span> <span class="w">f</span><span class="c">or</span> <span class="w">strange</span> <span class="w">h</span><span class="c">ardware</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">DEVNAME</span> <span class="pc">"</span><span class="w">ad1889</span><span class="c">"</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">PFX</span>	<span class="w">D</span><span class="c">EVNAME</span> <span class="w">": "</span>


<span class="w">s</span><span class="c">truct</span> <span class="w">ad1889_register_state</span> <span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">reg</span><span class="c">;</span>	
	<span class="pc">u3</span><span class="c">2</span> <span class="w">a</span><span class="pc">dd</span><span class="c">r;</span>	
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="pc">s</span><span class="c">ize;</span>	
<span class="pc">}</span><span class="c">;</span>

<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_card</span> <span class="pc">*</span><span class="w">c</span><span class="pc">a</span><span class="c">rd;</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">c</span><span class="c">i_dev</span> <span class="c">*</span><span class="w">pc</span><span class="pc">i</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">nt</span> <span class="c">irq;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">bar</span><span class="c">;</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">__iomem</span> <span class="c">*</span><span class="w">i</span><span class="pc">ob</span><span class="c">ase;</span>

	<span class="c">struct</span> <span class="w">snd_ac97</span> <span class="c">*</span><span class="w">a</span><span class="pc">c</span><span class="c">97;</span>
	<span class="c">struct</span> <span class="w">snd_ac97_bus</span> <span class="c">*</span><span class="w">ac97_bus</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">snd_pcm</span> <span class="c">*</span><span class="w">pc</span><span class="pc">m</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">snd_info_entry</span> <span class="c">*</span><span class="w">pro</span><span class="pc">c</span><span class="c">;</span>

	<span class="c">struct</span> <span class="w">s</span><span class="pc">nd_pcm_</span><span class="c">substream</span> <span class="c">*</span><span class="w">psubs</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">s</span><span class="pc">nd_pcm_</span><span class="c">substream</span> <span class="c">*</span><span class="w">csubs</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="w">ad1889_register_state</span> <span class="w">wave</span><span class="c">;</span>
	<span class="c">struct</span> <span class="c">ad1889_register_state</span> <span class="w">ramc</span><span class="c">;</span>

	<span class="pc">sp</span><span class="c">inlock_t</span> <span class="c">lock;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="c">inline</span> <span class="w">u1</span><span class="c">6</span>
<span class="w">ad1889_readw</span><span class="c">(struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">ch</span><span class="c">ip</span><span class="pc">,</span> <span class="pc">un</span><span class="c">signed</span> <span class="w">r</span><span class="c">eg)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">readw</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">io</span><span class="pc">b</span><span class="c">ase</span> <span class="c">+</span> <span class="pc">r</span><span class="c">eg);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span>
<span class="w">ad1889_writew</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="c">unsigned</span> <span class="pc">r</span><span class="c">eg,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="c">val)</span>
<span class="c">{</span>
	<span class="w">w</span><span class="pc">ritew</span><span class="c">(val,</span> <span class="w">c</span><span class="c">hip-&gt;</span><span class="pc">i</span><span class="c">obase</span> <span class="c">+</span> <span class="c">reg);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="pc">u3</span><span class="c">2</span>
<span class="w">ad1889_readl</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*</span><span class="pc">ch</span><span class="c">ip,</span> <span class="pc">un</span><span class="c">signed</span> <span class="pc">r</span><span class="c">eg)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">r</span><span class="c">eadl(</span><span class="pc">c</span><span class="c">hip-&gt;</span><span class="pc">i</span><span class="c">obase</span> <span class="c">+</span> <span class="c">reg);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span>
<span class="w">ad1889_writel</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="c">unsigned</span> <span class="pc">r</span><span class="c">eg,</span> <span class="pc">u3</span><span class="c">2</span> <span class="c">val)</span>
<span class="c">{</span>
	<span class="c">writel(val,</span> <span class="w">c</span><span class="c">hip-&gt;</span><span class="w">i</span><span class="c">obase</span> <span class="c">+</span> <span class="c">reg);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span>
<span class="w">ad1889_unmute</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u1</span><span class="c">6</span> <span class="w">st</span><span class="c">;</span>
	<span class="w">st</span> <span class="pc">=</span> <span class="w">ad1889_readw</span><span class="c">(chip,</span> <span class="w">AD_DS_WADA)</span><span class="pc"> </span><span class="c">&amp;</span> 
		<span class="w">~(AD_DS_WADA_RWAM</span> <span class="w">|</span> <span class="w">AD_DS_WADA_LWAM</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ad1889_writew</span><span class="c">(chip,</span> <span class="w">A</span><span class="pc">D_DS_WADA</span><span class="c">,</span> <span class="w">st</span><span class="c">);</span>
	<span class="w">a</span><span class="pc">d1889_r</span><span class="c">eadw(</span><span class="pc">c</span><span class="c">hip,</span> <span class="c">AD_DS_WADA</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="c">void</span>
<span class="w">ad1889_mute</span><span class="c">(struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">st</span><span class="pc">;</span>
	<span class="w">st</span> <span class="pc">=</span> <span class="w">a</span><span class="c">d1889_readw(chip,</span> <span class="c">AD_DS_WADA</span><span class="w">) </span><span class="pc">|</span> <span class="w">AD_DS_WADA_RWAM</span> <span class="pc">|</span> <span class="w">AD_DS_WADA_LWAM</span><span class="pc">;</span>
	<span class="w">ad1889_writew</span><span class="c">(chip,</span> <span class="pc">A</span><span class="c">D_DS_WADA,</span> <span class="w">st</span><span class="c">);</span>
	<span class="w">a</span><span class="pc">d1889_r</span><span class="c">eadw(chip,</span> <span class="c">AD_DS_WADA</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">i</span><span class="pc">nl</span><span class="c">ine</span> <span class="c">void</span>
<span class="w">ad1889_load_adc_buffer_address</span><span class="c">(struct</span> <span class="w">snd_ad1889</span> <span class="c">*chip,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss)</span>
<span class="c">{</span>
	<span class="w">ad1889_writel</span><span class="c">(chip,</span> <span class="w">AD_DMA_ADCBA</span><span class="c">,</span> <span class="w">add</span><span class="pc">re</span><span class="c">ss</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">a</span><span class="pc">d1889_writel</span><span class="c">(chip,</span> <span class="w">AD_DMA_ADCCA</span><span class="c">,</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nline</span> <span class="c">void</span>
<span class="w">ad1889_load_adc_buffer_count</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="c">u32</span> <span class="w">c</span><span class="c">ount</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_ADCBC</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt);</span>
	<span class="pc">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_ADCCC</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span>
<span class="w">ad1889_load_adc_interrupt_count</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">c</span><span class="c">ount</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_ADCIB</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_ADCIC</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span>
<span class="w">ad1889_load_wave_buffer_address</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_WAVBA</span><span class="c">,</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_WAVCA</span><span class="c">,</span> <span class="w">a</span><span class="pc">ddre</span><span class="c">ss);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span>
<span class="w">ad1889_load_wave_buffer_count</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="c">u32</span> <span class="w">c</span><span class="c">ount</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_WAVBC</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt);</span>
	<span class="pc">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_WAVCC</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span>
<span class="w">ad1889_load_wave_interrupt_count</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">c</span><span class="c">ount</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_WAVIB</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">a</span><span class="c">d1889_writel(chip,</span> <span class="w">AD_DMA_WAVIC</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">ad1889_channel_reset</span><span class="c">(struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip,</span> <span class="c">unsigned</span> <span class="c">int</span> <span class="w">ch</span><span class="pc">a</span><span class="c">nnel)</span>
<span class="c">{</span>
	<span class="w">u1</span><span class="c">6</span> <span class="c">reg;</span>
	
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">ch</span><span class="pc">a</span><span class="c">nnel</span> <span class="w">&amp;</span> <span class="w">AD_CHAN_WAV</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="pc">r</span><span class="c">eg</span> <span class="c">=</span> <span class="w">ad1889_readw</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">AD_DS_WSMC)</span><span class="pc"> &amp; </span><span class="c">~</span><span class="w">AD_DS_WSMC_WAEN</span><span class="c">;</span>
		<span class="w">ad1889_writew</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="pc">A</span><span class="c">D_DS_WSMC,</span> <span class="c">reg);</span>
		<span class="w">c</span><span class="c">hip-&gt;</span><span class="w">wave</span><span class="pc">.r</span><span class="c">eg</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eg;</span>
		
		
		<span class="pc">r</span><span class="c">eg</span> <span class="c">=</span> <span class="w">a</span><span class="c">d1889_readw(chip,</span> <span class="w">AD_DMA_WAV</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">reg</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">AD_DMA_IM_DIS</span><span class="c">;</span>
		<span class="c">reg</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">AD_DMA_LOOP</span><span class="c">;</span>
		<span class="w">a</span><span class="pc">d1889_w</span><span class="c">ritew(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">A</span><span class="pc">D_DM</span><span class="c">A_WAV,</span> <span class="c">reg);</span>

		
		<span class="w">ad1889_load_wave_buffer_address</span><span class="c">(chip,</span> <span class="w">0x0</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ad1889_load_wave_buffer_count</span><span class="c">(chip,</span> <span class="w">0x0</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ad1889_load_wave_interrupt_count</span><span class="c">(chip,</span> <span class="w">0</span><span class="pc">x0</span><span class="c">);</span>

		
		<span class="w">a</span><span class="c">d1889_readw(chip</span><span class="pc">,</span> <span class="c">AD_DMA_WAV);</span>
	<span class="c">}</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ch</span><span class="pc">ann</span><span class="c">el</span> <span class="c">&amp;</span> <span class="w">AD_CHAN_ADC</span><span class="c">) {</span>
		
		<span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span> <span class="w">a</span><span class="pc">d1889_r</span><span class="c">eadw(chip,</span> <span class="w">AD_DS_RAMC)</span><span class="pc"> &amp; </span><span class="c">~</span><span class="w">AD_DS_RAMC_ADEN</span><span class="c">;</span>
		<span class="w">ad1889_writew</span><span class="c">(chip,</span> <span class="pc">A</span><span class="c">D_DS_RAMC,</span> <span class="c">reg);</span>
		<span class="w">c</span><span class="c">hip-&gt;</span><span class="w">ramc</span><span class="pc">.r</span><span class="c">eg</span> <span class="c">=</span> <span class="pc">r</span><span class="c">eg;</span>

		<span class="pc">reg</span> <span class="c">=</span> <span class="w">a</span><span class="c">d1889_readw(chip,</span> <span class="w">AD_DMA_ADC</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">reg</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">AD_DMA_IM_DIS</span><span class="c">;</span>
		<span class="c">reg</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">AD_DMA_LOOP</span><span class="c">;</span>
		<span class="w">a</span><span class="pc">d1889_w</span><span class="c">ritew(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">A</span><span class="pc">D_DM</span><span class="c">A_ADC,</span> <span class="c">reg);</span>
	
		<span class="w">ad1889_load_adc_buffer_address</span><span class="c">(chip,</span> <span class="w">0x0</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ad1889_load_adc_buffer_count</span><span class="c">(chip,</span> <span class="w">0x0</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">ad1889_load_adc_interrupt_count</span><span class="c">(chip,</span> <span class="w">0</span><span class="pc">x0</span><span class="c">);</span>

		
		<span class="w">a</span><span class="c">d1889_readw(chip</span><span class="pc">,</span> <span class="c">AD_DMA_ADC);</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span>
<span class="w">snd_ad1889_ac97_read</span><span class="c">(struct</span> <span class="w">snd_ac97</span> <span class="c">*</span><span class="w">a</span><span class="pc">c</span><span class="c">97</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="w">s</span><span class="c">hort</span> <span class="c">reg)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*chip</span> <span class="c">=</span> <span class="w">a</span><span class="pc">c</span><span class="c">97</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pr</span><span class="pc">ivate_</span><span class="c">data;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">a</span><span class="pc">d1889_r</span><span class="c">eadw(chip,</span> <span class="w">AD_AC97_BASE</span> <span class="w">+</span> <span class="pc">r</span><span class="c">eg</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">snd_ad1889_ac97_write</span><span class="c">(struct</span> <span class="c">snd_ac97</span> <span class="c">*</span><span class="w">a</span><span class="pc">c</span><span class="c">97,</span> <span class="c">unsigned</span> <span class="w">s</span><span class="c">hort</span> <span class="c">reg,</span> <span class="c">unsigned</span> <span class="pc">s</span><span class="c">hort</span> <span class="c">val)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">snd_ad1889</span> <span class="c">*chip</span> <span class="c">=</span> <span class="w">a</span><span class="pc">c</span><span class="c">97-&gt;</span><span class="w">pr</span><span class="pc">ivate_</span><span class="c">data;</span>
	<span class="w">ad1889_writew</span><span class="c">(chip,</span> <span class="w">A</span><span class="c">D_AC97_BASE</span> <span class="pc">+</span> <span class="c">reg,</span> <span class="pc">v</span><span class="c">al);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_ac97_ready</span><span class="c">(struct</span> <span class="pc">snd_ad</span><span class="c">1889</span> <span class="c">*chip</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">ret</span><span class="pc">r</span><span class="c">y</span> <span class="pc">=</span> <span class="w">400</span><span class="pc">;</span> 
	
	<span class="w">w</span><span class="c">hile</span> <span class="pc">(!(</span><span class="w">ad1889_readw</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_AC97_ACIC</span><span class="pc">)</span><span class="c"> &amp;</span> <span class="w">AD_AC97_ACIC_ACRDY</span><span class="pc">)</span> 
			<span class="w">&amp;&amp; --ret</span><span class="pc">r</span><span class="c">y</span><span class="w">)</span>
		<span class="w">m</span><span class="pc">d</span><span class="c">elay(</span><span class="pc">1</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">ret</span><span class="pc">r</span><span class="c">y</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">d</span><span class="c">ev_err(</span><span class="pc">c</span><span class="c">hip-&gt;</span><span class="w">ca</span><span class="pc">r</span><span class="c">d</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="w">, "[%s]</span> <span class="w">Link</span> <span class="w">i</span><span class="c">s</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">r</span><span class="pc">eady.</span><span class="c">\n",</span>
			<span class="c">__func__);</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">d</span><span class="c">ev_dbg</span><span class="pc">(ch</span><span class="c">ip-&gt;</span><span class="w">ca</span><span class="c">rd-&gt;dev</span><span class="w">, "</span><span class="pc">[</span><span class="c">%</span><span class="w">s]</span> <span class="w">rea</span><span class="pc">dy</span> <span class="w">after</span> <span class="pc">%</span><span class="c">d</span> <span class="w">m</span><span class="pc">s\</span><span class="c">n",</span> <span class="c">__func__</span><span class="pc">,</span> <span class="w">400</span> <span class="w">-</span> <span class="w">ret</span><span class="pc">r</span><span class="c">y);</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> 
<span class="w">snd_ad1889_hw_params</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*substream,</span>
			<span class="c">struct</span> <span class="w">snd_pcm_hw_params</span> <span class="c">*</span><span class="w">hw_params</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">snd_pcm_lib_malloc_pages</span><span class="c">(</span><span class="w">su</span><span class="pc">bs</span><span class="c">tream,</span> 
					<span class="w">params_buffer_bytes</span><span class="pc">(</span><span class="c">hw_params</span><span class="pc">))</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_hw_free</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">nd_pcm_s</span><span class="c">ubstream</span> <span class="c">*substream)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">snd_pcm_lib_free_pages</span><span class="c">(</span><span class="w">su</span><span class="c">bstream</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_pcm_hardware</span> <span class="w">snd_ad1889_playback_hw</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="c">=</span> <span class="w">SNDRV_PCM_INFO_MMAP</span> <span class="pc">|</span> <span class="w">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="pc">|</span>
		<span class="w">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="c">|</span> <span class="w">SNDRV_PCM_INFO_BLOCK_TRANSFER</span><span class="pc">,</span>
	<span class="c">.</span><span class="w">formats</span> <span class="c">=</span> <span class="w">SNDRV_PCM_FMTBIT_S16_LE</span><span class="c">,</span>
	<span class="c">.</span><span class="w">ra</span><span class="pc">t</span><span class="c">es</span> <span class="c">=</span> <span class="w">SNDRV_PCM_RATE_CONTINUOUS</span> <span class="pc">|</span> <span class="w">SNDRV_PCM_RATE_8000_48000</span><span class="pc">,</span>
	<span class="c">.</span><span class="w">rate_min</span> <span class="c">=</span> <span class="w">8000</span><span class="c">,</span>	
	<span class="c">.</span><span class="w">rate_max</span> <span class="c">=</span> <span class="w">48000</span><span class="c">,</span>
	<span class="c">.</span><span class="w">channels_min</span> <span class="c">=</span> <span class="c">1,</span>
	<span class="c">.</span><span class="w">channels_max</span> <span class="c">=</span> <span class="pc">2</span><span class="c">,</span>
	<span class="c">.</span><span class="w">buffer_bytes_max</span> <span class="c">=</span> <span class="w">BUFFER_BYTES_MAX</span><span class="c">,</span>
	<span class="c">.</span><span class="w">period_bytes_min</span> <span class="c">=</span> <span class="w">PERIOD_BYTES_MIN</span><span class="c">,</span>
	<span class="c">.</span><span class="w">period_bytes_max</span> <span class="c">=</span> <span class="w">PERIOD_BYTES_MAX</span><span class="c">,</span>
	<span class="c">.</span><span class="w">periods_min</span> <span class="c">=</span> <span class="w">PERIODS_MIN</span><span class="c">,</span>
	<span class="c">.</span><span class="w">periods_max</span> <span class="c">=</span> <span class="w">PERIODS_MAX</span><span class="c">,</span>
	
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_pcm_hardware</span> <span class="w">snd_ad1889_capture_hw</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span> <span class="pc">=</span> <span class="w">SNDRV_PCM_INFO_MMAP</span> <span class="pc">|</span> <span class="w">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="pc">|</span>
		<span class="w">SNDRV_PCM_INFO_MMAP_VALID</span> <span class="pc">|</span> <span class="w">SNDRV_PCM_INFO_BLOCK_TRANSFER</span><span class="pc">,</span>
	<span class="c">.</span><span class="w">formats</span> <span class="c">=</span> <span class="w">SNDRV_PCM_FMTBIT_S16_LE</span><span class="c">,</span>
	<span class="c">.</span><span class="w">ra</span><span class="pc">t</span><span class="c">es</span> <span class="c">=</span> <span class="w">SNDRV_PCM_RATE_48000</span><span class="c">,</span>
	<span class="c">.</span><span class="w">rate_min</span> <span class="c">=</span> <span class="w">48000</span><span class="c">,</span>	
	<span class="c">.</span><span class="w">rate_max</span> <span class="c">=</span> <span class="pc">4</span><span class="c">8000,</span>
	<span class="c">.</span><span class="w">channels_min</span> <span class="c">=</span> <span class="c">1,</span>
	<span class="c">.</span><span class="w">channels_max</span> <span class="c">=</span> <span class="pc">2</span><span class="c">,</span>
	<span class="c">.</span><span class="w">buffer_bytes_max</span> <span class="c">=</span> <span class="w">BUFFER_BYTES_MAX</span><span class="c">,</span>
	<span class="c">.</span><span class="w">period_bytes_min</span> <span class="c">=</span> <span class="w">PERIOD_BYTES_MIN</span><span class="c">,</span>
	<span class="c">.</span><span class="w">period_bytes_max</span> <span class="c">=</span> <span class="w">PERIOD_BYTES_MAX</span><span class="c">,</span>
	<span class="c">.</span><span class="w">periods_min</span> <span class="c">=</span> <span class="w">PERIODS_MIN</span><span class="c">,</span>
	<span class="c">.</span><span class="w">periods_max</span> <span class="c">=</span> <span class="w">PERIODS_MAX</span><span class="c">,</span>
	
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_playback_open</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span> <span class="c">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="c">struct</span> <span class="w">snd_pcm_runtime</span> <span class="c">*</span><span class="w">rt</span> <span class="c">=</span> <span class="w">ss</span><span class="c">-&gt;</span><span class="w">ru</span><span class="c">ntime;</span>

	<span class="w">chi</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">psubs</span> <span class="c">=</span> <span class="w">ss</span><span class="pc">;</span>
	<span class="w">rt</span><span class="c">-&gt;</span><span class="w">h</span><span class="pc">w</span> <span class="pc">=</span> <span class="w">snd_ad1889_playback_hw</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_capture_open</span><span class="c">(struct</span> <span class="w">sn</span><span class="pc">d_pcm_s</span><span class="c">ubstream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="c">hip</span> <span class="c">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="c">struct</span> <span class="w">snd_pcm_runtime</span> <span class="c">*</span><span class="w">rt</span> <span class="c">=</span> <span class="w">ss</span><span class="c">-&gt;</span><span class="w">ru</span><span class="c">ntime;</span>

	<span class="w">chi</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">csubs</span> <span class="c">=</span> <span class="w">ss</span><span class="pc">;</span>
	<span class="w">rt</span><span class="c">-&gt;</span><span class="w">h</span><span class="pc">w</span> <span class="pc">=</span> <span class="w">snd_ad1889_capture_hw</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_playback_close</span><span class="c">(struct</span> <span class="w">sn</span><span class="pc">d_pcm_s</span><span class="c">ubstream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="c">hip</span> <span class="c">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="w">c</span><span class="pc">hi</span><span class="c">p-&gt;</span><span class="w">psubs</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_capture_close</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">nd_p</span><span class="c">cm_substream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">snd_ad1889</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip</span> <span class="c">=</span> <span class="pc">s</span><span class="c">nd_pcm_substream_chip(</span><span class="w">ss</span><span class="c">);</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">csubs</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_playback_prepare</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">nd_p</span><span class="c">cm_substream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">snd_ad1889</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip</span> <span class="c">=</span> <span class="pc">s</span><span class="c">nd_pcm_substream_chip(</span><span class="w">ss</span><span class="c">);</span>
	<span class="c">struct</span> <span class="w">snd_pcm_runtime</span> <span class="c">*</span><span class="w">rt</span> <span class="c">=</span> <span class="w">ss</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">u</span><span class="c">ntime;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">=</span> <span class="w">snd_pcm_lib_buffer_bytes</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">c</span><span class="c">ount</span> <span class="pc">=</span> <span class="w">snd_pcm_lib_period_bytes</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">r</span><span class="c">eg</span><span class="pc">;</span>

	<span class="w">ad1889_channel_reset</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">AD_CHAN_WAV</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="w">ad1889_readw</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DS_WSMC</span><span class="c">);</span>
	
	
	<span class="pc">r</span><span class="c">eg</span> <span class="pc">&amp;= ~(</span><span class="w">AD_DS_WSMC_WA16</span> <span class="c">|</span> <span class="w">AD_DS_WSMC_WAST</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">snd_pcm_format_width</span><span class="c">(</span><span class="w">rt-</span><span class="c">&gt;</span><span class="w">f</span><span class="pc">o</span><span class="c">rmat</span><span class="w">)</span><span class="pc"> =</span><span class="c">=</span> <span class="w">1</span><span class="pc">6</span><span class="c">)</span>
		<span class="pc">reg</span> <span class="c">|=</span> <span class="w">A</span><span class="pc">D_DS_WSMC_WA1</span><span class="c">6</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rt</span><span class="c">-&gt;</span><span class="w">cha</span><span class="pc">nnels</span> <span class="pc">&gt;</span> <span class="pc">1</span><span class="c">)</span>
		<span class="w">r</span><span class="pc">eg</span> <span class="c">|=</span> <span class="w">A</span><span class="pc">D_DS_WSMC_WAS</span><span class="c">T;</span>

	
	<span class="w">spin_l</span><span class="pc">ock_irq</span><span class="c">(&amp;</span><span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;lock);</span>
	
	<span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;</span><span class="w">wave.s</span><span class="pc">i</span><span class="c">ze</span> <span class="c">=</span> <span class="w">s</span><span class="pc">ize</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">hip-&gt;wave.</span><span class="w">r</span><span class="c">eg</span> <span class="c">=</span> <span class="w">r</span><span class="pc">eg</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">hip-&gt;wave.</span><span class="w">a</span><span class="c">ddr</span> <span class="c">=</span> <span class="w">rt</span><span class="c">-&gt;</span><span class="w">dm</span><span class="pc">a_</span><span class="c">addr;</span>

	<span class="w">ad1889_writew</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DS_WSMC</span><span class="c">,</span> <span class="pc">c</span><span class="c">hip-&gt;wave.</span><span class="pc">r</span><span class="c">eg</span><span class="pc">)</span><span class="c">;</span>
	
	
	<span class="pc">a</span><span class="c">d1889_writew(chip,</span> <span class="w">AD_DS_WAS</span><span class="c">,</span> <span class="w">rt</span><span class="c">-&gt;</span><span class="w">ra</span><span class="c">te</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">ad1889_load_wave_buffer_address</span><span class="c">(chip,</span> <span class="pc">c</span><span class="c">hip-&gt;wave</span><span class="pc">.</span><span class="w">a</span><span class="pc">dd</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ad1889_load_wave_buffer_count</span><span class="c">(chip,</span> <span class="w">s</span><span class="c">ize</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ad1889_load_wave_interrupt_count</span><span class="c">(chip,</span> <span class="w">c</span><span class="pc">ou</span><span class="c">nt</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">ad1889_readw</span><span class="c">(chip,</span> <span class="w">AD_DS_WSMC</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">sp</span><span class="pc">in_unlock_irq(&amp;</span><span class="c">chip-&gt;</span><span class="w">l</span><span class="c">ock);</span>
	
	<span class="w">d</span><span class="c">ev_dbg</span><span class="pc">(</span><span class="c">chip-&gt;</span><span class="w">ca</span><span class="c">rd-&gt;</span><span class="pc">dev</span><span class="c">,</span>
		<span class="w">"prepare</span> <span class="w">playback</span><span class="pc">:</span> <span class="w">ad</span><span class="pc">dr</span> <span class="w">=</span> <span class="c">0x%x,</span> <span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="pc">=</span><span class="c"> %</span><span class="w">u</span><span class="pc">,</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">= </span><span class="c">%</span><span class="w">u</span><span class="c">,</span> <span class="w">r</span><span class="pc">eg</span> <span class="w">=</span> <span class="c">0x%x,</span> <span class="w">ra</span><span class="c">te</span> <span class="pc">=</span><span class="c"> %</span><span class="pc">u\</span><span class="c">n",</span>
		<span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;</span><span class="w">wave</span><span class="pc">.a</span><span class="c">ddr,</span> <span class="w">c</span><span class="c">ount,</span> <span class="pc">s</span><span class="c">ize,</span> <span class="w">r</span><span class="c">eg,</span> <span class="w">rt</span><span class="c">-&gt;</span><span class="w">ra</span><span class="pc">t</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_capture_prepare</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip</span> <span class="c">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="c">struct</span> <span class="w">snd_pcm_runtime</span> <span class="c">*</span><span class="w">rt</span> <span class="c">=</span> <span class="w">ss</span><span class="c">-&gt;</span><span class="w">ru</span><span class="c">ntime;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">=</span> <span class="w">snd_pcm_lib_buffer_bytes</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">c</span><span class="c">ount</span> <span class="pc">=</span> <span class="w">snd_pcm_lib_period_bytes</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">r</span><span class="c">eg</span><span class="pc">;</span>

	<span class="w">ad1889_channel_reset</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">AD_CHAN_ADC</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="w">ad1889_readw</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DS_RAMC</span><span class="c">);</span>

	
	<span class="pc">r</span><span class="c">eg</span> <span class="pc">&amp;= ~(</span><span class="w">AD_DS_RAMC_AD16</span> <span class="c">|</span> <span class="w">AD_DS_RAMC_ADST</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">snd_pcm_format_width</span><span class="c">(</span><span class="w">rt-</span><span class="c">&gt;</span><span class="w">f</span><span class="pc">o</span><span class="c">rmat</span><span class="w">)</span><span class="pc"> =</span><span class="c">=</span> <span class="w">1</span><span class="pc">6</span><span class="c">)</span>
		<span class="pc">reg</span> <span class="c">|=</span> <span class="w">A</span><span class="pc">D_DS_RAMC_AD1</span><span class="c">6</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rt</span><span class="c">-&gt;</span><span class="w">cha</span><span class="pc">nnels</span> <span class="pc">&gt;</span> <span class="pc">1</span><span class="c">)</span>
		<span class="w">r</span><span class="pc">eg</span> <span class="c">|=</span> <span class="w">A</span><span class="pc">D_DS_RAMC_ADS</span><span class="c">T;</span>

	
	<span class="w">spin_l</span><span class="pc">ock_irq</span><span class="c">(&amp;</span><span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;lock);</span>
	
	<span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;</span><span class="w">ramc.s</span><span class="pc">i</span><span class="c">ze</span> <span class="c">=</span> <span class="w">s</span><span class="pc">ize</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">hip-&gt;ramc.</span><span class="w">r</span><span class="c">eg</span> <span class="c">=</span> <span class="w">r</span><span class="pc">eg</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">hip-&gt;ramc.</span><span class="w">a</span><span class="c">ddr</span> <span class="c">=</span> <span class="w">rt</span><span class="c">-&gt;</span><span class="w">dm</span><span class="pc">a_</span><span class="c">addr;</span>

	<span class="w">ad1889_writew</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DS_RAMC</span><span class="c">,</span> <span class="pc">c</span><span class="c">hip-&gt;ramc.</span><span class="pc">r</span><span class="c">eg</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">ad1889_load_adc_buffer_address</span><span class="c">(chip</span><span class="pc">,</span> <span class="pc">c</span><span class="c">hip-&gt;</span><span class="w">r</span><span class="pc">a</span><span class="c">mc</span><span class="pc">.</span><span class="w">a</span><span class="pc">dd</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ad1889_load_adc_buffer_count</span><span class="c">(chip,</span> <span class="w">s</span><span class="c">ize</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ad1889_load_adc_interrupt_count</span><span class="c">(chip,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">ad1889_readw</span><span class="c">(chip,</span> <span class="w">A</span><span class="c">D_DS_RAMC</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">sp</span><span class="pc">in_unlock_irq(&amp;</span><span class="c">chip-&gt;</span><span class="pc">l</span><span class="c">ock);</span>
	
	<span class="w">d</span><span class="c">ev_dbg(chip-&gt;</span><span class="w">ca</span><span class="c">rd-&gt;</span><span class="pc">dev</span><span class="c">,</span>
		<span class="w">"prepare</span> <span class="w">capture</span><span class="pc">:</span> <span class="w">ad</span><span class="pc">dr</span> <span class="w">=</span> <span class="c">0x%x,</span> <span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="pc">=</span><span class="c"> %</span><span class="w">u</span><span class="pc">,</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">= </span><span class="c">%</span><span class="w">u</span><span class="c">,</span> <span class="w">r</span><span class="pc">eg</span> <span class="w">=</span> <span class="c">0x%x,</span> <span class="w">ra</span><span class="c">te</span> <span class="pc">=</span><span class="c"> %</span><span class="pc">u\</span><span class="c">n",</span>
		<span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;</span><span class="w">ramc</span><span class="pc">.a</span><span class="c">ddr,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt,</span> <span class="pc">s</span><span class="c">ize,</span> <span class="w">r</span><span class="pc">e</span><span class="c">g,</span> <span class="w">rt</span><span class="c">-&gt;</span><span class="w">ra</span><span class="pc">t</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_playback_trigger</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="w">ss</span><span class="c">,</span> <span class="w">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">m</span><span class="c">d</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">wsmc</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span> <span class="pc">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>
	
	<span class="w">w</span><span class="c">smc</span> <span class="c">=</span> <span class="w">ad1889_readw</span><span class="c">(</span><span class="pc">c</span><span class="c">hip</span><span class="pc">,</span> <span class="w">AD_DS_WSMC</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">s</span><span class="c">witch</span> <span class="c">(</span><span class="pc">cm</span><span class="c">d) {</span>
	<span class="c">case</span> <span class="w">SNDRV_PCM_TRIGGER_START</span><span class="c">:</span>
		
		<span class="w">ad1889_writew</span><span class="c">(</span><span class="w">ch</span><span class="c">ip,</span> <span class="w">AD_DMA_WAV</span><span class="c">,</span> <span class="w">AD_DMA_LOOP</span> <span class="pc">|</span> <span class="w">AD_DMA_IM_CNT</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">w</span><span class="c">smc</span> <span class="pc">|</span><span class="c">=</span> <span class="w">AD_DS_WSMC_WAEN</span><span class="c">;</span>
		
		<span class="w">ad1889_writel</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">AD_DMA_CHSS</span><span class="c">,</span> <span class="w">AD_DMA_CHSS_WAVS</span><span class="c">);</span>
		<span class="w">ad1889_unmute</span><span class="c">(</span><span class="pc">c</span><span class="c">hip</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">case</span> <span class="w">SNDRV_PCM_TRIGGER_STOP</span><span class="c">:</span>
		<span class="w">ad1889_mute</span><span class="c">(</span><span class="pc">c</span><span class="c">hip);</span>
		<span class="pc">w</span><span class="c">smc</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">A</span><span class="pc">D_DS</span><span class="c">_WSMC_WAEN;</span>
		<span class="pc">b</span><span class="c">reak;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="w">snd_BUG</span><span class="pc">()</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">-</span><span class="c">EINVAL;</span>
	<span class="c">}</span>
	
	<span class="w">c</span><span class="c">hip-&gt;</span><span class="w">wave</span><span class="pc">.</span><span class="w">r</span><span class="c">eg</span> <span class="c">=</span> <span class="pc">w</span><span class="c">smc;</span>
	<span class="w">ad1889_writew</span><span class="c">(chip,</span> <span class="w">AD_DS_WSMC</span><span class="c">,</span> <span class="c">wsmc</span><span class="pc">)</span><span class="c">;</span>	
	<span class="w">ad1889_readw</span><span class="c">(chip,</span> <span class="pc">A</span><span class="c">D_DS_WSMC</span><span class="pc">)</span><span class="c">;</span>	

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">d</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SNDRV_PCM_TRIGGER_STOP</span><span class="pc">)</span>
		<span class="w">ad1889_channel_reset</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_CHAN_WAV</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_capture_trigger</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">m</span><span class="c">d)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">ramc</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span> <span class="pc">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>

	<span class="w">r</span><span class="pc">a</span><span class="c">mc</span> <span class="pc">=</span> <span class="w">ad1889_readw</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DS_RAMC</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="pc">sw</span><span class="c">itch</span> <span class="c">(</span><span class="pc">cm</span><span class="c">d) {</span>
	<span class="c">case</span> <span class="w">SNDRV_PCM_TRIGGER_START</span><span class="c">:</span>
		
		<span class="w">ad1889_writew</span><span class="c">(</span><span class="w">ch</span><span class="c">ip,</span> <span class="w">AD_DMA_ADC</span><span class="c">,</span> <span class="w">AD_DMA_LOOP</span> <span class="pc">|</span> <span class="w">AD_DMA_IM_CNT</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">a</span><span class="c">mc</span> <span class="pc">|</span><span class="c">=</span> <span class="w">AD_DS_RAMC_ADEN</span><span class="c">;</span>
		
		<span class="w">ad1889_writel</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">AD_DMA_CHSS</span><span class="c">,</span> <span class="w">AD_DMA_CHSS_ADCS</span><span class="c">);</span>
		<span class="c">break;</span>
	<span class="c">case</span> <span class="w">SNDRV_PCM_TRIGGER_STOP</span><span class="c">:</span>
		<span class="w">r</span><span class="pc">a</span><span class="c">mc</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">AD_DS</span><span class="pc">_RAMC_</span><span class="c">ADEN;</span>
		<span class="c">break;</span>
	<span class="pc">d</span><span class="c">efault:</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>
	
	<span class="w">ch</span><span class="c">ip-&gt;</span><span class="pc">r</span><span class="c">amc</span><span class="pc">.</span><span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="w">r</span><span class="c">amc;</span>
	<span class="w">ad1889_writew</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">AD_DS_RAMC</span><span class="c">,</span> <span class="pc">r</span><span class="c">amc);</span>	
	<span class="w">ad1889_readw</span><span class="c">(chip,</span> <span class="c">AD_DS_RAMC</span><span class="pc">)</span><span class="c">;</span>	
	
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">m</span><span class="c">d</span> <span class="pc">=</span><span class="c">=</span> <span class="w">SNDRV_PCM_TRIGGER_STOP</span><span class="c">)</span>
		<span class="w">ad1889_channel_reset</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_CHAN_ADC</span><span class="pc">)</span><span class="c">;</span>
		
	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">snd_pcm_uframes_t</span>
<span class="w">snd_ad1889_playback_pointer</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">n</span><span class="c">d_pcm_substream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">si</span><span class="c">ze_t</span> <span class="w">pt</span><span class="c">r</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip</span> <span class="c">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely</span><span class="pc">(!(</span><span class="w">c</span><span class="c">hip-&gt;</span><span class="w">wave</span><span class="pc">.</span><span class="w">r</span><span class="pc">eg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_WSMC_WAEN))</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">pt</span><span class="c">r</span> <span class="c">=</span> <span class="w">ad1889_readl</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">,</span> <span class="w">AD_DMA_WAVCA</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">p</span><span class="c">tr</span> <span class="w">-</span><span class="pc">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;wave.</span><span class="pc">a</span><span class="c">ddr;</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">snd_BUG_ON</span><span class="c">(</span><span class="w">p</span><span class="c">tr</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;wave.</span><span class="w">s</span><span class="c">ize))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">bytes_to_frames</span><span class="c">(</span><span class="w">ss</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ru</span><span class="c">ntime,</span> <span class="w">p</span><span class="c">tr);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">snd_pcm_uframes_t</span>
<span class="w">snd_ad1889_capture_pointer</span><span class="c">(struct</span> <span class="w">sn</span><span class="pc">d_pcm_s</span><span class="c">ubstream</span> <span class="c">*</span><span class="w">ss</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span> <span class="w">p</span><span class="pc">t</span><span class="c">r</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span> <span class="c">=</span> <span class="w">snd_pcm_substream_chip</span><span class="c">(</span><span class="w">ss</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">u</span><span class="c">nlikely</span><span class="pc">(!(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">ramc</span><span class="pc">.</span><span class="w">reg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_RAMC_ADEN))</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">pt</span><span class="c">r</span> <span class="c">=</span> <span class="w">ad1889_readl</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">,</span> <span class="w">AD_DMA_ADCCA</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">p</span><span class="c">tr</span> <span class="w">-</span><span class="pc">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;ramc.</span><span class="pc">a</span><span class="c">ddr;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">snd_BUG_ON</span><span class="c">(</span><span class="w">p</span><span class="c">tr</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;ramc.</span><span class="w">s</span><span class="c">ize))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">bytes_to_frames</span><span class="c">(</span><span class="w">ss</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ru</span><span class="c">ntime,</span> <span class="w">p</span><span class="c">tr);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">snd_pcm_ops</span> <span class="w">snd_ad1889_playback_ops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">o</span><span class="pc">pe</span><span class="c">n</span> <span class="c">=</span> <span class="w">snd_ad1889_playback_open</span><span class="c">,</span>
	<span class="c">.</span><span class="w">c</span><span class="pc">l</span><span class="c">ose</span> <span class="c">=</span> <span class="w">snd_ad1889_playback_close</span><span class="c">,</span>
	<span class="c">.</span><span class="w">i</span><span class="c">octl</span> <span class="c">=</span> <span class="w">snd_pcm_lib_ioctl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">hw_params</span> <span class="c">=</span> <span class="w">snd_ad1889_hw_params</span><span class="c">,</span>
	<span class="c">.</span><span class="w">hw_free</span> <span class="c">=</span> <span class="w">snd_ad1889_hw_free</span><span class="c">,</span>
	<span class="c">.</span><span class="w">prepare</span> <span class="c">=</span> <span class="w">snd_ad1889_playback_prepare</span><span class="c">,</span>
	<span class="c">.</span><span class="w">t</span><span class="pc">r</span><span class="c">igger</span> <span class="c">=</span> <span class="w">snd_ad1889_playback_trigger</span><span class="c">,</span>
	<span class="c">.</span><span class="w">po</span><span class="pc">i</span><span class="c">nter</span> <span class="c">=</span> <span class="w">snd_ad1889_playback_pointer</span><span class="c">,</span> 
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_pcm_ops</span> <span class="w">snd_ad1889_capture_ops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">op</span><span class="pc">e</span><span class="c">n</span> <span class="c">=</span> <span class="w">snd_ad1889_capture_open</span><span class="c">,</span>
	<span class="c">.</span><span class="w">c</span><span class="pc">lo</span><span class="c">se</span> <span class="c">=</span> <span class="w">snd_ad1889_capture_close</span><span class="c">,</span>
	<span class="c">.</span><span class="w">i</span><span class="pc">o</span><span class="c">ctl</span> <span class="c">=</span> <span class="w">snd_pcm_lib_ioctl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">hw_params</span> <span class="c">=</span> <span class="w">snd_ad1889_hw_params</span><span class="c">,</span>
	<span class="c">.</span><span class="w">hw_free</span> <span class="c">=</span> <span class="w">snd_ad1889_hw_free</span><span class="c">,</span>
	<span class="c">.</span><span class="w">prepare</span> <span class="c">=</span> <span class="w">snd_ad1889_capture_prepare</span><span class="c">,</span>
	<span class="c">.</span><span class="w">t</span><span class="pc">r</span><span class="c">igger</span> <span class="c">=</span> <span class="w">snd_ad1889_capture_trigger</span><span class="c">,</span>
	<span class="c">.</span><span class="w">po</span><span class="pc">i</span><span class="c">nter</span> <span class="c">=</span> <span class="w">snd_ad1889_capture_pointer</span><span class="c">,</span> 
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="w">i</span><span class="pc">r</span><span class="c">qreturn_t</span>
<span class="w">snd_ad1889_interrupt</span><span class="c">(int</span> <span class="c">irq,</span> <span class="c">void</span> <span class="c">*dev_id)</span>
<span class="c">{</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">st</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">ch</span><span class="c">ip</span> <span class="c">=</span> <span class="pc">d</span><span class="c">ev_id;</span>

	<span class="w">st</span> <span class="pc">=</span> <span class="w">ad1889_readl</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">,</span> <span class="w">AD_DMA_DISR</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="w">ad1889_writel</span><span class="c">(</span><span class="pc">c</span><span class="c">hip</span><span class="pc">,</span> <span class="w">A</span><span class="c">D_DMA_DISR,</span> <span class="w">st</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">st</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">AD_INTR_MASK</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="c">nlikely</span><span class="pc">(!</span><span class="w">s</span><span class="pc">t))</span>
		<span class="c">return</span> <span class="w">IRQ_NONE</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="c">t</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">AD_DMA_DISR_PMAI</span><span class="c">|</span><span class="w">AD_DMA_DISR_PTAI</span><span class="c">))</span>
		<span class="w">d</span><span class="pc">ev_d</span><span class="c">bg</span><span class="pc">(</span><span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;</span><span class="pc">c</span><span class="c">ard</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="pc">,</span>
			<span class="c">"</span><span class="w">Unexpected</span> <span class="w">mas</span><span class="pc">t</span><span class="c">er</span> <span class="w">o</span><span class="pc">r</span> <span class="w">ta</span><span class="pc">r</span><span class="c">get</span> <span class="w">abort</span> <span class="w">in</span><span class="pc">t</span><span class="c">errupt</span><span class="w">!</span><span class="c">\n");</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">st</span> <span class="pc">&amp;</span> <span class="w">AD_DMA_DISR_WAVI</span><span class="pc">) &amp;</span><span class="c">&amp;</span> <span class="w">chi</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">psubs</span><span class="pc">)</span>
		<span class="w">snd_pcm_period_elapsed</span><span class="c">(</span><span class="w">c</span><span class="pc">hi</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;psubs</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">((</span><span class="w">st</span> <span class="pc">&amp;</span> <span class="w">AD_DMA_DISR_ADCI</span><span class="pc">) &amp;</span><span class="c">&amp;</span> <span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;</span><span class="w">csubs</span><span class="pc">)</span>
		<span class="w">s</span><span class="c">nd_pcm_period_elapsed(</span><span class="pc">c</span><span class="c">hip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">c</span><span class="c">subs</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">I</span><span class="c">RQ_HANDLED;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_pcm_init</span><span class="c">(struct</span> <span class="w">snd_ad1889</span> <span class="c">*chip</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">de</span><span class="pc">v</span><span class="c">ice</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_pcm</span> <span class="c">*</span><span class="w">pcm</span><span class="c">;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_pcm_new</span><span class="c">(chip-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd</span><span class="pc">,</span> <span class="w">c</span><span class="c">hip-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="pc">,</span> <span class="w">d</span><span class="pc">e</span><span class="c">vice,</span> <span class="w">1</span><span class="c">,</span> <span class="w">1</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">pcm</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">snd_pcm_set_ops</span><span class="c">(</span><span class="w">pcm</span><span class="c">,</span> <span class="w">SNDRV_PCM_STREAM_PLAYBACK</span><span class="c">,</span> 
			<span class="w">&amp;snd_ad1889_playback_ops</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">nd_pcm_s</span><span class="c">et_ops(</span><span class="w">pcm</span><span class="c">,</span> <span class="w">SNDRV_PCM_STREAM_CAPTURE</span><span class="c">,</span>
			<span class="pc">&amp;</span><span class="w">snd_ad1889_capture_ops</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">pc</span><span class="pc">m-</span><span class="c">&gt;</span><span class="w">pr</span><span class="pc">iva</span><span class="c">te_data</span> <span class="c">=</span> <span class="w">ch</span><span class="c">ip;</span>
	<span class="w">pc</span><span class="pc">m</span><span class="c">-&gt;</span><span class="w">info_flags</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">str</span><span class="pc">c</span><span class="c">py(</span><span class="w">pcm</span><span class="c">-&gt;</span><span class="w">n</span><span class="c">ame,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">ca</span><span class="pc">r</span><span class="c">d-&gt;</span><span class="w">shortname</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="pc">c</span><span class="c">hip-&gt;</span><span class="w">pcm</span> <span class="c">=</span> <span class="w">pcm</span><span class="c">;</span>
	<span class="c">chip-&gt;</span><span class="w">psubs</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">chip-&gt;</span><span class="w">csubs</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">snd_pcm_lib_preallocate_pages_for_all</span><span class="c">(</span><span class="w">pcm</span><span class="c">,</span> <span class="w">SNDRV_DMA_TYPE_DEV</span><span class="c">,</span>
						<span class="w">snd_dma_pci_data</span><span class="pc">(</span><span class="c">chip-&gt;</span><span class="w">pc</span><span class="pc">i</span><span class="c">),</span>
						<span class="w">BUFFER_BYTES_MAX</span> <span class="w">/</span> <span class="pc">2,</span>
						<span class="w">B</span><span class="c">UFFER_BYTES_MAX</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
		<span class="c">dev_err</span><span class="pc">(ch</span><span class="c">ip-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">rd</span><span class="pc">-</span><span class="c">&gt;dev, "</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span> <span class="w">allocation</span> <span class="w">e</span><span class="c">rror</span><span class="pc">:</span><span class="c"> %d\n",</span> <span class="c">err);</span>
		<span class="c">return</span> <span class="c">err;</span>
	<span class="c">}</span>
	
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">snd_ad1889_proc_read</span><span class="c">(struct</span> <span class="w">snd_info_entry</span> <span class="c">*</span><span class="w">e</span><span class="pc">nt</span><span class="c">ry</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">snd_info_buffer</span> <span class="c">*</span><span class="w">b</span><span class="pc">uff</span><span class="c">er</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span> <span class="c">=</span> <span class="w">e</span><span class="pc">n</span><span class="c">try-&gt;</span><span class="w">p</span><span class="pc">rivate_</span><span class="c">data;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">r</span><span class="c">eg;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">t</span><span class="c">mp;</span>

	<span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="w">ad1889_readw</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">AD_DS_WSMC</span><span class="c">);</span>
	<span class="w">snd_iprintf</span><span class="c">(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, "</span><span class="w">Wave</span> <span class="w">ou</span><span class="pc">tp</span><span class="c">ut</span><span class="pc">:</span><span class="c"> %</span><span class="pc">s</span><span class="c">\n",</span>
			<span class="w">(r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_WSMC_WAEN</span><span class="pc">) ?</span><span class="c"> "</span><span class="w">e</span><span class="c">nabled" : "</span><span class="w">d</span><span class="c">isabled");</span>
	<span class="pc">s</span><span class="c">nd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="pc">W</span><span class="c">ave</span> <span class="w">Channels</span><span class="pc">:</span><span class="c"> %</span><span class="pc">s</span><span class="c">\n",</span>
			<span class="pc">(</span><span class="w">r</span><span class="c">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_WSMC_WAST</span><span class="c">) ? "</span><span class="w">stereo</span><span class="c">" : "</span><span class="w">mono</span><span class="c">");</span>
	<span class="c">snd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"Wave</span> <span class="w">Quality</span><span class="pc">:</span><span class="c"> %</span><span class="pc">d</span><span class="w">-b</span><span class="c">it</span> <span class="w">linear</span><span class="c">\n</span><span class="pc">",</span>
			<span class="pc">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_WSMC_WA16) </span><span class="pc">?</span> <span class="w">1</span><span class="pc">6</span> <span class="c">:</span> <span class="w">8</span><span class="c">);</span>
	
	
	<span class="w">t</span><span class="pc">mp</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_WSMC_WARQ</span><span class="pc">) ?</span>
		<span class="w">((((r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">A</span><span class="pc">D_DS_WSMC_WAR</span><span class="c">Q</span><span class="pc">)</span><span class="c"> &gt;&gt;</span> <span class="w">1</span><span class="pc">2) </span><span class="c">&amp;</span> <span class="w">0x0</span><span class="pc">1</span><span class="w">)</span><span class="pc"> ?</span> <span class="w">1</span><span class="pc">2</span> <span class="c">:</span> <span class="w">18)</span><span class="pc"> </span><span class="c">:</span> <span class="w">4</span><span class="c">;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="w">/= (r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_WSMC_WAST</span><span class="pc">) ?</span> <span class="w">2</span> <span class="c">:</span> <span class="w">1</span><span class="c">;</span>
	
	<span class="w">snd_iprintf</span><span class="pc">(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">Wave</span> <span class="w">FIFO:</span><span class="pc"> </span><span class="c">%d</span> <span class="pc">%s</span> <span class="w">words\</span><span class="c">n</span><span class="pc">\</span><span class="c">n",</span> <span class="w">t</span><span class="c">mp,</span>
			<span class="w">(r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="c">AD_DS_WSMC_WAST</span><span class="w">)</span><span class="pc"> ? </span><span class="c">"</span><span class="w">stereo</span><span class="c">" : "</span><span class="w">mono</span><span class="c">");</span>
				
	
	<span class="w">s</span><span class="c">nd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">Synthesis</span> <span class="w">ou</span><span class="pc">tp</span><span class="c">ut</span><span class="pc">:</span><span class="c"> %</span><span class="pc">s</span><span class="c">\n",</span>
			<span class="w">re</span><span class="pc">g</span> <span class="w">&amp;</span> <span class="w">AD_DS_WSMC_SYEN</span> <span class="pc">?</span><span class="c"> "</span><span class="w">e</span><span class="c">nabled" : "</span><span class="w">d</span><span class="c">isabled");</span>
	
	
	<span class="w">t</span><span class="pc">mp</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_WSMC_SYRQ</span><span class="pc">) ?</span>
		<span class="w">((((r</span><span class="c">eg</span> <span class="c">&amp;</span> <span class="w">A</span><span class="pc">D_DS_WSMC_SYR</span><span class="c">Q</span><span class="pc">) &gt;</span><span class="c">&gt;</span> <span class="w">4</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">0x0</span><span class="pc">1</span><span class="w">)</span><span class="pc"> ?</span> <span class="w">1</span><span class="pc">2</span> <span class="c">:</span> <span class="w">18)</span><span class="pc"> </span><span class="c">:</span> <span class="w">4</span><span class="c">;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="w">/= (r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_WSMC_WAST</span><span class="pc">) ?</span> <span class="w">2</span> <span class="c">:</span> <span class="w">1</span><span class="c">;</span>
	
	<span class="w">snd_iprintf</span><span class="pc">(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">Synthesis</span> <span class="w">FIFO:</span><span class="pc"> </span><span class="c">%d</span> <span class="pc">%s</span> <span class="w">words\</span><span class="c">n</span><span class="pc">\</span><span class="c">n",</span> <span class="w">t</span><span class="c">mp,</span>
			<span class="w">(r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="c">AD_DS_WSMC_WAST</span><span class="w">)</span><span class="pc"> ? </span><span class="c">"</span><span class="w">stereo</span><span class="c">" : "</span><span class="w">mono</span><span class="c">");</span>

	<span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span> <span class="w">ad1889_readw</span><span class="c">(</span><span class="w">c</span><span class="pc">hi</span><span class="c">p,</span> <span class="w">AD_DS_RAMC</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="c">nd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">A</span><span class="pc">DC</span> <span class="w">inp</span><span class="c">ut</span><span class="pc">: </span><span class="c">%</span><span class="pc">s</span><span class="c">\n",</span>
			<span class="c">(</span><span class="w">r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_RAMC_ADEN</span><span class="c">) ? "</span><span class="w">e</span><span class="c">nabled" : "</span><span class="w">d</span><span class="c">isabled");</span>
	<span class="w">s</span><span class="c">nd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">AD</span><span class="pc">C</span> <span class="w">Channels</span><span class="pc">:</span><span class="c"> %</span><span class="pc">s</span><span class="c">\n",</span>
			<span class="pc">(</span><span class="w">r</span><span class="c">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_RAMC_ADST</span><span class="c">) ? "</span><span class="w">stereo</span><span class="c">" : "</span><span class="w">mono</span><span class="c">");</span>
	<span class="c">snd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">A</span><span class="pc">DC</span> <span class="w">Quality</span><span class="pc">: </span><span class="c">%d</span><span class="w">-b</span><span class="c">it</span> <span class="w">linear</span><span class="pc">\</span><span class="c">n</span><span class="pc">",</span>
			<span class="pc">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_RAMC_AD16)</span><span class="pc"> ?</span> <span class="w">1</span><span class="pc">6</span> <span class="c">:</span> <span class="w">8</span><span class="c">);</span>
	
	
	<span class="w">tm</span><span class="pc">p</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_RAMC_ACRQ</span><span class="pc">) ?</span>
		<span class="w">((((r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">A</span><span class="pc">D_DS_RAMC_AC</span><span class="c">RQ</span><span class="pc">)</span><span class="c"> &gt;&gt;</span> <span class="w">4</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">0x0</span><span class="pc">1</span><span class="w">)</span><span class="pc"> ?</span> <span class="w">1</span><span class="pc">2</span> <span class="c">:</span> <span class="w">18)</span><span class="pc"> </span><span class="c">:</span> <span class="w">4</span><span class="c">;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="w">/= (r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_RAMC_ADST</span><span class="pc">) ?</span> <span class="w">2</span> <span class="c">:</span> <span class="w">1</span><span class="c">;</span>
	
	<span class="w">snd_iprintf</span><span class="pc">(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">A</span><span class="pc">DC</span> <span class="w">FIFO:</span><span class="pc"> </span><span class="c">%d</span> <span class="pc">%s</span> <span class="w">words\</span><span class="c">n</span><span class="pc">\</span><span class="c">n",</span> <span class="w">t</span><span class="c">mp,</span>
			<span class="w">(r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="c">AD_DS_RAMC_ADST</span><span class="w">)</span><span class="pc"> ? </span><span class="c">"</span><span class="w">stereo</span><span class="c">" : "</span><span class="w">mono</span><span class="c">");</span>
	
	<span class="w">s</span><span class="c">nd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="w">,</span><span class="pc"> </span><span class="c">"</span><span class="w">Resampler</span> <span class="w">inp</span><span class="c">ut</span><span class="pc">:</span><span class="c"> %</span><span class="pc">s</span><span class="c">\n",</span>
			<span class="w">re</span><span class="pc">g</span> <span class="w">&amp;</span> <span class="w">AD_DS_RAMC_REEN</span> <span class="pc">?</span><span class="c"> "</span><span class="w">e</span><span class="c">nabled" : "</span><span class="w">d</span><span class="c">isabled");</span>
			
	
	<span class="w">t</span><span class="pc">mp</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_RAMC_RERQ</span><span class="pc">) ?</span>
		<span class="w">((((r</span><span class="c">eg</span> <span class="c">&amp;</span> <span class="w">A</span><span class="pc">D_DS_RAMC_RER</span><span class="c">Q</span><span class="pc">) &gt;</span><span class="c">&gt;</span> <span class="w">1</span><span class="pc">2) </span><span class="c">&amp;</span> <span class="w">0x0</span><span class="pc">1</span><span class="w">)</span><span class="pc"> ?</span> <span class="w">1</span><span class="pc">2</span> <span class="c">:</span> <span class="w">18)</span><span class="pc"> </span><span class="c">:</span> <span class="w">4</span><span class="c">;</span>
	<span class="w">t</span><span class="pc">m</span><span class="c">p</span> <span class="w">/= (r</span><span class="pc">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_RAMC_ADST</span><span class="pc">) ?</span> <span class="w">2</span> <span class="c">:</span> <span class="w">1</span><span class="c">;</span>
	
	<span class="w">snd_iprintf</span><span class="pc">(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">Resampler</span> <span class="w">FIFO:</span><span class="pc"> </span><span class="c">%d</span> <span class="pc">%s</span> <span class="w">words\</span><span class="c">n</span><span class="pc">\</span><span class="c">n",</span> <span class="w">t</span><span class="c">mp,</span>
			<span class="w">(r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_WSMC_WAST</span><span class="pc">) ? </span><span class="c">"</span><span class="w">stereo</span><span class="c">" : "</span><span class="w">mono</span><span class="c">");</span>
				
	
	
	<span class="w">r</span><span class="pc">eg</span> <span class="pc">=</span> <span class="w">ad1889_readw</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip,</span> <span class="w">AD_DS_WADA</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="c">nd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">L</span><span class="pc">e</span><span class="c">ft</span><span class="w">:</span><span class="c"> %</span><span class="pc">s</span><span class="w">, -%d</span> <span class="w">dB</span><span class="c">\n",</span>
			<span class="pc">(</span><span class="w">r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_WADA_LWAM</span><span class="c">) ? "</span><span class="w">mute</span><span class="c">" : "</span><span class="w">unmute</span><span class="pc">",</span>
			<span class="w">(</span><span class="pc">(</span><span class="w">r</span><span class="c">eg</span> <span class="c">&amp;</span> <span class="w">AD_DS_WADA_LWAA</span><span class="pc">) &gt;</span><span class="c">&gt;</span> <span class="pc">8</span><span class="w">) *</span> <span class="w">3</span><span class="c">);</span>
	<span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="w">a</span><span class="c">d1889_readw(</span><span class="w">c</span><span class="c">hip,</span> <span class="w">A</span><span class="pc">D_DS_WADA)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">n</span><span class="c">d_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">R</span><span class="pc">i</span><span class="c">ght</span><span class="w">:</span><span class="pc"> </span><span class="c">%s</span><span class="w">,</span><span class="pc"> </span><span class="c">-%</span><span class="w">d</span> <span class="w">dB</span><span class="c">\n",</span>
			<span class="pc">(</span><span class="w">r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_WADA_RWAM</span><span class="pc">) ?</span><span class="c"> "</span><span class="w">m</span><span class="c">ute" : "</span><span class="w">u</span><span class="c">nmute</span><span class="pc">",</span>
			<span class="pc">(</span><span class="w">r</span><span class="c">eg</span> <span class="pc">&amp;</span> <span class="w">AD_DS_WADA_RWAA) *</span> <span class="w">3</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="w">a</span><span class="c">d1889_readw(</span><span class="w">c</span><span class="c">hip,</span> <span class="w">AD_DS_WAS</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">n</span><span class="c">d_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">Wave</span> <span class="w">samplerate</span><span class="pc">:</span><span class="c"> %</span><span class="w">u</span> <span class="w">Hz</span><span class="c">\n",</span> <span class="w">r</span><span class="c">eg);</span>
	<span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="pc">a</span><span class="c">d1889_readw(chip,</span> <span class="w">AD_DS_RES</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="c">nd_iprintf(</span><span class="w">bu</span><span class="pc">ff</span><span class="c">er</span><span class="pc">, </span><span class="c">"</span><span class="w">Resampler</span> <span class="c">samplerate</span><span class="pc">:</span><span class="c"> %</span><span class="w">u</span> <span class="w">H</span><span class="c">z</span><span class="pc">\</span><span class="c">n",</span> <span class="w">r</span><span class="pc">eg</span><span class="c">);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span>
<span class="w">snd_ad1889_proc_init</span><span class="c">(struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_info_entry</span> <span class="c">*</span><span class="w">e</span><span class="c">ntry</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">snd_card_proc_new</span><span class="c">(</span><span class="pc">c</span><span class="c">hip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ca</span><span class="c">rd,</span> <span class="w">c</span><span class="c">hip-&gt;</span><span class="w">ca</span><span class="c">rd-&gt;</span><span class="w">dr</span><span class="c">iver</span><span class="w">,</span><span class="pc"> &amp;</span><span class="w">en</span><span class="pc">t</span><span class="c">ry</span><span class="pc">))</span>
		<span class="w">snd_info_set_text_ops</span><span class="c">(</span><span class="w">e</span><span class="pc">n</span><span class="c">try</span><span class="pc">,</span> <span class="pc">ch</span><span class="c">ip</span><span class="pc">,</span> <span class="w">snd_ad1889_proc_read</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">ac97_quirk</span> <span class="w">ac97_quirks</span><span class="pc">[</span><span class="c">] = {</span>
	<span class="c">{</span>
		<span class="c">.</span><span class="w">subvendor</span> <span class="c">=</span> <span class="w">0x11d4</span><span class="c">,</span>	
		<span class="c">.</span><span class="w">subdevice</span> <span class="c">=</span> <span class="w">0x1889</span><span class="c">,</span>	
		<span class="c">.</span><span class="w">codec_id</span> <span class="c">=</span> <span class="w">AC97_ID_AD1819</span><span class="c">,</span>
		<span class="c">.</span><span class="pc">n</span><span class="c">ame</span> <span class="c">= "</span><span class="w">AD1889</span><span class="c">",</span>
		<span class="c">.</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">AC97_TUNE_HP_ONLY</span>
	<span class="pc">},</span>
	<span class="w">{</span><span class="pc"> }</span> 
<span class="c">};</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">snd_ad1889_ac97_xinit</span><span class="c">(struct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">ch</span><span class="c">ip)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="pc">r</span><span class="c">eg;</span>

	<span class="w">r</span><span class="pc">eg</span> <span class="c">=</span> <span class="w">ad1889_readw</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip,</span> <span class="w">AD_AC97_ACIC</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eg</span> <span class="pc">|</span><span class="c">=</span> <span class="w">AD_AC97_ACIC_ACRD</span><span class="c">;</span>		
	<span class="w">ad1889_writew</span><span class="c">(</span><span class="pc">c</span><span class="c">hip,</span> <span class="w">A</span><span class="c">D_AC97_ACIC,</span> <span class="c">reg);</span>
	<span class="w">a</span><span class="pc">d1889_r</span><span class="c">eadw(chip,</span> <span class="pc">A</span><span class="c">D_AC97_ACIC</span><span class="pc">)</span><span class="c">;</span>	
	<span class="w">u</span><span class="c">delay(</span><span class="pc">10</span><span class="c">);</span>
	
	<span class="pc">reg</span> <span class="pc">|</span><span class="c">=</span> <span class="w">AD_AC97_ACIC_ACIE</span><span class="c">;</span>
	<span class="w">a</span><span class="pc">d1889_w</span><span class="c">ritew(chip,</span> <span class="w">A</span><span class="c">D_AC97_ACIC,</span> <span class="c">reg);</span>
	
	<span class="w">snd_ad1889_ac97_ready</span><span class="c">(chip</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">reg</span> <span class="c">=</span> <span class="pc">a</span><span class="c">d1889_readw(chip,</span> <span class="w">A</span><span class="pc">D_AC97_ACIC</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eg</span> <span class="pc">|</span><span class="c">=</span> <span class="w">AD_AC97_ACIC_ASOE</span> <span class="pc">|</span> <span class="w">AD_AC97_ACIC_VSRM</span><span class="c">;</span>
	<span class="w">a</span><span class="pc">d1889_w</span><span class="c">ritew(chip,</span> <span class="pc">A</span><span class="c">D_AC97_ACIC,</span> <span class="c">reg);</span>
	<span class="w">a</span><span class="pc">d1889_r</span><span class="c">eadw(</span><span class="pc">c</span><span class="c">hip,</span> <span class="pc">A</span><span class="c">D_AC97_ACIC);</span> 

<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">snd_ad1889_ac97_bus_free</span><span class="c">(struct</span> <span class="w">snd_ac97_bus</span> <span class="c">*</span><span class="w">b</span><span class="c">us)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*chip</span> <span class="c">=</span> <span class="w">b</span><span class="c">us-&gt;</span><span class="w">pr</span><span class="pc">ivate_</span><span class="c">data;</span>
	<span class="w">c</span><span class="c">hip-&gt;</span><span class="w">ac97_bus</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">snd_ad1889_ac97_free</span><span class="c">(struct</span> <span class="w">snd_ac97</span> <span class="c">*</span><span class="w">ac</span><span class="pc">97</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">snd_ad</span><span class="c">1889</span> <span class="c">*chip</span> <span class="c">=</span> <span class="w">a</span><span class="pc">c97</span><span class="c">-&gt;</span><span class="w">p</span><span class="pc">rivate_</span><span class="c">data;</span>
	<span class="w">c</span><span class="c">hip-&gt;</span><span class="w">ac</span><span class="pc">97</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_ac97_init</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">nd_ad</span><span class="c">1889</span> <span class="c">*chip,</span> <span class="pc">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">quirk_override</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_ac97_template</span> <span class="w">ac</span><span class="pc">9</span><span class="c">7;</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">struct</span> <span class="w">snd_ac97_bus_ops</span> <span class="w">o</span><span class="c">ps</span> <span class="c">= {</span>
		<span class="c">.</span><span class="w">w</span><span class="c">rite</span> <span class="c">=</span> <span class="w">snd_ad1889_ac97_write</span><span class="c">,</span>
		<span class="c">.</span><span class="w">r</span><span class="pc">ea</span><span class="c">d</span> <span class="c">=</span> <span class="w">snd_ad1889_ac97_read</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">;</span>

	
	<span class="w">snd_ad1889_ac97_xinit</span><span class="c">(</span><span class="w">ch</span><span class="pc">i</span><span class="c">p);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_ac97_bus</span><span class="c">(chip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ca</span><span class="c">rd,</span> <span class="pc">0, </span><span class="c">&amp;</span><span class="w">o</span><span class="pc">p</span><span class="c">s</span><span class="pc">,</span> <span class="pc">c</span><span class="c">hip</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">ac97_bus</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="c">err;</span>
	
	<span class="w">c</span><span class="c">hip-&gt;</span><span class="w">a</span><span class="pc">c</span><span class="c">97_bus</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">private_free</span> <span class="pc">=</span> <span class="w">snd_ad1889_ac97_bus_free</span><span class="pc">;</span>

	<span class="w">me</span><span class="pc">ms</span><span class="c">et</span><span class="pc">(&amp;</span><span class="w">ac</span><span class="pc">97</span><span class="c">,</span> <span class="c">0,</span> <span class="pc">s</span><span class="c">izeof(</span><span class="w">ac</span><span class="pc">97</span><span class="c">));</span>
	<span class="w">ac</span><span class="pc">97.</span><span class="w">pri</span><span class="pc">vate_d</span><span class="c">ata</span> <span class="c">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">;</span>
	<span class="w">ac</span><span class="pc">97.</span><span class="c">private_free</span> <span class="c">=</span> <span class="w">snd_ad1889_ac97_free</span><span class="c">;</span>
	<span class="w">ac</span><span class="pc">97</span><span class="c">.</span><span class="w">pc</span><span class="c">i</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">pc</span><span class="pc">i;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_ac97_mixer</span><span class="c">(</span><span class="w">c</span><span class="c">hip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ac97_bus</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ac</span><span class="pc">97, </span><span class="c">&amp;</span><span class="pc">c</span><span class="c">hip-&gt;</span><span class="w">a</span><span class="pc">c97)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
		
	<span class="w">snd_ac97_tune_hardware</span><span class="c">(chip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">a</span><span class="pc">c97</span><span class="c">,</span> <span class="w">ac97_quirks</span><span class="c">,</span> <span class="w">quirk_override</span><span class="c">);</span>
	
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_free</span><span class="c">(struct</span> <span class="w">snd_ad1889</span> <span class="c">*chip)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(chip-&gt;</span><span class="pc">i</span><span class="c">rq</span> <span class="pc">&lt;</span> <span class="pc">0</span><span class="c">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">skip_hw</span><span class="c">;</span>

	<span class="w">sp</span><span class="pc">in_lock_irq</span><span class="c">(&amp;chip-&gt;lock);</span>

	<span class="w">ad1889_mute</span><span class="c">(chip);</span>

	
	<span class="w">ad1889_channel_reset</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_CHAN_WAV</span> <span class="pc">|</span> <span class="w">AD_CHAN_ADC</span><span class="c">);</span>

	
	<span class="w">ad1889_writel</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DMA_DISR</span><span class="c">,</span> <span class="w">AD_DMA_DISR_PTAI</span> <span class="pc">|</span> <span class="w">AD_DMA_DISR_PMAI</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ad1889_readl</span><span class="c">(chip,</span> <span class="pc">AD_D</span><span class="c">MA_DISR</span><span class="pc">)</span><span class="c">;</span>	

	<span class="w">sp</span><span class="pc">in_unlock_irq(&amp;</span><span class="c">chip-&gt;lock);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(chip-&gt;irq</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="pc">0</span><span class="c">)</span>
		<span class="w">f</span><span class="c">ree_irq(chip-&gt;irq,</span> <span class="c">chip</span><span class="pc">)</span><span class="c">;</span>

<span class="w">skip_hw</span><span class="pc">:</span>
	<span class="w">i</span><span class="pc">o</span><span class="c">unmap(chip-&gt;</span><span class="w">i</span><span class="pc">o</span><span class="c">base);</span>
	<span class="w">pci_release_regions</span><span class="c">(chip-&gt;</span><span class="w">pc</span><span class="pc">i)</span><span class="c">;</span>
	<span class="w">pci_disable_device</span><span class="c">(chip-&gt;</span><span class="w">pc</span><span class="pc">i)</span><span class="c">;</span>
	<span class="pc">k</span><span class="c">free(chip);</span>
	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_dev_free</span><span class="c">(struct</span> <span class="w">snd_device</span> <span class="c">*</span><span class="pc">d</span><span class="c">evice)</span> 
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="c">*chip</span> <span class="c">=</span> <span class="w">de</span><span class="pc">vi</span><span class="c">ce</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">device_data</span><span class="c">;</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">snd_ad1889_free</span><span class="c">(chip</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_init</span><span class="c">(struct</span> <span class="w">s</span><span class="pc">nd_a</span><span class="c">d1889</span> <span class="c">*chip)</span> 
<span class="c">{</span>
	<span class="w">ad1889_writew</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DS_CCS</span><span class="c">,</span> <span class="w">AD_DS_CCS_CLKEN</span><span class="c">);</span> 
	<span class="w">ad1889_readw</span><span class="c">(chip</span><span class="pc">,</span> <span class="pc">A</span><span class="c">D_DS_CCS</span><span class="pc">)</span><span class="c">;</span>	

	<span class="w">m</span><span class="pc">d</span><span class="c">elay(</span><span class="pc">1</span><span class="c">0);</span>

	
	<span class="w">ad1889_writel</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">AD_DMA_DISR</span><span class="c">,</span> <span class="w">AD_DMA_DISR_PMAE</span> <span class="pc">|</span> <span class="w">AD_DMA_DISR_PTAE</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_create</span><span class="c">(struct</span> <span class="w">snd_card</span> <span class="c">*</span><span class="w">c</span><span class="pc">a</span><span class="c">rd,</span>
		  <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="c">ci_dev</span> <span class="c">*</span><span class="w">p</span><span class="pc">ci</span><span class="c">,</span>
		  <span class="c">struct</span> <span class="w">snd_ad1889</span> <span class="pc">**</span><span class="w">rchip</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>

	<span class="c">struct</span> <span class="w">s</span><span class="pc">nd_a</span><span class="c">d1889</span> <span class="c">*</span><span class="pc">c</span><span class="c">hip;</span>
	<span class="w">st</span><span class="pc">a</span><span class="c">tic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">snd_device_ops</span> <span class="w">o</span><span class="c">ps</span> <span class="c">= {</span>
		<span class="c">.</span><span class="w">dev_free</span> <span class="c">=</span> <span class="w">snd_ad1889_dev_free</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">;</span>

	<span class="w">*r</span><span class="c">chip</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="pc">if</span> <span class="pc">((</span><span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">pci_enable_device</span><span class="c">(</span><span class="w">pc</span><span class="pc">i</span><span class="w">)) </span><span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">dma_set_mask</span><span class="pc">(&amp;</span><span class="w">pc</span><span class="pc">i</span><span class="c">-&gt;</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">DMA_BIT_MASK</span><span class="pc">(</span><span class="w">3</span><span class="pc">2</span><span class="w">)) &lt;</span> <span class="c">0</span> <span class="pc">|</span><span class="c">|</span>
	    <span class="w">dma_set_coherent_mask</span><span class="pc">(&amp;</span><span class="w">pc</span><span class="pc">i</span><span class="c">-&gt;dev</span><span class="pc">,</span> <span class="w">D</span><span class="c">MA_BIT_MASK</span><span class="w">(3</span><span class="pc">2</span><span class="w">)) &lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(</span><span class="w">c</span><span class="c">ard-&gt;dev, "</span><span class="w">e</span><span class="c">rror</span> <span class="w">s</span><span class="pc">e</span><span class="c">tting</span> <span class="w">3</span><span class="pc">2-</span><span class="w">b</span><span class="pc">i</span><span class="c">t</span> <span class="w">D</span><span class="c">MA</span> <span class="w">mas</span><span class="pc">k.</span><span class="c">\n");</span>
		<span class="w">pci_disable_device</span><span class="c">(</span><span class="w">p</span><span class="pc">c</span><span class="c">i</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">E</span><span class="pc">NX</span><span class="c">IO;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="pc">((c</span><span class="c">hip</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(sizeof</span><span class="pc">(*c</span><span class="c">hip),</span> <span class="c">GFP_KERNEL</span><span class="w">)) </span><span class="pc">=</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL) {</span>
		<span class="w">p</span><span class="pc">c</span><span class="c">i_disable_device(</span><span class="w">pc</span><span class="pc">i)</span><span class="c">;</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="c">}</span>

	<span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">ca</span><span class="c">rd</span> <span class="c">=</span> <span class="w">c</span><span class="c">ard;</span>
	<span class="w">c</span><span class="pc">a</span><span class="c">rd-&gt;</span><span class="w">p</span><span class="pc">r</span><span class="c">ivate_data</span> <span class="c">=</span> <span class="pc">ch</span><span class="c">ip;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">pc</span><span class="pc">i</span> <span class="c">=</span> <span class="w">pc</span><span class="pc">i</span><span class="c">;</span>
	<span class="c">chip-&gt;</span><span class="pc">i</span><span class="c">rq</span> <span class="pc">= </span><span class="c">-1;</span>

	
	<span class="w">i</span><span class="pc">f</span> <span class="pc">((</span><span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">pci_request_regions</span><span class="c">(</span><span class="w">p</span><span class="pc">ci</span><span class="c">,</span> <span class="pc">c</span><span class="c">ard-&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="w">)) </span><span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">free_and_ret</span><span class="c">;</span>

	<span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bar</span> <span class="c">=</span> <span class="w">pci_resource_start</span><span class="pc">(</span><span class="w">pc</span><span class="pc">i</span><span class="c">,</span> <span class="c">0);</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;</span><span class="w">i</span><span class="pc">ob</span><span class="c">ase</span> <span class="c">=</span> <span class="w">pci_ioremap_bar</span><span class="c">(</span><span class="w">pc</span><span class="pc">i</span><span class="c">,</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">hip-&gt;</span><span class="w">i</span><span class="pc">o</span><span class="c">base</span> <span class="w">=</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd-&gt;dev, "</span><span class="w">u</span><span class="c">nable</span> <span class="c">to</span> <span class="w">reserve</span> <span class="w">reg</span><span class="pc">io</span><span class="c">n</span><span class="w">.</span><span class="c">\n");</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">= -</span><span class="pc">EB</span><span class="c">USY;</span>
		<span class="c">goto</span> <span class="w">free_and_ret</span><span class="c">;</span>
	<span class="c">}</span>
	
	<span class="w">pci_set_master</span><span class="c">(</span><span class="w">pc</span><span class="pc">i)</span><span class="c">;</span>

	<span class="w">sp</span><span class="pc">in_lock_in</span><span class="c">it(&amp;</span><span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;lock);</span>	

	<span class="c">if</span> <span class="c">(</span><span class="w">re</span><span class="pc">q</span><span class="c">uest_irq(</span><span class="w">pc</span><span class="pc">i</span><span class="c">-&gt;irq,</span> <span class="w">snd_ad1889_interrupt</span><span class="c">,</span>
			<span class="w">IRQF_SHARED</span><span class="c">,</span> <span class="w">K</span><span class="pc">B</span><span class="c">UILD_MODNAME,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="w">)</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">dev_err</span><span class="pc">(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd-&gt;dev, "</span><span class="pc">c</span><span class="c">annot</span> <span class="w">obtain</span> <span class="c">IRQ</span> <span class="pc">%</span><span class="c">d\n",</span> <span class="w">p</span><span class="pc">ci</span><span class="c">-&gt;irq);</span>
		<span class="w">snd_ad1889_free</span><span class="c">(</span><span class="w">c</span><span class="c">hip</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">-</span><span class="pc">EB</span><span class="c">USY;</span>
	<span class="c">}</span>

	<span class="w">c</span><span class="c">hip-&gt;irq</span> <span class="c">=</span> <span class="w">p</span><span class="pc">c</span><span class="c">i-&gt;irq;</span>
	<span class="w">synchronize_irq</span><span class="c">(chip-&gt;irq</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">if</span> <span class="pc">((</span><span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_ad1889_init</span><span class="c">(chip</span><span class="w">)) </span><span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">n</span><span class="c">d_ad1889_free</span><span class="pc">(</span><span class="c">chip</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">e</span><span class="pc">rr</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_device_new</span><span class="c">(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd,</span> <span class="w">SNDRV_DEV_LOWLEVEL</span><span class="c">,</span> <span class="w">c</span><span class="c">hip</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">o</span><span class="pc">ps</span><span class="w">)) </span><span class="pc">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="c">nd_ad1889_free(chip</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">return</span> <span class="c">err;</span>
	<span class="c">}</span>

	<span class="w">*rchip</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">hip;</span>

	<span class="c">return</span> <span class="c">0;</span>

<span class="w">free_and_ret</span><span class="c">:</span>
	<span class="pc">k</span><span class="c">free(chip);</span>
	<span class="w">pci_disable_device</span><span class="pc">(</span><span class="w">pc</span><span class="pc">i</span><span class="c">);</span>

	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span>
<span class="w">snd_ad1889_probe</span><span class="c">(struct</span> <span class="pc">pc</span><span class="c">i_dev</span> <span class="c">*</span><span class="w">p</span><span class="pc">ci,</span>
		 <span class="pc">c</span><span class="c">onst</span> <span class="pc">s</span><span class="c">truct</span> <span class="c">pci_device_id</span> <span class="c">*</span><span class="w">pci_id</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">int</span> <span class="w">devno</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">snd_card</span> <span class="c">*</span><span class="w">c</span><span class="pc">a</span><span class="c">rd;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">snd_ad1889</span> <span class="c">*</span><span class="w">c</span><span class="pc">h</span><span class="c">ip;</span>

	
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">d</span><span class="pc">evn</span><span class="c">o</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">SNDRV_CARDS</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">e</span><span class="pc">nable</span><span class="w">[</span><span class="pc">d</span><span class="c">evno</span><span class="pc">]) </span><span class="c">{</span>
		<span class="w">de</span><span class="pc">vn</span><span class="c">o</span><span class="w">+</span><span class="c">+;</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EN</span><span class="pc">OE</span><span class="c">NT;</span>
	<span class="c">}</span>

	
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">snd_card_new</span><span class="pc">(&amp;</span><span class="w">pc</span><span class="c">i-&gt;dev,</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span><span class="w">[</span><span class="pc">d</span><span class="c">evno</span><span class="pc">],</span> <span class="w">i</span><span class="c">d</span><span class="pc">[d</span><span class="c">evno</span><span class="pc">],</span> <span class="w">T</span><span class="c">HIS_MODULE</span><span class="pc">,</span>
			   <span class="pc">0, </span><span class="c">&amp;</span><span class="w">ca</span><span class="c">rd</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="c">err;</span>

	<span class="w">st</span><span class="pc">r</span><span class="c">cpy(card</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">r</span><span class="c">iver</span><span class="pc">, </span><span class="c">"</span><span class="w">AD1889</span><span class="c">");</span>
	<span class="w">str</span><span class="pc">c</span><span class="c">py(card-&gt;</span><span class="w">shortname,</span><span class="pc"> "</span><span class="w">Analog</span> <span class="w">Devices</span> <span class="w">A</span><span class="pc">D</span><span class="c">1889");</span>

	
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_ad1889_create</span><span class="c">(card</span><span class="pc">,</span> <span class="w">pc</span><span class="pc">i, &amp;</span><span class="w">ch</span><span class="pc">i</span><span class="c">p);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">free_and_ret</span><span class="c">;</span>

	
	<span class="w">sp</span><span class="pc">r</span><span class="c">intf(card</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">longname,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">a</span><span class="c">t</span> <span class="w">0</span><span class="c">x%</span><span class="w">l</span><span class="c">x</span> <span class="w">i</span><span class="pc">r</span><span class="c">q</span> <span class="c">%</span><span class="w">i</span><span class="pc">"</span><span class="c">,</span>
		<span class="w">c</span><span class="c">ard-&gt;</span><span class="w">shortname</span><span class="c">,</span> <span class="w">ch</span><span class="pc">i</span><span class="c">p-&gt;</span><span class="w">bar</span><span class="c">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip-&gt;irq);</span>

	
	
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_ad1889_ac97_init</span><span class="c">(chip</span><span class="pc">,</span> <span class="w">ac97_quirk[devno</span><span class="pc">])</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">free_and_ret</span><span class="c">;</span>
	
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_ad1889_pcm_init</span><span class="c">(chip,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">f</span><span class="c">ree_and_ret;</span>

	
	<span class="w">snd_ad1889_proc_init</span><span class="c">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ip</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">snd_card_register</span><span class="c">(</span><span class="w">c</span><span class="pc">a</span><span class="c">rd);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">f</span><span class="pc">r</span><span class="c">ee_and_ret;</span>

	
	<span class="w">pci_set_drvdata</span><span class="c">(</span><span class="w">pc</span><span class="pc">i,</span> <span class="w">c</span><span class="pc">a</span><span class="c">rd</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">devno+</span><span class="c">+;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>

<span class="pc">f</span><span class="c">ree_and_ret:</span>
	<span class="w">snd_card_free</span><span class="c">(</span><span class="pc">c</span><span class="c">ard);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">snd_ad1889_remove</span><span class="c">(struct</span> <span class="pc">p</span><span class="c">ci_dev</span> <span class="c">*</span><span class="w">p</span><span class="pc">ci</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">n</span><span class="c">d_card_free(</span><span class="w">pci_get_drvdata</span><span class="pc">(</span><span class="w">p</span><span class="pc">ci</span><span class="c">));</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="pc">p</span><span class="c">ci_device_id</span> <span class="w">snd_ad1889_ids</span><span class="c">[] = {</span>
	<span class="c">{</span> <span class="w">PCI_DEVICE</span><span class="c">(</span><span class="w">PCI_VENDOR_ID_ANALOG_DEVICES</span><span class="c">,</span> <span class="w">PCI_DEVICE_ID_AD1889JS</span><span class="c">) },</span>
	<span class="c">{</span> <span class="pc">0, }</span><span class="c">,</span>
<span class="c">};</span>
<span class="c">MODULE_DEVICE_TABLE(pci,</span> <span class="c">snd_ad1889_ids);</span>

<span class="c">static</span> <span class="c">struct</span> <span class="w">pci_driver</span> <span class="w">ad1889_pci_driver</span> <span class="c">= {</span>
	<span class="c">.name</span> <span class="pc">=</span> <span class="pc">K</span><span class="c">BUILD_MODNAME,</span>
	<span class="c">.id_table</span> <span class="c">=</span> <span class="c">snd_ad1889_ids,</span>
	<span class="c">.probe</span> <span class="c">=</span> <span class="w">snd_ad1889_probe</span><span class="c">,</span>
	<span class="c">.remove</span> <span class="c">=</span> <span class="w">snd_ad1889_remove</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">module_pci_driver</span><span class="c">(ad1889_pci_driver);</span>

</pre>
</body>
</html>

