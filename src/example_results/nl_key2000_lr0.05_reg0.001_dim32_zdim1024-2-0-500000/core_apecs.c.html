<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#define</span> <span class="w">__EXTERN_INLINE</span> <span class="w">inline</span>
<span class="w">#include</span> <span class="w">&lt;asm/io.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;asm/core_apecs.h&gt;</span>
<span class="w">#undef</span> <span class="w">__EXTERN_INLINE</span>

<span class="w">#include</span> <span class="w">&lt;linux/types.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/pci</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">n</span><span class="c">it.h&gt;</span>

<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="w">ptrace</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">sm</span><span class="c">p.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;asm/</span><span class="w">mce</span><span class="c">.h&gt;</span>

<span class="c">#include</span> <span class="pc">"</span><span class="w">pr</span><span class="pc">o</span><span class="c">to.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">pci_impl</span><span class="c">.h"</span>





<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">DEBUG_CONFIG</span> <span class="pc">0</span>

<span class="c">#</span><span class="w">i</span><span class="pc">f</span> <span class="w">D</span><span class="pc">EBUG_</span><span class="c">CONFIG</span>
<span class="c">#</span> <span class="pc">d</span><span class="c">efine</span> <span class="w">DBGC</span><span class="c">(</span><span class="w">a</span><span class="pc">r</span><span class="c">gs</span><span class="pc">)</span>	<span class="w">p</span><span class="c">rintk</span> <span class="w">a</span><span class="pc">r</span><span class="c">gs</span>
<span class="pc">#el</span><span class="c">se</span>
<span class="c">#</span> <span class="c">define</span> <span class="c">DBGC(args</span><span class="pc">)</span>
<span class="c">#</span><span class="pc">en</span><span class="c">dif</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">vuip</span>	<span class="w">vo</span><span class="pc">l</span><span class="c">atile</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span>  <span class="w">*</span>



<span class="w">stat</span><span class="pc">i</span><span class="c">c</span> <span class="pc">i</span><span class="c">nt</span>
<span class="w">mk_conf_addr</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">pci_bus</span> <span class="c">*</span><span class="w">pbus</span><span class="c">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">device_fn</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">w</span><span class="pc">h</span><span class="c">ere</span><span class="pc">,</span>
	     <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">*</span><span class="w">pci_addr</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="c">*</span><span class="w">type1</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">unsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">a</span><span class="c">ddr;</span>
	<span class="pc">u8</span> <span class="w">bus</span> <span class="pc">=</span> <span class="c">pbus</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="pc">u</span><span class="c">mber;</span>

	<span class="w">DBGC(("m</span><span class="c">k_conf_addr</span><span class="w">(b</span><span class="c">us</span><span class="w">=</span><span class="pc">%</span><span class="c">d</span> <span class="c">,</span><span class="pc">d</span><span class="c">evice_fn</span><span class="w">=</span><span class="c">0x%x,</span> <span class="w">wh</span><span class="pc">e</span><span class="c">re</span><span class="pc">=</span><span class="c">0x%x</span><span class="w">,"</span>
	      <span class="w">"</span> <span class="w">p</span><span class="pc">c</span><span class="c">i_addr</span><span class="w">=</span><span class="c">0x%</span><span class="w">p</span><span class="c">,</span> <span class="w">type1</span><span class="pc">=</span><span class="c">0x%</span><span class="pc">p</span><span class="w">)</span><span class="pc">\</span><span class="c">n",</span>
	      <span class="w">bu</span><span class="pc">s,</span> <span class="pc">d</span><span class="c">evice_fn,</span> <span class="w">wh</span><span class="pc">e</span><span class="c">re,</span> <span class="w">p</span><span class="pc">c</span><span class="c">i_addr,</span> <span class="w">t</span><span class="c">ype1</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">b</span><span class="c">us</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">0) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">dev</span><span class="pc">ice</span> <span class="c">=</span> <span class="w">d</span><span class="pc">evi</span><span class="c">ce_fn</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">3</span><span class="c">;</span>

		

		<span class="c">if</span> <span class="c">(</span><span class="w">d</span><span class="pc">evice</span> <span class="pc">&gt;</span> <span class="w">20</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">DBGC(("mk_conf_addr:</span> <span class="w">d</span><span class="pc">evice</span> <span class="w">(</span><span class="pc">%</span><span class="c">d</span><span class="w">) &gt;</span> <span class="w">2</span><span class="pc">0,</span> <span class="w">returning</span> <span class="pc">-</span><span class="w">1\</span><span class="c">n",</span>
			      <span class="w">d</span><span class="pc">evice))</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="pc">1</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="w">*type1</span> <span class="pc">=</span> <span class="c">0;</span>
		<span class="w">a</span><span class="pc">d</span><span class="c">dr</span> <span class="pc">= </span><span class="c">(</span><span class="w">d</span><span class="c">evice_fn</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="pc">8</span><span class="c">) | (</span><span class="w">wh</span><span class="pc">e</span><span class="c">re</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		
		<span class="w">*</span><span class="c">type1</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">a</span><span class="c">ddr</span> <span class="pc">= </span><span class="c">(</span><span class="w">bus</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="pc">16</span><span class="c">) | (</span><span class="pc">d</span><span class="c">evice_fn</span> <span class="c">&lt;&lt;</span> <span class="pc">8) </span><span class="c">| (</span><span class="w">wh</span><span class="pc">e</span><span class="c">re</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">*pci_addr</span> <span class="pc">=</span> <span class="w">a</span><span class="c">ddr</span><span class="pc">;</span>
	<span class="w">DBGC(("mk_conf_addr:</span> <span class="w">returning</span> <span class="w">p</span><span class="c">ci_addr</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">l</span><span class="c">x</span><span class="pc">\</span><span class="c">n",</span> <span class="c">addr</span><span class="w">)</span><span class="pc">);</span>
	<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">int</span>
<span class="w">conf_read</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="pc">a</span><span class="c">ddr,</span> <span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">type1</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">unsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">stat0</span><span class="pc">,</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue;</span>
	<span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">haxr2</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>	

	<span class="w">DBGC(("c</span><span class="c">onf_read</span><span class="w">(a</span><span class="c">ddr</span><span class="pc">=</span><span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="pc">l</span><span class="c">x,</span> <span class="w">t</span><span class="c">ype1</span><span class="w">=</span><span class="pc">%</span><span class="c">d</span><span class="w">)</span><span class="pc">\</span><span class="c">n",</span> <span class="pc">a</span><span class="c">ddr,</span> <span class="w">t</span><span class="pc">ype1</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">s</span><span class="c">tat0</span> <span class="w">= *</span><span class="pc">(</span><span class="w">vuip)APECS_IOC_DCSR</span><span class="pc">;</span>
	<span class="w">*</span><span class="pc">(</span><span class="c">vuip</span><span class="w">)A</span><span class="c">PECS_IOC_DCSR</span> <span class="c">=</span> <span class="w">s</span><span class="c">tat0;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
	<span class="w">D</span><span class="c">BGC</span><span class="w">((</span><span class="pc">"c</span><span class="c">onf_read</span><span class="w">:</span> <span class="w">APECS</span> <span class="w">DCSR</span> <span class="w">was</span> <span class="w">0</span><span class="pc">x</span><span class="c">%x\n",</span> <span class="c">stat0</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">t</span><span class="c">ype1</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">haxr2</span> <span class="w">= *</span><span class="pc">(</span><span class="c">vuip</span><span class="w">)APECS_IOC_HAXR2</span><span class="pc">;</span>
		<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
		<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)</span><span class="pc">APECS_IOC_H</span><span class="c">AXR2</span> <span class="c">=</span> <span class="w">h</span><span class="c">axr2</span> <span class="w">|</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">D</span><span class="c">BGC</span><span class="w">(</span><span class="pc">(</span><span class="c">"</span><span class="pc">c</span><span class="c">onf_read</span><span class="w">:</span> <span class="w">TYPE1</span> <span class="w">ac</span><span class="pc">c</span><span class="c">ess\n</span><span class="pc">"))</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">draina(</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">mcheck_expected</span><span class="c">(</span><span class="w">0)</span><span class="pc"> =</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">mcheck_taken</span><span class="c">(</span><span class="w">0) </span><span class="pc">=</span> <span class="c">0;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>

	

	
	<span class="w">as</span><span class="pc">m</span> <span class="w">v</span><span class="pc">o</span><span class="c">latile</span><span class="w">("ldl</span> <span class="w">%0,%1;</span> <span class="w">mb;</span> <span class="w">mb" : "=r"(va</span><span class="pc">lu</span><span class="c">e</span><span class="w">) : "m"(*(vuip)ad</span><span class="c">dr</span><span class="w">)</span>
		     <span class="w">: "$9", "$1</span><span class="pc">0</span><span class="w">"</span><span class="pc">,</span><span class="c"> "$</span><span class="w">1</span><span class="pc">1</span><span class="w">"</span><span class="c">, "$</span><span class="w">12</span><span class="c">", "$</span><span class="w">13"</span><span class="c">, "$</span><span class="pc">1</span><span class="c">4</span><span class="w">",</span><span class="pc"> "</span><span class="w">mem</span><span class="pc">o</span><span class="c">ry</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">mcheck_taken</span><span class="c">(</span><span class="w">0</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">m</span><span class="c">check_taken(</span><span class="w">0) </span><span class="pc">=</span> <span class="c">0;</span>
		<span class="w">va</span><span class="pc">lu</span><span class="c">e</span> <span class="c">=</span> <span class="w">0xffffffffU</span><span class="pc">;</span>
		<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
	<span class="pc">}</span>
	<span class="w">mcheck_expected</span><span class="c">(</span><span class="w">0) </span><span class="pc">=</span> <span class="c">0;</span>
	<span class="w">mb</span><span class="pc">()</span><span class="c">;</span>

<span class="w">#</span><span class="pc">if</span> <span class="w">1</span>
	
	<span class="w">draina()</span><span class="c">;</span>

	
	<span class="w">stat0</span> <span class="w">= *</span><span class="pc">(</span><span class="w">vuip)APECS_IOC_DCSR;</span>
	<span class="w">DBGC(("conf_read:</span> <span class="w">APECS</span> <span class="w">DCSR</span> <span class="w">after</span> <span class="w">rea</span><span class="pc">d</span> <span class="w">0</span><span class="pc">x</span><span class="c">%x</span><span class="pc">\</span><span class="c">n",</span> <span class="c">stat0</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">s</span><span class="c">tat0</span> <span class="w">&amp;</span> <span class="w">0xffe0U</span><span class="c">) {</span>
		
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">(stat0</span> <span class="c">&amp;</span> <span class="w">0x08</span><span class="pc">0</span><span class="c">0</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">printk("</span><span class="w">apecs.c</span><span class="pc">:</span><span class="w">c</span><span class="c">onf_read</span><span class="w">:</span> <span class="w">got</span> <span class="w">s</span><span class="pc">tat0</span><span class="w">=</span><span class="pc">%x</span><span class="c">\n",</span> <span class="c">stat0);</span>
		<span class="pc">}</span>

		
		<span class="w">*</span><span class="pc">(</span><span class="w">vuip)APECS_IOC_DCSR</span> <span class="pc">=</span> <span class="w">s</span><span class="c">tat0;</span>
		<span class="w">m</span><span class="pc">b(</span><span class="c">);</span>
		<span class="w">wrmces</span><span class="c">(</span><span class="w">0x7</span><span class="c">);</span>			
		<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="w">0xf</span><span class="pc">ffff</span><span class="c">fff;</span>
	<span class="pc">}</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">type1</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="c">uip</span><span class="w">)APECS_IOC_HAXR2</span> <span class="pc">=</span> <span class="w">haxr2</span> <span class="w">&amp;</span><span class="pc"> ~1</span><span class="c">;</span>
		<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
	<span class="pc">}</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">conf_write</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">a</span><span class="pc">d</span><span class="c">dr</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">,</span> <span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">t</span><span class="c">ype1</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">stat0</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="c">int</span> <span class="w">haxr2</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">local_irq_save</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>	

	
	<span class="w">s</span><span class="pc">tat0</span> <span class="w">= *</span><span class="pc">(</span><span class="w">vuip)APECS_IOC_DCSR</span><span class="pc">;</span>
	<span class="w">*</span><span class="pc">(</span><span class="c">vuip</span><span class="w">)</span><span class="c">APECS_IOC_DCSR</span> <span class="pc">=</span> <span class="c">stat0;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype1</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="c">haxr2</span> <span class="w">= *</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)APECS_IOC_HAXR2</span><span class="pc">;</span>
		<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
		<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)</span><span class="c">APECS_IOC_HAXR2</span> <span class="c">=</span> <span class="w">h</span><span class="c">axr2</span> <span class="pc">|</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">draina</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">mcheck_expected</span><span class="c">(</span><span class="w">0)</span><span class="pc"> =</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>

	
	<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)ad</span><span class="c">dr</span> <span class="c">=</span> <span class="w">va</span><span class="pc">lu</span><span class="c">e;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
	<span class="w">mb</span><span class="c">();</span>  
	<span class="w">m</span><span class="c">check_expected</span><span class="pc">(</span><span class="w">0)</span><span class="pc"> =</span> <span class="c">0;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>

<span class="w">#</span><span class="pc">if</span> <span class="w">1</span>
	
	<span class="w">d</span><span class="c">raina</span><span class="w">()</span><span class="pc">;</span>

	
	<span class="w">stat0</span> <span class="w">= *</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip)</span><span class="w">APECS_IOC_DCSR</span><span class="pc">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(stat0</span> <span class="w">&amp;</span> <span class="w">0xffe0U</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">(stat0</span> <span class="c">&amp;</span> <span class="w">0x08</span><span class="pc">0</span><span class="c">0</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">printk</span><span class="pc">("</span><span class="w">apecs.c:conf_write:</span> <span class="w">got</span> <span class="w">s</span><span class="c">tat0</span><span class="w">=</span><span class="pc">%x</span><span class="c">\n",</span> <span class="c">stat0);</span>
		<span class="pc">}</span>

		
		<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)</span><span class="c">APECS_IOC_DCSR</span> <span class="c">=</span> <span class="c">stat0;</span>
		<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
		<span class="w">wrmces</span><span class="c">(</span><span class="w">0x7</span><span class="c">);</span>			
	<span class="c">}</span>
<span class="pc">#</span><span class="c">endif</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">type1</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="c">uip</span><span class="w">)APECS_IOC_HAXR2</span> <span class="w">=</span> <span class="w">haxr2</span> <span class="w">&amp;</span><span class="pc"> ~1</span><span class="c">;</span>
		<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
	<span class="pc">}</span>
	<span class="w">local_irq_restore</span><span class="c">(</span><span class="w">f</span><span class="c">lags);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">int</span>
<span class="w">apecs_read_config</span><span class="c">(struct</span> <span class="w">pci_bus</span> <span class="c">*</span><span class="w">b</span><span class="c">us,</span> <span class="pc">un</span><span class="c">signed</span> <span class="c">int</span> <span class="w">d</span><span class="pc">ev</span><span class="c">fn,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">w</span><span class="pc">h</span><span class="c">ere</span><span class="pc">,</span>
		  <span class="c">int</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="pc">,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="c">*</span><span class="w">v</span><span class="pc">alu</span><span class="c">e)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">a</span><span class="c">ddr</span><span class="pc">,</span> <span class="w">pci_addr</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">type1</span><span class="pc">;</span>
	<span class="w">l</span><span class="pc">on</span><span class="c">g</span> <span class="w">m</span><span class="pc">a</span><span class="c">sk;</span>
	<span class="c">int</span> <span class="w">s</span><span class="c">hift;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">mk_conf_addr</span><span class="c">(</span><span class="pc">b</span><span class="c">us,</span> <span class="w">d</span><span class="pc">evf</span><span class="c">n,</span> <span class="w">wh</span><span class="pc">e</span><span class="c">re</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">p</span><span class="c">ci_addr</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;type1))</span>
		<span class="c">return</span> <span class="w">PCIBIOS_DEVICE_NOT_FOUND</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">a</span><span class="c">sk</span> <span class="pc">= </span><span class="c">(</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">-</span> <span class="pc">1) *</span> <span class="pc">8</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">h</span><span class="c">ift</span> <span class="pc">= </span><span class="c">(</span><span class="w">wh</span><span class="pc">e</span><span class="c">re</span> <span class="pc">&amp;</span> <span class="w">3) *</span> <span class="pc">8</span><span class="c">;</span>
	<span class="w">a</span><span class="c">ddr</span> <span class="pc">= </span><span class="c">(</span><span class="pc">p</span><span class="c">ci_addr</span> <span class="c">&lt;&lt;</span> <span class="w">5</span><span class="pc">) +</span> <span class="w">m</span><span class="c">ask</span> <span class="w">+</span> <span class="w">APECS_CONF</span><span class="c">;</span>
	<span class="w">*</span><span class="pc">v</span><span class="c">alue</span> <span class="c">=</span> <span class="w">conf_read</span><span class="c">(</span><span class="w">a</span><span class="pc">d</span><span class="c">dr</span><span class="pc">,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe1</span><span class="w">) &gt;&gt; (</span><span class="pc">s</span><span class="c">hift</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">PCIBIOS_SUCCESSFUL</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span>
<span class="w">apecs_write_config</span><span class="c">(struct</span> <span class="w">pci_bus</span> <span class="c">*</span><span class="w">b</span><span class="c">us,</span> <span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">d</span><span class="pc">ev</span><span class="c">fn,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">w</span><span class="pc">h</span><span class="c">ere</span><span class="pc">,</span>
		   <span class="c">int</span> <span class="w">s</span><span class="c">ize</span><span class="pc">,</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="pc">valu</span><span class="c">e)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="pc">a</span><span class="c">ddr</span><span class="pc">,</span> <span class="w">pci_addr</span><span class="c">;</span>
	<span class="c">unsigned</span> <span class="pc">c</span><span class="c">har</span> <span class="w">t</span><span class="c">ype1</span><span class="pc">;</span>
	<span class="w">l</span><span class="c">ong</span> <span class="w">m</span><span class="c">ask;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">mk_conf_addr</span><span class="c">(</span><span class="pc">b</span><span class="c">us,</span> <span class="w">d</span><span class="pc">evf</span><span class="c">n,</span> <span class="w">wh</span><span class="pc">e</span><span class="c">re</span><span class="pc">, </span><span class="c">&amp;pci_addr</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">t</span><span class="c">ype1))</span>
		<span class="c">return</span> <span class="w">PCIBIOS_DEVICE_NOT_FOUND</span><span class="pc">;</span>

	<span class="w">ma</span><span class="c">sk</span> <span class="pc">= </span><span class="c">(</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">-</span> <span class="pc">1</span><span class="w">)</span><span class="pc"> *</span> <span class="pc">8</span><span class="c">;</span>
	<span class="w">a</span><span class="c">ddr</span> <span class="pc">= </span><span class="c">(</span><span class="pc">p</span><span class="c">ci_addr</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">5</span><span class="pc">) +</span> <span class="w">m</span><span class="c">ask</span> <span class="w">+</span> <span class="w">APECS_CONF</span><span class="c">;</span>
	<span class="w">conf_write</span><span class="pc">(</span><span class="w">a</span><span class="c">ddr,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="w">&lt;&lt; ((wh</span><span class="pc">e</span><span class="c">re</span> <span class="w">&amp;</span> <span class="w">3) *</span> <span class="w">8),</span> <span class="pc">t</span><span class="c">ype1</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">return</span> <span class="w">PCIBIOS_SUCCESSFUL</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">pci_ops</span> <span class="w">apecs_pci_ops</span> <span class="w">=</span> 
<span class="w">{</span>
	<span class="pc">.</span><span class="w">rea</span><span class="c">d</span> <span class="c">=</span>		<span class="w">apecs_read_config</span><span class="c">,</span>
	<span class="c">.</span><span class="w">w</span><span class="c">rite</span> <span class="c">=</span>	<span class="w">apecs_write_config</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">v</span><span class="c">oid</span>
<span class="w">apecs_pci_tbi</span><span class="c">(struct</span> <span class="w">pci_controller</span> <span class="c">*</span><span class="w">ho</span><span class="pc">se</span><span class="c">,</span> <span class="w">d</span><span class="c">ma_addr_t</span> <span class="w">s</span><span class="pc">t</span><span class="c">art,</span> <span class="w">d</span><span class="c">ma_addr_t</span> <span class="w">e</span><span class="pc">n</span><span class="c">d</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">wmb()</span><span class="c">;</span>
	<span class="w">*</span><span class="pc">(</span><span class="w">vip)APECS_IOC_TBIA</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
<span class="pc">}</span>

<span class="c">void</span> <span class="pc">__in</span><span class="c">it</span>
<span class="w">apecs_init_arch</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">pci_controller</span> <span class="c">*</span><span class="w">ho</span><span class="pc">se;</span>

	

	<span class="w">pci_isa_hose</span> <span class="pc">=</span> <span class="w">ho</span><span class="pc">se</span> <span class="w">=</span> <span class="w">alloc_pci_controller</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="w">io_space</span> <span class="w">=</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">ioport_resource</span><span class="c">;</span>
	<span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="w">mem_space</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">iomem_resource</span><span class="c">;</span>
	<span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="w">sparse_mem_base</span> <span class="c">=</span> <span class="w">APECS_SPARSE_MEM</span> <span class="w">-</span> <span class="w">IDENT_ADDR</span><span class="c">;</span>
	<span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="w">dense_mem_base</span> <span class="c">=</span> <span class="w">APECS_DENSE_MEM</span> <span class="w">-</span> <span class="pc">I</span><span class="c">DENT_ADDR;</span>
	<span class="w">ho</span><span class="pc">se-</span><span class="c">&gt;</span><span class="w">sparse_io_base</span> <span class="c">=</span> <span class="w">APECS_IO</span> <span class="w">-</span> <span class="pc">I</span><span class="c">DENT_ADDR;</span>
	<span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="w">dense_io_base</span> <span class="c">=</span> <span class="c">0;</span>

	
	<span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="w">sg_isa</span> <span class="c">=</span> <span class="w">iommu_arena_new</span><span class="pc">(</span><span class="w">ho</span><span class="pc">se,</span> <span class="w">0x00800000</span><span class="c">,</span> <span class="w">0</span><span class="pc">x</span><span class="c">00800000</span><span class="pc">,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="w">ho</span><span class="pc">se-</span><span class="c">&gt;</span><span class="w">sg_pci</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">__direct_map_base</span> <span class="pc">=</span> <span class="w">0x40</span><span class="pc">0000</span><span class="c">00</span><span class="pc">;</span>
	<span class="w">__direct_map_size</span> <span class="c">=</span> <span class="w">0x4</span><span class="c">0000000</span><span class="pc">;</span>

	<span class="w">*</span><span class="pc">(</span><span class="w">vuip)APECS_IOC_PB1R</span> <span class="pc">=</span> <span class="c">__direct_map_base</span> <span class="w">|</span> <span class="w">0x00080000</span><span class="pc">;</span>
	<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)APECS_IOC_PM1R</span> <span class="w">=</span><span class="pc"> </span><span class="c">(__direct_map_size</span> <span class="w">-</span> <span class="c">1</span><span class="pc">) &amp;</span> <span class="w">0xfff00000U</span><span class="c">;</span>
	<span class="w">*</span><span class="pc">(</span><span class="c">vuip</span><span class="w">)APECS_IOC_TB1R</span> <span class="pc">=</span> <span class="w">0</span><span class="c">;</span>

	<span class="w">*</span><span class="pc">(v</span><span class="c">uip</span><span class="w">)APECS_IOC_PB2R</span> <span class="pc">=</span> <span class="w">ho</span><span class="pc">se-</span><span class="c">&gt;</span><span class="w">sg_isa-</span><span class="pc">&gt;</span><span class="w">dma_base</span> <span class="w">|</span> <span class="w">0x000c0000</span><span class="c">;</span>
	<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="pc">)</span><span class="w">APECS_IOC_PM2R</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">ho</span><span class="pc">se-</span><span class="c">&gt;sg_isa</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">si</span><span class="pc">z</span><span class="c">e</span> <span class="w">-</span> <span class="c">1</span><span class="w">) </span><span class="pc">&amp;</span> <span class="w">0xfff00000</span><span class="c">;</span>
	<span class="w">*</span><span class="pc">(v</span><span class="c">uip</span><span class="w">)APECS_IOC_TB2R</span> <span class="pc">=</span> <span class="w">virt_to_phys</span><span class="c">(</span><span class="w">ho</span><span class="pc">se</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">g_isa</span><span class="w">-</span><span class="c">&gt;</span><span class="w">ptes) &gt;</span><span class="c">&gt;</span> <span class="pc">1;</span>

	<span class="w">apecs_pci_tbi</span><span class="c">(</span><span class="w">ho</span><span class="pc">se,</span> <span class="pc">0</span><span class="w">, </span><span class="pc">-</span><span class="c">1);</span>

	
	<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)APECS_IOC_HAXR2</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span>
<span class="w">apecs_pci_clr_err</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">jd</span><span class="c">;</span>

	<span class="pc">j</span><span class="c">d</span> <span class="w">= *</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)APECS_IOC_DCSR</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(jd</span> <span class="pc">&amp;</span> <span class="w">0xffe0L</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">*</span><span class="pc">(</span><span class="c">vuip</span><span class="pc">)</span><span class="w">APECS_IOC_SEAR</span><span class="pc">;</span>
		<span class="w">*</span><span class="pc">(</span><span class="c">vuip</span><span class="w">)A</span><span class="pc">PECS_IOC_D</span><span class="c">CSR</span> <span class="c">=</span> <span class="c">jd</span> <span class="w">|</span> <span class="w">0xffe1L</span><span class="pc">;</span>
		<span class="w">m</span><span class="pc">b</span><span class="c">();</span>
		<span class="w">*</span><span class="pc">(</span><span class="w">v</span><span class="pc">u</span><span class="c">ip</span><span class="w">)</span><span class="c">APECS_IOC_DCSR</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="w">*</span><span class="pc">(v</span><span class="c">uip</span><span class="w">)APECS_IOC_TBIA</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt)</span><span class="w">A</span><span class="pc">PECS_IOC_T</span><span class="c">BIA;</span>
	<span class="w">m</span><span class="c">b();</span>
	<span class="w">*</span><span class="pc">(</span><span class="c">vuip</span><span class="w">)A</span><span class="pc">PECS_IOC_T</span><span class="c">BIA</span><span class="pc">;</span>
<span class="pc">}</span>

<span class="w">v</span><span class="pc">o</span><span class="c">id</span>
<span class="w">apecs_machine_check</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">ve</span><span class="pc">c</span><span class="c">tor,</span> <span class="c">unsigned</span> <span class="c">long</span> <span class="w">la_ptr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">el_common</span> <span class="c">*</span><span class="w">mchk_header</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">el_apecs_procdata</span> <span class="c">*</span><span class="w">mchk_procdata</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">el_apecs_sysdata_mcheck</span> <span class="c">*</span><span class="w">mchk_sysdata</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">chk_h</span><span class="c">eader</span> <span class="pc">= </span><span class="c">(struct</span> <span class="pc">e</span><span class="c">l_common</span> <span class="c">*)</span><span class="w">l</span><span class="c">a_ptr;</span>

	<span class="w">m</span><span class="pc">chk_p</span><span class="c">rocdata</span> <span class="w">=</span><span class="pc"> (s</span><span class="c">truct</span> <span class="pc">e</span><span class="c">l_apecs_procdata</span> <span class="c">*)</span>
		<span class="w">(l</span><span class="c">a_ptr</span> <span class="w">+</span> <span class="pc">mchk_h</span><span class="c">eader-&gt;</span><span class="w">proc_offset</span>
		 <span class="w">-</span> <span class="w">s</span><span class="c">izeof(</span><span class="pc">m</span><span class="c">chk_procdata</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">paltemp</span><span class="c">));</span>

	<span class="w">m</span><span class="pc">chk_s</span><span class="c">ysdata</span> <span class="pc">= </span><span class="c">(struct</span> <span class="pc">el_apecs_s</span><span class="c">ysdata_mcheck</span> <span class="c">*)</span>
		<span class="w">(</span><span class="pc">l</span><span class="c">a_ptr</span> <span class="w">+</span> <span class="pc">m</span><span class="c">chk_header-&gt;</span><span class="w">sys_offset</span><span class="c">);</span>


	
	<span class="w">mb</span><span class="pc">(</span><span class="c">);</span>
	<span class="w">mb</span><span class="c">();</span> 
	<span class="w">draina</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">apecs_pci_clr_err</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">wrmces</span><span class="c">(</span><span class="w">0x7</span><span class="c">);</span>		
	<span class="w">m</span><span class="pc">b</span><span class="c">();</span>

	<span class="w">process_mcheck_info</span><span class="c">(</span><span class="w">ve</span><span class="pc">c</span><span class="c">tor</span><span class="pc">,</span> <span class="w">l</span><span class="c">a_ptr</span><span class="w">,</span><span class="pc"> "</span><span class="w">APECS</span><span class="pc">",</span>
			    <span class="w">(mcheck_expected</span><span class="pc">(0</span><span class="w">)</span>
			     <span class="w">&amp;</span><span class="c">&amp; (</span><span class="w">m</span><span class="pc">chk_s</span><span class="c">ysdata</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">epic_dcsr</span> <span class="pc">&amp;</span> <span class="w">0x0c00UL)))</span><span class="pc">;</span>
<span class="c">}</span>

</pre>
</body>
</html>

