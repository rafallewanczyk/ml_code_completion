<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">"xfs.h"</span>
<span class="w">#include</span> <span class="w">"xfs_shared.h"</span>
<span class="w">#include</span> <span class="w">"xfs_format.h"</span>
<span class="w">#include</span> <span class="w">"xfs_log_format.h"</span>
<span class="w">#include</span> <span class="w">"xfs_trans_resv.h"</span>
<span class="w">#include</span> <span class="w">"xfs_sb.</span><span class="c">h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_mount</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_da_format</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_inode</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_btree</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_bmap</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_alloc</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_error</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_fsops</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_trans</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_buf_item</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_log</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_log_priv</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_da_btree</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_dir2</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_extfree_item</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_mru_cache</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_inode_item</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_icache</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_trace</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_icreate_item</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_filestream</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_quota</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_sysfs</span><span class="c">.h"</span>

<span class="c">#include</span> <span class="pc">&lt;</span><span class="c">linux/</span><span class="w">namei</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">n</span><span class="c">it.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/slab.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">mount</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">mempool</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">writeback</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">kthread</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">freezer</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">parser</span><span class="c">.h&gt;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">super_operations</span> <span class="w">xfs_super_operations</span><span class="pc">;</span>
<span class="c">static</span> <span class="w">kmem_zone_t</span> <span class="pc">*</span><span class="w">xfs_ioend_zone</span><span class="pc">;</span>
<span class="w">mempool_t</span> <span class="pc">*</span><span class="w">xfs_ioend_pool</span><span class="pc">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">kset</span> <span class="c">*</span><span class="w">xfs_kset</span><span class="c">;</span>		
<span class="w">#</span><span class="c">ifdef</span> <span class="c">DEBUG</span>
<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_kobj</span> <span class="w">xfs_dbg_kobj</span><span class="c">;</span>	
<span class="pc">#</span><span class="c">endif</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">MNTOPT_LOGBUFS</span>	<span class="w">"logbufs</span><span class="pc">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_LOGBSIZE</span>	<span class="c">"</span><span class="w">logbsize</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_LOGDEV</span>	<span class="c">"</span><span class="w">logdev</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_RTDEV</span>	<span class="c">"</span><span class="w">rtdev</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_BIOSIZE</span>	<span class="c">"</span><span class="w">biosize</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_WSYNC</span>	<span class="c">"</span><span class="w">wsync</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_NOALIGN</span>	<span class="c">"</span><span class="w">noalign</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_SWALLOC</span>	<span class="c">"</span><span class="w">swalloc</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_SUNIT</span>	<span class="c">"</span><span class="w">sunit</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_SWIDTH</span>	<span class="c">"</span><span class="w">swidth</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_NOUUID</span>	<span class="c">"</span><span class="w">nouuid</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_MTPT</span>	<span class="c">"</span><span class="w">mtpt</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_GRPID</span>	<span class="c">"</span><span class="w">grpid</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_NOGRPID</span>	<span class="c">"</span><span class="w">nogrpid</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_BSDGROUPS</span>    <span class="c">"</span><span class="w">bsdgroups</span><span class="c">"</span>    
<span class="c">#define</span> <span class="w">MNTOPT_SYSVGROUPS</span>   <span class="c">"</span><span class="w">sysvgroups</span><span class="c">"</span>   
<span class="c">#define</span> <span class="w">MNTOPT_ALLOCSIZE</span>    <span class="c">"</span><span class="w">allocsize</span><span class="c">"</span>    
<span class="c">#define</span> <span class="w">MNTOPT_NORECOVERY</span>   <span class="c">"</span><span class="w">norecovery</span><span class="c">"</span>   
<span class="c">#define</span> <span class="w">MNTOPT_BARRIER</span>	<span class="c">"</span><span class="w">barrier</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_NOBARRIER</span> <span class="c">"</span><span class="w">nobarrier</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_64BITINODE</span>   <span class="c">"</span><span class="w">inode64</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_32BITINODE</span>   <span class="c">"</span><span class="w">inode32</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_IKEEP</span>	<span class="c">"</span><span class="w">ikeep</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_NOIKEEP</span>	<span class="c">"</span><span class="w">noikeep</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_LARGEIO</span>	   <span class="c">"</span><span class="w">largeio</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_NOLARGEIO</span>   <span class="c">"</span><span class="w">nolargeio</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_ATTR2</span>	<span class="c">"</span><span class="w">attr2</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_NOATTR2</span>	<span class="c">"</span><span class="w">noattr2</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_FILESTREAM</span>  <span class="c">"</span><span class="w">filestreams</span><span class="c">"</span> 
<span class="c">#define</span> <span class="w">MNTOPT_QUOTA</span>	<span class="c">"</span><span class="w">quota</span><span class="c">"</span>		
<span class="c">#define</span> <span class="w">MNTOPT_NOQUOTA</span>	<span class="c">"</span><span class="w">noquota</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_USRQUOTA</span>	<span class="c">"</span><span class="w">usrquota</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_GRPQUOTA</span>	<span class="c">"</span><span class="w">grpquota</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_PRJQUOTA</span>	<span class="c">"</span><span class="w">prjquota</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_UQUOTA</span>	<span class="c">"</span><span class="w">uquota</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_GQUOTA</span>	<span class="c">"</span><span class="w">gquota</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_PQUOTA</span>	<span class="c">"</span><span class="w">pquota</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_UQUOTANOENF</span> <span class="c">"</span><span class="w">uqnoenforce</span><span class="c">"</span>
<span class="c">#define</span> <span class="w">MNTOPT_GQUOTANOENF</span> <span class="c">"</span><span class="w">gqnoenforce</span><span class="c">"</span>
<span class="c">#define</span> <span class="w">MNTOPT_PQUOTANOENF</span> <span class="c">"</span><span class="w">pqnoenforce</span><span class="c">"</span>
<span class="c">#define</span> <span class="w">MNTOPT_QUOTANOENF</span>  <span class="c">"</span><span class="w">qnoenforce</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_DISCARD</span>	   <span class="c">"</span><span class="w">discard</span><span class="c">"</span>	
<span class="c">#define</span> <span class="w">MNTOPT_NODISCARD</span>   <span class="c">"</span><span class="w">nodiscard</span><span class="c">"</span>	

<span class="c">#define</span> <span class="w">MNTOPT_DAX</span>	<span class="c">"</span><span class="w">dax</span><span class="c">"</span>		


<span class="pc">e</span><span class="c">num</span> <span class="c">{</span>
	<span class="w">Opt_barrier</span><span class="c">,</span>
	<span class="w">Opt_nobarrier</span><span class="c">,</span>
	<span class="w">Opt_inode64</span><span class="c">,</span>
	<span class="w">Opt_inode32</span><span class="c">,</span>
	<span class="w">Opt_err</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="c">const</span> <span class="w">match_table_t</span> <span class="w">tokens</span> <span class="w">=</span><span class="c"> {</span>
	<span class="pc">{O</span><span class="c">pt_barrier</span><span class="pc">, </span><span class="c">"</span><span class="w">barrier"}</span><span class="c">,</span>
	<span class="c">{</span><span class="pc">Opt_n</span><span class="c">obarrier</span><span class="pc">, </span><span class="c">"</span><span class="w">nobarrier"</span><span class="pc">}</span><span class="c">,</span>
	<span class="c">{</span><span class="w">O</span><span class="pc">pt_i</span><span class="c">node64</span><span class="pc">, </span><span class="c">"</span><span class="w">inode64</span><span class="pc">"}</span><span class="c">,</span>
	<span class="c">{</span><span class="w">O</span><span class="pc">pt_inode3</span><span class="c">2</span><span class="pc">, </span><span class="c">"</span><span class="w">inode32</span><span class="pc">"}</span><span class="c">,</span>
	<span class="c">{</span><span class="w">O</span><span class="pc">pt_e</span><span class="c">rr,</span> <span class="pc">N</span><span class="c">ULL</span><span class="w">}</span>
<span class="c">};</span>


<span class="w">STATIC</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">l</span><span class="c">ong</span>
<span class="w">suffix_kstrtoint</span><span class="pc">(</span><span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">s</span><span class="c">,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">ba</span><span class="pc">s</span><span class="c">e,</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">*</span><span class="w">r</span><span class="pc">es</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span>	<span class="w">la</span><span class="c">st</span><span class="pc">,</span> <span class="w">shift_left_factor</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">_res</span><span class="pc">;</span>
	<span class="w">c</span><span class="c">har</span>	<span class="c">*</span><span class="w">v</span><span class="c">alue</span> <span class="c">=</span> <span class="w">s</span><span class="pc">;</span>

	<span class="w">la</span><span class="pc">s</span><span class="c">t</span> <span class="c">=</span> <span class="w">st</span><span class="pc">r</span><span class="c">len(</span><span class="w">v</span><span class="pc">al</span><span class="c">ue</span><span class="w">) </span><span class="pc">-</span> <span class="c">1;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">v</span><span class="c">alue</span><span class="w">[la</span><span class="c">st</span><span class="w">] == 'K' ||</span> <span class="pc">v</span><span class="c">alue</span><span class="pc">[</span><span class="w">la</span><span class="c">st</span><span class="w">] =</span><span class="pc">= </span><span class="c">'</span><span class="w">k') {</span>
		<span class="w">s</span><span class="c">hift_left_factor</span> <span class="w">=</span> <span class="w">1</span><span class="pc">0</span><span class="c">;</span>
		<span class="pc">v</span><span class="c">alue</span><span class="pc">[</span><span class="w">l</span><span class="pc">a</span><span class="c">st</span><span class="w">] = '\0</span><span class="pc">'</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(value</span><span class="w">[l</span><span class="pc">a</span><span class="c">st</span><span class="w">] =</span><span class="pc">= </span><span class="c">'</span><span class="w">M</span><span class="pc">'</span><span class="c"> ||</span> <span class="c">value</span><span class="w">[l</span><span class="pc">a</span><span class="c">st</span><span class="pc">] </span><span class="c">== '</span><span class="w">m'</span><span class="c">) {</span>
		<span class="c">shift_left_factor</span> <span class="w">=</span> <span class="w">20</span><span class="c">;</span>
		<span class="w">v</span><span class="c">alue</span><span class="pc">[</span><span class="w">l</span><span class="pc">a</span><span class="c">st</span><span class="w">] </span><span class="pc">= '</span><span class="c">\</span><span class="w">0</span><span class="pc">'</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">lue</span><span class="w">[l</span><span class="pc">a</span><span class="c">st</span><span class="w">] =</span><span class="pc">= </span><span class="c">'</span><span class="w">G</span><span class="pc">'</span><span class="c"> ||</span> <span class="c">value</span><span class="w">[l</span><span class="pc">a</span><span class="c">st</span><span class="w">]</span><span class="pc"> =</span><span class="c">= '</span><span class="w">g</span><span class="pc">'</span><span class="c">) {</span>
		<span class="c">shift_left_factor</span> <span class="w">=</span> <span class="w">3</span><span class="pc">0</span><span class="c">;</span>
		<span class="w">v</span><span class="c">alue</span><span class="pc">[</span><span class="w">l</span><span class="pc">a</span><span class="c">st</span><span class="w">] =</span><span class="pc"> '</span><span class="c">\</span><span class="w">0</span><span class="pc">'</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">kstrtoint</span><span class="c">(</span><span class="w">s</span><span class="c">,</span> <span class="w">ba</span><span class="pc">s</span><span class="c">e</span><span class="w">,</span><span class="pc"> &amp;</span><span class="w">_res</span><span class="pc">)</span><span class="c">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
	<span class="w">*r</span><span class="pc">es</span> <span class="c">=</span> <span class="c">_res</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">s</span><span class="pc">hift_</span><span class="c">left_factor;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_parseargs</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="c">,</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span>			<span class="c">*</span><span class="w">o</span><span class="pc">p</span><span class="c">tions</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="w">s</span><span class="pc">b</span> <span class="pc">=</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_super</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span>			<span class="c">*</span><span class="w">this_char</span><span class="pc">,</span><span class="c"> *</span><span class="w">va</span><span class="pc">lu</span><span class="c">e;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">dsunit</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">dswidth</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">int</span>			<span class="w">iosize</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">__uint8_t</span>		<span class="w">iosizelog</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="w">mp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m_fsname</span> <span class="c">=</span> <span class="w">kstrndup</span><span class="pc">(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_id</span><span class="c">,</span> <span class="w">MAXNAMELEN</span><span class="pc">,</span> <span class="pc">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_fsname)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_fsname_len</span> <span class="c">=</span> <span class="w">st</span><span class="pc">r</span><span class="c">len(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_fsname</span><span class="w">) </span><span class="pc">+</span> <span class="c">1;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)</span>
		<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_RDONLY</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">_flags</span> <span class="pc">&amp;</span> <span class="w">MS_DIRSYNC</span><span class="c">)</span>
		<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_fl</span><span class="c">ags</span> <span class="c">|=</span> <span class="w">XFS_MOUNT_DIRSYNC</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">sb</span><span class="c">-&gt;s_flags</span> <span class="c">&amp;</span> <span class="w">MS_SYNCHRONOUS</span><span class="c">)</span>
		<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="c">|=</span> <span class="w">XFS_MOUNT_WSYNC</span><span class="c">;</span>

	
	<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="c">|=</span> <span class="w">XFS_MOUNT_BARRIER</span><span class="c">;</span>
	<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="c">|=</span> <span class="w">XFS_MOUNT_COMPAT_IOSIZE</span><span class="c">;</span>

	
	<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logbufs</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>
	<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logbsize</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">opt</span><span class="pc">ions</span><span class="c">)</span>
		<span class="c">goto</span> <span class="w">d</span><span class="c">one;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="pc">((</span><span class="w">this_char</span> <span class="c">=</span> <span class="w">strsep</span><span class="pc">(&amp;</span><span class="w">op</span><span class="pc">ti</span><span class="c">ons</span><span class="w">, ",")) !=</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="w">(!*</span><span class="c">this_char</span><span class="w">)</span>
			<span class="pc">c</span><span class="c">ontinue;</span>
		<span class="c">if</span> <span class="pc">((</span><span class="w">va</span><span class="pc">lu</span><span class="c">e</span> <span class="pc">=</span> <span class="w">strchr</span><span class="c">(</span><span class="pc">t</span><span class="c">his_char</span><span class="w">, '=')) !=</span> <span class="w">N</span><span class="c">ULL</span><span class="w">)</span>
			<span class="pc">*</span><span class="w">v</span><span class="c">alue</span><span class="w">+</span><span class="pc">+</span><span class="c"> =</span> <span class="pc">0</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char,</span> <span class="w">MNTOPT_LOGBUFS</span><span class="pc">)</span><span class="c">) {</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">alue</span> <span class="w">|| !*v</span><span class="c">alue</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">mp,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="c">,</span>
					<span class="pc">t</span><span class="c">his_char);</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">kstrtoint</span><span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">lue,</span> <span class="w">1</span><span class="pc">0, </span><span class="c">&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_logbufs</span><span class="c">))</span>
				<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_LOGBSIZE)</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">alue</span> <span class="w">|| !*v</span><span class="c">alue</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">mp,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">tion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="pc">,</span>
					<span class="w">t</span><span class="c">his_char);</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">suffix_kstrtoint</span><span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">lue,</span> <span class="w">1</span><span class="pc">0, </span><span class="c">&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_logbsize</span><span class="c">))</span>
				<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_LOGDEV)</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">alue</span> <span class="w">|| !*v</span><span class="c">alue</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">mp,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">tion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="pc">,</span>
					<span class="w">t</span><span class="c">his_char);</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
			<span class="c">}</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_logname</span> <span class="c">=</span> <span class="w">kstrndup</span><span class="pc">(</span><span class="w">va</span><span class="pc">l</span><span class="c">ue,</span> <span class="w">MAXNAMELEN</span><span class="pc">,</span> <span class="w">G</span><span class="c">FP_KERNEL);</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">mp</span><span class="pc">-</span><span class="c">&gt;m_logname</span><span class="pc">)</span>
				<span class="c">return</span> <span class="pc">-</span><span class="c">ENOMEM;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_MTPT)</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="w">,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">allowed</span> <span class="w">o</span><span class="pc">n</span> <span class="w">t</span><span class="pc">his</span> <span class="w">system"</span><span class="c">,</span>
				<span class="w">t</span><span class="c">his_char</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char,</span> <span class="w">MNTOPT_RTDEV</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="w">|| !*v</span><span class="c">alue) {</span>
				<span class="w">x</span><span class="c">fs_warn</span><span class="pc">(</span><span class="w">mp,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="c">,</span>
					<span class="pc">t</span><span class="c">his_char);</span>
				<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
			<span class="c">}</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_rtname</span> <span class="c">=</span> <span class="w">kstrndup</span><span class="pc">(</span><span class="w">va</span><span class="pc">l</span><span class="c">ue,</span> <span class="w">MAXNAMELEN</span><span class="pc">,</span> <span class="w">G</span><span class="c">FP_KERNEL);</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">mp</span><span class="pc">-</span><span class="c">&gt;m_rtname</span><span class="pc">)</span>
				<span class="c">return</span> <span class="pc">-</span><span class="c">ENOMEM;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_BIOSIZE)</span><span class="pc">) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">alue</span> <span class="w">|| !*v</span><span class="c">alue</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="w">,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="c">,</span>
					<span class="w">t</span><span class="pc">h</span><span class="c">is_char);</span>
				<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">kstrtoint</span><span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">lue,</span> <span class="w">1</span><span class="pc">0, </span><span class="c">&amp;</span><span class="w">iosize</span><span class="pc">)</span><span class="c">)</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
			<span class="w">iosizelog</span> <span class="pc">=</span> <span class="w">ffs</span><span class="c">(</span><span class="pc">i</span><span class="c">osize</span><span class="w">)</span><span class="pc"> -</span> <span class="c">1</span><span class="pc">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_ALLOCSIZE</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">alue</span> <span class="w">|| !*v</span><span class="c">alue</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">mp,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="c">,</span>
					<span class="w">t</span><span class="c">his_char);</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">suffix_kstrtoint</span><span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">lue,</span> <span class="w">1</span><span class="pc">0, </span><span class="c">&amp;</span><span class="w">iosize</span><span class="pc">)</span><span class="c">)</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
			<span class="w">iosizelog</span> <span class="pc">=</span> <span class="w">ffs</span><span class="c">(</span><span class="pc">i</span><span class="c">osize</span><span class="w">)</span><span class="pc"> -</span> <span class="c">1</span><span class="pc">;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_GRPID) |</span><span class="c">|</span>
			   <span class="pc">!s</span><span class="c">trcmp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_BSDGROUPS</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_GRPID</span><span class="c">;</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOGRPID) |</span><span class="c">|</span>
			   <span class="pc">!s</span><span class="c">trcmp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_SYSVGROUPS</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">X</span><span class="c">FS_MOUNT_GRPID;</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_WSYNC</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_WSYNC</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_NORECOVERY</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_NORECOVERY</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOALIGN</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_NOALIGN</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_SWALLOC</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_SWALLOC</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_SUNIT</span><span class="pc">)</span><span class="c">) {</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="w">|| !*v</span><span class="c">alue</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="w">,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="c">,</span>
					<span class="w">t</span><span class="c">his_char);</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="pc">EIN</span><span class="c">VAL;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">kstrtoint</span><span class="c">(</span><span class="w">v</span><span class="pc">alu</span><span class="c">e,</span> <span class="w">1</span><span class="pc">0, </span><span class="c">&amp;</span><span class="w">dsunit</span><span class="pc">)</span><span class="c">)</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">trc</span><span class="c">mp(</span><span class="w">t</span><span class="pc">h</span><span class="c">is_char,</span> <span class="w">MNTOPT_SWIDTH</span><span class="pc">)</span><span class="c">) {</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">v</span><span class="c">alue</span> <span class="w">|| !*v</span><span class="c">alue</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">mp,</span><span class="pc"> "%</span><span class="c">s</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">requires</span> <span class="w">an</span> <span class="w">argument"</span><span class="pc">,</span>
					<span class="w">t</span><span class="pc">h</span><span class="c">is_char);</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">kstrtoint</span><span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">lue,</span> <span class="w">1</span><span class="pc">0, </span><span class="c">&amp;</span><span class="w">dswidth</span><span class="pc">)</span><span class="c">)</span>
				<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">trc</span><span class="c">mp(</span><span class="w">t</span><span class="pc">h</span><span class="c">is_char,</span> <span class="w">MNTOPT_32BITINODE</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_SMALL_INUMS</span><span class="c">;</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_64BITINODE</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">X</span><span class="c">FS_MOUNT_SMALL_INUMS;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOUUID</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_NOUUID</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_BARRIER</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_BARRIER</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOBARRIER</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">XFS_MOUNT_B</span><span class="c">ARRIER;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_IKEEP</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_IKEEP</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOIKEEP</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">XFS_MOUNT_I</span><span class="c">KEEP;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_LARGEIO</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">XFS_MOUNT_COMPAT_IOSIZE</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOLARGEIO</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">XFS_MOUNT_C</span><span class="c">OMPAT_IOSIZE;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_ATTR2</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_ATTR2</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOATTR2</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">XFS_MOUNT_A</span><span class="c">TTR2;</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_NOATTR2</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!s</span><span class="c">trcmp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_FILESTREAM</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_FILESTREAMS</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!s</span><span class="c">trcmp(</span><span class="pc">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_NOQUOTA</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_qflags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">XFS_ALL_QUOTA_ACCT</span><span class="c">;</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_qflags</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">XFS_ALL_QUOTA_ENFD</span><span class="c">;</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_qflags</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">XFS_ALL_QUOTA_ACTIVE</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">trc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_QUOTA) |</span><span class="c">|</span>
			   <span class="c">!</span><span class="w">s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_UQUOTA)</span><span class="pc"> </span><span class="c">||</span>
			   <span class="pc">!s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_USRQUOTA</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_qflags</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">XFS_UQUOTA_ACCT</span> <span class="pc">|</span> <span class="w">XFS_UQUOTA_ACTIVE</span> <span class="c">|</span>
					 <span class="w">XFS_UQUOTA_ENFD</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_QUOTANOENF) </span><span class="pc">|</span><span class="c">|</span>
			   <span class="pc">!s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_UQUOTANOENF</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_qflags</span> <span class="w">|</span><span class="pc">= </span><span class="c">(XFS_UQUOTA_ACCT</span> <span class="pc">|</span> <span class="c">XFS_UQUOTA_ACTIVE);</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_qflags</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">X</span><span class="pc">FS_UQUOTA_E</span><span class="c">NFD;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_PQUOTA) |</span><span class="c">|</span>
			   <span class="pc">!</span><span class="w">s</span><span class="c">trcmp(</span><span class="w">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_PRJQUOTA)</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">_qflags</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">XFS_PQUOTA_ACCT</span> <span class="pc">|</span> <span class="w">XFS_PQUOTA_ACTIVE</span> <span class="c">|</span>
					 <span class="w">XFS_PQUOTA_ENFD</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_PQUOTANOENF</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_qflags</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="pc">X</span><span class="c">FS_PQUOTA_ACCT</span> <span class="pc">|</span> <span class="pc">X</span><span class="c">FS_PQUOTA_ACTIVE</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">mp</span><span class="c">-&gt;m_qflags</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="pc">XFS_PQUOTA_E</span><span class="c">NFD;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">trc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_GQUOTA) |</span><span class="c">|</span>
			   <span class="pc">!</span><span class="w">s</span><span class="c">trcmp(</span><span class="w">t</span><span class="c">his_char</span><span class="pc">,</span> <span class="w">MNTOPT_GRPQUOTA</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">_qflags</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">XFS_GQUOTA_ACCT</span> <span class="pc">|</span> <span class="w">XFS_GQUOTA_ACTIVE</span> <span class="c">|</span>
					 <span class="w">XFS_GQUOTA_ENFD</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_GQUOTANOENF</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_qflags</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="pc">X</span><span class="c">FS_GQUOTA_ACCT</span> <span class="pc">|</span> <span class="pc">X</span><span class="c">FS_GQUOTA_ACTIVE</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">mp</span><span class="c">-&gt;m_qflags</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="pc">XFS_GQUOTA_E</span><span class="c">NFD;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="pc">(!</span><span class="w">s</span><span class="pc">trc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_DISCARD</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_DISCARD</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!strc</span><span class="c">mp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_NODISCARD</span><span class="pc">)</span><span class="c">) {</span>
			<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">X</span><span class="c">FS_MOUNT_DISCARD;</span>
<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">CONFIG_FS_DAX</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="pc">(!</span><span class="w">s</span><span class="c">trcmp(this_char</span><span class="pc">,</span> <span class="w">MNTOPT_DAX</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_DAX</span><span class="c">;</span>
<span class="w">#</span><span class="c">endif</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="c">p</span><span class="pc">, </span><span class="c">"</span><span class="w">u</span><span class="c">nknown</span> <span class="w">mount</span> <span class="w">op</span><span class="pc">t</span><span class="c">ion</span> <span class="w">[</span><span class="c">%</span><span class="pc">s</span><span class="w">].",</span> <span class="pc">t</span><span class="c">his_char</span><span class="w">)</span><span class="pc">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
		<span class="c">}</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="c">&amp;</span> <span class="w">XFS_MOUNT_NORECOVERY</span><span class="c">) &amp;&amp;</span>
	    <span class="pc">!(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">_flags</span> <span class="c">&amp;</span> <span class="w">XFS_MOUNT_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">x</span><span class="c">fs_warn</span><span class="pc">(</span><span class="w">m</span><span class="pc">p, "n</span><span class="c">o</span><span class="w">-recovery</span> <span class="w">mounts</span> <span class="w">must</span> <span class="w">b</span><span class="c">e</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="pc">((</span><span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="c">&amp;</span> <span class="w">XFS_MOUNT_NOALIGN) </span><span class="pc">&amp;&amp; </span><span class="c">(</span><span class="w">dsunit</span> <span class="w">|</span><span class="c">|</span> <span class="w">dswidth)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">x</span><span class="c">fs_warn(</span><span class="w">mp</span><span class="c">,</span>
	<span class="pc">"</span><span class="w">sunit</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">swidth</span> <span class="w">op</span><span class="pc">t</span><span class="c">ions</span> <span class="w">incompatible</span> <span class="w">w</span><span class="c">ith</span> <span class="pc">t</span><span class="c">he</span> <span class="w">noalign</span> <span class="w">op</span><span class="pc">tion</span><span class="w">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
	<span class="c">}</span>

<span class="w">#i</span><span class="pc">fn</span><span class="c">def</span> <span class="w">CONFIG_XFS_QUOTA</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">XFS_IS_QUOTA_RUNNING</span><span class="pc">(</span><span class="w">m</span><span class="pc">p)) </span><span class="c">{</span>
		<span class="w">x</span><span class="c">fs_warn(</span><span class="w">mp</span><span class="pc">, </span><span class="c">"</span><span class="w">quota</span> <span class="w">s</span><span class="pc">up</span><span class="c">port</span> <span class="pc">n</span><span class="c">ot</span> <span class="w">available</span> <span class="w">i</span><span class="c">n</span> <span class="w">t</span><span class="pc">hi</span><span class="c">s</span> <span class="w">k</span><span class="pc">er</span><span class="c">nel</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>
<span class="c">#endif</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">dsunit</span> <span class="w">&amp;</span><span class="pc">&amp; !</span><span class="w">dswidth) || (!</span><span class="c">dsunit</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="pc">dsw</span><span class="c">idth</span><span class="w">)</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">x</span><span class="c">fs_warn</span><span class="pc">(</span><span class="w">mp</span><span class="pc">, </span><span class="c">"</span><span class="w">sunit</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">swidth</span> <span class="w">must</span> <span class="w">b</span><span class="pc">e</span> <span class="w">specified</span> <span class="w">together</span><span class="pc">")</span><span class="c">;</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(dsunit</span> <span class="w">&amp;</span><span class="pc">&amp; (dsw</span><span class="c">idth</span> <span class="w">%</span> <span class="w">d</span><span class="pc">s</span><span class="c">unit</span> <span class="w">!</span><span class="c">=</span> <span class="c">0</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">xfs_warn</span><span class="pc">(</span><span class="w">mp</span><span class="c">,</span>
	<span class="pc">"</span><span class="w">stripe</span> <span class="w">wi</span><span class="pc">d</span><span class="c">th</span> <span class="w">(</span><span class="c">%d</span><span class="pc">)</span> <span class="pc">m</span><span class="c">ust</span> <span class="w">b</span><span class="c">e</span> <span class="w">a</span> <span class="w">multiple</span> <span class="w">o</span><span class="c">f</span> <span class="pc">t</span><span class="c">he</span> <span class="c">stripe</span> <span class="w">un</span><span class="c">it</span> <span class="w">(</span><span class="c">%d</span><span class="pc">)"</span><span class="c">,</span>
			<span class="c">dswidth</span><span class="pc">,</span> <span class="w">d</span><span class="pc">su</span><span class="c">nit</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

<span class="w">do</span><span class="pc">n</span><span class="c">e</span><span class="pc">:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(dsunit</span> <span class="w">&amp;&amp; !(mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_MOUNT_NOALIGN</span><span class="pc">)) </span><span class="c">{</span>
		
		<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_dalign</span> <span class="c">=</span> <span class="pc">d</span><span class="c">sunit;</span>
		<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_swidth</span> <span class="c">=</span> <span class="w">d</span><span class="pc">sw</span><span class="c">idth;</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logbufs</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_logbufs</span> <span class="pc">!</span><span class="c">=</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">(mp</span><span class="c">-&gt;m_logbufs</span> <span class="w">&lt;</span> <span class="w">XLOG_MIN_ICLOGS</span> <span class="w">|</span><span class="c">|</span>
	     <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_l</span><span class="c">ogbufs</span> <span class="w">&gt;</span> <span class="w">XLOG_MAX_ICLOGS)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p, "</span><span class="w">i</span><span class="c">nvalid</span> <span class="w">logbufs</span> <span class="w">va</span><span class="pc">lu</span><span class="c">e</span><span class="pc">:</span><span class="c"> %d</span> <span class="w">[n</span><span class="pc">ot</span> <span class="w">%</span><span class="pc">d</span><span class="w">-</span><span class="c">%d</span><span class="w">]",</span>
			<span class="w">mp</span><span class="pc">-</span><span class="c">&gt;m_logbufs</span><span class="pc">,</span> <span class="pc">X</span><span class="c">LOG_MIN_ICLOGS</span><span class="pc">,</span> <span class="w">X</span><span class="c">LOG_MAX_ICLOGS</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_logbsize</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_logbsize</span> <span class="pc">!</span><span class="c">=</span>  <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="pc">(</span><span class="w">mp</span><span class="c">-&gt;m_logbsize</span> <span class="w">&lt;</span> <span class="w">XLOG_MIN_RECORD_BSIZE</span> <span class="c">||</span>
	     <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_logbsize</span> <span class="pc">&gt;</span> <span class="w">XLOG_MAX_RECORD_BSIZE</span> <span class="pc">|</span><span class="c">|</span>
	     <span class="c">!</span><span class="w">is_power_of_2</span><span class="c">(</span><span class="w">mp</span><span class="c">-&gt;m_logbsize</span><span class="w">))</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span>
			<span class="pc">"</span><span class="w">i</span><span class="c">nvalid</span> <span class="w">logbufsize:</span><span class="pc"> </span><span class="c">%</span><span class="pc">d</span> <span class="w">[n</span><span class="pc">ot</span> <span class="w">16k,32k,64k</span><span class="pc">,</span><span class="w">128k</span> <span class="w">o</span><span class="c">r</span> <span class="w">256k]",</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_logbsize</span><span class="w">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">iosizelog</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">i</span><span class="c">osizelog</span> <span class="c">&gt;</span> <span class="w">XFS_MAX_IO_LOG</span> <span class="pc">|</span><span class="c">|</span>
		    <span class="pc">i</span><span class="c">osizelog</span> <span class="w">&lt;</span> <span class="w">XFS_MIN_IO_LOG</span><span class="c">) {</span>
			<span class="w">xfs_warn</span><span class="pc">(</span><span class="w">mp</span><span class="pc">, </span><span class="c">"</span><span class="w">i</span><span class="pc">n</span><span class="c">valid</span> <span class="w">lo</span><span class="pc">g</span> <span class="w">iosize:</span><span class="pc"> </span><span class="c">%</span><span class="pc">d</span> <span class="w">[n</span><span class="pc">ot</span> <span class="w">%</span><span class="pc">d</span><span class="w">-</span><span class="c">%d</span><span class="w">]"</span><span class="c">,</span>
				<span class="w">i</span><span class="pc">o</span><span class="c">sizelog</span><span class="w">,</span> <span class="c">XFS_MIN_IO_LOG</span><span class="pc">,</span>
				<span class="w">X</span><span class="c">FS_MAX_IO_LOG</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span>

		<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_DFLT_IOSIZE</span><span class="c">;</span>
		<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_readio_log</span> <span class="c">=</span> <span class="w">i</span><span class="pc">osizel</span><span class="c">og;</span>
		<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_writeio_log</span> <span class="c">=</span> <span class="pc">i</span><span class="c">osizelog;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">proc_xfs_info</span> <span class="pc">{</span>
	<span class="w">ui</span><span class="pc">nt6</span><span class="c">4_t</span>	<span class="w">fl</span><span class="pc">ag</span><span class="c">;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span>		<span class="c">*</span><span class="w">st</span><span class="pc">r</span><span class="c">;</span>
<span class="w">}</span><span class="pc">;</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">nt</span>
<span class="w">xfs_showargs</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span>
	<span class="c">struct</span> <span class="w">s</span><span class="pc">e</span><span class="c">q_file</span>		<span class="c">*m</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">struct</span> <span class="pc">p</span><span class="c">roc_xfs_info</span> <span class="w">xfs_info_set</span><span class="pc">[]</span><span class="c"> = {</span>
		
		<span class="c">{</span> <span class="w">XFS_MOUNT_IKEEP,		","</span> <span class="w">MNTOPT_IKEEP</span> <span class="w">}</span><span class="pc">,</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_WSYNC,</span><span class="pc">	</span><span class="c">	","</span> <span class="w">MNTOPT_WSYNC</span> <span class="pc">}</span><span class="c">,</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_NOALIGN,	</span><span class="pc">	</span><span class="c">","</span> <span class="w">MNTOPT_NOALIGN</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_SWALLOC,</span><span class="pc">	</span><span class="c">	","</span> <span class="w">MNTOPT_SWALLOC</span> <span class="pc">}</span><span class="c">,</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_NOUUID,</span><span class="pc">	</span><span class="c">	","</span> <span class="w">MNTOPT_NOUUID</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_NORECOVERY</span><span class="pc">,	</span><span class="c">	","</span> <span class="w">MNTOPT_NORECOVERY</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_ATTR2</span><span class="c">,		","</span> <span class="w">MNTOPT_ATTR2</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_FILESTREAMS,	","</span> <span class="w">MNTOPT_FILESTREAM</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_GRPID</span><span class="pc">,	</span><span class="c">	","</span> <span class="w">MNTOPT_GRPID</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_DISCARD</span><span class="pc">,	</span><span class="c">	","</span> <span class="w">MNTOPT_DISCARD</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_SMALL_INUMS,	</span><span class="pc">",</span><span class="c">"</span> <span class="w">MNTOPT_32BITINODE</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_DAX</span><span class="pc">,	</span><span class="c">	","</span> <span class="w">MNTOPT_DAX</span> <span class="c">},</span>
		<span class="c">{</span> <span class="pc">0</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL</span> <span class="pc">}</span>
	<span class="c">};</span>
	<span class="c">static</span> <span class="c">struct</span> <span class="w">proc_xfs_info</span> <span class="w">xfs_info_unset</span><span class="pc">[</span><span class="c">] = {</span>
		
		<span class="c">{</span> <span class="w">XFS_MOUNT_COMPAT_IOSIZE,</span><span class="pc">	</span><span class="c">","</span> <span class="w">MNTOPT_LARGEIO</span> <span class="pc">}</span><span class="c">,</span>
		<span class="c">{</span> <span class="w">XFS_MOUNT_BARRIER,</span><span class="pc">	</span><span class="c">	","</span> <span class="w">MNTOPT_NOBARRIER</span> <span class="c">},</span>
		<span class="c">{</span> <span class="w">X</span><span class="pc">FS_MOUNT_S</span><span class="c">MALL_INUMS</span><span class="w">,</span><span class="pc">	"</span><span class="c">,"</span> <span class="w">MNTOPT_64BITINODE</span> <span class="c">},</span>
		<span class="c">{</span> <span class="pc">0</span><span class="c">,</span> <span class="w">N</span><span class="c">ULL</span> <span class="pc">}</span>
	<span class="c">};</span>
	<span class="pc">str</span><span class="c">uct</span> <span class="pc">p</span><span class="c">roc_xfs_info</span>	<span class="pc">*</span><span class="w">xfs_infop</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="pc">x</span><span class="c">fs_infop</span> <span class="c">=</span> <span class="w">xfs_info_set</span><span class="c">;</span> <span class="pc">x</span><span class="c">fs_infop</span><span class="w">-</span><span class="c">&gt;</span><span class="w">fl</span><span class="pc">ag;</span> <span class="pc">xfs_infop</span><span class="c">++) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="w">&amp;</span> <span class="c">xfs_infop-&gt;</span><span class="w">f</span><span class="pc">lag)</span>
			<span class="w">se</span><span class="pc">q_pu</span><span class="c">ts(</span><span class="w">m</span><span class="pc">,</span> <span class="c">xfs_infop</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">str</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="pc">x</span><span class="c">fs_infop</span> <span class="c">=</span> <span class="w">xfs_info_unset</span><span class="pc">;</span> <span class="c">xfs_infop-&gt;</span><span class="w">fl</span><span class="pc">ag;</span> <span class="pc">xfs_infop</span><span class="c">++) {</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="c">&amp;</span> <span class="c">xfs_infop-&gt;</span><span class="w">f</span><span class="pc">lag</span><span class="c">))</span>
			<span class="w">se</span><span class="pc">q_pu</span><span class="c">ts(</span><span class="pc">m,</span> <span class="c">xfs_infop</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">str</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="w">&amp;</span> <span class="w">XFS_MOUNT_DFLT_IOSIZE)</span>
		<span class="pc">s</span><span class="c">eq_printf(</span><span class="pc">m</span><span class="w">, ","</span> <span class="w">MNTOPT_ALLOCSIZE</span> <span class="w">"=%dk"</span><span class="c">,</span>
				<span class="c">(</span><span class="w">i</span><span class="c">nt</span><span class="pc">)(</span><span class="w">1</span> <span class="c">&lt;&lt;</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_writeio_log) &gt;</span><span class="c">&gt;</span> <span class="w">1</span><span class="pc">0);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logbufs</span> <span class="w">&gt;</span> <span class="pc">0</span><span class="c">)</span>
		<span class="pc">s</span><span class="c">eq_printf(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_LOGBUFS</span> <span class="w">"</span><span class="c">=%</span><span class="w">d"</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;m_logbufs</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logbsize</span> <span class="w">&gt;</span> <span class="c">0)</span>
		<span class="w">s</span><span class="c">eq_printf(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_LOGBSIZE</span> <span class="w">"</span><span class="c">=%</span><span class="w">dk"</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;m_logbsize</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">1</span><span class="pc">0</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logname</span><span class="pc">)</span>
		<span class="w">seq_show_option</span><span class="c">(</span><span class="w">m</span><span class="c">,</span> <span class="w">MNTOPT_LOGDEV</span><span class="c">,</span> <span class="w">mp</span><span class="c">-&gt;m_logname);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_rtname</span><span class="c">)</span>
		<span class="w">s</span><span class="pc">eq_s</span><span class="c">how_option(</span><span class="w">m</span><span class="pc">,</span> <span class="w">MNTOPT_RTDEV</span><span class="c">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_rtname);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_dalign</span> <span class="w">&gt;</span> <span class="pc">0</span><span class="c">)</span>
		<span class="w">s</span><span class="pc">eq_p</span><span class="c">rintf(</span><span class="pc">m</span><span class="w">, ","</span> <span class="w">MNTOPT_SUNIT</span> <span class="w">"=%d"</span><span class="pc">,</span>
				<span class="pc">(</span><span class="w">i</span><span class="c">nt)</span><span class="w">XFS_FSB_TO_BB</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_d</span><span class="c">align</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_swidth</span> <span class="w">&gt;</span> <span class="c">0)</span>
		<span class="pc">s</span><span class="c">eq_printf(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_SWIDTH</span> <span class="w">"</span><span class="c">=%</span><span class="w">d</span><span class="pc">"</span><span class="c">,</span>
				<span class="c">(</span><span class="w">i</span><span class="c">nt)</span><span class="pc">X</span><span class="c">FS_FSB_TO_BB(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_s</span><span class="c">width</span><span class="pc">))</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_qflags</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">XFS_UQUOTA_ACCT</span><span class="c">|</span><span class="w">XFS_UQUOTA_ENFD</span><span class="c">))</span>
		<span class="w">s</span><span class="pc">eq_pu</span><span class="c">ts(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_USRQUOTA)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_q</span><span class="c">flags</span> <span class="pc">&amp;</span> <span class="pc">X</span><span class="c">FS_UQUOTA_ACCT)</span>
		<span class="w">s</span><span class="pc">eq_pu</span><span class="c">ts(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_UQUOTANOENF</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_q</span><span class="c">flags</span> <span class="pc">&amp;</span> <span class="w">XFS_PQUOTA_ACCT</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_qflags</span> <span class="pc">&amp;</span> <span class="w">XFS_PQUOTA_ENFD</span><span class="c">)</span>
			<span class="w">s</span><span class="pc">eq_pu</span><span class="c">ts(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_PRJQUOTA)</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">se</span><span class="pc">q_pu</span><span class="c">ts(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_PQUOTANOENF)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_qflags</span> <span class="pc">&amp;</span> <span class="w">XFS_GQUOTA_ACCT</span><span class="c">) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_qflags</span> <span class="pc">&amp;</span> <span class="w">XFS_GQUOTA_ENFD</span><span class="c">)</span>
			<span class="w">s</span><span class="pc">eq_pu</span><span class="c">ts(m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_GRPQUOTA</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">else</span>
			<span class="w">se</span><span class="pc">q_pu</span><span class="c">ts(</span><span class="pc">m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_GQUOTANOENF)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_qflags</span> <span class="c">&amp;</span> <span class="w">XFS_ALL_QUOTA_ACCT</span><span class="pc">))</span>
		<span class="w">s</span><span class="pc">eq_pu</span><span class="c">ts(m</span><span class="w">, "</span><span class="pc">,</span><span class="c">"</span> <span class="w">MNTOPT_NOQUOTA</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>
<span class="w">__uint64_t</span>
<span class="w">xfs_max_file_offset</span><span class="c">(</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span>		<span class="w">blockshift</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span>		<span class="w">pagefactor</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span>		<span class="w">bitshift</span> <span class="pc">=</span> <span class="w">BITS_PER_LONG</span> <span class="w">-</span> <span class="c">1;</span>

	

<span class="w">#</span><span class="pc">if</span> <span class="w">B</span><span class="c">ITS_PER_LONG</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">3</span><span class="c">2</span>
<span class="w">#</span> <span class="pc">i</span><span class="c">f</span> <span class="c">defined(</span><span class="w">CONFIG_LBDAF</span><span class="c">)</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">sec</span><span class="c">tor_t</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="w">8);</span>
	<span class="w">p</span><span class="pc">a</span><span class="c">gefactor</span> <span class="c">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">;</span>
	<span class="pc">b</span><span class="c">itshift</span> <span class="c">=</span> <span class="pc">B</span><span class="c">ITS_PER_LONG;</span>
<span class="pc">#</span> <span class="pc">el</span><span class="c">se</span>
	<span class="pc">p</span><span class="c">agefactor</span> <span class="c">=</span> <span class="pc">P</span><span class="c">AGE_CACHE_SIZE</span> <span class="w">&gt;</span><span class="pc">&gt; </span><span class="c">(</span><span class="w">PAGE_CACHE_SHIFT</span> <span class="c">-</span> <span class="w">blockshift</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">#</span> <span class="c">endif</span>
<span class="c">#</span><span class="w">e</span><span class="pc">n</span><span class="c">dif</span>

	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">(</span><span class="pc">((</span><span class="w">__uint64_t</span><span class="pc">)p</span><span class="c">agefactor</span><span class="w">)</span><span class="pc"> </span><span class="c">&lt;&lt;</span> <span class="w">b</span><span class="c">itshift</span><span class="w">) </span><span class="pc">-</span> <span class="c">1;</span>
<span class="c">}</span>


<span class="w">xfs_agnumber_t</span>
<span class="w">xfs_set_inode32</span><span class="c">(struct</span> <span class="w">xfs_mount</span> <span class="c">*</span><span class="w">mp</span><span class="c">,</span> <span class="w">x</span><span class="c">fs_agnumber_t</span> <span class="w">agcount</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">x</span><span class="c">fs_agnumber_t</span>	<span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">x</span><span class="c">fs_agnumber_t</span>	<span class="w">maxagi</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">xfs_sb_t</span>	<span class="w">*sbp</span> <span class="pc">= &amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb</span><span class="c">;</span>
	<span class="w">x</span><span class="c">fs_agnumber_t</span>	<span class="w">max_metadata</span><span class="c">;</span>
	<span class="w">xfs_agino_t</span>	<span class="w">agino</span><span class="c">;</span>
	<span class="w">xfs_ino_t</span>	<span class="w">ino</span><span class="c">;</span>
	<span class="w">xfs_perag_t</span>	<span class="pc">*</span><span class="w">pag</span><span class="pc">;</span>

	
	<span class="c">if</span> <span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_maxicount</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">__uint64_t</span>	<span class="w">icount</span><span class="c">;</span>

		<span class="w">i</span><span class="pc">c</span><span class="c">ount</span> <span class="c">=</span> <span class="pc">s</span><span class="c">bp-&gt;</span><span class="w">sb_dblocks</span> <span class="pc">*</span> <span class="w">s</span><span class="pc">bp-</span><span class="c">&gt;</span><span class="w">sb_imax_pct</span><span class="c">;</span>
		<span class="w">do_div</span><span class="c">(</span><span class="w">i</span><span class="c">count,</span> <span class="w">1</span><span class="pc">0</span><span class="c">0);</span>
		<span class="w">i</span><span class="pc">c</span><span class="c">ount</span> <span class="w">+</span><span class="pc">=</span> <span class="pc">s</span><span class="c">bp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb_agblocks</span> <span class="w">-</span> <span class="pc">1</span><span class="c">;</span>
		<span class="w">d</span><span class="c">o_div</span><span class="pc">(</span><span class="c">icount,</span> <span class="pc">s</span><span class="c">bp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">sb_a</span><span class="c">gblocks</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">max_metadata</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">count</span><span class="pc">;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">m</span><span class="c">ax_metadata</span> <span class="c">=</span> <span class="w">agcount</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="w">agino</span> <span class="c">=</span>	<span class="w">XFS_OFFBNO_TO_AGINO</span><span class="c">(</span><span class="w">mp</span><span class="c">,</span> <span class="w">s</span><span class="pc">bp-</span><span class="c">&gt;sb_agblocks</span> <span class="w">-</span> <span class="pc">1,</span> <span class="pc">0</span><span class="c">);</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">&lt;</span> <span class="w">a</span><span class="pc">gc</span><span class="c">ount;</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex++) {</span>
		<span class="w">ino</span> <span class="c">=</span> <span class="w">XFS_AGINO_TO_INO</span><span class="c">(</span><span class="w">mp</span><span class="c">,</span> <span class="w">i</span><span class="c">ndex,</span> <span class="pc">a</span><span class="c">gino);</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">ino</span> <span class="c">&gt;</span> <span class="w">XFS_MAXINUMBER_32</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">pag</span> <span class="pc">=</span> <span class="w">xfs_perag_get</span><span class="c">(</span><span class="w">mp</span><span class="c">,</span> <span class="w">i</span><span class="c">ndex</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">p</span><span class="c">ag</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pagi_inodeok</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="pc">p</span><span class="c">ag-&gt;</span><span class="w">pagf_metadata</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="w">xfs_perag_put</span><span class="c">(pag</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>

		<span class="w">p</span><span class="c">ag</span> <span class="c">=</span> <span class="pc">x</span><span class="c">fs_perag_get(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">p</span><span class="c">ag</span><span class="pc">-</span><span class="c">&gt;pagi_inodeok</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">maxagi+</span><span class="c">+;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="c">ndex</span> <span class="c">&lt;</span> <span class="w">max_metadata</span><span class="pc">)</span>
			<span class="c">pag-&gt;pagf_metadata</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">x</span><span class="c">fs_perag_put</span><span class="pc">(</span><span class="c">pag</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">XFS_MOUNT_32BITINODES</span> <span class="pc">|</span>
			<span class="w">XFS_MOUNT_SMALL_INUMS</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">m</span><span class="pc">axa</span><span class="c">gi;</span>
<span class="c">}</span>

<span class="w">xfs_agnumber_t</span>
<span class="w">xfs_set_inode64</span><span class="c">(struct</span> <span class="w">xfs_mount</span> <span class="c">*</span><span class="w">mp</span><span class="c">,</span> <span class="w">x</span><span class="c">fs_agnumber_t</span> <span class="w">agcount</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">x</span><span class="pc">fs_a</span><span class="c">gnumber_t</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">in</span><span class="c">dex</span> <span class="c">&lt;</span> <span class="w">a</span><span class="c">gcount</span><span class="pc">;</span> <span class="pc">in</span><span class="c">dex++) {</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_perag</span>	<span class="c">*</span><span class="w">pag</span><span class="c">;</span>

		<span class="pc">p</span><span class="c">ag</span> <span class="c">=</span> <span class="w">xfs_perag_get</span><span class="c">(</span><span class="w">mp</span><span class="pc">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">p</span><span class="c">ag</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">pagi_inodeok</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="pc">p</span><span class="c">ag-&gt;</span><span class="w">pagf_metadata</span> <span class="c">=</span> <span class="c">0;</span>
		<span class="w">xfs_perag_put</span><span class="c">(pag</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="w">XFS_MOUNT_32BITINODES</span> <span class="c">|</span>
			 <span class="w">XFS_MOUNT_SMALL_INUMS</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">nt</span>
<span class="w">xfs_blkdev_get</span><span class="c">(</span>
	<span class="w">xfs_mount_t</span>		<span class="pc">*</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span>
	<span class="w">c</span><span class="c">onst</span> <span class="c">char</span>		<span class="c">*</span><span class="pc">n</span><span class="c">ame,</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">block_device</span>	<span class="pc">**</span><span class="w">bdevp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">*</span><span class="pc">b</span><span class="c">devp</span> <span class="c">=</span> <span class="w">blkdev_get_by_path</span><span class="pc">(</span><span class="w">n</span><span class="pc">a</span><span class="c">me</span><span class="pc">,</span> <span class="w">FMODE_READ|FMODE_WRITE</span><span class="pc">|</span><span class="w">FMODE_EXCL</span><span class="pc">,</span>
				    <span class="w">mp</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(IS_ERR</span><span class="pc">(*b</span><span class="c">devp</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="c">PTR_ERR</span><span class="pc">(*</span><span class="c">bdevp);</span>
		<span class="w">xfs_warn</span><span class="c">(</span><span class="w">mp</span><span class="pc">, "</span><span class="w">I</span><span class="c">nvalid</span> <span class="pc">d</span><span class="c">evice</span> <span class="w">[</span><span class="c">%</span><span class="pc">s</span><span class="w">]</span><span class="pc">,</span> <span class="w">e</span><span class="c">rror</span><span class="w">=</span><span class="c">%d</span><span class="pc">"</span><span class="c">,</span> <span class="c">name,</span> <span class="pc">e</span><span class="c">rror);</span>
	<span class="pc">}</span>

	<span class="c">return</span> <span class="pc">e</span><span class="c">rror;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_blkdev_put</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">block_device</span>	<span class="c">*</span><span class="w">b</span><span class="pc">dev</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">ev)</span>
		<span class="w">blkdev_put</span><span class="c">(</span><span class="w">bd</span><span class="pc">ev,</span> <span class="w">FMODE_READ|FMODE_WRITE</span><span class="pc">|</span><span class="w">FMODE_EXCL</span><span class="c">);</span>
<span class="pc">}</span>

<span class="pc">v</span><span class="c">oid</span>
<span class="w">xfs_blkdev_issue_flush</span><span class="c">(</span>
	<span class="w">xfs_buftarg_t</span>		<span class="c">*</span><span class="w">buftarg</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">blkdev_issue_flush</span><span class="c">(buftarg</span><span class="w">-</span><span class="c">&gt;</span><span class="w">bt_bdev</span><span class="c">,</span> <span class="w">GFP_NOFS</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL);</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_close_devices</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logdev_targp</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_logdev_targp</span> <span class="pc">!</span><span class="c">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_ddev_targp</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="c">truct</span> <span class="w">block_device</span> <span class="c">*</span><span class="w">logdev</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_logdev_targp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b</span><span class="pc">t</span><span class="c">_bdev;</span>
		<span class="w">xfs_free_buftarg</span><span class="c">(</span><span class="w">m</span><span class="c">p</span><span class="pc">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">_logdev_targp);</span>
		<span class="w">xfs_blkdev_put</span><span class="c">(logdev);</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_rtdev_targp</span><span class="c">) {</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="c">block_device</span> <span class="c">*</span><span class="w">rtdev</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">_r</span><span class="c">tdev_targp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">b</span><span class="c">t_bdev;</span>
		<span class="c">xfs_free_buftarg</span><span class="pc">(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">_r</span><span class="c">tdev_targp);</span>
		<span class="pc">x</span><span class="c">fs_blkdev_put</span><span class="pc">(</span><span class="c">rtdev</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">x</span><span class="pc">fs_f</span><span class="c">ree_buftarg</span><span class="pc">(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_ddev_targp</span><span class="c">);</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">nt</span>
<span class="w">xfs_open_devices</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">block_device</span>	<span class="c">*</span><span class="w">dd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="w">m</span><span class="c">p-&gt;</span><span class="w">m_super</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">s_bdev</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">b</span><span class="c">lock_device</span>	<span class="c">*</span><span class="w">logdev</span> <span class="pc">=</span> <span class="c">NULL</span><span class="pc">,</span><span class="c"> *</span><span class="pc">r</span><span class="c">tdev</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r</span><span class="pc">;</span>

	
	<span class="c">if</span> <span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logname</span><span class="c">) {</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_blkdev_get</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_logname</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">l</span><span class="c">ogdev);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror)</span>
			<span class="c">goto</span> <span class="c">out;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_rtname</span><span class="c">) {</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">x</span><span class="c">fs_blkdev_get</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_rtname</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">rtdev</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror)</span>
			<span class="c">goto</span> <span class="w">out_close_logdev</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">tdev</span> <span class="pc">=</span><span class="c">=</span> <span class="w">dd</span><span class="pc">e</span><span class="c">v</span> <span class="pc">|</span><span class="c">|</span> <span class="pc">r</span><span class="c">tdev</span> <span class="pc">=</span><span class="c">=</span> <span class="w">logdev</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span>
	<span class="pc">"</span><span class="w">C</span><span class="pc">a</span><span class="c">nnot</span> <span class="w">mount</span> <span class="w">filesystem</span> <span class="w">w</span><span class="c">ith</span> <span class="w">identical</span> <span class="w">r</span><span class="pc">t</span><span class="c">dev</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">dd</span><span class="pc">e</span><span class="c">v</span><span class="w">/l</span><span class="c">ogdev</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
			<span class="c">goto</span> <span class="w">out_close_rtdev</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	
	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="pc">= </span><span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>
	<span class="w">mp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m_ddev_targp</span> <span class="c">=</span> <span class="w">xfs_alloc_buftarg</span><span class="pc">(</span><span class="w">mp</span><span class="pc">,</span> <span class="w">dd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;m_ddev_targp</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_c</span><span class="c">lose_rtdev;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="c">tdev</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_rtdev_targp</span> <span class="c">=</span> <span class="w">x</span><span class="c">fs_alloc_buftarg</span><span class="pc">(</span><span class="w">m</span><span class="pc">p,</span> <span class="c">rtdev);</span>
		<span class="c">if</span> <span class="pc">(!mp</span><span class="c">-&gt;m_rtdev_targp)</span>
			<span class="c">goto</span> <span class="w">out_free_ddev_targ</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">logdev</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="pc">l</span><span class="c">ogdev</span> <span class="pc">!</span><span class="c">=</span> <span class="w">dd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_logdev_targp</span> <span class="c">=</span> <span class="c">xfs_alloc_buftarg</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span> <span class="c">logdev);</span>
		<span class="c">if</span> <span class="pc">(!mp</span><span class="c">-&gt;m_logdev_targp</span><span class="pc">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">out_free_rtdev_targ</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_l</span><span class="c">ogdev_targp</span> <span class="c">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_ddev_targp</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>

 <span class="w">o</span><span class="c">ut_free_rtdev_targ:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_rtdev_targp</span><span class="pc">)</span>
		<span class="w">xfs_free_buftarg</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_rtdev_targp);</span>
 <span class="w">out_free_ddev_targ</span><span class="pc">:</span>
	<span class="w">x</span><span class="c">fs_free_buftarg</span><span class="pc">(</span><span class="c">mp</span><span class="pc">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_d</span><span class="c">dev_targp</span><span class="pc">)</span><span class="c">;</span>
 <span class="w">out_close_rtdev</span><span class="pc">:</span>
	<span class="w">xfs_blkdev_put</span><span class="c">(</span><span class="w">rtdev</span><span class="c">);</span>
 <span class="w">out_close_logdev</span><span class="c">:</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">logdev</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">l</span><span class="c">ogdev</span> <span class="pc">!</span><span class="c">=</span> <span class="w">dd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
		<span class="w">x</span><span class="pc">fs_b</span><span class="c">lkdev_put(</span><span class="pc">l</span><span class="c">ogdev</span><span class="pc">)</span><span class="c">;</span>
 <span class="w">o</span><span class="pc">ut</span><span class="c">:</span>
	<span class="c">return</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">nt</span>
<span class="w">xfs_setup_devices</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>

	<span class="w">e</span><span class="c">rror</span> <span class="c">=</span> <span class="w">xfs_setsize_buftarg</span><span class="c">(</span><span class="w">mp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m_ddev_targp</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_sb</span><span class="pc">.</span><span class="w">sb_sectsize</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">e</span><span class="c">rror;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_logdev_targp</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">mp</span><span class="c">-&gt;m_logdev_targp</span> <span class="pc">!</span><span class="c">=</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_d</span><span class="c">dev_targp) {</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span>	<span class="w">log_sector_size</span> <span class="c">=</span> <span class="w">BBSIZE</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">xfs_sb_version_hassector</span><span class="pc">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_sb</span><span class="pc">)</span><span class="c">)</span>
			<span class="pc">l</span><span class="c">og_sector_size</span> <span class="c">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_sb</span><span class="w">.sb_logsectsize</span><span class="c">;</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_setsize_buftarg</span><span class="c">(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="pc">m_l</span><span class="c">ogdev_targp</span><span class="pc">,</span>
					    <span class="c">log_sector_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rror;</span>
	<span class="pc">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_rtdev_targp</span><span class="c">) {</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="pc">x</span><span class="c">fs_setsize_buftarg(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;m_rtdev_targp</span><span class="pc">,</span>
					    <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_s</span><span class="c">b</span><span class="pc">.</span><span class="w">sb_sectsize</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(error)</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rror;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">nt</span>
<span class="w">xfs_init_mount_workqueues</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_buf_workqueue</span> <span class="c">=</span> <span class="w">alloc_workqueue(</span><span class="pc">"</span><span class="w">xfs</span><span class="pc">-</span><span class="w">buf/</span><span class="pc">%s</span><span class="c">",</span>
			<span class="w">WQ_MEM_RECLAIM|WQ_FREEZABLE</span><span class="pc">,</span> <span class="w">1</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_fsname</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_buf_workqueue</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>

	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_data_workqueue</span> <span class="c">=</span> <span class="w">a</span><span class="c">lloc_workqueue</span><span class="w">(</span><span class="pc">"</span><span class="w">x</span><span class="c">fs</span><span class="pc">-</span><span class="w">da</span><span class="c">ta</span><span class="w">/</span><span class="pc">%s</span><span class="c">",</span>
			<span class="w">W</span><span class="pc">Q_M</span><span class="c">EM_RECLAIM</span><span class="w">|</span><span class="c">WQ_FREEZABLE</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_f</span><span class="c">sname);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_d</span><span class="c">ata_workqueue</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">out_destroy_buf</span><span class="c">;</span>

	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_unwritten_workqueue</span> <span class="c">=</span> <span class="w">a</span><span class="c">lloc_workqueue</span><span class="w">(</span><span class="pc">"</span><span class="w">x</span><span class="c">fs</span><span class="pc">-</span><span class="w">conv/</span><span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">W</span><span class="pc">Q_M</span><span class="c">EM_RECLAIM</span><span class="w">|</span><span class="c">WQ_FREEZABLE</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_f</span><span class="c">sname</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="c">p-&gt;</span><span class="pc">m_u</span><span class="c">nwritten_workqueue</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">out_destroy_data_iodone_queue</span><span class="c">;</span>

	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_cil_workqueue</span> <span class="c">=</span> <span class="w">a</span><span class="c">lloc_workqueue</span><span class="w">(</span><span class="pc">"</span><span class="w">x</span><span class="c">fs</span><span class="pc">-</span><span class="w">cil/</span><span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">W</span><span class="pc">Q_M</span><span class="c">EM_RECLAIM</span><span class="w">|</span><span class="c">WQ_FREEZABLE</span><span class="pc">,</span> <span class="pc">0,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_f</span><span class="c">sname</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="c">p-&gt;</span><span class="pc">m_c</span><span class="c">il_workqueue</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">out_destroy_unwritten</span><span class="c">;</span>

	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_reclaim_workqueue</span> <span class="c">=</span> <span class="w">a</span><span class="c">lloc_workqueue</span><span class="w">(</span><span class="pc">"</span><span class="w">x</span><span class="c">fs</span><span class="pc">-</span><span class="w">reclaim/</span><span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span>
			<span class="c">WQ_FREEZABLE</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_f</span><span class="c">sname);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_r</span><span class="c">eclaim_workqueue</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">out_destroy_cil</span><span class="c">;</span>

	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_log_workqueue</span> <span class="c">=</span> <span class="w">a</span><span class="c">lloc_workqueue</span><span class="w">(</span><span class="pc">"x</span><span class="c">fs</span><span class="pc">-</span><span class="w">lo</span><span class="pc">g</span><span class="w">/</span><span class="pc">%</span><span class="c">s",</span>
			<span class="c">WQ_FREEZABLE</span><span class="w">|WQ_HIGHPRI</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">_f</span><span class="c">sname);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="c">p-&gt;</span><span class="pc">m_l</span><span class="c">og_workqueue</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">out_destroy_reclaim</span><span class="c">;</span>

	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_eofblocks_workqueue</span> <span class="c">=</span> <span class="w">a</span><span class="c">lloc_workqueue</span><span class="w">(</span><span class="pc">"</span><span class="w">x</span><span class="c">fs</span><span class="pc">-</span><span class="w">eofblocks/</span><span class="pc">%</span><span class="c">s</span><span class="pc">"</span><span class="c">,</span>
			<span class="w">W</span><span class="pc">Q_F</span><span class="c">REEZABLE</span><span class="pc">,</span> <span class="w">0</span><span class="pc">,</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_f</span><span class="c">sname);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_e</span><span class="c">ofblocks_workqueue</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">out_destroy_log</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>

<span class="pc">o</span><span class="c">ut_destroy_log:</span>
	<span class="w">destroy_workqueue</span><span class="c">(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">m_log_workqueue</span><span class="c">);</span>
<span class="w">out_destroy_reclaim</span><span class="pc">:</span>
	<span class="w">d</span><span class="c">estroy_workqueue(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_reclaim_workqueue</span><span class="c">);</span>
<span class="w">out_destroy_cil</span><span class="c">:</span>
	<span class="pc">d</span><span class="c">estroy_workqueue(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_cil_workqueue</span><span class="c">);</span>
<span class="w">out_destroy_unwritten</span><span class="c">:</span>
	<span class="pc">d</span><span class="c">estroy_workqueue(</span><span class="w">m</span><span class="c">p</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m_unwritten_workqueue</span><span class="c">);</span>
<span class="w">out_destroy_data_iodone_queue</span><span class="c">:</span>
	<span class="c">destroy_workqueue(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">m_data_workqueue</span><span class="c">);</span>
<span class="w">out_destroy_buf</span><span class="c">:</span>
	<span class="pc">d</span><span class="c">estroy_workqueue(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">m_buf_workqueue</span><span class="c">);</span>
<span class="w">out</span><span class="c">:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-EN</span><span class="c">OMEM;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_destroy_mount_workqueues</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">d</span><span class="c">estroy_workqueue</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_eofblocks_workqueue</span><span class="c">);</span>
	<span class="w">d</span><span class="c">estroy_workqueue</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_log_workqueue</span><span class="c">);</span>
	<span class="pc">d</span><span class="c">estroy_workqueue</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_reclaim_workqueue</span><span class="c">);</span>
	<span class="c">destroy_workqueue(</span><span class="pc">mp</span><span class="c">-&gt;</span><span class="w">m_cil_workqueue</span><span class="c">);</span>
	<span class="pc">d</span><span class="c">estroy_workqueue(</span><span class="w">m</span><span class="c">p-&gt;</span><span class="w">m_data_workqueue</span><span class="c">);</span>
	<span class="pc">d</span><span class="c">estroy_workqueue(</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_unwritten_workqueue</span><span class="c">);</span>
	<span class="c">destroy_workqueue(</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_buf_workqueue</span><span class="c">);</span>
<span class="pc">}</span>


<span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_flush_inodes</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="pc">p</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="w">s</span><span class="pc">b</span> <span class="c">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_super</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">down_read_trylock</span><span class="pc">(&amp;</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_umount</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">sync_inodes_sb</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>
		<span class="w">up_read</span><span class="pc">(&amp;</span><span class="w">sb</span><span class="c">-&gt;s_umount);</span>
	<span class="pc">}</span>
<span class="pc">}</span>


<span class="w">STATIC</span> <span class="w">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span> <span class="c">*</span>
<span class="w">xfs_fs_alloc_inode</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">B</span><span class="pc">UG</span><span class="c">();</span>
	<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>
<span class="c">}</span>


<span class="w">S</span><span class="c">TATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_fs_destroy_inode</span><span class="c">(</span>
	<span class="c">struct</span> <span class="c">inode</span>		<span class="c">*inode)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(inode);</span>

	<span class="w">trace_xfs_destroy_inode</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">);</span>

	<span class="w">XFS_STATS_INC</span><span class="c">(</span><span class="w">vn_reclaim</span><span class="c">);</span>

	<span class="w">A</span><span class="c">SSERT(</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">i_mount) |</span><span class="c">|</span> <span class="w">i</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">i_delayed_blks</span> <span class="w">=</span><span class="c">=</span> <span class="c">0</span><span class="w">)</span><span class="pc">;</span>

	
	<span class="w">ASSERT_ALWAYS(!xfs_iflags_test</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">,</span> <span class="w">XFS_IRECLAIMABLE)</span><span class="pc">);</span>
	<span class="pc">A</span><span class="c">SSERT_ALWAYS</span><span class="w">(!x</span><span class="c">fs_iflags_test</span><span class="pc">(</span><span class="w">i</span><span class="pc">p</span><span class="c">,</span> <span class="w">XFS_IRECLAIM</span><span class="pc">))</span><span class="c">;</span>

	
	<span class="w">xfs_inode_set_reclaim_tag</span><span class="c">(</span><span class="w">i</span><span class="c">p);</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_fs_inode_init_once</span><span class="c">(</span>
	<span class="pc">v</span><span class="c">oid</span>			<span class="pc">*</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="c">=</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">e</span><span class="c">mset(</span><span class="w">i</span><span class="pc">p</span><span class="c">,</span> <span class="pc">0</span><span class="c">,</span> <span class="c">sizeof(struct</span> <span class="c">xfs_inode));</span>

	
	<span class="w">inode_init_once</span><span class="c">(</span><span class="w">VFS_I</span><span class="pc">(</span><span class="w">i</span><span class="pc">p))</span><span class="c">;</span>

	
	<span class="w">a</span><span class="c">tomic_set(&amp;</span><span class="w">i</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">i_pincount</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="w">s</span><span class="pc">pin_l</span><span class="c">ock_init(&amp;</span><span class="w">i</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">i_flags_lock</span><span class="c">);</span>

	<span class="w">mrlock_init</span><span class="pc">(&amp;</span><span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_mmaplock</span><span class="pc">,</span> <span class="w">MRLOCK_ALLOW_EQUAL_PRI|MRLOCK_BARRIER</span><span class="pc">,</span>
		     <span class="w">"xfsino</span><span class="c">",</span> <span class="w">i</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">i_i</span><span class="c">no</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">r</span><span class="c">lock_init</span><span class="pc">(&amp;</span><span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_lock</span><span class="pc">,</span> <span class="w">M</span><span class="c">RLOCK_ALLOW_EQUAL_PRI</span><span class="w">|</span><span class="pc">M</span><span class="c">RLOCK_BARRIER</span><span class="pc">,</span>
		     <span class="w">"</span><span class="c">xfsino</span><span class="pc">"</span><span class="c">,</span> <span class="w">i</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">i_i</span><span class="c">no</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_fs_evict_inode</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">xfs_inode_t</span>		<span class="pc">*</span><span class="w">i</span><span class="pc">p</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(inode</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">A</span><span class="c">SSERT</span><span class="w">(!rwsem_is_locked</span><span class="pc">(&amp;</span><span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_iolock.mr_lock</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">trace_xfs_evict_inode</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">);</span>

	<span class="w">truncate_inode_pages_final</span><span class="pc">(&amp;</span><span class="c">inode-&gt;</span><span class="w">i_data</span><span class="c">);</span>
	<span class="w">clear_inode</span><span class="c">(inode</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">XFS_STATS_INC</span><span class="c">(</span><span class="w">vn_rele</span><span class="c">);</span>
	<span class="w">X</span><span class="pc">FS_S</span><span class="c">TATS_INC(</span><span class="w">vn_remove</span><span class="c">);</span>

	<span class="w">xfs_inactive</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">);</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_fs_drop_inode</span><span class="c">(</span>
	<span class="c">struct</span> <span class="c">inode</span>		<span class="c">*inode</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">i</span><span class="pc">p</span> <span class="pc">=</span> <span class="w">XFS_I</span><span class="c">(inode);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">generic_drop_inode</span><span class="c">(inode</span><span class="w">) |</span><span class="pc">| </span><span class="c">(</span><span class="w">i</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">i_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_IDONTCACHE</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">vo</span><span class="c">id</span>
<span class="w">xfs_free_fsname</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">m_fsname</span><span class="c">);</span>
	<span class="c">kfree(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">m_rtname</span><span class="c">);</span>
	<span class="c">kfree(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">m_logname</span><span class="c">);</span>
<span class="pc">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">int</span>
<span class="w">xfs_fs_sync_fs</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">s</span><span class="pc">u</span><span class="c">per_block</span>	<span class="c">*sb,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">w</span><span class="pc">a</span><span class="c">it)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="pc">p</span> <span class="c">=</span> <span class="w">XFS_M</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">wa</span><span class="pc">i</span><span class="c">t)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">xfs_log_force</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">XFS_LOG_SYNC</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">laptop_mode</span><span class="pc">)</span><span class="c"> {</span>
		
		<span class="w">flush_delayed_work</span><span class="pc">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_log-</span><span class="c">&gt;</span><span class="w">l_work</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_fs_statfs</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span>		<span class="c">*</span><span class="w">d</span><span class="pc">en</span><span class="c">try,</span>
	<span class="c">struct</span> <span class="w">kstatfs</span>		<span class="c">*</span><span class="w">statp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="pc">p</span> <span class="pc">=</span> <span class="w">XFS_M</span><span class="c">(</span><span class="w">de</span><span class="pc">n</span><span class="c">try</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d_sb</span><span class="c">);</span>
	<span class="w">xfs_sb_t</span>		<span class="w">*sbp</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="pc">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="w">d_</span><span class="pc">i</span><span class="c">node(</span><span class="w">d</span><span class="pc">e</span><span class="c">ntry));</span>
	<span class="w">__uint64_t</span>		<span class="w">fakeinos,</span> <span class="w">id;</span>
	<span class="w">_</span><span class="pc">_ui</span><span class="c">nt64_t</span>		<span class="w">icount</span><span class="c">;</span>
	<span class="w">_</span><span class="c">_uint64_t</span>		<span class="w">ifree</span><span class="c">;</span>
	<span class="w">_</span><span class="pc">_ui</span><span class="c">nt64_t</span>		<span class="w">fdblocks</span><span class="c">;</span>
	<span class="w">xfs_extlen_t</span>		<span class="w">lsize</span><span class="c">;</span>
	<span class="w">__int64_t</span>		<span class="w">ffree</span><span class="c">;</span>

	<span class="w">statp-</span><span class="pc">&gt;</span><span class="w">f_type</span> <span class="c">=</span> <span class="w">XFS_SB_MAGIC</span><span class="c">;</span>
	<span class="c">statp-&gt;</span><span class="w">f_namelen</span> <span class="c">=</span> <span class="w">MAXNAMELEN</span> <span class="w">-</span> <span class="c">1;</span>

	<span class="w">id</span> <span class="c">=</span> <span class="w">huge_encode_dev</span><span class="c">(</span><span class="w">mp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m_ddev_targp-</span><span class="c">&gt;</span><span class="w">bt_dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">tatp-&gt;</span><span class="w">f_fsid</span><span class="pc">.</span><span class="w">va</span><span class="pc">l</span><span class="w">[</span><span class="c">0</span><span class="w">] =</span><span class="pc"> </span><span class="c">(</span><span class="w">u</span><span class="pc">3</span><span class="c">2)</span><span class="w">id</span><span class="pc">;</span>
	<span class="c">statp-&gt;f_fsid</span><span class="pc">.</span><span class="w">v</span><span class="pc">al[1</span><span class="w">] </span><span class="pc">= </span><span class="c">(</span><span class="pc">u</span><span class="c">32</span><span class="pc">)(</span><span class="w">i</span><span class="pc">d</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">3</span><span class="pc">2</span><span class="c">);</span>

	<span class="w">icount</span> <span class="pc">=</span> <span class="w">percpu_counter_sum</span><span class="pc">(&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_icount</span><span class="c">);</span>
	<span class="w">ifree</span> <span class="pc">=</span> <span class="w">p</span><span class="c">ercpu_counter_sum</span><span class="w">(</span><span class="pc">&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_ifree</span><span class="c">);</span>
	<span class="w">fdblocks</span> <span class="pc">=</span> <span class="pc">p</span><span class="c">ercpu_counter_sum</span><span class="pc">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_fdblocks</span><span class="c">);</span>

	<span class="w">spin_l</span><span class="pc">ock</span><span class="c">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb_lock</span><span class="c">);</span>
	<span class="w">statp-</span><span class="c">&gt;</span><span class="w">f_bsize</span> <span class="c">=</span> <span class="w">sbp-</span><span class="c">&gt;</span><span class="w">sb_blocksize</span><span class="c">;</span>
	<span class="w">lsize</span> <span class="pc">=</span> <span class="pc">sb</span><span class="c">p-&gt;</span><span class="w">sb_logstart</span> <span class="w">?</span> <span class="pc">sb</span><span class="c">p-&gt;</span><span class="w">sb_logblocks</span> <span class="pc">:</span> <span class="pc">0;</span>
	<span class="pc">s</span><span class="c">tatp-&gt;</span><span class="w">f_blocks</span> <span class="c">=</span> <span class="pc">s</span><span class="c">bp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb_dblocks</span> <span class="w">-</span> <span class="pc">l</span><span class="c">size;</span>
	<span class="w">sp</span><span class="pc">in_unlock</span><span class="c">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_sb_lock);</span>

	<span class="pc">s</span><span class="c">tatp-&gt;</span><span class="w">f_bfree</span> <span class="c">=</span> <span class="w">fdblocks</span> <span class="w">-</span> <span class="w">XFS_ALLOC_SET_ASIDE</span><span class="pc">(</span><span class="w">mp</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">tatp-&gt;</span><span class="w">f_bavail</span> <span class="c">=</span> <span class="pc">s</span><span class="c">tatp-&gt;</span><span class="pc">f_bf</span><span class="c">ree;</span>

	<span class="w">fakeinos</span> <span class="pc">=</span> <span class="c">statp-&gt;f_bfree</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="pc">sb</span><span class="c">p-&gt;</span><span class="w">sb_inopblog</span><span class="c">;</span>
	<span class="c">statp-&gt;</span><span class="w">f_files</span> <span class="c">=</span> <span class="w">MIN</span><span class="pc">(</span><span class="w">icount</span> <span class="w">+</span> <span class="w">f</span><span class="pc">a</span><span class="c">keinos</span><span class="w">,</span><span class="pc"> (</span><span class="w">__uint64_t)XFS_MAXINUMBER</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_maxicount</span><span class="pc">)</span>
		<span class="c">statp-&gt;</span><span class="pc">f_f</span><span class="c">iles</span> <span class="c">=</span> <span class="w">m</span><span class="pc">i</span><span class="c">n_t(</span><span class="w">typeof(</span><span class="c">statp</span><span class="pc">-</span><span class="c">&gt;f_files</span><span class="pc">)</span><span class="c">,</span>
					<span class="w">s</span><span class="pc">t</span><span class="c">atp-&gt;f_files</span><span class="pc">,</span>
					<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_maxicount);</span>

	
	<span class="pc">s</span><span class="c">tatp-&gt;f_files</span> <span class="c">=</span> <span class="w">max_t</span><span class="pc">(t</span><span class="c">ypeof</span><span class="w">(</span><span class="c">statp-&gt;f_files</span><span class="pc">),</span>
					<span class="c">statp</span><span class="pc">-</span><span class="c">&gt;f_files</span><span class="pc">,</span>
					<span class="w">sbp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb_icount</span><span class="c">);</span>

	
	<span class="w">ffree</span> <span class="pc">=</span> <span class="pc">s</span><span class="c">tatp-&gt;f_files</span> <span class="w">-</span><span class="pc"> </span><span class="c">(</span><span class="w">icount</span> <span class="w">-</span> <span class="w">ifree</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">tatp-&gt;</span><span class="w">f_ffree</span> <span class="c">=</span> <span class="pc">m</span><span class="c">ax_t</span><span class="pc">(</span><span class="w">__int64_t</span><span class="c">,</span> <span class="pc">ff</span><span class="c">ree</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>


	<span class="c">if</span> <span class="pc">((</span><span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_d.di_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_DIFLAG_PROJINHERIT</span><span class="c">) &amp;&amp;</span>
	    <span class="pc">((</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_qflags</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">XFS_PQUOTA_ACCT</span><span class="c">|</span><span class="w">XFS_PQUOTA_ENFD))) ==</span>
			      <span class="c">(</span><span class="w">X</span><span class="c">FS_PQUOTA_ACCT</span><span class="w">|X</span><span class="pc">FS_PQUOTA_E</span><span class="c">NFD</span><span class="pc">))</span>
		<span class="w">xfs_qm_statvfs</span><span class="c">(</span><span class="w">ip</span><span class="pc">,</span> <span class="pc">s</span><span class="c">tatp</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_save_resvblks</span><span class="c">(struct</span> <span class="w">xfs_mount</span> <span class="c">*</span><span class="w">mp</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">__uint64_t</span> <span class="w">resblks</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_resblks_save</span> <span class="c">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_resblks</span><span class="c">;</span>
	<span class="w">xfs_reserve_blocks</span><span class="c">(</span><span class="pc">m</span><span class="c">p</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">r</span><span class="c">esblks</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL);</span>
<span class="pc">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_restore_resvblks</span><span class="c">(struct</span> <span class="c">xfs_mount</span> <span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">_</span><span class="c">_uint64_t</span> <span class="pc">r</span><span class="c">esblks</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">p-&gt;m_resblks_save</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">r</span><span class="pc">es</span><span class="c">blks</span> <span class="pc">=</span> <span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m</span><span class="pc">_resblks_</span><span class="c">save;</span>
		<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_resblks_save</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">}</span> <span class="c">else</span>
		<span class="pc">r</span><span class="c">esblks</span> <span class="pc">=</span> <span class="w">xfs_default_resblks</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>

	<span class="w">xfs_reserve_blocks</span><span class="c">(</span><span class="w">m</span><span class="pc">p, </span><span class="c">&amp;resblks</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL);</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span>
<span class="w">xfs_quiesce_attr</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="pc">p</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span>	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">a</span><span class="c">tomic_read(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_active_trans) &gt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">del</span><span class="c">ay</span><span class="w">(1</span><span class="pc">00</span><span class="c">);</span>

	
	<span class="w">xfs_log_force</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">XFS_LOG_SYNC</span><span class="c">);</span>

	
	<span class="w">xfs_reclaim_inodes</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="c">0);</span>
	<span class="w">x</span><span class="pc">fs_r</span><span class="c">eclaim_inodes(</span><span class="w">m</span><span class="c">p,</span> <span class="w">SYNC_WAIT</span><span class="c">);</span>

	
	<span class="w">e</span><span class="c">rror</span> <span class="c">=</span> <span class="w">xfs_log_sbcount</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror)</span>
		<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p, </span><span class="c">"</span><span class="w">xfs_attr_quiesce:</span> <span class="pc">f</span><span class="c">ailed</span> <span class="pc">t</span><span class="c">o</span> <span class="w">lo</span><span class="pc">g</span> <span class="w">sb</span> <span class="w">changes. "</span>
				<span class="pc">"</span><span class="w">Frozen</span> <span class="w">im</span><span class="c">age</span> <span class="w">may</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="pc">b</span><span class="c">e</span> <span class="w">consistent.</span><span class="pc">"</span><span class="c">);</span>
	
	<span class="w">W</span><span class="c">ARN_ON(</span><span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_active_trans) </span><span class="pc">!</span><span class="c">=</span> <span class="c">0</span><span class="pc">);</span>

	<span class="w">xfs_log_quiesce</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_fs_remount</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="c">*</span><span class="w">fl</span><span class="pc">ags,</span>
	<span class="w">c</span><span class="c">har</span>			<span class="c">*</span><span class="w">o</span><span class="pc">p</span><span class="c">tions</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="pc">p</span> <span class="c">=</span> <span class="w">XFS_M</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>
	<span class="w">xfs_sb_t</span>		<span class="w">*sbp</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb</span><span class="c">;</span>
	<span class="w">substring_t</span>		<span class="w">a</span><span class="c">rgs[</span><span class="w">MAX_OPT_ARGS</span><span class="c">];</span>
	<span class="w">c</span><span class="c">har</span>			<span class="c">*</span><span class="pc">p</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>

	<span class="w">sync_filesystem</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="pc">((</span><span class="w">p</span> <span class="c">=</span> <span class="w">strsep</span><span class="pc">(&amp;</span><span class="w">op</span><span class="pc">ti</span><span class="c">ons</span><span class="w">, ",")) !=</span> <span class="w">N</span><span class="c">ULL</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">to</span><span class="pc">k</span><span class="c">en;</span>

		<span class="c">if</span> <span class="w">(!*</span><span class="pc">p</span><span class="w">)</span>
			<span class="pc">c</span><span class="c">ontinue;</span>

		<span class="w">to</span><span class="pc">k</span><span class="c">en</span> <span class="c">=</span> <span class="w">match_token</span><span class="c">(p</span><span class="pc">,</span> <span class="w">tokens</span><span class="c">,</span> <span class="w">a</span><span class="pc">rgs</span><span class="c">);</span>
		<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">to</span><span class="pc">ken</span><span class="c">) {</span>
		<span class="c">case</span> <span class="w">Opt_barrier</span><span class="c">:</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_BARRIER</span><span class="c">;</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="w">Opt_nobarrier</span><span class="c">:</span>
			<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~XFS_MOUNT_BARRIER;</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="w">Opt_inode64</span><span class="c">:</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_maxagi</span> <span class="c">=</span> <span class="w">xfs_set_inode64</span><span class="pc">(</span><span class="w">mp</span><span class="pc">,</span> <span class="w">sbp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sb_agcount</span><span class="c">);</span>
			<span class="c">break;</span>
		<span class="c">case</span> <span class="w">Opt_inode32</span><span class="c">:</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_m</span><span class="c">axagi</span> <span class="c">=</span> <span class="w">xfs_set_inode32</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span> <span class="c">sbp</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">b_agcount);</span>
			<span class="c">break;</span>
		<span class="pc">d</span><span class="c">efault:</span>
			
<span class="w">#i</span><span class="pc">f</span> <span class="w">0</span>
			<span class="w">xfs_info</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span>
		<span class="pc">"</span><span class="w">mount</span> <span class="w">op</span><span class="pc">ti</span><span class="c">on</span> <span class="w">\"%s\"</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="c">supported</span> <span class="w">f</span><span class="c">or</span> <span class="w">remount"</span><span class="pc">,</span> <span class="w">p</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-</span><span class="pc">EI</span><span class="c">NVAL;</span>
<span class="w">#</span><span class="pc">el</span><span class="c">se</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>
<span class="pc">#</span><span class="c">endif</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	
	<span class="pc">if</span> <span class="pc">((</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="c">&amp;</span> <span class="w">XFS_MOUNT_RDONLY) &amp;&amp; !(*f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_MOUNT_NORECOVERY</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span>
		<span class="pc">"</span><span class="w">ro-</span><span class="pc">&gt;</span><span class="w">rw</span> <span class="w">transition</span> <span class="w">prohibited</span> <span class="w">o</span><span class="pc">n</span> <span class="w">norecovery</span> <span class="w">mount"</span><span class="pc">);</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
		<span class="c">}</span>

		<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">X</span><span class="pc">FS_MOUNT_R</span><span class="c">DONLY;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_update_sb</span><span class="c">) {</span>
			<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_sync_sb</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span> <span class="w">f</span><span class="pc">a</span><span class="c">lse);</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_warn</span><span class="c">(</span><span class="w">mp</span><span class="pc">, </span><span class="c">"</span><span class="pc">f</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">w</span><span class="c">rite</span> <span class="w">sb</span> <span class="w">changes"</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">return</span> <span class="pc">erro</span><span class="c">r;</span>
			<span class="c">}</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m_u</span><span class="c">pdate_sb</span> <span class="c">=</span> <span class="w">f</span><span class="c">alse;</span>
		<span class="c">}</span>

		
		<span class="w">xfs_restore_resvblks</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
		<span class="w">xfs_log_work_queue</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
	<span class="pc">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="c">&amp;</span> <span class="w">XFS_MOUNT_RDONLY) &amp;&amp; (*f</span><span class="c">lags</span> <span class="c">&amp;</span> <span class="w">MS_RDONLY</span><span class="c">)) {</span>
		
		<span class="w">xfs_save_resvblks</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
		<span class="w">xfs_quiesce_attr</span><span class="c">(</span><span class="w">m</span><span class="pc">p)</span><span class="c">;</span>
		<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">X</span><span class="c">FS_MOUNT_RDONLY;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_fs_freeze</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="c">p</span> <span class="c">=</span> <span class="w">XFS_M</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>

	<span class="w">x</span><span class="c">fs_save_resvblks</span><span class="pc">(mp</span><span class="c">);</span>
	<span class="w">x</span><span class="pc">fs_q</span><span class="c">uiesce_attr(</span><span class="w">m</span><span class="c">p);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">xfs_sync_sb</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">tr</span><span class="c">ue);</span>
<span class="c">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_fs_unfreeze</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="c">p</span> <span class="c">=</span> <span class="pc">X</span><span class="c">FS_M(</span><span class="w">sb</span><span class="c">);</span>

	<span class="w">xfs_restore_resvblks</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
	<span class="w">xfs_log_work_queue</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_fs_show_options</span><span class="c">(</span>
	<span class="c">struct</span> <span class="pc">s</span><span class="c">eq_file</span>		<span class="c">*</span><span class="pc">m</span><span class="c">,</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">d</span><span class="pc">en</span><span class="c">try</span>		<span class="c">*</span><span class="w">r</span><span class="pc">o</span><span class="c">ot</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">xfs_showargs</span><span class="c">(</span><span class="w">X</span><span class="c">FS_M</span><span class="pc">(</span><span class="w">r</span><span class="c">oot</span><span class="w">-</span><span class="c">&gt;</span><span class="w">d_sb)</span><span class="pc">,</span> <span class="w">m</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="w">S</span><span class="c">TATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_finish_flags</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">ronly</span> <span class="pc">= </span><span class="c">(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_MOUNT_RDONLY</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">xfs_sb_version_haslogv2</span><span class="pc">(&amp;</span><span class="w">m</span><span class="c">p-&gt;</span><span class="w">m_sb</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="c">p-&gt;</span><span class="w">m_logbsize</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
		    <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_s</span><span class="c">b.</span><span class="w">sb_logsunit</span> <span class="w">&gt;</span> <span class="w">XLOG_BIG_RECORD_BSIZE</span><span class="c">) {</span>
			<span class="w">m</span><span class="c">p-&gt;</span><span class="pc">m_l</span><span class="c">ogbsize</span> <span class="pc">=</span> <span class="w">m</span><span class="c">p-&gt;m_sb</span><span class="pc">.s</span><span class="c">b_logsunit;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_logbsize</span> <span class="w">&gt;</span> <span class="pc">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
			   <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_l</span><span class="c">ogbsize</span> <span class="w">&lt;</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_sb.</span><span class="pc">s</span><span class="c">b_logsunit</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">xfs_warn</span><span class="c">(</span><span class="pc">m</span><span class="c">p</span><span class="pc">,</span>
		<span class="w">"logbuf</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">must</span> <span class="w">be</span> <span class="w">greater</span> <span class="w">than</span> <span class="w">o</span><span class="pc">r</span> <span class="w">equal</span> <span class="w">t</span><span class="c">o</span> <span class="w">lo</span><span class="pc">g</span> <span class="w">stripe</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">mp</span><span class="c">-&gt;m_logbsize</span> <span class="w">&gt;</span> <span class="w">XLOG_BIG_RECORD_BSIZE</span><span class="c">) {</span>
			<span class="w">x</span><span class="c">fs_warn</span><span class="pc">(</span><span class="w">mp</span><span class="c">,</span>
		<span class="w">"</span><span class="c">logbuf</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">f</span><span class="c">or</span> <span class="w">ve</span><span class="pc">rs</span><span class="c">ion</span> <span class="w">1</span> <span class="w">logs</span> <span class="w">m</span><span class="pc">u</span><span class="c">st</span> <span class="w">b</span><span class="pc">e</span> <span class="w">16K</span> <span class="w">o</span><span class="pc">r</span> <span class="w">32K</span><span class="pc">")</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="c">-EINVAL;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">xfs_sb_version_hascrc(</span><span class="pc">&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_sb)</span><span class="pc"> &amp;</span><span class="c">&amp;</span>
	    <span class="pc">(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_MOUNT_NOATTR2</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">x</span><span class="c">fs_warn</span><span class="pc">(</span><span class="w">m</span><span class="pc">p,</span>
<span class="pc">"</span><span class="w">C</span><span class="pc">a</span><span class="c">nnot</span> <span class="w">mount</span> <span class="w">a</span> <span class="w">V5</span> <span class="w">filesystem</span> <span class="w">as</span> <span class="pc">%s</span><span class="w">. %s</span> <span class="w">i</span><span class="c">s</span> <span class="w">always</span> <span class="w">e</span><span class="pc">n</span><span class="c">abled</span> <span class="w">f</span><span class="c">or</span> <span class="w">V</span><span class="c">5</span> <span class="w">filesystems.",</span>
			<span class="w">MNTOPT_NOATTR2,</span> <span class="w">MNTOPT_ATTR2)</span><span class="pc">;</span>
		<span class="w">r</span><span class="c">eturn</span> <span class="w">-</span><span class="c">EINVAL;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">xfs_sb_version_hasattr2</span><span class="pc">(&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_sb) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">!</span><span class="pc">(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="c">&amp;</span> <span class="w">XFS_MOUNT_NOATTR2</span><span class="c">))</span>
		<span class="w">mp</span><span class="c">-&gt;m_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_MOUNT_ATTR2</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="pc">((</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">_s</span><span class="c">b</span><span class="pc">.</span><span class="w">sb_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_SBF_READONLY) &amp;</span><span class="pc">&amp; !</span><span class="w">ronly</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span>
			<span class="pc">"</span><span class="w">c</span><span class="pc">ann</span><span class="c">ot</span> <span class="w">mount</span> <span class="w">a</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-on</span><span class="pc">l</span><span class="c">y</span> <span class="w">filesystem</span> <span class="w">a</span><span class="pc">s</span> <span class="w">rea</span><span class="pc">d</span><span class="w">-w</span><span class="pc">r</span><span class="c">ite</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">-</span><span class="w">EROFS</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="pc">((</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_qflags</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">XFS_GQUOTA_ACCT</span> <span class="c">|</span> <span class="w">XFS_GQUOTA_ACTIVE)) &amp;&amp;</span>
	    <span class="c">(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">_</span><span class="c">qflags</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">XFS_PQUOTA_ACCT</span> <span class="c">|</span> <span class="w">XFS_PQUOTA_ACTIVE)) &amp;</span><span class="pc">&amp;</span>
	    <span class="w">!xfs_sb_version_has_pquotino(</span><span class="pc">&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_sb))</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span>
		  <span class="c">"</span><span class="w">Super</span> <span class="w">b</span><span class="pc">l</span><span class="c">ock</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">su</span><span class="pc">pport</span> <span class="w">project</span> <span class="w">a</span><span class="c">nd</span> <span class="w">gr</span><span class="c">oup</span> <span class="w">quota</span> <span class="w">together</span><span class="pc">"</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span>
<span class="w">xfs_init_percpu_counters</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span>		<span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>

	<span class="w">e</span><span class="c">rror</span> <span class="c">=</span> <span class="w">percpu_counter_init</span><span class="pc">(&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_icount</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="w">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>

	<span class="w">e</span><span class="c">rror</span> <span class="c">=</span> <span class="pc">p</span><span class="c">ercpu_counter_init</span><span class="pc">(&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_ifree</span><span class="c">,</span> <span class="c">0,</span> <span class="pc">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">free_icount</span><span class="c">;</span>

	<span class="w">e</span><span class="c">rror</span> <span class="c">=</span> <span class="pc">p</span><span class="c">ercpu_counter_init</span><span class="pc">(&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_fdblocks</span><span class="pc">,</span> <span class="c">0</span><span class="pc">,</span> <span class="w">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror)</span>
		<span class="c">goto</span> <span class="w">free_ifree</span><span class="c">;</span>

	<span class="c">return</span> <span class="c">0;</span>

<span class="c">free_ifree:</span>
	<span class="w">percpu_counter_destroy</span><span class="pc">(&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_ifree</span><span class="c">);</span>
<span class="w">f</span><span class="pc">ree_ic</span><span class="c">ount:</span>
	<span class="w">p</span><span class="c">ercpu_counter_destroy</span><span class="pc">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_icount</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">-</span><span class="pc">ENOM</span><span class="c">EM;</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span>
<span class="w">xfs_reinit_percpu_counters</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">percpu_counter_set</span><span class="c">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m_ic</span><span class="c">ount</span><span class="pc">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb</span><span class="pc">.</span><span class="w">sb_icount</span><span class="c">);</span>
	<span class="w">p</span><span class="c">ercpu_counter_set</span><span class="pc">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">_if</span><span class="c">ree</span><span class="pc">,</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;m_sb</span><span class="pc">.</span><span class="w">sb_ifree</span><span class="c">);</span>
	<span class="pc">p</span><span class="c">ercpu_counter_set</span><span class="pc">(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_fdblocks</span><span class="c">,</span> <span class="w">m</span><span class="c">p-&gt;</span><span class="pc">m_s</span><span class="c">b.</span><span class="w">sb_fdblocks</span><span class="c">);</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span>
<span class="w">xfs_destroy_percpu_counters</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="pc">p)</span>
<span class="c">{</span>
	<span class="w">percpu_counter_destroy</span><span class="c">(&amp;</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_icount</span><span class="c">);</span>
	<span class="w">p</span><span class="c">ercpu_counter_destroy(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_ifree</span><span class="c">);</span>
	<span class="pc">p</span><span class="c">ercpu_counter_destroy</span><span class="pc">(&amp;</span><span class="w">m</span><span class="c">p-&gt;</span><span class="pc">m_f</span><span class="c">dblocks);</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">in</span><span class="pc">t</span>
<span class="w">xfs_fs_fill_super</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">s</span><span class="pc">u</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b,</span>
	<span class="pc">v</span><span class="c">oid</span>			<span class="c">*data,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">silent</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="c">node</span>		<span class="c">*</span><span class="w">r</span><span class="pc">o</span><span class="c">ot;</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">f</span><span class="c">lags</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>

	<span class="w">mp</span> <span class="pc">=</span> <span class="c">kzalloc(sizeof</span><span class="pc">(</span><span class="c">struct</span> <span class="c">xfs_mount),</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">m</span><span class="pc">p</span><span class="c">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>

	<span class="w">s</span><span class="c">pin_lock_init(&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb_lock</span><span class="c">);</span>
	<span class="pc">m</span><span class="c">utex_init(&amp;</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_growlock</span><span class="c">);</span>
	<span class="w">a</span><span class="c">tomic_set(&amp;</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_active_trans</span><span class="c">,</span> <span class="c">0);</span>
	<span class="w">INIT_DELAYED_WORK</span><span class="c">(&amp;</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_reclaim_work</span><span class="pc">,</span> <span class="w">xfs_reclaim_worker</span><span class="c">);</span>
	<span class="w">I</span><span class="pc">NIT_D</span><span class="c">ELAYED_WORK</span><span class="pc">(</span><span class="c">&amp;</span><span class="pc">m</span><span class="c">p-&gt;</span><span class="w">m_eofblocks_work</span><span class="pc">,</span> <span class="w">xfs_eofblocks_worker</span><span class="c">);</span>
	<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_kobj</span><span class="pc">.</span><span class="w">ko</span><span class="pc">bje</span><span class="c">ct</span><span class="w">.kset</span> <span class="pc">=</span> <span class="w">xfs_kset</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_super</span> <span class="c">=</span> <span class="w">sb</span><span class="c">;</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_fs_info</span> <span class="c">=</span> <span class="w">m</span><span class="pc">p;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="c">=</span> <span class="w">xfs_parseargs</span><span class="c">(</span><span class="pc">m</span><span class="c">p</span><span class="w">,</span><span class="pc"> (</span><span class="w">c</span><span class="c">har</span> <span class="c">*)</span><span class="w">da</span><span class="pc">t</span><span class="c">a);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r)</span>
		<span class="c">goto</span> <span class="w">out_free_fsname</span><span class="c">;</span>

	<span class="w">sb_min_blocksize</span><span class="c">(</span><span class="w">sb</span><span class="c">,</span> <span class="w">BBSIZE</span><span class="c">);</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_xattr</span> <span class="c">=</span> <span class="w">xfs_xattr_handlers</span><span class="c">;</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_export_op</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">xfs_export_operations</span><span class="c">;</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">CONFIG_XFS_QUOTA</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_qcop</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">xfs_quotactl_operations</span><span class="c">;</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_quota_types</span> <span class="c">=</span> <span class="w">QTYPE_MASK_USR</span> <span class="pc">|</span> <span class="w">QTYPE_MASK_GRP</span> <span class="c">|</span> <span class="w">QTYPE_MASK_PRJ</span><span class="pc">;</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_op</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">xfs_super_operations</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">silent</span><span class="pc">)</span>
		<span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">|=</span> <span class="w">XFS_MFSI_QUIET</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_open_devices</span><span class="c">(</span><span class="w">mp</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_free_fsname</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_init_mount_workqueues</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
		<span class="c">goto</span> <span class="w">out_close_devices</span><span class="c">;</span>

	<span class="pc">erro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_init_percpu_counters</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
		<span class="c">goto</span> <span class="w">out_destroy_workqueues</span><span class="c">;</span>

	<span class="pc">e</span><span class="c">rror</span> <span class="c">=</span> <span class="w">xfs_readsb</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="w">f</span><span class="c">lags);</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">goto</span> <span class="w">out_destroy_counters</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_finish_flags</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">goto</span> <span class="w">out_free_sb</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_setup_devices</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">goto</span> <span class="pc">out_</span><span class="c">free_sb;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_filestream_mount</span><span class="c">(</span><span class="w">mp</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">goto</span> <span class="pc">out_</span><span class="c">free_sb;</span>

	
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_magic</span> <span class="c">=</span> <span class="w">XFS_SB_MAGIC</span><span class="c">;</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_blocksize</span> <span class="c">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb</span><span class="pc">.</span><span class="w">sb_blocksize</span><span class="c">;</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_blocksize_bits</span> <span class="c">=</span> <span class="w">ffs</span><span class="c">(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s_blocksize</span><span class="w">) </span><span class="pc">-</span> <span class="c">1</span><span class="pc">;</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_maxbytes</span> <span class="c">=</span> <span class="w">xfs_max_file_offset</span><span class="pc">(</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s_blocksize_</span><span class="c">bits);</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_max_links</span> <span class="c">=</span> <span class="w">XFS_MAXLINK</span><span class="pc">;</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_time_gran</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">set_posix_acl_flag</span><span class="c">(</span><span class="w">sb</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">XFS_SB_VERSION_NUM(</span><span class="pc">&amp;</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_sb)</span><span class="pc"> </span><span class="c">==</span> <span class="w">XFS_SB_VERSION_5</span><span class="pc">)</span>
		<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_flags</span> <span class="w">|</span><span class="c">=</span> <span class="w">MS_I_VERSION</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="c">p-&gt;</span><span class="w">m_flags</span> <span class="pc">&amp;</span> <span class="w">XFS_MOUNT_DAX</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">xfs_warn</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span>
	<span class="c">"</span><span class="w">DAX</span> <span class="w">en</span><span class="pc">a</span><span class="c">bled</span><span class="w">.</span> <span class="w">Warning:</span> <span class="w">EXPERIMENTAL</span><span class="pc">,</span> <span class="w">u</span><span class="pc">s</span><span class="c">e</span> <span class="w">a</span><span class="pc">t</span> <span class="w">your</span> <span class="w">own</span> <span class="w">risk</span><span class="c">");</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_blocksize</span> <span class="pc">!</span><span class="c">=</span> <span class="w">P</span><span class="c">AGE_SIZE</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">xfs_alert</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">,</span>
		<span class="c">"</span><span class="w">Filesystem</span> <span class="w">b</span><span class="pc">l</span><span class="c">ock</span> <span class="w">s</span><span class="c">ize</span> <span class="w">i</span><span class="pc">nv</span><span class="c">alid</span> <span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="w">D</span><span class="c">AX</span> <span class="w">Turning</span> <span class="w">D</span><span class="c">AX</span> <span class="w">of</span><span class="pc">f</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">XFS_MOUNT_DAX</span><span class="c">;</span>
		<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_bdev-</span><span class="c">&gt;</span><span class="w">bd_disk-</span><span class="c">&gt;</span><span class="w">fops</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">direct_access</span><span class="c">) {</span>
			<span class="w">x</span><span class="c">fs_alert</span><span class="pc">(</span><span class="w">m</span><span class="c">p</span><span class="pc">,</span>
		<span class="w">"Block</span> <span class="w">d</span><span class="c">evice</span> <span class="w">does</span> <span class="w">n</span><span class="pc">o</span><span class="c">t</span> <span class="w">s</span><span class="pc">upport</span> <span class="w">D</span><span class="pc">A</span><span class="c">X</span> <span class="w">T</span><span class="c">urning</span> <span class="w">D</span><span class="c">AX</span> <span class="w">of</span><span class="pc">f</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_flags</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">X</span><span class="c">FS_MOUNT_DAX;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="c">=</span> <span class="w">xfs_mountfs</span><span class="c">(</span><span class="w">mp</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_filestream_unmount</span><span class="c">;</span>

	<span class="w">ro</span><span class="c">ot</span> <span class="pc">=</span> <span class="w">igrab</span><span class="c">(</span><span class="w">VFS_I</span><span class="pc">(</span><span class="w">m</span><span class="pc">p-</span><span class="c">&gt;</span><span class="w">m_rootip</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">ro</span><span class="c">ot) {</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">= -</span><span class="w">EN</span><span class="pc">OE</span><span class="c">NT;</span>
		<span class="c">goto</span> <span class="w">out_unmount</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">sb</span><span class="c">-&gt;</span><span class="w">s_root</span> <span class="c">=</span> <span class="w">d_make_root</span><span class="c">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">sb</span><span class="pc">-</span><span class="c">&gt;s_root) {</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">o</span><span class="pc">ut_unm</span><span class="c">ount;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>

 <span class="w">out_filestream_unmount</span><span class="c">:</span>
	<span class="w">xfs_filestream_unmount</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
 <span class="w">out_free_sb</span><span class="c">:</span>
	<span class="w">xfs_freesb</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
 <span class="w">out_destroy_counters</span><span class="c">:</span>
	<span class="w">xfs_destroy_percpu_counters</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
<span class="w">out_destroy_workqueues</span><span class="c">:</span>
	<span class="w">xfs_destroy_mount_workqueues</span><span class="c">(</span><span class="w">m</span><span class="pc">p</span><span class="c">);</span>
 <span class="w">out_close_devices</span><span class="c">:</span>
	<span class="w">xfs_close_devices</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
 <span class="w">out_free_fsname</span><span class="c">:</span>
	<span class="w">xfs_free_fsname</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
	<span class="w">k</span><span class="c">free(</span><span class="pc">m</span><span class="c">p);</span>
 <span class="w">out</span><span class="c">:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>

 <span class="w">out_unmount</span><span class="c">:</span>
	<span class="w">xfs_filestream_unmount</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
	<span class="w">xfs_unmountfs</span><span class="pc">(</span><span class="w">m</span><span class="c">p);</span>
	<span class="w">g</span><span class="c">oto</span> <span class="w">out_free_sb</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_fs_put_super</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="c">p</span> <span class="c">=</span> <span class="w">XFS_M</span><span class="c">(</span><span class="w">sb</span><span class="c">);</span>

	<span class="w">xfs_notice</span><span class="c">(</span><span class="w">m</span><span class="c">p</span><span class="w">,</span><span class="pc"> "</span><span class="w">Unmounting</span> <span class="w">Filesystem"</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">x</span><span class="c">fs_filestream_unmount(</span><span class="w">m</span><span class="c">p);</span>
	<span class="w">x</span><span class="pc">fs_u</span><span class="c">nmountfs(</span><span class="w">m</span><span class="c">p);</span>

	<span class="w">xfs_freesb</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
	<span class="w">xfs_destroy_percpu_counters</span><span class="c">(</span><span class="w">m</span><span class="c">p);</span>
	<span class="w">xfs_destroy_mount_workqueues</span><span class="c">(</span><span class="pc">m</span><span class="c">p);</span>
	<span class="w">xfs_close_devices</span><span class="c">(</span><span class="pc">m</span><span class="c">p);</span>
	<span class="w">xfs_free_fsname</span><span class="c">(</span><span class="pc">m</span><span class="c">p);</span>
	<span class="pc">k</span><span class="c">free(mp);</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">st</span><span class="pc">r</span><span class="c">uct</span> <span class="w">d</span><span class="c">entry</span> <span class="c">*</span>
<span class="w">xfs_fs_mount</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">file_system_type</span>	<span class="c">*</span><span class="w">fs_type</span><span class="c">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">f</span><span class="pc">l</span><span class="c">ags</span><span class="pc">,</span>
	<span class="w">c</span><span class="c">onst</span> <span class="pc">c</span><span class="c">har</span>		<span class="c">*dev_name,</span>
	<span class="c">void</span>			<span class="c">*data)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">mount_bdev</span><span class="c">(</span><span class="pc">f</span><span class="c">s_type,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags</span><span class="pc">,</span> <span class="w">dev</span><span class="pc">_</span><span class="c">name</span><span class="w">,</span> <span class="pc">d</span><span class="c">ata</span><span class="pc">,</span> <span class="w">xfs_fs_fill_super</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">l</span><span class="c">ong</span>
<span class="w">xfs_fs_nr_cached_objects</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b,</span>
	<span class="c">struct</span> <span class="w">shrink_control</span>	<span class="c">*</span><span class="w">sc</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">xfs_reclaim_inodes_count</span><span class="c">(</span><span class="w">XFS_M</span><span class="pc">(</span><span class="w">sb</span><span class="pc">))</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">l</span><span class="c">ong</span>
<span class="w">xfs_fs_free_cached_objects</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">su</span><span class="c">per_block</span>	<span class="c">*</span><span class="pc">s</span><span class="c">b,</span>
	<span class="c">struct</span> <span class="c">shrink_control</span>	<span class="c">*</span><span class="w">sc</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">xfs_reclaim_inodes_nr</span><span class="c">(XFS_M</span><span class="pc">(</span><span class="w">sb</span><span class="c">),</span> <span class="w">s</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">nr_to_scan</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">super_operations</span> <span class="w">xfs_super_operations</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">alloc_inode</span>		<span class="c">=</span> <span class="w">xfs_fs_alloc_inode</span><span class="c">,</span>
	<span class="c">.</span><span class="w">destroy_inode</span>		<span class="c">=</span> <span class="w">xfs_fs_destroy_inode</span><span class="c">,</span>
	<span class="c">.</span><span class="w">evict_inode</span>		<span class="c">=</span> <span class="w">xfs_fs_evict_inode</span><span class="c">,</span>
	<span class="c">.</span><span class="w">drop_inode</span>		<span class="c">=</span> <span class="w">xfs_fs_drop_inode</span><span class="c">,</span>
	<span class="c">.</span><span class="w">put_super</span>		<span class="c">=</span> <span class="w">xfs_fs_put_super</span><span class="c">,</span>
	<span class="c">.</span><span class="w">sync_fs</span>		<span class="c">=</span> <span class="w">xfs_fs_sync_fs</span><span class="c">,</span>
	<span class="c">.</span><span class="w">freeze_fs</span>		<span class="c">=</span> <span class="w">xfs_fs_freeze</span><span class="c">,</span>
	<span class="c">.</span><span class="w">unfreeze_fs</span>		<span class="c">=</span> <span class="w">xfs_fs_unfreeze</span><span class="c">,</span>
	<span class="c">.</span><span class="w">statfs</span>			<span class="c">=</span> <span class="w">xfs_fs_statfs</span><span class="c">,</span>
	<span class="c">.</span><span class="w">remount_fs</span>		<span class="c">=</span> <span class="w">xfs_fs_remount</span><span class="c">,</span>
	<span class="c">.</span><span class="w">show_options</span>		<span class="c">=</span> <span class="w">xfs_fs_show_options</span><span class="c">,</span>
	<span class="c">.</span><span class="w">nr_cached_objects</span>	<span class="c">=</span> <span class="w">xfs_fs_nr_cached_objects</span><span class="c">,</span>
	<span class="c">.</span><span class="w">free_cached_objects</span>	<span class="c">=</span> <span class="w">xfs_fs_free_cached_objects</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">file_system_type</span> <span class="w">xfs_fs_type</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">o</span><span class="pc">w</span><span class="c">ner</span>			<span class="c">=</span> <span class="c">THIS_MODULE,</span>
	<span class="c">.name</span>			<span class="c">= "</span><span class="w">xfs</span><span class="c">",</span>
	<span class="c">.</span><span class="w">mount</span>			<span class="c">=</span> <span class="w">xfs_fs_mount</span><span class="c">,</span>
	<span class="c">.</span><span class="w">kill_sb</span>		<span class="c">=</span> <span class="w">kill_block_super</span><span class="c">,</span>
	<span class="c">.</span><span class="w">fs_flags</span>		<span class="c">=</span> <span class="w">FS_REQUIRES_DEV</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>
<span class="w">MODULE_ALIAS_FS</span><span class="pc">("</span><span class="w">x</span><span class="pc">fs</span><span class="w">"</span><span class="pc">)</span><span class="c">;</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="c">nt</span> <span class="pc">_</span><span class="c">_init</span>
<span class="w">xfs_init_zones</span><span class="c">(void)</span>
<span class="c">{</span>

	<span class="w">xfs_ioend_zone</span> <span class="c">=</span> <span class="w">kmem_zone_init</span><span class="pc">(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">xfs_ioend_t),</span><span class="pc"> "</span><span class="w">xfs_ioend</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_ioend_zone)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>

	<span class="w">xfs_ioend_pool</span> <span class="pc">=</span> <span class="w">mempool_create_slab_pool</span><span class="c">(</span><span class="w">4</span> <span class="pc">*</span> <span class="w">MAX_BUF_PER_PAGE</span><span class="pc">,</span>
						  <span class="pc">xfs_ioend_z</span><span class="c">one);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_ioend_pool)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_destroy_ioend_zone</span><span class="c">;</span>

	<span class="w">xfs_log_ticket_zone</span> <span class="pc">=</span> <span class="pc">k</span><span class="c">mem_zone_init</span><span class="pc">(</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">xlog_ticket_t</span><span class="c">),</span>
						<span class="w">"xfs_log_ticket</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_log_ticket_zone)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_destroy_ioend_pool</span><span class="c">;</span>

	<span class="w">xfs_bmap_free_item_zone</span> <span class="pc">=</span> <span class="pc">k</span><span class="c">mem_zone_init(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">xfs_bmap_free_item_t</span><span class="pc">),</span>
						<span class="w">"xfs_bmap_free_item</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_bmap_free_item_zone)</span>
		<span class="c">goto</span> <span class="w">out_destroy_log_ticket_zone</span><span class="c">;</span>

	<span class="w">xfs_btree_cur_zone</span> <span class="pc">=</span> <span class="c">kmem_zone_init(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">xfs_btree_cur_t</span><span class="c">),</span>
						<span class="w">"xfs_btree_cur</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_btree_cur_zone)</span>
		<span class="c">goto</span> <span class="w">out_destroy_bmap_free_item_zone</span><span class="c">;</span>

	<span class="w">xfs_da_state_zone</span> <span class="pc">=</span> <span class="c">kmem_zone_init(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">xfs_da_state_t</span><span class="c">),</span>
						<span class="w">"xfs_da_state</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_da_state_zone)</span>
		<span class="c">goto</span> <span class="w">out_destroy_btree_cur_zone</span><span class="c">;</span>

	<span class="w">xfs_ifork_zone</span> <span class="pc">=</span> <span class="c">kmem_zone_init(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">xfs_ifork_t),</span><span class="pc"> "</span><span class="w">xfs_ifork</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_ifork_zone)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_destroy_da_state_zone</span><span class="c">;</span>

	<span class="w">xfs_trans_zone</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">me</span><span class="c">m_zone_init(</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">xfs_trans_t),</span><span class="pc"> "</span><span class="w">xfs_trans</span><span class="c">");</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_trans_zone)</span>
		<span class="c">goto</span> <span class="w">out_destroy_ifork_zone</span><span class="c">;</span>

	<span class="w">xfs_log_item_desc_zone</span> <span class="pc">=</span>
		<span class="c">kmem_zone_init(</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">xfs_log_item_desc</span><span class="c">),</span>
			       <span class="w">"xfs_l</span><span class="pc">og_item_desc")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_log_item_desc_zone)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_destroy_trans_zone</span><span class="c">;</span>

	
	<span class="w">xfs_buf_item_zone</span> <span class="pc">=</span> <span class="pc">k</span><span class="c">mem_zone_init(</span><span class="w">s</span><span class="c">izeof(struct</span> <span class="w">xfs_buf_log_item</span><span class="c">),</span>
					   <span class="w">"xfs_buf_item"</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_buf_item_zone)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_destroy_log_item_desc_zone</span><span class="c">;</span>

	<span class="w">xfs_efd_zone</span> <span class="pc">=</span> <span class="c">kmem_zone_init</span><span class="w">(</span><span class="pc">(</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">xfs_efd_log_item_t</span><span class="pc">) </span><span class="c">+</span>
			<span class="w">(</span><span class="pc">(</span><span class="w">XFS_EFD_MAX_FAST_EXTENTS</span> <span class="c">-</span> <span class="pc">1) </span><span class="c">*</span>
				 <span class="c">sizeof(</span><span class="w">xfs_extent_t))), "xfs_efd_item"</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!xfs_ef</span><span class="c">d_zone)</span>
		<span class="c">goto</span> <span class="w">out_destroy_buf_item_zone</span><span class="c">;</span>

	<span class="w">xfs_efi_zone</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">me</span><span class="c">m_zone_init</span><span class="w">(</span><span class="pc">(</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">xfs_efi_log_item_t</span><span class="pc">) </span><span class="c">+</span>
			<span class="w">(</span><span class="pc">(</span><span class="w">XFS_EFI_MAX_FAST_EXTENTS</span> <span class="w">-</span> <span class="pc">1</span><span class="c">) *</span>
				<span class="c">sizeof(</span><span class="pc">x</span><span class="c">fs_extent_t</span><span class="w">)))</span><span class="pc">,</span><span class="c"> "</span><span class="w">xfs_efi_item"</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">x</span><span class="pc">fs_efi</span><span class="c">_zone)</span>
		<span class="c">goto</span> <span class="w">out_destroy_efd_zone</span><span class="c">;</span>

	<span class="w">xfs_inode_zone</span> <span class="pc">=</span>
		<span class="w">kmem_zone_init_flags</span><span class="c">(</span><span class="w">s</span><span class="pc">i</span><span class="c">zeof(</span><span class="w">xfs_inode_t),</span><span class="pc"> "</span><span class="w">xfs_inode</span><span class="pc">",</span>
			<span class="w">KM_ZONE_HWALIGN</span> <span class="pc">|</span> <span class="w">KM_ZONE_RECLAIM</span> <span class="pc">|</span> <span class="w">KM_ZONE_SPREAD</span><span class="pc">,</span>
			<span class="w">xfs_fs_inode_init_once</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_inode_zone)</span>
		<span class="c">goto</span> <span class="w">out_destroy_efi_zone</span><span class="c">;</span>

	<span class="w">xfs_ili_zone</span> <span class="pc">=</span>
		<span class="w">k</span><span class="c">mem_zone_init_flags(</span><span class="w">s</span><span class="c">izeof(</span><span class="w">xfs_inode_log_item_t),</span><span class="pc"> "</span><span class="w">xfs_ili</span><span class="c">",</span>
					<span class="w">K</span><span class="pc">M_ZONE_S</span><span class="c">PREAD</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_ili_zone</span><span class="pc">)</span>
		<span class="c">goto</span> <span class="w">out_destroy_inode_zone</span><span class="c">;</span>
	<span class="w">xfs_icreate_zone</span> <span class="pc">=</span> <span class="w">kmem_zone_init</span><span class="c">(</span><span class="w">s</span><span class="c">izeof(struct</span> <span class="w">xfs_icreate_item</span><span class="c">),</span>
					<span class="w">"xfs_icr</span><span class="pc">")</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_icreate_zone)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_destroy_ili_zone</span><span class="c">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>

 <span class="c">out_destroy_ili_zone:</span>
	<span class="w">kmem_zone_destroy</span><span class="c">(</span><span class="pc">xfs_il</span><span class="c">i_zone);</span>
 <span class="pc">o</span><span class="c">ut_destroy_inode_zone:</span>
	<span class="w">k</span><span class="pc">mem_zone_d</span><span class="c">estroy(</span><span class="w">xfs_inode_zone</span><span class="pc">)</span><span class="c">;</span>
 <span class="w">out_destroy_efi_zone</span><span class="c">:</span>
	<span class="pc">km</span><span class="c">em_zone_destroy(</span><span class="w">xfs_efi_zone</span><span class="pc">)</span><span class="c">;</span>
 <span class="w">out_destroy_efd_zone</span><span class="c">:</span>
	<span class="w">k</span><span class="pc">m</span><span class="c">em_zone_destroy(</span><span class="w">xfs_efd_zone</span><span class="c">);</span>
 <span class="w">out_destroy_buf_item_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_buf_item_zone</span><span class="c">);</span>
 <span class="w">out_destroy_log_item_desc_zone</span><span class="c">:</span>
	<span class="pc">k</span><span class="c">mem_zone_destroy(</span><span class="w">xfs_log_item_desc_zone</span><span class="c">);</span>
 <span class="w">out_destroy_trans_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_trans_zone</span><span class="c">);</span>
 <span class="w">out_destroy_ifork_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_ifork_zone</span><span class="c">);</span>
 <span class="w">out_destroy_da_state_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_da_state_zone</span><span class="c">);</span>
 <span class="w">out_destroy_btree_cur_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_btree_cur_zone</span><span class="c">);</span>
 <span class="w">out_destroy_bmap_free_item_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_bmap_free_item_zone</span><span class="c">);</span>
 <span class="w">out_destroy_log_ticket_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_log_ticket_zone</span><span class="c">);</span>
 <span class="w">out_destroy_ioend_pool</span><span class="c">:</span>
	<span class="w">mempool_destroy</span><span class="c">(</span><span class="w">xfs_ioend_pool</span><span class="c">);</span>
 <span class="w">out_destroy_ioend_zone</span><span class="c">:</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_ioend_zone</span><span class="c">);</span>
 <span class="w">out</span><span class="c">:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">E</span><span class="pc">NOM</span><span class="c">EM;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="pc">o</span><span class="c">id</span>
<span class="w">xfs_destroy_zones</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	
	<span class="w">rcu_barrier</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_icreate_zone</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">k</span><span class="c">mem_zone_destroy(</span><span class="w">xfs_ili_zone</span><span class="c">);</span>
	<span class="pc">k</span><span class="c">mem_zone_destroy(</span><span class="w">xfs_inode_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_efi_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_efd_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_buf_item_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_log_item_desc_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_trans_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_ifork_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_da_state_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_btree_cur_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_bmap_free_item_zone</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_log_ticket_zone</span><span class="c">);</span>
	<span class="w">mempool_destroy</span><span class="c">(</span><span class="w">xfs_ioend_pool</span><span class="c">);</span>
	<span class="c">kmem_zone_destroy(</span><span class="w">xfs_ioend_zone</span><span class="c">);</span>

<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">nt</span> <span class="w">_</span><span class="c">_init</span>
<span class="w">xfs_init_workqueues</span><span class="c">(void)</span>
<span class="c">{</span>
	
	<span class="w">xfs_alloc_wq</span> <span class="w">=</span> <span class="w">alloc_workqueue(</span><span class="pc">"</span><span class="w">xfsalloc</span><span class="c">",</span>
			<span class="w">WQ_MEM_RECLAIM</span><span class="pc">|</span><span class="w">WQ_FREEZABLE</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_alloc_wq</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">v</span><span class="pc">o</span><span class="c">id</span>
<span class="w">xfs_destroy_workqueues</span><span class="c">(</span><span class="pc">v</span><span class="c">oid)</span>
<span class="c">{</span>
	<span class="w">destroy_workqueue</span><span class="c">(xfs_alloc_wq);</span>
<span class="c">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">i</span><span class="c">nt</span> <span class="w">_</span><span class="c">_init</span>
<span class="w">init_xfs_fs</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="c">int</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>

	<span class="w">p</span><span class="pc">ri</span><span class="c">ntk(</span><span class="pc">KERN_I</span><span class="c">NFO</span> <span class="w">XFS_VERSION_STRING</span> <span class="c">"</span> <span class="w">w</span><span class="pc">i</span><span class="c">th</span> <span class="pc">"</span>
			 <span class="w">XFS_BUILD_OPTIONS</span> <span class="w">"</span> <span class="w">e</span><span class="pc">n</span><span class="c">abled</span><span class="pc">\</span><span class="c">n");</span>

	<span class="w">xfs_dir_startup</span><span class="pc">()</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_init_zones</span><span class="pc">()</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="c">rror</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_init_workqueues</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror)</span>
		<span class="c">goto</span> <span class="w">out_destroy_zones</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_mru_cache_init</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
		<span class="c">goto</span> <span class="w">out_destroy_wq</span><span class="c">;</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_buf_init</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">goto</span> <span class="w">out_mru_cache_uninit</span><span class="c">;</span>

	<span class="pc">erro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_init_procfs</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">goto</span> <span class="w">out_buf_terminate</span><span class="c">;</span>

	<span class="pc">erro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_sysctl_register</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(error)</span>
		<span class="c">goto</span> <span class="w">out_cleanup_procfs</span><span class="c">;</span>

	<span class="w">xfs_kset</span> <span class="c">=</span> <span class="w">kset_create_and_add</span><span class="pc">("</span><span class="w">xfs</span><span class="c">",</span> <span class="c">NULL</span><span class="pc">,</span> <span class="w">fs_kobj</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">xfs_kset</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">out_sysctl_unregister;;</span>
	<span class="pc">}</span>

<span class="w">#</span><span class="pc">i</span><span class="c">fdef</span> <span class="w">D</span><span class="c">EBUG</span>
	<span class="w">xfs_dbg_kobj</span><span class="pc">.</span><span class="w">ko</span><span class="pc">bje</span><span class="c">ct</span><span class="w">.kset</span> <span class="c">=</span> <span class="pc">xfs_k</span><span class="c">set;</span>
	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_sysfs_init</span><span class="pc">(&amp;</span><span class="w">x</span><span class="pc">fs_d</span><span class="c">bg_kobj</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">xfs_dbg_ktype</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">, "</span><span class="w">deb</span><span class="c">ug");</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
		<span class="c">goto</span> <span class="w">out_kset_unregister</span><span class="c">;</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

	<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_qm_init</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
		<span class="c">goto</span> <span class="w">out_remove_kobj</span><span class="c">;</span>

	<span class="pc">erro</span><span class="c">r</span> <span class="c">=</span> <span class="w">register_filesystem</span><span class="pc">(&amp;</span><span class="w">xfs_fs_type</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">erro</span><span class="c">r)</span>
		<span class="c">goto</span> <span class="w">out_qm_exit</span><span class="c">;</span>
	<span class="c">return</span> <span class="c">0;</span>

 <span class="c">out_qm_exit:</span>
	<span class="w">xfs_qm_exit</span><span class="pc">()</span><span class="c">;</span>
 <span class="w">o</span><span class="pc">ut_r</span><span class="c">emove_kobj:</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="w">D</span><span class="c">EBUG</span>
	<span class="w">xfs_sysfs_del</span><span class="pc">(&amp;</span><span class="w">xfs_dbg_kobj</span><span class="c">);</span>
 <span class="w">out_kset_unregister</span><span class="pc">:</span>
<span class="w">#</span><span class="c">endif</span>
	<span class="w">kset_unregister</span><span class="c">(</span><span class="w">xfs_kset</span><span class="c">);</span>
 <span class="w">out_sysctl_unregister</span><span class="pc">:</span>
	<span class="w">xfs_sysctl_unregister</span><span class="pc">()</span><span class="c">;</span>
 <span class="w">out_cleanup_procfs</span><span class="pc">:</span>
	<span class="w">xfs_cleanup_procfs</span><span class="pc">()</span><span class="c">;</span>
 <span class="w">out_buf_terminate</span><span class="c">:</span>
	<span class="w">xfs_buf_terminate</span><span class="c">();</span>
 <span class="w">out_mru_cache_uninit</span><span class="c">:</span>
	<span class="w">xfs_mru_cache_uninit</span><span class="c">();</span>
 <span class="w">out_destroy_wq</span><span class="c">:</span>
	<span class="w">xfs_destroy_workqueues</span><span class="pc">(</span><span class="c">);</span>
 <span class="w">out_destroy_zones</span><span class="c">:</span>
	<span class="w">xfs_destroy_zones</span><span class="c">();</span>
 <span class="w">out</span><span class="c">:</span>
	<span class="c">return</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span> <span class="pc">_</span><span class="c">_exit</span>
<span class="w">exit_xfs_fs</span><span class="c">(void)</span>
<span class="c">{</span>
	<span class="w">xfs_qm_exit</span><span class="c">();</span>
	<span class="w">unregister_filesystem</span><span class="pc">(&amp;</span><span class="w">xfs_fs_type</span><span class="c">);</span>
<span class="w">#</span><span class="c">ifdef</span> <span class="pc">D</span><span class="c">EBUG</span>
	<span class="w">xfs_sysfs_del</span><span class="pc">(&amp;</span><span class="w">xfs_dbg_kobj</span><span class="c">);</span>
<span class="pc">#</span><span class="c">endif</span>
	<span class="w">kset_unregister</span><span class="c">(</span><span class="w">xfs_kset</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">xfs_sysctl_unregister</span><span class="pc">()</span><span class="c">;</span>
	<span class="w">xfs_cleanup_procfs</span><span class="c">();</span>
	<span class="w">xfs_buf_terminate</span><span class="c">();</span>
	<span class="w">xfs_mru_cache_uninit</span><span class="c">();</span>
	<span class="w">xfs_destroy_workqueues</span><span class="c">();</span>
	<span class="w">xfs_destroy_zones</span><span class="c">();</span>
<span class="c">}</span>

<span class="c">module_init(</span><span class="w">init_xfs_fs</span><span class="c">);</span>
<span class="c">module_exit(</span><span class="w">exit_xfs_fs</span><span class="c">);</span>

<span class="pc">MODULE_A</span><span class="c">UTHOR("</span><span class="w">Silicon</span> <span class="w">Graphics,</span> <span class="w">Inc.</span><span class="pc">"</span><span class="c">);</span>
<span class="pc">MODULE_D</span><span class="c">ESCRIPTION</span><span class="pc">(</span><span class="w">XFS_VERSION_STRING</span> <span class="pc">"</span> <span class="w">w</span><span class="pc">i</span><span class="c">th</span> <span class="w">"</span> <span class="w">XFS_BUILD_OPTIONS</span> <span class="w">"</span> <span class="w">e</span><span class="pc">n</span><span class="c">abled");</span>
<span class="c">MODULE_LICENSE("GPL");</span>

</pre>
</body>
</html>

