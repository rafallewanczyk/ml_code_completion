<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>


<span class="w">#include</span> <span class="w">&lt;linux/init.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/clk.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/err.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="pc">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">nt</span><span class="c">errupt.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">p</span><span class="c">latform_device.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/slab.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">s</span><span class="pc">pi</span><span class="c">/spi.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">sc</span><span class="pc">a</span><span class="c">tterlist.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/of.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">pm_runtime</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="pc">i</span><span class="c">o.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">dmaengine</span><span class="c">.h&gt;</span>

<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">DRIVER_NAME</span> <span class="c">"</span><span class="w">rockchip</span><span class="pc">-</span><span class="w">sp</span><span class="pc">i</span><span class="c">"</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">ROCKCHIP_SPI_CTRLR0</span>			<span class="w">0x00</span><span class="pc">00</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_CTRLR1</span>			<span class="w">0x0004</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_SSIENR</span>			<span class="c">0x0008</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_SER</span>			<span class="w">0x000c</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_BAUDR</span>			<span class="w">0x001</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_TXFTLR</span>			<span class="w">0x0014</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_RXFTLR</span>			<span class="w">0x0018</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_TXFLR</span>			<span class="w">0x001c</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_RXFLR</span>			<span class="w">0x002</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_SR</span>				<span class="w">0x0024</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_IPR</span>			<span class="w">0x0028</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_IMR</span>			<span class="w">0x002c</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_ISR</span>			<span class="w">0x0030</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_RISR</span>			<span class="w">0x0034</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_ICR</span>			<span class="w">0x0038</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_DMACR</span>			<span class="w">0x003c</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_DMATDLR</span>		<span class="w">0x004</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_DMARDLR</span>		<span class="w">0x0044</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_TXDR</span>			<span class="w">0x04</span><span class="c">00</span>
<span class="c">#define</span> <span class="w">ROCKCHIP_SPI_RXDR</span>			<span class="c">0x0800</span>


<span class="c">#define</span> <span class="w">CR0_DFS_OFFSET</span>				<span class="w">0</span>

<span class="c">#define</span> <span class="w">CR0_CFS_OFFSET</span>				<span class="w">2</span>

<span class="c">#define</span> <span class="w">CR0_SCPH_OFFSET</span>				<span class="w">6</span>

<span class="c">#define</span> <span class="w">CR0_SCPOL_OFFSET</span>			<span class="pc">7</span>

<span class="c">#define</span> <span class="w">CR0_CSM_OFFSET</span>				<span class="c">8</span>
<span class="c">#define</span> <span class="w">CR0_CSM_KEEP</span>				<span class="w">0x0</span>

<span class="c">#define</span> <span class="w">CR0_CSM_HALF</span>				<span class="w">0X1</span>

<span class="c">#define</span> <span class="w">CR0_CSM_ONE</span>					<span class="w">0x</span><span class="pc">2</span>


<span class="c">#define</span> <span class="w">CR0_SSD_OFFSET</span>				<span class="w">1</span><span class="pc">0</span>

<span class="c">#define</span> <span class="w">CR0_SSD_HALF</span>				<span class="pc">0x</span><span class="c">0</span>

<span class="c">#define</span> <span class="w">CR0_SSD_ONE</span>					<span class="c">0x1</span>

<span class="c">#define</span> <span class="w">CR0_EM_OFFSET</span>				<span class="w">11</span>
<span class="c">#define</span> <span class="w">CR0_EM_LITTLE</span>				<span class="w">0x0</span>
<span class="c">#define</span> <span class="w">CR0_EM_BIG</span>					<span class="pc">0x1</span>

<span class="c">#define</span> <span class="w">CR0_FBM_OFFSET</span>				<span class="w">1</span><span class="pc">2</span>
<span class="c">#define</span> <span class="w">CR0_FBM_MSB</span>					<span class="c">0x0</span>
<span class="c">#define</span> <span class="w">CR0_FBM_LSB</span>					<span class="c">0x1</span>

<span class="c">#define</span> <span class="w">CR0_BHT_OFFSET</span>				<span class="w">1</span><span class="pc">3</span>
<span class="c">#define</span> <span class="w">CR0_BHT_16BIT</span>				<span class="pc">0x0</span>
<span class="c">#define</span> <span class="w">CR0_BHT_8BIT</span>				<span class="c">0x1</span>

<span class="c">#define</span> <span class="w">CR0_RSD_OFFSET</span>				<span class="w">14</span>

<span class="c">#define</span> <span class="w">CR0_FRF_OFFSET</span>				<span class="w">1</span><span class="pc">6</span>
<span class="c">#define</span> <span class="w">CR0_FRF_SPI</span>					<span class="pc">0</span><span class="c">x0</span>
<span class="c">#define</span> <span class="w">CR0_FRF_SSP</span>					<span class="c">0x1</span>
<span class="c">#define</span> <span class="w">CR0_FRF_MICROWIRE</span>			<span class="c">0x2</span>

<span class="c">#define</span> <span class="w">CR0_XFM_OFFSET</span>				<span class="w">18</span>
<span class="c">#define</span> <span class="w">CR0_XFM_MASK</span>				<span class="w">(0x03</span> <span class="c">&lt;&lt;</span> <span class="w">SPI_XFM_OFFSET</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">CR0_XFM_TR</span>					<span class="pc">0x</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">CR0_XFM_TO</span>					<span class="c">0x1</span>
<span class="c">#define</span> <span class="w">CR0_XFM_RO</span>					<span class="c">0x2</span>

<span class="c">#define</span> <span class="w">CR0_OPM_OFFSET</span>				<span class="w">20</span>
<span class="c">#define</span> <span class="w">CR0_OPM_MASTER</span>				<span class="pc">0x0</span>
<span class="c">#define</span> <span class="w">CR0_OPM_SLAVE</span>				<span class="c">0x1</span>

<span class="c">#define</span> <span class="w">CR0_MTM_OFFSET</span>				<span class="w">0x2</span><span class="pc">1</span>


<span class="c">#define</span> <span class="w">SER_MASK</span>					<span class="pc">0x3</span>


<span class="c">#define</span> <span class="w">SR_MASK</span>						<span class="w">0x1</span><span class="pc">f</span>
<span class="c">#define</span> <span class="w">SR_BUSY</span>						<span class="w">(</span><span class="pc">1</span> <span class="c">&lt;&lt;</span> <span class="pc">0</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">SR_TF_FULL</span>					<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">1)</span>
<span class="c">#define</span> <span class="w">SR_TF_EMPTY</span>					<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">2)</span>
<span class="c">#define</span> <span class="w">SR_RF_EMPTY</span>					<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">3)</span>
<span class="c">#define</span> <span class="w">SR_RF_FULL</span>					<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">4)</span>


<span class="c">#define</span> <span class="w">INT_MASK</span>					<span class="w">0x1</span><span class="pc">f</span>
<span class="c">#define</span> <span class="w">INT_TF_EMPTY</span>				<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">0)</span>
<span class="c">#define</span> <span class="w">INT_TF_OVERFLOW</span>				<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">1)</span>
<span class="c">#define</span> <span class="w">INT_RF_UNDERFLOW</span>			<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">2)</span>
<span class="c">#define</span> <span class="w">INT_RF_OVERFLOW</span>				<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">3)</span>
<span class="c">#define</span> <span class="w">INT_RF_FULL</span>					<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">4)</span>


<span class="c">#define</span> <span class="w">ICR_MASK</span>					<span class="w">0x0f</span>
<span class="c">#define</span> <span class="w">ICR_ALL</span>						<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">0)</span>
<span class="c">#define</span> <span class="w">ICR_RF_UNDERFLOW</span>			<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">1)</span>
<span class="c">#define</span> <span class="w">ICR_RF_OVERFLOW</span>				<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">2)</span>
<span class="c">#define</span> <span class="w">ICR_TF_OVERFLOW</span>				<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">3)</span>


<span class="c">#define</span> <span class="w">RF_DMA_EN</span>					<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="pc">0</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">TF_DMA_EN</span>					<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">1)</span>

<span class="c">#define</span> <span class="w">RXBUSY</span>						<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="pc">0</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">TXBUSY</span>						<span class="c">(1</span> <span class="c">&lt;&lt;</span> <span class="c">1)</span>


<span class="c">#define</span> <span class="w">MAX_SCLK_OUT</span>		<span class="w">50000000</span>

<span class="w">e</span><span class="c">num</span> <span class="w">rockchip_ssi_type</span> <span class="c">{</span>
	<span class="w">SSI_MOTO_SPI</span> <span class="pc">=</span> <span class="c">0,</span>
	<span class="w">SSI_TI_SSP</span><span class="c">,</span>
	<span class="w">SSI_NS_MICROWIRE</span><span class="c">,</span>
<span class="c">};</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">rockchip_spi_dma_data</span> <span class="c">{</span>
	<span class="c">struct</span> <span class="w">dm</span><span class="c">a_chan</span> <span class="pc">*</span><span class="w">ch</span><span class="c">;</span>
	<span class="w">e</span><span class="c">num</span> <span class="w">dma_transfer_direction</span> <span class="w">d</span><span class="pc">ire</span><span class="c">ction;</span>
	<span class="w">d</span><span class="c">ma_addr_t</span> <span class="pc">a</span><span class="c">ddr;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">rockchip_spi</span> <span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">d</span><span class="c">evice</span> <span class="c">*dev;</span>
	<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="pc">m</span><span class="c">aster;</span>

	<span class="c">struct</span> <span class="w">c</span><span class="pc">l</span><span class="c">k</span> <span class="c">*</span><span class="w">spiclk</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">c</span><span class="c">lk</span> <span class="c">*</span><span class="w">apb_pclk</span><span class="c">;</span>

	<span class="pc">v</span><span class="c">oid</span> <span class="c">__iomem</span> <span class="c">*regs;</span>
	
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">fifo_len</span><span class="c">;</span>
	
	<span class="c">u32</span> <span class="w">max_freq</span><span class="c">;</span>
	
	<span class="w">e</span><span class="c">num</span> <span class="w">rockchip_ssi_type</span> <span class="c">type;</span>

	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">m</span><span class="pc">o</span><span class="c">de;</span>
	<span class="pc">u8</span> <span class="w">tmode</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">bpw</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">n_bytes</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">rsd_nsecs</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="w">l</span><span class="pc">e</span><span class="c">n;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">s</span><span class="pc">p</span><span class="c">eed;</span>

	<span class="w">c</span><span class="pc">o</span><span class="c">nst</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">tx</span><span class="c">;</span>
	<span class="w">c</span><span class="c">onst</span> <span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">tx_end</span><span class="c">;</span>
	<span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">r</span><span class="pc">x</span><span class="c">;</span>
	<span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">rx_end</span><span class="c">;</span>

	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">s</span><span class="pc">t</span><span class="c">ate;</span>
	
	<span class="w">s</span><span class="pc">p</span><span class="c">inlock_t</span> <span class="c">lock;</span>

	<span class="pc">s</span><span class="c">truct</span> <span class="w">c</span><span class="c">ompletion</span> <span class="w">xfer_completion</span><span class="c">;</span>

	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">use_dma</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">sg_table</span> <span class="w">tx_sg</span><span class="c">;</span>
	<span class="c">struct</span> <span class="c">sg_table</span> <span class="w">rx_sg</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">rockchip_spi_dma_data</span> <span class="w">dma_rx</span><span class="c">;</span>
	<span class="c">struct</span> <span class="c">rockchip_spi_dma_data</span> <span class="w">dma_tx</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">spi_enable_chip</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="pc">n</span><span class="c">able)</span>
<span class="c">{</span>
	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed</span><span class="pc">((</span><span class="w">en</span><span class="pc">a</span><span class="c">ble</span> <span class="w">?</span> <span class="c">1</span> <span class="c">:</span> <span class="c">0</span><span class="w">)</span><span class="pc">,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">reg</span><span class="pc">s</span> <span class="pc">+</span> <span class="w">ROCKCHIP_SPI_SSIENR</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">spi_set_clk</span><span class="c">(struct</span> <span class="c">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="c">,</span> <span class="pc">u1</span><span class="c">6</span> <span class="w">di</span><span class="pc">v)</span>
<span class="c">{</span>
	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed(</span><span class="w">d</span><span class="pc">i</span><span class="c">v,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_BAUDR</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">flush_fifo</span><span class="c">(struct</span> <span class="c">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">readl_relaxed</span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">egs</span> <span class="pc">+</span> <span class="w">ROCKCHIP_SPI_RXFLR</span><span class="pc">))</span>
		<span class="w">r</span><span class="pc">ea</span><span class="c">dl_relaxed(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_RXDR</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="c">void</span> <span class="w">wait_for_idle</span><span class="c">(struct</span> <span class="c">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="pc">t</span><span class="c">imeout</span> <span class="pc">=</span> <span class="pc">j</span><span class="c">iffies</span> <span class="c">+</span> <span class="pc">m</span><span class="c">secs_to_jiffies(</span><span class="w">5</span><span class="c">);</span>

	<span class="w">d</span><span class="c">o</span> <span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">r</span><span class="pc">eadl_</span><span class="c">relaxed</span><span class="w">(rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="c">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_SR</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">SR_BUSY</span><span class="pc">))</span>
			<span class="c">return;</span>
	<span class="c">}</span> <span class="pc">w</span><span class="c">hile</span> <span class="pc">(!</span><span class="w">time_after</span><span class="c">(</span><span class="w">j</span><span class="c">iffies,</span> <span class="c">timeout</span><span class="w">)</span><span class="pc">);</span>

	<span class="w">d</span><span class="pc">ev_w</span><span class="c">arn(</span><span class="w">rs</span><span class="c">-&gt;dev, "</span><span class="w">spi</span> <span class="w">co</span><span class="pc">n</span><span class="c">troller</span> <span class="w">i</span><span class="c">s</span> <span class="w">i</span><span class="c">n</span> <span class="pc">b</span><span class="c">usy</span> <span class="w">s</span><span class="pc">t</span><span class="c">ate</span><span class="w">!</span><span class="c">\n");</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">get_fifo_len</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">fi</span><span class="pc">f</span><span class="c">o</span><span class="pc">;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">f</span><span class="pc">i</span><span class="c">fo</span> <span class="c">=</span> <span class="w">2</span><span class="c">;</span> <span class="w">f</span><span class="pc">i</span><span class="c">fo</span> <span class="c">&lt;</span> <span class="w">3</span><span class="pc">2</span><span class="c">;</span> <span class="w">f</span><span class="pc">i</span><span class="c">fo++) {</span>
		<span class="w">wr</span><span class="pc">itel_</span><span class="c">relaxed(</span><span class="w">f</span><span class="c">ifo,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_TXFTLR</span><span class="c">);</span>
		<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">f</span><span class="c">ifo</span> <span class="w">!</span><span class="c">=</span> <span class="w">readl_relaxed</span><span class="pc">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="pc">re</span><span class="c">gs</span> <span class="c">+</span> <span class="c">ROCKCHIP_SPI_TXFTLR))</span>
			<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">}</span>

	<span class="w">wr</span><span class="pc">itel_</span><span class="c">relaxed(</span><span class="w">0</span><span class="c">,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs</span> <span class="c">+</span> <span class="c">ROCKCHIP_SPI_TXFTLR);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">(</span><span class="w">f</span><span class="pc">i</span><span class="c">fo</span> <span class="w">=</span><span class="c">=</span> <span class="w">3</span><span class="pc">1</span><span class="c">) ?</span> <span class="c">0</span> <span class="c">:</span> <span class="w">f</span><span class="pc">i</span><span class="c">fo</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="pc">u</span><span class="c">32</span> <span class="w">tx_max</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">tx_left</span><span class="pc">,</span> <span class="w">tx_room</span><span class="c">;</span>

	<span class="w">t</span><span class="pc">x_l</span><span class="c">eft</span> <span class="pc">= </span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">tx_end</span> <span class="pc">-</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">tx) </span><span class="pc">/</span> <span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n_bytes</span><span class="c">;</span>
	<span class="w">t</span><span class="pc">x_r</span><span class="c">oom</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">fifo_len</span> <span class="pc">-</span> <span class="w">readl_relaxed</span><span class="pc">(</span><span class="c">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">reg</span><span class="pc">s</span> <span class="pc">+</span> <span class="w">ROCKCHIP_SPI_TXFLR</span><span class="c">);</span>

	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">m</span><span class="pc">i</span><span class="c">n(</span><span class="pc">t</span><span class="c">x_left</span><span class="pc">,</span> <span class="c">tx_room</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">rx_max</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">r</span><span class="pc">s)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">rx_left</span> <span class="pc">= </span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">rx_end</span> <span class="pc">-</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">x</span><span class="w">) </span><span class="pc">/</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">n_bytes</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">rx_room</span> <span class="pc">= </span><span class="c">(u32</span><span class="pc">)</span><span class="w">readl_relaxed</span><span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">reg</span><span class="pc">s</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_RXFLR</span><span class="c">);</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">m</span><span class="pc">i</span><span class="c">n(</span><span class="pc">rx_l</span><span class="c">eft,</span> <span class="c">rx_room</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rockchip_spi_set_cs</span><span class="c">(struct</span> <span class="w">spi_device</span> <span class="c">*</span><span class="w">sp</span><span class="pc">i</span><span class="c">,</span> <span class="w">b</span><span class="c">ool</span> <span class="c">enable)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">32</span> <span class="w">ser</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="pc">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">sp</span><span class="pc">i-</span><span class="c">&gt;</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter);</span>

	<span class="w">s</span><span class="pc">e</span><span class="c">r</span> <span class="c">=</span> <span class="w">readl_relaxed</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">re</span><span class="pc">gs</span> <span class="pc">+</span> <span class="w">ROCKCHIP_SPI_SER</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">SER_MASK</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">e</span><span class="pc">n</span><span class="c">able)</span>
		<span class="pc">s</span><span class="c">er</span> <span class="pc">|</span><span class="c">=</span> <span class="c">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">sp</span><span class="pc">i</span><span class="c">-&gt;</span><span class="w">chip_select</span><span class="c">;</span>
	<span class="c">else</span>
		<span class="w">s</span><span class="c">er</span> <span class="w">&amp;</span><span class="pc">= ~(</span><span class="c">1</span> <span class="c">&lt;&lt;</span> <span class="w">sp</span><span class="pc">i</span><span class="c">-&gt;</span><span class="pc">c</span><span class="c">hip_select);</span>

	<span class="w">wr</span><span class="pc">itel_</span><span class="c">relaxed(ser</span><span class="pc">,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs</span> <span class="c">+</span> <span class="pc">R</span><span class="c">OCKCHIP_SPI_SER);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rockchip_spi_prepare_message</span><span class="c">(struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter,</span>
					<span class="pc">s</span><span class="c">truct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">m</span><span class="pc">s</span><span class="c">g)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter);</span>
	<span class="c">struct</span> <span class="w">spi_device</span> <span class="c">*</span><span class="w">sp</span><span class="pc">i</span> <span class="c">=</span> <span class="w">m</span><span class="pc">s</span><span class="c">g-&gt;</span><span class="pc">s</span><span class="c">pi;</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">o</span><span class="c">de</span> <span class="c">=</span> <span class="w">s</span><span class="pc">p</span><span class="c">i-&gt;</span><span class="w">m</span><span class="pc">o</span><span class="c">de;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rockchip_spi_handle_err</span><span class="c">(struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter</span><span class="pc">,</span>
				    <span class="c">struct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">as</span><span class="c">ter);</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">use_dma</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="pc">&amp;</span> <span class="w">RXBUSY</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">dmaengine_terminate_all</span><span class="c">(</span><span class="pc">rs-</span><span class="c">&gt;</span><span class="w">dma_rx.c</span><span class="pc">h)</span><span class="c">;</span>
			<span class="w">flush_fifo</span><span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">);</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="pc">&amp;</span> <span class="w">TXBUSY</span><span class="pc">)</span>
			<span class="pc">d</span><span class="c">maengine_terminate_all(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">dma_tx</span><span class="pc">.</span><span class="w">c</span><span class="pc">h</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">rockchip_spi_unprepare_message</span><span class="c">(struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">ma</span><span class="c">ster,</span>
					  <span class="c">struct</span> <span class="w">spi_message</span> <span class="c">*</span><span class="w">m</span><span class="pc">s</span><span class="c">g)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">ma</span><span class="c">ster);</span>

	<span class="w">spi_enable_chip</span><span class="c">(</span><span class="w">rs</span><span class="pc">,</span> <span class="c">0);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rockchip_spi_pio_writer</span><span class="c">(struct</span> <span class="pc">r</span><span class="c">ockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">m</span><span class="pc">ax</span> <span class="c">=</span> <span class="w">tx_max</span><span class="c">(</span><span class="w">rs</span><span class="c">);</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">txw</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">ma</span><span class="c">x</span><span class="pc">-</span><span class="c">-) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">n_bytes</span> <span class="c">==</span> <span class="pc">1)</span>
			<span class="pc">t</span><span class="c">xw</span> <span class="w">= *</span><span class="pc">(</span><span class="w">u</span><span class="pc">8</span> <span class="pc">*)(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">tx</span><span class="c">);</span>
		<span class="c">else</span>
			<span class="pc">t</span><span class="c">xw</span> <span class="w">= *</span><span class="pc">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="pc">*)(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tx);</span>

		<span class="w">wr</span><span class="pc">itel_</span><span class="c">relaxed(txw,</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">re</span><span class="pc">g</span><span class="c">s</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_TXDR</span><span class="c">);</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">x</span> <span class="pc">+</span><span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">_bytes;</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rockchip_spi_pio_reader</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">r</span><span class="pc">s)</span>
<span class="c">{</span>
	<span class="pc">u3</span><span class="c">2</span> <span class="w">m</span><span class="pc">ax</span> <span class="c">=</span> <span class="w">rx_max</span><span class="c">(</span><span class="w">r</span><span class="pc">s)</span><span class="c">;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">rxw</span><span class="pc">;</span>

	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">ma</span><span class="c">x</span><span class="w">-</span><span class="c">-) {</span>
		<span class="w">r</span><span class="pc">xw</span> <span class="c">=</span> <span class="w">readl_relaxed</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">re</span><span class="pc">gs</span> <span class="pc">+</span> <span class="w">ROCKCHIP_SPI_RXDR</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">n_bytes</span> <span class="c">==</span> <span class="pc">1</span><span class="c">)</span>
			<span class="w">*</span><span class="pc">(</span><span class="w">u</span><span class="pc">8</span> <span class="pc">*)(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">rx) = (u</span><span class="pc">8)</span><span class="c">rxw</span><span class="w">;</span>
		<span class="c">else</span>
			<span class="w">*</span><span class="pc">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="pc">*)(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">rx) =</span><span class="pc"> </span><span class="c">(</span><span class="w">u</span><span class="pc">1</span><span class="c">6)</span><span class="pc">r</span><span class="c">xw</span><span class="pc">;</span>
		<span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">x</span> <span class="w">+</span><span class="pc">=</span> <span class="w">r</span><span class="pc">s-</span><span class="c">&gt;n_bytes;</span>
	<span class="c">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">rockchip_spi_pio_transfer</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">r</span><span class="pc">s)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">remain</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tx)</span><span class="c"> {</span>
			<span class="pc">r</span><span class="c">emain</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tx_end</span> <span class="w">-</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">x</span><span class="c">;</span>
			<span class="w">rockchip_spi_pio_writer</span><span class="c">(</span><span class="pc">rs)</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">rx)</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">r</span><span class="c">emain</span> <span class="c">=</span> <span class="pc">rs</span><span class="c">-&gt;</span><span class="w">rx_end</span> <span class="w">-</span> <span class="pc">r</span><span class="c">s-&gt;</span><span class="w">r</span><span class="pc">x;</span>
			<span class="w">rockchip_spi_pio_reader</span><span class="c">(</span><span class="pc">r</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="w">cpu_relax()</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">r</span><span class="pc">e</span><span class="c">main</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">x</span><span class="w">)</span>
		<span class="w">wait_for_idle</span><span class="c">(</span><span class="pc">r</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">spi_enable_chip</span><span class="c">(</span><span class="pc">r</span><span class="c">s</span><span class="pc">,</span> <span class="w">0</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rockchip_spi_dma_rxcb</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">d</span><span class="c">ata</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">ns</span><span class="c">igned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">r</span><span class="pc">s</span> <span class="pc">=</span> <span class="w">d</span><span class="c">ata;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">state</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">RXBUSY</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">&amp;</span> <span class="w">TXBUSY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">spi_enable_chip</span><span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="w">spi_finalize_current_transfer</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">ma</span><span class="pc">st</span><span class="c">er</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rockchip_spi_dma_txcb</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*data</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">ns</span><span class="c">igned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">r</span><span class="pc">s</span> <span class="pc">=</span> <span class="pc">d</span><span class="c">ata;</span>

	
	<span class="w">wait_for_idle</span><span class="c">(</span><span class="w">rs</span><span class="c">);</span>

	<span class="pc">sp</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>

	<span class="w">rs</span><span class="c">-&gt;state</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">TXBUSY</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="c">&amp;</span> <span class="w">RXBUSY</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">spi_enable_chip</span><span class="c">(</span><span class="pc">r</span><span class="c">s,</span> <span class="c">0);</span>
		<span class="w">spi_finalize_current_transfer</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">mas</span><span class="pc">t</span><span class="c">er</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rockchip_spi_prepare_dma</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">dma_slave_config</span> <span class="w">rxconf</span><span class="pc">,</span> <span class="w">txconf</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">dma_async_tx_descriptor</span> <span class="c">*</span><span class="w">rxdesc</span><span class="pc">,</span><span class="c"> *</span><span class="w">txdesc</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">pin_</span><span class="c">lock_irqsave(&amp;</span><span class="w">rs</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">RXBUSY</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;state</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">TXBUSY</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>

	<span class="w">r</span><span class="pc">x</span><span class="c">desc</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">rx)</span><span class="c"> {</span>
		<span class="w">rxconf.d</span><span class="pc">i</span><span class="c">rection</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">dma_rx</span><span class="pc">.</span><span class="w">d</span><span class="pc">i</span><span class="c">rection;</span>
		<span class="c">rxconf</span><span class="pc">.</span><span class="w">src_addr</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">d</span><span class="c">ma_rx.</span><span class="w">ad</span><span class="c">dr;</span>
		<span class="pc">r</span><span class="c">xconf</span><span class="pc">.</span><span class="w">src_addr_width</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">n_bytes</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">xconf.</span><span class="w">src_maxburst</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">n</span><span class="c">_bytes;</span>
		<span class="w">dmaengine_slave_config</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;dma_rx.</span><span class="w">ch</span><span class="pc">, </span><span class="c">&amp;rxconf</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">rxdesc</span> <span class="pc">=</span> <span class="w">dmaengine_prep_slave_sg</span><span class="c">(</span>
				<span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="pc">d</span><span class="c">ma_rx.</span><span class="w">c</span><span class="pc">h,</span>
				<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">rx_sg</span><span class="pc">.</span><span class="w">sg</span><span class="pc">l</span><span class="c">,</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">rx_</span><span class="c">sg.</span><span class="w">nents</span><span class="pc">,</span>
				<span class="pc">r</span><span class="c">s-&gt;</span><span class="pc">d</span><span class="c">ma_rx.</span><span class="w">di</span><span class="c">rection</span><span class="pc">,</span> <span class="w">DMA_PREP_INTERRUPT</span><span class="c">);</span>

		<span class="pc">rx</span><span class="c">desc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cal</span><span class="pc">lb</span><span class="c">ack</span> <span class="c">=</span> <span class="w">rockchip_spi_dma_rxcb</span><span class="c">;</span>
		<span class="pc">rx</span><span class="c">desc-&gt;</span><span class="w">callback_param</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s;</span>
	<span class="c">}</span>

	<span class="w">txdesc</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">tx)</span><span class="c"> {</span>
		<span class="w">txconf.di</span><span class="c">rection</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">dma_tx</span><span class="pc">.</span><span class="w">di</span><span class="pc">re</span><span class="c">ction;</span>
		<span class="c">txconf.</span><span class="w">dst_addr</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">dm</span><span class="c">a_tx.</span><span class="w">ad</span><span class="pc">dr</span><span class="c">;</span>
		<span class="pc">t</span><span class="c">xconf.</span><span class="w">dst_addr_width</span> <span class="c">=</span> <span class="w">r</span><span class="c">s-&gt;</span><span class="w">n_bytes</span><span class="c">;</span>
		<span class="pc">t</span><span class="c">xconf.</span><span class="w">dst_maxburst</span> <span class="c">=</span> <span class="w">r</span><span class="c">s-&gt;</span><span class="pc">n</span><span class="c">_bytes;</span>
		<span class="w">dmaengine_slave_config</span><span class="c">(</span><span class="w">r</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;dma_tx.</span><span class="w">ch</span><span class="pc">, </span><span class="c">&amp;txconf</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">txdesc</span> <span class="pc">=</span> <span class="w">dmaengine_prep_slave_sg</span><span class="c">(</span>
				<span class="w">r</span><span class="c">s</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">d</span><span class="c">ma_tx.</span><span class="w">c</span><span class="pc">h,</span>
				<span class="w">r</span><span class="c">s-&gt;</span><span class="w">tx_sg</span><span class="pc">.</span><span class="w">sg</span><span class="pc">l</span><span class="c">,</span> <span class="w">r</span><span class="c">s-&gt;</span><span class="pc">tx_</span><span class="c">sg.</span><span class="w">nents</span><span class="pc">,</span>
				<span class="pc">r</span><span class="c">s-&gt;</span><span class="pc">d</span><span class="c">ma_tx.</span><span class="w">di</span><span class="c">rection</span><span class="pc">,</span> <span class="w">DMA_PREP_INTERRUPT</span><span class="c">);</span>

		<span class="pc">t</span><span class="c">xdesc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cal</span><span class="pc">lb</span><span class="c">ack</span> <span class="c">=</span> <span class="w">rockchip_spi_dma_txcb</span><span class="c">;</span>
		<span class="pc">t</span><span class="c">xdesc-&gt;</span><span class="w">callback_param</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rxdesc)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">sp</span><span class="pc">in_lock_i</span><span class="c">rqsave(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
		<span class="w">rs</span><span class="c">-&gt;</span><span class="w">s</span><span class="c">tate</span> <span class="pc">|</span><span class="c">=</span> <span class="w">RXBUSY</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
		<span class="w">dmaengine_submit</span><span class="c">(</span><span class="w">r</span><span class="c">xdesc);</span>
		<span class="w">dma_async_issue_pending</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">dma_rx</span><span class="pc">.</span><span class="w">ch</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">txdesc</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">pin_l</span><span class="c">ock_irqsave(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
		<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">tate</span> <span class="pc">|</span><span class="c">=</span> <span class="w">TXBUSY</span><span class="c">;</span>
		<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
		<span class="w">d</span><span class="pc">mae</span><span class="c">ngine_submit</span><span class="pc">(t</span><span class="c">xdesc);</span>
		<span class="w">d</span><span class="pc">ma_a</span><span class="c">sync_issue_pending</span><span class="pc">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">dma_tx</span><span class="pc">.</span><span class="w">ch</span><span class="c">);</span>
	<span class="pc">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">rockchip_spi_config</span><span class="c">(struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">di</span><span class="pc">v</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">dmacr</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">rsd</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="c">u32</span> <span class="w">cr0</span> <span class="pc">= </span><span class="c">(</span><span class="w">CR0_BHT_8BIT</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">CR0_BHT_OFFSET)</span>
		<span class="w">|</span><span class="c"> (</span><span class="w">CR0_SSD_ONE</span> <span class="c">&lt;&lt;</span> <span class="w">CR0_SSD_OFFSET</span><span class="pc">);</span>

	<span class="w">c</span><span class="pc">r</span><span class="c">0</span> <span class="pc">|= </span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n_bytes</span> <span class="c">&lt;&lt;</span> <span class="w">CR0_DFS_OFFSET</span><span class="c">);</span>
	<span class="pc">c</span><span class="c">r0</span> <span class="w">|= ((rs</span><span class="c">-&gt;</span><span class="w">m</span><span class="pc">o</span><span class="c">de</span> <span class="pc">&amp;</span> <span class="w">0x3</span><span class="c">) &lt;&lt;</span> <span class="w">CR0_SCPH_OFFSET</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">c</span><span class="c">r0</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">tmode</span> <span class="c">&lt;&lt;</span> <span class="w">CR0_XFM_OFFSET</span><span class="pc">);</span>
	<span class="c">cr0</span> <span class="pc">|= </span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ty</span><span class="c">pe</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">CR0_FRF_OFFSET</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">use_dma</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tx)</span>
			<span class="w">dmacr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">TF_DMA_EN</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">s-&gt;</span><span class="w">rx</span><span class="pc">)</span>
			<span class="pc">d</span><span class="c">macr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">RF_DMA_EN</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">W</span><span class="c">ARN_ON(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">sp</span><span class="c">eed</span> <span class="w">&gt;</span> <span class="w">MAX_SCLK_OUT</span><span class="pc">))</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">sp</span><span class="c">eed</span> <span class="c">=</span> <span class="w">M</span><span class="c">AX_SCLK_OUT;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">max_freq</span> <span class="pc">&lt;</span> <span class="w">2</span> <span class="w">*</span> <span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">sp</span><span class="c">eed</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">clk_set_rate</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">spiclk</span><span class="c">,</span> <span class="w">2</span> <span class="pc">*</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">sp</span><span class="pc">e</span><span class="c">ed);</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">ax_freq</span> <span class="c">=</span> <span class="w">clk_get_rate</span><span class="c">(</span><span class="w">r</span><span class="c">s-&gt;</span><span class="w">s</span><span class="pc">p</span><span class="c">iclk);</span>
	<span class="c">}</span>

	
	<span class="w">di</span><span class="c">v</span> <span class="c">=</span> <span class="w">DIV_ROUND_UP</span><span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">ax_freq,</span> <span class="w">r</span><span class="c">s-&gt;</span><span class="w">sp</span><span class="pc">e</span><span class="c">ed);</span>
	<span class="w">di</span><span class="c">v</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">d</span><span class="c">iv</span> <span class="w">+</span> <span class="c">1</span><span class="pc">) &amp;</span> <span class="w">0xfffe</span><span class="c">;</span>

	
	<span class="w">rsd</span> <span class="pc">=</span> <span class="w">DIV_ROUND_CLOSEST</span><span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">rsd_nsecs</span> <span class="w">*</span><span class="pc"> </span><span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">ax_freq</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="pc">8</span><span class="w">),</span>
				<span class="w">1000000000</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="c">8</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">rsd</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;rsd_nsecs</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">pr_warn_once</span><span class="pc">("</span><span class="w">rockchip</span><span class="pc">-</span><span class="w">spi</span><span class="pc">: </span><span class="c">%</span><span class="pc">u</span> <span class="w">Hz</span> <span class="w">ar</span><span class="pc">e</span> <span class="w">t</span><span class="pc">o</span><span class="c">o</span> <span class="w">slow</span> <span class="w">t</span><span class="c">o</span> <span class="w">express</span> <span class="pc">%u</span> <span class="w">ns</span> <span class="w">del</span><span class="c">ay</span><span class="pc">\</span><span class="c">n",</span>
			     <span class="w">rs</span><span class="c">-&gt;</span><span class="w">m</span><span class="c">ax_freq</span><span class="pc">,</span> <span class="w">rs</span><span class="c">-&gt;rsd_nsecs);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">sd</span> <span class="pc">&gt;</span> <span class="w">3</span><span class="c">) {</span>
		<span class="w">rs</span><span class="pc">d</span> <span class="c">=</span> <span class="pc">3</span><span class="c">;</span>
		<span class="w">p</span><span class="pc">r_w</span><span class="c">arn_once</span><span class="pc">("</span><span class="w">r</span><span class="pc">o</span><span class="c">ckchip</span><span class="w">-spi:</span><span class="pc"> </span><span class="c">%</span><span class="pc">u</span> <span class="w">H</span><span class="c">z</span> <span class="w">ar</span><span class="c">e</span> <span class="w">t</span><span class="pc">oo</span> <span class="w">fast</span> <span class="w">t</span><span class="c">o</span> <span class="w">e</span><span class="pc">x</span><span class="c">press</span> <span class="c">%</span><span class="pc">u</span> <span class="w">ns</span> <span class="w">d</span><span class="pc">e</span><span class="c">lay</span><span class="w">,</span> <span class="w">clamping</span> <span class="w">a</span><span class="pc">t</span> <span class="pc">%u</span> <span class="w">ns</span><span class="pc">\</span><span class="c">n",</span>
			     <span class="w">rs</span><span class="c">-&gt;</span><span class="w">max_freq</span><span class="c">,</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">rsd_nsecs</span><span class="c">,</span>
			     <span class="c">rsd</span> <span class="w">*</span> <span class="w">1000000000U</span> <span class="w">/</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">ax_freq</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">cr0</span> <span class="w">|</span><span class="c">=</span> <span class="pc">rsd</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">CR0_RSD_OFFSET</span><span class="c">;</span>

	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed(cr0,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_CTRLR0</span><span class="c">);</span>

	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">l</span><span class="pc">en</span> <span class="w">-</span> <span class="c">1</span><span class="pc">,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_CTRLR1</span><span class="c">);</span>
	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">fifo_len</span> <span class="w">/</span> <span class="w">2</span> <span class="pc">-</span> <span class="c">1</span><span class="pc">,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">e</span><span class="c">gs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_TXFTLR</span><span class="c">);</span>
	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">f</span><span class="c">ifo_len</span> <span class="w">/</span> <span class="w">2</span> <span class="pc">-</span> <span class="c">1</span><span class="pc">,</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">r</span><span class="c">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_RXFTLR</span><span class="c">);</span>

	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed(0,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_DMATDLR</span><span class="c">);</span>
	<span class="w">w</span><span class="pc">ritel_</span><span class="c">relaxed(0,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_DMARDLR</span><span class="c">);</span>
	<span class="pc">writel_</span><span class="c">relaxed(</span><span class="w">dmacr</span><span class="c">,</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_DMACR</span><span class="c">);</span>

	<span class="w">spi_set_clk</span><span class="c">(</span><span class="w">rs</span><span class="pc">,</span> <span class="w">d</span><span class="pc">i</span><span class="c">v);</span>

	<span class="w">d</span><span class="pc">e</span><span class="c">v_dbg(</span><span class="w">rs</span><span class="c">-&gt;dev, "</span><span class="w">cr0</span> <span class="w">0</span><span class="c">x%</span><span class="pc">x,</span> <span class="w">di</span><span class="pc">v</span> <span class="c">%d\n",</span> <span class="w">cr</span><span class="c">0</span><span class="pc">,</span> <span class="w">d</span><span class="pc">i</span><span class="c">v);</span>
<span class="pc">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rockchip_spi_transfer_one</span><span class="c">(</span>
		<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">ma</span><span class="pc">st</span><span class="c">er,</span>
		<span class="c">struct</span> <span class="w">spi_device</span> <span class="c">*</span><span class="w">sp</span><span class="pc">i,</span>
		<span class="c">struct</span> <span class="w">spi_transfer</span> <span class="c">*</span><span class="w">x</span><span class="pc">f</span><span class="c">er)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="c">ret</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="pc">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>

	<span class="w">W</span><span class="c">ARN_ON(</span><span class="w">readl_relaxed</span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">egs</span> <span class="pc">+</span> <span class="w">ROCKCHIP_SPI_SSIENR) </span><span class="pc">&amp;&amp;</span>
		<span class="c">(</span><span class="pc">re</span><span class="c">adl_relaxed</span><span class="pc">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">egs</span> <span class="pc">+</span> <span class="w">ROCKCHIP_SPI_SR</span><span class="pc">) </span><span class="c">&amp;</span> <span class="w">SR_BUSY))</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">x</span><span class="pc">f</span><span class="c">er</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tx_buf</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">x</span><span class="pc">f</span><span class="c">er-&gt;</span><span class="w">rx_buf</span><span class="c">) {</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(</span><span class="w">rs</span><span class="c">-&gt;dev, "</span><span class="w">N</span><span class="c">o</span> <span class="w">b</span><span class="pc">uf</span><span class="c">fer</span> <span class="pc">f</span><span class="c">or</span> <span class="w">transfer</span><span class="c">\n");</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>
	<span class="c">}</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">sp</span><span class="pc">e</span><span class="c">ed</span> <span class="c">=</span> <span class="w">x</span><span class="pc">f</span><span class="c">er</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">speed_hz</span><span class="c">;</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">bpw</span> <span class="c">=</span> <span class="w">x</span><span class="pc">f</span><span class="c">er</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bits_per_word</span><span class="c">;</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">n_bytes</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">b</span><span class="c">pw</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="pc">3</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">x</span> <span class="pc">=</span> <span class="w">x</span><span class="pc">f</span><span class="c">er</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tx_buf</span><span class="c">;</span>
	<span class="w">r</span><span class="c">s-&gt;</span><span class="w">tx_end</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">x</span> <span class="pc">+</span> <span class="w">x</span><span class="pc">f</span><span class="c">er-&gt;</span><span class="pc">l</span><span class="c">en;</span>
	<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">x</span> <span class="c">=</span> <span class="w">x</span><span class="pc">f</span><span class="c">er</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rx_buf</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">rx_end</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">rx</span> <span class="w">+</span> <span class="w">x</span><span class="pc">f</span><span class="c">er-&gt;</span><span class="pc">l</span><span class="c">en;</span>
	<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;len</span> <span class="c">=</span> <span class="w">x</span><span class="pc">f</span><span class="c">er-&gt;len;</span>

	<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tx_sg</span> <span class="c">=</span> <span class="w">x</span><span class="pc">f</span><span class="c">er-&gt;tx_sg;</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">rx_sg</span> <span class="c">=</span> <span class="w">x</span><span class="pc">f</span><span class="c">er-&gt;rx_sg;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">x</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">r</span><span class="pc">x)</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tmode</span> <span class="c">=</span> <span class="w">CR0_XFM_TR</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">tx</span><span class="pc">)</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;tmode</span> <span class="c">=</span> <span class="w">CR0_XFM_TO</span><span class="c">;</span>
	<span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">rx</span><span class="c">)</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">t</span><span class="c">mode</span> <span class="c">=</span> <span class="w">CR0_XFM_RO</span><span class="c">;</span>

	
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter-&gt;</span><span class="w">can_dma</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">ma</span><span class="pc">s</span><span class="c">ter-&gt;can_dma</span><span class="w">(ma</span><span class="pc">s</span><span class="c">ter</span><span class="pc">,</span> <span class="w">spi</span><span class="pc">,</span> <span class="w">x</span><span class="pc">f</span><span class="c">er</span><span class="pc">))</span>
		<span class="w">rs</span><span class="c">-&gt;</span><span class="w">use_dma</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">rs</span><span class="c">-&gt;use_dma</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">rockchip_spi_config</span><span class="c">(</span><span class="w">r</span><span class="pc">s)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">u</span><span class="c">se_dma</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">rs</span><span class="c">-&gt;</span><span class="w">tmode</span> <span class="c">==</span> <span class="w">CR0_XFM_RO</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="w">rockchip_spi_prepare_dma</span><span class="c">(</span><span class="w">r</span><span class="c">s</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">spi_enable_chip</span><span class="c">(</span><span class="pc">r</span><span class="c">s</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			
			<span class="w">s</span><span class="c">pi_enable_chip(</span><span class="w">r</span><span class="pc">s</span><span class="c">,</span> <span class="pc">1)</span><span class="c">;</span>
			<span class="w">r</span><span class="pc">ockchip_spi_p</span><span class="c">repare_dma(</span><span class="pc">rs</span><span class="c">);</span>
		<span class="c">}</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">s</span><span class="pc">p</span><span class="c">i_enable_chip(</span><span class="w">r</span><span class="pc">s</span><span class="c">,</span> <span class="pc">1</span><span class="c">);</span>
		<span class="w">re</span><span class="pc">t</span> <span class="c">=</span> <span class="w">rockchip_spi_pio_transfer</span><span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">b</span><span class="c">ool</span> <span class="w">rockchip_spi_can_dma</span><span class="c">(struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter</span><span class="pc">,</span>
				 <span class="c">struct</span> <span class="w">spi_device</span> <span class="c">*</span><span class="w">sp</span><span class="pc">i,</span>
				 <span class="c">struct</span> <span class="w">spi_transfer</span> <span class="c">*</span><span class="w">x</span><span class="pc">f</span><span class="c">er)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">(</span><span class="w">x</span><span class="pc">f</span><span class="c">er-&gt;</span><span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="w">&gt;</span> <span class="w">rs</span><span class="c">-&gt;</span><span class="w">fifo_len</span><span class="c">);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">rockchip_spi_probe</span><span class="c">(struct</span> <span class="w">p</span><span class="c">latform_device</span> <span class="c">*pdev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">m</span><span class="c">aster;</span>
	<span class="c">struct</span> <span class="pc">r</span><span class="c">esource</span> <span class="c">*</span><span class="w">m</span><span class="pc">e</span><span class="c">m;</span>
	<span class="pc">u3</span><span class="c">2</span> <span class="w">rsd_nsecs</span><span class="c">;</span>

	<span class="w">ma</span><span class="pc">st</span><span class="c">er</span> <span class="c">=</span> <span class="w">spi_alloc_master</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev,</span> <span class="c">sizeof(struct</span> <span class="pc">r</span><span class="c">ockchip_spi</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">m</span><span class="pc">as</span><span class="c">ter)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="w">p</span><span class="pc">l</span><span class="c">atform_set_drvdata(pdev,</span> <span class="w">m</span><span class="c">aster);</span>

	<span class="w">rs</span> <span class="pc">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter);</span>
	<span class="w">me</span><span class="c">mset(</span><span class="w">rs</span><span class="c">,</span> <span class="c">0,</span> <span class="c">sizeof(struct</span> <span class="c">rockchip_spi));</span>

	
	<span class="w">me</span><span class="pc">m</span> <span class="pc">=</span> <span class="pc">p</span><span class="c">latform_get_resource(pdev,</span> <span class="c">IORESOURCE_MEM,</span> <span class="c">0);</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs</span> <span class="pc">=</span> <span class="w">devm_ioremap_resource</span><span class="c">(&amp;pdev-&gt;dev,</span> <span class="w">m</span><span class="pc">e</span><span class="c">m);</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="pc">re</span><span class="c">gs</span><span class="pc">)) </span><span class="c">{</span>
		<span class="c">ret</span> <span class="c">=</span>  <span class="c">PTR_ERR(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">egs);</span>
		<span class="c">goto</span> <span class="w">err_ioremap_resource</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">apb_pclk</span> <span class="c">=</span> <span class="w">devm_clk_get</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev</span><span class="pc">, </span><span class="c">"</span><span class="pc">a</span><span class="c">pb_pclk");</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="w">rs</span><span class="c">-&gt;apb_pclk)) {</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev, "</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">g</span><span class="c">et</span> <span class="pc">a</span><span class="c">pb_pclk\n");</span>
		<span class="pc">ret</span> <span class="pc">=</span> <span class="c">PTR_ERR(</span><span class="w">rs</span><span class="c">-&gt;apb_pclk);</span>
		<span class="c">goto</span> <span class="w">err_ioremap_resource</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">spiclk</span> <span class="c">=</span> <span class="w">devm_clk_get</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev</span><span class="pc">, </span><span class="c">"spiclk");</span>
	<span class="c">if</span> <span class="c">(IS_ERR(</span><span class="w">rs</span><span class="c">-&gt;spiclk)) {</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev, "</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">g</span><span class="c">et</span> <span class="w">spi_pclk</span><span class="c">\n");</span>
		<span class="pc">ret</span> <span class="pc">=</span> <span class="c">PTR_ERR(</span><span class="w">rs</span><span class="c">-&gt;spiclk);</span>
		<span class="c">goto</span> <span class="w">err_ioremap_resource</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">ret</span> <span class="c">=</span> <span class="w">clk_prepare_enable</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">apb_pclk</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret) {</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev, "</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">e</span><span class="c">nable</span> <span class="pc">a</span><span class="c">pb_pclk\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">err_</span><span class="c">ioremap_resource;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">c</span><span class="c">lk_prepare_enable(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">spiclk</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret) {</span>
		<span class="c">dev_err(&amp;</span><span class="pc">p</span><span class="c">dev-&gt;dev, "</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">e</span><span class="c">nable</span> <span class="w">spi_clk</span><span class="c">\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">err_spiclk_enable</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">spi_enable_chip</span><span class="c">(</span><span class="w">rs</span><span class="pc">,</span> <span class="c">0);</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">SSI_MOTO_SPI</span><span class="c">;</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">ma</span><span class="pc">st</span><span class="c">er</span> <span class="c">=</span> <span class="w">ma</span><span class="pc">st</span><span class="c">er;</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">d</span><span class="c">ev</span> <span class="pc">= </span><span class="c">&amp;pdev-&gt;dev;</span>
	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">max_freq</span> <span class="c">=</span> <span class="w">clk_get_rate</span><span class="pc">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">spiclk</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">of_property_read_u32</span><span class="c">(</span><span class="w">pd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="pc">.</span><span class="c">of_node</span><span class="pc">, </span><span class="c">"</span><span class="w">rx</span><span class="c">-</span><span class="w">sa</span><span class="c">mple-</span><span class="w">d</span><span class="pc">el</span><span class="c">ay</span><span class="pc">-</span><span class="w">ns</span><span class="pc">",</span>
				  <span class="pc">&amp;</span><span class="w">rsd_nsecs</span><span class="pc">))</span>
		<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">r</span><span class="c">sd_nsecs</span> <span class="pc">=</span> <span class="w">r</span><span class="c">sd_nsecs;</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">fifo_len</span> <span class="c">=</span> <span class="w">get_fifo_len</span><span class="pc">(</span><span class="w">r</span><span class="pc">s)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">rs</span><span class="c">-&gt;fifo_len) {</span>
		<span class="pc">d</span><span class="c">ev_err(&amp;pdev-&gt;dev, "</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">g</span><span class="c">et</span> <span class="w">fif</span><span class="pc">o</span> <span class="w">l</span><span class="pc">en</span><span class="c">gth\n");</span>
		<span class="pc">ret</span> <span class="c">= -EINVAL;</span>
		<span class="c">goto</span> <span class="w">err_get_fifo_len</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">sp</span><span class="pc">in_lock_in</span><span class="c">it(&amp;</span><span class="w">rs</span><span class="c">-&gt;lock);</span>

	<span class="w">pm_runtime_set_active</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">pm_runtime_enable</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev);</span>

	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">auto_runtime_pm</span> <span class="c">=</span> <span class="w">t</span><span class="c">rue;</span>
	<span class="w">ma</span><span class="pc">s</span><span class="c">ter-&gt;</span><span class="w">bus_num</span> <span class="c">=</span> <span class="w">p</span><span class="c">dev-&gt;</span><span class="pc">id</span><span class="c">;</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">mode_bits</span> <span class="c">=</span> <span class="w">SPI_CPOL</span> <span class="pc">|</span> <span class="w">SPI_CPHA</span> <span class="pc">|</span> <span class="w">SPI_LOOP</span><span class="c">;</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">num_chipselect</span> <span class="c">=</span> <span class="w">2</span><span class="c">;</span>
	<span class="w">ma</span><span class="c">ster-&gt;dev</span><span class="pc">.</span><span class="c">of_node</span> <span class="c">=</span> <span class="c">pdev-&gt;dev</span><span class="pc">.</span><span class="c">of_node;</span>
	<span class="w">m</span><span class="pc">as</span><span class="c">ter-&gt;</span><span class="w">bits_per_word_mask</span> <span class="c">=</span> <span class="w">SPI_BPW_MASK</span><span class="pc">(</span><span class="w">1</span><span class="pc">6</span><span class="w">)</span><span class="pc"> </span><span class="c">|</span> <span class="w">S</span><span class="pc">PI_B</span><span class="c">PW_MASK(</span><span class="w">8</span><span class="c">);</span>

	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">set_cs</span> <span class="c">=</span> <span class="w">rockchip_spi_set_cs</span><span class="pc">;</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">prepare_message</span> <span class="c">=</span> <span class="w">rockchip_spi_prepare_message</span><span class="c">;</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">unprepare_message</span> <span class="c">=</span> <span class="w">rockchip_spi_unprepare_message</span><span class="c">;</span>
	<span class="w">ma</span><span class="c">ster-&gt;</span><span class="w">transfer_one</span> <span class="c">=</span> <span class="w">rockchip_spi_transfer_one</span><span class="c">;</span>
	<span class="w">m</span><span class="pc">a</span><span class="c">ster-&gt;</span><span class="w">handle_err</span> <span class="c">=</span> <span class="w">rockchip_spi_handle_err</span><span class="c">;</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">dma_tx</span><span class="pc">.</span><span class="w">ch</span> <span class="c">=</span> <span class="w">dma_request_slave_channel</span><span class="pc">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">de</span><span class="c">v</span><span class="w">,</span><span class="pc"> "</span><span class="w">t</span><span class="pc">x</span><span class="c">");</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">rs</span><span class="c">-&gt;</span><span class="pc">d</span><span class="c">ma_tx</span><span class="pc">.</span><span class="w">ch</span><span class="c">)</span>
		<span class="w">d</span><span class="pc">e</span><span class="c">v_warn</span><span class="pc">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;dev, "</span><span class="w">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">req</span><span class="c">uest</span> <span class="w">TX</span> <span class="w">D</span><span class="c">MA</span> <span class="w">ch</span><span class="c">annel\n");</span>

	<span class="w">rs</span><span class="c">-&gt;</span><span class="w">dma_rx</span><span class="pc">.</span><span class="w">c</span><span class="c">h</span> <span class="pc">=</span> <span class="w">d</span><span class="c">ma_request_slave_channel</span><span class="pc">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">d</span><span class="pc">e</span><span class="c">v</span><span class="w">,</span><span class="pc"> "</span><span class="w">r</span><span class="c">x");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;dma_rx</span><span class="pc">.</span><span class="w">c</span><span class="pc">h) </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">dma_tx.</span><span class="c">ch</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">dma_release_channel</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;dma_tx.ch</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;dma_tx.</span><span class="pc">ch</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
		<span class="c">}</span>
		<span class="w">dev</span><span class="pc">_w</span><span class="c">arn</span><span class="pc">(</span><span class="w">r</span><span class="c">s-&gt;</span><span class="pc">de</span><span class="c">v</span><span class="pc">, </span><span class="c">"</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="pc">r</span><span class="c">equest</span> <span class="w">RX</span> <span class="w">D</span><span class="c">MA</span> <span class="w">ch</span><span class="pc">a</span><span class="c">nnel\n");</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;dma_tx</span><span class="pc">.</span><span class="w">c</span><span class="pc">h</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">dma_rx.</span><span class="pc">c</span><span class="c">h) {</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;dma_tx</span><span class="pc">.</span><span class="w">ad</span><span class="pc">dr</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">dm</span><span class="pc">a_a</span><span class="c">ddr_t</span><span class="pc">)(</span><span class="w">me</span><span class="pc">m</span><span class="c">-&gt;</span><span class="w">sta</span><span class="pc">r</span><span class="c">t</span> <span class="w">+</span> <span class="w">ROCKCHIP_SPI_TXDR</span><span class="c">);</span>
		<span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="pc">dma_r</span><span class="c">x.</span><span class="w">a</span><span class="pc">d</span><span class="c">dr</span> <span class="pc">= </span><span class="c">(</span><span class="w">dm</span><span class="pc">a_a</span><span class="c">ddr_t</span><span class="pc">)(</span><span class="w">m</span><span class="pc">e</span><span class="c">m-&gt;</span><span class="w">s</span><span class="c">tart</span> <span class="c">+</span> <span class="w">ROCKCHIP_SPI_RXDR</span><span class="c">);</span>
		<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">d</span><span class="c">ma_tx.</span><span class="w">d</span><span class="pc">i</span><span class="c">rection</span> <span class="pc">=</span> <span class="w">DMA_MEM_TO_DEV</span><span class="c">;</span>
		<span class="w">rs</span><span class="c">-&gt;</span><span class="pc">dma_r</span><span class="c">x.</span><span class="w">d</span><span class="pc">i</span><span class="c">rection</span> <span class="c">=</span> <span class="w">DMA_DEV_TO_MEM</span><span class="c">;</span>

		<span class="w">ma</span><span class="pc">st</span><span class="c">er-&gt;</span><span class="w">can_dma</span> <span class="pc">=</span> <span class="w">rockchip_spi_can_dma</span><span class="c">;</span>
		<span class="w">ma</span><span class="pc">st</span><span class="c">er-&gt;</span><span class="pc">dma_t</span><span class="c">x</span> <span class="pc">=</span> <span class="w">rs</span><span class="pc">-</span><span class="c">&gt;dma_tx</span><span class="pc">.</span><span class="w">ch</span><span class="c">;</span>
		<span class="w">ma</span><span class="pc">s</span><span class="c">ter-&gt;</span><span class="w">d</span><span class="pc">ma_r</span><span class="c">x</span> <span class="c">=</span> <span class="w">r</span><span class="pc">s</span><span class="c">-&gt;dma_rx</span><span class="pc">.</span><span class="w">ch</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">devm_spi_register_master</span><span class="pc">(&amp;</span><span class="w">p</span><span class="pc">de</span><span class="c">v-&gt;dev,</span> <span class="w">ma</span><span class="pc">s</span><span class="c">ter</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">et</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">dev_err(&amp;pdev-&gt;dev, "Failed</span> <span class="c">to</span> <span class="c">register</span> <span class="w">ma</span><span class="pc">s</span><span class="c">ter\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">err_register_master</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">retu</span><span class="c">rn</span> <span class="c">0;</span>

<span class="pc">e</span><span class="c">rr_register_master:</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">dma_tx.ch</span><span class="pc">)</span>
		<span class="w">dma_release_channel</span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;dma_tx</span><span class="pc">.</span><span class="w">ch</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">dma_rx</span><span class="pc">.ch)</span>
		<span class="w">d</span><span class="pc">ma_r</span><span class="c">elease_channel</span><span class="pc">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;dma_rx.ch);</span>
<span class="w">err_get_fifo_len</span><span class="pc">:</span>
	<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">spiclk</span><span class="c">);</span>
<span class="w">err_spiclk_enable</span><span class="pc">:</span>
	<span class="w">c</span><span class="pc">l</span><span class="c">k_disable_unprepare(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="w">apb_pclk</span><span class="c">);</span>
<span class="w">err_ioremap_resource</span><span class="pc">:</span>
	<span class="w">spi_master_put</span><span class="c">(</span><span class="w">mas</span><span class="c">ter);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">e</span><span class="c">t;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rockchip_spi_remove</span><span class="c">(struct</span> <span class="c">platform_device</span> <span class="c">*pdev)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">m</span><span class="pc">as</span><span class="c">ter</span> <span class="c">=</span> <span class="w">spi_master_get</span><span class="c">(</span><span class="w">p</span><span class="pc">l</span><span class="c">atform_get_drvdata(pdev));</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>

	<span class="w">pm_runtime_disable</span><span class="pc">(&amp;</span><span class="c">pdev-&gt;dev</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">spiclk</span><span class="c">);</span>
	<span class="pc">c</span><span class="c">lk_disable_unprepare(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">apb_pclk</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">dma_tx.ch</span><span class="pc">)</span>
		<span class="w">dma_release_channel</span><span class="c">(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;dma_tx</span><span class="pc">.c</span><span class="c">h</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;</span><span class="w">dma_rx</span><span class="pc">.ch</span><span class="c">)</span>
		<span class="w">d</span><span class="pc">ma_r</span><span class="c">elease_channel(</span><span class="w">r</span><span class="pc">s</span><span class="c">-&gt;dma_rx.ch);</span>

	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_PM_SLEEP</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">rockchip_spi_suspend</span><span class="c">(struct</span> <span class="w">d</span><span class="pc">e</span><span class="c">vice</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">m</span><span class="pc">a</span><span class="c">ster</span> <span class="c">=</span> <span class="w">d</span><span class="pc">ev_</span><span class="c">get_drvdata(dev);</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">spi_master_suspend</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="c">aster</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="c">return</span> <span class="c">ret;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">pm_runtime_suspended</span><span class="c">(dev</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">spiclk</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">lk_disable_unprepare(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">apb_pclk</span><span class="c">);</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">rockchip_spi_resume</span><span class="c">(struct</span> <span class="pc">d</span><span class="c">evice</span> <span class="c">*dev)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">m</span><span class="c">aster</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">pm_runtime_suspended</span><span class="c">(dev</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">clk_prepare_enable</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">apb_pclk</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0)</span>
			<span class="c">return</span> <span class="c">ret;</span>

		<span class="pc">ret</span> <span class="c">=</span> <span class="w">c</span><span class="c">lk_prepare_enable(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">spiclk</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span> <span class="c">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;apb_pclk</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">return</span> <span class="c">ret;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">spi_master_resume</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ma</span><span class="pc">s</span><span class="c">ter</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
		<span class="w">c</span><span class="c">lk_disable_unprepare(</span><span class="w">r</span><span class="pc">s-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">piclk</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">c</span><span class="c">lk_disable_unprepare(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="pc">a</span><span class="c">pb_pclk);</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>
<span class="w">#</span><span class="c">endif</span> 

<span class="pc">#</span><span class="c">ifdef</span> <span class="w">CONFIG_PM</span>
<span class="c">static</span> <span class="c">int</span> <span class="w">rockchip_spi_runtime_suspend</span><span class="c">(struct</span> <span class="c">device</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">m</span><span class="pc">a</span><span class="c">ster</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">as</span><span class="c">ter);</span>

	<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">spiclk</span><span class="c">);</span>
	<span class="w">c</span><span class="c">lk_disable_unprepare(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">apb_pclk</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">rockchip_spi_runtime_resume</span><span class="c">(struct</span> <span class="pc">d</span><span class="c">evice</span> <span class="c">*dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="c">struct</span> <span class="w">spi_master</span> <span class="c">*</span><span class="w">m</span><span class="pc">a</span><span class="c">ster</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev);</span>
	<span class="c">struct</span> <span class="w">rockchip_spi</span> <span class="c">*</span><span class="w">rs</span> <span class="c">=</span> <span class="w">spi_master_get_devdata</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">ster);</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">clk_prepare_enable</span><span class="c">(</span><span class="w">rs</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">apb_pclk</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="c">return</span> <span class="c">ret;</span>

	<span class="c">ret</span> <span class="c">=</span> <span class="w">c</span><span class="c">lk_prepare_enable(</span><span class="w">rs</span><span class="c">-&gt;</span><span class="w">spiclk</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="w">clk_disable_unprepare</span><span class="c">(</span><span class="w">rs</span><span class="c">-&gt;apb_pclk</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">return</span> <span class="c">ret;</span>
<span class="c">}</span>
<span class="w">#</span><span class="pc">en</span><span class="c">dif</span> 

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">dev_pm_ops</span> <span class="w">rockchip_spi_pm</span> <span class="c">= {</span>
	<span class="w">SET_SYSTEM_SLEEP_PM_OPS</span><span class="c">(</span><span class="w">rockchip_spi_suspend</span><span class="c">,</span> <span class="w">rockchip_spi_resume)</span>
	<span class="w">SET_RUNTIME_PM_OPS</span><span class="c">(</span><span class="w">rockchip_spi_runtime_suspend</span><span class="c">,</span>
			   <span class="w">rockchip_spi_runtime_resume</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">)</span>
<span class="w">}</span><span class="c">;</span>

<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="pc">o</span><span class="c">f_device_id</span> <span class="w">rockchip_spi_dt_match</span><span class="c">[] = {</span>
	<span class="c">{ .compatible</span> <span class="c">= "</span><span class="w">rockchip</span><span class="c">,</span><span class="w">rk3066</span><span class="c">-</span><span class="w">sp</span><span class="c">i</span><span class="w">", },</span>
	<span class="w">{</span><span class="pc"> .</span><span class="c">compatible</span> <span class="c">= "rockchip,</span><span class="w">rk3188</span><span class="c">-</span><span class="w">s</span><span class="pc">p</span><span class="c">i</span><span class="w">"</span><span class="pc">, }</span><span class="c">,</span>
	<span class="pc">{</span><span class="c"> .compatible</span> <span class="c">= "</span><span class="pc">r</span><span class="c">ockchip,</span><span class="w">rk3288</span><span class="c">-</span><span class="w">s</span><span class="pc">p</span><span class="c">i</span><span class="w">"</span><span class="pc">, }</span><span class="c">,</span>
	<span class="w">{ },</span>
<span class="c">};</span>
<span class="c">MODULE_DEVICE_TABLE(of,</span> <span class="c">rockchip_spi_dt_match);</span>

<span class="c">static</span> <span class="c">struct</span> <span class="c">platform_driver</span> <span class="w">rockchip_spi_driver</span> <span class="c">= {</span>
	<span class="c">.</span><span class="pc">d</span><span class="c">river</span> <span class="c">= {</span>
		<span class="c">.name</span>	<span class="pc">=</span> <span class="w">DRIVER_NAME</span><span class="c">,</span>
		<span class="c">.</span><span class="w">p</span><span class="pc">m</span> <span class="pc">= </span><span class="c">&amp;</span><span class="w">rockchip_spi_pm</span><span class="c">,</span>
		<span class="pc">.</span><span class="w">of_match_table</span> <span class="c">=</span> <span class="w">of_match_ptr</span><span class="pc">(ro</span><span class="c">ckchip_spi_dt_match),</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="c">.probe</span> <span class="c">=</span> <span class="w">rockchip_spi_probe</span><span class="c">,</span>
	<span class="c">.remove</span> <span class="c">=</span> <span class="w">rockchip_spi_remove</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">module_platform_driver</span><span class="c">(rockchip_spi_driver);</span>

<span class="c">MODULE_AUTHOR("</span><span class="w">Addy</span> <span class="w">Ke</span> <span class="c">&lt;</span><span class="w">addy</span><span class="pc">.</span><span class="w">ke</span><span class="c">@</span><span class="w">rock</span><span class="pc">-</span><span class="w">chips</span><span class="c">.com&gt;");</span>
<span class="c">MODULE_DESCRIPTION("</span><span class="w">ROCKCHIP</span> <span class="w">SPI</span> <span class="w">C</span><span class="c">ontroller</span> <span class="w">D</span><span class="c">river");</span>
<span class="c">MODULE_LICENSE("GPL</span> <span class="c">v2");</span>

</pre>
</body>
</html>

