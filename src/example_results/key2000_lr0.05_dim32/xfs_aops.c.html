<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>

<span class="w">#include</span> <span class="w">"xfs.h"</span>
<span class="w">#include</span> <span class="w">"xfs_shared.h"</span>
<span class="w">#include</span> <span class="w">"xfs_format.h"</span>
<span class="w">#include</span> <span class="w">"xfs_log_format.h"</span>
<span class="w">#include</span> <span class="w">"xfs_trans_resv.h"</span>
<span class="w">#include</span> <span class="w">"xfs_mount.</span><span class="c">h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_inode</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_trans</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_inode_item</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_alloc</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_error</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_iomap</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_trace</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_bmap</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_bmap_util</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">xfs_bmap_btree</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="pc">&lt;</span><span class="c">linux/</span><span class="w">gf</span><span class="c">p.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">mpage</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">pagevec</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">writeback</span><span class="c">.h&gt;</span>

<span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_count_page_state</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">age</span>		<span class="c">*</span><span class="w">pa</span><span class="pc">ge</span><span class="c">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="c">*</span><span class="w">delalloc</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="c">*</span><span class="w">unwritten</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er_head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">,</span><span class="c"> *</span><span class="w">he</span><span class="pc">ad</span><span class="c">;</span>

	<span class="w">*d</span><span class="c">elalloc</span> <span class="w">=</span><span class="pc"> *</span><span class="c">unwritten</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">bh</span> <span class="pc">=</span> <span class="w">h</span><span class="c">ead</span> <span class="pc">=</span> <span class="w">page_buffers</span><span class="pc">(</span><span class="w">pa</span><span class="pc">g</span><span class="c">e);</span>
	<span class="w">d</span><span class="pc">o</span> <span class="pc">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">buffer_unwritten</span><span class="c">(</span><span class="w">bh))</span>
			<span class="w">(</span><span class="pc">*</span><span class="w">u</span><span class="c">nwritten</span><span class="w">) </span><span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">buffer_delay</span><span class="c">(</span><span class="w">bh</span><span class="c">))</span>
			<span class="w">(</span><span class="c">*</span><span class="pc">d</span><span class="c">elalloc</span><span class="w">) </span><span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">((</span><span class="w">bh</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page) !</span><span class="c">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span><span class="w">)</span><span class="pc">;</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">block_device</span> <span class="pc">*</span>
<span class="w">xfs_find_bdev_for_inode</span><span class="pc">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="pc">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="w">i</span><span class="c">node);</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span> <span class="c">=</span> <span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_mount</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">XFS_IS_REALTIME_INODE</span><span class="c">(</span><span class="w">ip</span><span class="c">))</span>
		<span class="c">return</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_rtdev_targp-</span><span class="pc">&gt;</span><span class="w">bt_bdev</span><span class="pc">;</span>
	<span class="w">e</span><span class="c">lse</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_ddev_targp-</span><span class="c">&gt;</span><span class="pc">b</span><span class="c">t_bdev</span><span class="pc">;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_destroy_ioend</span><span class="c">(</span>
	<span class="w">xfs_ioend_t</span>		<span class="pc">*</span><span class="w">ioend</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">buff</span><span class="pc">er_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh,</span><span class="c"> *</span><span class="w">n</span><span class="pc">e</span><span class="c">xt;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">bh</span> <span class="c">=</span> <span class="w">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_buffer_head</span><span class="pc">;</span> <span class="w">bh</span><span class="pc">;</span> <span class="w">b</span><span class="pc">h</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">ex</span><span class="c">t</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">n</span><span class="c">ext</span> <span class="c">=</span> <span class="w">bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_private</span><span class="c">;</span>
		<span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_end_io(bh, !</span><span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_error</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="w">mempool_free</span><span class="pc">(i</span><span class="c">oend</span><span class="pc">,</span> <span class="w">xfs_ioend_pool</span><span class="c">);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">b</span><span class="c">ool</span> <span class="w">xfs_ioend_is_append</span><span class="c">(struct</span> <span class="w">xfs_ioend</span> <span class="c">*</span><span class="pc">i</span><span class="c">oend)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">i</span><span class="c">oend-&gt;</span><span class="w">io_offset</span> <span class="w">+</span> <span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_size</span> <span class="w">&gt;</span>
		<span class="w">XFS_I</span><span class="c">(ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_inode)-</span><span class="c">&gt;</span><span class="w">i_d</span><span class="pc">.</span><span class="w">di_size</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">in</span><span class="c">t</span>
<span class="w">xfs_setfilesize_trans_alloc</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">x</span><span class="c">fs_ioend</span>	<span class="c">*ioend</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span> <span class="c">=</span> <span class="w">X</span><span class="c">FS_I</span><span class="pc">(i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">o_inode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mount</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">xfs_trans</span>	<span class="c">*</span><span class="w">tp</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>

	<span class="w">tp</span> <span class="pc">=</span> <span class="w">xfs_trans_alloc</span><span class="c">(</span><span class="w">mp</span><span class="pc">,</span> <span class="w">XFS_TRANS_FSYNC_TS</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_trans_reserve</span><span class="c">(</span><span class="w">t</span><span class="c">p</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">M_RES(mp)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tr_fsyncts</span><span class="pc">,</span> <span class="pc">0,</span> <span class="c">0);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r) {</span>
		<span class="w">xfs_trans_cancel</span><span class="c">(</span><span class="w">t</span><span class="pc">p)</span><span class="c">;</span>
		<span class="c">return</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
	<span class="c">}</span>

	<span class="w">ioend-</span><span class="c">&gt;</span><span class="w">io_append_trans</span> <span class="c">=</span> <span class="w">t</span><span class="pc">p;</span>

	
	<span class="w">rwsem_release</span><span class="pc">(&amp;</span><span class="c">ioend-&gt;</span><span class="w">io_inode-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b-&gt;</span><span class="w">s_writers</span><span class="pc">.</span><span class="w">lock_map[SB_FREEZE_FS-</span><span class="c">1</span><span class="pc">],</span>
		      <span class="w">1</span><span class="pc">,</span> <span class="w">_THIS_IP_</span><span class="c">);</span>
	
	<span class="w">current_restore_flags_nested</span><span class="pc">(&amp;</span><span class="w">t</span><span class="c">p-&gt;</span><span class="w">t_pflags</span><span class="c">,</span> <span class="w">PF_FSTRANS</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_setfilesize</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span><span class="c">,</span>
	<span class="c">struct</span> <span class="w">xfs_trans</span>	<span class="c">*</span><span class="w">t</span><span class="pc">p</span><span class="c">,</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="pc">f</span><span class="c">fset,</span>
	<span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span>			<span class="c">size)</span>
<span class="c">{</span>
	<span class="w">xfs_fsize_t</span>		<span class="w">isize</span><span class="pc">;</span>

	<span class="w">xfs_ilock</span><span class="pc">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">XFS_ILOCK_EXCL</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">s</span><span class="c">ize</span> <span class="pc">=</span> <span class="w">xfs_new_eof</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="pc">ffs</span><span class="c">et</span> <span class="pc">+</span> <span class="w">s</span><span class="pc">ize</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!i</span><span class="c">size</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="pc">X</span><span class="c">FS_ILOCK_EXCL</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">xfs_trans_cancel</span><span class="c">(</span><span class="w">t</span><span class="pc">p)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
	<span class="c">}</span>

	<span class="w">trace_xfs_setfilesize</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize</span><span class="c">);</span>

	<span class="w">i</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">i_d</span><span class="pc">.</span><span class="w">di_size</span> <span class="c">=</span> <span class="w">i</span><span class="pc">s</span><span class="c">ize</span><span class="pc">;</span>
	<span class="w">xfs_trans_ijoin</span><span class="c">(</span><span class="w">t</span><span class="pc">p,</span> <span class="w">ip</span><span class="c">,</span> <span class="w">X</span><span class="c">FS_ILOCK_EXCL);</span>
	<span class="w">xfs_trans_log_inode</span><span class="c">(</span><span class="w">t</span><span class="pc">p,</span> <span class="w">i</span><span class="pc">p</span><span class="c">,</span> <span class="w">XFS_ILOG_CORE</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">xfs_trans_commit</span><span class="c">(</span><span class="w">t</span><span class="pc">p)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">nt</span>
<span class="w">xfs_setfilesize_ioend</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_ioend</span>	<span class="c">*</span><span class="w">ioend</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="pc">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_inode</span><span class="c">);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_trans</span>	<span class="c">*tp</span> <span class="c">=</span> <span class="w">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_append_trans</span><span class="c">;</span>

	
	<span class="w">current_set_flags_nested</span><span class="pc">(&amp;</span><span class="w">t</span><span class="c">p-&gt;</span><span class="w">t_pflags</span><span class="c">,</span> <span class="w">PF_FSTRANS</span><span class="c">);</span>
	<span class="w">rwsem_acquire_read</span><span class="pc">(&amp;</span><span class="w">VFS_I</span><span class="pc">(</span><span class="w">ip)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">s</span><span class="c">b-&gt;</span><span class="w">s_writers</span><span class="pc">.</span><span class="w">lock_map[SB_FREEZE_FS-</span><span class="c">1</span><span class="pc">],</span>
			   <span class="pc">0,</span> <span class="w">1</span><span class="pc">,</span> <span class="w">_THIS_IP_</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">xfs_setfilesize</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">tp</span><span class="pc">,</span> <span class="w">ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_offset</span><span class="c">,</span> <span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_size</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_finish_ioend</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">xfs_ioend</span>	<span class="c">*</span><span class="pc">i</span><span class="c">oend</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">atomic_dec_and_test</span><span class="pc">(&amp;i</span><span class="c">oend-&gt;</span><span class="w">io_remaining</span><span class="pc">)) </span><span class="c">{</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span><span class="c">p</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_inode)-</span><span class="c">&gt;</span><span class="w">i_mount</span><span class="c">;</span>

		<span class="pc">if</span> <span class="c">(ioend-&gt;</span><span class="w">io_type</span> <span class="c">==</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="pc">)</span>
			<span class="w">queue_work</span><span class="c">(</span><span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_unwritten_workqueue,</span><span class="pc"> &amp;</span><span class="c">ioend-&gt;</span><span class="w">io_work</span><span class="c">);</span>
		<span class="c">else</span> <span class="c">if</span> <span class="c">(ioend-&gt;</span><span class="w">io_append_trans</span><span class="pc">)</span>
			<span class="w">q</span><span class="c">ueue_work</span><span class="pc">(</span><span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">m_data_workqueue,</span><span class="pc"> </span><span class="c">&amp;ioend-&gt;</span><span class="pc">io_w</span><span class="c">ork);</span>
		<span class="pc">e</span><span class="c">lse</span>
			<span class="w">xfs_destroy_ioend</span><span class="c">(ioend</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_end_io</span><span class="c">(</span>
	<span class="c">struct</span> <span class="pc">w</span><span class="c">ork_struct</span> <span class="c">*work)</span>
<span class="c">{</span>
	<span class="w">xfs_ioend_t</span>	<span class="pc">*</span><span class="c">ioend</span> <span class="c">=</span> <span class="w">co</span><span class="pc">nt</span><span class="c">ainer_of(</span><span class="pc">w</span><span class="c">ork,</span> <span class="w">x</span><span class="pc">fs_i</span><span class="c">oend_t</span><span class="pc">,</span> <span class="w">i</span><span class="pc">o_w</span><span class="c">ork);</span>
	<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">xfs_inode</span> <span class="c">*</span><span class="w">ip</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_inode</span><span class="c">);</span>
	<span class="pc">in</span><span class="c">t</span>		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mount)</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_error</span> <span class="w">= </span><span class="pc">-</span><span class="w">E</span><span class="pc">IO</span><span class="c">;</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">d</span><span class="c">one;</span>
	<span class="c">}</span>
	<span class="c">if</span> <span class="c">(ioend-&gt;</span><span class="w">io</span><span class="pc">_e</span><span class="c">rror</span><span class="w">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">d</span><span class="c">one;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(ioend-&gt;</span><span class="w">io_type</span> <span class="c">==</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="c">) {</span>
		<span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_iomap_write_unwritten</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="c">ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_offset</span><span class="pc">,</span>
						  <span class="c">ioend-&gt;</span><span class="w">io_size</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(ioend-&gt;</span><span class="w">io_append_trans</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_setfilesize_ioend</span><span class="c">(ioend</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">A</span><span class="pc">S</span><span class="c">SERT</span><span class="w">(</span><span class="pc">!</span><span class="w">xfs_ioend_is_append</span><span class="c">(ioend</span><span class="w">)</span><span class="pc">);</span>
	<span class="pc">}</span>

<span class="w">d</span><span class="pc">o</span><span class="c">ne:</span>
	<span class="pc">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rror)</span>
		<span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_error</span> <span class="c">=</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
	<span class="w">xfs_destroy_ioend</span><span class="c">(ioend</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="w">STATIC</span> <span class="w">xfs_ioend_t</span> <span class="w">*</span>
<span class="w">xfs_alloc_ioend</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span>		<span class="c">*</span><span class="pc">in</span><span class="c">ode,</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span>		<span class="w">t</span><span class="c">ype</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">x</span><span class="pc">fs_ioend_t</span>		<span class="pc">*</span><span class="w">i</span><span class="pc">oe</span><span class="c">nd</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">o</span><span class="c">end</span> <span class="c">=</span> <span class="w">mempool_alloc</span><span class="c">(</span><span class="w">xfs_ioend_pool</span><span class="c">,</span> <span class="w">GFP_NOFS</span><span class="c">);</span>

	
	<span class="w">at</span><span class="pc">omic_s</span><span class="c">et(&amp;ioend-&gt;</span><span class="w">io_remaining</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">o</span><span class="c">end</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_error</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_list</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">io</span><span class="c">end-&gt;</span><span class="w">io_type</span> <span class="c">=</span> <span class="w">ty</span><span class="c">pe;</span>
	<span class="c">ioend-&gt;</span><span class="w">io_inode</span> <span class="c">=</span> <span class="w">ino</span><span class="c">de</span><span class="pc">;</span>
	<span class="c">ioend-&gt;</span><span class="w">io_buffer_head</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">ioend-&gt;</span><span class="w">io_buffer_tail</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="c">ioend-&gt;</span><span class="w">io_offset</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">ioend-&gt;</span><span class="w">io_size</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">ioend-&gt;</span><span class="w">io_append_trans</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">INIT_WORK</span><span class="pc">(&amp;</span><span class="c">ioend-&gt;</span><span class="w">io_work</span><span class="pc">,</span> <span class="w">xfs_end_io</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">i</span><span class="c">oend;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_map_blocks</span><span class="pc">(</span>
	<span class="c">struct</span> <span class="w">in</span><span class="c">ode</span>		<span class="c">*</span><span class="pc">in</span><span class="c">ode,</span>
	<span class="w">l</span><span class="c">off_t</span>			<span class="pc">o</span><span class="c">ffset,</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="w">imap</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">t</span><span class="c">ype,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">nonblocking</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span> <span class="c">=</span> <span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_mount</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span>			<span class="w">c</span><span class="c">ount</span> <span class="pc">=</span> <span class="w">1</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">i</span><span class="pc">no</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>
	<span class="w">xfs_fileoff_t</span>		<span class="w">offset_fsb,</span> <span class="w">end_fsb</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span>			<span class="w">bmapi_flags</span> <span class="c">=</span> <span class="w">XFS_BMAPI_ENTIRE</span><span class="c">;</span>
	<span class="c">int</span>			<span class="w">nimaps</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="c">(</span><span class="w">mp</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="pc">)</span>
		<span class="w">b</span><span class="pc">m</span><span class="c">api_flags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">XFS_BMAPI_IGSTATE</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">xfs_ilock_nowait</span><span class="pc">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">XFS_ILOCK_SHARED)</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">nonblocking</span><span class="pc">)</span>
			<span class="c">return</span> <span class="c">-</span><span class="w">EA</span><span class="c">GAIN;</span>
		<span class="w">xfs_ilock</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">X</span><span class="pc">FS_IL</span><span class="c">OCK_SHARED);</span>
	<span class="c">}</span>

	<span class="w">A</span><span class="c">SSERT(</span><span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_d.di_format</span> <span class="pc">!</span><span class="c">=</span> <span class="w">XFS_DINODE_FMT_BTREE</span> <span class="pc">|</span><span class="c">|</span>
	       <span class="pc">(</span><span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_df</span><span class="pc">.</span><span class="w">if_flags</span> <span class="w">&amp;</span> <span class="w">XFS_IFEXTENTS))</span><span class="pc">;</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">of</span><span class="c">fset</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="w">m_super-</span><span class="c">&gt;</span><span class="w">s_maxbytes</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">o</span><span class="c">ffset</span> <span class="w">+</span> <span class="w">c</span><span class="c">ount</span> <span class="pc">&gt;</span> <span class="w">mp</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_super</span><span class="pc">-</span><span class="c">&gt;s_maxbytes</span><span class="w">)</span>
		<span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_super-&gt;s_maxbytes</span> <span class="w">-</span> <span class="pc">o</span><span class="c">ffset;</span>
	<span class="w">end_fsb</span> <span class="pc">=</span> <span class="w">XFS_B_TO_FSB</span><span class="c">(</span><span class="w">mp,</span><span class="pc"> (</span><span class="w">xfs_ufsize_t)o</span><span class="c">ffset</span> <span class="pc">+</span> <span class="w">c</span><span class="c">ount);</span>
	<span class="w">offset_fsb</span> <span class="pc">=</span> <span class="w">XFS_B_TO_FSBT</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="pc">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_bmapi_read</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="pc">offset_</span><span class="c">fsb</span><span class="pc">,</span> <span class="pc">e</span><span class="c">nd_fsb</span> <span class="w">-</span> <span class="pc">offs</span><span class="c">et_fsb</span><span class="pc">,</span>
				<span class="w">imap,</span><span class="pc"> &amp;</span><span class="w">nimaps</span><span class="pc">,</span> <span class="w">bmapi_flags</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">XFS_ILOCK_SHARED</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rror;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="c">==</span> <span class="w">XFS_IO_DELALLOC</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">(</span><span class="pc">!</span><span class="w">n</span><span class="c">imaps</span> <span class="pc">|</span><span class="c">|</span> <span class="w">isnullstartblock</span><span class="c">(</span><span class="w">i</span><span class="c">map</span><span class="w">-</span><span class="c">&gt;</span><span class="w">br_startblock))</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_iomap_write_allocate</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="pc">ffs</span><span class="c">et</span><span class="pc">,</span> <span class="w">i</span><span class="pc">m</span><span class="c">ap);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">e</span><span class="pc">rro</span><span class="c">r)</span>
			<span class="w">trace_xfs_map_blocks_alloc</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="c">ffset,</span> <span class="w">c</span><span class="c">ount</span><span class="pc">,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">,</span> <span class="pc">i</span><span class="c">map);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="c">rror;</span>
	<span class="c">}</span>

<span class="pc">#i</span><span class="c">fdef</span> <span class="c">DEBUG</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">==</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">nimaps</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">i</span><span class="c">map-&gt;</span><span class="w">br_startblock</span> <span class="w">!</span><span class="c">=</span> <span class="w">HOLESTARTBLOCK</span><span class="c">);</span>
		<span class="w">A</span><span class="c">SSERT(imap-&gt;br_startblock</span> <span class="w">!</span><span class="c">=</span> <span class="w">DELAYSTARTBLOCK</span><span class="c">);</span>
	<span class="pc">}</span>
<span class="pc">#</span><span class="c">endif</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">n</span><span class="c">imaps</span><span class="pc">)</span>
		<span class="w">trace_xfs_map_blocks_found</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="c">ffset,</span> <span class="w">c</span><span class="c">ount</span><span class="pc">,</span> <span class="w">ty</span><span class="c">pe</span><span class="pc">,</span> <span class="pc">i</span><span class="c">map);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_imap_valid</span><span class="c">(</span>
	<span class="c">struct</span> <span class="pc">i</span><span class="c">node</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="w">i</span><span class="pc">m</span><span class="c">ap,</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="pc">f</span><span class="c">fset)</span>
<span class="c">{</span>
	<span class="w">o</span><span class="c">ffset</span> <span class="w">&gt;</span><span class="pc">&gt;=</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">o</span><span class="c">ffset</span> <span class="w">&gt;</span><span class="c">=</span> <span class="w">i</span><span class="pc">m</span><span class="c">ap-&gt;</span><span class="w">br_startoff</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
		<span class="c">offset</span> <span class="pc">&lt;</span> <span class="pc">i</span><span class="c">map-&gt;</span><span class="w">b</span><span class="pc">r</span><span class="c">_startoff</span> <span class="pc">+</span> <span class="w">i</span><span class="pc">m</span><span class="c">ap-&gt;</span><span class="w">br_blockcount</span><span class="c">;</span>
<span class="pc">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="pc">o</span><span class="c">id</span>
<span class="w">xfs_end_bio</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span>		<span class="c">*bio</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">er</span><span class="pc">ro</span><span class="c">r</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">xfs_ioend_t</span>		<span class="pc">*</span><span class="w">ioend</span> <span class="c">=</span> <span class="w">b</span><span class="pc">i</span><span class="c">o-&gt;</span><span class="w">bi_private</span><span class="c">;</span>

	<span class="pc">if</span> <span class="pc">(!i</span><span class="c">oend-&gt;</span><span class="w">io_error</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">t</span><span class="pc">e</span><span class="c">st_bit(</span><span class="w">BIO_UPTODATE</span><span class="c">, &amp;</span><span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_flags</span><span class="pc">))</span>
		<span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">o_</span><span class="c">error</span> <span class="c">=</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror;</span>

	
	<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="pc">bi_</span><span class="c">private</span> <span class="c">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="w">b</span><span class="c">io-&gt;</span><span class="w">bi_end_io</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="w">bio_put</span><span class="pc">(bio)</span><span class="c">;</span>

	<span class="w">xfs_finish_ioend</span><span class="c">(</span><span class="pc">i</span><span class="c">oend</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_submit_ioend_bio</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">wbc</span><span class="pc">,</span>
	<span class="w">xfs_ioend_t</span>		<span class="c">*ioend,</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">io</span>		<span class="c">*bio)</span>
<span class="c">{</span>
	<span class="w">a</span><span class="c">tomic_inc(&amp;</span><span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_remaining</span><span class="c">);</span>
	<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_private</span> <span class="c">=</span> <span class="c">ioend</span><span class="pc">;</span>
	<span class="pc">b</span><span class="c">io-&gt;</span><span class="w">bi_end_io</span> <span class="c">=</span> <span class="w">xfs_end_bio</span><span class="c">;</span>
	<span class="w">submit_bio</span><span class="c">(</span><span class="pc">w</span><span class="c">bc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sync_mode</span> <span class="w">=</span><span class="pc">=</span> <span class="w">WB_SYNC_ALL</span> <span class="w">?</span> <span class="w">WRITE_SYNC</span> <span class="c">:</span> <span class="w">WRITE</span><span class="c">,</span> <span class="w">b</span><span class="pc">io)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="pc">b</span><span class="c">io</span> <span class="pc">*</span>
<span class="w">xfs_alloc_ioend_bio</span><span class="pc">(</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">uf</span><span class="c">fer_head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">nvecs</span> <span class="pc">=</span> <span class="w">bio_get_nr_vecs</span><span class="c">(</span><span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_bdev</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">io</span>		<span class="c">*bio</span> <span class="c">=</span> <span class="w">bio_alloc</span><span class="c">(</span><span class="w">GFP_NOIO</span><span class="pc">,</span> <span class="w">n</span><span class="c">vecs</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">A</span><span class="c">SSERT(bio-&gt;</span><span class="w">bi_private</span> <span class="w">=</span><span class="c">=</span> <span class="c">NULL</span><span class="pc">);</span>
	<span class="w">b</span><span class="c">io-&gt;</span><span class="w">bi_iter.bi_sector</span> <span class="c">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_blocknr</span> <span class="w">*</span><span class="pc"> </span><span class="c">(</span><span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_size</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">9</span><span class="c">);</span>
	<span class="w">bi</span><span class="pc">o</span><span class="c">-&gt;</span><span class="w">bi_bdev</span> <span class="c">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_bdev</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">bio</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_start_buffer_writeback</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">bu</span><span class="c">ffer_head</span>	<span class="c">*</span><span class="w">bh</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">buffer_mapped</span><span class="c">(</span><span class="w">bh</span><span class="c">));</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">buffer_locked</span><span class="c">(</span><span class="w">bh</span><span class="c">));</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT</span><span class="pc">(!</span><span class="w">buffer_delay</span><span class="c">(</span><span class="w">bh</span><span class="c">));</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT</span><span class="pc">(!</span><span class="w">buffer_unwritten</span><span class="c">(</span><span class="w">bh</span><span class="c">));</span>

	<span class="w">mark_buffer_async_write</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
	<span class="w">set_buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
	<span class="w">clear_buffer_dirty</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="pc">o</span><span class="c">id</span>
<span class="w">xfs_start_page_writeback</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span>		<span class="c">*</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">clear_dirty</span><span class="pc">,</span>
	<span class="c">int</span>			<span class="w">buffers</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">PageLocked</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT</span><span class="pc">(!</span><span class="w">PageWriteback</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">));</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">c</span><span class="c">lear_dirty</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">clear_page_dirty_for_io</span><span class="c">(</span><span class="pc">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">set_page_writeback</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span>
		<span class="w">set_page_writeback_keepwrite</span><span class="c">(</span><span class="pc">p</span><span class="c">age);</span>

	<span class="w">unlock_page</span><span class="c">(</span><span class="pc">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">b</span><span class="c">uffers</span><span class="pc">)</span>
		<span class="w">end_page_writeback</span><span class="c">(page</span><span class="pc">)</span><span class="c">;</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">inline</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">xfs_bio_add_buffer</span><span class="c">(struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*</span><span class="pc">b</span><span class="c">io</span><span class="pc">,</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">uffer_</span><span class="c">head</span> <span class="c">*</span><span class="w">bh</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">bio_add_page</span><span class="pc">(</span><span class="w">b</span><span class="pc">i</span><span class="c">o,</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_page</span><span class="pc">,</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_size</span><span class="pc">,</span> <span class="w">bh_offset</span><span class="pc">(</span><span class="w">bh</span><span class="pc">))</span><span class="c">;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="pc">o</span><span class="c">id</span>
<span class="w">xfs_submit_ioend</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">wbc</span><span class="c">,</span>
	<span class="w">xfs_ioend_t</span>		<span class="pc">*</span><span class="w">ioend</span><span class="c">,</span>
	<span class="w">i</span><span class="c">nt</span>			<span class="w">fa</span><span class="pc">i</span><span class="c">l)</span>
<span class="c">{</span>
	<span class="w">x</span><span class="pc">fs_i</span><span class="c">oend_t</span>		<span class="pc">*</span><span class="w">he</span><span class="c">ad</span> <span class="c">=</span> <span class="pc">i</span><span class="c">oend</span><span class="pc">;</span>
	<span class="w">x</span><span class="c">fs_ioend_t</span>		<span class="w">*n</span><span class="c">ext</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">buf</span><span class="pc">fer_</span><span class="c">head</span>	<span class="c">*</span><span class="w">b</span><span class="pc">h</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span>		<span class="c">*bio;</span>
	<span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span>		<span class="w">lastblock</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="w">do</span> <span class="c">{</span>
		<span class="w">ne</span><span class="pc">x</span><span class="c">t</span> <span class="c">=</span> <span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_list</span><span class="c">;</span>
		<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(</span><span class="w">bh</span> <span class="c">=</span> <span class="w">i</span><span class="pc">oe</span><span class="c">nd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_buffer_head</span><span class="c">;</span> <span class="w">bh;</span> <span class="w">bh</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_private)</span>
			<span class="w">xfs_start_buffer_writeback</span><span class="pc">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">((i</span><span class="c">oend</span> <span class="w">=</span> <span class="w">n</span><span class="c">ext</span><span class="w">) !</span><span class="c">=</span> <span class="c">NULL</span><span class="w">);</span>

	
	<span class="pc">io</span><span class="c">end</span> <span class="pc">=</span> <span class="w">h</span><span class="c">ead;</span>
	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="w">n</span><span class="c">ext</span> <span class="c">=</span> <span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_list</span><span class="c">;</span>
		<span class="w">b</span><span class="c">io</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">fa</span><span class="pc">i</span><span class="c">l</span><span class="pc">) </span><span class="c">{</span>
			<span class="pc">io</span><span class="c">end</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_error</span> <span class="c">=</span> <span class="w">fa</span><span class="pc">il</span><span class="c">;</span>
			<span class="w">xfs_finish_ioend</span><span class="c">(</span><span class="pc">ioe</span><span class="c">nd</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>

		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">bh</span> <span class="c">=</span> <span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_buffer_head</span><span class="c">;</span> <span class="w">bh</span><span class="pc">;</span> <span class="w">bh</span> <span class="c">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_private)</span><span class="pc"> {</span>

			<span class="pc">if</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">i</span><span class="c">o</span><span class="pc">)</span><span class="c"> {</span>
 <span class="w">ret</span><span class="pc">r</span><span class="c">y</span><span class="w">:</span>
				<span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="pc">=</span> <span class="w">xfs_alloc_ioend_bio</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_blocknr</span> <span class="pc">!</span><span class="c">=</span> <span class="w">lastblock</span> <span class="w">+</span> <span class="pc">1) </span><span class="c">{</span>
				<span class="w">xfs_submit_ioend_bio</span><span class="c">(</span><span class="w">wbc</span><span class="c">,</span> <span class="pc">i</span><span class="c">oend,</span> <span class="w">b</span><span class="pc">i</span><span class="c">o);</span>
				<span class="w">g</span><span class="c">oto</span> <span class="pc">r</span><span class="c">etry;</span>
			<span class="c">}</span>

			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">xfs_bio_add_buffer</span><span class="c">(bio,</span> <span class="w">bh) </span><span class="pc">!</span><span class="c">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_size</span><span class="pc">) </span><span class="c">{</span>
				<span class="pc">x</span><span class="c">fs_submit_ioend_bio(</span><span class="pc">w</span><span class="c">bc,</span> <span class="c">ioend,</span> <span class="w">b</span><span class="pc">i</span><span class="c">o);</span>
				<span class="w">g</span><span class="c">oto</span> <span class="w">r</span><span class="c">etry;</span>
			<span class="c">}</span>

			<span class="w">l</span><span class="c">astblock</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_blocknr</span><span class="c">;</span>
		<span class="pc">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">b</span><span class="c">io</span><span class="w">)</span>
			<span class="w">x</span><span class="pc">fs_s</span><span class="c">ubmit_ioend_bio(wbc,</span> <span class="c">ioend,</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">xfs_finish_ioend</span><span class="c">(ioend</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="pc">((</span><span class="w">i</span><span class="c">oend</span> <span class="pc">=</span> <span class="w">ne</span><span class="c">xt</span><span class="w">) !</span><span class="c">=</span> <span class="pc">N</span><span class="c">ULL</span><span class="w">);</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_cancel_ioend</span><span class="c">(</span>
	<span class="w">xfs_ioend_t</span>		<span class="pc">*i</span><span class="c">oend</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">x</span><span class="pc">fs_i</span><span class="c">oend_t</span>		<span class="c">*</span><span class="w">n</span><span class="c">ext</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">buf</span><span class="pc">fer_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">,</span><span class="c"> *</span><span class="w">next_bh</span><span class="c">;</span>

	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="w">n</span><span class="pc">ext</span> <span class="pc">=</span> <span class="c">ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_list</span><span class="c">;</span>
		<span class="w">bh</span> <span class="pc">=</span> <span class="c">ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_buffer_head</span><span class="c">;</span>
		<span class="w">d</span><span class="c">o</span> <span class="c">{</span>
			<span class="pc">n</span><span class="c">ext_bh</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_private</span><span class="c">;</span>
			<span class="w">clear_buffer_async_write</span><span class="c">(</span><span class="w">b</span><span class="pc">h)</span><span class="c">;</span>
			
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(i</span><span class="c">oend-&gt;</span><span class="w">io_type</span> <span class="pc">=</span><span class="c">=</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="c">)</span>
				<span class="w">set_buffer_unwritten</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">unlock_buffer</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
		<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">((</span><span class="w">bh</span> <span class="w">=</span> <span class="pc">n</span><span class="c">ext_bh</span><span class="w">)</span><span class="pc"> !</span><span class="c">=</span> <span class="c">NULL</span><span class="w">);</span>

		<span class="w">mempool_free</span><span class="c">(</span><span class="pc">i</span><span class="c">oend,</span> <span class="w">xfs_ioend_pool</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">((i</span><span class="c">oend</span> <span class="w">=</span> <span class="w">n</span><span class="pc">ext</span><span class="w">) !</span><span class="c">=</span> <span class="c">NULL</span><span class="w">);</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_add_to_ioend</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span>	<span class="c">*</span><span class="w">b</span><span class="pc">h,</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="pc">f</span><span class="c">fset,</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span>		<span class="w">t</span><span class="c">ype,</span>
	<span class="w">xfs_ioend_t</span>		<span class="w">*</span><span class="pc">*</span><span class="w">r</span><span class="c">esult</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">need_ioend</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">x</span><span class="pc">fs_i</span><span class="c">oend_t</span>		<span class="pc">*i</span><span class="c">oend</span> <span class="w">=</span><span class="pc"> *</span><span class="w">r</span><span class="c">esult;</span>

	<span class="c">if</span> <span class="pc">(!i</span><span class="c">oend</span> <span class="w">|</span><span class="pc">|</span> <span class="pc">n</span><span class="c">eed_ioend</span> <span class="w">|</span><span class="pc">|</span> <span class="w">t</span><span class="c">ype</span> <span class="c">!=</span> <span class="c">ioend</span><span class="w">-</span><span class="c">&gt;</span><span class="w">io_type</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">x</span><span class="c">fs_ioend_t</span>	<span class="w">*previous</span> <span class="w">=</span><span class="pc"> *</span><span class="w">r</span><span class="c">esult;</span>

		<span class="c">ioend</span> <span class="pc">=</span> <span class="w">xfs_alloc_ioend</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="w">ty</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">io</span><span class="c">end</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_offset</span> <span class="c">=</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset;</span>
		<span class="c">ioend-&gt;</span><span class="w">io_buffer_head</span> <span class="c">=</span> <span class="w">bh</span><span class="c">;</span>
		<span class="c">ioend-&gt;</span><span class="w">io_buffer_tail</span> <span class="c">=</span> <span class="w">bh</span><span class="c">;</span>
		<span class="pc">if</span> <span class="c">(</span><span class="pc">p</span><span class="c">revious</span><span class="pc">)</span>
			<span class="w">p</span><span class="c">revious-&gt;</span><span class="w">io_list</span> <span class="c">=</span> <span class="c">ioend</span><span class="pc">;</span>
		<span class="w">*</span><span class="pc">r</span><span class="c">esult</span> <span class="c">=</span> <span class="pc">ioe</span><span class="c">nd</span><span class="pc">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
		<span class="c">ioend-&gt;</span><span class="w">i</span><span class="pc">o_buffer_t</span><span class="c">ail</span><span class="w">-</span><span class="c">&gt;</span><span class="w">b_private</span> <span class="pc">=</span> <span class="w">bh</span><span class="pc">;</span>
		<span class="c">ioend-&gt;</span><span class="w">i</span><span class="pc">o_buffer_t</span><span class="c">ail</span> <span class="c">=</span> <span class="w">bh</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">bh</span><span class="c">-&gt;</span><span class="pc">b</span><span class="c">_private</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="w">i</span><span class="pc">oe</span><span class="c">nd-&gt;</span><span class="w">io_size</span> <span class="w">+</span><span class="c">=</span> <span class="w">bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span><span class="c">;</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_map_buffer</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span>		<span class="c">*</span><span class="pc">in</span><span class="c">ode,</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">uf</span><span class="c">fer_head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">,</span>
	<span class="c">struct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="w">imap</span><span class="pc">,</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="pc">f</span><span class="c">fset)</span>
<span class="c">{</span>
	<span class="w">se</span><span class="c">ctor_t</span>		<span class="w">bn</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">m</span> <span class="pc">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)-</span><span class="c">&gt;</span><span class="w">i_mount</span><span class="pc">;</span>
	<span class="w">x</span><span class="pc">fs_o</span><span class="c">ff_t</span>		<span class="w">iomap_offset</span> <span class="pc">=</span> <span class="w">XFS_FSB_TO_B</span><span class="c">(</span><span class="w">m</span><span class="c">,</span> <span class="pc">i</span><span class="c">map</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">br_startoff</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">xfs_daddr_t</span>		<span class="w">iomap_bn</span> <span class="pc">=</span> <span class="w">xfs_fsb_to_db</span><span class="c">(</span><span class="w">X</span><span class="pc">FS_I(</span><span class="w">ino</span><span class="c">de</span><span class="pc">),</span> <span class="pc">im</span><span class="c">ap</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">br_startblock</span><span class="c">);</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(imap-&gt;br_startblock</span> <span class="w">!</span><span class="c">=</span> <span class="w">HOLESTARTBLOCK</span><span class="pc">);</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">im</span><span class="c">ap-&gt;</span><span class="w">b</span><span class="pc">r_startb</span><span class="c">lock</span> <span class="w">!</span><span class="c">=</span> <span class="w">DELAYSTARTBLOCK</span><span class="pc">);</span>

	<span class="w">bn</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">i</span><span class="pc">o</span><span class="c">map_bn</span> <span class="w">&gt;</span><span class="pc">&gt; </span><span class="c">(</span><span class="w">ino</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span> <span class="pc">-</span> <span class="w">BBSHIFT)) +</span>
	      <span class="w">(</span><span class="pc">(</span><span class="w">of</span><span class="pc">f</span><span class="c">set</span> <span class="w">-</span> <span class="w">iomap_offset) &gt;</span><span class="c">&gt;</span> <span class="w">ino</span><span class="c">de-&gt;</span><span class="pc">i_</span><span class="c">blkbits</span><span class="w">)</span><span class="c">;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">b</span><span class="c">n</span> <span class="w">|</span><span class="c">|</span> <span class="w">XFS_IS_REALTIME_INODE</span><span class="c">(</span><span class="w">XFS_I(in</span><span class="pc">o</span><span class="c">de</span><span class="w">))</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_blocknr</span> <span class="pc">=</span> <span class="pc">b</span><span class="c">n</span><span class="pc">;</span>
	<span class="w">set_buffer_mapped</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_map_at_offset</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span>	<span class="c">*</span><span class="w">b</span><span class="pc">h,</span>
	<span class="c">struct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="w">imap</span><span class="pc">,</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="pc">f</span><span class="c">fset</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">i</span><span class="c">map-&gt;</span><span class="w">br_startblock</span> <span class="w">!</span><span class="c">=</span> <span class="w">HOLESTARTBLOCK</span><span class="pc">);</span>
	<span class="w">A</span><span class="c">SSERT(imap-&gt;</span><span class="pc">b</span><span class="c">r_startblock</span> <span class="w">!</span><span class="c">=</span> <span class="w">DELAYSTARTBLOCK</span><span class="pc">);</span>

	<span class="w">xfs_map_buffer</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">bh</span><span class="pc">,</span> <span class="c">imap</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">set_buffer_mapped</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
	<span class="w">clear_buffer_delay</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">clear_buffer_unwritten</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">bo</span><span class="c">ol</span>
<span class="w">xfs_check_page_type</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span>		<span class="c">*</span><span class="pc">p</span><span class="c">age,</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="c">int</span>		<span class="w">t</span><span class="pc">y</span><span class="c">pe,</span>
	<span class="w">b</span><span class="c">ool</span>			<span class="w">check_all_buffers</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bu</span><span class="pc">ffer_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span>	<span class="c">*</span><span class="w">h</span><span class="pc">e</span><span class="c">ad;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(</span><span class="w">PageWriteback</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">pa</span><span class="pc">g</span><span class="c">e</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">page_has_buffers</span><span class="c">(</span><span class="w">p</span><span class="c">age))</span>
		<span class="c">return</span> <span class="w">f</span><span class="c">alse;</span>

	<span class="w">bh</span> <span class="pc">=</span> <span class="w">he</span><span class="pc">ad</span> <span class="w">=</span> <span class="w">page_buffers</span><span class="c">(</span><span class="w">p</span><span class="pc">age</span><span class="c">);</span>
	<span class="w">d</span><span class="pc">o</span> <span class="pc">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">buffer_unwritten</span><span class="c">(</span><span class="w">bh</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">ty</span><span class="c">pe</span> <span class="c">==</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="c">)</span>
				<span class="c">return</span> <span class="pc">t</span><span class="c">rue;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">buffer_delay</span><span class="c">(</span><span class="w">bh</span><span class="pc">))</span><span class="c"> {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">==</span> <span class="w">XFS_IO_DELALLOC</span><span class="c">)</span>
				<span class="c">return</span> <span class="w">t</span><span class="c">rue;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="w">buffer_dirty</span><span class="c">(</span><span class="w">bh</span><span class="pc">) &amp;</span><span class="c">&amp;</span> <span class="w">buffer_mapped</span><span class="c">(</span><span class="w">bh</span><span class="pc">))</span><span class="c"> {</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ty</span><span class="c">pe</span> <span class="c">==</span> <span class="w">XFS_IO_OVERWRITE</span><span class="c">)</span>
				<span class="c">return</span> <span class="pc">t</span><span class="c">rue;</span>
		<span class="c">}</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">check_all_buffers</span><span class="pc">)</span>
			<span class="pc">b</span><span class="c">reak;</span>
	<span class="c">}</span> <span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="pc">((</span><span class="w">bh</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page)</span><span class="pc"> !</span><span class="c">=</span> <span class="w">he</span><span class="c">ad</span><span class="w">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">f</span><span class="c">alse;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_convert_page</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="w">p</span><span class="c">age</span>		<span class="c">*</span><span class="pc">p</span><span class="c">age</span><span class="pc">,</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">tindex</span><span class="pc">,</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="w">imap</span><span class="c">,</span>
	<span class="w">xfs_ioend_t</span>		<span class="w">*</span><span class="pc">*</span><span class="w">ioendp</span><span class="c">,</span>
	<span class="c">struct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">wbc</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bu</span><span class="pc">ffer_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">,</span><span class="c"> *</span><span class="w">h</span><span class="c">ead;</span>
	<span class="w">xfs_off_t</span>		<span class="w">end_offset</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">ns</span><span class="c">igned</span> <span class="c">long</span>		<span class="w">p_offset</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span>		<span class="pc">t</span><span class="c">ype;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">l</span><span class="c">en</span><span class="pc">,</span> <span class="w">page_dirty</span><span class="c">;</span>
	<span class="c">int</span>			<span class="w">c</span><span class="c">ount</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">do</span><span class="c">ne</span> <span class="w">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">uptodate</span> <span class="pc">=</span> <span class="pc">1;</span>
 	<span class="w">x</span><span class="c">fs_off_t</span>		<span class="w">o</span><span class="c">ffset</span> <span class="c">=</span> <span class="w">page_offset</span><span class="c">(</span><span class="w">pa</span><span class="pc">ge)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">pa</span><span class="pc">ge</span><span class="w">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">!</span><span class="c">=</span> <span class="w">tindex</span><span class="pc">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">f</span><span class="pc">ail</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">trylock_page</span><span class="c">(page</span><span class="pc">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">f</span><span class="c">ail;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">PageWriteback</span><span class="c">(page</span><span class="pc">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">fail_unlock_page</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">p</span><span class="c">age</span><span class="w">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">ap</span><span class="c">ping</span> <span class="w">!</span><span class="c">=</span> <span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_mapping)</span>
		<span class="c">goto</span> <span class="pc">f</span><span class="c">ail_unlock_page;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">xfs_check_page_type</span><span class="pc">(</span><span class="c">page</span><span class="w">, (*ioendp)-</span><span class="c">&gt;</span><span class="w">io_type,</span> <span class="w">fa</span><span class="pc">l</span><span class="c">se</span><span class="pc">))</span>
		<span class="c">goto</span> <span class="w">f</span><span class="pc">ail_</span><span class="c">unlock_page;</span>

	
	<span class="w">end_offset</span> <span class="pc">=</span> <span class="w">mi</span><span class="pc">n_</span><span class="c">t(</span><span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">long,</span>
			<span class="pc">(</span><span class="w">xfs_off_t)(p</span><span class="c">age</span><span class="w">-</span><span class="c">&gt;</span><span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="w">+</span> <span class="c">1</span><span class="w">) &lt;</span><span class="pc">&lt;</span> <span class="w">PAGE_CACHE_SHIFT,</span>
			<span class="w">i_size_read</span><span class="c">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">)</span><span class="c">);</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">xfs_imap_valid</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="w">imap</span><span class="c">,</span> <span class="pc">e</span><span class="c">nd_offset</span><span class="pc">))</span>
		<span class="w">g</span><span class="c">oto</span> <span class="pc">f</span><span class="c">ail_unlock_page;</span>

	<span class="w">l</span><span class="pc">en</span> <span class="c">=</span> <span class="w">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>
	<span class="w">p_offset</span> <span class="pc">=</span> <span class="w">mi</span><span class="pc">n_</span><span class="c">t(</span><span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span><span class="w">,</span> <span class="w">e</span><span class="c">nd_offset</span> <span class="w">&amp;</span><span class="pc"> (</span><span class="w">PAGE_CACHE_SIZE</span> <span class="pc">-</span> <span class="c">1</span><span class="w">)</span><span class="pc">,</span>
					<span class="pc">P</span><span class="c">AGE_CACHE_SIZE</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">p</span><span class="c">_offset</span> <span class="c">=</span> <span class="c">p_offset</span> <span class="w">?</span> <span class="w">roundup</span><span class="pc">(</span><span class="c">p_offset</span><span class="pc">,</span> <span class="w">l</span><span class="pc">en</span><span class="w">) </span><span class="pc">:</span> <span class="w">P</span><span class="c">AGE_CACHE_SIZE</span><span class="pc">;</span>
	<span class="w">page_dirty</span> <span class="pc">=</span> <span class="c">p_offset</span> <span class="w">/</span> <span class="w">l</span><span class="c">en;</span>

	
	<span class="w">bh</span> <span class="c">=</span> <span class="w">he</span><span class="pc">ad</span> <span class="pc">=</span> <span class="w">page_buffers</span><span class="pc">(</span><span class="w">p</span><span class="pc">age)</span><span class="c">;</span>
	<span class="w">do</span> <span class="pc">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">ffse</span><span class="c">t</span> <span class="pc">&gt;</span><span class="c">=</span> <span class="w">e</span><span class="c">nd_offset</span><span class="pc">)</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">buffer_uptodate</span><span class="pc">(</span><span class="w">bh</span><span class="c">))</span>
			<span class="w">uptodate</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!(</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">p</span><span class="pc">age</span><span class="w">) |</span><span class="c">|</span> <span class="w">b</span><span class="c">uffer_uptodate(</span><span class="w">bh))</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">do</span><span class="pc">n</span><span class="c">e</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">buffer_unwritten</span><span class="c">(</span><span class="w">bh) |</span><span class="c">|</span> <span class="w">buffer_delay</span><span class="c">(</span><span class="w">bh) |</span><span class="pc">|</span>
		    <span class="w">buffer_mapped</span><span class="c">(</span><span class="w">bh</span><span class="pc">)) </span><span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">b</span><span class="c">uffer_unwritten(</span><span class="w">bh</span><span class="c">))</span>
				<span class="w">ty</span><span class="pc">pe</span> <span class="c">=</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="pc">;</span>
			<span class="c">else</span> <span class="c">if</span> <span class="c">(</span><span class="w">b</span><span class="pc">uffer_d</span><span class="c">elay</span><span class="w">(bh)</span><span class="pc">)</span>
				<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">XFS_IO_DELALLOC</span><span class="pc">;</span>
			<span class="c">else</span>
				<span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">XFS_IO_OVERWRITE</span><span class="pc">;</span>

			
			<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">xfs_imap_valid</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">imap</span><span class="pc">,</span> <span class="w">o</span><span class="pc">ffset));</span>

			<span class="w">lock_buffer</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">X</span><span class="c">FS_IO_OVERWRITE)</span>
				<span class="w">xfs_map_at_offset</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">bh</span><span class="pc">,</span> <span class="c">imap</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">xfs_add_to_ioend</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">bh</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset,</span> <span class="w">t</span><span class="c">ype</span><span class="pc">,</span>
					 <span class="w">ioendp</span><span class="pc">,</span> <span class="w">do</span><span class="pc">n</span><span class="c">e</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">page_dirty-</span><span class="pc">-</span><span class="c">;</span>
			<span class="w">co</span><span class="pc">u</span><span class="c">nt</span><span class="pc">++</span><span class="c">;</span>
		<span class="c">}</span> <span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="c">{</span>
			<span class="w">d</span><span class="pc">o</span><span class="c">ne</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="c">}</span>
	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">+</span><span class="pc">=</span> <span class="w">l</span><span class="c">en</span><span class="w">,</span><span class="pc"> (</span><span class="w">bh</span> <span class="w">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page) !</span><span class="c">=</span> <span class="w">h</span><span class="c">ead</span><span class="w">)</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">uptodate</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">bh</span> <span class="pc">=</span><span class="c">=</span> <span class="w">h</span><span class="c">ead</span><span class="pc">)</span>
		<span class="w">SetPageUptodate</span><span class="c">(</span><span class="w">p</span><span class="pc">age)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">co</span><span class="pc">u</span><span class="c">nt</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">i</span><span class="c">f</span> <span class="w">(-</span><span class="c">-</span><span class="w">wbc-</span><span class="c">&gt;</span><span class="w">nr_to_write</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
		    <span class="c">wbc-&gt;</span><span class="w">sync_mode</span> <span class="c">==</span> <span class="w">WB_SYNC_NONE</span><span class="pc">)</span>
			<span class="w">do</span><span class="pc">n</span><span class="c">e</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">xfs_start_page_writeback</span><span class="pc">(p</span><span class="c">age</span><span class="w">, !page_dirty</span><span class="pc">,</span> <span class="w">c</span><span class="c">ount</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">d</span><span class="c">one;</span>
 <span class="w">fail_unlock_page</span><span class="pc">:</span>
	<span class="w">unlock_page</span><span class="c">(</span><span class="w">p</span><span class="pc">age</span><span class="c">);</span>
 <span class="w">fa</span><span class="pc">il</span><span class="c">:</span>
	<span class="c">return</span> <span class="w">1</span><span class="c">;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_cluster_write</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span>		<span class="c">*</span><span class="w">i</span><span class="c">node,</span>
	<span class="w">pgoff_t</span>			<span class="w">tindex</span><span class="pc">,</span>
	<span class="c">struct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="w">imap</span><span class="pc">,</span>
	<span class="w">xfs_ioend_t</span>		<span class="w">*</span><span class="pc">*</span><span class="w">ioendp</span><span class="c">,</span>
	<span class="c">struct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">wbc</span><span class="c">,</span>
	<span class="w">p</span><span class="c">goff_t</span>			<span class="w">tlast)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">pagevec</span>		<span class="w">pvec</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">do</span><span class="c">ne</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">i</span><span class="c">;</span>

	<span class="w">pagevec_init</span><span class="pc">(&amp;pv</span><span class="c">ec</span><span class="pc">,</span> <span class="pc">0)</span><span class="c">;</span>
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="pc">(!</span><span class="w">do</span><span class="c">ne</span> <span class="w">&amp;</span><span class="c">&amp;</span> <span class="w">tindex</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">t</span><span class="c">last) {</span>
		<span class="w">u</span><span class="pc">ns</span><span class="c">igned</span> <span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="c">=</span> <span class="w">m</span><span class="pc">in_</span><span class="c">t(</span><span class="w">p</span><span class="pc">g</span><span class="c">off_t,</span> <span class="w">PAGEVEC_SIZE</span><span class="c">,</span> <span class="w">t</span><span class="c">last</span> <span class="w">-</span> <span class="w">t</span><span class="pc">i</span><span class="c">ndex</span> <span class="pc">+</span> <span class="c">1);</span>

		<span class="c">if</span> <span class="pc">(!</span><span class="w">pagevec_lookup</span><span class="pc">(&amp;</span><span class="c">pvec</span><span class="pc">,</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mapping</span><span class="c">,</span> <span class="c">tindex</span><span class="pc">,</span> <span class="w">l</span><span class="c">en</span><span class="w">)</span><span class="pc">)</span>
			<span class="pc">b</span><span class="c">reak;</span>

		<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">pagevec_count(</span><span class="pc">&amp;pv</span><span class="c">ec</span><span class="pc">)</span><span class="c">;</span> <span class="pc">i++) </span><span class="c">{</span>
			<span class="w">do</span><span class="pc">n</span><span class="c">e</span> <span class="c">=</span> <span class="w">xfs_convert_page</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="pc">p</span><span class="c">vec</span><span class="w">.p</span><span class="pc">ages[</span><span class="c">i</span><span class="pc">],</span> <span class="pc">t</span><span class="c">index</span><span class="w">++</span><span class="pc">,</span>
					<span class="w">imap</span><span class="pc">,</span> <span class="w">ioendp</span><span class="c">,</span> <span class="w">wbc</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">do</span><span class="pc">n</span><span class="c">e)</span>
				<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>

		<span class="w">pagevec_release</span><span class="pc">(&amp;p</span><span class="c">vec</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">cond_resched</span><span class="pc">()</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_vm_invalidatepage</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">age</span>		<span class="c">*page</span><span class="pc">,</span>
	<span class="c">unsigned</span> <span class="c">int</span>		<span class="w">o</span><span class="pc">f</span><span class="c">fset,</span>
	<span class="c">unsigned</span> <span class="c">int</span>		<span class="w">l</span><span class="pc">eng</span><span class="c">th)</span>
<span class="c">{</span>
	<span class="w">trace_xfs_invalidatepage</span><span class="c">(page</span><span class="w">-</span><span class="c">&gt;</span><span class="w">map</span><span class="pc">p</span><span class="c">ing</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset,</span>
				 <span class="w">l</span><span class="pc">eng</span><span class="c">th);</span>
	<span class="w">block_invalidatepage</span><span class="c">(page,</span> <span class="pc">o</span><span class="c">ffset,</span> <span class="w">l</span><span class="pc">eng</span><span class="c">th);</span>
<span class="pc">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_aops_discard_page</span><span class="c">(</span>
	<span class="c">struct</span> <span class="c">page</span>		<span class="c">*page</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*</span><span class="pc">i</span><span class="c">node</span> <span class="c">=</span> <span class="pc">p</span><span class="c">age</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">h</span><span class="c">ost</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="pc">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">buff</span><span class="pc">er_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">,</span><span class="c"> *</span><span class="w">h</span><span class="pc">e</span><span class="c">ad;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>			<span class="w">o</span><span class="c">ffset</span> <span class="pc">=</span> <span class="w">page_offset</span><span class="c">(</span><span class="pc">p</span><span class="c">age);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">xfs_check_page_type</span><span class="c">(page</span><span class="pc">,</span> <span class="w">XFS_IO_DELALLOC</span><span class="c">,</span> <span class="w">tr</span><span class="pc">u</span><span class="c">e</span><span class="pc">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">out_invalidate</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mount))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_i</span><span class="c">nvalidate;</span>

	<span class="w">xfs_alert</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mount</span><span class="pc">,</span>
		<span class="w">"p</span><span class="pc">age</span> <span class="w">discard</span> <span class="w">o</span><span class="pc">n</span> <span class="w">p</span><span class="pc">age</span> <span class="c">%</span><span class="w">p</span><span class="pc">,</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span> <span class="w">0</span><span class="c">x%</span><span class="pc">ll</span><span class="c">x</span><span class="pc">,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="c">%</span><span class="w">l</span><span class="pc">l</span><span class="c">u</span><span class="w">.",</span>
			<span class="w">p</span><span class="c">age</span><span class="w">,</span> <span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span><span class="pc">);</span>

	<span class="w">xfs_ilock</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">XFS_ILOCK_EXCL</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">bh</span> <span class="pc">=</span> <span class="w">h</span><span class="c">ead</span> <span class="w">=</span> <span class="w">page_buffers</span><span class="c">(page</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">d</span><span class="pc">o</span> <span class="c">{</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span>		<span class="w">e</span><span class="pc">rro</span><span class="c">r</span><span class="pc">;</span>
		<span class="w">xfs_fileoff_t</span>	<span class="w">start_fsb</span><span class="pc">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">buffer_delay</span><span class="c">(</span><span class="w">bh</span><span class="pc">))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">next_buffer</span><span class="c">;</span>

		<span class="w">s</span><span class="pc">tar</span><span class="c">t_fsb</span> <span class="pc">=</span> <span class="w">XFS_B_TO_FSBT</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mount</span><span class="pc">,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset);</span>
		<span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_bmap_punch_delalloc_range</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="pc">s</span><span class="c">tart_fsb</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="pc">(</span><span class="w">ip-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">_</span><span class="c">mount</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">xfs_alert</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mount</span><span class="pc">,</span>
			<span class="w">"pa</span><span class="pc">g</span><span class="c">e</span> <span class="w">discard</span> <span class="w">un</span><span class="pc">a</span><span class="c">ble</span> <span class="c">to</span> <span class="w">rem</span><span class="c">ove</span> <span class="w">delalloc</span> <span class="w">m</span><span class="pc">ap</span><span class="c">ping</span><span class="w">.</span><span class="pc">"</span><span class="c">);</span>
			<span class="pc">}</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="c">}</span>
<span class="w">next_buffer</span><span class="pc">:</span>
		<span class="w">of</span><span class="pc">fset</span> <span class="w">+</span><span class="c">=</span> <span class="pc">1</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>

	<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">((</span><span class="w">bh</span> <span class="w">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page) </span><span class="pc">!</span><span class="c">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span><span class="w">)</span><span class="pc">;</span>

	<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">XFS_ILOCK_EXCL</span><span class="pc">)</span><span class="c">;</span>
<span class="w">out_invalidate:</span>
	<span class="w">xfs_vm_invalidatepage</span><span class="c">(</span><span class="w">p</span><span class="pc">ag</span><span class="c">e,</span> <span class="w">0</span><span class="c">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_vm_writepage</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">p</span><span class="c">age</span>		<span class="c">*page,</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">wbc</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode</span> <span class="c">=</span> <span class="w">p</span><span class="c">age</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bu</span><span class="pc">ffer_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">,</span><span class="c"> *</span><span class="w">h</span><span class="c">ead;</span>
	<span class="c">struct</span> <span class="w">xfs_bmbt_irec</span>	<span class="w">imap</span><span class="c">;</span>
	<span class="w">xfs_ioend_t</span>		<span class="w">*ioend</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">, </span><span class="c">*</span><span class="w">iohead</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>			<span class="w">of</span><span class="pc">fs</span><span class="c">et</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span>		<span class="w">t</span><span class="c">ype;</span>
	<span class="w">__uint64_t</span>              <span class="w">end_offset</span><span class="c">;</span>
	<span class="w">pgoff_t</span>                 <span class="w">end_index,</span> <span class="w">last_index</span><span class="c">;</span>
	<span class="w">ss</span><span class="pc">iz</span><span class="c">e_t</span>			<span class="w">l</span><span class="c">en;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">imap_valid</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">,</span> <span class="w">uptodate</span> <span class="pc">=</span> <span class="pc">1;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">c</span><span class="c">ount</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">nonblocking</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">trace_xfs_writepage</span><span class="pc">(</span><span class="w">ino</span><span class="c">de,</span> <span class="w">pa</span><span class="pc">g</span><span class="c">e,</span> <span class="w">0</span><span class="pc">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">page_has_buffers</span><span class="c">(</span><span class="w">p</span><span class="pc">age))</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">WARN_ON_ONCE((cu</span><span class="c">rrent</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">PF_MEMALLOC</span><span class="c">|</span><span class="w">PF_KSWAPD</span><span class="pc">)) =</span><span class="c">=</span>
			<span class="w">P</span><span class="c">F_MEMALLOC</span><span class="pc">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">redirty</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">W</span><span class="c">ARN_ON_ONCE</span><span class="pc">(</span><span class="w">cu</span><span class="c">rrent-&gt;</span><span class="w">f</span><span class="c">lags</span> <span class="pc">&amp;</span> <span class="w">PF_FSTRANS</span><span class="c">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">r</span><span class="c">edirty;</span>

	
	<span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="c">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">end_index</span> <span class="pc">=</span> <span class="w">of</span><span class="pc">f</span><span class="c">set</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="w">last_index</span> <span class="pc">= </span><span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">-</span> <span class="pc">1</span><span class="w">) &gt;</span><span class="c">&gt;</span> <span class="w">P</span><span class="pc">AGE_C</span><span class="c">ACHE_SHIFT;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="w">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">&lt;</span> <span class="w">e</span><span class="c">nd_index)</span>
		<span class="w">end_offset</span> <span class="pc">= </span><span class="c">(</span><span class="w">xfs_off_t)</span><span class="pc">(</span><span class="w">p</span><span class="c">age</span><span class="w">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">+</span> <span class="pc">1</span><span class="w">)</span><span class="pc"> &lt;</span><span class="c">&lt;</span> <span class="w">P</span><span class="pc">AGE_C</span><span class="c">ACHE_SHIFT;</span>
	<span class="w">e</span><span class="pc">l</span><span class="c">se</span> <span class="c">{</span>
		
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="w">offset_into_page</span> <span class="pc">=</span> <span class="w">o</span><span class="pc">ffset</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">PAGE_CACHE_SIZE</span> <span class="pc">-</span> <span class="pc">1</span><span class="c">);</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">&gt;</span> <span class="w">e</span><span class="pc">nd_i</span><span class="c">ndex</span> <span class="w">|</span><span class="c">|</span>
		    <span class="w">(</span><span class="pc">p</span><span class="c">age-&gt;</span><span class="w">i</span><span class="c">ndex</span> <span class="c">==</span> <span class="w">e</span><span class="c">nd_index</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">o</span><span class="c">ffset_into_page</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">))</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">redirty</span><span class="c">;</span>

		
		<span class="w">zero_user_segment</span><span class="c">(</span><span class="pc">p</span><span class="c">age,</span> <span class="w">o</span><span class="pc">ffset_</span><span class="c">into_page,</span> <span class="w">P</span><span class="c">AGE_CACHE_SIZE</span><span class="pc">)</span><span class="c">;</span>

		
		<span class="w">end_offset</span> <span class="pc">=</span> <span class="w">of</span><span class="pc">fset</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">l</span><span class="pc">e</span><span class="c">n</span> <span class="c">=</span> <span class="w">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>

	<span class="w">bh</span> <span class="pc">=</span> <span class="w">he</span><span class="pc">ad</span> <span class="pc">=</span> <span class="w">page_buffers</span><span class="pc">(p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">o</span><span class="pc">ffset</span> <span class="c">=</span> <span class="w">page_offset</span><span class="c">(</span><span class="pc">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ty</span><span class="pc">pe</span> <span class="c">=</span> <span class="w">XFS_IO_OVERWRITE</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">wbc</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">sync_mode</span> <span class="c">==</span> <span class="w">WB_SYNC_NONE</span><span class="pc">)</span>
		<span class="w">nonblocking</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>

	<span class="w">do</span> <span class="pc">{</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">new_ioend</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">ffs</span><span class="c">et</span> <span class="c">&gt;=</span> <span class="w">end_offset</span><span class="c">)</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">buffer_uptodate</span><span class="pc">(</span><span class="w">bh</span><span class="pc">))</span>
			<span class="w">uptodate</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">buffer_mapped</span><span class="c">(</span><span class="w">bh) &amp;</span><span class="pc">&amp;</span> <span class="w">b</span><span class="c">uffer_uptodate</span><span class="pc">(</span><span class="w">bh)</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">imap_valid</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="w">c</span><span class="pc">on</span><span class="c">tinue;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">buffer_unwritten</span><span class="c">(</span><span class="w">bh</span><span class="pc">))</span><span class="c"> {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">ty</span><span class="c">pe</span> <span class="pc">!</span><span class="c">=</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="pc">X</span><span class="c">FS_IO_UNWRITTEN;</span>
				<span class="pc">i</span><span class="c">map_valid</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">buffer_delay</span><span class="c">(</span><span class="w">bh</span><span class="pc">))</span><span class="c"> {</span>
			<span class="pc">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="pc">!</span><span class="c">=</span> <span class="w">XFS_IO_DELALLOC</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="pc">X</span><span class="c">FS_IO_DELALLOC;</span>
				<span class="w">i</span><span class="pc">m</span><span class="c">ap_valid</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="pc">))</span><span class="c"> {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">t</span><span class="c">ype</span> <span class="pc">!</span><span class="c">=</span> <span class="w">XFS_IO_OVERWRITE</span><span class="pc">) </span><span class="c">{</span>
				<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="pc">X</span><span class="c">FS_IO_OVERWRITE;</span>
				<span class="w">i</span><span class="pc">m</span><span class="c">ap_valid</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">PageUptodate</span><span class="c">(</span><span class="w">pag</span><span class="c">e</span><span class="w">))</span>
				<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">buffer_mapped</span><span class="c">(</span><span class="w">bh)</span><span class="pc">);</span>
			
			<span class="w">i</span><span class="pc">m</span><span class="c">ap_valid</span> <span class="pc">=</span> <span class="w">0</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(imap_valid</span><span class="w">)</span>
			<span class="pc">i</span><span class="c">map_valid</span> <span class="pc">=</span> <span class="w">xfs_imap_valid</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">imap</span><span class="pc">,</span> <span class="w">of</span><span class="pc">fs</span><span class="c">et);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">imap_valid</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="w">new_ioend</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_map_blocks</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">imap,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">,</span>
					     <span class="w">nonblocking</span><span class="c">);</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr)</span>
				<span class="c">goto</span> <span class="pc">e</span><span class="c">rror;</span>
			<span class="w">i</span><span class="pc">m</span><span class="c">ap_valid</span> <span class="c">=</span> <span class="w">x</span><span class="pc">fs_i</span><span class="c">map_valid(</span><span class="pc">in</span><span class="c">ode</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">imap,</span> <span class="w">o</span><span class="c">ffset);</span>
		<span class="pc">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i</span><span class="pc">map_</span><span class="c">valid</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">lock_buffer</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="pc">!</span><span class="c">=</span> <span class="w">XFS_IO_OVERWRITE</span><span class="c">)</span>
				<span class="w">xfs_map_at_offset</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">bh</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">imap,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset);</span>
			<span class="w">xfs_add_to_ioend</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="w">bh</span><span class="pc">,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span><span class="pc">,</span> <span class="w">t</span><span class="c">ype</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ioend</span><span class="pc">,</span>
					 <span class="w">new_ioend</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">co</span><span class="pc">u</span><span class="c">nt</span><span class="pc">++</span><span class="c">;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">iohead</span><span class="pc">)</span>
			<span class="w">io</span><span class="pc">h</span><span class="c">ead</span> <span class="c">=</span> <span class="w">i</span><span class="pc">oe</span><span class="c">nd</span><span class="pc">;</span>

	<span class="pc">}</span> <span class="pc">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">+</span><span class="pc">=</span> <span class="w">l</span><span class="pc">en</span><span class="w">, ((bh</span> <span class="w">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page) </span><span class="pc">!</span><span class="c">=</span> <span class="w">h</span><span class="c">ead</span><span class="w">))</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">uptodate</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">bh</span> <span class="pc">=</span><span class="c">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span><span class="pc">)</span>
		<span class="w">SetPageUptodate</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">xfs_start_page_writeback</span><span class="c">(</span><span class="pc">p</span><span class="c">age,</span> <span class="w">1</span><span class="c">,</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">i</span><span class="c">oend)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">iohead</span><span class="pc">);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">imap_valid</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">xfs_off_t</span>		<span class="w">end_index</span><span class="pc">;</span>

		<span class="pc">e</span><span class="c">nd_index</span> <span class="c">=</span> <span class="w">imap.br_startoff</span> <span class="w">+</span> <span class="w">im</span><span class="pc">ap</span><span class="w">.br_blockcount</span><span class="c">;</span>

		
		<span class="w">e</span><span class="c">nd_index</span> <span class="w">&lt;</span><span class="pc">&lt;</span><span class="c">=</span> <span class="w">ino</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_blkbits</span><span class="pc">;</span>

		
		<span class="w">e</span><span class="c">nd_index</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">e</span><span class="c">nd_index</span> <span class="w">-</span> <span class="c">1</span><span class="w">)</span><span class="pc"> &gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>

		
		<span class="pc">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">nd_index</span> <span class="c">&gt;</span> <span class="w">last_index</span><span class="c">)</span>
			<span class="w">e</span><span class="c">nd_index</span> <span class="c">=</span> <span class="c">last_index;</span>

		<span class="w">xfs_cluster_write</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">p</span><span class="c">age</span><span class="w">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">+</span> <span class="pc">1</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">im</span><span class="c">ap</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">ioend</span><span class="pc">,</span>
				  <span class="w">wbc</span><span class="pc">,</span> <span class="c">end_index</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>


	
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_type</span> <span class="pc">!</span><span class="c">=</span> <span class="w">XFS_IO_UNWRITTEN</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">xfs_ioend_is_append</span><span class="c">(</span><span class="pc">ioe</span><span class="c">nd</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_setfilesize_trans_alloc</span><span class="c">(</span><span class="pc">ioe</span><span class="c">nd</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">xfs_submit_ioend</span><span class="c">(</span><span class="w">w</span><span class="c">bc,</span> <span class="w">iohead</span><span class="c">,</span> <span class="w">e</span><span class="pc">r</span><span class="c">r);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>

<span class="w">e</span><span class="pc">rro</span><span class="c">r:</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">oh</span><span class="c">ead</span><span class="w">)</span>
		<span class="w">xfs_cancel_ioend</span><span class="c">(</span><span class="pc">ioh</span><span class="c">ead</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">== </span><span class="c">-</span><span class="pc">EA</span><span class="c">GAIN)</span>
		<span class="c">goto</span> <span class="w">redirty</span><span class="c">;</span>

	<span class="w">xfs_aops_discard_page</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ClearPageUptodate</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">unlock_page</span><span class="c">(</span><span class="w">p</span><span class="c">age);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>

<span class="pc">r</span><span class="c">edirty:</span>
	<span class="w">redirty_page_for_writepage</span><span class="c">(</span><span class="w">wbc</span><span class="pc">,</span> <span class="w">p</span><span class="c">age);</span>
	<span class="w">u</span><span class="c">nlock_page(page);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_vm_writepages</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">address_space</span>	<span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">writeback_control</span> <span class="c">*</span><span class="w">w</span><span class="c">bc)</span>
<span class="c">{</span>
	<span class="w">xfs_iflags_clear</span><span class="c">(</span><span class="w">XFS_I</span><span class="pc">(</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing</span><span class="w">-</span><span class="c">&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">),</span> <span class="w">XFS_ITRUNCATED</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">generic_writepages</span><span class="c">(</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span> <span class="c">wbc);</span>
<span class="c">}</span>


<span class="w">S</span><span class="c">TATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_vm_releasepage</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span>		<span class="c">*</span><span class="pc">p</span><span class="c">age,</span>
	<span class="w">g</span><span class="c">fp_t</span>			<span class="w">gfp_mask</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">delalloc</span><span class="pc">,</span> <span class="w">unwritten</span><span class="pc">;</span>

	<span class="w">trace_xfs_releasepage</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="w">-</span><span class="c">&gt;</span><span class="w">m</span><span class="c">apping</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="w">p</span><span class="pc">ag</span><span class="c">e,</span> <span class="w">0</span><span class="c">,</span> <span class="c">0);</span>

	<span class="w">xfs_count_page_state</span><span class="c">(page</span><span class="pc">, &amp;</span><span class="w">d</span><span class="c">elalloc</span><span class="pc">, </span><span class="c">&amp;unwritten</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">WARN_ON_ONCE</span><span class="c">(</span><span class="w">d</span><span class="c">elalloc</span><span class="pc">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">W</span><span class="c">ARN_ON_ONCE(</span><span class="pc">u</span><span class="c">nwritten</span><span class="pc">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">try_to_free_buffers</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">xfs_map_direct</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="c">node</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span>	<span class="c">*</span><span class="w">bh_result</span><span class="pc">,</span>
	<span class="c">struct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="w">imap</span><span class="pc">,</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="pc">ffs</span><span class="c">et)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_ioend</span>	<span class="c">*</span><span class="w">ioend</span><span class="pc">;</span>
	<span class="w">x</span><span class="pc">fs_o</span><span class="c">ff_t</span>		<span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">=</span> <span class="pc">b</span><span class="c">h_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span>			<span class="w">t</span><span class="c">ype</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">ISUNWRITTEN</span><span class="c">(</span><span class="pc">im</span><span class="c">ap</span><span class="pc">))</span>
		<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">XFS_IO_UNWRITTEN</span><span class="pc">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">XFS_IO_OVERWRITE</span><span class="c">;</span>

	<span class="w">trace_xfs_gbmap_direct</span><span class="pc">(</span><span class="w">XFS_I</span><span class="pc">(</span><span class="w">ino</span><span class="c">de</span><span class="w">)</span><span class="pc">,</span> <span class="w">o</span><span class="pc">ffs</span><span class="c">et</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">,</span> <span class="w">i</span><span class="pc">m</span><span class="c">ap);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">b</span><span class="c">h_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_private</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">ioend</span> <span class="pc">=</span> <span class="c">bh_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">b</span><span class="c">_private;</span>
		<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_size</span> <span class="w">&gt;</span> <span class="c">0</span><span class="pc">);</span>
		<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="c">ioend-&gt;</span><span class="w">io_offset</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">o</span><span class="c">ffset</span> <span class="w">+</span> <span class="w">s</span><span class="c">ize</span> <span class="pc">&gt;</span> <span class="pc">i</span><span class="c">oend-&gt;</span><span class="pc">io_</span><span class="c">offset</span> <span class="w">+</span> <span class="w">i</span><span class="pc">oe</span><span class="c">nd-&gt;</span><span class="w">i</span><span class="pc">o_s</span><span class="c">ize</span><span class="w">)</span>
			<span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">i</span><span class="pc">o_s</span><span class="c">ize</span> <span class="pc">=</span> <span class="w">o</span><span class="c">ffset</span> <span class="w">-</span> <span class="pc">i</span><span class="c">oend-&gt;</span><span class="pc">io_o</span><span class="c">ffset</span> <span class="c">+</span> <span class="w">s</span><span class="c">ize</span><span class="pc">;</span>

		<span class="pc">if</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="pc">=</span><span class="c">=</span> <span class="w">XFS_IO_UNWRITTEN</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="pc">!</span><span class="c">=</span> <span class="c">ioend-&gt;</span><span class="w">io_type</span><span class="pc">)</span>
			<span class="w">i</span><span class="pc">oe</span><span class="c">nd-&gt;io_type</span> <span class="c">=</span> <span class="pc">X</span><span class="c">FS_IO_UNWRITTEN</span><span class="pc">;</span>

		<span class="w">trace_xfs_gbmap_direct_update</span><span class="c">(</span><span class="w">XFS_I</span><span class="pc">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">),</span> <span class="c">ioend-&gt;</span><span class="w">i</span><span class="pc">o_o</span><span class="c">ffset</span><span class="pc">,</span>
					      <span class="c">ioend-&gt;</span><span class="w">i</span><span class="pc">o_s</span><span class="c">ize,</span> <span class="c">ioend-&gt;</span><span class="pc">io_t</span><span class="c">ype</span><span class="pc">,</span>
					      <span class="w">imap</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">==</span> <span class="pc">X</span><span class="c">FS_IO_UNWRITTEN</span> <span class="pc">|</span><span class="c">|</span>
		   <span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">+</span> <span class="w">s</span><span class="pc">ize</span> <span class="w">&gt;</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">oe</span><span class="c">nd</span> <span class="pc">=</span> <span class="w">xfs_alloc_ioend</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">ty</span><span class="c">pe</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">io</span><span class="c">end</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">io_</span><span class="c">offset</span> <span class="c">=</span> <span class="w">o</span><span class="c">ffset;</span>
		<span class="pc">io</span><span class="c">end-&gt;</span><span class="w">i</span><span class="pc">o_s</span><span class="c">ize</span> <span class="c">=</span> <span class="w">s</span><span class="c">ize;</span>

		<span class="w">bh_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_private</span> <span class="c">=</span> <span class="pc">i</span><span class="c">oend;</span>
		<span class="w">set_buffer_defer_completion</span><span class="c">(</span><span class="pc">b</span><span class="c">h_result</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">trace_xfs_gbmap_direct_new</span><span class="pc">(</span><span class="w">XFS_I</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">),</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">,</span>
					   <span class="w">imap</span><span class="c">);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">trace_xfs_gbmap_direct_none</span><span class="c">(</span><span class="w">X</span><span class="c">FS_I</span><span class="pc">(</span><span class="w">ino</span><span class="c">de</span><span class="pc">),</span> <span class="w">o</span><span class="c">ffset,</span> <span class="pc">si</span><span class="c">ze</span><span class="pc">,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">,</span>
					    <span class="pc">i</span><span class="c">map);</span>
	<span class="pc">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">xfs_map_trim_size</span><span class="c">(</span>
	<span class="c">struct</span> <span class="pc">i</span><span class="c">node</span>		<span class="c">*inode,</span>
	<span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span>		<span class="w">iblock</span><span class="c">,</span>
	<span class="c">struct</span> <span class="w">buff</span><span class="pc">er_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh_result</span><span class="pc">,</span>
	<span class="c">struct</span> <span class="w">xfs_bmbt_irec</span>	<span class="c">*</span><span class="pc">i</span><span class="c">map,</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="c">ffset,</span>
	<span class="w">ss</span><span class="c">ize_t</span>			<span class="pc">s</span><span class="c">ize)</span>
<span class="pc">{</span>
	<span class="w">x</span><span class="pc">fs_o</span><span class="c">ff_t</span>		<span class="w">mapping_size</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">apping_size</span> <span class="c">=</span> <span class="w">i</span><span class="pc">m</span><span class="c">ap</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">br_startoff</span> <span class="w">+</span> <span class="pc">i</span><span class="c">map</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">br_blockcount</span> <span class="w">-</span> <span class="w">i</span><span class="pc">b</span><span class="c">lock;</span>
	<span class="pc">m</span><span class="c">apping_size</span> <span class="w">&lt;</span><span class="pc">&lt;</span><span class="c">=</span> <span class="w">ino</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">m</span><span class="c">apping_size</span> <span class="w">&gt;</span> <span class="pc">0);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">m</span><span class="c">apping_size</span> <span class="c">&gt;</span> <span class="w">s</span><span class="c">ize)</span>
		<span class="w">m</span><span class="c">apping_size</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">ize</span><span class="c">;</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="pc">&lt;</span> <span class="w">i_size_read(in</span><span class="pc">o</span><span class="c">de</span><span class="w">) &amp;</span><span class="c">&amp;</span>
	    <span class="w">o</span><span class="pc">ffs</span><span class="c">et</span> <span class="w">+</span> <span class="pc">m</span><span class="c">apping_size</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">i</span><span class="pc">_</span><span class="c">size_read</span><span class="w">(in</span><span class="pc">o</span><span class="c">de)) {</span>
		
		<span class="w">m</span><span class="c">apping_size</span> <span class="w">=</span> <span class="w">roundup_64</span><span class="c">(</span><span class="pc">i</span><span class="c">_size_read</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">) </span><span class="pc">-</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">,</span>
					  <span class="w">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_blkbits</span><span class="c">);</span>
	<span class="pc">}</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">m</span><span class="c">apping_size</span> <span class="w">&gt;</span> <span class="w">LONG_MAX</span><span class="c">)</span>
		<span class="w">m</span><span class="pc">a</span><span class="c">pping_size</span> <span class="pc">=</span> <span class="pc">L</span><span class="c">ONG_MAX</span><span class="pc">;</span>

	<span class="w">bh_result-</span><span class="pc">&gt;</span><span class="w">b_size</span> <span class="c">=</span> <span class="pc">m</span><span class="c">apping_size;</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">__xfs_get_blocks</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span>		<span class="w">iblock</span><span class="c">,</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">buf</span><span class="pc">fer_</span><span class="c">head</span>	<span class="c">*bh_result</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">cr</span><span class="pc">ea</span><span class="c">te</span><span class="pc">,</span>
	<span class="w">b</span><span class="pc">o</span><span class="c">ol</span>			<span class="w">direct</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span> <span class="c">=</span> <span class="w">ip</span><span class="c">-&gt;</span><span class="w">i_mount</span><span class="c">;</span>
	<span class="w">xfs_fileoff_t</span>		<span class="w">offset_fsb,</span> <span class="w">end_fsb</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">lockmode</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">xfs_bmbt_irec</span>	<span class="w">imap</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">nimaps</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="w">xfs_off_t</span>		<span class="w">o</span><span class="pc">ffset</span><span class="c">;</span>
	<span class="w">ss</span><span class="c">ize_t</span>			<span class="pc">s</span><span class="c">ize;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">ne</span><span class="c">w</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="pc">(</span><span class="w">mp)</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>

	<span class="w">o</span><span class="pc">ffs</span><span class="c">et</span> <span class="pc">= </span><span class="c">(</span><span class="w">x</span><span class="c">fs_off_t</span><span class="w">)iblock</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">ino</span><span class="c">de-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">bh_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span> <span class="w">&gt;= (1</span> <span class="c">&lt;&lt;</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e-&gt;i_blkbits</span><span class="w">))</span><span class="pc">;</span>
	<span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="c">=</span> <span class="c">bh_result</span><span class="pc">-</span><span class="c">&gt;b_size;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">cr</span><span class="pc">ea</span><span class="c">te</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">direct</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="pc">&gt;=</span> <span class="w">i_size_read(in</span><span class="pc">o</span><span class="c">de</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">0</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cr</span><span class="pc">e</span><span class="c">ate</span> <span class="w">&amp;</span><span class="pc">&amp;</span><span class="c"> !</span><span class="w">d</span><span class="c">irect</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">lockmode</span> <span class="pc">=</span> <span class="w">XFS_ILOCK_EXCL</span><span class="pc">;</span>
		<span class="w">xfs_ilock</span><span class="pc">(</span><span class="w">ip</span><span class="c">,</span> <span class="c">lockmode);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">l</span><span class="c">ockmode</span> <span class="c">=</span> <span class="w">xfs_ilock_data_map_shared</span><span class="c">(</span><span class="w">ip</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">mp</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m_super-</span><span class="pc">&gt;</span><span class="w">s_maxbytes</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="w">+</span> <span class="w">s</span><span class="pc">ize</span> <span class="pc">&gt;</span> <span class="w">mp</span><span class="c">-&gt;m_super</span><span class="pc">-</span><span class="c">&gt;s_maxbytes</span><span class="w">)</span>
		<span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">=</span> <span class="w">m</span><span class="pc">p</span><span class="c">-&gt;</span><span class="pc">m</span><span class="c">_super</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s_</span><span class="c">maxbytes</span> <span class="w">-</span> <span class="pc">o</span><span class="c">ffset;</span>
	<span class="w">end_fsb</span> <span class="pc">=</span> <span class="w">XFS_B_TO_FSB</span><span class="c">(</span><span class="w">mp,</span><span class="pc"> (</span><span class="w">xfs_ufsize_t)o</span><span class="c">ffset</span> <span class="pc">+</span> <span class="pc">s</span><span class="c">ize);</span>
	<span class="w">offset_fsb</span> <span class="pc">=</span> <span class="w">XFS_B_TO_FSBT</span><span class="c">(</span><span class="w">m</span><span class="pc">p,</span> <span class="pc">o</span><span class="c">ffset</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_bmapi_read</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="pc">offset_</span><span class="c">fsb,</span> <span class="pc">e</span><span class="c">nd_fsb</span> <span class="w">-</span> <span class="pc">offs</span><span class="c">et_fsb,</span>
				<span class="w">&amp;imap,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">nimaps</span><span class="pc">,</span> <span class="w">XFS_BMAPI_ENTIRE</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="pc">r</span><span class="c">ror)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_u</span><span class="c">nlock;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cr</span><span class="pc">e</span><span class="c">ate</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
	    <span class="w">(</span><span class="pc">!n</span><span class="c">imaps</span> <span class="pc">|</span><span class="c">|</span>
	     <span class="w">(i</span><span class="c">map</span><span class="w">.br_startblock</span> <span class="pc">=</span><span class="c">=</span> <span class="w">HOLESTARTBLOCK</span> <span class="pc">|</span><span class="c">|</span>
	      <span class="w">i</span><span class="pc">m</span><span class="c">ap</span><span class="w">.</span><span class="c">br_startblock</span> <span class="c">==</span> <span class="w">DELAYSTARTBLOCK))</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">direct</span> <span class="w">|</span><span class="c">|</span> <span class="w">xfs_get_extsz_hint</span><span class="pc">(</span><span class="w">ip))</span><span class="pc"> </span><span class="c">{</span>
			
			<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">ip</span><span class="pc">,</span> <span class="w">lockmode</span><span class="c">);</span>
			<span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_iomap_write_direct</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">of</span><span class="pc">fs</span><span class="c">et</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize,</span>
						       <span class="w">&amp;</span><span class="pc">i</span><span class="c">map</span><span class="pc">,</span> <span class="w">nimaps</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r)</span>
				<span class="c">return</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
			<span class="w">n</span><span class="pc">e</span><span class="c">w</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>

		<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
			
			<span class="c">if</span> <span class="c">(nimaps</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">i</span><span class="pc">m</span><span class="c">ap</span><span class="w">.br_startblock</span> <span class="pc">=</span><span class="c">=</span> <span class="w">HOLESTARTBLOCK</span><span class="c">)</span>
				<span class="w">n</span><span class="pc">e</span><span class="c">w</span> <span class="pc">=</span> <span class="c">1;</span>
			<span class="w">e</span><span class="pc">r</span><span class="c">ror</span> <span class="c">=</span> <span class="w">xfs_iomap_write_delay</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset,</span> <span class="w">s</span><span class="pc">ize, </span><span class="c">&amp;</span><span class="pc">i</span><span class="c">map);</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r</span><span class="pc">)</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_</span><span class="c">unlock;</span>

			<span class="w">xfs_iunlock</span><span class="pc">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">lockmode</span><span class="c">);</span>
		<span class="pc">}</span>
		<span class="w">trace_xfs_get_blocks_alloc</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="pc">ffs</span><span class="c">et,</span> <span class="c">size</span><span class="pc">,</span>
				<span class="w">ISUNWRITTEN(</span><span class="pc">&amp;i</span><span class="c">map</span><span class="w">) ?</span> <span class="w">XFS_IO_UNWRITTEN</span>
						   <span class="c">:</span> <span class="w">XFS_IO_DELALLOC,</span><span class="pc"> </span><span class="c">&amp;</span><span class="pc">i</span><span class="c">map</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">nimaps</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">trace_xfs_get_blocks_found</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="c">ffset,</span> <span class="pc">s</span><span class="c">ize</span><span class="pc">,</span>
				<span class="w">I</span><span class="c">SUNWRITTEN</span><span class="w">(</span><span class="pc">&amp;</span><span class="c">imap</span><span class="w">) ?</span> <span class="w">X</span><span class="c">FS_IO_UNWRITTEN</span>
						   <span class="pc">:</span> <span class="w">XFS_IO_OVERWRITE,</span><span class="pc"> </span><span class="c">&amp;imap</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">,</span> <span class="w">lockmode</span><span class="c">);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">trace_xfs_get_blocks_notfound</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset,</span> <span class="w">s</span><span class="pc">ize</span><span class="c">);</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">o</span><span class="pc">ut_u</span><span class="c">nlock;</span>
	<span class="c">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">direct</span> <span class="w">|</span><span class="c">|</span> <span class="w">s</span><span class="pc">ize</span> <span class="w">&gt; (1</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">in</span><span class="pc">o</span><span class="c">de-&gt;</span><span class="w">i_blkbits)</span><span class="pc">)</span>
		<span class="w">xfs_map_trim_size</span><span class="c">(</span><span class="w">i</span><span class="pc">no</span><span class="c">de,</span> <span class="w">iblock</span><span class="c">,</span> <span class="w">bh_result</span><span class="pc">,</span>
				  <span class="c">&amp;</span><span class="w">imap</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset,</span> <span class="w">s</span><span class="pc">ize)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">m</span><span class="c">ap</span><span class="w">.br_startblock</span> <span class="w">!</span><span class="c">=</span> <span class="w">HOLESTARTBLOCK</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="pc">im</span><span class="c">ap</span><span class="pc">.</span><span class="c">br_startblock</span> <span class="pc">!</span><span class="c">=</span> <span class="w">DELAYSTARTBLOCK</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
	    <span class="w">(cr</span><span class="pc">e</span><span class="c">ate</span> <span class="w">|</span><span class="pc">| </span><span class="c">!</span><span class="w">ISUNWRITTEN(</span><span class="pc">&amp;im</span><span class="c">ap</span><span class="w">))</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">xfs_map_buffer</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="pc">b</span><span class="c">h_result</span><span class="pc">, &amp;im</span><span class="c">ap</span><span class="pc">,</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="pc">SU</span><span class="c">NWRITTEN</span><span class="w">(</span><span class="pc">&amp;</span><span class="c">imap</span><span class="pc">)</span><span class="c">)</span>
			<span class="w">set_buffer_unwritten</span><span class="c">(</span><span class="w">b</span><span class="pc">h</span><span class="c">_result</span><span class="pc">)</span><span class="c">;</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cr</span><span class="c">eate</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">direct</span><span class="pc">)</span>
			<span class="w">xfs_map_direct</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="pc">b</span><span class="c">h_result</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">i</span><span class="c">map</span><span class="pc">,</span> <span class="w">of</span><span class="pc">fset)</span><span class="c">;</span>
	<span class="pc">}</span>

	
	<span class="w">b</span><span class="c">h_result</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_bdev</span> <span class="c">=</span> <span class="w">xfs_find_bdev_for_inode</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="pc">ea</span><span class="c">te</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
	    <span class="w">((!buffer_mapped</span><span class="c">(</span><span class="pc">b</span><span class="c">h_result</span><span class="w">) &amp;</span><span class="pc">&amp; </span><span class="c">!</span><span class="w">buffer_uptodate</span><span class="c">(</span><span class="pc">bh</span><span class="c">_result</span><span class="w">)) </span><span class="pc">|</span><span class="c">|</span>
	     <span class="c">(</span><span class="w">of</span><span class="pc">fs</span><span class="c">et</span> <span class="w">&gt;</span><span class="c">=</span> <span class="w">i_size_read(in</span><span class="pc">o</span><span class="c">de</span><span class="w">)) </span><span class="pc">|</span><span class="c">|</span>
	     <span class="pc">(</span><span class="w">ne</span><span class="pc">w</span> <span class="w">|</span><span class="c">|</span> <span class="w">ISUNWRITTEN(</span><span class="pc">&amp;</span><span class="w">i</span><span class="pc">m</span><span class="c">ap</span><span class="w">))))</span>
		<span class="w">set_buffer_new</span><span class="pc">(</span><span class="w">b</span><span class="pc">h</span><span class="c">_result</span><span class="pc">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span><span class="c">map</span><span class="w">.br_startblock</span> <span class="c">==</span> <span class="w">DELAYSTARTBLOCK</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">B</span><span class="c">UG_ON(</span><span class="w">direct</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cr</span><span class="pc">ea</span><span class="c">te</span><span class="w">)</span><span class="c"> {</span>
			<span class="w">set_buffer_uptodate</span><span class="c">(bh_result</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">set_buffer_mapped</span><span class="c">(</span><span class="pc">b</span><span class="c">h_result</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">set_buffer_delay</span><span class="c">(</span><span class="w">b</span><span class="pc">h</span><span class="c">_result);</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">o</span><span class="pc">ut_</span><span class="c">unlock:</span>
	<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">ip</span><span class="pc">,</span> <span class="w">lockmode</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
<span class="c">}</span>

<span class="w">i</span><span class="c">nt</span>
<span class="w">xfs_get_blocks</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="w">s</span><span class="pc">ec</span><span class="c">tor_t</span>		<span class="w">iblock</span><span class="c">,</span>
	<span class="c">struct</span> <span class="w">bu</span><span class="pc">ffer_</span><span class="c">head</span>	<span class="c">*</span><span class="pc">b</span><span class="c">h_result</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">cr</span><span class="pc">e</span><span class="c">ate)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">__xfs_get_blocks</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="pc">ib</span><span class="c">lock,</span> <span class="c">bh_result</span><span class="pc">,</span> <span class="w">cr</span><span class="pc">e</span><span class="c">ate</span><span class="pc">,</span> <span class="w">fa</span><span class="c">lse);</span>
<span class="c">}</span>

<span class="w">i</span><span class="c">nt</span>
<span class="w">xfs_get_blocks_direct</span><span class="c">(</span>
	<span class="c">struct</span> <span class="pc">in</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span>		<span class="w">i</span><span class="c">block,</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">b</span><span class="pc">uff</span><span class="c">er_head</span>	<span class="c">*bh_result</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">cr</span><span class="pc">e</span><span class="c">ate)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">_</span><span class="c">_xfs_get_blocks</span><span class="pc">(in</span><span class="c">ode,</span> <span class="c">iblock</span><span class="pc">,</span> <span class="c">bh_result</span><span class="pc">,</span> <span class="w">cr</span><span class="pc">e</span><span class="c">ate</span><span class="pc">,</span> <span class="w">t</span><span class="pc">r</span><span class="c">ue);</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span>
<span class="w">__xfs_end_io_direct_write</span><span class="c">(</span>
	<span class="c">struct</span> <span class="pc">in</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="w">xfs_ioend</span>	<span class="c">*</span><span class="w">ioend</span><span class="pc">,</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">o</span><span class="pc">f</span><span class="c">fset</span><span class="pc">,</span>
	<span class="w">ss</span><span class="c">ize_t</span>			<span class="pc">s</span><span class="c">ize)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_mount</span>	<span class="c">*</span><span class="w">mp</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(inode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mount</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="c">(</span><span class="w">mp) |</span><span class="c">|</span> <span class="c">ioend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_error</span><span class="c">)</span>
		<span class="w">g</span><span class="c">oto</span> <span class="w">out_end_io</span><span class="c">;</span>

	
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">si</span><span class="c">ze</span> <span class="w">&gt;</span> <span class="pc">0);</span>

	
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">of</span><span class="pc">fs</span><span class="c">et</span> <span class="w">+</span> <span class="pc">s</span><span class="c">ize</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_offset</span> <span class="w">+</span> <span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_size</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">oe</span><span class="c">nd</span><span class="pc">-</span><span class="c">&gt;io_size</span> <span class="c">=</span> <span class="w">s</span><span class="pc">ize</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">o</span><span class="c">end-&gt;</span><span class="pc">io_o</span><span class="c">ffset</span> <span class="c">=</span> <span class="w">o</span><span class="pc">f</span><span class="c">fset;</span>

	
	<span class="w">s</span><span class="pc">pin_l</span><span class="c">ock(&amp;</span><span class="w">XFS_I(in</span><span class="pc">o</span><span class="c">de</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_flags_lock</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">o</span><span class="c">ffset</span> <span class="w">+</span> <span class="w">s</span><span class="c">ize</span> <span class="pc">&gt;</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">in</span><span class="c">ode</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">i_size_write</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset</span> <span class="pc">+</span> <span class="pc">s</span><span class="c">ize);</span>
	<span class="w">s</span><span class="pc">pin_u</span><span class="c">nlock(&amp;</span><span class="w">X</span><span class="c">FS_I</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_</span><span class="pc">f</span><span class="c">lags_lock);</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ioend-</span><span class="c">&gt;</span><span class="w">io_type</span> <span class="c">==</span> <span class="w">XFS_IO_OVERWRITE</span><span class="c">)</span>
		<span class="pc">io</span><span class="c">end</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_error</span> <span class="c">=</span> <span class="w">xfs_setfilesize_trans_alloc</span><span class="c">(ioend</span><span class="pc">)</span><span class="c">;</span>

<span class="w">out_end_io:</span>
	<span class="w">xfs_end_io</span><span class="pc">(&amp;</span><span class="c">ioend-&gt;</span><span class="w">io_work</span><span class="c">);</span>
	<span class="c">return</span><span class="pc">;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_end_io_direct_write</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">kiocb</span>		<span class="c">*</span><span class="w">iocb</span><span class="pc">,</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>			<span class="w">o</span><span class="pc">f</span><span class="c">fset,</span>
	<span class="w">ss</span><span class="c">ize_t</span>			<span class="pc">s</span><span class="c">ize</span><span class="pc">,</span>
	<span class="w">v</span><span class="c">oid</span>			<span class="c">*</span><span class="w">pr</span><span class="pc">iva</span><span class="c">te</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span>		<span class="c">*inode</span> <span class="c">=</span> <span class="w">file_inode</span><span class="c">(iocb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ki_filp</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">xfs_ioend</span>	<span class="c">*</span><span class="w">ioend</span> <span class="pc">=</span> <span class="w">pr</span><span class="pc">iva</span><span class="c">te</span><span class="pc">;</span>

	<span class="w">trace_xfs_gbmap_direct_endio</span><span class="c">(</span><span class="w">XFS_I</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">)</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset</span><span class="pc">,</span> <span class="w">s</span><span class="pc">ize,</span>
				     <span class="c">ioend</span> <span class="w">?</span> <span class="w">i</span><span class="pc">o</span><span class="c">end-&gt;</span><span class="w">io_type</span> <span class="w">:</span> <span class="w">0</span><span class="c">,</span> <span class="pc">N</span><span class="c">ULL);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">ioend</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">A</span><span class="c">SSERT(</span><span class="w">o</span><span class="pc">ffs</span><span class="c">et</span> <span class="w">+</span> <span class="w">s</span><span class="pc">ize</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">ino</span><span class="c">de</span><span class="w">)</span><span class="pc">);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
	<span class="c">}</span>

	<span class="w">__xfs_end_io_direct_write</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="c">ioend,</span> <span class="pc">o</span><span class="c">ffset,</span> <span class="pc">s</span><span class="c">ize);</span>
<span class="c">}</span>


<span class="pc">#i</span><span class="c">fdef</span> <span class="w">CONFIG_FS_DAX</span>
<span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_end_io_dax_write</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span>	<span class="c">*</span><span class="w">bh</span><span class="pc">,</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">uptodate</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_ioend</span>	<span class="c">*</span><span class="pc">i</span><span class="c">oend</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_private</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span>		<span class="c">*</span><span class="pc">in</span><span class="c">ode</span> <span class="pc">=</span> <span class="pc">i</span><span class="c">oend</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_inode</span><span class="c">;</span>
	<span class="w">ss</span><span class="c">ize_t</span>			<span class="w">s</span><span class="c">ize</span> <span class="pc">=</span> <span class="w">i</span><span class="pc">oe</span><span class="c">nd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">io_size</span><span class="c">;</span>

	<span class="w">A</span><span class="c">SSERT(</span><span class="w">IS_DAX</span><span class="c">(</span><span class="pc">ioe</span><span class="c">nd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">o_i</span><span class="c">node</span><span class="pc">))</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!u</span><span class="c">ptodate</span><span class="pc">)</span>
		<span class="pc">i</span><span class="c">oend-&gt;</span><span class="w">io_error</span> <span class="w">=</span><span class="pc"> -</span><span class="w">E</span><span class="pc">I</span><span class="c">O;</span>

	
	<span class="w">s</span><span class="pc">pin_l</span><span class="c">ock(&amp;</span><span class="w">XFS_I</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">)-</span><span class="c">&gt;</span><span class="w">i_flags_lock</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(ioend-&gt;</span><span class="w">io_offset</span> <span class="w">+</span> <span class="w">s</span><span class="c">ize</span> <span class="w">&gt;</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">in</span><span class="c">ode</span><span class="pc">)</span><span class="c">)</span>
		<span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">=</span> <span class="w">i_</span><span class="pc">s</span><span class="c">ize_read(</span><span class="pc">in</span><span class="c">ode</span><span class="w">)</span><span class="pc"> -</span> <span class="pc">io</span><span class="c">end-&gt;</span><span class="w">i</span><span class="pc">o_o</span><span class="c">ffset</span><span class="w">;</span>
	<span class="w">s</span><span class="c">pin_unlock(&amp;</span><span class="pc">X</span><span class="c">FS_I</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="w">)</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i_</span><span class="c">flags_lock);</span>

	<span class="w">__xfs_end_io_direct_write</span><span class="c">(</span><span class="pc">in</span><span class="c">ode,</span> <span class="pc">ioe</span><span class="c">nd</span><span class="pc">,</span> <span class="pc">ioe</span><span class="c">nd</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">o_</span><span class="c">offset</span><span class="pc">,</span> <span class="w">s</span><span class="c">ize);</span>

<span class="pc">}</span>
<span class="w">#</span><span class="pc">el</span><span class="c">se</span>
<span class="w">v</span><span class="c">oid</span> <span class="w">xfs_end_io_dax_write</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="c">uffer_head</span> <span class="c">*</span><span class="w">b</span><span class="pc">h,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">uptodate) { }</span>
<span class="w">#</span><span class="pc">e</span><span class="c">ndif</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="pc">inl</span><span class="c">ine</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span>
<span class="w">xfs_vm_do_dio</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="w">kiocb</span>		<span class="c">*</span><span class="w">iocb</span><span class="pc">,</span>
	<span class="c">struct</span> <span class="w">iov_iter</span>		<span class="c">*</span><span class="w">i</span><span class="pc">ter,</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">o</span><span class="pc">ffs</span><span class="c">et,</span>
	<span class="w">v</span><span class="c">oid</span>			<span class="w">(</span><span class="c">*</span><span class="w">endio</span><span class="c">)(struct</span> <span class="pc">k</span><span class="c">iocb</span>	<span class="c">*</span><span class="pc">io</span><span class="c">cb,</span>
					 <span class="w">l</span><span class="c">off_t</span>		<span class="c">offset,</span>
					 <span class="w">ss</span><span class="c">ize_t</span>	<span class="c">size</span><span class="pc">,</span>
					 <span class="w">v</span><span class="c">oid</span>		<span class="c">*</span><span class="w">pr</span><span class="pc">iva</span><span class="c">te</span><span class="w">),</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">f</span><span class="c">lags</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">block_device</span>	<span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">IS_DAX</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="w">)</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">dax_do_io</span><span class="c">(</span><span class="pc">i</span><span class="c">ocb,</span> <span class="w">ino</span><span class="c">de,</span> <span class="w">it</span><span class="pc">er,</span> <span class="w">o</span><span class="c">ffset,</span>
				 <span class="w">xfs_get_blocks_direct</span><span class="pc">,</span> <span class="w">endio</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="w">xfs_find_bdev_for_inode</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span>  <span class="w">__blockdev_direct_IO</span><span class="c">(iocb,</span> <span class="w">ino</span><span class="c">de,</span> <span class="w">bd</span><span class="c">ev,</span> <span class="w">it</span><span class="c">er</span><span class="pc">,</span> <span class="w">o</span><span class="pc">ffs</span><span class="c">et,</span>
				     <span class="w">x</span><span class="c">fs_get_blocks_direct,</span> <span class="pc">e</span><span class="c">ndio,</span> <span class="w">N</span><span class="c">ULL,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">ss</span><span class="c">ize_t</span>
<span class="w">xfs_vm_direct_IO</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">kiocb</span>		<span class="c">*</span><span class="w">i</span><span class="pc">o</span><span class="c">cb,</span>
	<span class="c">struct</span> <span class="w">iov_iter</span>		<span class="c">*</span><span class="w">it</span><span class="pc">er</span><span class="c">,</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>			<span class="w">of</span><span class="pc">fse</span><span class="c">t</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode</span> <span class="c">=</span> <span class="pc">io</span><span class="c">cb</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ki_filp-</span><span class="pc">&gt;</span><span class="w">f_mapping-</span><span class="c">&gt;</span><span class="w">ho</span><span class="c">st</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">iov_iter_rw</span><span class="c">(</span><span class="w">it</span><span class="c">er</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="w">WRITE</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">xfs_vm_do_dio</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">,</span> <span class="pc">ioc</span><span class="c">b</span><span class="pc">,</span> <span class="w">i</span><span class="pc">t</span><span class="c">er</span><span class="pc">,</span> <span class="w">o</span><span class="c">ffset,</span>
				     <span class="w">xfs_end_io_direct_write</span><span class="pc">,</span> <span class="w">DIO_ASYNC_EXTEND</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">x</span><span class="pc">fs_v</span><span class="c">m_do_dio(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="pc">i</span><span class="c">ocb,</span> <span class="w">i</span><span class="pc">t</span><span class="c">er,</span> <span class="w">o</span><span class="c">ffset,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">xfs_vm_kill_delalloc_range</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="w">l</span><span class="c">off_t</span>			<span class="w">s</span><span class="pc">tar</span><span class="c">t,</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="pc">e</span><span class="c">nd)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="c">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">xfs_fileoff_t</span>		<span class="w">start_fsb;</span>
	<span class="w">x</span><span class="c">fs_fileoff_t</span>		<span class="w">end_fsb</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span>			<span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>

	<span class="w">st</span><span class="pc">ar</span><span class="c">t_fsb</span> <span class="pc">=</span> <span class="w">XFS_B_TO_FSB</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i_mount</span><span class="pc">,</span> <span class="w">st</span><span class="pc">art)</span><span class="c">;</span>
	<span class="w">e</span><span class="c">nd_fsb</span> <span class="pc">=</span> <span class="w">X</span><span class="c">FS_B_TO_FSB(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mount</span><span class="pc">,</span> <span class="w">e</span><span class="pc">nd</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(end_fsb</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">s</span><span class="c">tart_fsb</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">xfs_ilock</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">XFS_ILOCK_EXCL</span><span class="c">);</span>
	<span class="w">er</span><span class="pc">ro</span><span class="c">r</span> <span class="c">=</span> <span class="w">xfs_bmap_punch_delalloc_range</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">,</span> <span class="c">start_fsb,</span>
						<span class="w">e</span><span class="c">nd_fsb</span> <span class="w">-</span> <span class="w">s</span><span class="pc">t</span><span class="c">art_fsb</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="pc">rro</span><span class="c">r</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">XFS_FORCED_SHUTDOWN</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">i</span><span class="c">_mount</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">xfs_alert</span><span class="c">(</span><span class="w">ip</span><span class="pc">-</span><span class="c">&gt;i_mount</span><span class="pc">,</span>
		<span class="w">"xfs_vm_write_failed:</span> <span class="w">un</span><span class="pc">a</span><span class="c">ble</span> <span class="c">to</span> <span class="w">clean</span> <span class="w">u</span><span class="c">p</span> <span class="w">ino</span> <span class="c">%</span><span class="w">ll</span><span class="pc">d</span><span class="w">"</span><span class="c">,</span>
					<span class="w">i</span><span class="pc">p</span><span class="c">-&gt;</span><span class="w">i_</span><span class="pc">i</span><span class="c">no);</span>
		<span class="pc">}</span>
	<span class="w">}</span>
	<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">ip</span><span class="c">,</span> <span class="w">XFS_ILOCK_EXCL</span><span class="c">);</span>
<span class="pc">}</span>

<span class="w">STATIC</span> <span class="w">v</span><span class="c">oid</span>
<span class="w">x</span><span class="pc">fs_v</span><span class="c">m_write_failed(</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode,</span>
	<span class="c">struct</span> <span class="pc">p</span><span class="c">age</span>		<span class="c">*</span><span class="pc">p</span><span class="c">age</span><span class="pc">,</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">po</span><span class="pc">s,</span>
	<span class="pc">u</span><span class="c">nsigned</span>		<span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">l</span><span class="c">off_t</span>			<span class="w">block_offset</span><span class="pc">;</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">block_start</span><span class="c">;</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">block_end</span><span class="c">;</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">fr</span><span class="c">om</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">os</span> <span class="w">&amp; </span><span class="pc">(</span><span class="w">PAGE_CACHE_SIZE</span> <span class="c">-</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>			<span class="w">t</span><span class="c">o</span> <span class="c">=</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m</span> <span class="w">+</span> <span class="c">len</span><span class="pc">;</span>
	<span class="w">st</span><span class="pc">r</span><span class="c">uct</span> <span class="w">buff</span><span class="pc">er_</span><span class="c">head</span>	<span class="c">*</span><span class="w">bh,</span><span class="c"> *</span><span class="w">h</span><span class="pc">ea</span><span class="c">d;</span>

	
	<span class="w">b</span><span class="pc">lock_o</span><span class="c">ffset</span> <span class="w">=</span><span class="pc"> (</span><span class="w">p</span><span class="c">os</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT) &lt;</span><span class="c">&lt;</span> <span class="w">P</span><span class="pc">AGE_CACHE_SH</span><span class="c">IFT;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">block_o</span><span class="c">ffset</span> <span class="w">+</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m</span> <span class="w">=</span><span class="c">=</span> <span class="w">p</span><span class="c">os</span><span class="w">)</span><span class="pc">;</span>

	<span class="w">h</span><span class="c">ead</span> <span class="pc">=</span> <span class="w">page_buffers</span><span class="c">(</span><span class="pc">pa</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">block_start</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">bh</span> <span class="c">=</span> <span class="pc">h</span><span class="c">ead;</span> <span class="w">bh</span> <span class="w">!</span><span class="c">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span> <span class="w">|</span><span class="pc">| !b</span><span class="c">lock_start;</span>
	     <span class="w">bh</span> <span class="w">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page,</span> <span class="pc">b</span><span class="c">lock_start</span> <span class="w">=</span> <span class="w">block_end</span><span class="pc">,</span>
				   <span class="pc">b</span><span class="c">lock_offset</span> <span class="w">+=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_size) {</span>
		<span class="w">b</span><span class="pc">lock_e</span><span class="c">nd</span> <span class="pc">=</span> <span class="c">block_start</span> <span class="w">+</span> <span class="w">bh</span><span class="c">-&gt;b_size</span><span class="pc">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(block_end</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">fr</span><span class="pc">o</span><span class="c">m)</span>
			<span class="w">c</span><span class="c">ontinue;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">block_s</span><span class="c">tart</span> <span class="w">&gt;</span><span class="c">=</span> <span class="w">to</span><span class="pc">)</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">buffer_delay</span><span class="pc">(</span><span class="w">bh</span><span class="pc">))</span>
			<span class="pc">c</span><span class="c">ontinue;</span>

		<span class="c">if</span> <span class="pc">(!</span><span class="w">buffer_new</span><span class="c">(</span><span class="w">bh) </span><span class="pc">&amp;&amp;</span> <span class="w">block_offset</span> <span class="w">&lt;</span> <span class="w">i_size_read(ino</span><span class="c">de))</span>
			<span class="c">continue;</span>

		<span class="w">xfs_vm_kill_delalloc_range</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de</span><span class="pc">,</span> <span class="pc">b</span><span class="c">lock_offset</span><span class="pc">,</span>
					   <span class="w">b</span><span class="pc">lock_o</span><span class="c">ffset</span> <span class="pc">+</span> <span class="w">bh</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">b_size</span><span class="c">);</span>

		
		<span class="w">clear_buffer_delay</span><span class="c">(</span><span class="w">bh</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">clear_buffer_uptodate</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
		<span class="w">clear_buffer_mapped</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
		<span class="w">clear_buffer_new</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
		<span class="w">clear_buffer_dirty</span><span class="c">(</span><span class="w">bh</span><span class="c">);</span>
	<span class="c">}</span>

<span class="pc">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_vm_write_begin</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">f</span><span class="c">ile</span>		<span class="c">*file,</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">address_space</span>	<span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing</span><span class="pc">,</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="w">p</span><span class="pc">o</span><span class="c">s,</span>
	<span class="pc">u</span><span class="c">nsigned</span>		<span class="w">l</span><span class="pc">e</span><span class="c">n</span><span class="pc">,</span>
	<span class="c">unsigned</span>		<span class="w">f</span><span class="c">lags</span><span class="pc">,</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">page</span>		<span class="pc">**</span><span class="w">pagep</span><span class="pc">,</span>
	<span class="w">v</span><span class="c">oid</span>			<span class="w">*</span><span class="pc">*</span><span class="w">fsdata</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">pgoff_t</span>			<span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">o</span><span class="c">s</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">page</span>		<span class="c">*page</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="w">st</span><span class="pc">atu</span><span class="c">s;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">l</span><span class="c">en</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">);</span>

	<span class="w">p</span><span class="pc">age</span> <span class="c">=</span> <span class="w">grab_cache_page_write_begin</span><span class="c">(</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex,</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">p</span><span class="pc">age)</span>
		<span class="c">return</span> <span class="c">-ENOMEM;</span>

	<span class="w">st</span><span class="pc">atu</span><span class="c">s</span> <span class="c">=</span> <span class="w">__block_write_begin</span><span class="c">(page,</span> <span class="w">po</span><span class="pc">s</span><span class="c">,</span> <span class="c">len,</span> <span class="w">xfs_get_blocks</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="c">nlikely(</span><span class="w">s</span><span class="c">tatus)) {</span>
		<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">in</span><span class="pc">o</span><span class="c">de</span>	<span class="c">*</span><span class="pc">i</span><span class="c">node</span> <span class="c">=</span> <span class="w">ma</span><span class="pc">pp</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st;</span>
		<span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span>		<span class="w">isize</span> <span class="pc">=</span> <span class="w">i_size_read</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">xfs_vm_write_failed</span><span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode</span><span class="pc">,</span> <span class="w">p</span><span class="c">age</span><span class="pc">,</span> <span class="w">pos</span><span class="pc">,</span> <span class="w">l</span><span class="c">en);</span>
		<span class="w">unlock_page</span><span class="c">(page</span><span class="pc">)</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="pc">os</span> <span class="w">+</span> <span class="c">len</span> <span class="pc">&gt;</span> <span class="pc">i</span><span class="c">size) {</span>
			<span class="w">ss</span><span class="c">ize_t</span> <span class="w">s</span><span class="pc">tar</span><span class="c">t</span> <span class="c">=</span> <span class="w">max_t</span><span class="c">(</span><span class="w">ss</span><span class="c">ize_t</span><span class="w">,</span> <span class="pc">p</span><span class="c">os</span><span class="pc">,</span> <span class="w">i</span><span class="pc">s</span><span class="c">ize</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">truncate_pagecache_range</span><span class="c">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="w">s</span><span class="pc">ta</span><span class="c">rt,</span> <span class="c">pos</span> <span class="pc">+</span> <span class="w">l</span><span class="c">en);</span>
		<span class="pc">}</span>

		<span class="w">page_cache_release</span><span class="c">(</span><span class="pc">pa</span><span class="c">ge);</span>
		<span class="pc">p</span><span class="c">age</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="pc">}</span>

	<span class="w">*pagep</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">age</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">st</span><span class="pc">at</span><span class="c">us;</span>
<span class="c">}</span>


<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_vm_write_end</span><span class="c">(</span>
	<span class="c">struct</span> <span class="c">file</span>		<span class="c">*file,</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">address_space</span>	<span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
	<span class="w">l</span><span class="pc">of</span><span class="c">f_t</span>			<span class="pc">po</span><span class="c">s,</span>
	<span class="pc">u</span><span class="c">nsigned</span>		<span class="pc">le</span><span class="c">n,</span>
	<span class="c">unsigned</span>		<span class="w">copied</span><span class="c">,</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">page</span>		<span class="c">*page,</span>
	<span class="w">v</span><span class="c">oid</span>			<span class="c">*</span><span class="w">fsdata</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span>			<span class="c">ret;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">l</span><span class="c">en</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">generic_write_end</span><span class="c">(</span><span class="w">f</span><span class="pc">ile</span><span class="c">,</span> <span class="w">ma</span><span class="pc">p</span><span class="c">ping,</span> <span class="w">po</span><span class="c">s,</span> <span class="c">len,</span> <span class="w">c</span><span class="pc">op</span><span class="c">ied</span><span class="pc">,</span> <span class="pc">p</span><span class="c">age,</span> <span class="w">f</span><span class="c">sdata</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">u</span><span class="c">nlikely(ret</span> <span class="c">&lt;</span> <span class="pc">l</span><span class="c">en</span><span class="pc">))</span><span class="c"> {</span>
		<span class="w">st</span><span class="pc">r</span><span class="c">uct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span>	<span class="c">*</span><span class="pc">i</span><span class="c">node</span> <span class="c">=</span> <span class="w">ma</span><span class="pc">pp</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="c">st;</span>
		<span class="w">s</span><span class="pc">i</span><span class="c">ze_t</span>		<span class="w">isize</span> <span class="pc">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="pc">in</span><span class="c">ode</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>		<span class="w">t</span><span class="pc">o</span> <span class="c">=</span> <span class="w">po</span><span class="pc">s</span> <span class="pc">+</span> <span class="pc">l</span><span class="c">en;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">to</span> <span class="w">&gt;</span> <span class="c">isize</span><span class="pc">) </span><span class="c">{</span>
			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">po</span><span class="pc">s</span> <span class="pc">&gt;</span> <span class="c">isize</span><span class="pc">)</span>
				<span class="w">i</span><span class="pc">s</span><span class="c">ize</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">o</span><span class="c">s;</span>
			<span class="w">xfs_vm_kill_delalloc_range</span><span class="pc">(</span><span class="w">in</span><span class="pc">o</span><span class="c">de,</span> <span class="c">isize</span><span class="pc">,</span> <span class="w">to</span><span class="c">);</span>
			<span class="w">truncate_pagecache_range</span><span class="pc">(</span><span class="w">i</span><span class="pc">n</span><span class="c">ode,</span> <span class="c">isize,</span> <span class="w">t</span><span class="pc">o</span><span class="c">);</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">sec</span><span class="pc">t</span><span class="c">or_t</span>
<span class="w">xfs_vm_bmap</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">address_space</span>	<span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
	<span class="w">s</span><span class="pc">e</span><span class="c">ctor_t</span>		<span class="w">b</span><span class="c">lock</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span>		<span class="c">*inode</span> <span class="pc">= </span><span class="c">(struct</span> <span class="w">i</span><span class="pc">n</span><span class="c">ode</span> <span class="c">*)</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="pc">st;</span>
	<span class="c">struct</span> <span class="w">xfs_inode</span>	<span class="c">*</span><span class="w">ip</span> <span class="pc">=</span> <span class="w">XFS_I</span><span class="c">(</span><span class="pc">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">trace_xfs_vm_bmap</span><span class="c">(</span><span class="w">X</span><span class="c">FS_I</span><span class="pc">(i</span><span class="c">node</span><span class="pc">)</span><span class="c">);</span>
	<span class="w">xfs_ilock</span><span class="c">(</span><span class="w">ip</span><span class="pc">,</span> <span class="w">XFS_IOLOCK_SHARED</span><span class="c">);</span>
	<span class="w">filemap_write_and_wait</span><span class="c">(</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">xfs_iunlock</span><span class="c">(</span><span class="w">i</span><span class="pc">p</span><span class="c">,</span> <span class="pc">X</span><span class="c">FS_IOLOCK_SHARED);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">generic_block_bmap</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">pping,</span> <span class="w">b</span><span class="pc">l</span><span class="c">ock,</span> <span class="w">xfs_get_blocks</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">STATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_vm_readpage</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">f</span><span class="c">ile</span>		<span class="c">*</span><span class="w">unused</span><span class="c">,</span>
	<span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span>		<span class="c">*</span><span class="pc">page)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">mpage_readpage</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge,</span> <span class="w">x</span><span class="pc">fs_g</span><span class="c">et_blocks</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="w">S</span><span class="c">TATIC</span> <span class="w">i</span><span class="c">nt</span>
<span class="w">xfs_vm_readpages</span><span class="c">(</span>
	<span class="c">struct</span> <span class="w">f</span><span class="c">ile</span>		<span class="c">*</span><span class="pc">u</span><span class="c">nused,</span>
	<span class="c">struct</span> <span class="w">address_space</span>	<span class="c">*</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing,</span>
	<span class="c">struct</span> <span class="w">l</span><span class="c">ist_head</span>	<span class="c">*</span><span class="w">p</span><span class="pc">ages,</span>
	<span class="c">unsigned</span>		<span class="w">n</span><span class="pc">r_</span><span class="c">pages</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">mpage_readpages</span><span class="pc">(</span><span class="w">m</span><span class="pc">a</span><span class="c">pping,</span> <span class="w">pa</span><span class="pc">ges</span><span class="c">,</span> <span class="w">nr</span><span class="pc">_</span><span class="c">pages,</span> <span class="w">x</span><span class="c">fs_get_blocks</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="w">S</span><span class="c">TATIC</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span>
<span class="w">xfs_vm_set_page_dirty</span><span class="c">(</span>
	<span class="c">struct</span> <span class="pc">p</span><span class="c">age</span>		<span class="c">*page</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">a</span><span class="c">ddress_space</span>	<span class="c">*</span><span class="w">m</span><span class="pc">ap</span><span class="c">ping</span> <span class="c">=</span> <span class="w">p</span><span class="c">age</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">m</span><span class="c">apping;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">no</span><span class="c">de</span>		<span class="c">*inode</span> <span class="c">=</span> <span class="w">ma</span><span class="pc">pp</span><span class="c">ing-&gt;</span><span class="w">ho</span><span class="pc">st</span><span class="c">;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>			<span class="w">end_offset</span><span class="c">;</span>
	<span class="w">lo</span><span class="pc">f</span><span class="c">f_t</span>			<span class="w">o</span><span class="pc">ff</span><span class="c">set;</span>
	<span class="pc">in</span><span class="c">t</span>			<span class="w">newly_dirty</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">mem_cgroup</span>	<span class="c">*</span><span class="w">memcg</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(unlikely</span><span class="pc">(!</span><span class="w">m</span><span class="pc">a</span><span class="c">pping</span><span class="pc">)</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">!TestSetPageDirty</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>

	<span class="w">e</span><span class="pc">n</span><span class="c">d_offset</span> <span class="pc">=</span> <span class="w">i_size_read</span><span class="c">(</span><span class="w">i</span><span class="c">node</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">o</span><span class="pc">ffs</span><span class="c">et</span> <span class="c">=</span> <span class="w">page_offset</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge);</span>

	<span class="w">sp</span><span class="pc">in_l</span><span class="c">ock(&amp;</span><span class="w">ma</span><span class="pc">pp</span><span class="c">ing-&gt;</span><span class="w">private_lock</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">page_has_buffers</span><span class="c">(page</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">b</span><span class="c">uffer_head</span> <span class="c">*</span><span class="w">h</span><span class="c">ead</span> <span class="c">=</span> <span class="w">page_buffers</span><span class="c">(</span><span class="pc">pa</span><span class="c">ge);</span>
		<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">b</span><span class="pc">u</span><span class="c">ffer_head</span> <span class="c">*</span><span class="w">b</span><span class="pc">h</span> <span class="c">=</span> <span class="w">h</span><span class="pc">e</span><span class="c">ad</span><span class="pc">;</span>

		<span class="w">d</span><span class="c">o</span> <span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="pc">&lt;</span> <span class="w">end_offset</span><span class="pc">)</span>
				<span class="w">set_buffer_dirty</span><span class="c">(</span><span class="w">bh</span><span class="pc">);</span>
			<span class="w">bh</span> <span class="pc">=</span> <span class="w">bh</span><span class="c">-&gt;</span><span class="w">b_this_page</span><span class="c">;</span>
			<span class="w">o</span><span class="pc">f</span><span class="c">fset</span> <span class="c">+=</span> <span class="pc">1</span> <span class="pc">&lt;</span><span class="c">&lt;</span> <span class="w">ino</span><span class="pc">d</span><span class="c">e-&gt;</span><span class="w">i_blkbits</span><span class="c">;</span>
		<span class="c">}</span> <span class="w">w</span><span class="c">hile</span> <span class="pc">(</span><span class="w">bh</span> <span class="w">!</span><span class="c">=</span> <span class="w">h</span><span class="c">ead</span><span class="w">);</span>
	<span class="pc">}</span>
	
	<span class="w">memcg</span> <span class="pc">=</span> <span class="w">mem_cgroup_begin_page_stat</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">newly_dirty</span> <span class="w">= !TestSetPageDirty</span><span class="c">(</span><span class="pc">pa</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock(&amp;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping-&gt;</span><span class="w">private_lock</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">n</span><span class="c">ewly_dirty</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

		<span class="pc">s</span><span class="c">pin_lock_irqsave(&amp;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping-&gt;</span><span class="w">tree_lock</span><span class="c">,</span> <span class="c">flags);</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping) {</span>	
			<span class="w">WARN_ON_ONCE(!PageUptodate</span><span class="pc">(p</span><span class="c">age</span><span class="pc">))</span><span class="c">;</span>
			<span class="w">account_page_dirtied</span><span class="c">(</span><span class="pc">p</span><span class="c">age,</span> <span class="w">m</span><span class="c">apping,</span> <span class="w">memcg</span><span class="c">);</span>
			<span class="w">radix_tree_tag_set</span><span class="pc">(&amp;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping-&gt;</span><span class="w">page_tree</span><span class="c">,</span>
					<span class="w">page_index</span><span class="pc">(</span><span class="c">page</span><span class="pc">),</span> <span class="w">PAGECACHE_TAG_DIRTY</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">m</span><span class="pc">a</span><span class="c">pping-&gt;</span><span class="w">tree_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="pc">}</span>
	<span class="w">mem_cgroup_end_page_stat</span><span class="c">(</span><span class="w">m</span><span class="c">emcg);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">newly_dirty</span><span class="c">)</span>
		<span class="w">__mark_inode_dirty</span><span class="c">(</span><span class="w">m</span><span class="pc">a</span><span class="c">pping</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">h</span><span class="pc">o</span><span class="c">st</span><span class="pc">,</span> <span class="w">I_DIRTY_PAGES</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">n</span><span class="c">ewly_dirty;</span>
<span class="c">}</span>

<span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">address_space_operations</span> <span class="w">xfs_address_space_operations</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">readpage</span>		<span class="c">=</span> <span class="w">xfs_vm_readpage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">readpages</span>		<span class="c">=</span> <span class="w">xfs_vm_readpages</span><span class="c">,</span>
	<span class="c">.</span><span class="w">writepage</span>		<span class="c">=</span> <span class="w">xfs_vm_writepage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">writepages</span>		<span class="c">=</span> <span class="w">xfs_vm_writepages</span><span class="c">,</span>
	<span class="c">.</span><span class="w">set_page_dirty</span>		<span class="c">=</span> <span class="w">xfs_vm_set_page_dirty</span><span class="c">,</span>
	<span class="c">.</span><span class="w">releasepage</span>		<span class="c">=</span> <span class="w">xfs_vm_releasepage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">invalidatepage</span>		<span class="c">=</span> <span class="w">xfs_vm_invalidatepage</span><span class="c">,</span>
	<span class="c">.</span><span class="w">write_begin</span>		<span class="c">=</span> <span class="w">xfs_vm_write_begin</span><span class="c">,</span>
	<span class="c">.</span><span class="w">write_end</span>		<span class="c">=</span> <span class="w">xfs_vm_write_end</span><span class="c">,</span>
	<span class="c">.</span><span class="w">bmap</span>			<span class="c">=</span> <span class="w">xfs_vm_bmap</span><span class="c">,</span>
	<span class="c">.</span><span class="w">direct_IO</span>		<span class="c">=</span> <span class="w">xfs_vm_direct_IO</span><span class="c">,</span>
	<span class="c">.</span><span class="w">migratepage</span>		<span class="c">=</span> <span class="w">buffer_migrate_page</span><span class="c">,</span>
	<span class="c">.</span><span class="w">is_partially_uptodate</span>  <span class="c">=</span> <span class="w">block_is_partially_uptodate</span><span class="c">,</span>
	<span class="c">.</span><span class="w">error_remove_page</span>	<span class="c">=</span> <span class="w">generic_error_remove_page</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

</pre>
</body>
</html>

