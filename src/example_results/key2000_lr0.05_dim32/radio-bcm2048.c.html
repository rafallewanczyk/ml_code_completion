<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>




<span class="w">#include</span> <span class="w">&lt;linux/kernel.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/module.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/init.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/version.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">i</span><span class="pc">n</span><span class="c">terrupt.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">sysfs</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">c</span><span class="pc">o</span><span class="c">mpletion.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">d</span><span class="c">elay.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">i</span><span class="pc">2</span><span class="c">c.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">videodev2</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">m</span><span class="pc">u</span><span class="c">tex.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/slab.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">m</span><span class="c">edia/</span><span class="w">v4l2</span><span class="c">-</span><span class="pc">com</span><span class="c">mon.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;media/v4l2-</span><span class="pc">i</span><span class="c">octl.h&gt;</span>
<span class="c">#include</span> <span class="pc">"</span><span class="w">r</span><span class="c">adio</span><span class="pc">-</span><span class="w">bcm2048</span><span class="c">.h"</span>


<span class="c">#define</span> <span class="w">BCM2048_DRIVER_AUTHOR</span>	<span class="pc">"</span><span class="w">Eero</span> <span class="w">Nurkkala</span> <span class="w">&lt;ex</span><span class="c">t</span><span class="pc">-</span><span class="w">eero</span><span class="pc">.</span><span class="w">nurkkala@nokia</span><span class="c">.com</span><span class="w">&gt;"</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">BCM2048_DRIVER_NAME</span>	<span class="w">BCM2048_NAME</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">BCM2048_DRIVER_VERSION</span>	<span class="w">KERNEL_VERSION</span><span class="pc">(0,</span> <span class="c">0</span><span class="pc">,</span> <span class="pc">1</span><span class="c">)</span>
<span class="c">#define</span> <span class="w">BCM2048_DRIVER_CARD</span>	<span class="w">"Broadcom</span> <span class="w">bcm2048</span> <span class="w">FM</span> <span class="w">Radio</span> <span class="w">Receiver"</span>
<span class="c">#define</span> <span class="w">BCM2048_DRIVER_DESC</span>	<span class="c">"</span><span class="w">I2C</span> <span class="w">dr</span><span class="c">iver</span> <span class="c">for</span> <span class="w">BCM2048</span> <span class="w">F</span><span class="c">M</span> <span class="w">R</span><span class="c">adio</span> <span class="w">R</span><span class="c">eceiver</span><span class="w">"</span>


<span class="pc">#</span><span class="c">define</span> <span class="w">BCM2048_I2C_FM_RDS_SYSTEM</span>	<span class="w">0</span><span class="pc">x00</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_CTRL</span>		<span class="c">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_CTRL0</span>		<span class="c">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_CTRL1</span>		<span class="pc">0x03</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_AUDIO_PAUSE</span>	<span class="c">0x04</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span>	<span class="c">0x05</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL1</span>	<span class="c">0x06</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_SEARCH_CTRL0</span>	<span class="c">0x07</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_SEARCH_CTRL1</span>	<span class="c">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_SEARCH_TUNE_MODE</span>	<span class="c">0x09</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_FREQ0</span>		<span class="c">0x0a</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_FREQ1</span>		<span class="c">0x0b</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_AF_FREQ0</span>		<span class="c">0x0c</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_AF_FREQ1</span>		<span class="c">0x0d</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_CARRIER</span>		<span class="c">0x0e</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_RSSI</span>		<span class="c">0x0f</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_RDS_MASK0</span>	<span class="c">0x10</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_RDS_MASK1</span>	<span class="c">0x11</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_RDS_FLAG0</span>	<span class="c">0x12</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_RDS_FLAG1</span>	<span class="c">0x13</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_WLINE</span>		<span class="c">0x14</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_BLKB_MATCH0</span>	<span class="pc">0x16</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_BLKB_MATCH1</span>	<span class="pc">0x17</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_BLKB_MASK0</span>	<span class="c">0x18</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_BLKB_MASK1</span>	<span class="c">0x19</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_PI_MATCH0</span>	<span class="c">0x1a</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_PI_MATCH1</span>	<span class="c">0x1b</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_PI_MASK0</span>	<span class="c">0x1c</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_PI_MASK1</span>	<span class="c">0x1d</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_SPARE1</span>		<span class="pc">0x2</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_SPARE2</span>		<span class="c">0x21</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_RDS_REV</span>		<span class="w">0x2</span><span class="pc">8</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_SLAVE_CONFIGURATION</span>	<span class="pc">0x29</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_RDS_DATA</span>		<span class="w">0x8</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_I2C_FM_BEST_TUNE_MODE</span>	<span class="w">0x9</span><span class="pc">0</span>


<span class="c">#define</span> <span class="w">BCM2048_FM_ON</span>			<span class="pc">0x0</span><span class="c">1</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_ON</span>			<span class="c">0x02</span>


<span class="c">#define</span> <span class="w">BCM2048_BAND_SELECT</span>			<span class="pc">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_STEREO_MONO_AUTO_SELECT</span>		<span class="c">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_STEREO_MONO_MANUAL_SELECT</span>	<span class="c">0x04</span>
<span class="c">#define</span> <span class="w">BCM2048_STEREO_MONO_BLEND_SWITCH</span>	<span class="c">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_HI_LO_INJECTION</span>			<span class="c">0x10</span>


<span class="c">#define</span> <span class="w">BCM2048_RBDS_RDS_SELECT</span>		<span class="pc">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_FLUSH_FIFO</span>		<span class="c">0x02</span>


<span class="c">#define</span> <span class="w">BCM2048_AUDIO_PAUSE_RSSI_TRESH</span>	<span class="w">0x0f</span>
<span class="c">#define</span> <span class="w">BCM2048_AUDIO_PAUSE_DURATION</span>	<span class="w">0xf</span><span class="pc">0</span>


<span class="c">#define</span> <span class="w">BCM2048_RF_MUTE</span>			<span class="c">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_MANUAL_MUTE</span>		<span class="c">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_DAC_OUTPUT_LEFT</span>		<span class="pc">0x04</span>
<span class="c">#define</span> <span class="w">BCM2048_DAC_OUTPUT_RIGHT</span>	<span class="c">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_AUDIO_ROUTE_DAC</span>		<span class="c">0x10</span>
<span class="c">#define</span> <span class="w">BCM2048_AUDIO_ROUTE_I2S</span>		<span class="c">0x20</span>
<span class="c">#define</span> <span class="w">BCM2048_DE_EMPHASIS_SELECT</span>	<span class="c">0x40</span>
<span class="c">#define</span> <span class="w">BCM2048_AUDIO_BANDWIDTH_SELECT</span>	<span class="c">0x80</span>


<span class="c">#define</span> <span class="w">BCM2048_SEARCH_RSSI_THRESHOLD</span>	<span class="w">0x7</span><span class="pc">f</span>
<span class="c">#define</span> <span class="w">BCM2048_SEARCH_DIRECTION</span>	<span class="pc">0x8</span><span class="c">0</span>


<span class="c">#define</span> <span class="w">BCM2048_FM_AUTO_SEARCH</span>		<span class="w">0x03</span>


<span class="c">#define</span> <span class="w">BCM2048_RSSI_VALUE</span>		<span class="w">0xf</span><span class="c">f</span>



<span class="c">#define</span> <span class="w">BCM2048_FM_FLAG_SEARCH_TUNE_FINISHED</span>	<span class="pc">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_FM_FLAG_SEARCH_TUNE_FAIL</span>	<span class="c">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_FM_FLAG_RSSI_LOW</span>		<span class="c">0x04</span>
<span class="c">#define</span> <span class="w">BCM2048_FM_FLAG_CARRIER_ERROR_HIGH</span>	<span class="c">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_FM_FLAG_AUDIO_PAUSE_INDICATION</span>	<span class="c">0x10</span>
<span class="c">#define</span> <span class="w">BCM2048_FLAG_STEREO_DETECTED</span>		<span class="c">0x20</span>
<span class="c">#define</span> <span class="w">BCM2048_FLAG_STEREO_ACTIVE</span>		<span class="c">0x40</span>


<span class="c">#define</span> <span class="w">BCM2048_SLAVE_ADDRESS</span>			<span class="w">0x3</span><span class="pc">f</span>
<span class="c">#define</span> <span class="w">BCM2048_SLAVE_ENABLE</span>			<span class="pc">0x8</span><span class="c">0</span>


<span class="c">#define</span> <span class="w">BCM2048_BEST_TUNE_MODE</span>			<span class="pc">0x8</span><span class="c">0</span>

<span class="c">#define</span> <span class="w">BCM2048_F</span><span class="pc">M</span><span class="c">_FLAG_SEARCH_TUNE_FINISHED</span>	<span class="pc">0x0</span><span class="c">1</span>
<span class="c">#define</span> <span class="w">BCM2048_FM</span><span class="pc">_FLAG_SEARCH_TUNE_FA</span><span class="c">IL</span>	<span class="c">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_FM</span><span class="pc">_FLAG_R</span><span class="c">SSI_LOW</span>		<span class="c">0x04</span>
<span class="c">#define</span> <span class="w">BCM2048_FM</span><span class="pc">_FLAG_C</span><span class="c">ARRIER_ERROR_HIGH</span>	<span class="c">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_FM</span><span class="pc">_FLAG_A</span><span class="c">UDIO_PAUSE_INDICATION</span>	<span class="c">0x10</span>
<span class="c">#define</span> <span class="w">BCM2048_FL</span><span class="pc">AG_STEREO_D</span><span class="c">ETECTED</span>		<span class="c">0x20</span>
<span class="c">#define</span> <span class="w">BCM2048_FL</span><span class="pc">AG_STEREO_A</span><span class="c">CTIVE</span>		<span class="c">0x40</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_FLAG_FIFO_WLINE</span>		<span class="pc">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_FLAG_B_BLOCK_MATCH</span>		<span class="w">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_FLAG_SYNC_LOST</span>		<span class="pc">0x1</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_FLAG_PI_MATCH</span>		<span class="c">0x20</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_MARK_END_BYTE0</span>		<span class="w">0x7C</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_MARK_END_BYTEN</span>		<span class="w">0xF</span><span class="pc">F</span>

<span class="c">#define</span> <span class="w">BCM2048_FM_FLAGS_ALL</span>	<span class="w">(FM_FLAG_SEARCH_TUNE_FINISHED</span> <span class="w">|</span><span class="pc"> </span><span class="c">\</span>
				 <span class="w">FM_FLAG_SEARCH_TUNE_FAIL</span> <span class="pc">|</span><span class="c"> \</span>
				 <span class="w">FM_FLAG_RSSI_LOW</span> <span class="c">| \</span>
				 <span class="w">FM_FLAG_CARRIER_ERROR_HIGH</span> <span class="c">| \</span>
				 <span class="w">FM_FLAG_AUDIO_PAUSE_INDICATION</span> <span class="c">| \</span>
				 <span class="w">FLAG_STEREO_DETECTED</span> <span class="pc">|</span> <span class="w">FLAG_STEREO_ACTIVE</span><span class="pc">)</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_FLAGS_ALL</span>	<span class="c">(</span><span class="w">RDS_FLAG_FIFO_WLINE</span> <span class="pc">| </span><span class="c">\</span>
				 <span class="w">RDS_FLAG_B_BLOCK_MATCH</span> <span class="c">| \</span>
				 <span class="w">RDS_FLAG_SYNC_LOST</span> <span class="pc">|</span> <span class="w">RDS_FLAG_PI_MATCH</span><span class="pc">)</span>

<span class="c">#define</span> <span class="w">BCM2048_DEFAULT_TIMEOUT</span>		<span class="w">1500</span>
<span class="c">#define</span> <span class="w">BCM2048_AUTO_SEARCH_TIMEOUT</span>	<span class="w">3000</span>


<span class="c">#define</span> <span class="w">BCM2048_FREQDEV_UNIT</span>		<span class="w">10000</span>
<span class="c">#define</span> <span class="w">BCM2048_FREQV4L2_MULTI</span>		<span class="w">625</span>
<span class="c">#define</span> <span class="w">dev_to_v4l2</span><span class="c">(</span><span class="w">f)</span><span class="pc">	((</span><span class="w">f</span> <span class="w">*</span> <span class="w">B</span><span class="pc">CM2048_FREQD</span><span class="c">EV_UNIT</span><span class="w">)</span><span class="pc"> </span><span class="c">/</span> <span class="pc">B</span><span class="c">CM2048_FREQV4L2_MULTI)</span>
<span class="c">#define</span> <span class="w">v4l2_to_dev</span><span class="c">(</span><span class="pc">f)</span><span class="c">	((f</span> <span class="w">*</span> <span class="w">B</span><span class="c">CM2048_FREQV4L2_MULTI</span><span class="pc">) </span><span class="c">/</span> <span class="pc">BCM2048_FREQD</span><span class="c">EV_UNIT)</span>

<span class="c">#define</span> <span class="w">msb</span><span class="c">(</span><span class="pc">x</span><span class="w">)                  ((u</span><span class="pc">8</span><span class="w">)((u1</span><span class="c">6</span><span class="pc">)</span> <span class="w">x</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="c">8</span><span class="w">))</span>
<span class="c">#define</span> <span class="w">lsb</span><span class="c">(</span><span class="pc">x</span><span class="w">) </span><span class="pc"> </span><span class="c">                ((</span><span class="w">u</span><span class="pc">8</span><span class="c">)((</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span><span class="pc">)</span> <span class="w">x</span> <span class="w">&amp;</span>  <span class="w">0x00FF)</span><span class="pc">)</span>
<span class="c">#define</span> <span class="w">compose_u16</span><span class="c">(</span><span class="w">m</span><span class="c">sb,</span> <span class="w">l</span><span class="c">sb</span><span class="w">)	</span><span class="pc">(</span><span class="c">((</span><span class="w">u</span><span class="pc">1</span><span class="c">6</span><span class="w">)m</span><span class="c">sb</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="pc">8) </span><span class="c">|</span> <span class="w">l</span><span class="c">sb)</span>

<span class="c">#define</span> <span class="w">BCM2048_DEFAULT_POWERING_DELAY</span>	<span class="w">2</span><span class="pc">0</span>
<span class="c">#define</span> <span class="w">BCM2048_DEFAULT_REGION</span>		<span class="w">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_DEFAULT_MUTE</span>		<span class="w">0</span><span class="pc">x</span><span class="c">01</span>
<span class="c">#define</span> <span class="w">BCM2048_DEFAULT_RSSI_THRESHOLD</span>	<span class="w">0x6</span><span class="c">4</span>
<span class="c">#define</span> <span class="w">BCM2048_DEFAULT_RDS_WLINE</span>	<span class="w">0x7E</span>

<span class="c">#define</span> <span class="w">BCM2048_FM_SEARCH_INACTIVE</span>	<span class="pc">0</span><span class="c">x00</span>
<span class="c">#define</span> <span class="w">BCM2048_FM_PRE_SET_MODE</span>		<span class="c">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_FM_AUTO_SEARCH_MODE</span>	<span class="c">0x02</span>
<span class="c">#define</span> <span class="w">BCM2048_FM_AF_JUMP_MODE</span>		<span class="c">0x03</span>

<span class="c">#define</span> <span class="w">BCM2048_FREQUENCY_BASE</span>		<span class="w">64000</span>

<span class="c">#define</span> <span class="w">BCM2048_POWER_ON</span>		<span class="pc">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_POWER_OFF</span>		<span class="pc">0x00</span>

<span class="c">#define</span> <span class="w">BCM2048_ITEM_ENABLED</span>		<span class="c">0x01</span>
<span class="c">#define</span> <span class="w">BCM2048_SEARCH_DIRECTION_UP</span>	<span class="w">0x01</span>

<span class="c">#define</span> <span class="w">BCM2048_DE_EMPHASIS_75us</span>	<span class="w">75</span>
<span class="c">#define</span> <span class="w">BCM2048_DE_EMPHASIS_50us</span>	<span class="w">5</span><span class="pc">0</span>

<span class="c">#define</span> <span class="w">BCM2048_SCAN_FAIL</span>		<span class="c">0x00</span>
<span class="c">#define</span> <span class="w">BCM2048_SCAN_OK</span>			<span class="c">0x01</span>

<span class="c">#define</span> <span class="w">BCM2048_FREQ_ERROR_FLOOR</span>	<span class="w">-2</span><span class="pc">0</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">BCM2048_FREQ_ERROR_ROOF</span>		<span class="w">2</span><span class="pc">0</span>


<span class="c">#define</span> <span class="w">BCM2048_RSSI_LEVEL_BASE</span>		<span class="w">-6</span><span class="pc">0</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">BCM2048_RSSI_LEVEL_ROOF</span>		<span class="w">-10</span><span class="pc">0</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">BCM2048_RSSI_LEVEL_ROOF_NEG</span>	<span class="w">10</span><span class="pc">0</span>
<span class="c">#define</span> <span class="w">BCM2048_SIGNAL_MULTIPLIER</span>	<span class="w">(0xF</span><span class="c">FFF</span> <span class="w">/ \</span>
					 <span class="w">(BCM2048_R</span><span class="pc">SSI_LEVEL_ROOF_</span><span class="c">NEG</span> <span class="w">+ \</span>
					  <span class="w">B</span><span class="pc">CM2048_RSSI_LEVEL_B</span><span class="c">ASE</span><span class="w">))</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_FIFO_DUPLE_SIZE</span>	<span class="w">0x03</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_CRC_MASK</span>		<span class="w">0x0F</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_CRC_NONE</span>		<span class="w">0x00</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_CRC_MAX_2BITS</span>	<span class="pc">0x04</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_CRC_LEAST_2BITS</span>	<span class="c">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span>	<span class="c">0x0C</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span>		<span class="w">0xF</span><span class="pc">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_BLOCK_A</span>		<span class="pc">0x00</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_BLOCK_B</span>		<span class="pc">0x1</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_BLOCK_C</span>		<span class="pc">0x2</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_BLOCK_D</span>		<span class="c">0x30</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_BLOCK_C_SCORED</span>	<span class="c">0x40</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_BLOCK_E</span>		<span class="w">0x6</span><span class="c">0</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_RT</span>			<span class="w">0x2</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_PS</span>			<span class="pc">0x0</span><span class="c">0</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_GROUP_AB_MASK</span>	<span class="pc">0x08</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_GROUP_A</span>		<span class="pc">0x00</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_GROUP_B</span>		<span class="w">0x08</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_RT_AB_MASK</span>		<span class="pc">0x1</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_RT_A</span>		<span class="w">0x0</span><span class="pc">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_RT_B</span>		<span class="w">0x1</span><span class="c">0</span>
<span class="c">#define</span> <span class="w">BCM2048_RDS_RT_INDEX</span>		<span class="w">0x0F</span>

<span class="c">#define</span> <span class="w">BCM2048_RDS_PS_INDEX</span>		<span class="w">0x0</span><span class="pc">3</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">rds_info</span> <span class="c">{</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">rds_pi</span><span class="c">;</span>
<span class="pc">#</span><span class="c">define</span> <span class="w">BCM2048_MAX_RDS_RT</span> <span class="c">(</span><span class="w">6</span><span class="pc">4</span> <span class="pc">+</span> <span class="c">1</span><span class="pc">)</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">rds_rt</span><span class="pc">[</span><span class="w">B</span><span class="c">CM2048_MAX_RDS_RT];</span>
	<span class="pc">u</span><span class="c">8</span> <span class="w">rds_rt_group_b</span><span class="pc">;</span>
	<span class="c">u8</span> <span class="w">rds_rt_ab</span><span class="c">;</span>
<span class="w">#</span><span class="c">define</span> <span class="w">BCM2048_MAX_RDS_PS</span> <span class="c">(</span><span class="w">8</span> <span class="w">+</span> <span class="c">1</span><span class="pc">)</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">rds_ps</span><span class="pc">[</span><span class="w">B</span><span class="c">CM2048_MAX_RDS_PS];</span>
	<span class="pc">u</span><span class="c">8</span> <span class="w">rds_ps_group</span><span class="pc">;</span>
	<span class="c">u8</span> <span class="w">rds_ps_group_cnt</span><span class="c">;</span>
<span class="w">#</span><span class="c">define</span> <span class="w">BCM2048_MAX_RDS_RADIO_TEXT</span> <span class="w">2</span><span class="pc">5</span><span class="c">5</span>
	<span class="w">u</span><span class="c">8</span> <span class="w">radio_text</span><span class="pc">[</span><span class="w">B</span><span class="pc">CM2048_MAX_RDS_RA</span><span class="c">DIO_TEXT</span> <span class="pc">+</span> <span class="pc">3</span><span class="c">];</span>
	<span class="pc">u8</span> <span class="w">text_len</span><span class="pc">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">region_info</span> <span class="c">{</span>
	<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">bottom_frequency</span><span class="c">;</span>
	<span class="c">u32</span> <span class="w">top_frequency</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">deemphasis</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">channel_spacing</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">regi</span><span class="pc">on;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">{</span>
	<span class="c">struct</span> <span class="w">i</span><span class="pc">2</span><span class="c">c_client</span> <span class="c">*client;</span>
	<span class="c">struct</span> <span class="w">video_device</span> <span class="w">videodev</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">w</span><span class="c">ork_struct</span> <span class="w">w</span><span class="c">ork;</span>
	<span class="c">struct</span> <span class="w">c</span><span class="c">ompletion</span> <span class="w">compl</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">m</span><span class="c">utex</span> <span class="pc">m</span><span class="c">utex;</span>
	<span class="c">struct</span> <span class="w">bcm2048_platform_data</span> <span class="c">*</span><span class="w">pl</span><span class="pc">at</span><span class="c">form_data;</span>
	<span class="c">struct</span> <span class="w">rds_info</span> <span class="w">r</span><span class="pc">d</span><span class="c">s_info;</span>
	<span class="c">struct</span> <span class="w">region_info</span> <span class="pc">r</span><span class="c">egion_info;</span>
	<span class="w">u1</span><span class="c">6</span> <span class="w">f</span><span class="pc">r</span><span class="c">equency;</span>
	<span class="pc">u8</span> <span class="w">cache_fm_rds_system</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">cache_fm_ctrl</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">cache_fm_audio_ctrl0</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">cache_fm_search_ctrl0</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">power_state</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">rds_state</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">fifo_size</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">scan_state</span><span class="c">;</span>
	<span class="c">u8</span> <span class="w">mute_state</span><span class="c">;</span>

	
	<span class="w">wait_queue_head_t</span> <span class="w">read_queue</span><span class="c">;</span>
	<span class="w">un</span><span class="pc">s</span><span class="c">igned</span> <span class="c">int</span> <span class="w">users</span><span class="c">;</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">c</span><span class="c">har</span> <span class="w">rds_data_available</span><span class="c">;</span>
	<span class="pc">un</span><span class="c">signed</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rd_index</span><span class="c">;</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">radio_nr</span> <span class="w">=</span><span class="pc"> </span><span class="c">-1;</span>	
<span class="w">m</span><span class="c">odule_param(radio_nr,</span> <span class="c">int,</span> <span class="c">0);</span>
<span class="pc">M</span><span class="c">ODULE_PARM_DESC(radio_nr</span><span class="pc">,</span>
		 <span class="c">"</span><span class="w">Minor</span> <span class="w">n</span><span class="c">umber</span> <span class="w">f</span><span class="c">or</span> <span class="w">ra</span><span class="pc">dio</span> <span class="w">d</span><span class="c">evice</span> <span class="w">(-</span><span class="c">1</span> <span class="w">==&gt;</span> <span class="w">auto</span> <span class="w">assign)</span><span class="c">");</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">region_info</span> <span class="w">region_configs[</span><span class="pc">] </span><span class="c">= {</span>
	
	<span class="pc">{</span>
		<span class="c">.</span><span class="w">channel_spacing</span>	<span class="c">=</span> <span class="w">2</span><span class="c">0,</span>
		<span class="c">.</span><span class="w">bottom_frequency</span>	<span class="c">=</span> <span class="w">87500</span><span class="c">,</span>
		<span class="c">.</span><span class="w">top_frequency</span>		<span class="c">=</span> <span class="w">108000</span><span class="c">,</span>
		<span class="c">.</span><span class="w">deemphasis</span>		<span class="c">=</span> <span class="w">75</span><span class="c">,</span>
		<span class="c">.</span><span class="w">regi</span><span class="pc">on</span>			<span class="c">=</span> <span class="w">0</span><span class="c">,</span>
	<span class="pc">},</span>
	
	<span class="c">{</span>
		<span class="c">.</span><span class="w">c</span><span class="c">hannel_spacing</span>	<span class="c">=</span> <span class="w">2</span><span class="pc">0</span><span class="c">,</span>
		<span class="c">.bottom_frequency</span>	<span class="c">=</span> <span class="pc">87</span><span class="c">500,</span>
		<span class="c">.top_frequency</span>		<span class="c">=</span> <span class="c">108000,</span>
		<span class="c">.deemphasis</span>		<span class="c">=</span> <span class="w">5</span><span class="pc">0</span><span class="c">,</span>
		<span class="c">.</span><span class="w">reg</span><span class="pc">ion</span>			<span class="c">=</span> <span class="pc">1</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">,</span>
	
	<span class="c">{</span>
		<span class="c">.</span><span class="pc">c</span><span class="c">hannel_spacing</span>	<span class="c">=</span> <span class="w">10</span><span class="c">,</span>
		<span class="c">.bottom_frequency</span>	<span class="c">=</span> <span class="pc">87</span><span class="c">500,</span>
		<span class="c">.top_frequency</span>		<span class="c">=</span> <span class="c">108000,</span>
		<span class="c">.deemphasis</span>		<span class="c">=</span> <span class="w">5</span><span class="pc">0</span><span class="c">,</span>
		<span class="c">.</span><span class="w">regi</span><span class="pc">on</span>			<span class="c">=</span> <span class="w">2</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">,</span>
	
	<span class="c">{</span>
		<span class="c">.</span><span class="pc">c</span><span class="c">hannel_spacing</span>	<span class="c">=</span> <span class="w">10</span><span class="c">,</span>
		<span class="c">.bottom_frequency</span>	<span class="c">=</span> <span class="w">76000</span><span class="c">,</span>
		<span class="c">.top_frequency</span>		<span class="c">=</span> <span class="w">90000</span><span class="c">,</span>
		<span class="c">.deemphasis</span>		<span class="c">=</span> <span class="w">5</span><span class="pc">0</span><span class="c">,</span>
		<span class="c">.</span><span class="w">reg</span><span class="pc">ion</span>			<span class="c">=</span> <span class="w">3</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">,</span>
	
	<span class="c">{</span>
		<span class="c">.</span><span class="pc">c</span><span class="c">hannel_spacing</span>	<span class="c">=</span> <span class="w">10</span><span class="c">,</span>
		<span class="c">.bottom_frequency</span>	<span class="c">=</span> <span class="pc">7</span><span class="c">6000,</span>
		<span class="c">.top_frequency</span>		<span class="c">=</span> <span class="w">108000</span><span class="c">,</span>
		<span class="c">.deemphasis</span>		<span class="c">=</span> <span class="w">5</span><span class="pc">0</span><span class="c">,</span>
		<span class="c">.</span><span class="w">regi</span><span class="pc">on</span>			<span class="c">=</span> <span class="w">4</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_send_command</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="pc">r</span><span class="c">eg,</span>
					<span class="c">unsigned</span> <span class="c">int</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">i</span><span class="c">2c_client</span> <span class="c">*client</span> <span class="c">=</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="pc">l</span><span class="c">ient;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">d</span><span class="c">ata[</span><span class="pc">2</span><span class="c">];</span>

	<span class="pc">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">power_state</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">d</span><span class="pc">ev_e</span><span class="c">rr</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">lient</span><span class="pc">-</span><span class="c">&gt;dev, "</span><span class="w">bcm2048</span><span class="pc">:</span> <span class="w">c</span><span class="pc">h</span><span class="c">ip</span> <span class="w">n</span><span class="c">ot</span> <span class="w">powered</span><span class="pc">!</span><span class="c">\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">d</span><span class="c">ata</span><span class="pc">[</span><span class="c">0] =</span> <span class="w">r</span><span class="pc">eg</span> <span class="pc">&amp;</span> <span class="c">0xff;</span>
	<span class="pc">d</span><span class="c">ata[</span><span class="pc">1</span><span class="c">] =</span> <span class="w">v</span><span class="c">alue</span> <span class="pc">&amp;</span> <span class="c">0xff;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">i2c_master_send</span><span class="c">(client,</span> <span class="w">d</span><span class="pc">a</span><span class="c">ta</span><span class="pc">,</span> <span class="w">2) </span><span class="pc">=</span><span class="c">=</span> <span class="pc">2</span><span class="c">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">de</span><span class="pc">v_e</span><span class="c">rr</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">lient</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="pc">, "</span><span class="w">BCM</span> <span class="w">I2C</span> <span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="w">!</span><span class="c">\n");</span>
	<span class="w">d</span><span class="pc">ev_e</span><span class="c">rr</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">lient-&gt;dev, "</span><span class="w">Is</span> <span class="w">Bluetooth</span> <span class="w">u</span><span class="pc">p</span> <span class="w">a</span><span class="pc">n</span><span class="c">d</span> <span class="w">running?\n</span><span class="c">");</span>
	<span class="c">return</span> <span class="pc">-EI</span><span class="c">O;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">bcm2048_recv_command</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">r</span><span class="pc">eg</span><span class="c">,</span>
			<span class="pc">u8</span> <span class="c">*</span><span class="w">v</span><span class="pc">alu</span><span class="c">e)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">i2c_client</span> <span class="c">*client</span> <span class="c">=</span> <span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="c">lient;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">power_state</span><span class="c">) {</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">lient-&gt;dev, "</span><span class="w">bcm2048:</span> <span class="w">c</span><span class="pc">hi</span><span class="c">p</span> <span class="w">n</span><span class="c">ot</span> <span class="w">powered</span><span class="pc">!</span><span class="c">\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="w">[</span><span class="c">0] =</span> <span class="w">i2c_smbus_read_byte_data</span><span class="c">(client</span><span class="pc">,</span> <span class="pc">r</span><span class="c">eg</span> <span class="w">&amp;</span> <span class="c">0xff);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_recv_duples</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="c">reg,</span>
			<span class="pc">u8</span> <span class="c">*</span><span class="pc">valu</span><span class="c">e</span><span class="pc">,</span> <span class="pc">u8</span> <span class="w">duples</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="c">i2c_client</span> <span class="c">*client</span> <span class="c">=</span> <span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;client;</span>
	<span class="c">struct</span> <span class="pc">i2c_a</span><span class="c">dapter</span> <span class="c">*</span><span class="pc">a</span><span class="c">dap</span> <span class="c">=</span> <span class="c">client-&gt;</span><span class="pc">a</span><span class="c">dapter;</span>
	<span class="c">struct</span> <span class="w">i2c_msg</span> <span class="w">m</span><span class="c">sg</span><span class="pc">[</span><span class="c">2];</span>
	<span class="pc">u</span><span class="c">8</span> <span class="pc">b</span><span class="c">uf</span><span class="pc">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">power_state</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">d</span><span class="c">ev_err</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">lient-&gt;dev</span><span class="pc">, "</span><span class="w">bcm2048</span><span class="pc">:</span> <span class="w">c</span><span class="pc">hi</span><span class="c">p</span> <span class="w">n</span><span class="c">ot</span> <span class="w">powered!</span><span class="c">\n");</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">E</span><span class="pc">IO</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">b</span><span class="c">uf</span> <span class="pc">=</span> <span class="w">reg</span> <span class="w">&amp;</span> <span class="pc">0</span><span class="c">xff;</span>

	<span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="pc">[0].a</span><span class="c">ddr</span> <span class="c">=</span> <span class="pc">c</span><span class="c">lient-&gt;</span><span class="w">a</span><span class="c">ddr</span><span class="pc">;</span>
	<span class="w">m</span><span class="pc">s</span><span class="c">g</span><span class="pc">[0</span><span class="c">].</span><span class="pc">f</span><span class="c">lags</span> <span class="pc">=</span> <span class="c">client-&gt;</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="pc">&amp;</span> <span class="w">I2C_M_TEN</span><span class="c">;</span>
	<span class="pc">m</span><span class="c">sg</span><span class="pc">[0</span><span class="c">].</span><span class="pc">l</span><span class="c">en</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
	<span class="c">msg</span><span class="pc">[0</span><span class="c">].</span><span class="pc">b</span><span class="c">uf</span> <span class="pc">= </span><span class="c">&amp;</span><span class="pc">b</span><span class="c">uf;</span>

	<span class="c">msg[</span><span class="pc">1</span><span class="c">].</span><span class="pc">a</span><span class="c">ddr</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient-&gt;</span><span class="pc">a</span><span class="c">ddr</span><span class="pc">;</span>
	<span class="c">msg</span><span class="pc">[1</span><span class="c">].</span><span class="pc">f</span><span class="c">lags</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">lient-&gt;</span><span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="pc">&amp;</span> <span class="w">I</span><span class="c">2C_M_TEN</span><span class="pc">;</span>
	<span class="pc">m</span><span class="c">sg</span><span class="pc">[1</span><span class="c">].</span><span class="pc">f</span><span class="c">lags</span> <span class="pc">|</span><span class="c">=</span> <span class="w">I2C_M_RD</span><span class="c">;</span>
	<span class="c">msg</span><span class="pc">[</span><span class="c">1].</span><span class="pc">l</span><span class="c">en</span> <span class="c">=</span> <span class="w">duples</span><span class="c">;</span>
	<span class="c">msg</span><span class="pc">[</span><span class="c">1].</span><span class="pc">b</span><span class="c">uf</span> <span class="c">=</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="w">i2c_transfer</span><span class="pc">(</span><span class="w">a</span><span class="pc">dap</span><span class="c">,</span> <span class="w">m</span><span class="c">sg,</span> <span class="w">2</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">bcm2048_set_power_state</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">u</span><span class="c">8</span> <span class="w">p</span><span class="pc">o</span><span class="c">wer)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">po</span><span class="pc">w</span><span class="c">er</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">power_state</span> <span class="c">=</span> <span class="w">BCM2048_POWER_ON</span><span class="pc">;</span>
		<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">cache_fm_rds_system</span> <span class="w">|</span><span class="c">=</span> <span class="w">BCM2048_FM_ON</span><span class="c">;</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;cache_fm_rds_system</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">B</span><span class="pc">CM2048_F</span><span class="c">M_ON;</span>
	<span class="pc">}</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">pow</span><span class="pc">er</span><span class="w">)</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_RDS_SYSTEM</span><span class="c">,</span>
					<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">ache_fm_rds_system</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">ms</span><span class="c">leep(</span><span class="w">BCM2048_DEFAULT_POWERING_DELAY</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">pow</span><span class="c">er</span><span class="pc">)</span>
		<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">power_state</span> <span class="c">=</span> <span class="w">BCM2048_POWER_OFF</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">utex_u</span><span class="c">nlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_power_state</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_RDS_SYSTEM</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr</span> <span class="w">&amp;</span><span class="pc">&amp; (</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">&amp;</span> <span class="w">BCM2048_FM_ON</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">BCM2048_POWER_ON</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_rds_no_lock</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">rds_on</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">f</span><span class="pc">l</span><span class="c">ags;</span>

	<span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cache_fm_rds_system</span> <span class="w">&amp;</span><span class="pc">= </span><span class="c">~</span><span class="w">BCM2048_RDS_ON</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">rd</span><span class="c">s_on</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;cache_fm_rds_system</span> <span class="w">|</span><span class="c">=</span> <span class="c">BCM2048_RDS_ON;</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_state</span> <span class="c">=</span> <span class="w">B</span><span class="c">CM2048_RDS_ON;</span>
		<span class="w">fl</span><span class="pc">ags</span> <span class="pc">=</span>	<span class="w">BCM2048_RDS_FLAG_FIFO_WLINE</span><span class="pc">;</span>
		<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev,</span> <span class="w">BCM2048_I2C_FM_RDS_MASK1</span><span class="c">,</span>
						<span class="w">f</span><span class="c">lags);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">fl</span><span class="c">ags</span> <span class="c">=</span>	<span class="c">0;</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">rds_s</span><span class="c">tate</span> <span class="c">=</span> <span class="c">0;</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">b</span><span class="c">cm2048_send_command(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="c">BCM2048_I2C_FM_RDS_MASK1,</span>
						<span class="w">f</span><span class="c">lags);</span>
		<span class="w">m</span><span class="pc">e</span><span class="c">mset</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rds_info</span><span class="c">,</span> <span class="c">0,</span> <span class="c">sizeof(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;rds_info));</span>
	<span class="pc">}</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">b</span><span class="c">cm2048_send_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_RDS_SYSTEM</span><span class="pc">,</span>
					<span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cache_fm_rds_system</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_no_lock</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">B</span><span class="c">CM2048_I2C_FM_RDS_SYSTEM</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">err</span> <span class="w">&amp;</span><span class="pc">&amp; (</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="w">&amp;</span> <span class="w">BCM2048_RDS_ON</span><span class="c">))</span>
		<span class="c">return</span> <span class="w">BCM2048_ITEM_ENABLED</span><span class="pc">;</span>

	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_rds</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">rds_on</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_set_rds_no_lock</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="c">rds_on);</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">cm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>

	<span class="pc">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_get_rds_no_lock</span><span class="pc">(</span><span class="c">bdev);</span>

	<span class="c">mutex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_pi</span><span class="c">(struct</span> <span class="w">b</span><span class="c">cm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">rds_info</span><span class="c">.</span><span class="w">rds_pi;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_automatic_stereo_mono</span><span class="c">(struct</span> <span class="w">b</span><span class="pc">cm2048_d</span><span class="c">evice</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span>
						<span class="w">u</span><span class="pc">8</span> <span class="w">en</span><span class="pc">abled</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="pc">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">cache_fm_ctrl</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">BCM2048_STEREO_MONO_AUTO_SELECT</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">en</span><span class="pc">abled</span><span class="c">)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">ache_fm_ctrl</span> <span class="pc">|</span><span class="c">=</span> <span class="c">BCM2048_STEREO_MONO_AUTO_SELECT;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_CTRL</span><span class="pc">,</span>
					<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="c">ache_fm_ctrl</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_hi_lo_injection</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
						<span class="pc">u8</span> <span class="w">hi_lo</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="c">ache_fm_ctrl</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="w">BCM2048_HI_LO_INJECTION</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">h</span><span class="c">i_lo</span><span class="w">)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">ache_fm_ctrl</span> <span class="pc">|</span><span class="c">=</span> <span class="c">BCM2048_HI_LO_INJECTION;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_CTRL</span><span class="c">,</span>
					<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="c">ache_fm_ctrl</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_hi_lo_injection</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_CTRL</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr</span> <span class="w">&amp;</span><span class="pc">&amp; (</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">&amp;</span> <span class="w">BCM2048_HI_LO_INJECTION</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">BCM2048_ITEM_ENABLED</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_frequency</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span> <span class="pc">u3</span><span class="c">2</span> <span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="pc">&lt;</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">region_info</span><span class="pc">.</span><span class="w">bottom_frequency</span> <span class="pc">|</span><span class="c">|</span>
		<span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="pc">&gt;</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;region_info.</span><span class="w">top_frequency)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EDOM</span><span class="c">;</span>

	<span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="w">-</span><span class="pc">=</span> <span class="w">BCM2048_FREQUENCY_BASE</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_FREQ0</span><span class="c">,</span> <span class="w">lsb(fr</span><span class="pc">equ</span><span class="c">ency</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="w">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">c</span><span class="c">m2048_send_command</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_FREQ1</span><span class="pc">,</span>
					<span class="w">msb(fr</span><span class="pc">equ</span><span class="c">ency</span><span class="pc">))</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">err)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="c">=</span> <span class="w">fr</span><span class="pc">equ</span><span class="c">ency;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_frequency</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">lsb</span><span class="pc">,</span> <span class="w">m</span><span class="c">sb</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_FREQ0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_FREQ1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">sb);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">compose_u16</span><span class="pc">(</span><span class="w">m</span><span class="c">sb,</span> <span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="w">+</span><span class="c">=</span> <span class="w">BCM2048_FREQUENCY_BASE</span><span class="pc">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_af_frequency</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span>
						<span class="w">u</span><span class="pc">3</span><span class="c">2</span> <span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="c">&lt;</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">region_info</span><span class="pc">.</span><span class="w">bottom_frequency</span> <span class="pc">|</span><span class="c">|</span>
		<span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="pc">&gt;</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;region_info.</span><span class="w">top_frequency)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">EDOM</span><span class="c">;</span>

	<span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="w">-</span><span class="pc">=</span> <span class="w">BCM2048_FREQUENCY_BASE</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_AF_FREQ0</span><span class="c">,</span>
					<span class="w">lsb(fr</span><span class="pc">equ</span><span class="c">ency</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="w">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">c</span><span class="c">m2048_send_command</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_AF_FREQ1</span><span class="pc">,</span>
					<span class="w">msb(fr</span><span class="pc">equ</span><span class="c">ency</span><span class="pc">))</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">err)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="c">=</span> <span class="w">fr</span><span class="pc">equ</span><span class="c">ency;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_af_frequency</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">lsb</span><span class="pc">,</span> <span class="w">m</span><span class="c">sb</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AF_FREQ0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_AF_FREQ1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">sb);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">compose_u16</span><span class="pc">(</span><span class="w">m</span><span class="c">sb,</span> <span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="w">+</span><span class="c">=</span> <span class="w">BCM2048_FREQUENCY_BASE</span><span class="pc">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_deemphasis</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">d</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">deemphasis</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="w">d</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_DE_EMPHASIS_75us</span><span class="c">)</span>
		<span class="w">d</span><span class="pc">e</span><span class="c">emphasis</span> <span class="pc">=</span> <span class="w">BCM2048_DE_EMPHASIS_SELECT</span><span class="pc">;</span>
	<span class="c">else</span>
		<span class="w">d</span><span class="c">eemphasis</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">cache_fm_audio_ctrl0</span> <span class="w">&amp;</span><span class="c">= ~</span><span class="pc">B</span><span class="c">CM2048_DE_EMPHASIS_SELECT;</span>
	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;cache_fm_audio_ctrl0</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">d</span><span class="c">eemphasis;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">de</span><span class="c">v</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">ache_fm_audio_ctrl0</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">err</span><span class="pc">)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">region_info</span><span class="pc">.</span><span class="w">d</span><span class="c">eemphasis</span> <span class="c">=</span> <span class="w">d</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_deemphasis</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">de</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">a</span><span class="c">lue</span> <span class="pc">&amp;</span> <span class="w">BCM2048_DE_EMPHASIS_SELECT</span><span class="pc">)</span>
			<span class="c">return</span> <span class="w">BCM2048_DE_EMPHASIS_75us</span><span class="pc">;</span>

		<span class="pc">r</span><span class="c">eturn</span> <span class="w">BCM2048_DE_EMPHASIS_50us</span><span class="pc">;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_region</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">r</span><span class="pc">egi</span><span class="c">on)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="c">32</span> <span class="w">new_frequency</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">regi</span><span class="pc">o</span><span class="c">n</span> <span class="w">&gt;</span><span class="c">=</span> <span class="w">A</span><span class="c">RRAY_SIZE(</span><span class="w">region_configs</span><span class="c">))</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="pc">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">region_info</span> <span class="c">=</span> <span class="w">r</span><span class="pc">egion_c</span><span class="c">onfigs</span><span class="w">[regi</span><span class="pc">on];</span>
	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;mutex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">b</span><span class="pc">de</span><span class="c">v-&gt;</span><span class="w">f</span><span class="pc">r</span><span class="c">equency</span> <span class="w">&lt;</span> <span class="pc">r</span><span class="c">egion_configs</span><span class="w">[reg</span><span class="pc">ion].</span><span class="w">bottom_frequency</span> <span class="w">|</span><span class="c">|</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">fr</span><span class="pc">eq</span><span class="c">uency</span> <span class="w">&gt;</span> <span class="pc">r</span><span class="c">egion_configs</span><span class="w">[reg</span><span class="pc">ion</span><span class="c">].</span><span class="w">top_frequency)</span>
		<span class="w">new_frequency</span> <span class="c">=</span> <span class="c">region_configs</span><span class="pc">[</span><span class="w">regi</span><span class="pc">on</span><span class="c">].</span><span class="w">b</span><span class="c">ottom_frequency</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(new_frequency</span> <span class="pc">&gt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">bcm2048_set_fm_frequency</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="c">new_frequency</span><span class="pc">)</span><span class="c">;</span>

		<span class="c">if</span> <span class="c">(err</span><span class="pc">)</span>
			<span class="c">goto</span> <span class="pc">d</span><span class="c">one;</span>
	<span class="pc">}</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_set_fm_deemphasis</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span>
			<span class="c">region_configs</span><span class="w">[reg</span><span class="pc">ion</span><span class="c">].</span><span class="w">deemphasis</span><span class="pc">)</span><span class="c">;</span>

<span class="w">do</span><span class="pc">n</span><span class="c">e</span><span class="pc">:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_region</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>

	<span class="pc">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">region_info</span><span class="pc">.</span><span class="w">regi</span><span class="pc">on</span><span class="w">;</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_mute</span><span class="c">(struct</span> <span class="w">b</span><span class="pc">cm2048_d</span><span class="c">evice</span> <span class="c">*</span><span class="w">b</span><span class="pc">de</span><span class="c">v,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">mute</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">cache_fm_audio_ctrl0</span> <span class="w">&amp;=</span><span class="pc"> ~(</span><span class="w">BCM2048_RF_MUTE</span> <span class="c">|</span> <span class="w">BCM2048_MANUAL_MUTE</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="c">ute</span><span class="w">)</span>
		<span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;cache_fm_audio_ctrl0</span> <span class="w">|</span><span class="pc">= </span><span class="c">(</span><span class="pc">B</span><span class="c">CM2048_RF_MUTE</span> <span class="c">|</span>
						<span class="pc">B</span><span class="c">CM2048_MANUAL_MUTE);</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span>
					<span class="w">b</span><span class="pc">de</span><span class="c">v-&gt;</span><span class="w">c</span><span class="c">ache_fm_audio_ctrl0</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">err)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">mute_state</span> <span class="c">=</span> <span class="w">m</span><span class="c">ute</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">de</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_mute</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">power_state</span><span class="pc">)</span><span class="c"> {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span>
						<span class="w">&amp;va</span><span class="pc">lu</span><span class="c">e);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">err</span><span class="pc">)</span>
			<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">BCM2048_RF_MUTE</span> <span class="c">|</span> <span class="w">BCM2048_MANUAL_MUTE</span><span class="c">);</span>
	<span class="w">}</span> <span class="c">else</span> <span class="pc">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">mute_state</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_audio_route</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">route</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">r</span><span class="pc">o</span><span class="c">ute</span> <span class="w">&amp;= (BCM2048_AUDIO_ROUTE_DAC</span> <span class="w">|</span> <span class="w">BCM2048_AUDIO_ROUTE_I2S</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">cache_fm_audio_ctrl0</span> <span class="w">&amp;=</span><span class="pc"> ~(B</span><span class="c">CM2048_AUDIO_ROUTE_DAC</span> <span class="c">|</span>
		<span class="pc">B</span><span class="c">CM2048_AUDIO_ROUTE_I2S);</span>
	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">ache_fm_audio_ctrl0</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">r</span><span class="c">oute</span><span class="pc">;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span>
					<span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">che_fm_audio_ctrl0</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;mutex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_audio_route</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="c">return</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">BCM2048_AUDIO_ROUTE_DAC</span> <span class="c">|</span>
			<span class="w">BCM2048_AUDIO_ROUTE_I2S</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">bcm2048_set_dac_output</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">ch</span><span class="pc">annels</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">cache_fm_audio_ctrl0</span> <span class="w">&amp;=</span><span class="pc"> ~(</span><span class="w">BCM2048_DAC_OUTPUT_LEFT</span> <span class="c">|</span>
					<span class="w">BCM2048_DAC_OUTPUT_RIGHT</span><span class="c">);</span>
	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="c">ache_fm_audio_ctrl0</span> <span class="pc">|</span><span class="c">=</span> <span class="w">ch</span><span class="pc">annels</span><span class="c">;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span>
					<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="pc">ac</span><span class="c">he_fm_audio_ctrl0</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;mutex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_dac_output</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_AUDIO_CTRL0</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="c">return</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">BCM2048_DAC_OUTPUT_LEFT</span> <span class="c">|</span>
			<span class="w">BCM2048_DAC_OUTPUT_RIGHT</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_search_rssi_threshold</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span>
							<span class="w">u</span><span class="pc">8</span> <span class="w">threshold</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">t</span><span class="c">hreshold</span> <span class="w">&amp;</span><span class="pc">=</span> <span class="w">BCM2048_SEARCH_RSSI_THRESHOLD</span><span class="c">;</span>
	<span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">cache_fm_search_ctrl0</span> <span class="w">&amp;</span><span class="pc">= </span><span class="c">~</span><span class="pc">B</span><span class="c">CM2048_SEARCH_RSSI_THRESHOLD;</span>
	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;cache_fm_search_ctrl0</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">t</span><span class="c">hreshold;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_SEARCH_CTRL0</span><span class="pc">,</span>
					<span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="pc">a</span><span class="c">che_fm_search_ctrl0</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_search_rssi_threshold</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_SEARCH_CTRL0</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="c">return</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">&amp;</span> <span class="w">BCM2048_SEARCH_RSSI_THRESHOLD</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_search_mode_direction</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">de</span><span class="c">v,</span>
						<span class="w">u</span><span class="pc">8</span> <span class="w">di</span><span class="pc">re</span><span class="c">ction)</span>
<span class="c">{</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="pc">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">cache_fm_search_ctrl0</span> <span class="w">&amp;</span><span class="pc">=</span><span class="c"> ~</span><span class="w">BCM2048_SEARCH_DIRECTION</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">di</span><span class="pc">re</span><span class="c">ction</span><span class="pc">)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">c</span><span class="c">ache_fm_search_ctrl0</span> <span class="pc">|</span><span class="c">=</span> <span class="c">BCM2048_SEARCH_DIRECTION;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_SEARCH_CTRL0</span><span class="c">,</span>
					<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="c">ache_fm_search_ctrl0</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_search_mode_direction</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_SEARCH_CTRL0</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr</span> <span class="w">&amp;</span><span class="pc">&amp; (</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">&amp;</span> <span class="w">BCM2048_SEARCH_DIRECTION</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">BCM2048_SEARCH_DIRECTION_UP</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_search_tune_mode</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span>
						<span class="w">u</span><span class="pc">8</span> <span class="w">m</span><span class="c">ode</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">,</span> <span class="w">t</span><span class="pc">i</span><span class="c">meout</span><span class="w">,</span> <span class="w">restart_rds</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">,</span> <span class="w">f</span><span class="c">lags</span><span class="pc">;</span>

	<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="w">mo</span><span class="c">de</span> <span class="w">&amp;</span> <span class="w">BCM2048_FM_AUTO_SEARCH</span><span class="c">;</span>

	<span class="w">f</span><span class="pc">l</span><span class="c">ags</span> <span class="c">=</span>	<span class="w">BCM2048_FM_FLAG_SEARCH_TUNE_FINISHED</span> <span class="pc">|</span>
		<span class="w">BCM2048_FM_FLAG_SEARCH_TUNE_FAIL</span><span class="pc">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">bcm2048_get_rds_no_lock</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">)</span><span class="c">) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_set_rds_no_lock</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
			<span class="c">goto</span> <span class="pc">u</span><span class="c">nlock;</span>
		<span class="w">restart_rds</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="pc">er</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_RDS_MASK0</span><span class="c">,</span> <span class="w">f</span><span class="c">lags);</span>

	<span class="c">if</span> <span class="c">(err)</span>
		<span class="c">goto</span> <span class="pc">u</span><span class="c">nlock;</span>

	<span class="w">b</span><span class="pc">cm2048_sen</span><span class="c">d_command</span><span class="pc">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">BCM2048_I2C_FM_SEARCH_TUNE_MODE</span><span class="pc">,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">o</span><span class="c">de</span> <span class="pc">!</span><span class="c">=</span> <span class="w">BCM2048_FM_AUTO_SEARCH_MODE</span><span class="c">)</span>
		<span class="w">t</span><span class="pc">i</span><span class="c">meout</span> <span class="c">=</span> <span class="w">BCM2048_DEFAULT_TIMEOUT</span><span class="pc">;</span>
	<span class="c">else</span>
		<span class="w">t</span><span class="pc">i</span><span class="c">meout</span> <span class="c">=</span> <span class="w">BCM2048_AUTO_SEARCH_TIMEOUT</span><span class="pc">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">wait_for_completion_timeout</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">compl</span><span class="c">,</span>
			<span class="w">m</span><span class="c">secs_to_jiffies(</span><span class="w">t</span><span class="pc">i</span><span class="c">meout</span><span class="w">))</span><span class="pc">)</span>
			<span class="w">d</span><span class="c">ev_err(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">cl</span><span class="pc">i</span><span class="c">ent-&gt;dev, "</span><span class="w">I</span><span class="pc">R</span><span class="c">Q</span> <span class="w">ti</span><span class="pc">meo</span><span class="c">ut</span><span class="w">.</span><span class="c">\n");</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">)</span>
		<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">scan_state</span><span class="c">)</span>
			<span class="w">e</span><span class="pc">rr</span> <span class="c">= -</span><span class="pc">EIO</span><span class="c">;</span>

<span class="w">u</span><span class="pc">nl</span><span class="c">ock:</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">restart_rds</span><span class="pc">)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">bcm2048_set_rds_no_lock</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">1</span><span class="c">);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_search_tune_mode</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_SEARCH_TUNE_MODE</span><span class="pc">,</span>
					<span class="w">&amp;va</span><span class="pc">lu</span><span class="c">e);</span>

	<span class="w">m</span><span class="pc">utex_u</span><span class="c">nlock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">err)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">&amp;</span> <span class="w">BCM2048_FM_AUTO_SEARCH</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_rds_b_block_mask</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">m</span><span class="pc">a</span><span class="c">sk)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="pc">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MASK0</span><span class="pc">,</span> <span class="w">lsb</span><span class="pc">(</span><span class="w">m</span><span class="pc">a</span><span class="c">sk</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_s</span><span class="c">end_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MASK1</span><span class="c">,</span> <span class="w">msb</span><span class="pc">(</span><span class="w">m</span><span class="c">ask</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_b_block_mask</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">ls</span><span class="c">b</span><span class="pc">,</span> <span class="w">m</span><span class="c">sb</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MASK0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MASK1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">sb);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">compose_u16</span><span class="c">(</span><span class="w">m</span><span class="pc">s</span><span class="c">b</span><span class="pc">,</span> <span class="pc">l</span><span class="c">sb</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_rds_b_block_match</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
						<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">ma</span><span class="pc">t</span><span class="c">ch</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="pc">b</span><span class="c">dev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MATCH0</span><span class="pc">,</span> <span class="w">l</span><span class="c">sb</span><span class="pc">(</span><span class="w">mat</span><span class="c">ch</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_s</span><span class="c">end_command(</span><span class="pc">b</span><span class="c">dev,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MATCH1</span><span class="pc">,</span> <span class="w">msb</span><span class="pc">(</span><span class="w">mat</span><span class="c">ch</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_b_block_match</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">ls</span><span class="c">b</span><span class="pc">,</span> <span class="w">m</span><span class="c">sb</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MATCH0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_I2C_RDS_BLKB_MATCH1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">sb);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">compose_u16</span><span class="c">(</span><span class="w">m</span><span class="pc">s</span><span class="c">b</span><span class="pc">,</span> <span class="pc">l</span><span class="c">sb</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_rds_pi_mask</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">m</span><span class="pc">a</span><span class="c">sk</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(bdev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MASK0</span><span class="pc">,</span> <span class="w">l</span><span class="c">sb</span><span class="pc">(</span><span class="w">m</span><span class="pc">a</span><span class="c">sk</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_s</span><span class="c">end_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MASK1</span><span class="c">,</span> <span class="w">msb</span><span class="pc">(</span><span class="w">m</span><span class="c">ask</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_pi_mask</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">ls</span><span class="c">b</span><span class="pc">,</span> <span class="w">m</span><span class="c">sb</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MASK0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MASK1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">sb);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">compose_u16</span><span class="c">(</span><span class="w">m</span><span class="pc">s</span><span class="c">b</span><span class="pc">,</span> <span class="pc">l</span><span class="c">sb</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_rds_pi_match</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">ma</span><span class="pc">t</span><span class="c">ch</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="pc">b</span><span class="c">dev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MATCH0</span><span class="pc">,</span> <span class="w">l</span><span class="c">sb</span><span class="pc">(</span><span class="w">mat</span><span class="c">ch</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_s</span><span class="c">end_command(</span><span class="pc">b</span><span class="c">dev,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MATCH1</span><span class="pc">,</span> <span class="w">msb</span><span class="pc">(</span><span class="w">mat</span><span class="c">ch</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_pi_match</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">ls</span><span class="c">b</span><span class="pc">,</span> <span class="w">m</span><span class="c">sb</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MATCH0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">l</span><span class="c">sb);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_I2C_RDS_PI_MATCH1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">m</span><span class="c">sb);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">compose_u16</span><span class="c">(</span><span class="w">m</span><span class="pc">s</span><span class="c">b</span><span class="pc">,</span> <span class="pc">l</span><span class="c">sb</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_rds_mask</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">m</span><span class="pc">a</span><span class="c">sk</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(bdev</span><span class="pc">,</span>
			<span class="w">BCM2048_I2C_FM_RDS_MASK0</span><span class="pc">,</span> <span class="w">l</span><span class="c">sb</span><span class="pc">(</span><span class="w">m</span><span class="pc">a</span><span class="c">sk</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_s</span><span class="c">end_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_I2C_FM_RDS_MASK1</span><span class="c">,</span> <span class="w">msb</span><span class="pc">(</span><span class="w">m</span><span class="c">ask</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_rds_mask</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">value0</span><span class="pc">,</span> <span class="w">value1</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_RDS_MASK0</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">v</span><span class="pc">alue0</span><span class="c">);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_RDS_MASK1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">value1</span><span class="c">);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">compose_u16</span><span class="c">(</span><span class="w">v</span><span class="pc">alue1,</span> <span class="pc">value0)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_rds_flags</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">va</span><span class="pc">lue0,</span> <span class="w">v</span><span class="c">alue1</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_RDS_FLAG0</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">value0</span><span class="c">);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_r</span><span class="c">ecv_command(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_RDS_FLAG1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">value1</span><span class="c">);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">compose_u16</span><span class="c">(</span><span class="w">v</span><span class="pc">alue1,</span> <span class="pc">value0)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_region_bottom_frequency</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">region_info</span><span class="pc">.</span><span class="w">bottom_frequency</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_region_top_frequency</span><span class="c">(struct</span> <span class="w">b</span><span class="c">cm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">de</span><span class="c">v)</span>
<span class="c">{</span>
	<span class="c">return</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="c">egion_info.</span><span class="w">top_frequency</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_fm_best_tune_mode</span><span class="c">(struct</span> <span class="c">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">m</span><span class="c">ode)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>
	<span class="w">u</span><span class="c">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	
	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_BEST_TUNE_MODE</span><span class="pc">,</span>
					<span class="pc">&amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>
	<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">&amp;</span><span class="c">= ~</span><span class="w">BCM2048_BEST_TUNE_MODE</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">m</span><span class="pc">o</span><span class="c">de</span><span class="pc">)</span>
		<span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="pc">|</span><span class="c">=</span> <span class="pc">BCM2048_B</span><span class="c">EST_TUNE_MODE;</span>
	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="pc">|</span><span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">B</span><span class="pc">CM2048_I</span><span class="c">2C_FM_BEST_TUNE_MODE</span><span class="pc">,</span>
					<span class="c">value);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_best_tune_mode</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_BEST_TUNE_MODE</span><span class="pc">,</span>
					<span class="w">&amp;va</span><span class="pc">lu</span><span class="c">e);</span>

	<span class="w">m</span><span class="pc">utex_u</span><span class="c">nlock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">err</span> <span class="w">&amp;</span><span class="pc">&amp; (</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">&amp;</span> <span class="w">BCM2048_BEST_TUNE_MODE</span><span class="c">))</span>
		<span class="c">return</span> <span class="w">BCM2048_ITEM_ENABLED</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_carrier_error</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">s8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="pc">;</span>

	<span class="pc">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_CARRIER</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">valu</span><span class="c">e);</span>
	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="c">return</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_fm_rssi</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*bdev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">s8</span> <span class="w">v</span><span class="c">alue;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_RSSI</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">valu</span><span class="c">e);</span>
	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr)</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_set_rds_wline</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*bdev,</span> <span class="w">u</span><span class="pc">8</span> <span class="w">wline</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">mutex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_send_command</span><span class="c">(</span><span class="pc">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_RDS_WLINE</span><span class="pc">,</span> <span class="pc">w</span><span class="c">line);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">err)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">fifo_size</span> <span class="c">=</span> <span class="pc">w</span><span class="c">line</span><span class="pc">;</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;mutex);</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_wline</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_RDS_WLINE</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!e</span><span class="c">rr</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">fifo_size</span> <span class="c">=</span> <span class="w">va</span><span class="pc">lu</span><span class="c">e;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">int</span> <span class="w">bcm2048_checkrev</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">v</span><span class="pc">e</span><span class="c">rsion;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;mutex);</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_RDS_REV</span><span class="pc">,</span><span class="c"> &amp;</span><span class="w">ve</span><span class="c">rsion);</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">err</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">d</span><span class="pc">ev_i</span><span class="c">nfo(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">c</span><span class="pc">l</span><span class="c">ient-&gt;dev, "</span><span class="w">BCM2048</span> <span class="w">Version</span> <span class="w">0</span><span class="pc">x</span><span class="c">%</span><span class="w">x</span><span class="c">\n",</span>
			<span class="w">ve</span><span class="pc">r</span><span class="c">sion);</span>
		<span class="c">return</span> <span class="w">ve</span><span class="pc">r</span><span class="c">sion;</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="pc">rr</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_rt</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="pc">d</span><span class="c">ata)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">i</span><span class="pc">,</span> <span class="w">j</span> <span class="pc">=</span> <span class="c">0,</span> <span class="w">ce</span> <span class="c">=</span> <span class="c">0,</span> <span class="w">cr</span> <span class="c">=</span> <span class="c">0</span><span class="pc">;</span>
	<span class="w">ch</span><span class="pc">ar</span> <span class="w">data_buffer</span><span class="c">[</span><span class="w">BCM2048_MAX_RDS_RT</span><span class="pc">+</span><span class="c">1];</span>

	<span class="w">m</span><span class="pc">u</span><span class="c">tex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;mutex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">text_len</span><span class="c">) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>
	<span class="c">}</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">B</span><span class="c">CM2048_MAX_RDS_RT</span><span class="pc">;</span> <span class="c">i++) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">r</span><span class="c">ds_info</span><span class="pc">.</span><span class="w">rds_rt</span><span class="pc">[</span><span class="c">i</span><span class="pc">])</span><span class="c"> {</span>
			<span class="w">ce</span> <span class="pc">=</span> <span class="w">i</span><span class="c">;</span>
			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.rds_r</span><span class="c">t[i</span><span class="w">] </span><span class="pc">!</span><span class="c">=</span> <span class="w">0x0d</span><span class="c">) {</span>
				<span class="w">data_buffer[</span><span class="pc">j+</span><span class="c">+] =</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">rds_rt[i</span><span class="pc">];</span>
			<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span>
				<span class="w">cr</span> <span class="pc">=</span> <span class="w">i</span><span class="c">;</span>
				<span class="w">b</span><span class="c">reak;</span>
			<span class="c">}</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">j</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">BCM2048_MAX_RDS_RT</span><span class="pc">)</span>
		<span class="pc">d</span><span class="c">ata_buffer</span><span class="pc">[</span><span class="w">j</span><span class="c">] =</span> <span class="c">0;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">B</span><span class="c">CM2048_MAX_RDS_RT;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">rds_rt</span><span class="c">[i]) {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">cr</span> <span class="w">&amp;</span><span class="pc">&amp; (i</span> <span class="c">&lt;</span> <span class="w">cr))</span><span class="c"> {</span>
				<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EB</span><span class="c">USY;</span>
				<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>
			<span class="c">}</span>
			<span class="c">if</span> <span class="c">(i</span> <span class="c">&lt;</span> <span class="w">ce</span><span class="c">) {</span>
				<span class="c">if</span> <span class="c">(</span><span class="w">cr</span> <span class="w">&amp;</span><span class="pc">&amp; </span><span class="c">(</span><span class="pc">i</span> <span class="c">&gt;=</span> <span class="w">cr))</span>
					<span class="pc">b</span><span class="c">reak;</span>
				<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">= -</span><span class="w">EB</span><span class="c">USY;</span>
				<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>
			<span class="c">}</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">d</span><span class="pc">a</span><span class="c">ta,</span> <span class="w">data_buffer</span><span class="c">,</span> <span class="c">sizeof(data_buffer));</span>

<span class="w">u</span><span class="c">nlock:</span>
	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_ps</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="pc">d</span><span class="c">ata</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">err</span> <span class="c">=</span> <span class="c">0</span><span class="w">,</span> <span class="w">i</span><span class="pc">,</span> <span class="w">j</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">d</span><span class="pc">ata_</span><span class="c">buffer</span><span class="pc">[</span><span class="w">BCM2048_MAX_RDS_PS</span><span class="pc">+</span><span class="c">1];</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">text_len</span><span class="c">) {</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>
	<span class="c">}</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">B</span><span class="c">CM2048_MAX_RDS_PS</span><span class="pc">;</span> <span class="c">i++) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">r</span><span class="c">ds_info</span><span class="pc">.</span><span class="w">rds_ps</span><span class="pc">[</span><span class="c">i</span><span class="pc">])</span><span class="c"> {</span>
			<span class="w">data_buffer[</span><span class="pc">j</span><span class="w">+</span><span class="pc">+</span><span class="c">] =</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.r</span><span class="c">ds_ps[i</span><span class="pc">];</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span> <span class="w">&lt;</span><span class="pc"> </span><span class="c">(</span><span class="w">B</span><span class="c">CM2048_MAX_RDS_PS</span> <span class="w">-</span> <span class="c">1)) {</span>
				<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EB</span><span class="c">USY;</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">u</span><span class="pc">n</span><span class="c">lock;</span>
			<span class="c">}</span>
		<span class="pc">}</span>
	<span class="c">}</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">j</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="w">B</span><span class="c">CM2048_MAX_RDS_PS</span><span class="pc">)</span>
		<span class="pc">d</span><span class="c">ata_buffer</span><span class="pc">[</span><span class="w">j</span><span class="pc">] </span><span class="c">=</span> <span class="c">0;</span>

	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">d</span><span class="pc">ata,</span> <span class="pc">d</span><span class="c">ata_buffer,</span> <span class="c">sizeof(</span><span class="pc">d</span><span class="c">ata_buffer));</span>

<span class="w">un</span><span class="pc">l</span><span class="c">ock:</span>
	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="c">return</span> <span class="w">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">bcm2048_parse_rds_pi</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i</span><span class="pc">,</span> <span class="w">cn</span><span class="c">t</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">u</span><span class="pc">1</span><span class="c">6</span> <span class="w">pi</span><span class="pc">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fifo_size</span><span class="c">;</span> <span class="c">i</span> <span class="pc">+=</span> <span class="w">BCM2048_RDS_FIFO_DUPLE_SIZE)</span><span class="c"> {</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text</span><span class="pc">[</span><span class="c">i</span><span class="w">] </span><span class="pc">==</span> <span class="w">BCM2048_RDS_BLOCK_A</span><span class="c">) {</span>

			<span class="w">pi</span> <span class="w">=</span><span class="pc"> (</span><span class="w">bd</span><span class="c">ev-&gt;rds_info</span><span class="pc">.ra</span><span class="c">dio_text[i</span><span class="w">+</span><span class="c">1</span><span class="w">] </span><span class="pc">&lt;</span><span class="c">&lt;</span> <span class="c">8</span><span class="w">) </span><span class="pc">+</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">r</span><span class="c">ds_info</span><span class="pc">.</span><span class="c">radio_text[i</span><span class="pc">+2];</span>

			<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rd</span><span class="c">s_info</span><span class="pc">.</span><span class="w">rds_pi</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.rd</span><span class="c">s_pi</span> <span class="pc">=</span> <span class="w">pi</span><span class="pc">;</span>
				<span class="pc">re</span><span class="c">turn</span><span class="w">;</span>
			<span class="c">}</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">pi</span> <span class="pc">!</span><span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rd</span><span class="c">s_info</span><span class="pc">.</span><span class="w">r</span><span class="pc">ds_p</span><span class="c">i</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">cn</span><span class="c">t</span><span class="pc">+</span><span class="c">+;</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cn</span><span class="c">t</span> <span class="c">&gt;</span> <span class="w">3</span><span class="c">) {</span>
					<span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">rds_i</span><span class="c">nfo.rds_pi</span> <span class="c">=</span> <span class="w">p</span><span class="c">i</span><span class="pc">;</span>
					<span class="w">cn</span><span class="c">t</span> <span class="c">=</span> <span class="c">0;</span>
				<span class="c">}</span>
			<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
				<span class="w">cn</span><span class="c">t</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="c">}</span>
		<span class="c">}</span>
	<span class="w">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">ds_i</span><span class="c">nfo</span><span class="pc">.</span><span class="w">radio_text[</span><span class="pc">i</span><span class="w">] &amp;</span> <span class="w">BCM2048_RDS_CRC_MASK</span><span class="pc">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">bcm2048_parse_rds_rt_block</span><span class="c">(struct</span> <span class="c">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="pc">,</span>
					<span class="c">int</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">,</span> <span class="c">int</span> <span class="w">cr</span><span class="pc">c</span><span class="c">)</span>
<span class="c">{</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cr</span><span class="c">c</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">r</span><span class="c">ds_info.</span><span class="w">rds_rt[</span><span class="pc">in</span><span class="c">dex</span><span class="pc">])</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.rds_rt</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">] </span><span class="c">=</span>
				<span class="w">bd</span><span class="c">ev-&gt;rds_info</span><span class="pc">.</span><span class="w">radio_text</span><span class="c">[i</span><span class="w">+</span><span class="c">1];</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">rds_rt[</span><span class="pc">in</span><span class="c">dex</span><span class="pc">+</span><span class="c">1</span><span class="pc">])</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.</span><span class="c">rds_rt[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">+</span><span class="c">1</span><span class="pc">] </span><span class="c">=</span>
				<span class="w">bd</span><span class="c">ev-&gt;rds_info</span><span class="pc">.</span><span class="c">radio_text[i</span><span class="pc">+2];</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">{</span>
		<span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.</span><span class="c">rds_rt[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">] </span><span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.</span><span class="pc">ra</span><span class="c">dio_text[</span><span class="pc">i</span><span class="w">+</span><span class="c">1];</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.rds_r</span><span class="c">t[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">+</span><span class="c">1</span><span class="pc">] </span><span class="c">=</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.ra</span><span class="c">dio_text[</span><span class="pc">i+2];</span>
	<span class="pc">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_parse_rt_match_b</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">cr</span><span class="pc">c,</span> <span class="w">rt_id,</span> <span class="w">rt_group_b</span><span class="c">,</span> <span class="w">rt_ab</span><span class="c">,</span> <span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="pc">=</span> <span class="c">0</span><span class="pc">;</span>

	<span class="w">cr</span><span class="c">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="c">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EIO;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="c">i</span><span class="w">] </span><span class="pc">&amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="c">) ==</span>
		<span class="w">BCM2048_RDS_BLOCK_B</span><span class="pc">) </span><span class="c">{</span>

		<span class="w">rt_id</span> <span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rd</span><span class="c">s_info.radio_text</span><span class="pc">[</span><span class="c">i</span><span class="w">+</span><span class="c">1</span><span class="w">] </span><span class="pc">&amp;</span>
			<span class="pc">B</span><span class="c">CM2048_RDS_BLOCK_MASK</span><span class="pc">;</span>
		<span class="w">rt_group_b</span> <span class="pc">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">radio_text[i</span><span class="w">+</span><span class="c">1</span><span class="w">]</span><span class="pc"> &amp;</span>
			<span class="w">BCM2048_RDS_GROUP_AB_MASK</span><span class="c">;</span>
		<span class="w">rt_ab</span> <span class="pc">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">radio_text</span><span class="pc">[</span><span class="c">i</span><span class="pc">+2</span><span class="w">] </span><span class="pc">&amp;</span>
				<span class="w">BCM2048_RDS_RT_AB_MASK</span><span class="c">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="pc">rt_g</span><span class="c">roup_b</span> <span class="w">!</span><span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="w">rds_rt_group_b)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">m</span><span class="pc">ems</span><span class="c">et</span><span class="pc">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">ds_i</span><span class="c">nfo</span><span class="pc">.</span><span class="w">rds_rt</span><span class="pc">,</span> <span class="w">0</span><span class="c">,</span>
				<span class="pc">s</span><span class="c">izeof(</span><span class="w">bd</span><span class="c">ev-&gt;rds_info.</span><span class="w">rd</span><span class="pc">s_rt)</span><span class="c">);</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.rds_rt_group_b</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">t</span><span class="c">_group_b</span><span class="pc">;</span>
		<span class="c">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rt_id</span> <span class="w">=</span><span class="pc">=</span> <span class="w">BCM2048_RDS_RT</span><span class="c">) {</span>
			
			<span class="c">if</span> <span class="c">(</span><span class="w">rt_ab</span> <span class="w">!</span><span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.</span><span class="w">rds_rt_ab</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">m</span><span class="pc">ems</span><span class="c">et(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">ds_i</span><span class="c">nfo</span><span class="pc">.</span><span class="c">rds_rt</span><span class="pc">,</span> <span class="w">0</span><span class="c">,</span>
					<span class="pc">s</span><span class="c">izeof(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">rd</span><span class="c">s_info.</span><span class="w">rd</span><span class="pc">s_rt</span><span class="c">));</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.rds_rt_ab</span> <span class="pc">=</span> <span class="w">r</span><span class="pc">t</span><span class="c">_ab</span><span class="pc">;</span>
			<span class="c">}</span>

			<span class="w">ind</span><span class="pc">e</span><span class="c">x</span> <span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">r</span><span class="c">ds_info.</span><span class="w">radio_text[</span><span class="pc">i</span><span class="w">+</span><span class="pc">2</span><span class="w">] &amp;</span>
					<span class="w">BCM2048_RDS_RT_INDEX</span><span class="pc">;</span>

			<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rd</span><span class="c">s_info.</span><span class="w">rds_rt_group_b</span><span class="pc">)</span>
				<span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">&lt;</span><span class="pc">&lt;=</span> <span class="c">1;</span>
			<span class="pc">e</span><span class="c">lse</span>
				<span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">&lt;&lt;</span><span class="pc">=</span> <span class="pc">2</span><span class="c">;</span>

			<span class="pc">r</span><span class="c">eturn</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="w">-E</span><span class="pc">IO</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_parse_rt_match_c</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="pc">,</span>
					<span class="c">int</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">cr</span><span class="c">c</span><span class="pc">;</span>

	<span class="w">cr</span><span class="c">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="c">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">0;</span>

	<span class="w">B</span><span class="pc">U</span><span class="c">G_ON</span><span class="pc">((</span><span class="w">in</span><span class="c">dex</span><span class="w">+2) &gt;</span><span class="pc">=</span> <span class="w">BCM2048_MAX_RDS_RT</span><span class="pc">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="pc">i</span><span class="w">] &amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="c">) ==</span>
		<span class="w">BCM2048_RDS_BLOCK_C</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="w">rds_rt_group_b</span><span class="pc">)</span>
			<span class="c">return</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">bcm2048_parse_rds_rt_block</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">i</span><span class="c">,</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex,</span> <span class="w">cr</span><span class="pc">c)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">bcm2048_parse_rt_match_d</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="c">,</span>
					<span class="c">int</span> <span class="pc">i</span><span class="c">ndex)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">cr</span><span class="c">c</span><span class="pc">;</span>

	<span class="w">cr</span><span class="c">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="c">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">B</span><span class="pc">U</span><span class="c">G_ON</span><span class="pc">((</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">+4) &gt;</span><span class="pc">=</span> <span class="w">BCM2048_MAX_RDS_RT)</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="pc">i] &amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="pc">) =</span><span class="c">=</span>
		<span class="w">BCM2048_RDS_BLOCK_D</span><span class="c">)</span>
		<span class="w">bcm2048_parse_rds_rt_block</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">+2</span><span class="pc">,</span> <span class="w">cr</span><span class="c">c</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">bcm2048_parse_rds_rt</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i</span><span class="pc">,</span> <span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">cr</span><span class="pc">c</span><span class="w">,</span> <span class="w">match_b</span> <span class="w">=</span> <span class="c">0,</span> <span class="w">match_c</span> <span class="pc">=</span> <span class="c">0,</span> <span class="w">match_d</span> <span class="c">=</span> <span class="c">0</span><span class="pc">;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">fifo_size</span><span class="c">;</span> <span class="c">i</span> <span class="pc">+=</span> <span class="w">BCM2048_RDS_FIFO_DUPLE_SIZE)</span><span class="c"> {</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">atch_b</span><span class="w">)</span><span class="c"> {</span>
			<span class="w">m</span><span class="pc">atch_b</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">=</span> <span class="w">bcm2048_parse_rt_match_b</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="pc">i)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">&gt;</span><span class="c">=</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">&lt;= (BCM2048_MAX_RDS_RT</span> <span class="w">-</span> <span class="w">5</span><span class="pc">)</span><span class="c">)</span>
				<span class="w">match_c</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(match_c</span><span class="w">)</span><span class="c"> {</span>
			<span class="w">m</span><span class="pc">atch_c</span> <span class="pc">=</span> <span class="c">0;</span>
			<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bcm2048_parse_rt_match_c</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">i</span><span class="c">,</span> <span class="w">i</span><span class="c">ndex</span><span class="w">))</span>
				<span class="w">match_d</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(match_d</span><span class="w">)</span><span class="c"> {</span>
			<span class="pc">match_d</span> <span class="pc">=</span> <span class="c">0;</span>
			<span class="w">bcm2048_parse_rt_match_d</span><span class="pc">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">,</span> <span class="w">i</span><span class="c">ndex</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="c">i</span><span class="w">] </span><span class="pc">&amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="pc">)</span>
			<span class="w">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_BLOCK_A</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">cr</span><span class="pc">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="pc">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="c">)</span>
				<span class="pc">c</span><span class="c">ontinue;</span>
			
			<span class="c">if</span> <span class="w">((</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">r</span><span class="pc">d</span><span class="c">s_info</span><span class="pc">.r</span><span class="c">adio_text</span><span class="w">[</span><span class="c">i</span><span class="w">+</span><span class="c">1</span><span class="w">] </span><span class="pc">&lt;</span><span class="c">&lt;</span> <span class="c">8</span><span class="w">) </span><span class="pc">+</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">radio_text[i</span><span class="pc">+2</span><span class="w">]) ==</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rd</span><span class="c">s_info</span><span class="pc">.</span><span class="w">rds_pi)</span>
					<span class="w">match_b</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">bcm2048_parse_rds_ps_block</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">i,</span>
					<span class="c">int</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">,</span> <span class="c">int</span> <span class="w">cr</span><span class="pc">c</span><span class="c">)</span>
<span class="c">{</span>
	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cr</span><span class="c">c</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">r</span><span class="pc">ds_i</span><span class="c">nfo.</span><span class="w">rds_ps[i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">])</span>
			<span class="w">bd</span><span class="c">ev-&gt;rds_info.rds_ps</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">] </span><span class="c">=</span>
				<span class="w">bd</span><span class="c">ev-&gt;rds_info</span><span class="pc">.</span><span class="w">radio_text</span><span class="c">[i</span><span class="w">+</span><span class="c">1];</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">rds_ps[</span><span class="pc">in</span><span class="c">dex</span><span class="pc">+</span><span class="c">1</span><span class="pc">])</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.</span><span class="c">rds_ps[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">+</span><span class="c">1</span><span class="pc">] </span><span class="c">=</span>
				<span class="w">bd</span><span class="c">ev-&gt;rds_info</span><span class="pc">.</span><span class="c">radio_text[i</span><span class="pc">+2];</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">{</span>
		<span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.</span><span class="c">rds_ps[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">] </span><span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.</span><span class="pc">ra</span><span class="c">dio_text[</span><span class="pc">i</span><span class="w">+</span><span class="c">1];</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.rds_p</span><span class="c">s[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="w">+</span><span class="c">1</span><span class="pc">] </span><span class="c">=</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds_i</span><span class="c">nfo</span><span class="pc">.ra</span><span class="c">dio_text[</span><span class="pc">i+2];</span>
	<span class="pc">}</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_parse_ps_match_c</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="pc">,</span>
					<span class="c">int</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">cr</span><span class="c">c</span><span class="pc">;</span>

	<span class="w">cr</span><span class="c">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">r</span><span class="c">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="c">if</span> <span class="pc">((</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="pc">i</span><span class="w">] </span><span class="pc">&amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="pc">) =</span><span class="c">=</span>
		<span class="w">BCM2048_RDS_BLOCK_C</span><span class="c">)</span>
		<span class="c">return</span> <span class="w">1</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">bcm2048_parse_ps_match_d</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="c">,</span>
					<span class="c">int</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">cr</span><span class="pc">c</span><span class="c">;</span>

	<span class="w">cr</span><span class="c">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="c">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="pc">)</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="c">if</span> <span class="pc">((</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="c">i</span><span class="w">] </span><span class="pc">&amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="c">) ==</span>
		<span class="w">BCM2048_RDS_BLOCK_D</span><span class="pc">)</span>
		<span class="w">bcm2048_parse_rds_ps_block</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex,</span> <span class="w">cr</span><span class="pc">c</span><span class="c">);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">int</span> <span class="w">bcm2048_parse_ps_match_b</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">cr</span><span class="c">c</span><span class="pc">,</span> <span class="w">i</span><span class="pc">nd</span><span class="c">ex</span><span class="pc">,</span> <span class="w">ps_id</span><span class="pc">,</span> <span class="w">ps_group;</span>

	<span class="w">cr</span><span class="pc">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="c">c</span> <span class="c">==</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="c">i</span><span class="w">] </span><span class="pc">&amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="c">) ==</span>
		<span class="w">BCM2048_RDS_BLOCK_B</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">p</span><span class="pc">s_i</span><span class="c">d</span> <span class="pc">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rd</span><span class="c">s_info.radio_text</span><span class="pc">[</span><span class="c">i</span><span class="w">+</span><span class="c">1</span><span class="w">] </span><span class="pc">&amp;</span>
			<span class="pc">B</span><span class="c">CM2048_RDS_BLOCK_MASK</span><span class="pc">;</span>
		<span class="w">ps_group</span> <span class="pc">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">radio_text[i</span><span class="w">+</span><span class="c">1</span><span class="w">]</span><span class="pc"> &amp;</span>
			<span class="w">BCM2048_RDS_GROUP_AB_MASK</span><span class="c">;</span>

		
		<span class="c">if</span> <span class="c">(</span><span class="pc">p</span><span class="c">s_group</span> <span class="w">!</span><span class="c">=</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="w">rds_ps_group)</span><span class="c"> {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="pc">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_NONE</span><span class="c">) {</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">r</span><span class="c">ds_info.</span><span class="w">rds_ps_group_cnt</span><span class="pc">+</span><span class="c">+;</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.rds_ps_group_cnt</span> <span class="w">&gt;</span> <span class="w">2</span><span class="c">) {</span>
					<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">r</span><span class="pc">ds_i</span><span class="c">nfo.</span><span class="pc">rds_ps_group</span> <span class="c">=</span> <span class="w">p</span><span class="c">s_group</span><span class="pc">;</span>
					<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.</span><span class="pc">rds_ps_group_</span><span class="c">cnt</span>	<span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
					<span class="w">dev</span><span class="pc">_e</span><span class="c">rr(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">c</span><span class="pc">l</span><span class="c">ient-&gt;dev</span><span class="pc">,</span>
						<span class="pc">"</span><span class="w">RDS</span> <span class="w">PS</span> <span class="w">Group</span> <span class="w">chan</span><span class="pc">ge</span><span class="w">!</span><span class="c">\n");</span>
				<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
					<span class="pc">r</span><span class="c">eturn</span> <span class="w">-</span><span class="pc">EIO</span><span class="c">;</span>
				<span class="c">}</span>
			<span class="pc">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.rds_ps_group_cnt</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="c">}</span>
		<span class="pc">}</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">ps_id</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_PS</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">ind</span><span class="c">ex</span> <span class="c">=</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">r</span><span class="c">ds_info.</span><span class="w">radio_text</span><span class="pc">[i</span><span class="w">+</span><span class="pc">2</span><span class="w">] &amp;</span>
				<span class="w">BCM2048_RDS_PS_INDEX</span><span class="c">;</span>
			<span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="w">&lt;</span><span class="pc">&lt;</span><span class="c">=</span> <span class="c">1;</span>
			<span class="pc">r</span><span class="c">eturn</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">-</span><span class="pc">EIO</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">bcm2048_parse_rds_ps</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i</span><span class="pc">,</span> <span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">cr</span><span class="pc">c,</span> <span class="w">match_b</span> <span class="w">=</span> <span class="c">0,</span> <span class="w">match_c</span> <span class="pc">=</span> <span class="c">0,</span> <span class="w">match_d</span> <span class="c">=</span> <span class="c">0</span><span class="pc">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">fifo_size</span><span class="c">;</span> <span class="c">i</span> <span class="pc">+=</span> <span class="w">BCM2048_RDS_FIFO_DUPLE_SIZE)</span><span class="c"> {</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">m</span><span class="pc">atch_b</span><span class="w">)</span><span class="c"> {</span>
			<span class="w">m</span><span class="pc">atch_b</span> <span class="c">=</span> <span class="c">0;</span>
			<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">=</span> <span class="w">bcm2048_parse_ps_match_b</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="pc">i)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="pc">&gt;</span><span class="c">=</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">&lt;</span><span class="pc"> </span><span class="c">(</span><span class="w">BCM2048_MAX_RDS_PS</span> <span class="w">-</span> <span class="c">1))</span>
				<span class="w">match_c</span> <span class="c">=</span> <span class="c">1;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(match_c</span><span class="w">)</span><span class="c"> {</span>
			<span class="w">m</span><span class="pc">atch_c</span> <span class="pc">=</span> <span class="c">0;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bcm2048_parse_ps_match_c</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">i</span><span class="c">,</span> <span class="w">i</span><span class="c">ndex</span><span class="w">))</span>
				<span class="w">match_d</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(match_d</span><span class="w">)</span><span class="c"> {</span>
			<span class="pc">match_d</span> <span class="pc">=</span> <span class="c">0;</span>
			<span class="w">bcm2048_parse_ps_match_d</span><span class="pc">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="pc">i</span><span class="c">,</span> <span class="w">i</span><span class="c">ndex</span><span class="pc">)</span><span class="c">;</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text[</span><span class="c">i</span><span class="w">] </span><span class="pc">&amp;</span> <span class="w">BCM2048_RDS_BLOCK_MASK</span><span class="pc">)</span>
			<span class="w">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_BLOCK_A</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">cr</span><span class="pc">c</span> <span class="c">=</span> <span class="w">bcm2048_rds_block_crc</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">,</span> <span class="w">i</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">cr</span><span class="pc">c</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="c">)</span>
				<span class="pc">c</span><span class="c">ontinue;</span>
			
			<span class="c">if</span> <span class="w">((</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">r</span><span class="pc">d</span><span class="c">s_info</span><span class="pc">.r</span><span class="c">adio_text</span><span class="w">[</span><span class="c">i</span><span class="w">+</span><span class="c">1</span><span class="w">] </span><span class="pc">&lt;</span><span class="c">&lt;</span> <span class="c">8</span><span class="w">) </span><span class="pc">+</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.</span><span class="c">radio_text[i</span><span class="pc">+2</span><span class="w">]) ==</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rd</span><span class="c">s_info</span><span class="pc">.</span><span class="w">rds_pi)</span>
					<span class="w">match_b</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>
<span class="w">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">bcm2048_rds_fifo_receive</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="c">rr;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_recv_duples</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_RDS_DATA</span><span class="pc">,</span>
				<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">r</span><span class="c">ds_info</span><span class="pc">.</span><span class="w">radio_text</span><span class="pc">,</span> <span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">fifo_size</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="pc">!</span><span class="c">=</span> <span class="w">2</span><span class="c">) {</span>
		<span class="c">dev_err(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="pc">l</span><span class="c">ient-&gt;dev</span><span class="pc">, </span><span class="c">"</span><span class="w">RDS</span> <span class="w">Read</span> <span class="w">problem</span><span class="pc">\</span><span class="c">n");</span>
		<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;mutex);</span>
		<span class="c">return</span><span class="w">;</span>
	<span class="c">}</span>

	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info.</span><span class="w">text_len</span> <span class="c">=</span> <span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">f</span><span class="c">ifo_size</span><span class="pc">;</span>

	<span class="w">bcm2048_parse_rds_pi</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">bcm2048_parse_rds_rt</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">bcm2048_parse_rds_ps</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;mutex);</span>

	<span class="w">wake_up_interruptible</span><span class="c">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">read_queue</span><span class="c">);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_get_rds_data</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="c">dev</span><span class="pc">,</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">d</span><span class="c">ata)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0</span><span class="w">,</span> <span class="w">i</span><span class="pc">,</span> <span class="w">p</span> <span class="pc">=</span> <span class="pc">0;</span>
	<span class="w">c</span><span class="pc">ha</span><span class="c">r</span> <span class="c">*</span><span class="w">data_buffer</span><span class="pc">;</span>

	<span class="w">m</span><span class="c">utex_lock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">text_len</span><span class="c">) {</span>
		<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-EINVAL;</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>
	<span class="c">}</span>

	<span class="w">d</span><span class="pc">a</span><span class="c">ta_buffer</span> <span class="c">=</span> <span class="w">kcalloc</span><span class="c">(</span><span class="w">BCM2048_MAX_RDS_RADIO_TEXT</span><span class="pc">,</span> <span class="w">5</span><span class="pc">,</span> <span class="pc">G</span><span class="c">FP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!</span><span class="pc">d</span><span class="c">ata_buffer) {</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>
	<span class="c">}</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">text_len</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">p</span> <span class="pc">+</span><span class="c">=</span> <span class="c">sprintf(</span><span class="w">d</span><span class="c">ata_buffer+</span><span class="w">p,</span><span class="pc"> "%x</span> <span class="c">",</span>
			<span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">r</span><span class="c">ds_info</span><span class="pc">.</span><span class="w">radio_text</span><span class="c">[i]);</span>
	<span class="c">}</span>

	<span class="w">m</span><span class="pc">e</span><span class="c">mcpy(</span><span class="w">d</span><span class="pc">ata,</span> <span class="c">data_buffer</span><span class="pc">,</span> <span class="w">p</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">k</span><span class="c">free(data_buffer);</span>

<span class="w">un</span><span class="pc">l</span><span class="c">ock:</span>
	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>
	<span class="c">return</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_init</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_set_power_state</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">BCM2048_POWER_ON</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">e</span><span class="pc">x</span><span class="c">it;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_audio_route</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_AUDIO_ROUTE_DAC</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">e</span><span class="pc">x</span><span class="c">it;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_dac_output</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">BCM2048_DAC_OUTPUT_LEFT</span> <span class="w">|</span>
		<span class="w">BCM2048_DAC_OUTPUT_RIGHT</span><span class="pc">)</span><span class="c">;</span>

<span class="w">e</span><span class="pc">x</span><span class="c">it:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_deinit</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err</span><span class="pc">;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_audio_route</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">ex</span><span class="c">it;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_dac_output</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">e</span><span class="pc">x</span><span class="c">it;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_power_state</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">,</span> <span class="w">BCM2048_POWER_OFF</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">e</span><span class="pc">x</span><span class="c">it;</span>

<span class="w">e</span><span class="pc">x</span><span class="c">it:</span>
	<span class="c">return</span> <span class="c">err;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_probe</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">err;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_s</span><span class="c">et_power_state(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">BCM2048_POWER_ON</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">u</span><span class="c">nlock;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_checkrev</span><span class="c">(</span><span class="w">bd</span><span class="c">ev);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_mute</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">BCM2048_DEFAULT_MUTE</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="pc">u</span><span class="c">nlock;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_region</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">,</span> <span class="w">BCM2048_DEFAULT_REGION</span><span class="c">);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_fm_search_rssi_threshold</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span>
					<span class="w">BCM2048_DEFAULT_RSSI_THRESHOLD</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_fm_automatic_stereo_mono</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_ITEM_ENABLED</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_get_rds_wline</span><span class="c">(</span><span class="w">bd</span><span class="c">ev);</span>
	<span class="c">if</span> <span class="c">(err</span> <span class="c">&lt;</span> <span class="w">BCM2048_DEFAULT_RDS_WLINE</span><span class="pc">)</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_set_rds_wline</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">B</span><span class="pc">CM2048_D</span><span class="c">EFAULT_RDS_WLINE</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(err</span> <span class="pc">&lt;</span> <span class="c">0)</span>
		<span class="c">goto</span> <span class="w">u</span><span class="c">nlock;</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_set_power_state</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">BCM2048_POWER_OFF</span><span class="c">);</span>

	<span class="w">init_waitqueue_head</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">read_queue</span><span class="c">);</span>
	<span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">rds_data_available</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rd_index</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">users</span> <span class="c">=</span> <span class="c">0;</span>

<span class="w">un</span><span class="pc">l</span><span class="c">ock:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">bcm2048_work</span><span class="c">(struct</span> <span class="pc">w</span><span class="c">ork_struct</span> <span class="c">*work)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">de</span><span class="c">v</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">8</span> <span class="w">flag_lsb</span><span class="pc">,</span> <span class="w">flag_msb</span><span class="pc">,</span> <span class="w">f</span><span class="c">lags</span><span class="w">;</span>

	<span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="pc">=</span> <span class="w">c</span><span class="c">ontainer_of(work,</span> <span class="c">struct</span> <span class="pc">b</span><span class="c">cm2048_device,</span> <span class="w">w</span><span class="c">ork);</span>
	<span class="w">bcm2048_recv_command</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">BCM2048_I2C_FM_RDS_FLAG0</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">flag_l</span><span class="c">sb);</span>
	<span class="w">b</span><span class="c">cm2048_recv_command(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">BCM2048_I2C_FM_RDS_FLAG1</span><span class="pc">, </span><span class="c">&amp;</span><span class="pc">flag_m</span><span class="c">sb);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">f</span><span class="pc">lag_l</span><span class="c">sb</span> <span class="w">&amp;</span><span class="pc"> </span><span class="c">(</span><span class="w">BCM2048_FM_FLAG_SEARCH_TUNE_FINISHED</span> <span class="c">|</span>
			<span class="w">BCM2048_FM_FLAG_SEARCH_TUNE_FAIL</span><span class="pc">)) </span><span class="c">{</span>

		<span class="c">if</span> <span class="c">(</span><span class="pc">flag_l</span><span class="c">sb</span> <span class="pc">&amp;</span> <span class="w">B</span><span class="pc">CM2048_FM_FLAG_SEARCH_TUNE_FA</span><span class="c">IL</span><span class="pc">)</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">scan_state</span> <span class="c">=</span> <span class="w">BCM2048_SCAN_FAIL</span><span class="pc">;</span>
		<span class="c">else</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;scan_state</span> <span class="c">=</span> <span class="w">BCM2048_SCAN_OK</span><span class="pc">;</span>

		<span class="w">com</span><span class="c">plete(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">compl</span><span class="c">);</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">f</span><span class="pc">lag_m</span><span class="c">sb</span> <span class="pc">&amp;</span> <span class="w">BCM2048_RDS_FLAG_FIFO_WLINE</span><span class="c">) {</span>
		<span class="w">bcm2048_rds_fifo_receive</span><span class="c">(</span><span class="pc">b</span><span class="c">dev</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_state</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">f</span><span class="pc">lags</span> <span class="pc">=</span>	<span class="w">B</span><span class="pc">CM2048_R</span><span class="c">DS_FLAG_FIFO_WLINE</span><span class="pc">;</span>
			<span class="w">bcm2048_send_command</span><span class="pc">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">,</span> <span class="w">BCM2048_I2C_FM_RDS_MASK1</span><span class="pc">,</span>
						<span class="w">f</span><span class="pc">lags</span><span class="c">);</span>
		<span class="pc">}</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_data_available</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>
		<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">rd_index</span> <span class="c">=</span> <span class="c">0;</span> 
	<span class="pc">}</span>
<span class="w">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="w">i</span><span class="pc">r</span><span class="c">qreturn_t</span> <span class="w">bcm2048_handler</span><span class="c">(</span><span class="pc">i</span><span class="c">nt</span> <span class="c">irq,</span> <span class="c">void</span> <span class="c">*</span><span class="w">de</span><span class="pc">v</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span> <span class="c">=</span> <span class="c">dev</span><span class="pc">;</span>

	<span class="w">de</span><span class="pc">v_d</span><span class="c">bg(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">cl</span><span class="pc">i</span><span class="c">ent-&gt;dev</span><span class="w">,</span><span class="pc"> "</span><span class="w">I</span><span class="pc">R</span><span class="c">Q</span> <span class="w">called,</span> <span class="w">queuing</span> <span class="w">wo</span><span class="pc">rk\</span><span class="c">n");</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">power_state</span><span class="pc">)</span>
		<span class="w">schedule_work</span><span class="pc">(&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">w</span><span class="c">ork);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">I</span><span class="c">RQ_HANDLED;</span>
<span class="c">}</span>


<span class="pc">#d</span><span class="c">efine</span> <span class="w">property_write</span><span class="c">(</span><span class="w">prop</span><span class="c">,</span> <span class="w">t</span><span class="pc">y</span><span class="c">pe</span><span class="pc">,</span> <span class="w">ma</span><span class="pc">sk,</span> <span class="w">che</span><span class="c">ck</span><span class="w">)	</span><span class="pc">			</span><span class="c">\</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">ss</span><span class="c">ize_t</span> <span class="w">bcm2048_</span><span class="pc">#</span><span class="c">#</span><span class="w">prop</span><span class="c">##</span><span class="w">_write</span><span class="c">(struct</span> <span class="c">device</span> <span class="pc">*</span><span class="c">dev</span><span class="w">,</span><span class="pc">	</span><span class="c">	\</span>
					<span class="c">struct</span> <span class="c">device_attribute</span> <span class="c">*attr</span><span class="pc">,	\</span>
					<span class="pc">co</span><span class="c">nst</span> <span class="c">char</span> <span class="c">*</span><span class="pc">b</span><span class="c">uf</span><span class="w">,</span><span class="pc">	</span><span class="c">	\</span>
					<span class="c">size_t</span> <span class="c">count</span><span class="w">)</span><span class="pc">		</span><span class="c">	\</span>
<span class="w">{									\</span>
	<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="pc">d</span><span class="c">ev_get_drvdata(dev</span><span class="w">);		\</span>
	<span class="w">t</span><span class="c">ype</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue</span><span class="w">;							\</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">e</span><span class="pc">rr</span><span class="w">;</span><span class="pc">	</span><span class="c">						\</span>
									<span class="w">\</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(!</span><span class="w">bd</span><span class="c">ev</span><span class="w">)							\</span>
		<span class="c">return</span> <span class="pc">-ENOD</span><span class="c">EV</span><span class="w">;						\</span>
									<span class="pc">\</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">sscanf</span><span class="c">(</span><span class="w">b</span><span class="pc">u</span><span class="c">f,</span> <span class="w">ma</span><span class="pc">s</span><span class="c">k</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;value</span><span class="pc">) </span><span class="c">!=</span> <span class="pc">1</span><span class="w">)	</span><span class="pc">			\</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL</span><span class="pc">;	</span><span class="c">					\</span>
									<span class="w">\</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">che</span><span class="c">ck</span><span class="w">)</span><span class="pc">	</span><span class="c">						\</span>
		<span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="pc">-</span><span class="w">EDOM;</span><span class="pc">	</span><span class="c">					\</span>
									<span class="w">\</span>
	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">bcm2048_set_#</span><span class="c">#</span><span class="w">pr</span><span class="pc">op</span><span class="w">(</span><span class="pc">b</span><span class="c">dev,</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="w">);				\</span>
									<span class="w">\</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="w">e</span><span class="c">rr</span> <span class="w">&lt;</span> <span class="c">0</span> <span class="pc">?</span> <span class="w">e</span><span class="c">rr</span> <span class="c">:</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="w">;					\</span>
<span class="c">}</span>

<span class="w">#</span><span class="c">define</span> <span class="w">property_read</span><span class="c">(</span><span class="w">pr</span><span class="c">op,</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span><span class="pc">,</span> <span class="w">m</span><span class="pc">as</span><span class="c">k</span><span class="pc">)				</span><span class="c">	\</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="c">ssize_t</span> <span class="w">bcm2048_</span><span class="c">##</span><span class="w">p</span><span class="c">rop##</span><span class="w">_read</span><span class="pc">(</span><span class="c">struct</span> <span class="pc">device</span> <span class="c">*dev</span><span class="pc">,	</span><span class="c">	\</span>
					<span class="c">struct</span> <span class="c">device_attribute</span> <span class="c">*attr,	\</span>
					<span class="c">char</span> <span class="c">*buf</span><span class="w">)</span><span class="pc">			\</span>
<span class="w">{									\</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev</span><span class="w">);		\</span>
	<span class="w">i</span><span class="c">nt</span> <span class="w">v</span><span class="c">alue</span><span class="w">;							\</span>
									<span class="w">\</span>
	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="w">)							\</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-EN</span><span class="c">ODEV</span><span class="w">;						\</span>
									<span class="pc">\</span>
	<span class="w">v</span><span class="pc">a</span><span class="c">lue</span> <span class="c">=</span> <span class="w">bcm2048_get_</span><span class="pc">#</span><span class="c">#</span><span class="w">pr</span><span class="c">op</span><span class="w">(b</span><span class="pc">d</span><span class="c">ev</span><span class="w">);				\</span>
									<span class="pc">\</span>
	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">v</span><span class="c">alue</span> <span class="w">&gt;</span><span class="c">=</span> <span class="c">0</span><span class="w">)	</span><span class="c">						\</span>
		<span class="c">value</span> <span class="w">=</span> <span class="pc">s</span><span class="c">printf(buf</span><span class="pc">,</span> <span class="w">ma</span><span class="pc">s</span><span class="c">k</span> <span class="w">"</span><span class="pc">\</span><span class="c">n",</span> <span class="c">value</span><span class="w">);			\</span>
									<span class="w">\</span>
	<span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">v</span><span class="c">alue</span><span class="w">;							\</span>
<span class="c">}</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">property_signed_read</span><span class="c">(</span><span class="w">pr</span><span class="pc">op,</span> <span class="w">s</span><span class="c">ize</span><span class="pc">,</span> <span class="w">m</span><span class="c">ask</span><span class="w">)	</span><span class="pc">			\</span>
<span class="w">s</span><span class="c">tatic</span> <span class="c">ssize_t</span> <span class="w">bcm2048_</span><span class="c">##</span><span class="w">p</span><span class="pc">rop</span><span class="c">##</span><span class="w">_read</span><span class="pc">(</span><span class="c">struct</span> <span class="pc">device</span> <span class="c">*dev</span><span class="pc">,	</span><span class="c">	\</span>
					<span class="c">struct</span> <span class="c">device_attribute</span> <span class="c">*attr</span><span class="pc">,	\</span>
					<span class="c">char</span> <span class="c">*buf</span><span class="pc">)			\</span>
<span class="w">{									\</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev</span><span class="w">);		\</span>
	<span class="w">si</span><span class="pc">ze</span> <span class="w">v</span><span class="pc">a</span><span class="c">lue</span><span class="w">;							\</span>
									<span class="pc">\</span>
	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="w">)							\</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-ENOD</span><span class="c">EV</span><span class="w">;						\</span>
									<span class="pc">\</span>
	<span class="w">v</span><span class="pc">a</span><span class="c">lue</span> <span class="c">=</span> <span class="w">bcm2048_get_</span><span class="pc">#</span><span class="c">#</span><span class="w">pr</span><span class="pc">o</span><span class="c">p</span><span class="w">(b</span><span class="pc">d</span><span class="c">ev</span><span class="w">);				\</span>
									<span class="pc">\</span>
	<span class="w">v</span><span class="pc">a</span><span class="c">lue</span> <span class="w">=</span> <span class="pc">s</span><span class="c">printf(buf</span><span class="pc">,</span> <span class="w">ma</span><span class="pc">sk</span> <span class="w">"\</span><span class="c">n",</span> <span class="pc">v</span><span class="c">alue</span><span class="w">);</span><span class="pc">		</span><span class="c">		\</span>
									<span class="c">\</span>
	<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="w">v</span><span class="c">alue</span><span class="w">;</span><span class="pc">	</span><span class="c">						\</span>
<span class="w">}</span>

<span class="pc">#</span><span class="c">define</span> <span class="w">DEFINE_SYSFS_PROPERTY</span><span class="c">(</span><span class="w">pr</span><span class="pc">o</span><span class="c">p,</span> <span class="w">si</span><span class="pc">g</span><span class="c">nal</span><span class="w">,</span> <span class="w">s</span><span class="pc">ize,</span> <span class="w">ma</span><span class="pc">s</span><span class="c">k</span><span class="pc">,</span> <span class="w">che</span><span class="c">ck</span><span class="w">)</span><span class="pc">		</span><span class="c">\</span>
<span class="w">property_write</span><span class="c">(</span><span class="w">pr</span><span class="pc">o</span><span class="c">p,</span> <span class="w">sig</span><span class="pc">n</span><span class="c">al</span> <span class="w">si</span><span class="c">ze,</span> <span class="w">m</span><span class="pc">as</span><span class="c">k</span><span class="pc">,</span> <span class="w">ch</span><span class="pc">e</span><span class="c">ck</span><span class="w">)	</span><span class="pc">			</span><span class="c">\</span>
<span class="w">property_read</span><span class="c">(</span><span class="w">prop</span><span class="c">,</span> <span class="w">s</span><span class="pc">ize</span><span class="c">,</span> <span class="w">m</span><span class="pc">as</span><span class="c">k</span><span class="w">)</span>

<span class="w">#</span><span class="c">define</span> <span class="w">property_str_read</span><span class="c">(</span><span class="w">pr</span><span class="pc">op</span><span class="c">,</span> <span class="w">s</span><span class="c">ize</span><span class="w">)</span><span class="pc">				</span><span class="c">	\</span>
<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">s</span><span class="c">size_t</span> <span class="w">bcm2048_</span><span class="pc">#</span><span class="c">#</span><span class="w">prop</span><span class="c">##</span><span class="w">_read</span><span class="c">(</span><span class="w">s</span><span class="c">truct</span> <span class="pc">device</span> <span class="c">*dev</span><span class="pc">,	</span><span class="c">	\</span>
					<span class="c">struct</span> <span class="c">device_attribute</span> <span class="c">*attr,	\</span>
					<span class="c">char</span> <span class="c">*buf</span><span class="w">)	</span><span class="pc">		\</span>
<span class="w">{									\</span>
	<span class="pc">str</span><span class="c">uct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="c">dev_get_drvdata(dev</span><span class="w">);		\</span>
	<span class="w">i</span><span class="c">nt</span> <span class="w">c</span><span class="pc">o</span><span class="c">unt</span><span class="w">;							\</span>
	<span class="w">u</span><span class="pc">8</span> <span class="pc">*</span><span class="w">o</span><span class="pc">u</span><span class="c">t</span><span class="w">;</span><span class="pc">	</span><span class="c">						\</span>
									<span class="w">\</span>
	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="w">)							\</span>
		<span class="c">return</span> <span class="c">-ENODEV</span><span class="w">;						\</span>
									<span class="pc">\</span>
	<span class="w">ou</span><span class="c">t</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(</span><span class="w">s</span><span class="pc">ize</span> <span class="w">+</span> <span class="w">1</span><span class="pc">,</span> <span class="c">GFP_KERNEL</span><span class="w">);				\</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">o</span><span class="pc">u</span><span class="c">t</span><span class="w">)	</span><span class="pc">					</span><span class="c">	\</span>
		<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="c">-ENOMEM</span><span class="w">;</span><span class="pc">	</span><span class="c">					\</span>
									<span class="c">\</span>
	<span class="w">bcm2048_get_#</span><span class="c">#</span><span class="w">pr</span><span class="pc">op</span><span class="w">(bd</span><span class="c">ev,</span> <span class="w">o</span><span class="pc">u</span><span class="c">t</span><span class="w">);					\</span>
	<span class="w">co</span><span class="pc">u</span><span class="c">nt</span> <span class="w">=</span> <span class="pc">sp</span><span class="c">rintf(</span><span class="pc">b</span><span class="c">uf</span><span class="pc">, "%</span><span class="c">s\n",</span> <span class="w">ou</span><span class="c">t</span><span class="w">);</span><span class="pc">				\</span>
									<span class="c">\</span>
	<span class="w">k</span><span class="c">free(</span><span class="w">ou</span><span class="c">t</span><span class="w">);							\</span>
									<span class="pc">\</span>
	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">c</span><span class="pc">ou</span><span class="c">nt</span><span class="w">;							\</span>
<span class="pc">}</span>

<span class="w">DEFINE_SYSFS_PROPERTY</span><span class="c">(</span><span class="w">power_state</span><span class="c">,</span> <span class="w">u</span><span class="pc">n</span><span class="c">signed</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> "</span><span class="c">%</span><span class="w">u</span><span class="pc">"</span><span class="c">,</span> <span class="w">0</span><span class="pc">)</span>
<span class="w">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">mute</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> "%u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">audio_route</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="c">DEFINE_SYSFS_PROPERTY(</span><span class="w">dac_output</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>

<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_hi_lo_injection</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_frequency</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_af_frequency</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_deemphasis</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_rds_mask</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_best_tune_mode</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_search_rssi_threshold</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_search_mode_direction</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">fm_search_tune_mode</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="w">&gt;</span> <span class="w">3</span><span class="c">)</span>

<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">rds</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> "</span><span class="c">%</span><span class="w">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="w">D</span><span class="c">EFINE_SYSFS_PROPERTY</span><span class="pc">(</span><span class="w">rds_b_block_mask</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> "</span><span class="c">%</span><span class="w">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">rds_b_block_match</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="w">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">rds_pi_mask</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">rds_pi_match</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="pc">D</span><span class="c">EFINE_SYSFS_PROPERTY(</span><span class="w">rds_wline</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="c">nt</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">u</span><span class="c">",</span> <span class="w">0</span><span class="pc">)</span>
<span class="w">property_read</span><span class="c">(</span><span class="w">rds_pi</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span> <span class="c">int</span><span class="w">, </span><span class="pc">"</span><span class="c">%</span><span class="w">x")</span>
<span class="w">property_str_read</span><span class="c">(</span><span class="w">rds_rt, </span><span class="pc">(</span><span class="w">BCM2048_MAX_RDS_RT</span> <span class="w">+</span> <span class="w">1))</span>
<span class="w">p</span><span class="c">roperty_str_read(</span><span class="w">rds_ps,</span><span class="pc"> (</span><span class="w">BCM2048_MAX_RDS_PS</span> <span class="pc">+</span> <span class="c">1</span><span class="w">))</span>

<span class="w">p</span><span class="pc">roperty_r</span><span class="c">ead(</span><span class="w">fm_rds_flags</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">, </span><span class="pc">"%u</span><span class="w">")</span>
<span class="w">p</span><span class="c">roperty_str_read</span><span class="pc">(</span><span class="w">rds_data</span><span class="c">,</span> <span class="w">BCM2048_MAX_RDS_RADIO_TEXT*5</span><span class="pc">)</span>

<span class="w">p</span><span class="c">roperty_read(</span><span class="w">region_bottom_frequency</span><span class="pc">,</span> <span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">, "</span><span class="pc">%</span><span class="w">u")</span>
<span class="w">p</span><span class="pc">roperty_r</span><span class="c">ead(</span><span class="w">region_top_frequency</span><span class="c">,</span> <span class="w">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span><span class="w">, </span><span class="pc">"%</span><span class="w">u")</span>
<span class="w">property_signed_read</span><span class="c">(</span><span class="w">fm_carrier_error</span><span class="c">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span><span class="w">,</span><span class="pc"> </span><span class="c">"%</span><span class="pc">d</span><span class="w">")</span>
<span class="w">p</span><span class="pc">roperty_si</span><span class="c">gned_read(</span><span class="w">fm_rssi</span><span class="c">,</span> <span class="w">i</span><span class="c">nt, "%</span><span class="pc">d</span><span class="w">")</span>
<span class="w">DEFINE_SYSFS_PROPERTY</span><span class="c">(</span><span class="w">regi</span><span class="pc">on</span><span class="c">,</span> <span class="pc">u</span><span class="c">nsigned</span><span class="w">,</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span><span class="w">, </span><span class="pc">"</span><span class="c">%</span><span class="w">u</span><span class="c">",</span> <span class="w">0)</span>

<span class="w">s</span><span class="c">tatic</span> <span class="pc">st</span><span class="c">ruct</span> <span class="w">d</span><span class="c">evice_attribute</span> <span class="w">at</span><span class="pc">trs</span><span class="c">[] = {</span>
	<span class="w">__ATTR</span><span class="pc">(</span><span class="w">power_state</span><span class="c">,</span> <span class="pc">S</span><span class="c">_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_power_state_read</span><span class="c">,</span>
		<span class="w">bcm2048_power_state_write</span><span class="pc">),</span>
	<span class="w">_</span><span class="c">_ATTR(</span><span class="w">mute</span><span class="c">,</span> <span class="pc">S</span><span class="c">_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR</span><span class="pc">,</span> <span class="w">bcm2048_mute_read</span><span class="c">,</span>
		<span class="w">bcm2048_mute_write</span><span class="pc">),</span>
	<span class="pc">_</span><span class="c">_ATTR(</span><span class="w">audio_route</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_audio_route_read</span><span class="c">,</span>
		<span class="w">bcm2048_audio_route_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="pc">_</span><span class="c">_ATTR(</span><span class="w">dac_output</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_dac_output_read</span><span class="c">,</span>
		<span class="w">bcm2048_dac_output_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_hi_lo_injection</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_fm_hi_lo_injection_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_hi_lo_injection_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_frequency</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_fm_frequency_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_frequency_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_af_frequency</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_fm_af_frequency_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_af_frequency_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_deemphasis</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_fm_deemphasis_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_deemphasis_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_rds_mask</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_fm_rds_mask_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_rds_mask_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_best_tune_mode</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_fm_best_tune_mode_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_best_tune_mode_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_search_rssi_threshold</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_fm_search_rssi_threshold_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_search_rssi_threshold_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_search_mode_direction</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_fm_search_mode_direction_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_search_mode_direction_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_search_tune_mode</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_fm_search_tune_mode_read</span><span class="c">,</span>
		<span class="w">bcm2048_fm_search_tune_mode_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">rds</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_rds_read</span><span class="c">,</span>
		<span class="w">bcm2048_rds_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">rds_b_block_mask</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_rds_b_block_mask_read</span><span class="c">,</span>
		<span class="w">bcm2048_rds_b_block_mask_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">rds_b_block_match</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span>
		<span class="w">bcm2048_rds_b_block_match_read</span><span class="c">,</span>
		<span class="w">bcm2048_rds_b_block_match_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">rds_pi_mask</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_rds_pi_mask_read</span><span class="c">,</span>
		<span class="w">bcm2048_rds_pi_mask_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">rds_pi_match</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_rds_pi_match_read</span><span class="c">,</span>
		<span class="w">bcm2048_rds_pi_match_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">rds_wline</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_rds_wline_read</span><span class="c">,</span>
		<span class="w">bcm2048_rds_wline_write</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">rds_pi</span><span class="c">,</span> <span class="c">S_IRUGO,</span> <span class="w">bcm2048_rds_pi_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">),</span>
	<span class="w">_</span><span class="c">_ATTR(</span><span class="w">rds_rt</span><span class="c">,</span> <span class="c">S_IRUGO,</span> <span class="w">bcm2048_rds_rt_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">,</span>
	<span class="w">_</span><span class="c">_ATTR(</span><span class="w">rds_ps</span><span class="c">,</span> <span class="c">S_IRUGO,</span> <span class="w">bcm2048_rds_ps_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_rds_flags</span><span class="c">,</span> <span class="c">S_IRUGO,</span> <span class="w">bcm2048_fm_rds_flags_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">region_bottom_frequency</span><span class="c">,</span> <span class="c">S_IRUGO,</span>
		<span class="w">bcm2048_region_bottom_frequency_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">region_top_frequency</span><span class="c">,</span> <span class="c">S_IRUGO,</span>
		<span class="w">bcm2048_region_top_frequency_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_carrier_error</span><span class="c">,</span> <span class="c">S_IRUGO,</span>
		<span class="w">bcm2048_fm_carrier_error_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">fm_rssi</span><span class="c">,</span> <span class="c">S_IRUGO,</span>
		<span class="w">bcm2048_fm_rssi_read</span><span class="c">,</span> <span class="c">NULL</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">__ATTR(</span><span class="w">regi</span><span class="pc">on</span><span class="c">,</span> <span class="c">S_IRUGO</span> <span class="pc">|</span> <span class="c">S_IWUSR,</span> <span class="w">bcm2048_region_read</span><span class="c">,</span>
		<span class="w">bcm2048_region_write</span><span class="pc">),</span>
	<span class="w">_</span><span class="c">_ATTR(</span><span class="w">rds_data</span><span class="c">,</span> <span class="c">S_IRUGO,</span> <span class="w">bcm2048_rds_data_read</span><span class="c">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">)</span><span class="c">,</span>
<span class="c">};</span>

<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">bcm2048_sysfs_unregister_properties</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span>
						<span class="pc">i</span><span class="c">nt</span> <span class="w">si</span><span class="c">ze)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>

	<span class="c">for</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">s</span><span class="pc">ize</span><span class="c">;</span> <span class="c">i++)</span>
		<span class="w">device_remove_file</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="pc">l</span><span class="c">ient</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">at</span><span class="pc">trs</span><span class="c">[i]);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_sysfs_register_properties</span><span class="c">(struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">i</span><span class="pc">;</span>

	<span class="c">for</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="c">ARRAY_SIZE(</span><span class="w">at</span><span class="pc">trs)</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">device_create_file</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">cl</span><span class="pc">i</span><span class="c">ent</span><span class="pc">-</span><span class="c">&gt;dev</span><span class="w">,</span><span class="pc"> </span><span class="c">&amp;</span><span class="w">at</span><span class="pc">trs[</span><span class="c">i</span><span class="w">]) !=</span> <span class="c">0</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">d</span><span class="c">ev_err(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">c</span><span class="c">lient-&gt;dev</span><span class="pc">,</span>
					<span class="pc">"</span><span class="w">cou</span><span class="pc">l</span><span class="c">d</span> <span class="c">not</span> <span class="c">register</span> <span class="w">sysfs</span> <span class="w">e</span><span class="pc">nt</span><span class="c">ry</span><span class="pc">\</span><span class="c">n");</span>
			<span class="pc">e</span><span class="c">rr</span> <span class="c">= -</span><span class="w">EB</span><span class="c">USY;</span>
			<span class="w">bcm2048_sysfs_unregister_properties</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">,</span> <span class="w">i</span><span class="c">);</span>
			<span class="w">b</span><span class="c">reak;</span>
		<span class="pc">}</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">e</span><span class="c">rr;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_fops_open</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="w">video_drvdata</span><span class="c">(</span><span class="pc">f</span><span class="c">ile);</span>

	<span class="w">b</span><span class="c">dev-&gt;</span><span class="w">users+</span><span class="c">+;</span>
	<span class="w">b</span><span class="c">dev-&gt;</span><span class="w">rd_index</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_data_available</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_fops_release</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">b</span><span class="c">cm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="w">v</span><span class="pc">i</span><span class="c">deo_drvdata</span><span class="pc">(</span><span class="c">file);</span>

	<span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">u</span><span class="pc">s</span><span class="c">ers</span><span class="w">-</span><span class="pc">-</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="c">int</span> <span class="w">bcm2048_fops_poll</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file,</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">poll_table_struct</span> <span class="c">*</span><span class="w">pts</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span> <span class="c">=</span> <span class="w">v</span><span class="c">ideo_drvdata(file);</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">retv</span><span class="c">al</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">poll_wait</span><span class="c">(</span><span class="w">f</span><span class="c">ile</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">read_queue</span><span class="pc">,</span> <span class="w">p</span><span class="c">ts);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_data_available</span><span class="c">)</span>
		<span class="w">ret</span><span class="pc">v</span><span class="c">al</span> <span class="c">=</span> <span class="w">POLLIN</span> <span class="w">|</span> <span class="w">POLLRDNORM</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="w">s</span><span class="pc">s</span><span class="c">ize_t</span> <span class="w">bcm2048_fops_read</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file,</span> <span class="pc">c</span><span class="c">har</span> <span class="c">__user</span> <span class="c">*buf,</span>
	<span class="c">size_t</span> <span class="c">count,</span> <span class="c">loff_t</span> <span class="c">*ppos)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_drvdata</span><span class="c">(file);</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">i;</span>
	<span class="c">int</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al</span> <span class="c">=</span> <span class="c">0;</span>

	
	<span class="w">c</span><span class="pc">o</span><span class="c">unt</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="pc">c</span><span class="c">ount</span> <span class="w">/</span> <span class="w">3</span><span class="pc">) </span><span class="c">*</span> <span class="w">3</span><span class="c">;</span> 
	<span class="pc">if</span> <span class="c">(count</span> <span class="pc">&lt;</span> <span class="w">3</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="w">ENOBUFS</span><span class="c">;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="pc">(!</span><span class="w">bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rds_data_available</span><span class="pc">)</span><span class="c"> {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">fi</span><span class="pc">l</span><span class="c">e-&gt;</span><span class="w">f_flags</span> <span class="w">&amp;</span> <span class="w">O_NONBLOCK</span><span class="c">) {</span>
			<span class="w">r</span><span class="pc">etv</span><span class="c">al</span> <span class="pc">= </span><span class="c">-</span><span class="w">EWOULDBLOCK</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="pc">d</span><span class="c">one;</span>
		<span class="c">}</span>
		
		<span class="c">if</span> <span class="c">(</span><span class="w">wait_event_interruptible</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">read_queue</span><span class="c">,</span>
			<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">r</span><span class="pc">d</span><span class="c">s_data_available</span><span class="w">) </span><span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="w">re</span><span class="pc">tv</span><span class="c">al</span> <span class="c">= -</span><span class="w">EINTR</span><span class="c">;</span>
			<span class="c">goto</span> <span class="pc">d</span><span class="c">one;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">m</span><span class="pc">utex_l</span><span class="c">ock(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;mutex);</span>
	
	<span class="w">i</span> <span class="c">=</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">fifo_size</span> <span class="w">-</span> <span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="w">rd_index</span><span class="pc">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="c">ount</span> <span class="pc">&gt;</span> <span class="w">i</span><span class="pc">)</span>
		<span class="w">c</span><span class="pc">ou</span><span class="c">nt</span> <span class="w">=</span><span class="pc"> (</span><span class="w">i</span> <span class="w">/</span> <span class="w">3)</span><span class="pc"> *</span> <span class="w">3</span><span class="c">;</span>

	<span class="c">i</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(i</span> <span class="pc">&lt;</span> <span class="pc">c</span><span class="c">ount) {</span>
		<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="w">tmpbuf</span><span class="c">[</span><span class="pc">3</span><span class="c">];</span>

		<span class="w">t</span><span class="pc">mpb</span><span class="c">uf</span><span class="w">[</span><span class="c">i] =</span> <span class="w">bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rds_info</span><span class="pc">.</span><span class="w">radio_text</span><span class="pc">[</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rd_index</span><span class="pc">+i</span><span class="w">+2</span><span class="pc">]</span><span class="c">;</span>
		<span class="w">t</span><span class="c">mpbuf</span><span class="pc">[i+</span><span class="c">1] =</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">r</span><span class="c">ds_info</span><span class="pc">.r</span><span class="c">adio_text[</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">r</span><span class="c">d_index</span><span class="pc">+</span><span class="w">i</span><span class="c">+1</span><span class="pc">]</span><span class="c">;</span>
		<span class="w">t</span><span class="c">mpbuf</span><span class="pc">[</span><span class="c">i+</span><span class="w">2] </span><span class="pc">= (</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rds_info</span><span class="pc">.r</span><span class="c">adio_text</span><span class="pc">[</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">d_index</span> <span class="c">+</span> <span class="pc">i</span><span class="w">] &amp;</span> <span class="w">0xf</span><span class="pc">0</span><span class="w">)</span><span class="pc"> &gt;</span><span class="c">&gt;</span> <span class="w">4</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="pc">((</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">rds</span><span class="c">_info</span><span class="pc">.r</span><span class="c">adio_text</span><span class="pc">[</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">rd_</span><span class="c">index</span><span class="pc">+</span><span class="w">i] </span><span class="pc">&amp;</span>
			<span class="w">BCM2048_RDS_CRC_MASK) </span><span class="pc">=</span><span class="c">=</span> <span class="w">BCM2048_RDS_CRC_UNRECOVARABLE</span><span class="c">)</span>
			<span class="w">t</span><span class="c">mpbuf</span><span class="pc">[</span><span class="c">i</span><span class="pc">+2</span><span class="w">] </span><span class="pc">|</span><span class="c">=</span> <span class="w">0x8</span><span class="pc">0</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">cop</span><span class="c">y_to_user(buf</span><span class="w">+</span><span class="pc">i</span><span class="c">,</span> <span class="w">t</span><span class="c">mpbuf</span><span class="pc">,</span> <span class="w">3))</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">re</span><span class="pc">tv</span><span class="c">al</span> <span class="c">= -</span><span class="pc">EF</span><span class="c">AULT;</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>
		<span class="w">i</span> <span class="pc">+</span><span class="c">=</span> <span class="w">3</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rd_index</span> <span class="w">+</span><span class="pc">=</span> <span class="w">i</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;rd_index</span> <span class="pc">&gt;</span><span class="c">=</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">fifo_size</span><span class="pc">)</span>
		<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">rds_data_available</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">m</span><span class="c">utex_unlock(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">r</span><span class="pc">etv</span><span class="c">al</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">re</span><span class="pc">tv</span><span class="c">al</span> <span class="c">=</span> <span class="w">i</span><span class="c">;</span>

<span class="w">do</span><span class="pc">n</span><span class="c">e:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">etv</span><span class="c">al;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">v4l2_file_operations</span> <span class="w">bcm2048_fops</span> <span class="c">= {</span>
	<span class="c">.owner</span>		<span class="c">=</span> <span class="c">THIS_MODULE,</span>
	<span class="c">.</span><span class="w">unlocked_ioctl</span>	<span class="c">=</span> <span class="w">video_ioctl2</span><span class="c">,</span>
	
	<span class="c">.</span><span class="w">o</span><span class="pc">p</span><span class="c">en</span>		<span class="c">=</span> <span class="w">bcm2048_fops_open</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">rel</span><span class="c">ease</span>	<span class="c">=</span> <span class="w">bcm2048_fops_release</span><span class="c">,</span>
	<span class="c">.</span><span class="w">r</span><span class="pc">ea</span><span class="c">d</span>		<span class="c">=</span> <span class="w">bcm2048_fops_read</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">p</span><span class="c">oll</span>		<span class="c">=</span> <span class="w">bcm2048_fops_poll</span>
<span class="pc">}</span><span class="c">;</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">v4l2_queryctrl</span> <span class="w">bcm2048_v4l2_queryctrl</span><span class="pc">[</span><span class="c">] = {</span>
	<span class="pc">{</span>
		<span class="c">.</span><span class="w">i</span><span class="c">d</span>		<span class="c">=</span> <span class="w">V4L2_CID_AUDIO_VOLUME</span><span class="c">,</span>
		<span class="c">.</span><span class="w">f</span><span class="c">lags</span>		<span class="c">=</span> <span class="w">V4L2_CTRL_FLAG_DISABLED</span><span class="c">,</span>
	<span class="pc">},</span>
	<span class="c">{</span>
		<span class="c">.</span><span class="w">i</span><span class="c">d</span>		<span class="c">=</span> <span class="w">V4L2_CID_AUDIO_BALANCE</span><span class="c">,</span>
		<span class="c">.</span><span class="pc">f</span><span class="c">lags</span>		<span class="c">=</span> <span class="w">V</span><span class="pc">4L2_CT</span><span class="c">RL_FLAG_DISABLED,</span>
	<span class="pc">},</span>
	<span class="c">{</span>
		<span class="c">.</span><span class="w">i</span><span class="c">d</span>		<span class="c">=</span> <span class="w">V4L2_CID_AUDIO_BASS</span><span class="c">,</span>
		<span class="c">.</span><span class="pc">f</span><span class="c">lags</span>		<span class="c">=</span> <span class="w">V</span><span class="pc">4L2_CT</span><span class="c">RL_FLAG_DISABLED,</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="c">{</span>
		<span class="c">.</span><span class="w">i</span><span class="c">d</span>		<span class="c">=</span> <span class="w">V4L2_CID_AUDIO_TREBLE</span><span class="c">,</span>
		<span class="c">.</span><span class="pc">f</span><span class="c">lags</span>		<span class="c">=</span> <span class="c">V4L2_CTRL_FLAG_DISABLED,</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="c">{</span>
		<span class="c">.</span><span class="w">i</span><span class="c">d</span>		<span class="c">=</span> <span class="w">V4L2_CID_AUDIO_MUTE</span><span class="c">,</span>
		<span class="c">.</span><span class="w">t</span><span class="c">ype</span>		<span class="c">=</span> <span class="w">V4L2_CTRL_TYPE_BOOLEAN</span><span class="c">,</span>
		<span class="c">.</span><span class="pc">n</span><span class="c">ame</span>		<span class="c">= "</span><span class="w">Mute</span><span class="c">",</span>
		<span class="c">.</span><span class="w">minimum</span>	<span class="c">=</span> <span class="pc">0</span><span class="c">,</span>
		<span class="c">.</span><span class="w">maximum</span>	<span class="c">=</span> <span class="pc">1</span><span class="c">,</span>
		<span class="c">.</span><span class="w">s</span><span class="pc">t</span><span class="c">ep</span>		<span class="c">=</span> <span class="c">1,</span>
		<span class="c">.</span><span class="w">default_value</span>	<span class="c">=</span> <span class="c">1,</span>
	<span class="pc">},</span>
	<span class="pc">{</span>
		<span class="c">.</span><span class="pc">i</span><span class="c">d</span>		<span class="c">=</span> <span class="w">V4L2_CID_AUDIO_LOUDNESS</span><span class="c">,</span>
		<span class="c">.flags</span>		<span class="c">=</span> <span class="w">V4L2_CTRL_FLAG_DISABLED</span><span class="c">,</span>
	<span class="pc">},</span>
<span class="pc">}</span><span class="c">;</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_querycap</span><span class="c">(struct</span> <span class="w">f</span><span class="pc">i</span><span class="c">le</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p</span><span class="c">riv,</span>
		<span class="c">struct</span> <span class="w">v4l2_capability</span> <span class="c">*</span><span class="w">capability</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(</span><span class="w">f</span><span class="c">ile</span><span class="pc">))</span><span class="c">;</span>

	<span class="w">str</span><span class="pc">l</span><span class="c">cpy(</span><span class="pc">c</span><span class="c">apability-&gt;</span><span class="w">d</span><span class="c">river,</span> <span class="w">BCM2048_DRIVER_NAME</span><span class="pc">,</span>
		<span class="pc">s</span><span class="c">izeof(</span><span class="pc">c</span><span class="c">apability-&gt;</span><span class="pc">d</span><span class="c">river));</span>
	<span class="c">strlcpy(capability-&gt;</span><span class="w">c</span><span class="pc">ar</span><span class="c">d,</span> <span class="w">BCM2048_DRIVER_CARD</span><span class="c">,</span>
		<span class="c">sizeof(</span><span class="pc">c</span><span class="c">apability-&gt;</span><span class="w">c</span><span class="pc">ar</span><span class="c">d</span><span class="pc">)</span><span class="c">);</span>
	<span class="w">s</span><span class="pc">n</span><span class="c">printf(capability-&gt;</span><span class="w">bus_info</span><span class="c">,</span> <span class="w">3</span><span class="pc">2</span><span class="w">,</span><span class="pc"> "</span><span class="w">I2C:</span> <span class="pc">0</span><span class="c">x%</span><span class="w">X</span><span class="pc">"</span><span class="c">,</span> <span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">cli</span><span class="c">ent-&gt;</span><span class="w">a</span><span class="c">ddr</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">c</span><span class="c">apability-&gt;</span><span class="w">device_caps</span> <span class="c">=</span> <span class="w">V4L2_CAP_TUNER</span> <span class="pc">|</span> <span class="w">V4L2_CAP_RADIO</span> <span class="pc">|</span>
					<span class="w">V4L2_CAP_HW_FREQ_SEEK</span><span class="pc">;</span>
	<span class="c">capability-&gt;</span><span class="w">capabilities</span> <span class="c">=</span> <span class="pc">c</span><span class="c">apability-&gt;</span><span class="pc">d</span><span class="c">evice_caps</span> <span class="w">|</span>
		<span class="w">V4L2_CAP_DEVICE_CAPS</span><span class="c">;</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_g_input</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*</span><span class="pc">filp</span><span class="c">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p</span><span class="c">riv,</span>
		<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">*</span><span class="w">i</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">*</span><span class="pc">i</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_s_input</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*</span><span class="pc">filp</span><span class="c">,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p</span><span class="c">riv,</span>
					<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">i)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_queryctrl</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file,</span> <span class="c">void</span> <span class="c">*priv,</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">v4l2_queryctrl</span> <span class="c">*</span><span class="w">q</span><span class="pc">c</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i</span><span class="pc">;</span>

	<span class="c">for</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">A</span><span class="c">RRAY_SIZE(</span><span class="w">bcm2048_v4l2_queryctrl</span><span class="c">);</span> <span class="c">i++) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">q</span><span class="pc">c</span><span class="c">-&gt;</span><span class="w">i</span><span class="pc">d</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="w">q</span><span class="pc">c</span><span class="c">-&gt;</span><span class="pc">i</span><span class="c">d</span> <span class="pc">=</span><span class="c">=</span> <span class="w">b</span><span class="c">cm2048_v4l2_queryctrl</span><span class="pc">[</span><span class="c">i</span><span class="pc">].i</span><span class="c">d</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="pc">*</span><span class="w">qc</span> <span class="c">=</span> <span class="w">b</span><span class="c">cm2048_v4l2_queryctrl</span><span class="pc">[</span><span class="c">i</span><span class="pc">];</span>
			<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EINVAL;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_g_ctrl</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*priv,</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">v4l2_control</span> <span class="c">*</span><span class="w">ct</span><span class="pc">r</span><span class="c">l)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(</span><span class="w">f</span><span class="pc">i</span><span class="c">le));</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">ct</span><span class="pc">r</span><span class="c">l-&gt;</span><span class="pc">i</span><span class="c">d) {</span>
	<span class="c">case</span> <span class="w">V4L2_CID_AUDIO_MUTE</span><span class="c">:</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_get_mute</span><span class="c">(</span><span class="w">bd</span><span class="c">ev);</span>
		<span class="c">if</span> <span class="c">(err</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="c">0)</span>
			<span class="w">c</span><span class="pc">t</span><span class="c">rl</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span> <span class="c">=</span> <span class="c">err;</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_s_ctrl</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="pc">*p</span><span class="c">riv,</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">v4l2_control</span> <span class="c">*</span><span class="w">c</span><span class="pc">t</span><span class="c">rl)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(</span><span class="w">f</span><span class="pc">i</span><span class="c">le));</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="c">err</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>

	<span class="w">s</span><span class="pc">w</span><span class="c">itch</span> <span class="c">(</span><span class="w">ct</span><span class="pc">r</span><span class="c">l-&gt;</span><span class="pc">i</span><span class="c">d) {</span>
	<span class="c">case</span> <span class="w">V4L2_CID_AUDIO_MUTE</span><span class="c">:</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">t</span><span class="c">rl-&gt;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">power_state)</span><span class="pc"> </span><span class="c">{</span>
				<span class="w">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">bcm2048_set_mute</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">ct</span><span class="c">rl-&gt;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>
				<span class="w">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">bcm2048_deinit</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v);</span>
			<span class="pc">}</span>
		<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">pow</span><span class="c">er_state) {</span>
				<span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span> <span class="w">bcm2048_init</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">e</span><span class="pc">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="c">bcm2048_set_mute</span><span class="pc">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">c</span><span class="pc">t</span><span class="c">rl-&gt;</span><span class="w">v</span><span class="pc">alu</span><span class="c">e);</span>
			<span class="pc">}</span>
		<span class="w">}</span>
		<span class="w">b</span><span class="c">reak;</span>
	<span class="pc">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_g_audio</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="c">void</span> <span class="pc">*p</span><span class="c">riv,</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">v4l2_audio</span> <span class="c">*</span><span class="w">au</span><span class="c">dio)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">au</span><span class="c">dio-&gt;</span><span class="pc">i</span><span class="c">ndex</span> <span class="w">&gt;</span> <span class="pc">1</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">strncpy</span><span class="c">(</span><span class="w">au</span><span class="c">dio-&gt;</span><span class="pc">n</span><span class="c">ame</span><span class="pc">, </span><span class="c">"</span><span class="w">Radio</span><span class="pc">"</span><span class="c">,</span> <span class="w">3</span><span class="pc">2</span><span class="c">);</span>
	<span class="w">au</span><span class="c">dio-&gt;</span><span class="w">capability</span> <span class="c">=</span> <span class="w">V4L2_AUDCAP_STEREO</span><span class="pc">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_s_audio</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*priv,</span>
		<span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">v4l2_audio</span> <span class="c">*</span><span class="w">au</span><span class="c">dio)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">au</span><span class="c">dio-&gt;</span><span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="pc">!</span><span class="c">=</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="pc">-</span><span class="c">EINVAL;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_g_tuner</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="c">void</span> <span class="c">*priv,</span>
		<span class="c">struct</span> <span class="w">v4l2_tuner</span> <span class="c">*</span><span class="w">tuner</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(</span><span class="w">f</span><span class="pc">i</span><span class="c">le));</span>
	<span class="w">s8</span> <span class="w">f_error</span><span class="pc">;</span>
	<span class="w">s8</span> <span class="w">rssi</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">-</span><span class="c">ENODEV;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">t</span><span class="c">uner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">&gt;</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">strncpy</span><span class="c">(tuner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">n</span><span class="c">ame</span><span class="pc">, </span><span class="c">"</span><span class="w">FM</span> <span class="w">Receiver"</span><span class="pc">,</span> <span class="w">3</span><span class="pc">2)</span><span class="c">;</span>
	<span class="pc">t</span><span class="c">uner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="pc">y</span><span class="c">pe</span> <span class="c">=</span> <span class="w">V4L2_TUNER_RADIO</span><span class="c">;</span>
	<span class="c">tuner-&gt;</span><span class="w">rangelow</span> <span class="c">=</span>
		<span class="w">dev_to_v4l2</span><span class="pc">(</span><span class="w">bcm2048_get_region_bottom_frequency(b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">t</span><span class="c">uner-&gt;</span><span class="w">rangehigh</span> <span class="c">=</span>
		<span class="w">d</span><span class="c">ev_to_v4l2</span><span class="pc">(</span><span class="w">bcm2048_get_region_top_frequency</span><span class="pc">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">))</span><span class="c">;</span>
	<span class="pc">t</span><span class="c">uner-&gt;</span><span class="w">rxsubchans</span> <span class="c">=</span> <span class="w">V4L2_TUNER_SUB_STEREO</span><span class="pc">;</span>
	<span class="c">tuner-&gt;</span><span class="w">capability</span> <span class="c">=</span> <span class="w">V4L2_TUNER_CAP_STEREO</span> <span class="w">|</span> <span class="w">V4L2_TUNER_CAP_LOW</span><span class="c">;</span>
	<span class="c">tuner-&gt;</span><span class="w">audmode</span> <span class="c">=</span> <span class="w">V4L2_TUNER_MODE_STEREO</span><span class="pc">;</span>
	<span class="c">tuner-&gt;</span><span class="w">afc</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">power_state</span><span class="pc">)</span><span class="c"> {</span>
		
		<span class="w">f_error</span> <span class="pc">=</span> <span class="w">bcm2048_get_fm_carrier_error</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">f</span><span class="c">_error</span> <span class="pc">&lt;</span> <span class="w">BCM2048_FREQ_ERROR_FLOOR</span> <span class="pc">|</span><span class="c">|</span>
		    <span class="pc">f</span><span class="c">_error</span> <span class="c">&gt;</span> <span class="w">BCM2048_FREQ_ERROR_ROOF</span><span class="c">) {</span>
			<span class="pc">t</span><span class="c">uner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">si</span><span class="pc">g</span><span class="c">nal</span> <span class="c">=</span> <span class="w">0</span><span class="c">;</span>
		<span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
			
			<span class="w">rssi</span> <span class="c">=</span> <span class="w">bcm2048_get_fm_rssi</span><span class="c">(</span><span class="w">bd</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">ssi</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">BCM2048_RSSI_LEVEL_BASE</span><span class="c">) {</span>
				<span class="pc">t</span><span class="c">uner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">si</span><span class="pc">g</span><span class="c">nal</span> <span class="c">=</span> <span class="w">0xF</span><span class="pc">FFF</span><span class="c">;</span>
			<span class="pc">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">ssi</span> <span class="w">&gt;</span> <span class="w">BCM2048_RSSI_LEVEL_ROOF</span><span class="c">) {</span>
				<span class="pc">t</span><span class="c">uner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">si</span><span class="pc">g</span><span class="c">nal</span> <span class="pc">= </span><span class="c">(</span><span class="pc">r</span><span class="c">ssi</span> <span class="w">+</span>
						 <span class="w">BCM2048_RSSI_LEVEL_ROOF_NEG)</span>
						 <span class="w">*</span> <span class="w">BCM2048_SIGNAL_MULTIPLIER</span><span class="c">;</span>
			<span class="w">}</span> <span class="c">else</span> <span class="pc">{</span>
				<span class="pc">t</span><span class="c">uner-&gt;</span><span class="w">si</span><span class="pc">gn</span><span class="c">al</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="pc">}</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="pc">t</span><span class="c">uner-&gt;</span><span class="w">si</span><span class="pc">g</span><span class="c">nal</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_s_tuner</span><span class="c">(struct</span> <span class="w">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p</span><span class="c">riv,</span>
		<span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">v4l2_tuner</span> <span class="c">*</span><span class="pc">t</span><span class="c">uner)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(</span><span class="w">f</span><span class="pc">i</span><span class="c">le));</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-ENODEV;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(tuner</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span> <span class="w">&gt;</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_g_frequency</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p</span><span class="c">riv,</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">v4l2_frequency</span> <span class="c">*</span><span class="w">fr</span><span class="pc">e</span><span class="c">q)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(</span><span class="w">f</span><span class="pc">i</span><span class="c">le));</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">f</span><span class="pc">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="c">ev</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">power_state</span><span class="c">)</span>
		<span class="c">return</span> <span class="c">-ENODEV;</span>

	<span class="w">f</span><span class="pc">r</span><span class="c">eq</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">t</span><span class="c">ype</span> <span class="c">=</span> <span class="w">V4L2_TUNER_RADIO</span><span class="c">;</span>
	<span class="w">f</span> <span class="pc">=</span> <span class="w">bcm2048_get_fm_frequency</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="pc">f</span> <span class="pc">&lt;</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">f</span><span class="pc">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">f</span><span class="pc">r</span><span class="c">eq</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span> <span class="c">=</span> <span class="w">dev_to_v4l2</span><span class="pc">(</span><span class="c">f</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_s_frequency</span><span class="c">(struct</span> <span class="c">file</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">p</span><span class="c">riv,</span>
		<span class="w">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">v4l2_frequency</span> <span class="c">*</span><span class="w">fr</span><span class="pc">e</span><span class="c">q)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(</span><span class="w">f</span><span class="pc">i</span><span class="c">le));</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">f</span><span class="pc">r</span><span class="c">eq</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">t</span><span class="c">ype</span> <span class="c">!=</span> <span class="w">V4L2_TUNER_RADIO</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">power_state</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="w">bcm2048_set_fm_frequency</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span> <span class="w">v4l2_to_dev</span><span class="pc">(</span><span class="w">fr</span><span class="pc">eq</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">fr</span><span class="pc">equ</span><span class="c">ency</span><span class="w">)</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">bcm2048_set_fm_search_tune_mode</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="w">BCM2048_FM_PRE_SET_MODE</span><span class="c">);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">bcm2048_vidioc_s_hw_freq_seek</span><span class="c">(struct</span> <span class="pc">f</span><span class="c">ile</span> <span class="c">*file,</span> <span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p</span><span class="c">riv,</span>
					<span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">v4l2_hw_freq_seek</span> <span class="c">*</span><span class="w">seek</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="w">video_get_drvdata</span><span class="c">(</span><span class="w">video_devdata</span><span class="pc">(f</span><span class="c">ile));</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="pc">e</span><span class="c">rr</span><span class="pc">;</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">power_state</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">ODEV;</span>

	<span class="c">if</span> <span class="pc">((s</span><span class="c">eek-&gt;</span><span class="w">tuner</span> <span class="pc">!</span><span class="c">=</span> <span class="pc">0</span><span class="w">) </span><span class="pc">|</span><span class="c">| (</span><span class="pc">s</span><span class="c">eek-&gt;</span><span class="pc">ty</span><span class="c">pe</span> <span class="c">!=</span> <span class="w">V4L2_TUNER_RADIO</span><span class="pc">))</span>
		<span class="c">return</span> <span class="c">-EINVAL;</span>

	<span class="w">e</span><span class="pc">rr</span> <span class="c">=</span> <span class="w">bcm2048_set_fm_search_mode_direction</span><span class="c">(</span><span class="w">bd</span><span class="c">ev,</span> <span class="c">seek</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">seek_upward</span><span class="c">);</span>
	<span class="pc">e</span><span class="c">rr</span> <span class="pc">|</span><span class="c">=</span> <span class="w">bcm2048_set_fm_search_tune_mode</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev,</span>
			<span class="w">BCM2048_FM_AUTO_SEARCH_MODE</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">err;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">v4l2_ioctl_ops</span> <span class="w">bcm2048_ioctl_ops</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">vidioc_querycap</span>	<span class="c">=</span> <span class="w">bcm2048_vidioc_querycap</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_g_input</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_g_input</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_s_input</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_s_input</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_queryctrl</span>	<span class="c">=</span> <span class="w">bcm2048_vidioc_queryctrl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_g_ctrl</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_g_ctrl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_s_ctrl</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_s_ctrl</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_g_audio</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_g_audio</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_s_audio</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_s_audio</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_g_tuner</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_g_tuner</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_s_tuner</span>		<span class="c">=</span> <span class="w">bcm2048_vidioc_s_tuner</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_g_frequency</span>	<span class="c">=</span> <span class="w">bcm2048_vidioc_g_frequency</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_s_frequency</span>	<span class="c">=</span> <span class="w">bcm2048_vidioc_s_frequency</span><span class="c">,</span>
	<span class="c">.</span><span class="w">vidioc_s_hw_freq_seek</span>  <span class="c">=</span> <span class="w">bcm2048_vidioc_s_hw_freq_seek</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">video_device</span> <span class="w">bcm2048_viddev_template</span> <span class="c">= {</span>
	<span class="c">.</span><span class="w">fops</span>			<span class="pc">= </span><span class="c">&amp;</span><span class="w">bcm2048_fops</span><span class="c">,</span>
	<span class="c">.name</span>			<span class="pc">=</span> <span class="w">BCM2048_DRIVER_NAME</span><span class="c">,</span>
	<span class="c">.</span><span class="pc">r</span><span class="c">elease</span>		<span class="c">=</span> <span class="w">video_device_release_empty</span><span class="c">,</span>
	<span class="c">.</span><span class="w">ioctl_ops</span>		<span class="pc">= </span><span class="c">&amp;</span><span class="w">bcm2048_ioctl_ops</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">bcm2048_i2c_driver_probe</span><span class="c">(struct</span> <span class="w">i</span><span class="pc">2</span><span class="c">c_client</span> <span class="c">*client,</span>
					<span class="c">const</span> <span class="c">struct</span> <span class="w">i2c_device_id</span> <span class="c">*id)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">e</span><span class="c">rr;</span>

	<span class="w">bd</span><span class="pc">e</span><span class="c">v</span> <span class="c">=</span> <span class="pc">k</span><span class="c">zalloc(sizeof(*</span><span class="w">bd</span><span class="c">ev),</span> <span class="c">GFP_KERNEL);</span>
	<span class="c">if</span> <span class="c">(!</span><span class="w">bd</span><span class="c">ev) {</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">e</span><span class="pc">x</span><span class="c">it;</span>
	<span class="c">}</span>

	<span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">c</span><span class="pc">l</span><span class="c">ient</span> <span class="c">=</span> <span class="w">c</span><span class="pc">l</span><span class="c">ient;</span>
	<span class="w">i2c_set_clientdata</span><span class="pc">(c</span><span class="c">lient,</span> <span class="w">b</span><span class="c">dev</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">m</span><span class="c">utex_init(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="pc">m</span><span class="c">utex);</span>
	<span class="w">init_completion</span><span class="c">(&amp;</span><span class="w">b</span><span class="c">dev-&gt;</span><span class="w">compl</span><span class="c">);</span>
	<span class="w">INIT_WORK</span><span class="c">(&amp;</span><span class="w">b</span><span class="c">dev-&gt;</span><span class="pc">w</span><span class="c">ork</span><span class="pc">,</span> <span class="w">bcm2048_work</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">l</span><span class="c">ient-&gt;</span><span class="w">i</span><span class="pc">r</span><span class="c">q) {</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="pc">r</span><span class="c">equest_irq(client-&gt;irq,</span>
			<span class="w">bcm2048_handler</span><span class="c">,</span> <span class="w">IRQF_TRIGGER_FALLING</span><span class="c">,</span>
			<span class="w">cl</span><span class="c">ient-&gt;</span><span class="pc">n</span><span class="c">ame,</span> <span class="w">b</span><span class="c">dev</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
			<span class="c">dev_err</span><span class="pc">(&amp;</span><span class="c">client-&gt;dev, "</span><span class="w">C</span><span class="pc">o</span><span class="c">uld</span> <span class="c">not</span> <span class="pc">req</span><span class="c">uest</span> <span class="c">IRQ</span><span class="pc">\</span><span class="c">n");</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">free_bdev</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">d</span><span class="c">ev_dbg(&amp;</span><span class="pc">c</span><span class="c">lient-&gt;dev, "</span><span class="w">I</span><span class="pc">RQ</span> <span class="w">requested.</span><span class="c">\n");</span>
	<span class="pc">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="pc">d</span><span class="c">ev_dbg(&amp;client-&gt;dev, "</span><span class="w">I</span><span class="c">RQ</span> <span class="w">n</span><span class="c">ot</span> <span class="w">configured.</span> <span class="w">Using</span> <span class="w">timeouts</span><span class="pc">.</span><span class="c">\n");</span>
	<span class="pc">}</span>

	<span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">videodev</span> <span class="pc">=</span> <span class="w">bcm2048_viddev_template</span><span class="pc">;</span>
	<span class="w">video_set_drvdata</span><span class="c">(&amp;</span><span class="w">b</span><span class="pc">de</span><span class="c">v-&gt;</span><span class="w">v</span><span class="pc">i</span><span class="c">deodev</span><span class="pc">,</span> <span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">video_register_device</span><span class="pc">(</span><span class="c">&amp;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev-&gt;</span><span class="pc">v</span><span class="c">ideodev</span><span class="pc">,</span> <span class="w">VFL_TYPE_RADIO</span><span class="c">,</span> <span class="w">radio_nr</span><span class="pc">))</span><span class="c"> {</span>
		<span class="w">d</span><span class="pc">ev_d</span><span class="c">bg(&amp;</span><span class="pc">c</span><span class="c">lient-&gt;dev, "</span><span class="w">C</span><span class="pc">o</span><span class="c">uld</span> <span class="c">not</span> <span class="pc">r</span><span class="c">egister</span> <span class="w">v</span><span class="c">ideo</span> <span class="c">device</span><span class="pc">.</span><span class="c">\n");</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">= -</span><span class="pc">EI</span><span class="c">O;</span>
		<span class="c">goto</span> <span class="w">fr</span><span class="pc">ee_</span><span class="c">irq;</span>
	<span class="c">}</span>

	<span class="pc">e</span><span class="c">rr</span> <span class="c">=</span> <span class="w">bcm2048_sysfs_register_properties</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v);</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
		<span class="w">d</span><span class="pc">ev_d</span><span class="c">bg(&amp;client-&gt;dev, "</span><span class="w">C</span><span class="pc">o</span><span class="c">uld</span> <span class="c">not</span> <span class="c">register</span> <span class="w">sysfs</span> <span class="w">i</span><span class="pc">n</span><span class="c">terface</span><span class="w">.</span><span class="c">\n");</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">free_registration</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="c">err</span> <span class="c">=</span> <span class="w">bcm2048_probe</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev);</span>
	<span class="c">if</span> <span class="pc">(</span><span class="c">err</span> <span class="pc">&lt;</span> <span class="c">0) {</span>
		<span class="w">d</span><span class="pc">ev_d</span><span class="c">bg(&amp;client-&gt;dev, "</span><span class="pc">F</span><span class="c">ailed</span> <span class="c">to</span> <span class="w">p</span><span class="pc">r</span><span class="c">obe</span> <span class="w">d</span><span class="pc">ev</span><span class="c">ice</span> <span class="w">information</span><span class="pc">.</span><span class="c">\n");</span>
		<span class="c">goto</span> <span class="w">free_sysfs</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="pc">etu</span><span class="c">rn</span> <span class="c">0;</span>

<span class="pc">fr</span><span class="c">ee_sysfs:</span>
	<span class="w">bcm2048_sysfs_unregister_properties</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">A</span><span class="c">RRAY_SIZE(</span><span class="w">at</span><span class="pc">trs</span><span class="c">));</span>
<span class="w">free_registration</span><span class="c">:</span>
	<span class="w">video_unregister_device</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="c">ev-&gt;</span><span class="w">videodev</span><span class="c">);</span>
<span class="w">f</span><span class="pc">ree_i</span><span class="c">rq</span><span class="w">:</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="w">c</span><span class="pc">l</span><span class="c">ient-&gt;irq</span><span class="w">)</span>
		<span class="c">free_irq(</span><span class="w">c</span><span class="c">lient-&gt;irq,</span> <span class="w">b</span><span class="pc">de</span><span class="c">v);</span>
<span class="w">free_bdev</span><span class="pc">:</span>
	<span class="w">i2c_set_clientdata</span><span class="c">(</span><span class="pc">c</span><span class="c">lient</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL);</span>
	<span class="w">k</span><span class="c">free(</span><span class="pc">b</span><span class="c">dev);</span>
<span class="w">e</span><span class="pc">x</span><span class="c">it:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">e</span><span class="c">rr;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="pc">__e</span><span class="c">xit</span> <span class="w">bcm2048_i2c_driver_remove</span><span class="c">(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">i</span><span class="pc">2</span><span class="c">c_client</span> <span class="c">*client</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bcm2048_device</span> <span class="c">*</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span> <span class="c">=</span> <span class="w">i2c_get_clientdata</span><span class="c">(client);</span>

	<span class="c">if</span> <span class="pc">(!c</span><span class="c">lient-&gt;</span><span class="w">a</span><span class="pc">dapt</span><span class="c">er</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-ENODEV;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span><span class="c"> {</span>
		<span class="w">bcm2048_sysfs_unregister_properties</span><span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v,</span> <span class="w">A</span><span class="c">RRAY_SIZE(</span><span class="w">at</span><span class="pc">trs</span><span class="c">));</span>
		<span class="w">video_unregister_device</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">videodev</span><span class="c">);</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">power_state</span><span class="pc">)</span>
			<span class="w">bcm2048_set_power_state</span><span class="c">(</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="pc">,</span> <span class="w">BCM2048_POWER_OFF</span><span class="pc">)</span><span class="c">;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">cl</span><span class="pc">i</span><span class="c">ent-&gt;</span><span class="w">i</span><span class="c">rq</span> <span class="w">&gt;</span> <span class="c">0)</span>
			<span class="w">f</span><span class="pc">r</span><span class="c">ee_irq(</span><span class="pc">c</span><span class="c">lient-&gt;irq,</span> <span class="w">bd</span><span class="pc">e</span><span class="c">v</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">cancel_work_sync</span><span class="pc">(&amp;</span><span class="w">bd</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">w</span><span class="pc">o</span><span class="c">rk);</span>

		<span class="w">k</span><span class="c">free(</span><span class="pc">b</span><span class="c">dev);</span>
	<span class="c">}</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">c</span><span class="c">onst</span> <span class="c">struct</span> <span class="w">i2c_device_id</span> <span class="w">bcm2048_id</span><span class="pc">[</span><span class="c">] = {</span>
	<span class="pc">{ </span><span class="c">"</span><span class="w">bcm2048</span><span class="c">",</span> <span class="c">0</span> <span class="c">},</span>
	<span class="w">{ },</span>
<span class="w">}</span><span class="c">;</span>
<span class="c">MODULE_DEVICE_TABLE(i2c,</span> <span class="c">bcm2048_id);</span>

<span class="c">static</span> <span class="c">struct</span> <span class="w">i2c_driver</span> <span class="w">bcm2048_i2c_driver</span> <span class="c">= {</span>
	<span class="c">.driver</span>		<span class="c">= {</span>
		<span class="c">.name</span>	<span class="pc">=</span> <span class="w">BCM2048_DRIVER_NAME</span><span class="c">,</span>
	<span class="pc">}</span><span class="c">,</span>
	<span class="c">.probe</span>		<span class="c">=</span> <span class="w">bcm2048_i2c_driver_probe</span><span class="c">,</span>
	<span class="c">.remove</span>		<span class="c">=</span> <span class="w">__exit_p</span><span class="pc">(</span><span class="w">bcm2048_i2c_driver_remove</span><span class="pc">)</span><span class="c">,</span>
	<span class="c">.</span><span class="w">i</span><span class="pc">d</span><span class="c">_table</span>	<span class="c">=</span> <span class="w">b</span><span class="pc">cm2048_id</span><span class="c">,</span>
<span class="pc">}</span><span class="c">;</span>

<span class="w">module_i2c_driver</span><span class="c">(bcm2048_i2c_driver);</span>

<span class="w">M</span><span class="pc">ODULE_L</span><span class="c">ICENSE("GPL</span><span class="pc">"</span><span class="c">);</span>
<span class="c">MODULE_AUTHOR</span><span class="pc">(</span><span class="w">BCM2048_DRIVER_AUTHOR</span><span class="pc">)</span><span class="c">;</span>
<span class="c">MODULE_DESCRIPTION</span><span class="pc">(</span><span class="w">BCM2048_DRIVER_DESC</span><span class="pc">)</span><span class="c">;</span>
<span class="w">MODULE_VERSION</span><span class="pc">("</span><span class="w">0.0.2</span><span class="c">");</span>

</pre>
</body>
</html>

