<!DOCTYPE html>
<html>
<head>
<style>
span.c {
    background-color: #CCFFCC;
}
span.pc {
    background-color: #FFEEBB;
}
span.w {
    background-color: #FFCCCC;
}
</style>
</head>
<body>
<pre>

<span class="w">#include</span> <span class="w">&lt;linux/sched.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/wait.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/bio.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux/slab.h&gt;</span>
<span class="w">#include</span> <span class="w">&lt;linux</span><span class="c">/</span><span class="w">buff</span><span class="pc">er_</span><span class="c">head.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">blkdev</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">random</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">iocontext</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">capability</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">ratelimit</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">kthread</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">raid</span><span class="pc">/</span><span class="w">pq</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">h</span><span class="c">ash</span><span class="pc">.</span><span class="c">h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">list_sort</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">r</span><span class="c">aid</span><span class="pc">/</span><span class="w">xor</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;linux/</span><span class="w">vmalloc</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="c">&lt;</span><span class="pc">a</span><span class="c">sm/</span><span class="w">div64</span><span class="c">.h&gt;</span>
<span class="c">#include</span> <span class="pc">"</span><span class="w">ctree</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">extent_map</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">di</span><span class="pc">s</span><span class="c">k</span><span class="pc">-</span><span class="w">io</span><span class="c">.h"</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">"</span><span class="w">transaction</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">print</span><span class="pc">-</span><span class="w">tre</span><span class="c">e.h"</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">"</span><span class="w">volumes</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">raid56</span><span class="c">.h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">as</span><span class="pc">y</span><span class="c">nc</span><span class="pc">-</span><span class="w">th</span><span class="pc">r</span><span class="c">ead.h"</span>
<span class="c">#</span><span class="pc">i</span><span class="c">nclude</span> <span class="c">"</span><span class="w">che</span><span class="c">ck</span><span class="pc">-</span><span class="w">integrity</span><span class="pc">.</span><span class="c">h"</span>
<span class="c">#include</span> <span class="c">"</span><span class="w">rcu</span><span class="pc">-</span><span class="w">s</span><span class="pc">t</span><span class="c">ring.h"</span>


<span class="c">#</span><span class="pc">d</span><span class="c">efine</span> <span class="w">RBIO_RMW_LOCKED_BIT</span>	<span class="w">1</span>


<span class="c">#define</span> <span class="w">RBIO_CACHE_BIT</span>		<span class="pc">2</span>


<span class="c">#define</span> <span class="w">RBIO_CACHE_READY_BIT</span>	<span class="c">3</span>

<span class="c">#define</span> <span class="w">RBIO_CACHE_SIZE</span> <span class="w">10</span><span class="pc">2</span><span class="c">4</span>

<span class="pc">e</span><span class="c">num</span> <span class="w">btrfs_rbio_ops</span> <span class="c">{</span>
	<span class="w">BTRFS_RBIO_WRITE</span>	<span class="c">=</span> <span class="c">0,</span>
	<span class="w">BTRFS_RBIO_READ_REBUILD</span>	<span class="c">=</span> <span class="c">1,</span>
	<span class="w">BTRFS_RBIO_PARITY_SCRUB</span>	<span class="c">=</span> <span class="c">2,</span>
<span class="c">};</span>

<span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_raid_bio</span> <span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_fs_info</span> <span class="c">*</span><span class="w">fs</span><span class="pc">_</span><span class="c">info;</span>
	<span class="c">struct</span> <span class="w">btrfs_bio</span> <span class="c">*</span><span class="w">bbio</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="c">list_head</span> <span class="w">hash_list</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="c">list_head</span> <span class="w">stripe_cache</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="w">btrfs_work</span> <span class="w">w</span><span class="pc">o</span><span class="c">rk;</span>

	
	<span class="c">struct</span> <span class="w">bio_list</span> <span class="pc">b</span><span class="c">io_list;</span>
	<span class="pc">sp</span><span class="c">inlock_t</span> <span class="w">bio_list_lock</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="pc">l</span><span class="c">ist_head</span> <span class="w">plug_list</span><span class="c">;</span>

	
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>

	
	<span class="pc">i</span><span class="c">nt</span> <span class="w">stripe_len</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">nt</span> <span class="w">nr_data</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">nt</span> <span class="w">real_stripes</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">nt</span> <span class="w">stripe_npages</span><span class="c">;</span>
	
	<span class="w">e</span><span class="c">num</span> <span class="w">btrfs_rbio_ops</span> <span class="w">operation</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">nt</span> <span class="w">faila</span><span class="c">;</span>

	
	<span class="c">int</span> <span class="w">failb</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">nt</span> <span class="w">scrubp</span><span class="c">;</span>
	
	<span class="c">int</span> <span class="w">nr</span><span class="pc">_p</span><span class="c">ages;</span>

	
	<span class="c">int</span> <span class="w">bio_list_bytes</span><span class="c">;</span>

	<span class="c">int</span> <span class="w">generic_bio_cnt</span><span class="c">;</span>

	<span class="w">a</span><span class="c">tomic_t</span> <span class="w">refs</span><span class="c">;</span>

	<span class="w">a</span><span class="c">tomic_t</span> <span class="w">stripes_pending</span><span class="c">;</span>

	<span class="w">a</span><span class="c">tomic_t</span> <span class="w">e</span><span class="pc">rro</span><span class="c">r;</span>
	

	
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="pc">**</span><span class="w">stripe_pages</span><span class="c">;</span>

	
	<span class="c">struct</span> <span class="w">p</span><span class="c">age</span> <span class="pc">**</span><span class="w">bio_pages</span><span class="c">;</span>

	
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">*</span><span class="w">dbitmap</span><span class="c">;</span>
<span class="w">}</span><span class="c">;</span>

<span class="pc">sta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">__raid56_parity_recover</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">);</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="w">noinline</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">finish_rmw</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">);</span>
<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rmw_work</span><span class="c">(struct</span> <span class="w">btrfs_work</span> <span class="c">*</span><span class="w">w</span><span class="c">ork</span><span class="pc">);</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">read_rebuild_work</span><span class="c">(struct</span> <span class="c">btrfs_work</span> <span class="c">*</span><span class="w">w</span><span class="pc">o</span><span class="c">rk</span><span class="pc">);</span>
<span class="c">static</span> <span class="c">void</span> <span class="w">async_rmw_stripe</span><span class="c">(struct</span> <span class="pc">btrfs_r</span><span class="c">aid_bio</span> <span class="c">*rbio</span><span class="pc">);</span>
<span class="c">static</span> <span class="c">void</span> <span class="w">async_read_rebuild</span><span class="c">(struct</span> <span class="pc">btrfs_r</span><span class="c">aid_bio</span> <span class="c">*rbio</span><span class="pc">);</span>
<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">fail_bio_stripe</span><span class="c">(struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*rbio,</span> <span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*</span><span class="pc">bi</span><span class="c">o);</span>
<span class="c">static</span> <span class="pc">int</span> <span class="w">fail_rbio_index</span><span class="c">(struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*rbio,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">fai</span><span class="pc">le</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">__free_raid_bio</span><span class="c">(struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">);</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">index_rbio_pages</span><span class="c">(struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span><span class="c">;</span>
<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">alloc_rbio_pages</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">);</span>

<span class="c">static</span> <span class="w">noinline</span> <span class="w">v</span><span class="c">oid</span> <span class="w">finish_parity_scrub</span><span class="c">(struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio,</span>
					 <span class="pc">i</span><span class="c">nt</span> <span class="w">need_check</span><span class="c">);</span>
<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">async_scrub_parity</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio</span><span class="pc">);</span>


<span class="pc">i</span><span class="c">nt</span> <span class="w">btrfs_alloc_stripe_hash_table</span><span class="c">(struct</span> <span class="w">btrfs_fs_info</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_stripe_hash_table</span> <span class="c">*</span><span class="w">t</span><span class="pc">a</span><span class="c">ble</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="c">btrfs_stripe_hash_table</span> <span class="c">*</span><span class="w">x</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">btrfs_stripe_hash</span> <span class="c">*</span><span class="w">cu</span><span class="pc">r</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">b</span><span class="c">trfs_stripe_hash</span> <span class="c">*</span><span class="w">h</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">num_entries</span> <span class="pc">=</span> <span class="pc">1</span> <span class="w">&lt;</span><span class="c">&lt;</span> <span class="w">BTRFS_STRIPE_HASH_TABLE_BITS</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">table_size</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">i</span><span class="c">nfo-&gt;</span><span class="w">stripe_hash_table</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	
	<span class="w">t</span><span class="c">able_size</span> <span class="c">=</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*</span><span class="w">t</span><span class="pc">able) </span><span class="c">+</span> <span class="pc">si</span><span class="c">zeof</span><span class="pc">(*</span><span class="w">h</span><span class="c">) *</span> <span class="pc">n</span><span class="c">um_entries;</span>
	<span class="w">t</span><span class="pc">able</span> <span class="c">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(</span><span class="w">t</span><span class="c">able_size,</span> <span class="c">GFP_KERNEL</span> <span class="w">|</span> <span class="w">__GFP_NOWARN</span> <span class="pc">|</span> <span class="w">__GFP_REPEAT</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">t</span><span class="pc">able) </span><span class="c">{</span>
		<span class="w">t</span><span class="pc">able</span> <span class="pc">=</span> <span class="w">vzalloc</span><span class="c">(table_size</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">t</span><span class="pc">able</span><span class="c">)</span>
			<span class="c">return</span> <span class="c">-ENOMEM;</span>
	<span class="pc">}</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_init(&amp;</span><span class="w">ta</span><span class="pc">ble</span><span class="c">-&gt;</span><span class="w">cache_lock</span><span class="c">);</span>
	<span class="c">INIT_LIST_HEAD(&amp;</span><span class="pc">table</span><span class="c">-&gt;</span><span class="w">stripe_cache</span><span class="c">);</span>

	<span class="w">h</span> <span class="w">=</span> <span class="w">t</span><span class="pc">able-</span><span class="c">&gt;</span><span class="w">t</span><span class="pc">able</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">num_entries</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">cu</span><span class="pc">r</span> <span class="pc">=</span> <span class="w">h</span> <span class="pc">+</span> <span class="c">i;</span>
		<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="w">hash_list</span><span class="c">);</span>
		<span class="w">s</span><span class="c">pin_lock_init(&amp;</span><span class="w">cu</span><span class="c">r-&gt;lock);</span>
		<span class="w">init_waitqueue_head</span><span class="pc">(&amp;</span><span class="w">c</span><span class="pc">u</span><span class="c">r-&gt;</span><span class="w">w</span><span class="pc">a</span><span class="c">it);</span>
	<span class="c">}</span>

	<span class="w">x</span> <span class="pc">=</span> <span class="w">cmpxchg</span><span class="pc">(&amp;</span><span class="w">in</span><span class="pc">f</span><span class="c">o-&gt;</span><span class="w">stripe_hash_table</span><span class="pc">,</span> <span class="w">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="w">tab</span><span class="c">le</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">x</span><span class="pc">)</span>
		<span class="w">kvfree</span><span class="c">(</span><span class="pc">x)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cache_rbio_pages</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>
	<span class="w">c</span><span class="pc">h</span><span class="c">ar</span> <span class="c">*</span><span class="w">s</span><span class="c">;</span>
	<span class="w">c</span><span class="c">har</span> <span class="c">*</span><span class="w">d</span><span class="c">;</span>
	<span class="c">int</span> <span class="pc">r</span><span class="c">et;</span>

	<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">alloc_rbio_pages</span><span class="c">(</span><span class="w">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret)</span>
		<span class="c">return</span><span class="w">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr</span><span class="pc">_</span><span class="c">pages;</span> <span class="c">i++) {</span>
		<span class="c">if</span> <span class="pc">(!r</span><span class="c">bio-&gt;</span><span class="w">bio_pages</span><span class="c">[i</span><span class="pc">])</span>
			<span class="pc">c</span><span class="c">ontinue;</span>

		<span class="w">s</span> <span class="pc">=</span> <span class="w">kmap</span><span class="c">(</span><span class="pc">r</span><span class="c">bio-&gt;bio_pages[i]);</span>
		<span class="w">d</span> <span class="pc">=</span> <span class="pc">km</span><span class="c">ap(rbio-&gt;</span><span class="w">stripe_pages</span><span class="pc">[</span><span class="c">i]);</span>

		<span class="w">m</span><span class="c">emcpy(</span><span class="w">d</span><span class="pc">,</span> <span class="w">s</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">kunmap</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;bio_pages</span><span class="pc">[</span><span class="c">i</span><span class="pc">])</span><span class="c">;</span>
		<span class="w">k</span><span class="pc">u</span><span class="c">nmap(rbio-&gt;</span><span class="w">s</span><span class="c">tripe_pages[i]);</span>
		<span class="w">SetPageUptodate</span><span class="c">(rbio-&gt;stripe_pages[i]);</span>
	<span class="pc">}</span>
	<span class="w">se</span><span class="pc">t</span><span class="c">_bit(</span><span class="w">RBIO_CACHE_READY_BIT</span><span class="c">, &amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">rbio_bucket</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">n</span><span class="c">um</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">raid_map[</span><span class="c">0];</span>

	
	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">hash_64</span><span class="pc">(</span><span class="w">n</span><span class="pc">u</span><span class="c">m</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="pc">16,</span> <span class="w">BTRFS_STRIPE_HASH_TABLE_BITS</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">steal_rbio</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*</span><span class="w">sr</span><span class="pc">c</span><span class="c">,</span> <span class="c">struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*</span><span class="w">de</span><span class="pc">st)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="c">age</span> <span class="c">*</span><span class="w">s</span><span class="c">;</span>
	<span class="c">struct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*</span><span class="w">d</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="pc">(!t</span><span class="c">est_bit(</span><span class="w">RBIO_CACHE_READY_BIT</span><span class="c">, &amp;</span><span class="w">sr</span><span class="c">c-&gt;flags))</span>
		<span class="c">return;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">de</span><span class="pc">st</span><span class="c">-&gt;</span><span class="w">nr</span><span class="pc">_</span><span class="c">pages;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
		<span class="pc">s</span> <span class="pc">=</span> <span class="w">sr</span><span class="c">c-&gt;</span><span class="w">stripe_pages</span><span class="c">[i];</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">s</span> <span class="w">|</span><span class="c">| !</span><span class="w">PageUptodate</span><span class="pc">(s)) </span><span class="c">{</span>
			<span class="pc">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>

		<span class="w">d</span> <span class="pc">=</span> <span class="w">des</span><span class="pc">t</span><span class="c">-&gt;</span><span class="w">s</span><span class="pc">t</span><span class="c">ripe_pages</span><span class="pc">[</span><span class="c">i];</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">d)</span>
			<span class="w">__free_page</span><span class="c">(</span><span class="pc">d)</span><span class="c">;</span>

		<span class="w">des</span><span class="pc">t</span><span class="c">-&gt;</span><span class="pc">s</span><span class="c">tripe_pages</span><span class="pc">[i</span><span class="c">] =</span> <span class="pc">s;</span>
		<span class="w">sr</span><span class="c">c-&gt;</span><span class="pc">s</span><span class="c">tripe_pages[i] =</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="c">}</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">merge_rbio</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">de</span><span class="pc">st</span><span class="c">,</span>
		       <span class="c">struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*</span><span class="w">victim</span><span class="c">)</span>
<span class="c">{</span>
	<span class="w">bio_list_merge</span><span class="pc">(&amp;</span><span class="w">d</span><span class="c">est-&gt;</span><span class="w">bio_list,</span><span class="pc"> </span><span class="c">&amp;victim-&gt;</span><span class="pc">b</span><span class="c">io_list);</span>
	<span class="w">de</span><span class="pc">s</span><span class="c">t-&gt;</span><span class="w">bio_list_bytes</span> <span class="w">+</span><span class="c">=</span> <span class="c">victim</span><span class="pc">-</span><span class="c">&gt;bio_list_bytes;</span>
	<span class="w">d</span><span class="pc">e</span><span class="c">st-&gt;</span><span class="w">generic_bio_cnt</span> <span class="w">+</span><span class="c">=</span> <span class="c">victim-&gt;generic_bio_cnt;</span>
	<span class="w">bio_list_init</span><span class="pc">(&amp;</span><span class="c">victim-&gt;</span><span class="pc">bio_list)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">__remove_rbio_from_cache</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">bucket</span> <span class="pc">=</span> <span class="w">rbio_bucket</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_stripe_hash_table</span> <span class="c">*</span><span class="w">ta</span><span class="pc">b</span><span class="c">le</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">btrfs_stripe_hash</span> <span class="c">*</span><span class="w">h</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">freeit</span> <span class="pc">=</span> <span class="c">0;</span>

	
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">RBIO_CACHE_BIT</span><span class="c">, &amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags</span><span class="pc">))</span>
		<span class="c">return;</span>

	<span class="w">ta</span><span class="c">ble</span> <span class="pc">=</span> <span class="c">rbio-&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_hash_table</span><span class="c">;</span>
	<span class="w">h</span> <span class="pc">=</span> <span class="w">ta</span><span class="c">ble-&gt;</span><span class="w">t</span><span class="pc">a</span><span class="c">ble</span> <span class="w">+</span> <span class="w">bucket</span><span class="c">;</span>

	
	<span class="w">sp</span><span class="c">in_lock(&amp;</span><span class="w">h</span><span class="c">-&gt;lock);</span>

	
	<span class="w">s</span><span class="pc">pin_lock</span><span class="c">(&amp;</span><span class="w">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">test_and_clear_bit</span><span class="c">(</span><span class="pc">R</span><span class="c">BIO_CACHE_BIT</span><span class="pc">, </span><span class="c">&amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">l</span><span class="pc">ist_del_</span><span class="c">init(&amp;rbio-&gt;</span><span class="w">stripe_cache</span><span class="c">);</span>
		<span class="w">ta</span><span class="pc">b</span><span class="c">le-&gt;</span><span class="w">cache_size</span> <span class="w">-</span><span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">freeit</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bio_list_empty</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">bio_list</span><span class="pc">)) </span><span class="c">{</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">l</span><span class="c">ist_empty(&amp;rbio-&gt;</span><span class="w">hash_list</span><span class="pc">)) </span><span class="c">{</span>
				<span class="w">l</span><span class="pc">ist_del_</span><span class="c">init(&amp;rbio-&gt;hash_list);</span>
				<span class="w">atomic_dec</span><span class="c">(&amp;rbio-&gt;</span><span class="w">refs</span><span class="c">);</span>
				<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!l</span><span class="c">ist_empty(&amp;rbio-&gt;</span><span class="w">plug_list</span><span class="pc">))</span><span class="c">;</span>
			<span class="pc">}</span>
		<span class="pc">}</span>
	<span class="w">}</span>

	<span class="pc">sp</span><span class="c">in_unlock(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
	<span class="pc">s</span><span class="c">pin_unlock(&amp;</span><span class="w">h</span><span class="c">-&gt;lock);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">freeit</span><span class="pc">)</span>
		<span class="w">__free_raid_bio</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">)</span><span class="c">;</span>
<span class="w">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">remove_rbio_from_cache</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_stripe_hash_table</span> <span class="c">*</span><span class="w">ta</span><span class="pc">b</span><span class="c">le</span><span class="pc">;</span>
	<span class="w">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">RBIO_CACHE_BIT</span><span class="c">, &amp;</span><span class="pc">r</span><span class="c">bio-&gt;flags))</span>
		<span class="c">return;</span>

	<span class="w">t</span><span class="pc">a</span><span class="c">ble</span> <span class="pc">=</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_hash_table</span><span class="c">;</span>

	<span class="w">sp</span><span class="pc">in_lock_</span><span class="c">irqsave(&amp;</span><span class="w">t</span><span class="c">able-&gt;</span><span class="w">cache_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="w">__remove_rbio_from_cache</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">t</span><span class="pc">ab</span><span class="c">le-&gt;</span><span class="pc">c</span><span class="c">ache_lock,</span> <span class="c">flags);</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">btrfs_clear_rbio_cache</span><span class="c">(struct</span> <span class="w">btrfs_fs_info</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_stripe_hash_table</span> <span class="c">*</span><span class="w">ta</span><span class="pc">b</span><span class="c">le</span><span class="pc">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">st</span><span class="c">ruct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio;</span>

	<span class="w">ta</span><span class="pc">b</span><span class="c">le</span> <span class="pc">=</span> <span class="w">i</span><span class="c">nfo-&gt;</span><span class="w">stripe_hash_table</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_irqsave(&amp;</span><span class="w">t</span><span class="pc">a</span><span class="c">ble-&gt;</span><span class="w">c</span><span class="c">ache_lock,</span> <span class="c">flags);</span>
	<span class="w">w</span><span class="c">hile</span> <span class="pc">(!</span><span class="c">list_empty(&amp;</span><span class="w">ta</span><span class="pc">b</span><span class="c">le-&gt;</span><span class="w">stripe_cache</span><span class="c">)) {</span>
		<span class="w">r</span><span class="pc">b</span><span class="c">io</span> <span class="pc">=</span> <span class="c">list_entry(</span><span class="w">t</span><span class="pc">ab</span><span class="c">le</span><span class="pc">-</span><span class="c">&gt;stripe_cache.next,</span>
				  <span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="c">trfs_raid_bio,</span>
				  <span class="w">s</span><span class="c">tripe_cache);</span>
		<span class="w">__remove_rbio_from_cache</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="w">t</span><span class="pc">ab</span><span class="c">le-&gt;</span><span class="w">c</span><span class="c">ache_lock,</span> <span class="c">flags);</span>
<span class="c">}</span>


<span class="pc">v</span><span class="c">oid</span> <span class="w">btrfs_free_stripe_hash_table</span><span class="c">(struct</span> <span class="w">btrfs_fs_info</span> <span class="c">*</span><span class="w">i</span><span class="pc">n</span><span class="c">fo)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="w">stripe_hash_table</span><span class="c">)</span>
		<span class="c">return;</span>
	<span class="w">btrfs_clear_rbio_cache</span><span class="c">(</span><span class="pc">i</span><span class="c">nfo</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">kvfree</span><span class="pc">(i</span><span class="c">nfo-&gt;</span><span class="pc">s</span><span class="c">tripe_hash_table</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">fo-&gt;</span><span class="pc">s</span><span class="c">tripe_hash_table</span> <span class="c">=</span> <span class="c">NULL;</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">cache_rbio</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_stripe_hash_table</span> <span class="c">*</span><span class="w">ta</span><span class="pc">b</span><span class="c">le</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">n</span><span class="c">signed</span> <span class="c">long</span> <span class="c">flags;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">RBIO_CACHE_READY_BIT</span><span class="c">, &amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags))</span>
		<span class="c">return;</span>

	<span class="w">ta</span><span class="c">ble</span> <span class="pc">=</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_hash_table</span><span class="c">;</span>

	<span class="w">sp</span><span class="pc">in_lock_</span><span class="c">irqsave(&amp;</span><span class="w">t</span><span class="c">able-&gt;</span><span class="w">cache_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="w">s</span><span class="c">pin_lock(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>

	
	<span class="c">if</span> <span class="pc">(!</span><span class="w">test_and_set_bit</span><span class="pc">(</span><span class="w">RBIO_CACHE_BIT</span><span class="pc">, </span><span class="c">&amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags))</span>
		<span class="w">a</span><span class="pc">tomic_i</span><span class="c">nc(&amp;rbio-&gt;</span><span class="w">refs</span><span class="c">);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">list_empty(&amp;rbio-&gt;</span><span class="w">stripe_cache)){</span>
		<span class="w">list_move</span><span class="c">(&amp;rbio-&gt;stripe_cache</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">ta</span><span class="pc">b</span><span class="c">le</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tripe_cache);</span>
	<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">list_a</span><span class="pc">dd</span><span class="c">(&amp;</span><span class="w">r</span><span class="pc">b</span><span class="c">io-&gt;</span><span class="w">s</span><span class="c">tripe_cache, &amp;</span><span class="w">ta</span><span class="pc">b</span><span class="c">le-&gt;</span><span class="pc">s</span><span class="c">tripe_cache);</span>
		<span class="w">ta</span><span class="pc">b</span><span class="c">le</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">cache_size</span> <span class="w">+</span><span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">s</span><span class="pc">pin_unlock</span><span class="c">(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">ta</span><span class="pc">b</span><span class="c">le-&gt;</span><span class="pc">c</span><span class="c">ache_size</span> <span class="w">&gt;</span> <span class="w">RBIO_CACHE_SIZE</span><span class="c">) {</span>
		<span class="w">s</span><span class="pc">tru</span><span class="c">ct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">f</span><span class="pc">o</span><span class="c">und</span><span class="pc">;</span>

		<span class="w">fo</span><span class="pc">u</span><span class="c">nd</span> <span class="c">=</span> <span class="pc">l</span><span class="c">ist_entry(</span><span class="w">ta</span><span class="pc">b</span><span class="c">le-&gt;</span><span class="w">s</span><span class="c">tripe_cache.</span><span class="w">p</span><span class="pc">r</span><span class="c">ev</span><span class="pc">,</span>
				  <span class="w">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">t</span><span class="c">rfs_raid_bio</span><span class="pc">,</span>
				  <span class="w">s</span><span class="pc">tri</span><span class="c">pe_cache);</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">fo</span><span class="pc">u</span><span class="c">nd</span> <span class="w">!</span><span class="c">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">)</span>
			<span class="w">__remove_rbio_from_cache</span><span class="c">(</span><span class="w">fo</span><span class="pc">u</span><span class="c">nd</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">sp</span><span class="pc">in_unlock_i</span><span class="c">rqrestore(&amp;</span><span class="w">t</span><span class="pc">a</span><span class="c">ble-&gt;</span><span class="w">cache_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="c">return</span><span class="w">;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">run_xor</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="w">*</span><span class="pc">*</span><span class="w">p</span><span class="pc">ages,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">src_cnt</span><span class="pc">,</span> <span class="w">ss</span><span class="c">ize_t</span> <span class="pc">l</span><span class="c">en)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">src_off</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">xor_src_cnt</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">de</span><span class="pc">st</span> <span class="c">=</span> <span class="w">pag</span><span class="pc">es[</span><span class="w">s</span><span class="pc">rc_c</span><span class="c">nt];</span>

	<span class="w">w</span><span class="c">hile(</span><span class="pc">s</span><span class="c">rc_cnt</span> <span class="c">&gt;</span> <span class="c">0) {</span>
		<span class="pc">x</span><span class="c">or_src_cnt</span> <span class="c">=</span> <span class="w">m</span><span class="pc">in</span><span class="c">(src_cnt,</span> <span class="w">MAX_XOR_BLOCKS</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">xor_blocks</span><span class="c">(</span><span class="pc">x</span><span class="c">or_src_cnt,</span> <span class="w">l</span><span class="c">en,</span> <span class="w">de</span><span class="pc">st,</span> <span class="w">pa</span><span class="pc">g</span><span class="c">es</span> <span class="pc">+</span> <span class="w">src_off</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">s</span><span class="c">rc_cnt</span> <span class="w">-</span><span class="pc">=</span> <span class="c">xor_src_cnt;</span>
		<span class="w">s</span><span class="c">rc_off</span> <span class="pc">+</span><span class="c">=</span> <span class="c">xor_src_cnt;</span>
	<span class="c">}</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">__rbio_is_full</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bio_list_bytes</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">r</span><span class="c">et</span> <span class="pc">=</span> <span class="pc">1</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="w">!</span><span class="c">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr_data</span> <span class="w">*</span> <span class="c">rbio</span><span class="w">-</span><span class="c">&gt;</span><span class="w">stripe_len)</span>
		<span class="pc">ret</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="w">B</span><span class="c">UG_ON(</span><span class="w">s</span><span class="pc">i</span><span class="c">ze</span> <span class="pc">&gt;</span> <span class="c">rbio-&gt;</span><span class="w">n</span><span class="c">r_data</span> <span class="w">*</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;stripe_len</span><span class="w">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">ret;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">int</span> <span class="w">rbio_is_full</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">rb</span><span class="c">io</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="c">flags;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">ret;</span>

	<span class="c">spin_lock_irqsave(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">,</span> <span class="c">flags);</span>
	<span class="pc">ret</span> <span class="c">=</span> <span class="w">__rbio_is_full</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock_irqrestore(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;bio_list_lock,</span> <span class="c">flags);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">rbio_can_merge</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">la</span><span class="pc">s</span><span class="c">t,</span>
			  <span class="c">struct</span> <span class="w">b</span><span class="pc">t</span><span class="c">rfs_raid_bio</span> <span class="c">*</span><span class="w">cu</span><span class="pc">r</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(test_bit(</span><span class="w">RBIO_RMW_LOCKED_BIT</span><span class="c">, &amp;</span><span class="w">la</span><span class="pc">s</span><span class="c">t-&gt;flags</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span>
	    <span class="pc">t</span><span class="c">est_bit(</span><span class="pc">R</span><span class="c">BIO_RMW_LOCKED_BIT, &amp;</span><span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;flags</span><span class="pc">))</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(test_bit(</span><span class="w">RBIO_CACHE_BIT</span><span class="c">, &amp;</span><span class="w">la</span><span class="pc">s</span><span class="c">t-&gt;flags</span><span class="w">) </span><span class="pc">|</span><span class="c">|</span>
	    <span class="pc">t</span><span class="c">est_bit(</span><span class="pc">R</span><span class="c">BIO_CACHE_BIT, &amp;</span><span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;flags</span><span class="pc">))</span>
		<span class="c">return</span> <span class="w">0</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">la</span><span class="pc">s</span><span class="c">t</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">raid_map[</span><span class="pc">0</span><span class="w">] </span><span class="pc">!</span><span class="c">=</span>
	    <span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;bbio-&gt;raid_map[</span><span class="pc">0</span><span class="w">])</span>
		<span class="c">return</span> <span class="c">0;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">la</span><span class="pc">s</span><span class="c">t-&gt;</span><span class="w">operation</span> <span class="w">!</span><span class="c">=</span> <span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;</span><span class="pc">o</span><span class="c">peration</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">0;</span>
	
	<span class="c">if</span> <span class="c">(</span><span class="w">la</span><span class="c">st-&gt;</span><span class="pc">o</span><span class="c">peration</span> <span class="c">==</span> <span class="w">BTRFS_RBIO_PARITY_SCRUB</span> <span class="w">|</span><span class="c">|</span>
	    <span class="w">cu</span><span class="c">r-&gt;</span><span class="pc">o</span><span class="c">peration</span> <span class="c">==</span> <span class="pc">B</span><span class="c">TRFS_RBIO_PARITY_SCRUB</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">1</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">pa</span><span class="c">ge</span> <span class="c">*</span><span class="w">rbio_pstripe_page</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">ndex)</span>
<span class="c">{</span>
	<span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="w">+=</span><span class="pc"> </span><span class="c">(rbio-&gt;</span><span class="w">nr_data</span> <span class="w">*</span> <span class="c">rbio</span><span class="w">-</span><span class="c">&gt;</span><span class="w">stripe_len)</span><span class="pc"> &gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripe_pages</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex];</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="w">rbio_qstripe_page</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio,</span> <span class="pc">i</span><span class="c">nt</span> <span class="c">index)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(rbio-&gt;</span><span class="pc">n</span><span class="c">r_data</span> <span class="w">+</span> <span class="pc">1</span> <span class="w">=</span><span class="c">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">real_stripes</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="w">+= ((r</span><span class="pc">b</span><span class="c">io-&gt;</span><span class="pc">n</span><span class="c">r_data</span> <span class="w">+</span> <span class="pc">1</span><span class="w">)</span><span class="pc"> *</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len)</span><span class="pc"> &gt;</span><span class="c">&gt;</span>
		<span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripe_pages</span><span class="c">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">];</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">noinline</span> <span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">lock_stripe_add</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">bucket</span> <span class="pc">=</span> <span class="w">rbio_bucket</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_stripe_hash</span> <span class="c">*</span><span class="w">h</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="w">-</span><span class="c">&gt;</span><span class="w">stripe_hash_table-</span><span class="c">&gt;</span><span class="w">ta</span><span class="pc">b</span><span class="c">le</span> <span class="w">+</span> <span class="pc">bu</span><span class="c">cket</span><span class="pc">;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="pc">bt</span><span class="c">rfs_raid_bio</span> <span class="c">*</span><span class="w">cu</span><span class="pc">r;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*</span><span class="w">pe</span><span class="c">nding;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="w">DEFINE_WAIT</span><span class="pc">(</span><span class="w">wa</span><span class="c">it);</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">bt</span><span class="c">rfs_raid_bio</span> <span class="c">*</span><span class="w">freeit</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="c">struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*</span><span class="w">cache_drop</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">int</span> <span class="w">wa</span><span class="pc">l</span><span class="c">k</span> <span class="c">=</span> <span class="c">0;</span>

	<span class="w">s</span><span class="pc">pin_lock_</span><span class="c">irqsave(&amp;</span><span class="w">h</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
	<span class="w">l</span><span class="pc">ist_f</span><span class="c">or_each_entry(</span><span class="w">cu</span><span class="c">r, &amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="w">hash_list</span><span class="c">,</span> <span class="w">h</span><span class="c">ash_list) {</span>
		<span class="w">wa</span><span class="pc">l</span><span class="c">k</span><span class="w">+</span><span class="pc">+</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">c</span><span class="pc">u</span><span class="c">r-&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">raid_map[</span><span class="c">0</span><span class="w">] </span><span class="pc">==</span> <span class="w">rbio</span><span class="pc">-</span><span class="c">&gt;bbio-&gt;</span><span class="pc">r</span><span class="c">aid_map[</span><span class="pc">0</span><span class="w">])</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">spin_l</span><span class="pc">ock</span><span class="c">(&amp;</span><span class="w">c</span><span class="pc">u</span><span class="c">r-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>

			
			<span class="c">if</span> <span class="c">(</span><span class="w">bio_list_empty</span><span class="pc">(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="w">bio_list) &amp;</span><span class="c">&amp;</span>
			    <span class="w">list_e</span><span class="pc">m</span><span class="c">pty(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="w">plug_list) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
			    <span class="w">t</span><span class="c">est_bit(</span><span class="w">RBIO_CACHE_BIT</span><span class="c">, &amp;</span><span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;flags</span><span class="pc">) </span><span class="c">&amp;&amp;</span>
			    <span class="pc">!</span><span class="c">test_bit(</span><span class="w">RBIO_RMW_LOCKED_BIT</span><span class="c">, &amp;</span><span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;flags)) {</span>
				<span class="w">l</span><span class="pc">ist_del_</span><span class="c">init(&amp;</span><span class="w">c</span><span class="pc">u</span><span class="c">r-&gt;</span><span class="w">hash_list</span><span class="c">);</span>
				<span class="w">atomic_dec</span><span class="c">(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="w">refs</span><span class="c">);</span>

				<span class="w">steal_rbio</span><span class="pc">(</span><span class="w">c</span><span class="pc">u</span><span class="c">r,</span> <span class="w">rbio</span><span class="c">);</span>
				<span class="w">cache_drop</span> <span class="pc">=</span> <span class="w">cu</span><span class="c">r</span><span class="pc">;</span>
				<span class="pc">s</span><span class="c">pin_unlock(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>

				<span class="w">g</span><span class="c">oto</span> <span class="w">lockit</span><span class="c">;</span>
			<span class="c">}</span>

			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rbio_can_merge</span><span class="c">(</span><span class="w">cu</span><span class="pc">r</span><span class="c">,</span> <span class="w">r</span><span class="pc">bio))</span><span class="c"> {</span>
				<span class="w">merge_rbio</span><span class="c">(</span><span class="w">cu</span><span class="pc">r</span><span class="c">,</span> <span class="w">r</span><span class="pc">b</span><span class="c">io</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">s</span><span class="pc">pin_unlock</span><span class="c">(&amp;</span><span class="w">c</span><span class="pc">u</span><span class="c">r-&gt;</span><span class="w">b</span><span class="c">io_list_lock);</span>
				<span class="w">freeit</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">;</span>
				<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
				<span class="c">goto</span> <span class="pc">o</span><span class="c">ut;</span>
			<span class="c">}</span>


			
			<span class="w">li</span><span class="pc">st_for_each_entry</span><span class="c">(</span><span class="w">pe</span><span class="c">nding, &amp;</span><span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;</span><span class="w">plug_list</span><span class="c">,</span>
					    <span class="w">p</span><span class="c">lug_list) {</span>
				<span class="c">if</span> <span class="c">(</span><span class="w">rbio_can_merge</span><span class="c">(</span><span class="w">pe</span><span class="pc">n</span><span class="c">ding,</span> <span class="w">r</span><span class="pc">bio))</span><span class="c"> {</span>
					<span class="w">merge_rbio</span><span class="c">(</span><span class="w">pe</span><span class="pc">n</span><span class="c">ding,</span> <span class="pc">r</span><span class="c">bio);</span>
					<span class="w">sp</span><span class="pc">in_unlock</span><span class="c">(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
					<span class="w">freeit</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">;</span>
					<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
					<span class="pc">g</span><span class="c">oto</span> <span class="pc">o</span><span class="c">ut;</span>
				<span class="c">}</span>
			<span class="pc">}</span>

			
			<span class="w">l</span><span class="pc">ist_a</span><span class="c">dd_tail(&amp;rbio-&gt;</span><span class="w">p</span><span class="c">lug_list, &amp;</span><span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;plug_list);</span>
			<span class="w">s</span><span class="c">pin_unlock(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="pc">b</span><span class="c">io_list_lock);</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
<span class="w">lockit:</span>
	<span class="w">at</span><span class="pc">omic_i</span><span class="c">nc(&amp;</span><span class="w">r</span><span class="c">bio-&gt;</span><span class="w">refs</span><span class="c">);</span>
	<span class="w">l</span><span class="pc">ist_a</span><span class="c">dd(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">hash_list</span><span class="c">, &amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="pc">h</span><span class="c">ash_list);</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="w">s</span><span class="c">pin_unlock_irqrestore(&amp;</span><span class="w">h</span><span class="c">-&gt;lock</span><span class="pc">,</span> <span class="c">flags);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(</span><span class="w">cache_drop</span><span class="pc">)</span>
		<span class="w">remove_rbio_from_cache</span><span class="pc">(c</span><span class="c">ache_drop</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">freeit</span><span class="pc">)</span>
		<span class="w">__free_raid_bio</span><span class="c">(</span><span class="pc">f</span><span class="c">reeit</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">noinline</span> <span class="w">v</span><span class="c">oid</span> <span class="w">unlock_stripe</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">bucket</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">btrfs_stripe_hash</span> <span class="c">*</span><span class="w">h</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">flags;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">keep_cache</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">b</span><span class="pc">u</span><span class="c">cket</span> <span class="pc">=</span> <span class="w">rbio_bucket</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">h</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="w">-</span><span class="c">&gt;</span><span class="w">stripe_hash_table-</span><span class="c">&gt;</span><span class="w">t</span><span class="pc">a</span><span class="c">ble</span> <span class="pc">+</span> <span class="w">b</span><span class="pc">u</span><span class="c">cket</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">li</span><span class="pc">s</span><span class="c">t_empty(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">plug_list</span><span class="c">))</span>
		<span class="w">cache_rbio</span><span class="c">(</span><span class="w">r</span><span class="pc">bio</span><span class="c">);</span>

	<span class="w">s</span><span class="pc">pin_lock_i</span><span class="c">rqsave(&amp;</span><span class="w">h</span><span class="c">-&gt;lock,</span> <span class="c">flags);</span>
	<span class="w">s</span><span class="c">pin_lock(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>

	<span class="c">if</span> <span class="pc">(!</span><span class="c">list_empty(&amp;rbio-&gt;</span><span class="w">hash_list</span><span class="pc">)) </span><span class="c">{</span>
		
		<span class="w">i</span><span class="c">f</span> <span class="c">(list_empty(&amp;</span><span class="pc">rb</span><span class="c">io-&gt;</span><span class="w">p</span><span class="c">lug_list</span><span class="w">) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
		    <span class="w">t</span><span class="c">est_bit(</span><span class="w">RBIO_CACHE_BIT</span><span class="c">, &amp;rbio-&gt;flags)) {</span>
			<span class="w">keep_cache</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
			<span class="w">c</span><span class="c">lear_bit(</span><span class="w">RBIO_RMW_LOCKED_BIT</span><span class="c">, &amp;rbio-&gt;flags);</span>
			<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">bio_list_empty</span><span class="pc">(</span><span class="c">&amp;rbio-&gt;</span><span class="w">bio_list</span><span class="pc">))</span><span class="c">;</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">d</span><span class="c">one;</span>
		<span class="c">}</span>

		<span class="w">l</span><span class="pc">ist_d</span><span class="c">el_init(&amp;rbio-&gt;</span><span class="w">hash_list</span><span class="c">);</span>
		<span class="w">atomic_dec</span><span class="c">(&amp;rbio-&gt;</span><span class="w">refs</span><span class="c">);</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="c">list_empty(&amp;rbio-&gt;</span><span class="w">plug_list</span><span class="pc">)) </span><span class="c">{</span>
			<span class="w">s</span><span class="c">truct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">n</span><span class="pc">e</span><span class="c">xt;</span>
			<span class="c">struct</span> <span class="c">list_head</span> <span class="pc">*</span><span class="w">h</span><span class="c">ead</span> <span class="pc">=</span> <span class="c">rbio-&gt;</span><span class="w">p</span><span class="c">lug_list</span><span class="pc">.</span><span class="c">next;</span>

			<span class="w">n</span><span class="c">ext</span> <span class="pc">=</span> <span class="pc">l</span><span class="c">ist_entry(head</span><span class="pc">,</span> <span class="c">struct</span> <span class="w">b</span><span class="c">trfs_raid_bio,</span>
					  <span class="pc">p</span><span class="c">lug_list</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">l</span><span class="pc">ist_del_</span><span class="c">init(&amp;rbio-&gt;</span><span class="pc">p</span><span class="c">lug_list);</span>

			<span class="w">l</span><span class="pc">ist_add</span><span class="c">(&amp;</span><span class="pc">n</span><span class="c">ext-&gt;</span><span class="w">hash_list</span><span class="c">, &amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="w">h</span><span class="pc">a</span><span class="c">sh_list);</span>
			<span class="w">a</span><span class="pc">tomic_i</span><span class="c">nc(&amp;</span><span class="w">n</span><span class="pc">e</span><span class="c">xt-&gt;</span><span class="w">refs</span><span class="c">);</span>
			<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
			<span class="w">spin_u</span><span class="pc">nlock_irqr</span><span class="c">estore(&amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">ock</span><span class="pc">,</span> <span class="c">flags);</span>

			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">n</span><span class="pc">e</span><span class="c">xt-&gt;</span><span class="w">operation</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_READ_REBUILD</span><span class="pc">)</span>
				<span class="w">async_read_rebuild</span><span class="pc">(</span><span class="w">n</span><span class="pc">ex</span><span class="c">t</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">n</span><span class="c">ext</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">o</span><span class="c">peration</span> <span class="c">==</span> <span class="w">BTRFS_RBIO_WRITE</span><span class="c">) {</span>
				<span class="w">steal_rbio</span><span class="c">(</span><span class="w">r</span><span class="pc">b</span><span class="c">io</span><span class="pc">,</span> <span class="w">ne</span><span class="c">xt</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">async_rmw_stripe</span><span class="c">(</span><span class="w">n</span><span class="pc">e</span><span class="c">xt</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(next</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">o</span><span class="c">peration</span> <span class="c">==</span> <span class="w">BTRFS_RBIO_PARITY_SCRUB</span><span class="c">) {</span>
				<span class="w">s</span><span class="pc">te</span><span class="c">al_rbio(</span><span class="pc">r</span><span class="c">bio,</span> <span class="w">n</span><span class="c">ext</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">async_scrub_parity</span><span class="c">(</span><span class="w">n</span><span class="pc">e</span><span class="c">xt);</span>
			<span class="c">}</span>

			<span class="w">g</span><span class="c">oto</span> <span class="w">done_nolock</span><span class="c">;</span>
		<span class="c">}</span> <span class="w">e</span><span class="c">lse</span>  <span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">waitqueue_active</span><span class="pc">(&amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="w">w</span><span class="pc">ait))</span><span class="c"> {</span>
			<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
			<span class="w">sp</span><span class="pc">in_unlock_</span><span class="c">irqrestore(&amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">ock,</span> <span class="c">flags);</span>
			<span class="w">wake_up</span><span class="c">(&amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="w">w</span><span class="pc">ait</span><span class="c">);</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">d</span><span class="pc">one_</span><span class="c">nolock;</span>
		<span class="c">}</span>
	<span class="c">}</span>
<span class="w">do</span><span class="pc">ne:</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_unlock(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="pc">b</span><span class="c">io_list_lock);</span>
	<span class="w">s</span><span class="pc">pin_unlock_</span><span class="c">irqrestore(&amp;</span><span class="w">h</span><span class="c">-&gt;</span><span class="pc">l</span><span class="c">ock,</span> <span class="c">flags);</span>

<span class="w">d</span><span class="pc">one_</span><span class="c">nolock</span><span class="w">:</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">keep_cache</span><span class="pc">)</span>
		<span class="w">remove_rbio_from_cache</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">)</span><span class="c">;</span>
<span class="w">}</span>

<span class="pc">s</span><span class="c">tatic</span> <span class="c">void</span> <span class="w">__free_raid_bio</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="c">i;</span>

	<span class="w">W</span><span class="c">ARN_ON</span><span class="pc">(</span><span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;rbio-&gt;</span><span class="w">refs) &lt;</span> <span class="c">0</span><span class="pc">);</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">atomic_dec_and_test</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;refs))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">W</span><span class="c">ARN_ON</span><span class="pc">(!l</span><span class="c">ist_empty(&amp;rbio-&gt;</span><span class="w">stripe_cache</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">W</span><span class="c">ARN_ON</span><span class="pc">(!</span><span class="c">list_empty(&amp;rbio-&gt;</span><span class="w">hash_list</span><span class="c">));</span>
	<span class="w">W</span><span class="c">ARN_ON</span><span class="pc">(!</span><span class="w">bio_list_empty</span><span class="c">(&amp;rbio-&gt;</span><span class="w">bio_list</span><span class="pc">));</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="c">rbio-&gt;</span><span class="w">nr</span><span class="c">_pages;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="w">stripe_pages</span><span class="c">[i</span><span class="pc">])</span><span class="c"> {</span>
			<span class="w">__free_page</span><span class="c">(rbio-&gt;stripe_pages[i</span><span class="pc">])</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">bio-&gt;</span><span class="pc">s</span><span class="c">tripe_pages[i] =</span> <span class="w">N</span><span class="c">ULL;</span>
		<span class="c">}</span>
	<span class="c">}</span>

	<span class="w">btrfs_put_bbio</span><span class="c">(rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">k</span><span class="c">free(rbio);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">free_raid_bio</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio)</span>
<span class="c">{</span>
	<span class="w">unlock_stripe</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">__free_raid_bio</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rbio_orig_end_io</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="pc">r</span><span class="c">r</span><span class="pc">,</span> <span class="c">int</span> <span class="w">uptodate</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">bi</span><span class="c">o</span> <span class="c">*</span><span class="w">cu</span><span class="pc">r</span> <span class="c">=</span> <span class="w">bio_list_get</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">bio_list</span><span class="c">);</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*</span><span class="w">n</span><span class="c">ext</span><span class="pc">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">generic_bio_cnt</span><span class="c">)</span>
		<span class="w">btrfs_bio_counter_sub</span><span class="c">(rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">,</span> <span class="c">rbio-&gt;generic_bio_cnt);</span>

	<span class="w">free_raid_bio</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">cu</span><span class="pc">r) </span><span class="c">{</span>
		<span class="w">n</span><span class="pc">ex</span><span class="c">t</span> <span class="pc">=</span> <span class="w">c</span><span class="pc">u</span><span class="c">r-&gt;</span><span class="w">bi_next</span><span class="c">;</span>
		<span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;</span><span class="pc">b</span><span class="c">i_next</span> <span class="c">=</span> <span class="w">N</span><span class="c">ULL;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">uptodate)</span>
			<span class="w">s</span><span class="c">et_bit(</span><span class="w">BIO_UPTODATE</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">cu</span><span class="pc">r</span><span class="c">-&gt;</span><span class="w">bi_flags</span><span class="c">);</span>
		<span class="w">bio_endio</span><span class="c">(</span><span class="w">cu</span><span class="pc">r</span><span class="c">,</span> <span class="w">er</span><span class="c">r);</span>
		<span class="w">cu</span><span class="c">r</span> <span class="pc">=</span> <span class="w">n</span><span class="pc">ex</span><span class="c">t</span><span class="pc">;</span>
	<span class="c">}</span>
<span class="pc">}</span>


<span class="w">s</span><span class="pc">ta</span><span class="c">tic</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">raid_write_end_io</span><span class="c">(struct</span> <span class="w">b</span><span class="pc">io</span> <span class="c">*bio</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="pc">r</span><span class="c">r)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span> <span class="c">=</span> <span class="w">bi</span><span class="pc">o</span><span class="c">-&gt;</span><span class="w">bi_private</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="w">fail_bio_stripe</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">bio_put</span><span class="c">(</span><span class="pc">b</span><span class="c">io</span><span class="pc">)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">atomic_dec_and_test</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">stripes_pending</span><span class="c">))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">at</span><span class="pc">omic_r</span><span class="c">ead(&amp;rbio-&gt;</span><span class="w">e</span><span class="pc">rro</span><span class="c">r</span><span class="w">) </span><span class="pc">&gt;</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">max_errors)</span>
		<span class="w">e</span><span class="pc">rr</span> <span class="pc">= </span><span class="c">-</span><span class="pc">EIO</span><span class="c">;</span>

	<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="pc">,</span> <span class="w">e</span><span class="c">rr</span><span class="pc">,</span> <span class="c">0);</span>
	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span><span class="w">;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="w">page_in_rbio</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio,</span>
				 <span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="c">ndex</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">pagenr</span><span class="pc">,</span> <span class="c">int</span> <span class="w">bio_list_only</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">chunk_page</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*</span><span class="w">p</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	<span class="w">c</span><span class="pc">h</span><span class="c">unk_page</span> <span class="pc">=</span> <span class="w">i</span><span class="c">ndex</span> <span class="w">*</span><span class="pc"> </span><span class="c">(rbio-&gt;</span><span class="w">stripe_len</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="c">PAGE_SHIFT</span><span class="w">)</span><span class="pc"> +</span> <span class="w">p</span><span class="c">agenr</span><span class="pc">;</span>

	<span class="w">spin_l</span><span class="pc">ock_irq</span><span class="c">(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
	<span class="w">p</span> <span class="pc">=</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bio_pages</span><span class="pc">[</span><span class="w">c</span><span class="c">hunk_page];</span>
	<span class="w">spin_u</span><span class="pc">nlock_irq</span><span class="c">(&amp;rbio-&gt;</span><span class="w">b</span><span class="pc">io_l</span><span class="c">ist_lock);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">p</span> <span class="w">|</span><span class="pc">|</span> <span class="w">bio_list_only)</span>
		<span class="pc">re</span><span class="c">turn</span> <span class="w">p</span><span class="pc">;</span>

	<span class="c">return</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripe_pages[c</span><span class="pc">h</span><span class="c">unk_page];</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">rbio_nr_pages</span><span class="c">(</span><span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">stripe_len</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">nr_stripes</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">nr</span> <span class="pc">=</span> <span class="w">s</span><span class="pc">tripe_l</span><span class="c">en</span> <span class="pc">*</span> <span class="w">n</span><span class="pc">r_</span><span class="c">stripes;</span>
	<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">DIV_ROUND_UP</span><span class="pc">(</span><span class="w">nr</span><span class="c">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">alloc_rbio</span><span class="c">(struct</span> <span class="w">btrfs_root</span> <span class="c">*</span><span class="w">r</span><span class="pc">o</span><span class="c">ot,</span>
			  <span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_bio</span> <span class="c">*</span><span class="w">bbio</span><span class="pc">,</span> <span class="w">u6</span><span class="c">4</span> <span class="w">s</span><span class="pc">tr</span><span class="c">ipe_len</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">btrfs_ra</span><span class="c">id_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">nr_data</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">int</span> <span class="w">real_stripes</span> <span class="pc">=</span> <span class="w">b</span><span class="pc">b</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">num_stripes</span> <span class="w">-</span> <span class="pc">b</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">num_tgtdevs</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">num_pages</span> <span class="c">=</span> <span class="w">rbio_nr_pages</span><span class="c">(</span><span class="w">s</span><span class="pc">tri</span><span class="c">pe_len,</span> <span class="w">r</span><span class="pc">e</span><span class="c">al_stripes</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">stripe_npages</span> <span class="pc">=</span> <span class="w">DIV_ROUND_UP</span><span class="c">(</span><span class="w">s</span><span class="pc">tripe_l</span><span class="c">en,</span> <span class="w">P</span><span class="c">AGE_SIZE);</span>
	<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p;</span>

	<span class="w">r</span><span class="pc">b</span><span class="c">io</span> <span class="pc">=</span> <span class="w">k</span><span class="pc">z</span><span class="c">alloc(sizeof(*rbio</span><span class="pc">) </span><span class="c">+</span> <span class="w">n</span><span class="pc">um_p</span><span class="c">ages</span> <span class="w">*</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof(struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="w">*) *</span> <span class="w">2</span> <span class="w">+</span>
		       <span class="w">D</span><span class="c">IV_ROUND_UP</span><span class="w">(s</span><span class="pc">tripe_n</span><span class="c">pages</span><span class="pc">,</span> <span class="w">BITS_PER_LONG</span> <span class="w">/</span> <span class="w">8)</span><span class="pc">,</span>
			<span class="w">GFP_NOFS</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!r</span><span class="c">bio</span><span class="pc">)</span>
		<span class="c">return</span> <span class="w">E</span><span class="c">RR_PTR(-</span><span class="pc">E</span><span class="c">NOMEM);</span>

	<span class="w">bio_list_init</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">bio_list</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">I</span><span class="c">NIT_LIST_HEAD(&amp;rbio-&gt;</span><span class="w">plug_list</span><span class="c">);</span>
	<span class="w">s</span><span class="pc">p</span><span class="c">in_lock_init(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
	<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;rbio-&gt;</span><span class="w">stripe_cache</span><span class="c">);</span>
	<span class="c">INIT_LIST_HEAD(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">hash_list</span><span class="c">);</span>
	<span class="w">r</span><span class="pc">b</span><span class="c">io-&gt;</span><span class="w">bbio</span> <span class="c">=</span> <span class="w">b</span><span class="c">bio;</span>
	<span class="c">rbio-&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span> <span class="pc">=</span> <span class="w">ro</span><span class="c">ot</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info;</span>
	<span class="c">rbio-&gt;</span><span class="w">stripe_len</span> <span class="c">=</span> <span class="pc">s</span><span class="c">tripe_len;</span>
	<span class="c">rbio-&gt;</span><span class="w">nr</span><span class="c">_pages</span> <span class="c">=</span> <span class="w">num_pages</span><span class="c">;</span>
	<span class="c">rbio-&gt;</span><span class="w">real_stripes</span> <span class="c">=</span> <span class="pc">re</span><span class="c">al_stripes;</span>
	<span class="c">rbio-&gt;</span><span class="w">stripe_npages</span> <span class="c">=</span> <span class="c">stripe_npages;</span>
	<span class="c">rbio-&gt;</span><span class="w">faila</span> <span class="w">= </span><span class="pc">-1</span><span class="c">;</span>
	<span class="c">rbio-&gt;</span><span class="w">failb</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>
	<span class="w">a</span><span class="c">tomic_set(&amp;rbio-&gt;</span><span class="w">refs</span><span class="c">,</span> <span class="w">1</span><span class="c">);</span>
	<span class="w">a</span><span class="c">tomic_set(&amp;rbio-&gt;</span><span class="w">e</span><span class="pc">r</span><span class="c">ror,</span> <span class="c">0);</span>
	<span class="w">a</span><span class="c">tomic_set(&amp;rbio-&gt;</span><span class="w">stripes_pending</span><span class="c">,</span> <span class="c">0);</span>

	
	<span class="w">p</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio</span> <span class="w">+</span> <span class="c">1;</span>
	<span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripe_pages</span> <span class="c">=</span> <span class="w">p</span><span class="pc">;</span>
	<span class="c">rbio-&gt;</span><span class="w">bio_pages</span> <span class="c">=</span> <span class="w">p</span> <span class="w">+</span> <span class="w">s</span><span class="pc">izeo</span><span class="c">f(</span><span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="w">*) *</span> <span class="w">num_pages</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">dbitmap</span> <span class="c">=</span> <span class="w">p</span> <span class="pc">+</span> <span class="pc">s</span><span class="c">izeof(struct</span> <span class="w">p</span><span class="c">age</span> <span class="w">*)</span><span class="pc"> </span><span class="c">*</span> <span class="pc">n</span><span class="c">um_pages</span> <span class="w">*</span> <span class="w">2</span><span class="c">;</span>

	<span class="w">i</span><span class="pc">f</span> <span class="c">(</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">map_type</span> <span class="pc">&amp;</span> <span class="w">BTRFS_BLOCK_GROUP_RAID5</span><span class="c">)</span>
		<span class="w">nr_data</span> <span class="pc">=</span> <span class="w">real_stripes</span> <span class="w">-</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="pc">b</span><span class="c">bio-&gt;</span><span class="w">m</span><span class="c">ap_type</span> <span class="pc">&amp;</span> <span class="w">BTRFS_BLOCK_GROUP_RAID6</span><span class="c">)</span>
		<span class="pc">n</span><span class="c">r_data</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">eal_stripes</span> <span class="w">-</span> <span class="w">2</span><span class="c">;</span>
	<span class="c">else</span>
		<span class="w">B</span><span class="pc">U</span><span class="c">G();</span>

	<span class="w">rbio-</span><span class="c">&gt;</span><span class="pc">n</span><span class="c">r_data</span> <span class="c">=</span> <span class="pc">n</span><span class="c">r_data;</span>
	<span class="w">r</span><span class="pc">et</span><span class="c">urn</span> <span class="w">r</span><span class="pc">b</span><span class="c">io;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">alloc_rbio_pages</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">r</span><span class="pc">b</span><span class="c">io)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*page;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="c">rbio-&gt;</span><span class="w">n</span><span class="pc">r_p</span><span class="c">ages;</span> <span class="c">i++) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripe_pages</span><span class="c">[i</span><span class="pc">])</span>
			<span class="pc">c</span><span class="c">ontinue;</span>
		<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">alloc_page</span><span class="c">(</span><span class="w">GFP_NOFS</span> <span class="w">|</span> <span class="w">__GFP_HIGHMEM</span><span class="c">);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span>
			<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>
		<span class="w">r</span><span class="pc">b</span><span class="c">io-&gt;stripe_pages</span><span class="pc">[</span><span class="c">i</span><span class="pc">] </span><span class="c">=</span> <span class="w">p</span><span class="c">age;</span>
		<span class="w">ClearPageUptodate</span><span class="c">(</span><span class="pc">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">alloc_rbio_parity_pages</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">r</span><span class="c">bio)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*page;</span>

	<span class="w">i</span> <span class="w">=</span><span class="pc"> (r</span><span class="c">bio-&gt;</span><span class="w">nr_data</span> <span class="w">*</span> <span class="pc">r</span><span class="c">bio</span><span class="w">-</span><span class="c">&gt;</span><span class="w">stripe_len)</span><span class="pc"> &gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="w">(;</span> <span class="c">i</span> <span class="w">&lt;</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr</span><span class="pc">_p</span><span class="c">ages;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="w">stripe_pages</span><span class="c">[i</span><span class="w">])</span>
			<span class="pc">c</span><span class="c">ontinue;</span>
		<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">alloc_page</span><span class="c">(</span><span class="w">GFP_NOFS</span> <span class="w">|</span> <span class="w">__GFP_HIGHMEM</span><span class="c">);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span>
			<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>
		<span class="pc">r</span><span class="c">bio-&gt;stripe_pages</span><span class="pc">[</span><span class="c">i</span><span class="pc">] </span><span class="c">=</span> <span class="w">p</span><span class="c">age;</span>
	<span class="c">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">rbio_add_io_page</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">r</span><span class="c">bio</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">bio_list</span> <span class="c">*</span><span class="w">b</span><span class="pc">i</span><span class="c">o_list</span><span class="pc">,</span>
			    <span class="c">struct</span> <span class="w">p</span><span class="c">age</span> <span class="c">*page</span><span class="pc">,</span>
			    <span class="pc">i</span><span class="c">nt</span> <span class="w">stripe_nr</span><span class="pc">,</span>
			    <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">page_index</span><span class="c">,</span>
			    <span class="c">unsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">bio_max_len</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">io</span> <span class="c">*</span><span class="w">la</span><span class="pc">s</span><span class="c">t</span> <span class="c">=</span> <span class="pc">bi</span><span class="c">o_list</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">ta</span><span class="pc">i</span><span class="c">l;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">last_end</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">r</span><span class="c">et</span><span class="pc">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">b</span><span class="pc">io</span> <span class="c">*</span><span class="w">b</span><span class="pc">io</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_bio_stripe</span> <span class="c">*</span><span class="w">stripe</span><span class="c">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">disk_start</span><span class="c">;</span>

	<span class="w">s</span><span class="pc">tri</span><span class="c">pe</span> <span class="w">=</span><span class="pc"> &amp;</span><span class="w">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">stripes</span><span class="pc">[</span><span class="w">stripe_nr</span><span class="c">];</span>
	<span class="w">d</span><span class="c">isk_start</span> <span class="pc">=</span> <span class="c">stripe-&gt;</span><span class="w">physical</span> <span class="w">+</span><span class="pc"> </span><span class="c">(</span><span class="w">page_index</span> <span class="c">&lt;&lt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">);</span>

	
	<span class="c">if</span> <span class="pc">(!s</span><span class="c">tripe-&gt;</span><span class="w">d</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">b</span><span class="pc">d</span><span class="c">ev</span><span class="w">)</span>
		<span class="c">return</span> <span class="w">fail_rbio_index</span><span class="pc">(r</span><span class="c">bio</span><span class="pc">,</span> <span class="pc">st</span><span class="c">ripe_nr</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">la</span><span class="pc">s</span><span class="c">t</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">last_end</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">u6</span><span class="c">4</span><span class="pc">)</span><span class="w">la</span><span class="pc">st-</span><span class="c">&gt;</span><span class="w">bi_iter.bi_sector</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">9</span><span class="pc">;</span>
		<span class="pc">l</span><span class="c">ast_end</span> <span class="w">+</span><span class="pc">=</span> <span class="w">la</span><span class="pc">st-</span><span class="c">&gt;bi_iter.</span><span class="w">bi_size</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">l</span><span class="c">ast_end</span> <span class="pc">=</span><span class="c">=</span> <span class="w">disk_start</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="w">stripe</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bd</span><span class="c">ev</span> <span class="w">&amp;</span><span class="c">&amp;</span>
		    <span class="w">te</span><span class="pc">s</span><span class="c">t_bit(</span><span class="w">BIO_UPTODATE</span><span class="c">, &amp;</span><span class="w">la</span><span class="pc">st</span><span class="c">-&gt;</span><span class="w">bi_flags) </span><span class="pc">&amp;</span><span class="c">&amp;</span>
		    <span class="w">la</span><span class="pc">st</span><span class="c">-&gt;</span><span class="w">bi_bdev</span> <span class="c">==</span> <span class="w">s</span><span class="c">tripe-&gt;</span><span class="w">d</span><span class="pc">e</span><span class="c">v-&gt;</span><span class="w">bd</span><span class="c">ev</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">bio_add_page</span><span class="c">(</span><span class="w">la</span><span class="pc">st</span><span class="c">,</span> <span class="w">pa</span><span class="c">ge</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">,</span> <span class="c">0);</span>
			<span class="c">if</span> <span class="c">(ret</span> <span class="pc">=</span><span class="c">=</span> <span class="w">P</span><span class="c">AGE_CACHE_SIZE</span><span class="pc">)</span>
				<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="w">}</span>

	
	<span class="w">bi</span><span class="pc">o</span> <span class="c">=</span> <span class="w">btrfs_io_bio_alloc</span><span class="c">(</span><span class="w">GFP_NOFS</span><span class="pc">,</span> <span class="w">bio_max_len</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">P</span><span class="c">AGE_SHIFT</span><span class="w">?:</span><span class="pc">1)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="w">bi</span><span class="pc">o)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">ENOM</span><span class="c">EM;</span>

	<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_iter</span><span class="pc">.</span><span class="w">bi_size</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_bdev</span> <span class="c">=</span> <span class="w">stripe</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">d</span><span class="pc">e</span><span class="c">v</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bd</span><span class="c">ev</span><span class="pc">;</span>
	<span class="pc">b</span><span class="c">io-&gt;</span><span class="pc">bi_</span><span class="c">iter</span><span class="pc">.</span><span class="w">bi_sector</span> <span class="c">=</span> <span class="w">disk_start</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">9</span><span class="c">;</span>
	<span class="w">set</span><span class="pc">_</span><span class="c">bit(</span><span class="w">BIO_UPTODATE</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bi</span><span class="pc">o</span><span class="c">-&gt;</span><span class="w">bi_flags</span><span class="c">);</span>

	<span class="w">bio_add_page</span><span class="c">(</span><span class="pc">bio,</span> <span class="w">p</span><span class="pc">ag</span><span class="c">e</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">,</span> <span class="c">0</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">bio_list_add</span><span class="c">(</span><span class="w">bio_list</span><span class="c">,</span> <span class="w">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">validate_rbio_for_rmw</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(rbio-&gt;</span><span class="w">faila</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="c">0</span> <span class="w">|</span><span class="c">|</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">failb</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="pc">0) </span><span class="c">{</span>
		<span class="w">B</span><span class="c">UG_ON(rbio-&gt;faila</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">real_stripes</span> <span class="w">-</span> <span class="c">1</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">__raid56_parity_recover</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">finish_rmw</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="w">rbio_stripe_page</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">stripe</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex;</span>
	<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">=</span> <span class="c">stripe</span> <span class="w">*</span><span class="pc"> </span><span class="c">(rbio-&gt;</span><span class="w">stripe_len</span> <span class="w">&gt;</span><span class="pc">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">nd</span><span class="c">ex</span> <span class="pc">+</span><span class="c">=</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">r</span><span class="pc">b</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_pages</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex];</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">index_rbio_pages</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*</span><span class="w">b</span><span class="pc">i</span><span class="c">o</span><span class="pc">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">s</span><span class="c">tart;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="w">stripe_offset</span><span class="c">;</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="c">long</span> <span class="w">page_index</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*</span><span class="w">p</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">i;</span>

	<span class="w">sp</span><span class="pc">in_lock_irq</span><span class="c">(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
	<span class="w">bio_list_for_each</span><span class="c">(</span><span class="w">b</span><span class="pc">io, </span><span class="c">&amp;</span><span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bio_list)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">st</span><span class="pc">ar</span><span class="c">t</span> <span class="w">=</span><span class="pc"> (</span><span class="w">u</span><span class="c">64</span><span class="pc">)</span><span class="w">bi</span><span class="pc">o</span><span class="c">-&gt;</span><span class="w">bi_iter</span><span class="pc">.</span><span class="w">bi_sector</span> <span class="w">&lt;</span><span class="pc">&lt;</span> <span class="w">9</span><span class="pc">;</span>
		<span class="w">s</span><span class="pc">tri</span><span class="c">pe_offset</span> <span class="c">=</span> <span class="w">s</span><span class="pc">t</span><span class="c">art</span> <span class="w">-</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bbio-</span><span class="pc">&gt;</span><span class="w">raid_map[</span><span class="c">0];</span>
		<span class="w">page_index</span> <span class="c">=</span> <span class="pc">s</span><span class="c">tripe_offset</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>

		<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bi_vcnt</span><span class="c">;</span> <span class="c">i++) {</span>
			<span class="w">p</span> <span class="pc">=</span> <span class="w">bio</span><span class="c">-&gt;</span><span class="w">bi_io_vec</span><span class="c">[i</span><span class="pc">].</span><span class="w">bv_page</span><span class="pc">;</span>
			<span class="w">r</span><span class="c">bio-&gt;</span><span class="w">bio_pages</span><span class="pc">[</span><span class="w">p</span><span class="c">age_index</span> <span class="w">+</span> <span class="pc">i] </span><span class="c">=</span> <span class="w">p</span><span class="pc">;</span>
		<span class="c">}</span>
	<span class="c">}</span>
	<span class="w">spin_u</span><span class="pc">nlock_irq</span><span class="c">(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="w">noinline</span> <span class="w">v</span><span class="c">oid</span> <span class="w">finish_rmw</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_bio</span> <span class="c">*</span><span class="w">bbio</span> <span class="c">=</span> <span class="c">rbio-&gt;bbio;</span>
	<span class="w">v</span><span class="c">oid</span> <span class="pc">*</span><span class="w">pointers[r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="c">];</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">stripe_len</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio-&gt;stripe_len;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">nr_data</span> <span class="c">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="pc">n</span><span class="c">r_data;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">stripe</span><span class="pc">;</span>
	<span class="c">int</span> <span class="w">pagenr</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">p_stripe</span> <span class="w">=</span><span class="pc"> </span><span class="c">-1;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">q_stripe</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bio_list</span> <span class="pc">b</span><span class="c">io_list;</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">io</span> <span class="c">*bio;</span>
	<span class="c">int</span> <span class="w">pages_per_stripe</span> <span class="pc">=</span> <span class="w">s</span><span class="c">tripe_len</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>

	<span class="w">bio_list_init</span><span class="pc">(&amp;</span><span class="w">b</span><span class="pc">i</span><span class="c">o_list</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rbio-</span><span class="c">&gt;</span><span class="w">real_stripes</span> <span class="w">-</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr_data</span> <span class="w">=</span><span class="pc">=</span> <span class="pc">1) </span><span class="c">{</span>
		<span class="w">p_stripe</span> <span class="pc">=</span> <span class="c">rbio-&gt;</span><span class="pc">r</span><span class="c">eal_stripes</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="pc">i</span><span class="c">f</span> <span class="c">(rbio-&gt;real_stripes</span> <span class="w">-</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;nr_data</span> <span class="w">=</span><span class="pc">=</span> <span class="w">2</span><span class="c">) {</span>
		<span class="pc">p</span><span class="c">_stripe</span> <span class="pc">=</span> <span class="c">rbio-&gt;real_stripes</span> <span class="w">-</span> <span class="pc">2</span><span class="c">;</span>
		<span class="w">q_stripe</span> <span class="c">=</span> <span class="c">rbio-&gt;</span><span class="pc">re</span><span class="c">al_stripes</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">B</span><span class="c">UG();</span>
	<span class="c">}</span>

	
	<span class="w">spin_l</span><span class="pc">ock_irq</span><span class="c">(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
	<span class="w">se</span><span class="pc">t_</span><span class="c">bit(</span><span class="w">RBIO_RMW_LOCKED_BIT</span><span class="c">, &amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags);</span>
	<span class="w">sp</span><span class="pc">in_unlock_i</span><span class="c">rq(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="pc">b</span><span class="c">io_list_lock);</span>

	<span class="w">a</span><span class="c">tomic_set(&amp;rbio-&gt;</span><span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="pc">,</span> <span class="c">0);</span>

	
	<span class="w">index_rbio_pages</span><span class="pc">(</span><span class="c">rbio);</span>
	<span class="w">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">rbio_is_full</span><span class="pc">(</span><span class="c">rbio</span><span class="w">)</span><span class="pc">)</span>
		<span class="w">cache_rbio_pages</span><span class="c">(rbio);</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">cl</span><span class="pc">ear</span><span class="c">_bit(</span><span class="w">RBIO_CACHE_READY_BIT</span><span class="c">, &amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags);</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">pagenr</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">p</span><span class="c">agenr</span> <span class="c">&lt;</span> <span class="w">pages_per_stripe</span><span class="c">;</span> <span class="pc">p</span><span class="c">agenr++) {</span>
		<span class="c">struct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*</span><span class="w">p</span><span class="c">;</span>
		
		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">stripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">s</span><span class="c">tripe</span> <span class="c">&lt;</span> <span class="w">nr_data</span><span class="c">;</span> <span class="pc">s</span><span class="c">tripe++) {</span>
			<span class="w">p</span> <span class="pc">=</span> <span class="w">page_in_rbio</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="c">stripe,</span> <span class="pc">pa</span><span class="c">genr,</span> <span class="w">0</span><span class="c">);</span>
			<span class="w">pointers[</span><span class="c">stripe</span><span class="pc">] </span><span class="c">=</span> <span class="w">kmap</span><span class="c">(</span><span class="w">p</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>

		
		<span class="w">p</span> <span class="pc">=</span> <span class="w">rbio_pstripe_page</span><span class="c">(</span><span class="w">r</span><span class="c">bio,</span> <span class="pc">pagen</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">SetPageUptodate</span><span class="c">(</span><span class="pc">p)</span><span class="c">;</span>
		<span class="w">p</span><span class="pc">o</span><span class="c">inters</span><span class="pc">[s</span><span class="c">tripe</span><span class="pc">+</span><span class="c">+] =</span> <span class="pc">k</span><span class="c">map</span><span class="pc">(p</span><span class="c">);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">q_stripe</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>

			
			<span class="pc">p</span> <span class="pc">=</span> <span class="w">rbio_qstripe_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="pc">pa</span><span class="c">genr</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">S</span><span class="c">etPageUptodate(p</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">p</span><span class="c">ointers</span><span class="w">[</span><span class="c">stripe</span><span class="w">+</span><span class="pc">+</span><span class="c">] =</span> <span class="c">kmap(</span><span class="pc">p</span><span class="c">);</span>

			<span class="w">raid6_call.gen_syndrome</span><span class="pc">(r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="pc">,</span> <span class="w">P</span><span class="c">AGE_SIZE</span><span class="pc">,</span>
						<span class="w">p</span><span class="pc">o</span><span class="c">inters);</span>
		<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
			
			<span class="w">m</span><span class="c">emcpy(pointers</span><span class="pc">[</span><span class="w">nr_data</span><span class="pc">],</span> <span class="pc">p</span><span class="c">ointers</span><span class="w">[</span><span class="c">0],</span> <span class="w">P</span><span class="c">AGE_SIZE);</span>
			<span class="w">run_xor</span><span class="c">(pointers</span> <span class="w">+</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">n</span><span class="c">r_data</span> <span class="w">-</span> <span class="c">1</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>
		<span class="c">}</span>


		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">stripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">stripe</span> <span class="c">&lt;</span> <span class="w">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="pc">s</span><span class="c">tripe</span><span class="pc">++)</span>
			<span class="w">kunmap</span><span class="c">(</span><span class="w">page_in_rbio(r</span><span class="pc">b</span><span class="c">io,</span> <span class="pc">s</span><span class="c">tripe</span><span class="pc">,</span> <span class="w">pagenr</span><span class="pc">,</span> <span class="pc">0))</span><span class="c">;</span>
	<span class="pc">}</span>

	
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="pc">s</span><span class="c">tripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">s</span><span class="c">tripe</span> <span class="c">&lt;</span> <span class="w">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">r</span><span class="c">eal_stripes;</span> <span class="pc">s</span><span class="c">tripe++) {</span>
		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">p</span><span class="pc">agen</span><span class="c">r</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">p</span><span class="c">agenr</span> <span class="c">&lt;</span> <span class="w">pages_per_stripe</span><span class="c">;</span> <span class="w">p</span><span class="pc">agen</span><span class="c">r++) {</span>
			<span class="pc">s</span><span class="c">truct</span> <span class="w">pa</span><span class="pc">ge</span> <span class="c">*</span><span class="pc">page</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(stripe</span> <span class="w">&lt;</span> <span class="w">r</span><span class="pc">b</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr_data</span><span class="c">) {</span>
				<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">page_in_rbio</span><span class="c">(rbio</span><span class="pc">,</span> <span class="pc">s</span><span class="c">tripe</span><span class="pc">,</span> <span class="w">p</span><span class="pc">agen</span><span class="c">r</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
				<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">p</span><span class="pc">age)</span>
					<span class="pc">c</span><span class="c">ontinue;</span>
			<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			       <span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="pc">s</span><span class="c">tripe,</span> <span class="w">p</span><span class="pc">agen</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">}</span>

			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">rbio_add_io_page</span><span class="c">(rbio</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bio_list</span><span class="c">,</span>
				       <span class="w">p</span><span class="pc">age</span><span class="c">,</span> <span class="pc">s</span><span class="c">tripe,</span> <span class="pc">p</span><span class="c">agenr,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(ret)</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="pc">c</span><span class="c">leanup;</span>
		<span class="c">}</span>
	<span class="w">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">l</span><span class="pc">ik</span><span class="c">ely</span><span class="pc">(!</span><span class="w">bbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">num_tgtdevs</span><span class="pc">))</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">write_data</span><span class="c">;</span>

	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">st</span><span class="pc">ripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">s</span><span class="c">tripe</span> <span class="pc">&lt;</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="pc">s</span><span class="c">tripe++) {</span>
		<span class="c">if</span> <span class="pc">(!b</span><span class="c">bio-&gt;</span><span class="w">tgtdev_map</span><span class="c">[</span><span class="pc">s</span><span class="c">tripe</span><span class="pc">])</span>
			<span class="pc">c</span><span class="c">ontinue;</span>

		<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">pagenr</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">p</span><span class="c">agenr</span> <span class="c">&lt;</span> <span class="w">pages_per_stripe</span><span class="c">;</span> <span class="pc">p</span><span class="c">agenr++) {</span>
			<span class="c">struct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*</span><span class="pc">page</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">s</span><span class="c">tripe</span> <span class="pc">&lt;</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr_data</span><span class="c">) {</span>
				<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">page_in_rbio</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="pc">s</span><span class="c">tripe</span><span class="pc">,</span> <span class="w">p</span><span class="c">agenr</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
				<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">p</span><span class="pc">age)</span>
					<span class="pc">c</span><span class="c">ontinue;</span>
			<span class="pc">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			       <span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="pc">s</span><span class="c">tripe,</span> <span class="w">p</span><span class="pc">agen</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">}</span>

			<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">rbio_add_io_page</span><span class="c">(rbio</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bio_list</span><span class="c">,</span> <span class="w">p</span><span class="pc">age</span><span class="c">,</span>
					       <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">tgtdev_map[s</span><span class="c">tripe</span><span class="pc">],</span>
					       <span class="pc">p</span><span class="c">agenr,</span> <span class="c">rbio-&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span><span class="pc">)</span>
				<span class="pc">g</span><span class="c">oto</span> <span class="w">c</span><span class="c">leanup;</span>
		<span class="c">}</span>
	<span class="w">}</span>

<span class="w">write_data:</span>
	<span class="w">at</span><span class="pc">omic_s</span><span class="c">et(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripes_pending</span><span class="c">,</span> <span class="w">bio_list_size(</span><span class="pc">&amp;bi</span><span class="c">o_list</span><span class="pc">))</span><span class="c">;</span>
	<span class="w">B</span><span class="c">UG_ON(</span><span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="pc">s</span><span class="c">tripes_pending</span><span class="w">) </span><span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="w">)</span><span class="pc">;</span>

	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="pc">1</span><span class="c">) {</span>
		<span class="w">bi</span><span class="pc">o</span> <span class="pc">=</span> <span class="w">bio_list_pop</span><span class="pc">(&amp;b</span><span class="c">io_list</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">bi</span><span class="pc">o)</span>
			<span class="pc">b</span><span class="c">reak;</span>

		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_private</span> <span class="c">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">;</span>
		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_end_io</span> <span class="c">=</span> <span class="w">raid_write_end_io</span><span class="c">;</span>
		<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">BIO_UPTODATE</span><span class="c">, &amp;</span><span class="pc">b</span><span class="c">io-&gt;</span><span class="w">bi_flags))</span><span class="pc">;</span>
		<span class="w">submit_bio</span><span class="c">(</span><span class="w">WRITE</span><span class="c">,</span> <span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">r</span><span class="c">eturn</span><span class="w">;</span>

<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>
	<span class="w">rbio_orig_end_io</span><span class="c">(</span><span class="w">r</span><span class="c">bio</span><span class="w">, -E</span><span class="pc">I</span><span class="c">O</span><span class="pc">,</span> <span class="c">0);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">find_bio_stripe</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">r</span><span class="pc">bio</span><span class="c">,</span>
			   <span class="c">struct</span> <span class="pc">b</span><span class="c">io</span> <span class="c">*bio)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">physical</span> <span class="c">=</span> <span class="w">b</span><span class="pc">io-</span><span class="c">&gt;</span><span class="w">bi_iter</span><span class="pc">.</span><span class="w">bi_sector</span><span class="c">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">stripe_start</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">i</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_bio_stripe</span> <span class="c">*</span><span class="w">stripe</span><span class="c">;</span>

	<span class="w">p</span><span class="c">hysical</span> <span class="w">&lt;</span><span class="c">&lt;=</span> <span class="w">9</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="pc">&gt;</span><span class="w">num_stripes</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">s</span><span class="pc">tri</span><span class="c">pe</span> <span class="pc">= </span><span class="c">&amp;</span><span class="pc">r</span><span class="c">bio-&gt;bbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripes</span><span class="pc">[</span><span class="c">i];</span>
		<span class="w">s</span><span class="pc">tripe_</span><span class="c">start</span> <span class="pc">=</span> <span class="c">stripe-&gt;</span><span class="pc">p</span><span class="c">hysical</span><span class="pc">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="c">hysical</span> <span class="w">&gt;</span><span class="c">=</span> <span class="pc">s</span><span class="c">tripe_start</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
		    <span class="pc">p</span><span class="c">hysical</span> <span class="w">&lt;</span> <span class="c">stripe_start</span> <span class="pc">+</span> <span class="w">r</span><span class="c">bio-&gt;</span><span class="w">stripe_len</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
		    <span class="w">bi</span><span class="c">o-&gt;</span><span class="w">bi_bdev</span> <span class="pc">=</span><span class="c">=</span> <span class="w">s</span><span class="pc">tripe</span><span class="c">-&gt;</span><span class="w">de</span><span class="pc">v</span><span class="c">-&gt;</span><span class="w">bd</span><span class="c">ev</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="w">i</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="pc">-1</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">find_logical_bio_stripe</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio,</span>
				   <span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*bio)</span>
<span class="c">{</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">logical</span> <span class="c">=</span> <span class="w">b</span><span class="pc">io-</span><span class="c">&gt;</span><span class="w">bi_iter.bi_sector</span><span class="c">;</span>
	<span class="w">u6</span><span class="c">4</span> <span class="w">stripe_start</span><span class="pc">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i</span><span class="c">;</span>

	<span class="w">l</span><span class="c">ogical</span> <span class="w">&lt;&lt;</span><span class="pc">=</span> <span class="w">9</span><span class="c">;</span>

	<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">r</span><span class="c">bio-&gt;</span><span class="w">nr_data</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">s</span><span class="pc">tri</span><span class="c">pe_start</span> <span class="c">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">raid_map</span><span class="c">[i];</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">l</span><span class="c">ogical</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="w">s</span><span class="c">tripe_start</span> <span class="w">&amp;</span><span class="pc">&amp;</span>
		    <span class="c">logical</span> <span class="w">&lt;</span> <span class="pc">s</span><span class="c">tripe_start</span> <span class="pc">+</span> <span class="w">r</span><span class="pc">b</span><span class="c">io-&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c"> {</span>
			<span class="w">r</span><span class="pc">e</span><span class="c">turn</span> <span class="pc">i</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>
	<span class="w">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="w">1</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">fail_rbio_index</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="pc">f</span><span class="c">lags;</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="c">ret</span> <span class="pc">=</span> <span class="c">0;</span>

	<span class="w">sp</span><span class="pc">in_lock_</span><span class="c">irqsave(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">,</span> <span class="c">flags);</span>

	
	<span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="w">faila</span> <span class="pc">=</span><span class="c">=</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d</span> <span class="w">|</span><span class="c">|</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">failb</span> <span class="c">==</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(rbio-&gt;</span><span class="pc">f</span><span class="c">aila</span> <span class="w">=</span><span class="pc">= -</span><span class="c">1) {</span>
		
		<span class="c">rbio-&gt;</span><span class="pc">faila</span> <span class="c">=</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d;</span>
		<span class="w">a</span><span class="c">tomic_inc(&amp;rbio-&gt;</span><span class="w">e</span><span class="pc">r</span><span class="c">ror);</span>
	<span class="pc">}</span> <span class="c">else</span> <span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="pc">f</span><span class="c">ailb</span> <span class="w">=</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="c">rbio-&gt;</span><span class="pc">failb</span> <span class="c">=</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d;</span>
		<span class="w">a</span><span class="c">tomic_inc(&amp;rbio-&gt;</span><span class="w">e</span><span class="pc">r</span><span class="c">ror);</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">r</span><span class="pc">et</span> <span class="pc">= </span><span class="c">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>
	<span class="c">}</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="w">s</span><span class="c">pin_unlock_irqrestore(&amp;rbio-&gt;</span><span class="w">bio_list_lock</span><span class="c">,</span> <span class="c">flags);</span>

	<span class="pc">re</span><span class="c">turn</span> <span class="pc">r</span><span class="c">et;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">fail_bio_stripe</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">,</span>
			   <span class="c">struct</span> <span class="w">b</span><span class="pc">io</span> <span class="c">*bio)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d</span> <span class="c">=</span> <span class="w">find_bio_stripe</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">,</span> <span class="w">b</span><span class="pc">io)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">fa</span><span class="pc">ile</span><span class="c">d</span> <span class="c">&lt;</span> <span class="c">0)</span>
		<span class="c">return</span> <span class="c">-EIO;</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="w">fail_rbio_index</span><span class="pc">(</span><span class="c">rbio,</span> <span class="w">fa</span><span class="pc">ile</span><span class="c">d</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">set_bio_pages_uptodate</span><span class="c">(struct</span> <span class="w">b</span><span class="c">io</span> <span class="c">*bio)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="pc">i</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*</span><span class="w">p</span><span class="c">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="w">bi</span><span class="pc">o-</span><span class="c">&gt;</span><span class="w">bi_vcnt</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="w">p</span> <span class="pc">=</span> <span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_io_vec</span><span class="c">[i</span><span class="pc">].</span><span class="w">bv_page</span><span class="pc">;</span>
		<span class="w">SetPageUptodate</span><span class="c">(</span><span class="pc">p)</span><span class="c">;</span>
	<span class="c">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">raid_rmw_end_io</span><span class="c">(struct</span> <span class="w">b</span><span class="pc">io</span> <span class="c">*bio</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="pc">r</span><span class="c">r)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span> <span class="c">=</span> <span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_private</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="w">fail_bio_stripe</span><span class="c">(rbio,</span> <span class="w">b</span><span class="pc">io)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">set_bio_pages_uptodate</span><span class="c">(</span><span class="pc">bi</span><span class="c">o</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">bio_put</span><span class="c">(bio);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">atomic_dec_and_test</span><span class="pc">(&amp;r</span><span class="c">bio-&gt;</span><span class="w">stripes_pending</span><span class="c">))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">a</span><span class="pc">tomic_r</span><span class="c">ead(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">e</span><span class="c">rror</span><span class="w">) </span><span class="pc">&gt;</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="pc">&gt;</span><span class="w">max_errors)</span>
		<span class="c">goto</span> <span class="w">cl</span><span class="pc">e</span><span class="c">anup;</span>

	
	<span class="w">validate_rbio_for_rmw</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>

<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>

	<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="w">, -EI</span><span class="pc">O,</span> <span class="c">0);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">async_rmw_stripe</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio)</span>
<span class="c">{</span>
	<span class="w">btrfs_init_work</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">w</span><span class="c">ork</span><span class="pc">,</span> <span class="w">btrfs_rmw_helper</span><span class="pc">,</span>
			<span class="w">rmw_work</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL);</span>

	<span class="w">btrfs_queue_work</span><span class="c">(rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">rmw_workers</span><span class="c">,</span>
			 <span class="pc">&amp;r</span><span class="c">bio-&gt;</span><span class="w">wo</span><span class="pc">rk)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">async_read_rebuild</span><span class="c">(struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="w">b</span><span class="c">trfs_init_work</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">w</span><span class="c">ork,</span> <span class="pc">b</span><span class="c">trfs_rmw_helper</span><span class="pc">,</span>
			<span class="w">read_rebuild_work</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">NULL);</span>

	<span class="w">b</span><span class="c">trfs_queue_work</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="w">-</span><span class="c">&gt;</span><span class="w">r</span><span class="pc">m</span><span class="c">w_workers,</span>
			 <span class="w">&amp;</span><span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w</span><span class="pc">o</span><span class="c">rk</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">raid56_rmw_stripe</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">bios_to_read</span> <span class="pc">=</span> <span class="pc">0</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bio_list</span> <span class="pc">b</span><span class="c">io_list;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">nr</span><span class="c">_pages</span> <span class="pc">=</span> <span class="w">DIV_ROUND_UP</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">pagenr</span><span class="pc">;</span>
	<span class="c">int</span> <span class="w">stripe</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bi</span><span class="pc">o</span> <span class="c">*</span><span class="w">b</span><span class="pc">io</span><span class="c">;</span>

	<span class="w">bio_list_init</span><span class="pc">(&amp;bio_</span><span class="c">list</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">alloc_rbio_pages</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">c</span><span class="pc">l</span><span class="c">eanup;</span>

	<span class="w">index_rbio_pages</span><span class="pc">(</span><span class="c">rbio);</span>

	<span class="w">a</span><span class="pc">t</span><span class="c">omic_set(&amp;rbio-&gt;</span><span class="w">er</span><span class="pc">ro</span><span class="c">r</span><span class="pc">,</span> <span class="c">0);</span>
	
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">s</span><span class="pc">t</span><span class="c">ripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">s</span><span class="c">tripe</span> <span class="c">&lt;</span> <span class="c">rbio-&gt;</span><span class="w">nr_data</span><span class="c">;</span> <span class="pc">s</span><span class="c">tripe++) {</span>
		<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(</span><span class="w">pagenr</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">pagenr</span> <span class="c">&lt;</span> <span class="w">nr</span><span class="pc">_p</span><span class="c">ages;</span> <span class="c">pagenr++) {</span>
			<span class="c">struct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*page;</span>
			
			<span class="w">p</span><span class="pc">age</span> <span class="c">=</span> <span class="w">page_in_rbio</span><span class="c">(</span><span class="w">r</span><span class="c">bio,</span> <span class="c">stripe</span><span class="pc">,</span> <span class="w">p</span><span class="c">agenr</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">p</span><span class="pc">age</span><span class="w">)</span>
				<span class="w">c</span><span class="c">ontinue;</span>

			<span class="w">p</span><span class="pc">age</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="pc">s</span><span class="c">tripe,</span> <span class="pc">pagen</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
			
			<span class="c">if</span> <span class="c">(</span><span class="w">PageUptodate</span><span class="pc">(p</span><span class="c">age</span><span class="pc">))</span>
				<span class="pc">c</span><span class="c">ontinue;</span>

			<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">rbio_add_io_page</span><span class="c">(rbio</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bio_list</span><span class="pc">,</span> <span class="w">p</span><span class="pc">age</span><span class="c">,</span>
				       <span class="w">s</span><span class="c">tripe,</span> <span class="pc">p</span><span class="c">agenr,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(ret)</span>
				<span class="c">goto</span> <span class="w">c</span><span class="c">leanup;</span>
		<span class="c">}</span>
	<span class="w">}</span>

	<span class="w">bios_to_read</span> <span class="pc">=</span> <span class="w">bio_list_size</span><span class="pc">(&amp;b</span><span class="c">io_list</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">bios_to_read) {</span>
		
		<span class="w">g</span><span class="c">oto</span> <span class="w">finish</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">a</span><span class="pc">tomic_s</span><span class="c">et(&amp;</span><span class="w">r</span><span class="c">bio-&gt;</span><span class="w">stripes_pending</span><span class="c">,</span> <span class="pc">b</span><span class="c">ios_to_read</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="pc">1</span><span class="c">) {</span>
		<span class="w">bi</span><span class="pc">o</span> <span class="pc">=</span> <span class="w">bio_list_pop</span><span class="pc">(&amp;bio_</span><span class="c">list</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">io)</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>

		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_private</span> <span class="c">=</span> <span class="c">rbio;</span>
		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_end_io</span> <span class="c">=</span> <span class="w">raid_rmw_end_io</span><span class="c">;</span>

		<span class="w">btrfs_bio_wq_end_io</span><span class="pc">(r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info,</span> <span class="pc">bio</span><span class="c">,</span>
				    <span class="w">BTRFS_WQ_ENDIO_RAID56</span><span class="c">);</span>

		<span class="w">B</span><span class="pc">U</span><span class="c">G_ON</span><span class="pc">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">BIO_UPTODATE</span><span class="c">, &amp;bio-&gt;</span><span class="w">bi_flags))</span><span class="pc">;</span>
		<span class="w">submit_bio</span><span class="c">(</span><span class="w">READ</span><span class="c">,</span> <span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	
	<span class="w">r</span><span class="c">eturn</span> <span class="c">0;</span>

<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>
	<span class="w">rbio_orig_end_io</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="w">, </span><span class="pc">-</span><span class="w">EI</span><span class="c">O,</span> <span class="c">0);</span>
	<span class="pc">re</span><span class="c">turn</span> <span class="pc">-</span><span class="c">EIO;</span>

<span class="w">finish</span><span class="pc">:</span>
	<span class="w">validate_rbio_for_rmw</span><span class="c">(</span><span class="w">r</span><span class="pc">bio)</span><span class="c">;</span>
	<span class="c">return</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">full_stripe_write</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">ret</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">alloc_rbio_parity_pages</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">__free_raid_bio</span><span class="c">(</span><span class="pc">r</span><span class="c">bio);</span>
		<span class="c">return</span> <span class="c">ret;</span>
	<span class="c">}</span>

	<span class="pc">ret</span> <span class="c">=</span> <span class="w">lock_stripe_add</span><span class="c">(</span><span class="pc">r</span><span class="c">bio);</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
		<span class="w">finish_rmw</span><span class="c">(</span><span class="pc">rb</span><span class="c">io</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">retu</span><span class="c">rn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">partial_stripe_write</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">l</span><span class="c">ock_stripe_add(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0)</span>
		<span class="w">async_rmw_stripe</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">int</span> <span class="w">__raid56_parity_write</span><span class="c">(struct</span> <span class="w">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">rbio_is_full</span><span class="c">(rbio))</span>
		<span class="c">return</span> <span class="w">partial_stripe_write</span><span class="c">(</span><span class="pc">rbio</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="w">full_stripe_write</span><span class="c">(rbio);</span>
<span class="c">}</span>


<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="w">btrfs_plug_cb</span> <span class="pc">{</span>
	<span class="c">struct</span> <span class="w">blk_plug_cb</span> <span class="w">cb</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">btrfs_fs_info</span> <span class="c">*</span><span class="w">i</span><span class="pc">nf</span><span class="c">o;</span>
	<span class="c">struct</span> <span class="pc">l</span><span class="c">ist_head</span> <span class="w">rbio_list</span><span class="c">;</span>
	<span class="c">struct</span> <span class="w">btrfs_work</span> <span class="w">w</span><span class="c">ork;</span>
<span class="pc">}</span><span class="c">;</span>


<span class="pc">sta</span><span class="c">tic</span> <span class="pc">int</span> <span class="w">plug_cmp</span><span class="c">(</span><span class="pc">v</span><span class="c">oid</span> <span class="c">*</span><span class="pc">p</span><span class="c">riv,</span> <span class="c">struct</span> <span class="w">l</span><span class="c">ist_head</span> <span class="c">*</span><span class="w">a</span><span class="c">,</span> <span class="c">struct</span> <span class="pc">l</span><span class="c">ist_head</span> <span class="c">*</span><span class="w">b</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">ra</span> <span class="c">=</span> <span class="c">container_of(</span><span class="pc">a</span><span class="c">,</span> <span class="c">struct</span> <span class="c">btrfs_raid_bio,</span>
						 <span class="w">plug_list</span><span class="c">);</span>
	<span class="pc">str</span><span class="c">uct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*</span><span class="w">rb</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ontainer_of(</span><span class="w">b</span><span class="c">,</span> <span class="c">struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio,</span>
						 <span class="w">p</span><span class="pc">lu</span><span class="c">g_list);</span>
	<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">a_sector</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">a</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bio_list.h</span><span class="pc">e</span><span class="c">ad</span><span class="w">-</span><span class="c">&gt;</span><span class="w">bi_iter.bi_sector</span><span class="pc">;</span>
	<span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">b_sector</span> <span class="c">=</span> <span class="w">rb</span><span class="c">-&gt;</span><span class="w">b</span><span class="pc">io</span><span class="c">_list</span><span class="pc">.</span><span class="w">h</span><span class="pc">ea</span><span class="c">d</span><span class="w">-</span><span class="c">&gt;</span><span class="pc">bi_i</span><span class="c">ter</span><span class="pc">.</span><span class="c">bi_sector</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">a</span><span class="c">_sector</span> <span class="pc">&lt;</span> <span class="pc">b</span><span class="c">_sector</span><span class="pc">)</span>
		<span class="c">return</span> <span class="c">-</span><span class="pc">1</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">a</span><span class="c">_sector</span> <span class="pc">&gt;</span> <span class="pc">b</span><span class="c">_sector</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">run_plug</span><span class="c">(struct</span> <span class="w">btrfs_plug_cb</span> <span class="c">*</span><span class="w">plug</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">cu</span><span class="c">r</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*</span><span class="w">la</span><span class="c">st</span> <span class="pc">=</span> <span class="pc">N</span><span class="c">ULL;</span>

	
	<span class="w">list_sort</span><span class="c">(</span><span class="w">N</span><span class="c">ULL</span><span class="pc">, </span><span class="c">&amp;plug-&gt;</span><span class="w">rbio_list</span><span class="pc">,</span> <span class="w">plug_cmp</span><span class="c">);</span>
	<span class="w">w</span><span class="c">hile</span> <span class="pc">(!l</span><span class="c">ist_empty(&amp;</span><span class="pc">p</span><span class="c">lug-&gt;</span><span class="pc">r</span><span class="c">bio_list)) {</span>
		<span class="w">cu</span><span class="c">r</span> <span class="pc">=</span> <span class="c">list_entry(plug-&gt;rbio_list</span><span class="pc">.</span><span class="c">next</span><span class="pc">,</span>
				 <span class="c">struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span><span class="pc">,</span> <span class="w">plug_list</span><span class="c">);</span>
		<span class="pc">list_del_</span><span class="c">init(&amp;</span><span class="w">cu</span><span class="c">r-&gt;</span><span class="pc">p</span><span class="c">lug_list);</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rbio_is_full</span><span class="pc">(</span><span class="w">c</span><span class="pc">u</span><span class="c">r</span><span class="pc">))</span><span class="c"> {</span>
			
			<span class="w">full_stripe_write</span><span class="c">(</span><span class="w">cu</span><span class="pc">r</span><span class="c">);</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">la</span><span class="pc">s</span><span class="c">t) {</span>
			<span class="c">if</span> <span class="c">(</span><span class="w">rbio_can_merge</span><span class="c">(</span><span class="w">la</span><span class="c">st</span><span class="pc">,</span> <span class="w">cu</span><span class="pc">r)) </span><span class="c">{</span>
				<span class="w">merge_rbio</span><span class="c">(</span><span class="w">la</span><span class="c">st,</span> <span class="w">c</span><span class="pc">u</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">__free_raid_bio</span><span class="c">(</span><span class="w">c</span><span class="pc">u</span><span class="c">r</span><span class="pc">)</span><span class="c">;</span>
				<span class="w">c</span><span class="c">ontinue;</span>

			<span class="c">}</span>
			<span class="w">__raid56_parity_write</span><span class="c">(</span><span class="w">la</span><span class="c">st</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>
		<span class="w">la</span><span class="c">st</span> <span class="pc">=</span> <span class="w">c</span><span class="c">ur;</span>
	<span class="c">}</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">la</span><span class="pc">s</span><span class="c">t) {</span>
		<span class="w">_</span><span class="c">_raid56_parity_write(</span><span class="w">la</span><span class="pc">s</span><span class="c">t</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">k</span><span class="pc">f</span><span class="c">ree(</span><span class="w">plug</span><span class="c">);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="c">void</span> <span class="w">unplug_work</span><span class="c">(struct</span> <span class="w">btrfs_work</span> <span class="c">*</span><span class="w">w</span><span class="c">ork)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_plug_cb</span> <span class="c">*</span><span class="pc">p</span><span class="c">lug</span><span class="pc">;</span>
	<span class="w">p</span><span class="pc">l</span><span class="c">ug</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">ontainer_of(work,</span> <span class="c">struct</span> <span class="c">btrfs_plug_cb,</span> <span class="c">work);</span>
	<span class="w">run_plug</span><span class="c">(</span><span class="pc">p</span><span class="c">lug);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">btrfs_raid_unplug</span><span class="c">(struct</span> <span class="w">blk_plug_cb</span> <span class="c">*</span><span class="w">cb</span><span class="pc">,</span> <span class="w">b</span><span class="c">ool</span> <span class="w">from_schedule</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="c">btrfs_plug_cb</span> <span class="c">*plug</span><span class="pc">;</span>
	<span class="w">p</span><span class="c">lug</span> <span class="pc">=</span> <span class="pc">c</span><span class="c">ontainer_of(</span><span class="w">cb</span><span class="c">,</span> <span class="c">struct</span> <span class="c">btrfs_plug_cb,</span> <span class="w">cb</span><span class="c">);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">f</span><span class="c">rom_schedule) {</span>
		<span class="w">btrfs_init_work</span><span class="pc">(&amp;</span><span class="c">plug-&gt;</span><span class="w">w</span><span class="c">ork</span><span class="pc">,</span> <span class="w">btrfs_rmw_helper</span><span class="pc">,</span>
				<span class="w">unplug_work</span><span class="pc">,</span> <span class="c">NULL</span><span class="pc">,</span> <span class="c">NULL);</span>
		<span class="w">btrfs_queue_work</span><span class="c">(plug</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">rmw_workers</span><span class="c">,</span>
				 <span class="w">&amp;</span><span class="pc">p</span><span class="c">lug</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">wo</span><span class="c">rk</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>
	<span class="c">}</span>
	<span class="w">run_plug</span><span class="c">(plug</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">in</span><span class="c">t</span> <span class="w">raid56_parity_write</span><span class="c">(struct</span> <span class="w">btrfs_root</span> <span class="c">*</span><span class="w">ro</span><span class="c">ot,</span> <span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*</span><span class="pc">b</span><span class="c">io</span><span class="pc">,</span>
			<span class="c">struct</span> <span class="w">btrfs_bio</span> <span class="c">*</span><span class="w">bbio</span><span class="pc">,</span> <span class="w">u6</span><span class="c">4</span> <span class="w">stripe_len</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">;</span>
	<span class="c">struct</span> <span class="w">btrfs_plug_cb</span> <span class="c">*</span><span class="w">p</span><span class="pc">l</span><span class="c">ug</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="c">struct</span> <span class="w">blk_plug_cb</span> <span class="c">*</span><span class="w">cb</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">r</span><span class="c">et;</span>

	<span class="w">r</span><span class="pc">b</span><span class="c">io</span> <span class="c">=</span> <span class="w">alloc_rbio</span><span class="c">(</span><span class="w">ro</span><span class="c">ot,</span> <span class="w">b</span><span class="pc">b</span><span class="c">io</span><span class="pc">,</span> <span class="w">s</span><span class="pc">t</span><span class="c">ripe_len);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(rbio</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">btrfs_put_bbio</span><span class="c">(</span><span class="w">b</span><span class="pc">b</span><span class="c">io);</span>
		<span class="c">return</span> <span class="w">P</span><span class="c">TR_ERR(</span><span class="w">r</span><span class="c">bio);</span>
	<span class="c">}</span>
	<span class="w">bio_list_add</span><span class="pc">(&amp;</span><span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bio_list</span><span class="pc">,</span> <span class="w">bi</span><span class="pc">o</span><span class="c">);</span>
	<span class="pc">rb</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bio_list_bytes</span> <span class="c">=</span> <span class="w">bi</span><span class="pc">o-</span><span class="c">&gt;</span><span class="w">bi_iter</span><span class="pc">.</span><span class="w">bi_size</span><span class="pc">;</span>
	<span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">operation</span> <span class="c">=</span> <span class="w">BTRFS_RBIO_WRITE</span><span class="c">;</span>

	<span class="w">btrfs_bio_counter_inc_noblocked</span><span class="pc">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">rb</span><span class="c">io-&gt;</span><span class="w">generic_bio_cnt</span> <span class="c">=</span> <span class="pc">1</span><span class="c">;</span>

	
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">rbio_is_full</span><span class="c">(rbio</span><span class="w">)</span><span class="pc">) </span><span class="c">{</span>
		<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">full_stripe_write</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span><span class="pc">)</span>
			<span class="w">btrfs_bio_counter_dec</span><span class="c">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info);</span>
		<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">et;</span>
	<span class="c">}</span>

	<span class="w">cb</span> <span class="pc">=</span> <span class="w">blk_check_plugged</span><span class="c">(</span><span class="w">btrfs_raid_unplug</span><span class="pc">,</span> <span class="w">ro</span><span class="c">ot</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">,</span>
			       <span class="w">s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(*</span><span class="w">plug</span><span class="c">));</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">cb</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">p</span><span class="pc">l</span><span class="c">ug</span> <span class="pc">=</span> <span class="w">co</span><span class="pc">n</span><span class="c">tainer_of(</span><span class="w">cb</span><span class="c">,</span> <span class="c">struct</span> <span class="w">btrfs_plug_cb</span><span class="c">,</span> <span class="w">cb</span><span class="c">);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">plug</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">i</span><span class="pc">nf</span><span class="c">o</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">p</span><span class="pc">l</span><span class="c">ug</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">in</span><span class="pc">f</span><span class="c">o</span> <span class="c">=</span> <span class="w">ro</span><span class="c">ot</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info;</span>
			<span class="w">I</span><span class="c">NIT_LIST_HEAD(&amp;plug-&gt;</span><span class="w">rbio_list</span><span class="c">);</span>
		<span class="pc">}</span>
		<span class="w">l</span><span class="pc">i</span><span class="c">st_add_tail(&amp;</span><span class="w">rbio</span><span class="c">-&gt;</span><span class="w">plug_list</span><span class="c">, &amp;plug-&gt;</span><span class="pc">rbio_</span><span class="c">list);</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="c">0;</span>
	<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
		<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">__raid56_parity_write</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
			<span class="w">btrfs_bio_counter_dec</span><span class="c">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info);</span>
	<span class="w">}</span>
	<span class="pc">retu</span><span class="c">rn</span> <span class="c">ret;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">__raid_recover_end_io</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">r</span><span class="c">bio)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">pagenr</span><span class="pc">,</span> <span class="w">stripe</span><span class="pc">;</span>
	<span class="w">v</span><span class="c">oid</span> <span class="w">*</span><span class="pc">*</span><span class="w">pointers</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">faila</span> <span class="w">=</span><span class="pc"> </span><span class="c">-1</span><span class="pc">,</span> <span class="w">failb</span> <span class="w">=</span><span class="pc"> </span><span class="c">-1;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">nr</span><span class="pc">_</span><span class="c">pages</span> <span class="c">=</span> <span class="w">DIV_ROUND_UP</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">tru</span><span class="c">ct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">;</span>
	<span class="c">int</span> <span class="pc">e</span><span class="c">rr;</span>
	<span class="c">int</span> <span class="pc">i</span><span class="c">;</span>

	<span class="w">p</span><span class="c">ointers</span> <span class="pc">=</span> <span class="w">kcalloc</span><span class="c">(</span><span class="w">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="pc">,</span> <span class="w">s</span><span class="pc">i</span><span class="c">zeof</span><span class="pc">(</span><span class="w">v</span><span class="c">oid</span> <span class="w">*),</span> <span class="w">GFP_NOFS</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!p</span><span class="c">ointers</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">e</span><span class="c">rr</span> <span class="c">= -ENOMEM;</span>
		<span class="c">goto</span> <span class="w">cleanup_io</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="w">faila</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;faila;</span>
	<span class="w">failb</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="pc">failb</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">operation</span> <span class="c">==</span> <span class="w">BTRFS_RBIO_READ_REBUILD</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">sp</span><span class="pc">in_lock_ir</span><span class="c">q(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_list_lock</span><span class="c">);</span>
		<span class="w">se</span><span class="c">t_bit(</span><span class="w">RBIO_RMW_LOCKED_BIT</span><span class="c">, &amp;rbio-&gt;</span><span class="pc">f</span><span class="c">lags);</span>
		<span class="w">spin_u</span><span class="pc">nlock_irq</span><span class="c">(&amp;rbio-&gt;</span><span class="pc">b</span><span class="c">io_list_lock);</span>
	<span class="c">}</span>

	<span class="w">index_rbio_pages</span><span class="c">(rbio);</span>

	<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(</span><span class="w">pagenr</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">p</span><span class="c">agenr</span> <span class="c">&lt;</span> <span class="w">nr</span><span class="c">_pages;</span> <span class="c">pagenr++) {</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(rbio-&gt;</span><span class="w">operation</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_PARITY_SCRUB</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
		    <span class="w">!t</span><span class="c">est_bit(</span><span class="pc">p</span><span class="c">agenr</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">dbitmap</span><span class="pc">))</span>
			<span class="pc">c</span><span class="c">ontinue;</span>

		
		<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">stripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">s</span><span class="c">tripe</span> <span class="c">&lt;</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="c">stripe++) {</span>
			
			<span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="pc">o</span><span class="c">peration</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_READ_REBUILD</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
			    <span class="w">(s</span><span class="pc">t</span><span class="c">ripe</span> <span class="pc">=</span><span class="c">=</span> <span class="w">faila</span> <span class="pc">|</span><span class="c">|</span> <span class="w">s</span><span class="c">tripe</span> <span class="pc">=</span><span class="c">=</span> <span class="w">failb</span><span class="pc">))</span><span class="c"> {</span>
				<span class="w">pag</span><span class="pc">e</span> <span class="c">=</span> <span class="w">page_in_rbio</span><span class="c">(</span><span class="pc">rb</span><span class="c">io,</span> <span class="c">stripe</span><span class="pc">,</span> <span class="w">pagenr</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
			<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
				<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(rbio,</span> <span class="pc">s</span><span class="c">tripe,</span> <span class="pc">p</span><span class="c">agenr</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">}</span>
			<span class="w">pointers[s</span><span class="c">tripe</span><span class="w">]</span><span class="pc"> </span><span class="c">=</span> <span class="w">kmap</span><span class="c">(</span><span class="w">pa</span><span class="pc">ge)</span><span class="c">;</span>
		<span class="c">}</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">map_type</span> <span class="w">&amp;</span> <span class="w">BTRFS_BLOCK_GROUP_RAID6</span><span class="c">) {</span>
			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">failb</span> <span class="w">&lt;</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
				<span class="c">if</span> <span class="c">(</span><span class="w">faila</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">nr_data</span><span class="c">) {</span>
					
					<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>
					<span class="c">goto</span> <span class="w">c</span><span class="c">leanup;</span>
				<span class="c">}</span>
				
				<span class="w">g</span><span class="c">oto</span> <span class="w">pstripe</span><span class="c">;</span>
			<span class="c">}</span>

			
			<span class="c">if</span> <span class="c">(</span><span class="pc">faila</span> <span class="w">&gt;</span> <span class="w">f</span><span class="c">ailb) {</span>
				<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">t</span><span class="c">mp</span> <span class="c">=</span> <span class="c">failb</span><span class="pc">;</span>
				<span class="w">f</span><span class="pc">ailb</span> <span class="pc">=</span> <span class="c">faila;</span>
				<span class="pc">f</span><span class="c">aila</span> <span class="c">=</span> <span class="w">t</span><span class="pc">m</span><span class="c">p;</span>
			<span class="pc">}</span>

			
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="pc">&gt;</span><span class="w">raid_map[f</span><span class="pc">ailb] </span><span class="c">==</span> <span class="w">RAID6_Q_STRIPE</span><span class="c">) {</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(rbio-&gt;bbio</span><span class="w">-</span><span class="c">&gt;raid_map[</span><span class="w">f</span><span class="pc">aila] =</span><span class="c">=</span>
				    <span class="w">RAID5_P_STRIPE</span><span class="pc">) </span><span class="c">{</span>
					<span class="w">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>
					<span class="pc">g</span><span class="c">oto</span> <span class="pc">c</span><span class="c">leanup;</span>
				<span class="c">}</span>
				
				<span class="w">g</span><span class="c">oto</span> <span class="w">pstripe</span><span class="c">;</span>
			<span class="c">}</span>

			<span class="c">if</span> <span class="c">(rbio-&gt;bbio</span><span class="pc">-</span><span class="c">&gt;raid_map</span><span class="pc">[</span><span class="w">f</span><span class="pc">ailb] </span><span class="c">==</span> <span class="pc">RAID5</span><span class="c">_P_STRIPE</span><span class="pc">)</span><span class="c"> {</span>
				<span class="w">raid6_datap_recov</span><span class="c">(rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="c">,</span>
						  <span class="w">P</span><span class="c">AGE_SIZE</span><span class="pc">,</span> <span class="w">f</span><span class="pc">aila,</span> <span class="w">pointers</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">}</span> <span class="c">else</span> <span class="c">{</span>
				<span class="w">raid6_2data_recov</span><span class="c">(rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">re</span><span class="c">al_stripes,</span>
						  <span class="w">P</span><span class="c">AGE_SIZE,</span> <span class="pc">f</span><span class="c">aila,</span> <span class="w">f</span><span class="c">ailb</span><span class="pc">,</span>
						  <span class="w">p</span><span class="c">ointers</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">}</span>
		<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="c">{</span>
			<span class="w">v</span><span class="c">oid</span> <span class="pc">*</span><span class="w">p</span><span class="c">;</span>

			
			<span class="w">B</span><span class="c">UG_ON(</span><span class="pc">failb</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">);</span>
<span class="w">pstripe:</span>
			
			<span class="w">me</span><span class="c">mcpy(</span><span class="w">p</span><span class="pc">o</span><span class="c">inters</span><span class="w">[f</span><span class="c">aila</span><span class="pc">]</span><span class="c">,</span>
			       <span class="w">p</span><span class="pc">o</span><span class="c">inters</span><span class="pc">[</span><span class="w">r</span><span class="pc">b</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr_data]</span><span class="pc">,</span>
			       <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>

			
			<span class="w">p</span> <span class="pc">=</span> <span class="w">p</span><span class="pc">o</span><span class="c">inters</span><span class="pc">[</span><span class="w">f</span><span class="pc">aila];</span>
			<span class="w">f</span><span class="pc">o</span><span class="c">r</span> <span class="c">(</span><span class="w">stripe</span> <span class="c">=</span> <span class="w">f</span><span class="pc">aila</span><span class="c">;</span> <span class="c">stripe</span> <span class="pc">&lt;</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">nr</span><span class="c">_data</span> <span class="w">-</span> <span class="pc">1</span><span class="c">;</span> <span class="c">stripe</span><span class="pc">++)</span>
				<span class="pc">p</span><span class="c">ointers[</span><span class="pc">s</span><span class="c">tripe] =</span> <span class="pc">p</span><span class="c">ointers</span><span class="pc">[s</span><span class="c">tripe</span> <span class="pc">+</span> <span class="pc">1</span><span class="c">];</span>
			<span class="c">pointers[rbio</span><span class="w">-</span><span class="c">&gt;nr_data</span> <span class="w">-</span> <span class="pc">1</span><span class="w">]</span><span class="c"> =</span> <span class="w">p</span><span class="c">;</span>

			
			<span class="w">run_xor</span><span class="c">(</span><span class="pc">p</span><span class="c">ointers,</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;nr_data</span> <span class="w">-</span> <span class="c">1</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>
		<span class="pc">}</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">operation</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_WRITE</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span>  <span class="c">i</span> <span class="c">&lt;</span> <span class="w">nr</span><span class="pc">_p</span><span class="c">ages;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
				<span class="c">if</span> <span class="c">(</span><span class="w">faila</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1) {</span>
					<span class="w">pa</span><span class="pc">g</span><span class="c">e</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(rbio,</span> <span class="pc">f</span><span class="c">aila,</span> <span class="c">i</span><span class="pc">)</span><span class="c">;</span>
					<span class="w">SetPageUptodate</span><span class="c">(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">}</span>
				<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">failb</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1) {</span>
					<span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">=</span> <span class="w">r</span><span class="pc">bio_</span><span class="c">stripe_page(</span><span class="pc">r</span><span class="c">bio,</span> <span class="pc">failb</span><span class="c">,</span> <span class="pc">i</span><span class="c">);</span>
					<span class="w">S</span><span class="c">etPageUptodate(</span><span class="w">p</span><span class="pc">a</span><span class="c">ge</span><span class="pc">)</span><span class="c">;</span>
				<span class="c">}</span>
			<span class="c">}</span>
		<span class="pc">}</span>
		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">stripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">s</span><span class="c">tripe</span> <span class="c">&lt;</span> <span class="c">rbio-&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="pc">stri</span><span class="c">pe++) {</span>
			
			<span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="w">operation</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_READ_REBUILD</span> <span class="pc">&amp;</span><span class="c">&amp;</span>
			    <span class="w">(s</span><span class="c">tripe</span> <span class="pc">=</span><span class="c">=</span> <span class="w">faila</span> <span class="pc">|</span><span class="c">|</span> <span class="w">s</span><span class="c">tripe</span> <span class="pc">=</span><span class="c">=</span> <span class="w">f</span><span class="c">ailb</span><span class="pc">))</span><span class="c"> {</span>
				<span class="w">pa</span><span class="pc">g</span><span class="c">e</span> <span class="c">=</span> <span class="w">page_in_rbio</span><span class="pc">(rb</span><span class="c">io,</span> <span class="c">stripe</span><span class="pc">,</span> <span class="w">pagenr</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
			<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
				<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(rbio,</span> <span class="pc">s</span><span class="c">tripe,</span> <span class="pc">p</span><span class="c">agenr</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">}</span>
			<span class="w">kunmap</span><span class="c">(</span><span class="w">pa</span><span class="pc">ge)</span><span class="c">;</span>
		<span class="c">}</span>
	<span class="pc">}</span>

	<span class="w">e</span><span class="pc">r</span><span class="c">r</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>
<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>
	<span class="w">k</span><span class="pc">f</span><span class="c">ree(</span><span class="w">pointers</span><span class="c">);</span>

<span class="w">cleanup_io</span><span class="pc">:</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">operation</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_READ_REBUILD</span><span class="pc">) </span><span class="c">{</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">e</span><span class="c">rr</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">)</span>
			<span class="w">cache_rbio_pages</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">else</span>
			<span class="w">cl</span><span class="pc">ear</span><span class="c">_bit(</span><span class="w">RBIO_CACHE_READY_BIT</span><span class="c">, &amp;rbio-&gt;</span><span class="w">f</span><span class="c">lags);</span>

		<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="pc">,</span> <span class="w">e</span><span class="pc">r</span><span class="c">r</span><span class="pc">,</span> <span class="w">e</span><span class="c">rr</span> <span class="w">==</span> <span class="c">0);</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">r</span><span class="pc">b</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">faila</span> <span class="w">= -</span><span class="c">1;</span>
		<span class="pc">rb</span><span class="c">io-&gt;</span><span class="w">failb</span> <span class="w">= </span><span class="pc">-</span><span class="c">1;</span>

		<span class="c">if</span> <span class="c">(</span><span class="pc">rb</span><span class="c">io-&gt;</span><span class="w">operation</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_WRITE</span><span class="pc">)</span>
			<span class="w">finish_rmw</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="w">o</span><span class="c">peration</span> <span class="c">==</span> <span class="w">BTRFS_RBIO_PARITY_SCRUB</span><span class="c">)</span>
			<span class="w">finish_parity_scrub</span><span class="c">(rbio</span><span class="pc">,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="c">else</span>
			<span class="w">B</span><span class="pc">UG</span><span class="c">();</span>
	<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="pc">{</span>
		<span class="w">rbio_orig_end_io</span><span class="c">(rbio,</span> <span class="w">er</span><span class="pc">r,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="c">}</span>
<span class="pc">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">raid_recover_end_io</span><span class="c">(struct</span> <span class="w">b</span><span class="c">io</span> <span class="c">*bio</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="pc">rr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">r</span><span class="c">bio</span> <span class="c">=</span> <span class="w">b</span><span class="pc">i</span><span class="c">o-&gt;</span><span class="w">bi_private</span><span class="c">;</span>

	
	<span class="pc">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="w">fail_bio_stripe</span><span class="c">(rbio,</span> <span class="w">b</span><span class="pc">io)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">set_bio_pages_uptodate</span><span class="c">(</span><span class="pc">bi</span><span class="c">o</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">bio_put</span><span class="c">(bio);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">atomic_dec_and_test</span><span class="pc">(&amp;r</span><span class="c">bio-&gt;</span><span class="w">stripes_pending</span><span class="c">))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">a</span><span class="pc">tomic_r</span><span class="c">ead(&amp;rbio-&gt;</span><span class="w">e</span><span class="c">rror</span><span class="w">) </span><span class="pc">&gt;</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">max_errors</span><span class="pc">)</span>
		<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="w">,</span><span class="pc"> -</span><span class="w">E</span><span class="pc">IO,</span> <span class="c">0);</span>
	<span class="c">else</span>
		<span class="w">__raid_recover_end_io</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">__raid56_parity_recover</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">bios_to_read</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">bio_list</span> <span class="w">b</span><span class="pc">i</span><span class="c">o_list;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">nr</span><span class="c">_pages</span> <span class="pc">=</span> <span class="w">DIV_ROUND_UP</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">pagenr</span><span class="pc">;</span>
	<span class="c">int</span> <span class="w">stripe</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bi</span><span class="pc">o</span> <span class="c">*</span><span class="w">b</span><span class="pc">io</span><span class="c">;</span>

	<span class="w">bio_list_init</span><span class="pc">(&amp;bio_</span><span class="c">list</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">alloc_rbio_pages</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">c</span><span class="pc">l</span><span class="c">eanup;</span>

	<span class="w">a</span><span class="pc">tomic_s</span><span class="c">et(&amp;rbio-&gt;</span><span class="w">er</span><span class="pc">ro</span><span class="c">r</span><span class="pc">,</span> <span class="c">0);</span>

	
	<span class="pc">f</span><span class="c">or</span> <span class="c">(</span><span class="w">st</span><span class="pc">r</span><span class="c">ipe</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">s</span><span class="c">tripe</span> <span class="pc">&lt;</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="pc">s</span><span class="c">tripe++) {</span>
		<span class="c">if</span> <span class="c">(rbio-&gt;</span><span class="w">faila</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">s</span><span class="c">tripe</span> <span class="pc">|</span><span class="c">|</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">failb</span> <span class="pc">=</span><span class="c">=</span> <span class="w">s</span><span class="c">tripe) {</span>
			<span class="w">a</span><span class="pc">tomic_i</span><span class="c">nc(&amp;rbio-&gt;</span><span class="w">e</span><span class="c">rror);</span>
			<span class="w">c</span><span class="c">ontinue;</span>
		<span class="c">}</span>

		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">pagenr</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">p</span><span class="c">agenr</span> <span class="c">&lt;</span> <span class="w">nr</span><span class="c">_pages;</span> <span class="pc">p</span><span class="c">agenr++) {</span>
			<span class="c">struct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*</span><span class="w">p</span><span class="c">;</span>

			
			<span class="w">p</span> <span class="pc">=</span> <span class="w">rbio_stripe_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="w">s</span><span class="pc">tri</span><span class="c">pe</span><span class="pc">,</span> <span class="w">p</span><span class="pc">a</span><span class="c">genr);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">PageUptodate</span><span class="c">(</span><span class="pc">p))</span>
				<span class="pc">c</span><span class="c">ontinue;</span>

			<span class="w">re</span><span class="pc">t</span> <span class="c">=</span> <span class="w">rbio_add_io_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bio_list</span><span class="pc">,</span>
				       <span class="w">r</span><span class="pc">bio_</span><span class="c">stripe_page</span><span class="w">(</span><span class="c">rbio,</span> <span class="c">stripe,</span> <span class="w">p</span><span class="c">agenr</span><span class="w">)</span><span class="pc">,</span>
				       <span class="w">s</span><span class="c">tripe</span><span class="pc">,</span> <span class="pc">p</span><span class="c">agenr,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span> <span class="pc">&lt;</span> <span class="c">0)</span>
				<span class="c">goto</span> <span class="w">c</span><span class="c">leanup;</span>
		<span class="c">}</span>
	<span class="w">}</span>

	<span class="w">bios_to_read</span> <span class="pc">=</span> <span class="w">bio_list_size</span><span class="pc">(&amp;</span><span class="c">bio_list</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">bios_to_read) {</span>
		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">a</span><span class="pc">t</span><span class="c">omic_read(&amp;</span><span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">e</span><span class="pc">r</span><span class="c">ror</span><span class="w">) &lt;=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="pc">&gt;</span><span class="w">max_errors</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">__raid_recover_end_io</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="c">out;</span>
		<span class="c">}</span> <span class="w">e</span><span class="c">lse</span> <span class="pc">{</span>
			<span class="w">g</span><span class="c">oto</span> <span class="w">c</span><span class="c">leanup;</span>
		<span class="c">}</span>
	<span class="c">}</span>

	
	<span class="w">a</span><span class="pc">tomic_s</span><span class="c">et(&amp;rbio-&gt;</span><span class="w">stripes_pending</span><span class="c">,</span> <span class="pc">b</span><span class="c">ios_to_read</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">w</span><span class="pc">h</span><span class="c">ile</span> <span class="c">(</span><span class="w">1</span><span class="c">) {</span>
		<span class="w">bi</span><span class="pc">o</span> <span class="pc">=</span> <span class="w">bio_list_pop</span><span class="pc">(&amp;</span><span class="w">bio_list</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">io)</span>
			<span class="pc">b</span><span class="c">reak;</span>

		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_private</span> <span class="c">=</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">;</span>
		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_end_io</span> <span class="c">=</span> <span class="w">raid_recover_end_io</span><span class="c">;</span>

		<span class="w">btrfs_bio_wq_end_io</span><span class="pc">(r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info,</span> <span class="pc">bio</span><span class="c">,</span>
				    <span class="w">BTRFS_WQ_ENDIO_RAID56</span><span class="c">);</span>

		<span class="w">B</span><span class="pc">U</span><span class="c">G_ON</span><span class="pc">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">BIO_UPTODATE</span><span class="c">, &amp;bio-&gt;</span><span class="w">bi_flags))</span><span class="pc">;</span>
		<span class="w">submit_bio</span><span class="c">(</span><span class="w">READ</span><span class="c">,</span> <span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
<span class="w">o</span><span class="c">ut:</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>

<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>
	<span class="w">i</span><span class="c">f</span> <span class="c">(rbio-&gt;</span><span class="w">operation</span> <span class="pc">=</span><span class="c">=</span> <span class="w">BTRFS_RBIO_READ_REBUILD</span><span class="c">)</span>
		<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="w">, </span><span class="pc">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">-</span><span class="c">EIO;</span>
<span class="c">}</span>


<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">raid56_parity_recover</span><span class="c">(struct</span> <span class="w">btrfs_root</span> <span class="c">*</span><span class="w">ro</span><span class="c">ot,</span> <span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*</span><span class="pc">b</span><span class="c">io</span><span class="pc">,</span>
			  <span class="pc">st</span><span class="c">ruct</span> <span class="w">btrfs_bio</span> <span class="c">*</span><span class="w">bbio</span><span class="c">,</span> <span class="w">u6</span><span class="c">4</span> <span class="w">stripe_len</span><span class="c">,</span>
			  <span class="pc">i</span><span class="c">nt</span> <span class="w">mirror_num</span><span class="c">,</span> <span class="c">int</span> <span class="w">generic_io</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>

	<span class="w">r</span><span class="pc">b</span><span class="c">io</span> <span class="c">=</span> <span class="w">alloc_rbio</span><span class="c">(</span><span class="w">r</span><span class="pc">o</span><span class="c">ot,</span> <span class="w">b</span><span class="pc">b</span><span class="c">io</span><span class="pc">,</span> <span class="pc">s</span><span class="c">tripe_len</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)) </span><span class="c">{</span>
		<span class="w">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">g</span><span class="c">eneric_io</span><span class="w">)</span>
			<span class="w">btrfs_put_bbio</span><span class="c">(</span><span class="w">b</span><span class="pc">b</span><span class="c">io</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">re</span><span class="c">turn</span> <span class="w">P</span><span class="c">TR_ERR(rbio);</span>
	<span class="c">}</span>

	<span class="w">r</span><span class="pc">b</span><span class="c">io-&gt;</span><span class="w">operation</span> <span class="c">=</span> <span class="w">BTRFS_RBIO_READ_REBUILD</span><span class="pc">;</span>
	<span class="w">bio_list_add</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">bio_list</span><span class="c">,</span> <span class="w">bi</span><span class="pc">o)</span><span class="c">;</span>
	<span class="w">r</span><span class="pc">b</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bio_list_bytes</span> <span class="c">=</span> <span class="w">bi</span><span class="pc">o-</span><span class="c">&gt;</span><span class="w">bi_iter</span><span class="pc">.</span><span class="w">bi_size</span><span class="pc">;</span>

	<span class="c">rbio-&gt;</span><span class="w">faila</span> <span class="c">=</span> <span class="w">find_logical_bio_stripe</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">,</span> <span class="w">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(</span><span class="pc">rb</span><span class="c">io-&gt;</span><span class="pc">fa</span><span class="c">ila</span> <span class="w">==</span><span class="pc"> -</span><span class="c">1</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">B</span><span class="pc">UG</span><span class="c">();</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">generic_io)</span>
			<span class="w">btrfs_put_bbio</span><span class="c">(</span><span class="w">bbio</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">k</span><span class="c">free(rbio);</span>
		<span class="c">return</span> <span class="pc">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">g</span><span class="c">eneric_io</span><span class="w">)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">btrfs_bio_counter_inc_noblocked</span><span class="c">(</span><span class="w">ro</span><span class="c">ot</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">rb</span><span class="c">io-&gt;</span><span class="w">generic_bio_cnt</span> <span class="c">=</span> <span class="w">1</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">btrfs_get_bbio</span><span class="c">(</span><span class="pc">b</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="w">mirror_num</span> <span class="pc">=</span><span class="c">=</span> <span class="pc">3)</span>
		<span class="pc">rb</span><span class="c">io-&gt;</span><span class="w">failb</span> <span class="c">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">real_stripes</span> <span class="w">-</span> <span class="pc">2</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">lock_stripe_add</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>

	
	<span class="c">if</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0)</span>
		<span class="w">__raid56_parity_recover</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>

<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">rmw_work</span><span class="c">(struct</span> <span class="w">btrfs_work</span> <span class="c">*</span><span class="w">w</span><span class="c">ork)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">;</span>

	<span class="w">r</span><span class="c">bio</span> <span class="c">=</span> <span class="pc">c</span><span class="c">ontainer_of(</span><span class="pc">w</span><span class="c">ork,</span> <span class="c">struct</span> <span class="c">btrfs_raid_bio,</span> <span class="pc">w</span><span class="c">ork);</span>
	<span class="w">raid56_rmw_stripe</span><span class="c">(</span><span class="pc">r</span><span class="c">bio);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="c">void</span> <span class="w">read_rebuild_work</span><span class="c">(struct</span> <span class="pc">btrfs_w</span><span class="c">ork</span> <span class="c">*</span><span class="w">w</span><span class="c">ork)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">;</span>

	<span class="w">r</span><span class="c">bio</span> <span class="c">=</span> <span class="c">container_of(</span><span class="pc">w</span><span class="c">ork,</span> <span class="c">struct</span> <span class="c">btrfs_raid_bio,</span> <span class="pc">w</span><span class="c">ork);</span>
	<span class="w">__raid56_parity_recover</span><span class="c">(</span><span class="pc">r</span><span class="c">bio);</span>
<span class="c">}</span>



<span class="w">s</span><span class="pc">tr</span><span class="c">uct</span> <span class="pc">btrfs_r</span><span class="c">aid_bio</span> <span class="c">*</span>
<span class="w">raid56_parity_alloc_scrub_rbio</span><span class="pc">(</span><span class="c">struct</span> <span class="w">btrfs_root</span> <span class="c">*</span><span class="w">r</span><span class="pc">o</span><span class="c">ot,</span> <span class="c">struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*bio</span><span class="pc">,</span>
			       <span class="c">struct</span> <span class="w">btrfs_bio</span> <span class="c">*</span><span class="w">bbio</span><span class="pc">,</span> <span class="w">u6</span><span class="c">4</span> <span class="w">stripe_len</span><span class="pc">,</span>
			       <span class="c">struct</span> <span class="w">btrfs_device</span> <span class="c">*</span><span class="w">scrub_dev</span><span class="c">,</span>
			       <span class="pc">u</span><span class="c">nsigned</span> <span class="pc">l</span><span class="c">ong</span> <span class="c">*</span><span class="w">dbitmap</span><span class="c">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">stripe_nsectors</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="pc">btrfs_ra</span><span class="c">id_bio</span> <span class="c">*</span><span class="w">rbio</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>

	<span class="w">r</span><span class="pc">b</span><span class="c">io</span> <span class="c">=</span> <span class="w">alloc_rbio</span><span class="c">(</span><span class="w">ro</span><span class="c">ot,</span> <span class="w">b</span><span class="c">bio</span><span class="pc">,</span> <span class="w">s</span><span class="pc">tripe_l</span><span class="c">en);</span>
	<span class="c">if</span> <span class="c">(</span><span class="w">I</span><span class="c">S_ERR(rbio))</span>
		<span class="c">return</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="w">bio_list_add</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">bio_list</span><span class="pc">,</span> <span class="w">bi</span><span class="pc">o</span><span class="c">);</span>
	
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT</span><span class="w">(</span><span class="pc">!</span><span class="w">bi</span><span class="pc">o</span><span class="c">-&gt;</span><span class="w">bi_iter</span><span class="pc">.</span><span class="w">bi_size</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">rb</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">operation</span> <span class="c">=</span> <span class="w">BTRFS_RBIO_PARITY_SCRUB</span><span class="pc">;</span>

	<span class="w">f</span><span class="c">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="c">rbio-&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="c">i++) {</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">bbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripes</span><span class="c">[i].</span><span class="w">d</span><span class="pc">ev</span> <span class="w">=</span><span class="pc">=</span> <span class="w">scrub_dev</span><span class="c">) {</span>
			<span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">scrubp</span> <span class="pc">=</span> <span class="w">i</span><span class="c">;</span>
			<span class="pc">b</span><span class="c">reak;</span>
		<span class="c">}</span>
	<span class="c">}</span>

	
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="w">ro</span><span class="c">ot-&gt;</span><span class="w">sectorsize</span> <span class="w">=</span><span class="c">=</span> <span class="w">P</span><span class="c">AGE_SIZE</span><span class="w">)</span><span class="pc">;</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(rbio-&gt;</span><span class="w">stripe_npages</span> <span class="w">=</span><span class="c">=</span> <span class="w">stripe_nsectors</span><span class="pc">);</span>
	<span class="w">bitmap_copy</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dbitmap</span><span class="c">,</span> <span class="w">d</span><span class="pc">b</span><span class="c">itmap</span><span class="pc">,</span> <span class="w">s</span><span class="pc">tripe_ns</span><span class="c">ectors);</span>

	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">;</span>
<span class="c">}</span>

<span class="w">v</span><span class="c">oid</span> <span class="w">raid56_parity_add_scrub_pages</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio,</span>
				   <span class="c">struct</span> <span class="w">p</span><span class="pc">a</span><span class="c">ge</span> <span class="c">*</span><span class="pc">p</span><span class="c">age,</span> <span class="w">u</span><span class="pc">6</span><span class="c">4</span> <span class="w">logical</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">stripe_offset</span><span class="pc">;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">i</span><span class="pc">n</span><span class="c">dex;</span>

	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">l</span><span class="c">ogical</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">raid_map[</span><span class="c">0]);</span>
	<span class="w">A</span><span class="pc">S</span><span class="c">SERT(</span><span class="pc">l</span><span class="c">ogical</span> <span class="w">+</span> <span class="w">P</span><span class="c">AGE_SIZE</span> <span class="w">&lt;</span><span class="pc">=</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="pc">b</span><span class="c">bio</span><span class="w">-</span><span class="c">&gt;raid_map[</span><span class="pc">0</span><span class="w">] +</span>
				<span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripe_len</span> <span class="w">*</span> <span class="pc">rb</span><span class="c">io</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">nr_data)</span><span class="c">;</span>
	<span class="w">s</span><span class="pc">tripe_o</span><span class="c">ffset</span> <span class="w">=</span><span class="pc"> </span><span class="c">(</span><span class="w">i</span><span class="c">nt</span><span class="w">)</span><span class="pc">(l</span><span class="c">ogical</span> <span class="w">-</span> <span class="c">rbio-&gt;bbio-&gt;raid_map[</span><span class="pc">0])</span><span class="c">;</span>
	<span class="w">ind</span><span class="c">ex</span> <span class="c">=</span> <span class="c">stripe_offset</span> <span class="w">&gt;</span><span class="c">&gt;</span> <span class="w">PAGE_CACHE_SHIFT</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">bio_pages</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">] </span><span class="c">=</span> <span class="w">pa</span><span class="c">ge;</span>
<span class="pc">}</span>


<span class="pc">s</span><span class="c">tatic</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">alloc_rbio_essential_pages</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="pc">i</span><span class="c">;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">bi</span><span class="pc">t;</span>
	<span class="c">int</span> <span class="pc">in</span><span class="c">dex;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="pc">p</span><span class="c">age</span> <span class="c">*</span><span class="pc">page</span><span class="c">;</span>

	<span class="w">for_each_set_bit</span><span class="c">(</span><span class="w">bi</span><span class="pc">t</span><span class="c">,</span> <span class="c">rbio-&gt;</span><span class="w">dbitmap</span><span class="pc">,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_npages)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">f</span><span class="pc">or</span> <span class="c">(i</span> <span class="c">=</span> <span class="c">0;</span> <span class="c">i</span> <span class="c">&lt;</span> <span class="c">rbio-&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="c">i</span><span class="pc">++) </span><span class="c">{</span>
			<span class="w">in</span><span class="pc">d</span><span class="c">ex</span> <span class="c">=</span> <span class="w">i</span> <span class="w">*</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">tripe_npages</span> <span class="w">+</span> <span class="w">bi</span><span class="pc">t;</span>
			<span class="pc">if</span> <span class="c">(rbio-&gt;</span><span class="w">stripe_pages</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">])</span>
				<span class="c">continue;</span>

			<span class="w">pag</span><span class="pc">e</span> <span class="c">=</span> <span class="w">alloc_page</span><span class="c">(</span><span class="w">GFP_NOFS</span> <span class="w">|</span> <span class="w">__GFP_HIGHMEM</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="pc">(!</span><span class="w">pa</span><span class="pc">ge)</span>
				<span class="c">return</span> <span class="c">-</span><span class="pc">EN</span><span class="c">OMEM;</span>
			<span class="c">rbio-&gt;</span><span class="pc">stripe_p</span><span class="c">ages</span><span class="pc">[</span><span class="w">i</span><span class="pc">n</span><span class="c">dex</span><span class="pc">] </span><span class="c">=</span> <span class="w">p</span><span class="c">age;</span>
			<span class="w">ClearPageUptodate</span><span class="c">(</span><span class="w">p</span><span class="c">age</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">}</span>
	<span class="c">}</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="pc">0</span><span class="c">;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">raid_write_parity_end_io</span><span class="c">(struct</span> <span class="w">b</span><span class="c">io</span> <span class="c">*bio</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="pc">rr</span><span class="c">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio</span> <span class="c">=</span> <span class="w">b</span><span class="pc">i</span><span class="c">o-&gt;</span><span class="w">bi_private</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="w">fail_bio_stripe</span><span class="c">(rbio,</span> <span class="w">b</span><span class="pc">io)</span><span class="c">;</span>

	<span class="w">bio_put</span><span class="c">(</span><span class="w">b</span><span class="pc">io)</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">atomic_dec_and_test</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">stripes_pending</span><span class="c">))</span>
		<span class="c">return</span><span class="pc">;</span>

	<span class="w">e</span><span class="c">rr</span> <span class="c">=</span> <span class="pc">0</span><span class="c">;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">at</span><span class="pc">omic_r</span><span class="c">ead(&amp;rbio-&gt;</span><span class="w">e</span><span class="pc">rro</span><span class="c">r</span><span class="pc">))</span>
		<span class="pc">e</span><span class="c">rr</span> <span class="pc">= </span><span class="c">-</span><span class="w">EI</span><span class="pc">O</span><span class="c">;</span>

	<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="pc">,</span> <span class="w">e</span><span class="c">rr</span><span class="pc">,</span> <span class="c">0);</span>
<span class="pc">}</span>

<span class="c">static</span> <span class="w">noinline</span> <span class="w">v</span><span class="c">oid</span> <span class="w">finish_parity_scrub</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio,</span>
					 <span class="pc">i</span><span class="c">nt</span> <span class="w">need_check</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_bio</span> <span class="c">*</span><span class="w">bbio</span> <span class="c">=</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;bbio;</span>
	<span class="w">v</span><span class="c">oid</span> <span class="pc">*</span><span class="w">pointers[r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span><span class="c">];</span>
	<span class="w">DECLARE_BITMAP</span><span class="c">(</span><span class="w">pbitmap</span><span class="c">,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_npages</span><span class="c">);</span>
	<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">nr_data</span> <span class="pc">=</span> <span class="pc">r</span><span class="c">bio-&gt;nr_data;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">stripe</span><span class="pc">;</span>
	<span class="c">int</span> <span class="w">pagenr</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">p_stripe</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">q_stripe</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>
	<span class="w">s</span><span class="c">truct</span> <span class="w">pa</span><span class="pc">ge</span> <span class="c">*</span><span class="w">p_page</span> <span class="pc">=</span> <span class="w">N</span><span class="c">ULL;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">pa</span><span class="pc">ge</span> <span class="c">*</span><span class="w">q_page</span> <span class="pc">=</span> <span class="c">NULL;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bio_list</span> <span class="w">b</span><span class="c">io_list;</span>
	<span class="c">struct</span> <span class="w">b</span><span class="pc">io</span> <span class="c">*</span><span class="pc">b</span><span class="c">io;</span>
	<span class="c">int</span> <span class="w">is_replace</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="c">int</span> <span class="c">ret;</span>

	<span class="w">bio_list_init</span><span class="pc">(&amp;</span><span class="w">b</span><span class="pc">i</span><span class="c">o_list</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">real_stripes</span> <span class="w">-</span> <span class="pc">r</span><span class="c">bio</span><span class="w">-</span><span class="c">&gt;</span><span class="w">nr_data</span> <span class="w">=</span><span class="pc">=</span> <span class="pc">1</span><span class="c">) {</span>
		<span class="w">p_stripe</span> <span class="pc">=</span> <span class="c">rbio-&gt;</span><span class="pc">re</span><span class="c">al_stripes</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">if</span> <span class="c">(rbio-&gt;real_stripes</span> <span class="w">-</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;nr_data</span> <span class="w">=</span><span class="pc">=</span> <span class="w">2</span><span class="c">) {</span>
		<span class="pc">p</span><span class="c">_stripe</span> <span class="pc">=</span> <span class="c">rbio-&gt;real_stripes</span> <span class="w">-</span> <span class="pc">2</span><span class="c">;</span>
		<span class="w">q_stripe</span> <span class="c">=</span> <span class="c">rbio-&gt;</span><span class="pc">re</span><span class="c">al_stripes</span> <span class="w">-</span> <span class="c">1;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="c">{</span>
		<span class="w">B</span><span class="c">UG();</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">num_tgtdevs</span> <span class="w">&amp;</span><span class="pc">&amp;</span> <span class="pc">b</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tgtdev_map[r</span><span class="c">bio-&gt;</span><span class="w">scrubp])</span><span class="c"> {</span>
		<span class="w">is_replace</span> <span class="pc">=</span> <span class="w">1</span><span class="c">;</span>
		<span class="w">bitmap_copy</span><span class="pc">(</span><span class="w">pbitmap</span><span class="c">,</span> <span class="c">rbio-&gt;</span><span class="w">dbitmap</span><span class="c">,</span> <span class="w">r</span><span class="c">bio-&gt;</span><span class="w">stripe_npages</span><span class="c">);</span>
	<span class="c">}</span>

	
	<span class="w">cl</span><span class="pc">ear</span><span class="c">_bit(</span><span class="w">RBIO_CACHE_READY_BIT</span><span class="c">, &amp;</span><span class="pc">r</span><span class="c">bio-&gt;flags);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">need_check</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">writeback</span><span class="c">;</span>

	<span class="w">p_page</span> <span class="c">=</span> <span class="w">alloc_page</span><span class="c">(</span><span class="w">GFP_NOFS</span> <span class="w">|</span> <span class="w">__GFP_HIGHMEM</span><span class="c">);</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">p_page</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="pc">c</span><span class="c">leanup;</span>
	<span class="w">SetPageUptodate</span><span class="pc">(</span><span class="c">p_page</span><span class="pc">)</span><span class="c">;</span>

	<span class="c">if</span> <span class="c">(</span><span class="w">q_stripe</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>
		<span class="w">q_page</span> <span class="pc">=</span> <span class="w">a</span><span class="pc">l</span><span class="c">loc_page</span><span class="pc">(G</span><span class="c">FP_NOFS</span> <span class="w">|</span> <span class="c">__GFP_HIGHMEM);</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="c">q_page</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">__free_page</span><span class="c">(</span><span class="pc">p</span><span class="c">_page);</span>
			<span class="c">goto</span> <span class="c">cleanup;</span>
		<span class="c">}</span>
		<span class="pc">S</span><span class="c">etPageUptodate</span><span class="pc">(</span><span class="c">q_page);</span>
	<span class="c">}</span>

	<span class="w">at</span><span class="pc">omic_s</span><span class="c">et(&amp;</span><span class="w">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">e</span><span class="pc">r</span><span class="c">ror,</span> <span class="c">0);</span>

	<span class="w">for_each_set_bit</span><span class="c">(</span><span class="w">pagenr</span><span class="c">,</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dbitmap</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_npages)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*</span><span class="w">p</span><span class="c">;</span>
		<span class="w">v</span><span class="c">oid</span> <span class="c">*</span><span class="w">parity</span><span class="c">;</span>
		
		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">stripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">s</span><span class="c">tripe</span> <span class="c">&lt;</span> <span class="w">nr_data</span><span class="c">;</span> <span class="c">stripe++) {</span>
			<span class="w">p</span> <span class="pc">=</span> <span class="w">page_in_rbio</span><span class="c">(</span><span class="w">r</span><span class="c">bio,</span> <span class="c">stripe,</span> <span class="w">p</span><span class="pc">ag</span><span class="c">enr,</span> <span class="w">0</span><span class="c">);</span>
			<span class="w">pointers[</span><span class="c">stripe</span><span class="pc">] </span><span class="c">=</span> <span class="w">kmap</span><span class="c">(</span><span class="w">p</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span>

		
		<span class="w">p</span><span class="c">ointers</span><span class="w">[s</span><span class="c">tripe</span><span class="w">+</span><span class="pc">+</span><span class="c">] =</span> <span class="c">kmap</span><span class="pc">(</span><span class="w">p_page</span><span class="pc">)</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">q_stripe</span> <span class="w">!</span><span class="pc">= </span><span class="c">-1</span><span class="pc">) </span><span class="c">{</span>

			
			<span class="pc">p</span><span class="c">ointers</span><span class="w">[s</span><span class="c">tripe</span><span class="pc">+</span><span class="c">+] =</span> <span class="w">k</span><span class="c">map</span><span class="pc">(</span><span class="w">q_page</span><span class="pc">)</span><span class="c">;</span>

			<span class="w">raid6_call.gen_syndrome(rbio-</span><span class="pc">&gt;</span><span class="w">real_stripes</span><span class="pc">,</span> <span class="w">P</span><span class="c">AGE_SIZE</span><span class="pc">,</span>
						<span class="w">p</span><span class="pc">o</span><span class="c">inters</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">}</span> <span class="pc">e</span><span class="c">lse</span> <span class="c">{</span>
			
			<span class="w">m</span><span class="c">emcpy(</span><span class="pc">po</span><span class="c">inters</span><span class="pc">[</span><span class="w">nr_data</span><span class="pc">],</span> <span class="pc">p</span><span class="c">ointers</span><span class="w">[</span><span class="c">0],</span> <span class="w">P</span><span class="c">AGE_SIZE);</span>
			<span class="w">run_xor</span><span class="c">(pointers</span> <span class="w">+</span> <span class="c">1</span><span class="pc">,</span> <span class="pc">n</span><span class="c">r_data</span> <span class="w">-</span> <span class="c">1</span><span class="pc">,</span> <span class="w">PAGE_CACHE_SIZE</span><span class="c">);</span>
		<span class="c">}</span>

		
		<span class="w">p</span> <span class="pc">=</span> <span class="w">rbio_stripe_page</span><span class="c">(</span><span class="pc">rb</span><span class="c">io,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">scrubp</span><span class="c">,</span> <span class="w">pagenr</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">parity</span> <span class="pc">=</span> <span class="w">kmap</span><span class="c">(</span><span class="w">p</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="c">(</span><span class="w">me</span><span class="pc">mc</span><span class="c">mp(parity,</span> <span class="pc">po</span><span class="c">inters</span><span class="w">[r</span><span class="c">bio</span><span class="w">-</span><span class="pc">&gt;s</span><span class="c">crubp</span><span class="w">]</span><span class="pc">,</span> <span class="w">P</span><span class="c">AGE_CACHE_SIZE</span><span class="w">)</span><span class="pc">)</span>
			<span class="w">m</span><span class="c">emcpy(parity,</span> <span class="pc">p</span><span class="c">ointers</span><span class="pc">[r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">crubp</span><span class="w">]</span><span class="pc">,</span> <span class="pc">P</span><span class="c">AGE_CACHE_SIZE);</span>
		<span class="w">e</span><span class="c">lse</span>
			
			<span class="w">bitmap_clear</span><span class="c">(rbio-&gt;</span><span class="w">dbitmap</span><span class="c">,</span> <span class="w">pagenr</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
		<span class="w">kunmap</span><span class="c">(</span><span class="w">p</span><span class="pc">)</span><span class="c">;</span>

		<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">stripe</span> <span class="c">=</span> <span class="c">0;</span> <span class="pc">s</span><span class="c">tripe</span> <span class="c">&lt;</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="pc">s</span><span class="c">tripe</span><span class="pc">++)</span>
			<span class="w">k</span><span class="c">unmap(</span><span class="w">page_in_rbio</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">,</span> <span class="c">stripe</span><span class="pc">,</span> <span class="w">p</span><span class="c">agenr</span><span class="pc">,</span> <span class="pc">0))</span><span class="c">;</span>
	<span class="pc">}</span>

	<span class="w">__free_page</span><span class="c">(</span><span class="w">p_page</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">q_page</span><span class="pc">)</span>
		<span class="w">_</span><span class="c">_free_page(</span><span class="pc">q</span><span class="c">_page</span><span class="pc">)</span><span class="c">;</span>

<span class="w">writeback</span><span class="pc">:</span>
	
	<span class="w">for_each_set_bit</span><span class="c">(</span><span class="w">p</span><span class="pc">agen</span><span class="c">r,</span> <span class="w">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">dbitmap</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_npages)</span><span class="pc"> </span><span class="c">{</span>
		<span class="w">s</span><span class="pc">tru</span><span class="c">ct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*</span><span class="w">p</span><span class="pc">age;</span>

		<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio,</span> <span class="w">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">scrubp</span><span class="pc">,</span> <span class="pc">pa</span><span class="c">genr</span><span class="pc">)</span><span class="c">;</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">rbio_add_io_page</span><span class="c">(rbio</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bio_list</span><span class="pc">,</span>
			       <span class="w">p</span><span class="pc">age,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">crubp,</span> <span class="c">pagenr,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">re</span><span class="c">t</span><span class="pc">)</span>
			<span class="c">goto</span> <span class="w">c</span><span class="c">leanup;</span>
	<span class="c">}</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">is_replace</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">submit_write</span><span class="c">;</span>

	<span class="w">for_each_set_bit</span><span class="pc">(</span><span class="w">p</span><span class="pc">a</span><span class="c">genr,</span> <span class="w">pbitmap</span><span class="c">,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_npages)</span><span class="pc"> </span><span class="c">{</span>
		<span class="pc">s</span><span class="c">truct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*page</span><span class="pc">;</span>

		<span class="w">p</span><span class="pc">age</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(rbio,</span> <span class="w">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">scrubp</span><span class="pc">,</span> <span class="pc">p</span><span class="c">agenr);</span>
		<span class="w">r</span><span class="pc">et</span> <span class="c">=</span> <span class="w">rbio_add_io_page</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bio_list</span><span class="pc">,</span> <span class="w">p</span><span class="pc">age,</span>
				       <span class="w">bbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">tgtdev_map[</span><span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">s</span><span class="c">crubp</span><span class="pc">],</span>
				       <span class="pc">p</span><span class="c">agenr</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c">;</span>
		<span class="pc">i</span><span class="c">f</span> <span class="c">(ret</span><span class="pc">)</span>
			<span class="c">goto</span> <span class="w">c</span><span class="c">leanup;</span>
	<span class="c">}</span>

<span class="w">submit_write:</span>
	<span class="w">nr_data</span> <span class="pc">=</span> <span class="w">bio_list_size</span><span class="pc">(&amp;bi</span><span class="c">o_list</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!n</span><span class="c">r_data</span><span class="pc">) </span><span class="c">{</span>
		
		<span class="w">rbio_orig_end_io</span><span class="c">(rbio,</span> <span class="pc">0</span><span class="c">,</span> <span class="pc">0</span><span class="c">);</span>
		<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
	<span class="c">}</span>

	<span class="w">at</span><span class="pc">omic_s</span><span class="c">et(&amp;rbio-&gt;</span><span class="w">stripes_pending</span><span class="c">,</span> <span class="pc">n</span><span class="c">r_data);</span>

	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="w">1</span><span class="c">) {</span>
		<span class="w">bi</span><span class="pc">o</span> <span class="pc">=</span> <span class="w">bio_list_pop</span><span class="pc">(&amp;b</span><span class="c">io_list</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">io)</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>

		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_private</span> <span class="c">=</span> <span class="pc">r</span><span class="c">bio;</span>
		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_end_io</span> <span class="c">=</span> <span class="w">raid_write_parity_end_io</span><span class="c">;</span>
		<span class="w">B</span><span class="c">UG_ON</span><span class="pc">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">BIO_UPTODATE</span><span class="c">, &amp;</span><span class="pc">b</span><span class="c">io-&gt;</span><span class="w">bi_flags))</span><span class="pc">;</span>
		<span class="w">submit_bio</span><span class="c">(</span><span class="w">WRITE</span><span class="c">,</span> <span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	<span class="w">r</span><span class="c">eturn</span><span class="w">;</span>

<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>
	<span class="w">rbio_orig_end_io</span><span class="c">(</span><span class="w">r</span><span class="c">bio</span><span class="w">, -E</span><span class="pc">I</span><span class="c">O</span><span class="pc">,</span> <span class="c">0);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">inl</span><span class="c">ine</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">is_data_stripe</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="w">r</span><span class="pc">b</span><span class="c">io,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">stripe</span><span class="c">)</span>
<span class="c">{</span>
	<span class="pc">i</span><span class="c">f</span> <span class="c">(stripe</span> <span class="w">&gt;</span><span class="c">=</span> <span class="c">0</span> <span class="pc">&amp;</span><span class="c">&amp;</span> <span class="pc">st</span><span class="c">ripe</span> <span class="pc">&lt;</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">nr_data</span><span class="pc">)</span>
		<span class="c">return</span> <span class="pc">1</span><span class="c">;</span>
	<span class="pc">r</span><span class="c">eturn</span> <span class="c">0;</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">validate_rbio_for_parity_scrub</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="c">(</span><span class="w">a</span><span class="c">tomic_read(&amp;rbio-&gt;</span><span class="w">er</span><span class="pc">ro</span><span class="c">r</span><span class="w">) </span><span class="pc">&gt;</span> <span class="w">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">max_errors)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">cl</span><span class="c">eanup;</span>

	<span class="pc">i</span><span class="c">f</span> <span class="c">(rbio-&gt;</span><span class="w">faila</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="c">0</span> <span class="pc">|</span><span class="c">|</span> <span class="c">rbio-&gt;</span><span class="w">failb</span> <span class="w">&gt;</span><span class="pc">=</span> <span class="pc">0) </span><span class="c">{</span>
		<span class="w">i</span><span class="pc">n</span><span class="c">t</span> <span class="w">dfail</span> <span class="c">=</span> <span class="c">0</span><span class="pc">,</span> <span class="w">failp</span> <span class="w">=</span><span class="pc"> -</span><span class="c">1;</span>

		<span class="c">if</span> <span class="c">(</span><span class="w">is_data_stripe</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">f</span><span class="pc">aila</span><span class="c">))</span>
			<span class="w">d</span><span class="c">fail</span><span class="w">+</span><span class="c">+;</span>
		<span class="w">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="w">is_parity_stripe</span><span class="c">(rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">f</span><span class="c">aila</span><span class="pc">))</span>
			<span class="w">f</span><span class="c">ailp</span> <span class="pc">=</span> <span class="c">rbio-&gt;</span><span class="w">f</span><span class="pc">aila</span><span class="c">;</span>

		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">i</span><span class="c">s_data_stripe</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">failb</span><span class="c">))</span>
			<span class="pc">d</span><span class="c">fail</span><span class="w">+</span><span class="c">+;</span>
		<span class="w">e</span><span class="c">lse</span> <span class="c">if</span> <span class="c">(</span><span class="pc">is_p</span><span class="c">arity_stripe</span><span class="pc">(</span><span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="pc">failb))</span>
			<span class="pc">f</span><span class="c">ailp</span> <span class="pc">=</span> <span class="c">rbio-&gt;</span><span class="w">f</span><span class="pc">ailb</span><span class="c">;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">d</span><span class="c">fail</span> <span class="pc">&gt;</span> <span class="c">rbio-&gt;</span><span class="w">bbio-</span><span class="c">&gt;</span><span class="w">max_errors</span> <span class="w">-</span> <span class="c">1</span><span class="pc">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">cl</span><span class="pc">e</span><span class="c">anup;</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(dfail</span> <span class="pc">=</span><span class="c">=</span> <span class="c">0</span><span class="pc">) </span><span class="c">{</span>
			<span class="w">finish_parity_scrub</span><span class="c">(rbio</span><span class="pc">,</span> <span class="pc">0)</span><span class="c">;</span>
			<span class="pc">r</span><span class="c">eturn</span><span class="w">;</span>
		<span class="c">}</span>

		
		<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="pc">f</span><span class="c">ailp</span> <span class="w">!</span><span class="c">=</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">scrubp</span><span class="c">)</span>
			<span class="pc">g</span><span class="c">oto</span> <span class="w">c</span><span class="c">leanup;</span>

		<span class="w">__raid_recover_end_io</span><span class="pc">(r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span> <span class="c">else</span> <span class="pc">{</span>
		<span class="w">f</span><span class="c">inish_parity_scrub(rbio,</span> <span class="w">1</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">}</span>
	<span class="pc">r</span><span class="c">eturn</span><span class="pc">;</span>

<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>
	<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="w">, -E</span><span class="pc">I</span><span class="c">O</span><span class="pc">,</span> <span class="c">0);</span>
<span class="c">}</span>


<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">raid56_parity_scrub_end_io</span><span class="c">(struct</span> <span class="w">b</span><span class="pc">i</span><span class="c">o</span> <span class="c">*bio</span><span class="pc">,</span> <span class="pc">i</span><span class="c">nt</span> <span class="w">e</span><span class="pc">r</span><span class="c">r)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio</span> <span class="c">=</span> <span class="w">bi</span><span class="c">o-&gt;</span><span class="w">bi_private</span><span class="c">;</span>

	<span class="pc">if</span> <span class="c">(</span><span class="pc">e</span><span class="c">rr</span><span class="pc">)</span>
		<span class="w">fail_bio_stripe</span><span class="c">(rbio,</span> <span class="w">b</span><span class="pc">io)</span><span class="c">;</span>
	<span class="pc">e</span><span class="c">lse</span>
		<span class="w">set_bio_pages_uptodate</span><span class="c">(</span><span class="pc">bi</span><span class="c">o</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">bio_put</span><span class="c">(bio);</span>

	<span class="pc">i</span><span class="c">f</span> <span class="pc">(!</span><span class="w">atomic_dec_and_test</span><span class="pc">(&amp;r</span><span class="c">bio-&gt;</span><span class="w">stripes_pending</span><span class="c">))</span>
		<span class="c">return</span><span class="pc">;</span>

	
	<span class="w">validate_rbio_for_parity_scrub</span><span class="c">(rbio);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">raid56_parity_scrub_stripe</span><span class="c">(struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*rbio)</span>
<span class="c">{</span>
	<span class="pc">in</span><span class="c">t</span> <span class="w">bios_to_read</span> <span class="pc">=</span> <span class="c">0;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bio_list</span> <span class="w">b</span><span class="pc">io_l</span><span class="c">ist;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="c">ret;</span>
	<span class="pc">i</span><span class="c">nt</span> <span class="w">pagenr</span><span class="c">;</span>
	<span class="c">int</span> <span class="w">stripe</span><span class="c">;</span>
	<span class="pc">s</span><span class="c">truct</span> <span class="w">bi</span><span class="pc">o</span> <span class="c">*</span><span class="w">b</span><span class="pc">io</span><span class="c">;</span>

	<span class="w">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">alloc_rbio_essential_pages</span><span class="c">(</span><span class="w">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="c">(ret</span><span class="pc">)</span>
		<span class="pc">g</span><span class="c">oto</span> <span class="w">c</span><span class="c">leanup;</span>

	<span class="w">bio_list_init</span><span class="pc">(&amp;</span><span class="c">bio_list</span><span class="pc">)</span><span class="c">;</span>

	<span class="w">ato</span><span class="pc">mic_s</span><span class="c">et(&amp;rbio-&gt;</span><span class="w">er</span><span class="c">ror</span><span class="pc">,</span> <span class="c">0);</span>
	
	<span class="w">f</span><span class="c">or</span> <span class="c">(</span><span class="w">st</span><span class="pc">ri</span><span class="c">pe</span> <span class="c">=</span> <span class="c">0;</span> <span class="w">s</span><span class="c">tripe</span> <span class="pc">&lt;</span> <span class="c">rbio-&gt;</span><span class="w">real_stripes</span><span class="c">;</span> <span class="pc">s</span><span class="c">tripe++) {</span>
		<span class="w">for_each_set_bit</span><span class="pc">(</span><span class="w">pagenr</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">dbitmap</span><span class="pc">,</span> <span class="pc">r</span><span class="c">bio-&gt;</span><span class="w">stripe_npages)</span><span class="pc"> </span><span class="c">{</span>
			<span class="w">s</span><span class="pc">t</span><span class="c">ruct</span> <span class="w">p</span><span class="pc">age</span> <span class="c">*</span><span class="pc">p</span><span class="c">age;</span>
			
			<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">page_in_rbio</span><span class="c">(</span><span class="w">r</span><span class="pc">b</span><span class="c">io,</span> <span class="c">stripe,</span> <span class="w">p</span><span class="c">agenr</span><span class="pc">,</span> <span class="w">1</span><span class="c">);</span>
			<span class="pc">i</span><span class="c">f</span> <span class="c">(</span><span class="w">p</span><span class="pc">age)</span>
				<span class="w">c</span><span class="c">ontinue;</span>

			<span class="w">pa</span><span class="pc">ge</span> <span class="c">=</span> <span class="w">rbio_stripe_page</span><span class="c">(rbio,</span> <span class="w">s</span><span class="pc">tripe</span><span class="c">,</span> <span class="c">pagenr</span><span class="pc">)</span><span class="c">;</span>
			
			<span class="c">if</span> <span class="c">(</span><span class="w">PageUptodate</span><span class="pc">(p</span><span class="c">age</span><span class="pc">))</span>
				<span class="pc">c</span><span class="c">ontinue;</span>

			<span class="pc">r</span><span class="c">et</span> <span class="c">=</span> <span class="w">rbio_add_io_page</span><span class="c">(rbio</span><span class="pc">, </span><span class="c">&amp;</span><span class="w">bio_list</span><span class="pc">,</span> <span class="w">p</span><span class="pc">age</span><span class="c">,</span>
				       <span class="w">s</span><span class="c">tripe,</span> <span class="pc">p</span><span class="c">agenr,</span> <span class="c">rbio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">stripe_len</span><span class="pc">)</span><span class="c">;</span>
			<span class="c">if</span> <span class="c">(ret)</span>
				<span class="c">goto</span> <span class="w">c</span><span class="c">leanup;</span>
		<span class="c">}</span>
	<span class="w">}</span>

	<span class="w">bios_to_read</span> <span class="pc">=</span> <span class="w">bio_list_size</span><span class="pc">(&amp;b</span><span class="c">io_list</span><span class="pc">)</span><span class="c">;</span>
	<span class="c">if</span> <span class="pc">(!</span><span class="c">bios_to_read) {</span>
		
		<span class="w">g</span><span class="c">oto</span> <span class="w">finish</span><span class="c">;</span>
	<span class="c">}</span>

	
	<span class="w">a</span><span class="pc">tomic_s</span><span class="c">et(&amp;</span><span class="w">r</span><span class="c">bio-&gt;</span><span class="w">stripes_pending</span><span class="c">,</span> <span class="pc">b</span><span class="c">ios_to_read</span><span class="pc">)</span><span class="c">;</span>
	<span class="w">w</span><span class="c">hile</span> <span class="c">(</span><span class="pc">1</span><span class="c">) {</span>
		<span class="w">bi</span><span class="pc">o</span> <span class="pc">=</span> <span class="w">bio_list_pop</span><span class="pc">(&amp;bio_</span><span class="c">list</span><span class="pc">)</span><span class="c">;</span>
		<span class="c">if</span> <span class="pc">(!</span><span class="w">b</span><span class="pc">io)</span>
			<span class="w">b</span><span class="pc">r</span><span class="c">eak;</span>

		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_private</span> <span class="c">=</span> <span class="c">rbio;</span>
		<span class="w">b</span><span class="pc">io</span><span class="c">-&gt;</span><span class="w">bi_end_io</span> <span class="c">=</span> <span class="w">raid56_parity_scrub_end_io</span><span class="c">;</span>

		<span class="w">btrfs_bio_wq_end_io</span><span class="pc">(r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info,</span> <span class="pc">bio</span><span class="c">,</span>
				    <span class="w">BTRFS_WQ_ENDIO_RAID56</span><span class="c">);</span>

		<span class="w">B</span><span class="pc">U</span><span class="c">G_ON</span><span class="pc">(!</span><span class="w">t</span><span class="c">est_bit(</span><span class="w">BIO_UPTODATE</span><span class="c">, &amp;bio-&gt;</span><span class="w">bi_flags))</span><span class="pc">;</span>
		<span class="w">submit_bio</span><span class="c">(</span><span class="w">READ</span><span class="c">,</span> <span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
	<span class="pc">}</span>
	
	<span class="w">r</span><span class="c">eturn</span><span class="w">;</span>

<span class="w">cl</span><span class="pc">ean</span><span class="c">up:</span>
	<span class="w">rbio_orig_end_io</span><span class="c">(rbio</span><span class="w">,</span><span class="pc"> -</span><span class="w">E</span><span class="pc">I</span><span class="c">O</span><span class="pc">,</span> <span class="c">0);</span>
	<span class="pc">re</span><span class="c">turn</span><span class="w">;</span>

<span class="w">finish</span><span class="pc">:</span>
	<span class="w">validate_rbio_for_parity_scrub</span><span class="c">(</span><span class="w">r</span><span class="c">bio</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">scrub_parity_work</span><span class="c">(struct</span> <span class="w">btrfs_work</span> <span class="c">*</span><span class="w">wo</span><span class="c">rk)</span>
<span class="c">{</span>
	<span class="c">struct</span> <span class="w">btrfs_raid_bio</span> <span class="c">*</span><span class="pc">r</span><span class="c">bio</span><span class="pc">;</span>

	<span class="w">r</span><span class="pc">bio</span> <span class="pc">=</span> <span class="c">container_of(work,</span> <span class="c">struct</span> <span class="c">btrfs_raid_bio,</span> <span class="pc">w</span><span class="c">ork);</span>
	<span class="w">raid56_parity_scrub_stripe</span><span class="c">(</span><span class="w">r</span><span class="c">bio);</span>
<span class="c">}</span>

<span class="c">static</span> <span class="pc">v</span><span class="c">oid</span> <span class="w">async_scrub_parity</span><span class="c">(struct</span> <span class="c">btrfs_raid_bio</span> <span class="c">*rbio)</span>
<span class="c">{</span>
	<span class="w">btrfs_init_work</span><span class="pc">(&amp;</span><span class="c">rbio-&gt;</span><span class="w">w</span><span class="c">ork</span><span class="pc">,</span> <span class="w">btrfs_rmw_helper</span><span class="pc">,</span>
			<span class="w">scrub_parity_work</span><span class="pc">,</span> <span class="pc">N</span><span class="c">ULL</span><span class="pc">,</span> <span class="c">NULL);</span>

	<span class="w">btrfs_queue_work</span><span class="c">(</span><span class="pc">r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">fs</span><span class="pc">_</span><span class="c">info</span><span class="w">-</span><span class="pc">&gt;</span><span class="w">rmw_workers</span><span class="c">,</span>
			 <span class="pc">&amp;r</span><span class="c">bio</span><span class="pc">-</span><span class="c">&gt;</span><span class="w">w</span><span class="pc">o</span><span class="c">rk</span><span class="pc">)</span><span class="c">;</span>
<span class="c">}</span>

<span class="pc">v</span><span class="c">oid</span> <span class="w">raid56_parity_submit_scrub_rbio</span><span class="c">(struct</span> <span class="pc">b</span><span class="c">trfs_raid_bio</span> <span class="c">*rbio</span><span class="pc">)</span>
<span class="c">{</span>
	<span class="pc">if</span> <span class="pc">(!</span><span class="w">lock_stripe_add</span><span class="c">(rbio</span><span class="pc">))</span>
		<span class="w">async_scrub_parity</span><span class="c">(rbio</span><span class="pc">)</span><span class="c">;</span>
<span class="pc">}</span>

</pre>
</body>
</html>

